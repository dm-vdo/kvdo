cscope 15 $HOME/kvdo               0002275833
	@uds/accessMode.h

22 #i‚de‡
ACCESS_MODE_H


23 
	#ACCESS_MODE_H


	)

26 
	mIO_READ
 = 0x1,

27 
	mIO_WRITE
 = 0x2,

28 
	mIO_CREATE
 = 0x4,

29 
	mIO_READ_WRITE
 = 
IO_READ
 | 
IO_WRITE
,

30 
	mIO_CREATE_READ_WRITE
 = 
IO_READ_WRITE
 | 
IO_CREATE
,

31 
	mIO_CREATE_WRITE
 = 
IO_WRITE
 | 
IO_CREATE
,

32 
	mIO_ACCESS_MASK
 = 0x7,

33 } 
	tIOAc˚ssMode
;

	@uds/assertDefs.h

22 #i‚de‡
LINUX_KERNEL_ASSERT_DEFS_H


23 
	#LINUX_KERNEL_ASSERT_DEFS_H


	)

25 
	~"compûî.h
"

26 
	~"loggî.h
"

27 
	~"thªads.h
"

29 
	#CU_COMPLAIN
(
PRED
) \

30 
	`logEº‹
("\n%s:%d: %s: %s: ", 
__FILE__
, 
__LINE__
, 
__func__
, 
PRED
)

	)

32 
	#CU_MESSAGE
(...) \

33 
	`logEº‹
(
__VA_ARGS__
)

	)

41 
cuEº‹Mesßge
(c⁄° *
°rög
, 
vÆue
);

46 
INLINE
 
	$cuDõ
()

48 
	`exôThªad
();

49 
	}
}

	@uds/bits.c

22 
	~"bôs.h
"

24 
	~"compûî.h
"

31 íum { 
	mMAX_BIG_FIELD_BITS
 = ((
uöt64_t
Ë- 1Ë* 
CHAR_BIT
 + 1 };

42 
INLINE
 
uöt64_t
 
	$gëBigFõld
(c⁄° 
byã
 *
mem‹y
, 
uöt64_t
 
off£t
,

43 
size
)

45 c⁄° 
uöt64_t
 *
addr
 = (c⁄° uöt64_à*Ë(
mem‹y
 + 
off£t
 / 
CHAR_BIT
);

46  (*
addr
 >> (
off£t
 % 
CHAR_BIT
)Ë& ((1UL << 
size
) - 1);

47 
	}
}

59 
INLINE
 
	$£tBigFõld
(
uöt64_t
 
vÆue
, 
byã
 *
mem‹y
, uöt64_à
off£t
,

60 
size
)

62 
uöt64_t
 *
addr
 = (uöt64_à*Ë(
mem‹y
 + 
off£t
 / 
CHAR_BIT
);

63 
shi·
 = 
off£t
 % 
CHAR_BIT
;

64 *
addr
 &~(((1UL << 
size
Ë- 1Ë<< 
shi·
);

65 *
addr
 |
vÆue
 << 
shi·
;

66 
	}
}

69 
	$gëByãs
(c⁄° 
byã
 *
mem‹y
, 
uöt64_t
 
off£t
, byã *
de°ö©i⁄
, 
size
)

71 c⁄° 
byã
 *
addr
 = 
mem‹y
 + 
off£t
 / 
CHAR_BIT
;

72 
shi·
 = 
off£t
 % 
CHAR_BIT
;

73 --
size
 >= 0) {

74 *
de°ö©i⁄
++ = *(c⁄° 
uöt16_t
 *Ë
addr
++ >> 
shi·
;

76 
	}
}

79 
	$£tByãs
(
byã
 *
mem‹y
, 
uöt64_t
 
off£t
, c⁄° byã *
sour˚
, 
size
)

81 
byã
 *
addr
 = 
mem‹y
 + 
off£t
 / 
CHAR_BIT
;

82 
shi·
 = 
off£t
 % 
CHAR_BIT
;

83 
uöt16_t
 
mask
 = ~((uöt16_tË0xFF << 
shi·
);

84 --
size
 >= 0) {

85 
uöt16_t
 *
addr16
 = (uöt16_à*Ë(
addr
++);

86 *
addr16
 = (*addr16 & 
mask
Ë| (*
sour˚
++ << 
shi·
);

88 
	}
}

91 
	$moveBôs
(c⁄° 
byã
 *
sMem‹y
, 
uöt64_t
 
sour˚
, byã *
dMem‹y
,

92 
uöt64_t
 
de°ö©i⁄
, 
size
)

94 íum { 
UINT32_BIT
 = (
uöt32_t
Ë* 
CHAR_BIT
 };

95 i‡(
size
 > 
MAX_BIG_FIELD_BITS
) {

96 i‡(
sour˚
 > 
de°ö©i⁄
) {

100 
cou¡


101 
MAX_BIG_FIELD_BITS
 - (
de°ö©i⁄
 + MAX_BIG_FIELD_BITSË% 
UINT32_BIT
;

102 
uöt64_t
 
fõld
 = 
	`gëBigFõld
(
sMem‹y
, 
sour˚
, 
cou¡
);

103 
	`£tBigFõld
(
fõld
, 
dMem‹y
, 
de°ö©i⁄
, 
cou¡
);

104 
sour˚
 +
cou¡
;

105 
de°ö©i⁄
 +
cou¡
;

106 
size
 -
cou¡
;

109 
off£t
 = 
sour˚
 % 
UINT32_BIT
;

110 c⁄° 
byã
 *
§c
 = 
sMem‹y
 + (
sour˚
 - 
off£t
Ë/ 
CHAR_BIT
;

111 
byã
 *
de°
 = 
dMem‹y
 + 
de°ö©i⁄
 / 
CHAR_BIT
;

112 
size
 > 
MAX_BIG_FIELD_BITS
) {

113 *(
uöt32_t
 *Ë
de°
 = *(c⁄° 
uöt64_t
 *Ë
§c
 >> 
off£t
;

114 
§c
 +(
uöt32_t
);

115 
de°
 +(
uöt32_t
);

116 
sour˚
 +
UINT32_BIT
;

117 
de°ö©i⁄
 +
UINT32_BIT
;

118 
size
 -
UINT32_BIT
;

124 
cou¡
 = (
de°ö©i⁄
 + 
size
Ë% 
UINT32_BIT
;

125 i‡(
cou¡
 > 0) {

126 
size
 -
cou¡
;

127 
uöt64_t
 
fõld
 = 
	`gëBigFõld
(
sMem‹y
, 
sour˚
 + 
size
, 
cou¡
);

128 
	`£tBigFõld
(
fõld
, 
dMem‹y
, 
de°ö©i⁄
 + 
size
, 
cou¡
);

132 
off£t
 = (
sour˚
 + 
size
Ë% 
UINT32_BIT
;

133 c⁄° 
byã
 *
§c
 = 
sMem‹y
 + (
sour˚
 + 
size
 - 
off£t
Ë/ 
CHAR_BIT
;

134 
byã
 *
de°
 = 
dMem‹y
 + (
de°ö©i⁄
 + 
size
Ë/ 
CHAR_BIT
;

135 
size
 > 
MAX_BIG_FIELD_BITS
) {

136 
§c
 -(
uöt32_t
);

137 
de°
 -(
uöt32_t
);

138 
size
 -
UINT32_BIT
;

139 *(
uöt32_t
 *Ë
de°
 = *(c⁄° 
uöt64_t
 *Ë
§c
 >> 
off£t
;

144 i‡(
size
 > 0) {

145 
uöt64_t
 
fõld
 = 
	`gëBigFõld
(
sMem‹y
, 
sour˚
, 
size
);

146 
	`£tBigFõld
(
fõld
, 
dMem‹y
, 
de°ö©i⁄
, 
size
);

148 
	}
}

151 
boﬁ
 
	$ßmeBôs
(c⁄° 
byã
 *
mem1
, 
uöt64_t
 
off£t1
, c⁄° byã *
mem2
,

152 
uöt64_t
 
off£t2
, 
size
)

154 
size
 >
MAX_FIELD_BITS
) {

155 
fõld1
 = 
	`gëFõld
(
mem1
, 
off£t1
, 
MAX_FIELD_BITS
);

156 
fõld2
 = 
	`gëFõld
(
mem2
, 
off£t2
, 
MAX_FIELD_BITS
);

157 i‡(
fõld1
 !
fõld2
Ë 
Ál£
;

158 
off£t1
 +
MAX_FIELD_BITS
;

159 
off£t2
 +
MAX_FIELD_BITS
;

160 
size
 -
MAX_FIELD_BITS
;

162 i‡(
size
 > 0) {

163 
fõld1
 = 
	`gëFõld
(
mem1
, 
off£t1
, 
size
);

164 
fõld2
 = 
	`gëFõld
(
mem2
, 
off£t2
, 
size
);

165 i‡(
fõld1
 !
fõld2
Ë 
Ál£
;

167  
åue
;

168 
	}
}

	@uds/bits.h

22 #i‚de‡
BITS_H


23 
	#BITS_H
 1

	)

25 
	~"compûî.h
"

26 
	~"ty≥Defs.h
"

49 íum { 
	mMAX_FIELD_BITS
 = ((
uöt32_t
Ë- 1Ë* 
CHAR_BIT
 + 1 };

60 íum { 
	mPOST_FIELD_GUARD_BYTES
 = (
uöt64_t
) - 1 };

71 
INLINE
 
	$gëFõld
(c⁄° 
byã
 *
mem‹y
, 
uöt64_t
 
off£t
,

72 
size
)

74 c⁄° 
uöt32_t
 *
addr
 = (c⁄° uöt32_à*Ë(
mem‹y
 + 
off£t
 / 
CHAR_BIT
);

75  (*
addr
 >> (
off£t
 % 
CHAR_BIT
)Ë& ((1 << 
size
) - 1);

76 
	}
}

88 
INLINE
 
	$£tFõld
(
vÆue
, 
byã
 *
mem‹y
, 
uöt64_t
 
off£t
,

89 
size
)

91 
uöt32_t
 *
addr
 = (uöt32_à*Ë(
mem‹y
 + 
off£t
 / 
CHAR_BIT
);

92 
shi·
 = 
off£t
 % 
CHAR_BIT
;

93 *
addr
 &~(((1 << 
size
Ë- 1Ë<< 
shi·
);

94 *
addr
 |
vÆue
 << 
shi·
;

95 
	}
}

106 
INLINE
 
	$£tO√
(
byã
 *
mem‹y
, 
uöt64_t
 
off£t
, 
size
)

108 i‡(
size
 > 0) {

109 
byã
 *
addr
 = 
mem‹y
 + 
off£t
 / 
CHAR_BIT
;

110 
shi·
 = 
off£t
 % 
CHAR_BIT
;

111 
cou¡
 = 
size
 + 
shi·
 > 
CHAR_BIT
 ? CHAR_BIT - shift : size;

112 *
addr
++ |((1 << 
cou¡
Ë- 1Ë<< 
shi·
;

113 
size
 -
cou¡
; sizê> 
CHAR_BIT
; size -= CHAR_BIT) {

114 *
addr
++ = 0xFF;

116 i‡(
size
) {

117 *
addr
 |~(0xFF << 
size
);

120 
	}
}

131 
INLINE
 
	$£tZîo
(
byã
 *
mem‹y
, 
uöt64_t
 
off£t
, 
size
)

133 i‡(
size
 > 0) {

134 
byã
 *
addr
 = 
mem‹y
 + 
off£t
 / 
CHAR_BIT
;

135 
shi·
 = 
off£t
 % 
CHAR_BIT
;

136 
cou¡
 = 
size
 + 
shi·
 > 
CHAR_BIT
 ? CHAR_BIT - shift : size;

137 *
addr
++ &~(((1 << 
cou¡
Ë- 1Ë<< 
shi·
);

138 
size
 -
cou¡
; sizê> 
CHAR_BIT
; size -= CHAR_BIT) {

139 *
addr
++ = 0;

141 i‡(
size
) {

142 *
addr
 &0xFF << 
size
;

145 
	}
}

156 
gëByãs
(c⁄° 
byã
 *
mem‹y
, 
uöt64_t
 
off£t
, byã *
de°ö©i⁄
, 
size
);

167 
£tByãs
(
byã
 *
mem‹y
, 
uöt64_t
 
off£t
, c⁄° byã *
sour˚
, 
size
);

180 
moveBôs
(c⁄° 
byã
 *
sMem‹y
, 
uöt64_t
 
sour˚
, byã *
dMem‹y
,

181 
uöt64_t
 
de°ö©i⁄
, 
size
);

194 
boﬁ
 
	$ßmeBôs
(c⁄° 
byã
 *
mem1
, 
uöt64_t
 
off£t1
, c⁄° byã *
mem2
,

195 
uöt64_t
 
off£t2
, 
size
)

196 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

	@uds/block.c

22 
	~"uds-block.h
"

24 
	~"c⁄ãxt.h
"

25 
	~"„©uªDefs.h
"

26 
	~"nŸifiˇti⁄Defs.h
"

27 
	~"ªque°.h
"

28 
	~"uds-îr‹.h
"

30 
h™dÀBlockCÆlback
(
Reque°
 *
ªque°
);

38 
	$ícodeBlockMëad©a
(c⁄° *
mëad©a
, 
Reque°
 *
ªque°
)

40 
	`mem˝y
(
ªque°
->
√wMëad©a
.
d©a
, 
mëad©a
,Ñeque°->
c⁄ãxt
->
mëad©aSize
);

41 
	}
}

43 #i‡
NAMESPACES


45 
	$udsO≥nBlockC⁄ãxt
(
UdsIndexSessi⁄
 
£ssi⁄
,

46 c⁄° 
UdsName•a˚
 *
«me•a˚
,

47 
mëad©aSize
,

48 
UdsBlockC⁄ãxt
 *
c⁄ãxt
)

50 i‡(
c⁄ãxt
 =
NULL
) {

51  
UDS_CONTEXT_PTR_REQUIRED
;

53 
ªsu…
 = 
	`›íC⁄ãxt
(
£ssi⁄
, 
«me•a˚
, 
mëad©aSize
,

54 
ícodeBlockMëad©a
, 0, 
BLOCK_CONTEXT
,

55 
h™dÀBlockCÆlback
, &
c⁄ãxt
->
id
);

56 i‡(
ªsu…
 =
UDS_SUCCESS
) {

57 
	`nŸifyBlockC⁄ãxtO≥√d
(
£ssi⁄
, *
c⁄ãxt
);

59  
ªsu…
;

60 
	}
}

63 
	$udsO≥nBlockC⁄ãxt
(
UdsIndexSessi⁄
 
£ssi⁄
,

64 
mëad©aSize
,

65 
UdsBlockC⁄ãxt
 *
c⁄ãxt
)

67 i‡(
c⁄ãxt
 =
NULL
) {

68  
UDS_CONTEXT_PTR_REQUIRED
;

70 
ªsu…
 = 
	`›íC⁄ãxt
(
£ssi⁄
, 
mëad©aSize
,

71 
ícodeBlockMëad©a
, 0, 
BLOCK_CONTEXT
,

72 
h™dÀBlockCÆlback
, &
c⁄ãxt
->
id
);

73 i‡(
ªsu…
 =
UDS_SUCCESS
) {

74 
	`nŸifyBlockC⁄ãxtO≥√d
(
£ssi⁄
, *
c⁄ãxt
);

76  
ªsu…
;

77 
	}
}

81 
	$udsClo£BlockC⁄ãxt
(
UdsBlockC⁄ãxt
 
c⁄ãxt
)

83 
ªsu…
 = 
	`˛o£C⁄ãxt
(
c⁄ãxt
.
id
, 
BLOCK_CONTEXT
);

84 i‡(
ªsu…
 =
UDS_SUCCESS
) {

85 
	`nŸifyBlockC⁄ãxtClo£d
(
c⁄ãxt
);

87  
ªsu…
;

88 
	}
}

91 
	$udsFlushBlockC⁄ãxt
(
UdsBlockC⁄ãxt
 
c⁄ãxt
)

93  
	`ÊushC⁄ãxt
(
c⁄ãxt
.
id
, 
BLOCK_CONTEXT
);

94 
	}
}

97 
	$udsSèπChunkO≥øti⁄
(
UdsReque°
 *
ªque°
)

99 i‡(
ªque°
->
ˇŒback
 =
NULL
) {

100  
UDS_CALLBACK_REQUIRED
;

102 
ªque°
->
ty≥
) {

103 
UDS_DELETE
:

104 
UDS_POST
:

105 
UDS_QUERY
:

106 
UDS_UPDATE
:

109  
UDS_INVALID_OPERATION_TYPE
;

111 
ªque°
->
found
 = 
Ál£
;

112 
	`mem£t
(
ªque°
->
¥iv©e
, 0, (request->private));

113  
	`œunchAŒoˇãdClõ¡Reque°
((
Reque°
 *Ë
ªque°
);

114 
	}
}

117 
	$udsUpd©eBlockM≠pög
(
UdsBlockC⁄ãxt
 
c⁄ãxt
,

118 
UdsCookõ
 
cookõ
,

119 c⁄° 
UdsChunkName
 *
blockName
,

120 
UdsBlockAddªss
 
blockAddªss
)

122 i‡(
blockName
 =
NULL
) {

123  
UDS_CHUNK_NAME_REQUIRED
;

125 i‡(
blockAddªss
 =
NULL
) {

126  
UDS_BLOCK_ADDRESS_REQUIRED
;

128  
	`œunchClõ¡Reque°
(
c⁄ãxt
.
id
, 
BLOCK_CONTEXT
, 
UDS_UPDATE
, 
Ál£
,

129 
blockName
, 
cookõ
, 
blockAddªss
, 0, 
NULL
);

130 
	}
}

133 
	$udsDñëeBlockM≠pög
(
UdsBlockC⁄ãxt
 
c⁄ãxt
,

134 
UdsCookõ
 
cookõ
,

135 c⁄° 
UdsChunkName
 *
blockName
)

137 i‡(
blockName
 =
NULL
) {

138  
UDS_CHUNK_NAME_REQUIRED
;

140  
	`œunchClõ¡Reque°
(
c⁄ãxt
.
id
, 
BLOCK_CONTEXT
, 
UDS_DELETE
, 
Ál£
,

141 
blockName
, 
cookõ
, 
NULL
, 0, NULL);

142 
	}
}

145 
	$udsPo°Block
(
UdsBlockC⁄ãxt
 
c⁄ãxt
,

146 
UdsCookõ
 
cookõ
,

147 
UdsBlockAddªss
 
blockAddªss
,

148 
size_t
 
blockLígth
,

149 c⁄° *
d©a
)

151 i‡(
blockAddªss
 =
NULL
) {

152  
UDS_BLOCK_ADDRESS_REQUIRED
;

154 i‡(
d©a
 =
NULL
) {

155  
UDS_CHUNK_DATA_REQUIRED
;

157  
	`œunchClõ¡Reque°
(
c⁄ãxt
.
id
, 
BLOCK_CONTEXT
, 
UDS_POST
, 
Ál£
, 
NULL
,

158 
cookõ
, 
blockAddªss
, 
blockLígth
, 
d©a
);

159 
	}
}

162 
	$udsPo°BlockName
(
UdsBlockC⁄ãxt
 
c⁄ãxt
,

163 
UdsCookõ
 
cookõ
,

164 
UdsBlockAddªss
 
blockAddªss
,

165 c⁄° 
UdsChunkName
 *
chunkName
)

167 i‡(
blockAddªss
 =
NULL
) {

168  
UDS_BLOCK_ADDRESS_REQUIRED
;

170 i‡(
chunkName
 =
NULL
) {

171  
UDS_CHUNK_NAME_REQUIRED
;

173  
	`œunchClõ¡Reque°
(
c⁄ãxt
.
id
, 
BLOCK_CONTEXT
, 
UDS_POST
, 
Ál£
,

174 
chunkName
, 
cookõ
, 
blockAddªss
, 0, 
NULL
);

175 
	}
}

178 
	$udsQuîyBlockName
(
UdsBlockC⁄ãxt
 
c⁄ãxt
,

179 
UdsCookõ
 
cookõ
,

180 
UdsBlockAddªss
 
blockAddªss
,

181 c⁄° 
UdsChunkName
 *
blockName
,

182 
boﬁ
 
upd©e
)

184 i‡(
blockName
 =
NULL
) {

185  
UDS_CHUNK_NAME_REQUIRED
;

187  
	`œunchClõ¡Reque°
(
c⁄ãxt
.
id
, 
BLOCK_CONTEXT
, 
UDS_QUERY
, 
upd©e
,

188 
blockName
, 
cookõ
, 
blockAddªss
, 0, 
NULL
);

189 
	}
}

192 
	$udsCheckBlock
(
UdsBlockC⁄ãxt
 
c⁄ãxt
,

193 
UdsCookõ
 
cookõ
,

194 
UdsBlockAddªss
 
blockAddªss
,

195 
size_t
 
blockLígth
,

196 c⁄° *
d©a
,

197 
boﬁ
 
upd©e
)

199 i‡(
d©a
 =
NULL
) {

200  
UDS_CHUNK_DATA_REQUIRED
;

202  
	`œunchClõ¡Reque°
(
c⁄ãxt
.
id
, 
BLOCK_CONTEXT
, 
UDS_QUERY
, 
upd©e
,

203 
NULL
, 
cookõ
, 
blockAddªss
, 
blockLígth
, 
d©a
);

204 
	}
}

207 
	$udsRegi°îDedu≥BlockCÆlback
(
UdsBlockC⁄ãxt
 
c⁄ãxt
,

208 
UdsDedu≥BlockCÆlback
 
cb
,

209 *
ˇŒbackArgumít
)

211 
IndexCÆlbackFun˘i⁄
 
ˇŒbackFun˘i⁄
;

212 i‡(
cb
 !
NULL
) {

213 
ˇŒbackFun˘i⁄
.
blockCÆlback
 = 
cb
;

215  
	`ªgi°îDedu≥CÆlback
(
c⁄ãxt
.
id
, 
BLOCK_CONTEXT
,

216 ((
cb
 =
NULL
Ë? NULL : &
ˇŒbackFun˘i⁄
),

217 
ˇŒbackArgumít
);

218 
	}
}

221 
	$h™dÀBlockCÆlback
(
Reque°
 *
ªque°
)

223 
UdsBlockAddªss
 
du∂iˇãAddªss
 = 
NULL
;

224 i‡((
ªque°
->
ty≥
 !
UDS_DELETE
)) {

225 
du∂iˇãAddªss
 = &
ªque°
->
√wMëad©a
.
d©a
;

228 
UdsBlockAddªss
 
ˇn⁄iˇlAddªss
 = 
NULL
;

229 i‡(
ªque°
->
loˇti⁄
 !
LOC_UNAVAILABLE
) {

230 
ˇn⁄iˇlAddªss
 = &
ªque°
->
ﬁdMëad©a
.
d©a
;

233 
UdsC⁄ãxt
 *
c⁄ãxt
 = 
ªque°
->context;

234 
UdsBlockC⁄ãxt
 
blockC⁄ãxt
 = { .
id
 = 
c⁄ãxt
->id };

235 
UdsDedu≥BlockCÆlback
 
ˇŒback
 = 
c⁄ãxt
->
ˇŒbackFun˘i⁄
.
blockCÆlback
;

236 (*
ˇŒback
)(
blockC⁄ãxt
, 
ªque°
->
ty≥
,Ñeque°->
°©us
,Ñeque°->
cookõ
,

237 
du∂iˇãAddªss
, 
ˇn⁄iˇlAddªss
,

238 &
ªque°
->
hash
,Ñeque°->
d©aLígth
, 
c⁄ãxt
->
ˇŒbackArgumít
);

239 
	}
}

242 
	$udsSëBlockC⁄ãxtReque°QueueLimô
(
UdsBlockC⁄ãxt
 
c⁄ãxt
,

243 
maxReque°s
)

245  
	`£tReque°QueueLimô
(
c⁄ãxt
.
id
, 
BLOCK_CONTEXT
, 
maxReque°s
);

246 
	}
}

249 
	$udsSëBlockC⁄ãxtHashAlg‹ôhm
(
UdsBlockC⁄ãxt
 
c⁄ãxt
,

250 
UdsHashAlg‹ôhm
 
Æg‹ôhm
)

252  
	`£tChunkNameAlg‹ôhm
(
c⁄ãxt
.
id
, 
BLOCK_CONTEXT
, 
Æg‹ôhm
);

253 
	}
}

256 
	$udsGëBlockC⁄ãxtC⁄figuøti⁄
(
UdsBlockC⁄ãxt
 
c⁄ãxt
,

257 
UdsC⁄figuøti⁄
 *
c⁄f
)

259  
	`gëC⁄figuøti⁄
(
c⁄ãxt
.
id
, 
BLOCK_CONTEXT
, 
c⁄f
);

260 
	}
}

263 
	$udsGëBlockC⁄ãxtIndexSèts
(
UdsBlockC⁄ãxt
 
c⁄ãxt
,

264 
UdsIndexSèts
 *
°©s
)

266  
	`gëC⁄ãxtIndexSèts
(
c⁄ãxt
.
id
, 
BLOCK_CONTEXT
, 
°©s
);

267 
	}
}

270 
	$udsGëBlockC⁄ãxtSèts
(
UdsBlockC⁄ãxt
 
c⁄ãxt
,

271 
UdsC⁄ãxtSèts
 *
°©s
)

273  
	`gëC⁄ãxtSèts
(
c⁄ãxt
.
id
, 
BLOCK_CONTEXT
, 
°©s
);

274 
	}
}

277 
	$udsRe£tBlockC⁄ãxtSèts
(
UdsBlockC⁄ãxt
 
c⁄ãxt
)

279  
	`ª£tSèts
(
c⁄ãxt
.
id
, 
BLOCK_CONTEXT
);

280 
	}
}

	@uds/blockIORegion.c

22 
	~"blockIORegi⁄.h
"

24 
	~"compûî.h
"

25 
	~"loggî.h
"

26 
	~"mem‹yAŒoc.h
"

27 
	~"numîic.h
"

28 
	~"≥rmas£π.h
"

29 
	~"°rögUtûs.h
"

31 
	sblockIORegi⁄
 {

32 
IORegi⁄
 
	mcomm⁄
;

33 
IORegi⁄
 *
	m∑ª¡
;

34 
IOAc˚ssMode
 
	mac˚ss
;

35 
size_t
 
	mblockSize
;

36 
size_t
 
	mbe°Size
;

37 
off_t
 
	m°¨t
;

38 
off_t
 
	míd
;

39 } 
	tBlockIORegi⁄
;

41 c⁄° 
IORegi⁄Ops
 *
gëBlockIORegi⁄Ops
();

44 
INLINE
 
BlockIORegi⁄
 *
	$asBlockIORegi⁄
(
IORegi⁄
 *
ªgi⁄
)

46  
	`c⁄èöî_of
(
ªgi⁄
, 
BlockIORegi⁄
, 
comm⁄
);

47 
	}
}

50 
	$›íBlockRegi⁄
(
IORegi⁄
 *
∑ª¡
,

51 
IOAc˚ssMode
 
ac˚ss
,

52 
off_t
 
°¨t
,

53 
off_t
 
íd
,

54 
IORegi⁄
 **
ªgi⁄På
)

56 i‡(
°¨t
 > 
íd
) {

57  
	`logEº‹WôhSåögEº‹
(
UDS_INVALID_ARGUMENT
,

58 "íd (%zdË¥e˚ed†°¨à(%zd)", 
íd
,

59 
°¨t
);

62 i‡(
ac˚ss
 & ~(
IO_ACCESS_MASK
)) {

64  
	`logEº‹WôhSåögEº‹
(
UDS_INVALID_ARGUMENT
,

65 "unknow¿ac˚s†ty≥ %x", 
ac˚ss
);

68 
off_t
 
limô
 = 0;

69 
ªsu…
 = 
	`gëRegi⁄Limô
(
∑ª¡
, &
limô
);

70 i‡(
ªsu…
 !
UDS_SUCCESS
) {

71  
ªsu…
;

73 i‡(
íd
 > 
limô
) {

74  
	`logEº‹WôhSåögEº‹
(
UDS_OUT_OF_RANGE
, "end (%zd)"

76 
íd
, 
limô
);

79 
size_t
 
blockSize
 = 0;

80 
size_t
 
be°Size
 = 0;

81 
ªsu…
 = 
	`gëRegi⁄BlockSize
(
∑ª¡
, &
blockSize
);

82 i‡(
ªsu…
 !
UDS_SUCCESS
) {

83  
ªsu…
;

85 
ªsu…
 = 
	`gëRegi⁄Be°Buf„rSize
(
∑ª¡
, &
be°Size
);

86 i‡(
ªsu…
 !
UDS_SUCCESS
) {

87  
ªsu…
;

90 i‡(
°¨t
 % 
blockSize
 != 0) {

91  
	`logEº‹WôhSåögEº‹
(
UDS_INVALID_ARGUMENT
,

93 
°¨t
);

95 i‡(
íd
 % 
blockSize
 != 0) {

96  
	`logEº‹WôhSåögEº‹
(
UDS_INVALID_ARGUMENT
,

97 "íd off£à(%zdËnŸ blockálig√d", 
íd
);

100 
BlockIORegi⁄
 *
bi‹
;

101 
ªsu…
 = 
	`ALLOCATE
(1, 
BlockIORegi⁄
, "›í blockÑegi⁄", &
bi‹
);

102 i‡(
ªsu…
 !
UDS_SUCCESS
) {

103  
ªsu…
;

106 *
bi‹
 = (
BlockIORegi⁄
) {

107 .
∑ª¡
 =Öarent,

108 .
ac˚ss
 =áccess,

109 .
blockSize
 = blockSize,

110 .
be°Size
 = bestSize,

111 .
°¨t
 = start,

112 .
íd
 =Énd

115 
bi‹
->
comm⁄
.
›s
 = 
	`gëBlockIORegi⁄Ops
();

117 *
ªgi⁄På
 = &
bi‹
->
comm⁄
;

118  
UDS_SUCCESS
;

119 
	}
}

122 c⁄° *
	$dúe˘i⁄OfAc˚ss
(
IOAc˚ssMode
 
ac˚ss
)

124 
ac˚ss
) {

125 
IO_READ
:

128 
IO_WRITE
:

129 
IO_CREATE_WRITE
:

132 
IO_READ_WRITE
:

133 
IO_CREATE_READ_WRITE
:

139 
	}
}

142 
	$vÆid©eIO
(c⁄° 
BlockIORegi⁄
 *
bi‹
,

143 
off_t
 
off£t
,

144 
size_t
 
size
,

145 
size_t
 *
Àngth
,

146 
IOAc˚ssMode
 
ac˚ss
)

148 i‡((
ac˚ss
 & 
bi‹
->access) !=áccess) {

149  
	`logEº‹WôhSåögEº‹
(
UDS_BAD_IO_DIRECTION
,

151 
	`dúe˘i⁄OfAc˚ss
(
ac˚ss
));

154 i‡(
off£t
 % 
bi‹
->
blockSize
 != 0) {

155  
	`logEº‹WôhSåögEº‹
(
UDS_INCORRECT_ALIGNMENT
,

156 "Æignmíà%zdÇŸ mu…ùÀ o‡%zd", 
off£t
,

157 
bi‹
->
blockSize
);

160 i‡(
size
 % 
bi‹
->
blockSize
 != 0) {

161  
	`logEº‹WôhSåögEº‹
(
UDS_BUFFER_ERROR
,

163 
size
, 
bi‹
->
blockSize
);

166 i‡(*
Àngth
 > 
size
) {

167  
	`logEº‹WôhSåögEº‹
(
UDS_BUFFER_ERROR
,

169 *
Àngth
, 
size
);

172 i‡(
off£t
 > 
bi‹
->
íd
 - bi‹->
°¨t
) {

173  
	`logEº‹WôhSåögEº‹
(
UDS_OUT_OF_RANGE
,

175 
off£t
, 
bi‹
->
íd
 - bi‹->
°¨t
);

178 i‡((
off£t
 =(
off_t
Ë(
bi‹
->
íd
 - bi‹->
°¨t
)Ë&& (*
Àngth
 > 0)) {

179  
UDS_END_OF_FILE
;

182 i‡((
ac˚ss
 & 
IO_READ
) == IO_READ) {

183 *
Àngth
 = 
	`möSizeT
(
bi‹
->
íd
 - bi‹->
°¨t
, 
off£t
 + 
size
) - offset;

185 i‡((
off£t
 < 0) ||

186 ((
off£t
 + (
ssize_t
Ë*
Àngth
Ë> (
bi‹
->
íd
 - bi‹->
°¨t
))) {

187  
	`logEº‹WôhSåögEº‹
(
UDS_OUT_OF_RANGE
,

189 
off£t
, off£à+ *
Àngth
,

190 
bi‹
->
íd
 - bi‹->
°¨t
);

193  
UDS_SUCCESS
;

194 
	}
}

197 
	$bi‹_˛o£
(
IORegi⁄
 *
ªgi⁄
)

199 
	`FREE
(
	`asBlockIORegi⁄
(
ªgi⁄
));

200  
UDS_SUCCESS
;

201 
	}
}

204 
	$bi‹_gëLimô
(
IORegi⁄
 *
ªgi⁄
,

205 
off_t
 *
limô
)

207 
BlockIORegi⁄
 *
bi‹
 = 
	`asBlockIORegi⁄
(
ªgi⁄
);

209 *
limô
 = 
bi‹
->
íd
 - bi‹->
°¨t
;

210  
UDS_SUCCESS
;

211 
	}
}

214 
	$bi‹_gëD©aSize
(
IORegi⁄
 *
ªgi⁄
,

215 
off_t
 *
exã¡
)

217 
BlockIORegi⁄
 *
bi‹
 = 
	`asBlockIORegi⁄
(
ªgi⁄
);

219 
off_t
 
limô
 = 
INT64_MAX
;

220 
ªsu…
 = 
	`gëRegi⁄Limô
(
bi‹
->
∑ª¡
, &
limô
);

221 i‡(
ªsu…
 =
UDS_SUCCESS
) {

222 
off_t
 
ãmp
 = 
INT64_MAX
;

223 
ªsu…
 = 
	`gëRegi⁄D©aSize
(
bi‹
->
∑ª¡
, &
ãmp
);

224 i‡(
ªsu…
 =
UDS_SUCCESS
) {

225 i‡(
ãmp
 < 
limô
) {

226 
limô
 = 
ãmp
;

228 i‡(
bi‹
->
íd
 < 
limô
) {

229 
limô
 = 
bi‹
->
íd
;

231 i‡(
limô
 < 
bi‹
->
°¨t
) {

232 *
exã¡
 = 0;

234 *
exã¡
 = 
limô
 - 
bi‹
->
°¨t
;

238  
ªsu…
;

239 
	}
}

242 
	$bi‹_˛ór
(
IORegi⁄
 *
ªgi⁄
)

244 
BlockIORegi⁄
 *
bi‹
 = 
	`asBlockIORegi⁄
(
ªgi⁄
);

246 
size_t
 
Àn
 = 0;

248 
ªsu…
 = 
	`vÆid©eIO
(
bi‹
, 0, 0, &
Àn
, 
IO_WRITE
);

249 i‡(
ªsu…
 !
UDS_SUCCESS
) {

250  
ªsu…
;

253 
byã
 *
buf
;

255 
ªsu…
 = 
	`ALLOCATE_IO_ALIGNED
(
bi‹
->
be°Size
, 
byã
, "˛órög buf„r", &
buf
);

256 i‡(
ªsu…
 !
UDS_SUCCESS
) {

257  
ªsu…
;

259 
	`mem£t
(
buf
, 0, 
bi‹
->
be°Size
);

261 
off_t
 
off£t
 = 
bi‹
->
°¨t
;

262 
off£t
 < 
bi‹
->
íd
) {

263 
size_t
 
Àn
 = 
	`möSizeT
(
bi‹
->
íd
 - 
off£t
, bi‹->
be°Size
);

264 
ªsu…
 = 
	`wrôeToRegi⁄
(
bi‹
->
∑ª¡
, 
off£t
, 
buf
, bi‹->
be°Size
, 
Àn
);

265 i‡(
ªsu…
 !
UDS_SUCCESS
) {

268 
off£t
 +
Àn
;

271 
	`FREE
(
buf
);

272  
ªsu…
;

273 
	}
}

276 
	$bi‹_wrôe
(
IORegi⁄
 *
ªgi⁄
,

277 
off_t
 
off£t
,

278 c⁄° *
d©a
,

279 
size_t
 
size
,

280 
size_t
 
Àn
)

282 
BlockIORegi⁄
 *
bi‹
 = 
	`asBlockIORegi⁄
(
ªgi⁄
);

283 
ªsu…
 = 
	`vÆid©eIO
(
bi‹
, 
off£t
, 
size
, &
Àn
, 
IO_WRITE
);

284 i‡(
ªsu…
 !
UDS_SUCCESS
) {

285  
ªsu…
;

287  
	`wrôeToRegi⁄
(
bi‹
->
∑ª¡
, bi‹->
°¨t
 + 
off£t
, 
d©a
, 
size
, 
Àn
);

288 
	}
}

291 
	$bi‹_ªad
(
IORegi⁄
 *
ªgi⁄
,

292 
off_t
 
off£t
,

293 *
buf„r
,

294 
size_t
 
size
,

295 
size_t
 *
Àngth
)

297 
BlockIORegi⁄
 *
bi‹
 = 
	`asBlockIORegi⁄
(
ªgi⁄
);

299 
size_t
 
Àn
 = (
Àngth
 =
NULL
Ë? 
size
 : *length;

301 
ªsu…
 = 
	`vÆid©eIO
(
bi‹
, 
off£t
, 
size
, &
Àn
, 
IO_READ
);

302 i‡(
ªsu…
 !
UDS_SUCCESS
) {

303  
ªsu…
;

306 
ªsu…
 = 
	`ªadFromRegi⁄
(
bi‹
->
∑ª¡
, bi‹->
°¨t
 + 
off£t
,

307 
buf„r
, 
Àn
, 
NULL
);

308 i‡(
ªsu…
 =
UDS_SUCCESS
 && 
Àngth
 !
NULL
) {

309 *
Àngth
 = 
Àn
;

311  
ªsu…
;

312 
	}
}

315 
	$bi‹_gëBlockSize
(
IORegi⁄
 *
ªgi⁄
, 
size_t
 *
blockSize
)

317 *
blockSize
 = 
	`asBlockIORegi⁄
(
ªgi⁄
)->blockSize;

318  
UDS_SUCCESS
;

319 
	}
}

322 
	$bi‹_gëBe°Size
(
IORegi⁄
 *
ªgi⁄
, 
size_t
 *
buf„rSize
)

324 *
buf„rSize
 = 
	`asBlockIORegi⁄
(
ªgi⁄
)->
be°Size
;

325  
UDS_SUCCESS
;

326 
	}
}

329 
	$bi‹_syncC⁄ã¡s
(
IORegi⁄
 *
ªgi⁄
)

331 
BlockIORegi⁄
 *
bi‹
 = 
	`asBlockIORegi⁄
(
ªgi⁄
);

333  
	`syncRegi⁄C⁄ã¡s
(
bi‹
->
∑ª¡
);

334 
	}
}

338 c⁄° 
IORegi⁄Ops
 
	gblockIORegi⁄Ops
 = {

339 .
˛o£
 = 
bi‹_˛o£
,

340 .
	ggëLimô
 = 
bi‹_gëLimô
,

341 .
	ggëD©aSize
 = 
bi‹_gëD©aSize
,

342 .
	g˛ór
 = 
bi‹_˛ór
,

343 .
	gwrôe
 = 
bi‹_wrôe
,

344 .
	gªad
 = 
bi‹_ªad
,

345 .
	ggëBlockSize
 = 
bi‹_gëBlockSize
,

346 .
	ggëBe°Size
 = 
bi‹_gëBe°Size
,

347 .
	gsyncC⁄ã¡s
 = 
bi‹_syncC⁄ã¡s
,

350 c⁄° 
IORegi⁄Ops
 *
	$gëBlockIORegi⁄Ops
()

352  &
blockIORegi⁄Ops
;

353 
	}
}

	@uds/blockIORegion.h

22 #i‚de‡
BLOCK_IO_REGION_H


23 
	#BLOCK_IO_REGION_H


	)

25 
	~"ioRegi⁄.h
"

27 
	~"ac˚ssMode.h
"

41 
	$›íBlockRegi⁄
(
IORegi⁄
 *
∑ª¡
,

42 
IOAc˚ssMode
 
ac˚ss
,

43 
off_t
 
°¨t
,

44 
off_t
 
íd
,

45 
IORegi⁄
 **
ªgi⁄På
)

46 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

	@uds/buffer.c

22 
	~"buf„r.h
"

24 
	~"buf„rPriv©e.h
"

25 
	~"loggî.h
"

26 
	~"mem‹yAŒoc.h
"

27 
	~"numîic.h
"

28 
	~"≥rmas£π.h
"

29 
	~"ty≥Defs.h
"

32 
	$wøpBuf„r
(
byã
 *
byãs
,

33 
size_t
 
Àngth
,

34 
size_t
 
c⁄ã¡Lígth
,

35 
Buf„r
 **
buf„rPå
)

37 
ªsu…
 = 
	`ASSERT
((
c⁄ã¡Lígth
 <
Àngth
),

39 
Àngth
, 
c⁄ã¡Lígth
);

40 
Buf„r
 *
buf„r
;

41 
ªsu…
 = 
	`ALLOCATE
(1, 
Buf„r
, "buf„r", &
buf„r
);

42 i‡(
ªsu…
 !
UDS_SUCCESS
) {

43  
ªsu…
;

46 
buf„r
->
d©a
 = 
byãs
;

47 
buf„r
->
°¨t
 = 0;

48 
buf„r
->
íd
 = 
c⁄ã¡Lígth
;

49 
buf„r
->
Àngth
 =Üength;

50 
buf„r
->
wøµed
 = 
åue
;

52 *
buf„rPå
 = 
buf„r
;

53  
UDS_SUCCESS
;

54 
	}
}

57 
	$makeBuf„r
(
size_t
 
size
, 
Buf„r
 **
√wBuf„r
)

59 
byã
 *
d©a
;

60 
ªsu…
 = 
	`ALLOCATE
(
size
, 
byã
, "buf„∏d©a", &
d©a
);

61 i‡(
ªsu…
 !
UDS_SUCCESS
) {

62  
ªsu…
;

65 
Buf„r
 *
buf„r
;

66 
ªsu…
 = 
	`wøpBuf„r
(
d©a
, 
size
, 0, &
buf„r
);

67 i‡(
ªsu…
 !
UDS_SUCCESS
) {

68 
	`FREE
(
d©a
);

69  
ªsu…
;

72 
buf„r
->
wøµed
 = 
Ál£
;

73 *
√wBuf„r
 = 
buf„r
;

74  
UDS_SUCCESS
;

75 
	}
}

78 
	$‰ìBuf„r
(
Buf„r
 **
pBuf„r
)

80 
Buf„r
 *
buf„r
 = *
pBuf„r
;

81 *
pBuf„r
 = 
NULL
;

82 i‡(
buf„r
 =
NULL
) {

85 i‡(!
buf„r
->
wøµed
) {

86 
	`FREE
(
buf„r
->
d©a
);

88 
	`FREE
(
buf„r
);

89 
	}
}

92 
size_t
 
	$buf„rLígth
(
Buf„r
 *
buf„r
)

94  
buf„r
->
Àngth
;

95 
	}
}

98 
ölöe
 
size_t
 
	$c⁄ã¡Lígth
(
Buf„r
 *
buf„r
)

100  
buf„r
->
íd
 - buf„r->
°¨t
;

101 
	}
}

104 
size_t
 
	$uncom∑˘edAmou¡
(
Buf„r
 *
buf„r
)

106  
buf„r
->
°¨t
;

107 
	}
}

110 
ölöe
 
size_t
 
	$avaûabÀS∑˚
(
Buf„r
 *
buf„r
)

112  
buf„r
->
Àngth
 - buf„r->
íd
;

113 
	}
}

116 
size_t
 
	$buf„rU£d
(
Buf„r
 *
buf„r
)

118  
buf„r
->
íd
;

119 
	}
}

122 
	$growBuf„r
(
Buf„r
 *
buf„r
, 
size_t
 
Àngth
)

124 i‡(
buf„r
 =
NULL
) {

125  
	`logW¨nögWôhSåögEº‹
(
UDS_INVALID_ARGUMENT
,

129 i‡(
buf„r
->
wøµed
) {

130  
	`logW¨nögWôhSåögEº‹
(
UDS_INVALID_ARGUMENT
,

133 i‡(
buf„r
->
íd
 > 
Àngth
) {

134  
	`logW¨nögWôhSåögEº‹
(
UDS_INVALID_ARGUMENT
,

138 
byã
 *
d©a
;

139 
ªsu…
 = 
	`ªÆloˇãMem‹y
(
buf„r
->
d©a
, buf„r->
Àngth
,Üength,

140 "buf„∏d©a", &
d©a
);

141 i‡(
ªsu…
 !
UDS_SUCCESS
) {

142  
ªsu…
;

145 
buf„r
->
d©a
 = data;

146 
buf„r
->
Àngth
 =Üength;

147  
UDS_SUCCESS
;

148 
	}
}

151 
boﬁ
 
	$ísuªAvaûabÀS∑˚
(
Buf„r
 *
buf„r
, 
size_t
 
byãs
)

153 i‡(
	`avaûabÀS∑˚
(
buf„r
Ë>
byãs
) {

154  
åue
;

156 
	`com∑˘Buf„r
(
buf„r
);

157  (
	`avaûabÀS∑˚
(
buf„r
Ë>
byãs
);

158 
	}
}

161 
	$com∑˘Buf„r
(
Buf„r
 *
buf„r
)

163 i‡((
buf„r
->
°¨t
 =0Ë|| (buf„r->
íd
 == 0)) {

166 
size_t
 
byãsToMove
 = 
buf„r
->
íd
 - buf„r->
°¨t
;

167 
	`memmove
(
buf„r
->
d©a
, buf„r->d©®+ buf„r->
°¨t
, 
byãsToMove
);

168 
buf„r
->
°¨t
 = 0;

169 
buf„r
->
íd
 = 
byãsToMove
;

170 
	}
}

173 
	$ª£tBuf„rEnd
(
Buf„r
 *
buf„r
, 
size_t
 
íd
)

175 i‡(
íd
 > 
buf„r
->
Àngth
) {

176  
UDS_BUFFER_ERROR
;

178 
buf„r
->
íd
 =Énd;

179 i‡(
buf„r
->
°¨t
 > buf„r->
íd
) {

180 
buf„r
->
°¨t
 = buf„r->
íd
;

182  
UDS_SUCCESS
;

183 
	}
}

186 
	$skùF‹w¨d
(
Buf„r
 *
buf„r
, 
size_t
 
byãsToSkù
)

188 i‡(
	`c⁄ã¡Lígth
(
buf„r
Ë< 
byãsToSkù
) {

189  
UDS_BUFFER_ERROR
;

192 
buf„r
->
°¨t
 +
byãsToSkù
;

193  
UDS_SUCCESS
;

194 
	}
}

197 
	$ªwödBuf„r
(
Buf„r
 *
buf„r
, 
size_t
 
byãsToRewöd
)

199 i‡(
buf„r
->
°¨t
 < 
byãsToRewöd
) {

200  
UDS_BUFFER_ERROR
;

203 
buf„r
->
°¨t
 -
byãsToRewöd
;

204  
UDS_SUCCESS
;

205 
	}
}

208 
boﬁ
 
	$hasSameByãs
(
Buf„r
 *
buf„r
, c⁄° 
byã
 *
d©a
, 
size_t
 
Àngth
)

210  ((
	`c⁄ã¡Lígth
(
buf„r
Ë>
Àngth
)

211 && (
	`memcmp
(
buf„r
->
d©a
 + buf„r->
°¨t
, d©a, 
Àngth
) == 0));

212 
	}
}

215 
boﬁ
 
	$equÆBuf„rs
(
Buf„r
 *
buf„r1
, Buf„∏*
buf„r2
)

217  
	`hasSameByãs
(
buf„r1
, 
buf„r2
->
d©a
 + buf„r2->
°¨t
,

218 
	`c⁄ã¡Lígth
(
buf„r2
));

219 
	}
}

222 
	$gëByã
(
Buf„r
 *
buf„r
, 
byã
 *
byãPå
)

224 i‡(
	`c⁄ã¡Lígth
(
buf„r
Ë< (
byã
)) {

225  
UDS_BUFFER_ERROR
;

228 *
byãPå
 = 
buf„r
->
d©a
[buf„r->
°¨t
++];

229  
UDS_SUCCESS
;

230 
	}
}

233 
	$≥ekByã
(
Buf„r
 *
buf„r
, 
size_t
 
off£t
, 
byã
 *
byãPå
)

235 i‡(
	`c⁄ã¡Lígth
(
buf„r
Ë< (
off£t
 + (
byã
))) {

236  
UDS_BUFFER_ERROR
;

239 *
byãPå
 = 
buf„r
->
d©a
[buf„r->
°¨t
 + 
off£t
];

240  
UDS_SUCCESS
;

241 
	}
}

244 
	$putByã
(
Buf„r
 *
buf„r
, 
byã
 
b
)

246 i‡(!
	`ísuªAvaûabÀS∑˚
(
buf„r
, (
byã
))) {

247  
UDS_BUFFER_ERROR
;

250 
buf„r
->
d©a
[buf„r->
íd
++] = 
b
;

251  
UDS_SUCCESS
;

252 
	}
}

255 
	$gëByãsFromBuf„r
(
Buf„r
 *
buf„r
, 
size_t
 
Àngth
, *
de°ö©i⁄
)

257 i‡(
	`c⁄ã¡Lígth
(
buf„r
Ë< 
Àngth
) {

258  
UDS_BUFFER_ERROR
;

261 
	`mem˝y
(
de°ö©i⁄
, 
buf„r
->
d©a
 + buf„r->
°¨t
, 
Àngth
);

262 
buf„r
->
°¨t
 +
Àngth
;

263  
UDS_SUCCESS
;

264 
	}
}

267 
byã
 *
	$gëBuf„rC⁄ã¡s
(
Buf„r
 *
buf„r
)

269  
buf„r
->
d©a
 + buf„r->
°¨t
;

270 
	}
}

273 
	$c›yByãs
(
Buf„r
 *
buf„r
, 
size_t
 
Àngth
, 
byã
 **
de°ö©i⁄På
)

275 
byã
 *
de°ö©i⁄
;

276 
ªsu…
 = 
	`ALLOCATE
(
Àngth
, 
byã
, "copyBytes() buffer",

277 &
de°ö©i⁄
);

278 i‡(
ªsu…
 !
UDS_SUCCESS
) {

279  
ªsu…
;

282 
ªsu…
 = 
	`gëByãsFromBuf„r
(
buf„r
, 
Àngth
, 
de°ö©i⁄
);

283 i‡(
ªsu…
 !
UDS_SUCCESS
) {

284 
	`FREE
(
de°ö©i⁄
);

286 *
de°ö©i⁄På
 = 
de°ö©i⁄
;

288  
ªsu…
;

289 
	}
}

292 
	$putByãs
(
Buf„r
 *
buf„r
, 
size_t
 
Àngth
, c⁄° *
sour˚
)

294 i‡(!
	`ísuªAvaûabÀS∑˚
(
buf„r
, 
Àngth
)) {

295  
UDS_BUFFER_ERROR
;

297 
	`mem˝y
(
buf„r
->
d©a
 + buf„r->
íd
, 
sour˚
, 
Àngth
);

298 
buf„r
->
íd
 +
Àngth
;

299  
UDS_SUCCESS
;

300 
	}
}

303 
	$zîoByãs
(
Buf„r
 *
buf„r
, 
size_t
 
Àngth
)

305 i‡(!
	`ísuªAvaûabÀS∑˚
(
buf„r
, 
Àngth
)) {

306  
UDS_BUFFER_ERROR
;

308 
	`mem£t
(
buf„r
->
d©a
 + buf„r->
íd
, 0, 
Àngth
);

309 
buf„r
->
íd
 +
Àngth
;

310  
UDS_SUCCESS
;

311 
	}
}

314 
	$gëBoﬁón
(
Buf„r
 *
buf„r
, 
boﬁ
 *
b
)

316 
byã
 
by
;

317 
ªsu…
 = 
	`gëByã
(
buf„r
, &
by
);

318 i‡(
ªsu…
 =
UDS_SUCCESS
) {

319 *
b
 = (
by
 == 1);

321  
ªsu…
;

322 
	}
}

325 
	$putBoﬁón
(
Buf„r
 *
buf„r
, 
boﬁ
 
b
)

327  
	`putByã
(
buf„r
, (
byã
Ë(
b
 ? 1 : 0));

328 
	}
}

331 
	$gëUI¡16BEFromBuf„r
(
Buf„r
 *
buf„r
, 
uöt16_t
 *
ui
)

333 i‡(
	`c⁄ã¡Lígth
(
buf„r
Ë< (
uöt16_t
)) {

334  
UDS_BUFFER_ERROR
;

337 
	`decodeUI¡16BE
(
buf„r
->
d©a
, &buf„r->
°¨t
, 
ui
);

338  
UDS_SUCCESS
;

339 
	}
}

342 
	$putUI¡16BEI¡oBuf„r
(
Buf„r
 *
buf„r
, 
uöt16_t
 
ui
)

344 i‡(!
	`ísuªAvaûabÀS∑˚
(
buf„r
, (
uöt16_t
))) {

345  
UDS_BUFFER_ERROR
;

348 
	`ícodeUI¡16BE
(
buf„r
->
d©a
, &buf„r->
íd
, 
ui
);

349  
UDS_SUCCESS
;

350 
	}
}

353 
	$gëUI¡32BEFromBuf„r
(
Buf„r
 *
buf„r
, 
uöt32_t
 *
ui
)

355 i‡(
	`c⁄ã¡Lígth
(
buf„r
Ë< (
uöt32_t
)) {

356  
UDS_BUFFER_ERROR
;

359 
	`decodeUI¡32BE
(
buf„r
->
d©a
, &buf„r->
°¨t
, 
ui
);

360  
UDS_SUCCESS
;

361 
	}
}

364 
	$putUI¡32BEI¡oBuf„r
(
Buf„r
 *
buf„r
, 
uöt32_t
 
ui
)

366 i‡(!
	`ísuªAvaûabÀS∑˚
(
buf„r
, (
uöt32_t
))) {

367  
UDS_BUFFER_ERROR
;

370 
	`ícodeUI¡32BE
(
buf„r
->
d©a
, &buf„r->
íd
, 
ui
);

371  
UDS_SUCCESS
;

372 
	}
}

375 
	$gëUI¡32BEsFromBuf„r
(
Buf„r
 *
buf„r
, 
size_t
 
cou¡
, 
uöt32_t
 *
ui
)

377 i‡(
	`c⁄ã¡Lígth
(
buf„r
Ë< ((
uöt32_t
Ë* 
cou¡
)) {

378  
UDS_BUFFER_ERROR
;

381 
i
 = 0; i < 
cou¡
; i++) {

382 
	`decodeUI¡32BE
(
buf„r
->
d©a
, &buf„r->
°¨t
, 
ui
 + 
i
);

384  
UDS_SUCCESS
;

385 
	}
}

388 
	$putUI¡32BEsI¡oBuf„r
(
Buf„r
 *
buf„r
, 
size_t
 
cou¡
, c⁄° 
uöt32_t
 *
ui
)

390 i‡(!
	`ísuªAvaûabÀS∑˚
(
buf„r
, (
uöt32_t
Ë* 
cou¡
)) {

391  
UDS_BUFFER_ERROR
;

394 
i
 = 0; i < 
cou¡
; i++) {

395 
	`ícodeUI¡32BE
(
buf„r
->
d©a
, &buf„r->
íd
, 
ui
[
i
]);

397  
UDS_SUCCESS
;

398 
	}
}

401 
	$gëUI¡64BEsFromBuf„r
(
Buf„r
 *
buf„r
, 
size_t
 
cou¡
, 
uöt64_t
 *
ui
)

403 i‡(
	`c⁄ã¡Lígth
(
buf„r
Ë< ((
uöt64_t
Ë* 
cou¡
)) {

404  
UDS_BUFFER_ERROR
;

407 
i
 = 0; i < 
cou¡
; i++) {

408 
	`decodeUI¡64BE
(
buf„r
->
d©a
, &buf„r->
°¨t
, 
ui
 + 
i
);

410  
UDS_SUCCESS
;

411 
	}
}

414 
	$putUI¡64BEsI¡oBuf„r
(
Buf„r
 *
buf„r
, 
size_t
 
cou¡
, c⁄° 
uöt64_t
 *
ui
)

416 i‡(!
	`ísuªAvaûabÀS∑˚
(
buf„r
, (
uöt64_t
Ë* 
cou¡
)) {

417  
UDS_BUFFER_ERROR
;

420 
i
 = 0; i < 
cou¡
; i++) {

421 
	`ícodeUI¡64BE
(
buf„r
->
d©a
, &buf„r->
íd
, 
ui
[
i
]);

423  
UDS_SUCCESS
;

424 
	}
}

	@uds/buffer.h

22 #i‚de‡
BUFFER_H


23 
	#BUFFER_H


	)

25 
	~"comm⁄.h
"

27 
buf„r
 
	tBuf„r
;

39 
	$wøpBuf„r
(
byã
 *
byãs
,

40 
size_t
 
Àngth
,

41 
size_t
 
c⁄ã¡Lígth
,

42 
Buf„r
 **
buf„rPå
)

43 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

53 
	$makeBuf„r
(
size_t
 
Àngth
, 
Buf„r
 **
buf„rPå
)

54 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

61 
	`‰ìBuf„r
(
Buf„r
 **
pBuf„r
);

71 
	$growBuf„r
(
Buf„r
 *
buf„r
, 
size_t
 
Àngth
)

72 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

83 
boﬁ
 
	$ísuªAvaûabÀS∑˚
(
Buf„r
 *
buf„r
, 
size_t
 
byãs
)

84 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

94 
	`com∑˘Buf„r
(
Buf„r
 *
buf„r
);

106 
	$skùF‹w¨d
(
Buf„r
 *
buf„r
, 
size_t
 
byãsToSkù
)

107 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

119 
	$ªwödBuf„r
(
Buf„r
 *
buf„r
, 
size_t
 
byãsToRewöd
)

120 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

129 
size_t
 
	`buf„rLígth
(
Buf„r
 *
buf„r
);

138 
size_t
 
	`c⁄ã¡Lígth
(
Buf„r
 *
buf„r
);

147 
size_t
 
	`avaûabÀS∑˚
(
Buf„r
 *
buf„r
);

157 
size_t
 
	`uncom∑˘edAmou¡
(
Buf„r
 *
buf„r
);

167 
size_t
 
	`buf„rU£d
(
Buf„r
 *
buf„r
);

177 
	$ª£tBuf„rEnd
(
Buf„r
 *
buf„r
, 
size_t
 
íd
)

178 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

191 
boﬁ
 
	$hasSameByãs
(
Buf„r
 *
buf„r
, c⁄° 
byã
 *
d©a
, 
size_t
 
Àngth
)

192 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

203 
boﬁ
 
	`equÆBuf„rs
(
Buf„r
 *
buf„r1
, Buf„∏*
buf„r2
);

214 
	$gëByã
(
Buf„r
 *
buf„r
, 
byã
 *
byãPå
Ë
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

226 
	$≥ekByã
(
Buf„r
 *
buf„r
, 
size_t
 
off£t
, 
byã
 *
byãPå
)

227 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

237 
	$putByã
(
Buf„r
 *
buf„r
, 
byã
 
b
Ë
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

249 
	$gëByãsFromBuf„r
(
Buf„r
 *
buf„r
, 
size_t
 
Àngth
, *
de°ö©i⁄
)

250 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

261 
byã
 *
	`gëBuf„rC⁄ã¡s
(
Buf„r
 *
buf„r
);

273 
	$c›yByãs
(
Buf„r
 *
buf„r
, 
size_t
 
Àngth
, 
byã
 **
de°ö©i⁄På
)

274 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

287 
	$putByãs
(
Buf„r
 *
buf„r
, 
size_t
 
Àngth
, c⁄° *
sour˚
)

288 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

300 
	$zîoByãs
(
Buf„r
 *
buf„r
, 
size_t
 
Àngth
)

301 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

312 
	$gëBoﬁón
(
Buf„r
 *
buf„r
, 
boﬁ
 *
b
Ë
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

322 
	$putBoﬁón
(
Buf„r
 *
buf„r
, 
boﬁ
 
b
Ë
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

334 
	$gëUI¡16BEFromBuf„r
(
Buf„r
 *
buf„r
, 
uöt16_t
 *
ui
)

335 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

347 
	$putUI¡16BEI¡oBuf„r
(
Buf„r
 *
buf„r
, 
uöt16_t
 
ui
)

348 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

360 
	$gëUI¡32BEFromBuf„r
(
Buf„r
 *
buf„r
, 
uöt32_t
 *
ui
)

361 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

373 
	$putUI¡32BEI¡oBuf„r
(
Buf„r
 *
buf„r
, 
uöt32_t
 
ui
)

374 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

387 
	$gëUI¡32BEsFromBuf„r
(
Buf„r
 *
buf„r
, 
size_t
 
cou¡
, 
uöt32_t
 *
ui
)

388 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

401 
	$putUI¡32BEsI¡oBuf„r
(
Buf„r
 *
buf„r
, 
size_t
 
cou¡
, c⁄° 
uöt32_t
 *
ui
)

402 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

415 
	$gëUI¡64BEsFromBuf„r
(
Buf„r
 *
buf„r
, 
size_t
 
cou¡
, 
uöt64_t
 *
ui
)

416 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

429 
	$putUI¡64BEsI¡oBuf„r
(
Buf„r
 *
buf„r
, 
size_t
 
cou¡
, c⁄° 
uöt64_t
 *
ui
)

430 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

	@uds/bufferOps.h

22 #i‚de‡
BUFFER_OPS_H


23 
	#BUFFER_OPS_H


	)

25 
	~"buf„r.h
"

37 
	$ªadI¡oBuf„rI¡îru±ibÀ
(
Buf„r
 *
buf„r
, 
fd
)

38 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

49 
	$ªadI¡oBuf„r
(
Buf„r
 *
buf„r
, 
fd
Ë
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

61 
	$£ndFromBuf„rI¡îru±ibÀ
(
Buf„r
 *
buf„r
, 
sock
)

62 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

73 
	$£ndFromBuf„r
(
Buf„r
 *
buf„r
, 
sock
)

74 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

85 
	$£ndBuf„rC⁄ã¡s
(
Buf„r
 *
buf„r
, 
sock
)

86 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

	@uds/bufferPrivate.h

22 #i‚de‡
BUFFER_PRIVATE_H


23 
	#BUFFER_PRIVATE_H


	)

25 
	~"comm⁄.h
"

27 
	sbuf„r
 {

28 
size_t
 
	m°¨t
;

29 
size_t
 
	míd
;

30 
size_t
 
	mÀngth
;

31 
byã
 *
	md©a
;

32 
boﬁ
 
	mwøµed
;

	@uds/bufferedIORegion.c

22 
	~"buf„ªdIORegi⁄.h
"

24 
	~"loggî.h
"

25 
	~"mem‹yAŒoc.h
"

26 
	~"numîic.h
"

27 
	~"≥rmas£π.h
"

29 
	sbuf„ªdIORegi⁄
 {

30 
IORegi⁄
 
	mcomm⁄
;

31 
Buf„r
 *
	mbuf„r
;

32 
boﬁ
 
	mmyBuf„r
;

33 
size_t
 
	mbufSize
;

34 
off_t
 
	mposôi⁄
;

35 } 
	tBuf„ªdIORegi⁄
;

37 c⁄° 
IORegi⁄Ops
 *
gëBuf„ªdIORegi⁄Ops
();

40 
INLINE
 
Buf„ªdIORegi⁄
 *
	$asBuf„ªdIORegi⁄
(
IORegi⁄
 *
ªgi⁄
)

42  
	`c⁄èöî_of
(
ªgi⁄
, 
Buf„ªdIORegi⁄
, 
comm⁄
);

43 
	}
}

46 
	$makeBuf„ªdRegi⁄
(
Buf„r
 *
buf„r
,

47 
size_t
 
buf„rSize
,

48 
IORegi⁄
 **
ªgi⁄På
)

50 
Buf„ªdIORegi⁄
 *
bufi‹
 = 
NULL
;

51 
ªsu…
 = 
	`ALLOCATE
(1, 
Buf„ªdIORegi⁄
, "buf„ªd IOÑegi⁄", &
bufi‹
);

52 i‡(
ªsu…
 !
UDS_SUCCESS
) {

53  
ªsu…
;

56 
ªsu…
 = 
UDS_SUCCESS
;

57 i‡(
buf„r
 =
NULL
) {

58 i‡(
buf„rSize
 == 0) {

59 
buf„rSize
 = 1024;

61 
ªsu…
 = 
	`makeBuf„r
(
buf„rSize
, &
buf„r
);

62 
bufi‹
->
myBuf„r
 = 
åue
;

64 i‡(
	`avaûabÀS∑˚
(
buf„r
Ë< 
buf„rSize
) {

65 
ªsu…
 = 
	`growBuf„r
(
buf„r
, 
buf„rSize
);

68 i‡(
ªsu…
 !
UDS_SUCCESS
) {

69  
ªsu…
;

72 
bufi‹
->
buf„r
 = buffer;

73 
bufi‹
->
bufSize
 = 
	`avaûabÀS∑˚
(
buf„r
);

74 
bufi‹
->
comm⁄
.
›s
 = 
	`gëBuf„ªdIORegi⁄Ops
();

75 
bufi‹
->
posôi⁄
 = 0;

77 *
ªgi⁄På
 = &
bufi‹
->
comm⁄
;

78  
UDS_SUCCESS
;

79 
	}
}

82 
	$gëBuf„ªdRegi⁄Buf„r
(
IORegi⁄
 *
ªgi⁄
,

83 
boﬁ
 
ªÀa£
,

84 
Buf„r
 **
buf„rPå
)

86 
Buf„ªdIORegi⁄
 *
bufi‹
 = 
	`asBuf„ªdIORegi⁄
(
ªgi⁄
);

88 i‡(
ªÀa£
) {

89 
bufi‹
->
myBuf„r
 = 
Ál£
;

91 *
buf„rPå
 = 
bufi‹
->
buf„r
;

92  
UDS_SUCCESS
;

93 
	}
}

96 
	$bufi‹_˛o£
(
IORegi⁄
 *
ªgi⁄
)

98 
Buf„ªdIORegi⁄
 *
bufi‹
 = 
	`asBuf„ªdIORegi⁄
(
ªgi⁄
);

100 i‡(
bufi‹
->
myBuf„r
) {

101 
	`‰ìBuf„r
(&
bufi‹
->
buf„r
);

103 
	`FREE
(
bufi‹
);

104  
UDS_SUCCESS
;

105 
	}
}

108 
bufi‹_gëLimô
(
IORegi⁄
 *
ªgi⁄
 
__©åibuã__
((
unu£d
)),

109 
off_t
 *
limô
)

111 *
	glimô
 = 
INT64_MAX
;

112  
	gUDS_SUCCESS
;

116 
	$bufi‹_gëD©aSize
(
IORegi⁄
 *
ªgi⁄
,

117 
off_t
 *
exã¡
)

119 
Buf„ªdIORegi⁄
 *
bufi‹
 = 
	`asBuf„ªdIORegi⁄
(
ªgi⁄
);

121 *
exã¡
 = 
bufi‹
->
posôi⁄
 + 
	`buf„rU£d
(bufi‹->
buf„r
);

122  
UDS_SUCCESS
;

123 
	}
}

126 
	$bufi‹_˛ór
(
IORegi⁄
 *
ªgi⁄
)

128 
Buf„ªdIORegi⁄
 *
bufi‹
 = 
	`asBuf„ªdIORegi⁄
(
ªgi⁄
);

130  
	`ª£tBuf„rEnd
(
bufi‹
->
buf„r
, 0);

131 
	}
}

134 
bufi‹_wrôe
(
IORegi⁄
 *
ªgi⁄
,

135 
off_t
 
off£t
,

136 c⁄° *
d©a
,

137 
size_t
 
size
 
__©åibuã__
((
unu£d
)),

138 
size_t
 
Àngth
)

140 
Buf„ªdIORegi⁄
 *
	gbufi‹
 = 
asBuf„ªdIORegi⁄
(
ªgi⁄
);

141 
Buf„r
 *
	gbuf
 = 
bufi‹
->
buf„r
;

143 
	gªsu…
 = 
UDS_SUCCESS
;

144 
off_t
 
	gcuºítOff£t
 = 
bufi‹
->
posôi⁄
 + 
buf„rU£d
(
buf
);

146 i‡(
	goff£t
 < 
	gcuºítOff£t
) {

147 i‡(
	goff£t
 < 
	gbufi‹
->
	gposôi⁄
) {

148  
	gUDS_BUFFER_ERROR
;

150 
	gªsu…
 = 
ª£tBuf„rEnd
(
buf
, 
off£t
 - 
bufi‹
->
posôi⁄
);

151 i‡(
	gªsu…
 !
UDS_SUCCESS
) {

152  
ªsu…
;

155 
size_t
 
	g∑ddög
 = 
off£t
 - 
cuºítOff£t
;

156 
size_t
 
	g√eded
 = 
∑ddög
 + 
Àngth
;

158 i‡(
	g√eded
 > 
avaûabÀS∑˚
(
buf
)) {

159 
size_t
 
	gﬁd
 = 
uncom∑˘edAmou¡
(
buf
);

160 
size_t
 
	gÀn
 = 
√eded
 - 
avaûabÀS∑˚
(
buf
Ë+ 
buf„rLígth
(buf);

161 
size_t
 
	gn
 = (
Àn
 + 
buf„rLígth
(
buf
) - 1) / bufferLength(buf);

162 
	gªsu…
 = 
growBuf„r
(
buf
, 
n
 * 
buf„rLígth
(buf));

163 i‡(
	gªsu…
 !
UDS_SUCCESS
) {

164  
ªsu…
;

166 
	gbufi‹
->
	gposôi⁄
 +
ﬁd
 - 
uncom∑˘edAmou¡
(
buf
);

169 i‡(
	g∑ddög
 > 0) {

170 
	gªsu…
 = 
zîoByãs
(
buf
, 
∑ddög
);

171 i‡(
	gªsu…
 !
UDS_SUCCESS
) {

172  
ªsu…
;

177 i‡(
	gÀngth
 > 0) {

178 
	gªsu…
 = 
putByãs
(
buf
, 
Àngth
, 
d©a
);

179 i‡(
	gªsu…
 !
UDS_SUCCESS
) {

180  
ªsu…
;

184 i‡((
	goff£t
 < 
	gcuºítOff£t
Ë&& (cuºítOff£à> off£à+ (
	goff_t
Ë
	gÀngth
)) {

185 
	gªsu…
 = 
ª£tBuf„rEnd
(
buf
, 
cuºítOff£t
 - 
bufi‹
->
posôi⁄
);

186 i‡(
	gªsu…
 !
UDS_SUCCESS
) {

187  
ªsu…
;

191  
	gUDS_SUCCESS
;

195 
	$bufi‹_ªad
(
IORegi⁄
 *
ªgi⁄
,

196 
off_t
 
off£t
,

197 *
buf„r
,

198 
size_t
 
size
,

199 
size_t
 *
Àngth
)

201 
Buf„ªdIORegi⁄
 *
bufi‹
 = 
	`asBuf„ªdIORegi⁄
(
ªgi⁄
);

203 
ªsu…
 = 
UDS_SUCCESS
;

204 
off_t
 
cuºítOff£t
 = 
bufi‹
->
posôi⁄
 + 
	`uncom∑˘edAmou¡
(bufi‹->
buf„r
);

206 i‡(
off£t
 < 
cuºítOff£t
) {

207 
ªsu…
 = 
	`ªwödBuf„r
(
bufi‹
->
buf„r
, 
cuºítOff£t
 - 
off£t
);

208 i‡(
ªsu…
 !
UDS_SUCCESS
) {

209  
ªsu…
;

211 
cuºítOff£t
 = 
off£t
;

214 i‡(
off£t
 > 
cuºítOff£t
) {

215 
ªsu…
 = 
	`skùF‹w¨d
(
bufi‹
->
buf„r
, 
off£t
 - 
cuºítOff£t
);

216 i‡(
ªsu…
 !
UDS_SUCCESS
) {

217  
ªsu…
;

219 
cuºítOff£t
 = 
off£t
;

222 
size_t
 
Àn
 = (
Àngth
 =
NULL
Ë? 
size
 : *length;

223 
size_t
 
n
 = 
	`möSizeT
(
size
, 
	`c⁄ã¡Lígth
(
bufi‹
->
buf„r
));

225 i‡(
n
 > 0) {

226 
ªsu…
 = 
	`gëByãsFromBuf„r
(
bufi‹
->
buf„r
, 
n
, buffer);

227 i‡(
ªsu…
 !
UDS_SUCCESS
) {

228  
ªsu…
;

232 i‡(
n
 < 
Àn
) {

233 i‡(
n
 == 0) {

234  
	`logEº‹WôhSåögEº‹
(
UDS_END_OF_FILE
,

236 
Àn
);

238  
	`logEº‹WôhSåögEº‹
(
UDS_SHORT_READ
,

240 
Àn
, 
n
);

243 i‡(
Àngth
 !
NULL
) {

244 *
Àngth
 = 
n
;

246  
UDS_SUCCESS
;

247 
	}
}

250 
bufi‹_gëBlockSize
(
IORegi⁄
 *
ªgi⁄
 
__©åibuã__
((
unu£d
)),

251 
size_t
 *
blockSize
)

253 *
	gblockSize
 = 1;

254  
	gUDS_SUCCESS
;

258 
	$bufi‹_gëBe°Size
(
IORegi⁄
 *
ªgi⁄
,

259 
size_t
 *
buf„rSize
)

261 *
buf„rSize
 = 
	`asBuf„ªdIORegi⁄
(
ªgi⁄
)->
bufSize
;

262  
UDS_SUCCESS
;

263 
	}
}

266 
bufi‹_syncC⁄ã¡s
(
IORegi⁄
 *
ªgi⁄
 
__©åibuã__
((
unu£d
)))

268  
	gUDS_SUCCESS
;

273 c⁄° 
IORegi⁄Ops
 
	gbuf„ªdIORegi⁄Ops
 = {

274 .
˛o£
 = 
bufi‹_˛o£
,

275 .
	ggëLimô
 = 
bufi‹_gëLimô
,

276 .
	ggëD©aSize
 = 
bufi‹_gëD©aSize
,

277 .
	g˛ór
 = 
bufi‹_˛ór
,

278 .
	gwrôe
 = 
bufi‹_wrôe
,

279 .
	gªad
 = 
bufi‹_ªad
,

280 .
	ggëBlockSize
 = 
bufi‹_gëBlockSize
,

281 .
	ggëBe°Size
 = 
bufi‹_gëBe°Size
,

282 .
	gsyncC⁄ã¡s
 = 
bufi‹_syncC⁄ã¡s
,

285 c⁄° 
IORegi⁄Ops
 *
	$gëBuf„ªdIORegi⁄Ops
()

287  &
buf„ªdIORegi⁄Ops
;

288 
	}
}

	@uds/bufferedIORegion.h

22 #i‚de‡
BUFFERED_IO_REGION_H


23 
	#BUFFERED_IO_REGION_H


	)

25 
	~"ioRegi⁄.h
"

27 
	~"buf„r.h
"

52 
	$makeBuf„ªdRegi⁄
(
Buf„r
 *
buf„r
,

53 
size_t
 
buf„rSize
,

54 
IORegi⁄
 **
ªgi⁄På
)

55 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

68 
	$gëBuf„ªdRegi⁄Buf„r
(
IORegi⁄
 *
ªgi⁄
,

69 
boﬁ
 
ªÀa£
,

70 
Buf„r
 **
buf„rPå
)

71 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

	@uds/bufferedReader.c

22 
	~"buf„ªdRódî.h
"

23 
	~"buf„ªdRódîI¡î«ls.h
"

25 
	~"compûî.h
"

26 
	~"loggî.h
"

27 
	~"mem‹yAŒoc.h
"

28 
	~"numîic.h
"

31 
	$makeBuf„ªdRódî
(
IORegi⁄
 *
ªgi⁄
, 
Buf„ªdRódî
 **
ªadîPå
)

33 
Buf„ªdRódî
 *
ªadî
 = 
NULL
;

34 
ªsu…
 = 
	`ALLOCATE
(1, 
Buf„ªdRódî
, "buf„ªdÑódî", &
ªadî
);

35 i‡(
ªsu…
 !
UDS_SUCCESS
) {

36  
ªsu…
;

39 
ªsu…
 = 
	`gëRegi⁄Be°Buf„rSize
(
ªgi⁄
, &
ªadî
->
bufsize
);

40 i‡(
ªsu…
 !
UDS_SUCCESS
) {

41  
ªsu…
;

44 
ªsu…
 = 
	`ALLOCATE_IO_ALIGNED
(
ªadî
->
bufsize
, 
byã
, "bufferedÑeader buffer",

45 &
ªadî
->
buf„r
);

46 i‡(
ªsu…
 !
UDS_SUCCESS
) {

47 
	`FREE
(
ªadî
);

48  
ªsu…
;

51 
ªadî
->
ªgi⁄
 =Ñegion;

52 
ªadî
->
off£t
 = 0;

53 
ªadî
->
exã¡
 =Ñódî->
buÂos
 =Ñódî->
buf„r
;

54 
ªadî
->
eof
 = 
Ál£
;

55 
ªadî
->
˛o£
 = 
Ál£
;

56 *
ªadîPå
 = 
ªadî
;

57  
UDS_SUCCESS
;

58 
	}
}

61 
	$‰ìBuf„ªdRódî
(
Buf„ªdRódî
 *
ªadî
)

63 i‡(
ªadî
 !
NULL
) {

64 i‡(
ªadî
->
˛o£
) {

65 
	`˛o£IORegi⁄
(&
ªadî
->
ªgi⁄
);

67 
	`FREE
(
ªadî
->
buf„r
);

68 
	`FREE
(
ªadî
);

70 
	}
}

73 
	$ªadBuf„ªdD©a
(
Buf„ªdRódî
 *
ªadî
,

74 *
d©a
,

75 
size_t
 
Àngth
,

76 
size_t
 *
cou¡
)

82 
ªsu…
 = 
UDS_SUCCESS
;

83 
byã
 *
dp
 = 
d©a
;

86 
size_t
 
ªmaöög
 = 
ªadî
->
exã¡
 -Ñódî->
buÂos
;

87 
size_t
 
n
 = 
	`möSizeT
(
Àngth
, 
ªmaöög
);

88 i‡(
n
 > 0) {

89 
	`mem˝y
(
dp
, 
ªadî
->
buÂos
, 
n
);

90 
ªadî
->
buÂos
 +
n
;

91 
dp
 +
n
;

92 
Àngth
 -
n
;

95 i‡(
ªadî
->
eof
) {

96 
ªsu…
 = 
UDS_END_OF_FILE
;

99 
boﬁ
 
ÆwaysC›y
 = 
Ál£
;

100 (
Àngth
 > 0Ë&& (
ªsu…
 =
UDS_SUCCESS
)) {

102 i‡((
Àngth
 >
ªadî
->
bufsize
Ë&& !
ÆwaysC›y
) {

103 
size_t
 
Àn
 = 
Àngth
 / 
ªadî
->
bufsize
 *Ñeader->bufsize;

104 
n
 = (
cou¡
 =
NULL
Ë? 
ªadî
->
bufsize
 : 0;

105 
ªsu…
 = 
	`ªadFromRegi⁄
(
ªadî
->
ªgi⁄
,Ñódî->
off£t
, 
dp
, 
Àn
, &
n
);

106 i‡(
ªsu…
 =
UDS_INCORRECT_ALIGNMENT
) {

109 
ªsu…
 = 
UDS_SUCCESS
;

110 
ÆwaysC›y
 = 
åue
;

113 i‡(
ªsu…
 !
UDS_SUCCESS
) {

114 
	`logW¨nögWôhSåögEº‹
(
ªsu…
, "%s gotÑeadFromRegionÉrror",

115 
__func__
);

118 
dp
 +
n
;

119 
Àngth
 -
n
;

120 
ªadî
->
off£t
 +
n
;

122 i‡(
n
 < 
Àn
) {

123 
ªadî
->
eof
 = 
åue
;

124 
ªsu…
 = 
UDS_END_OF_FILE
;

130 
n
 = 0;

131 
ªsu…
 = 
	`ªadFromRegi⁄
(
ªadî
->
ªgi⁄
,Ñódî->
off£t
,Ñódî->
buf„r
,

132 
ªadî
->
bufsize
, &
n
);

133 i‡(
ªsu…
 !
UDS_SUCCESS
) {

134 
	`logW¨nögWôhSåögEº‹
(
ªsu…
, "%s gotÑeadFromRegionÉrror",

135 
__func__
);

139 
ªadî
->
off£t
 +
n
;

140 
ªadî
->
buÂos
 =Ñódî->
buf„r
;

141 
ªadî
->
exã¡
 =Ñódî->
buf„r
 + 
n
;

142 i‡(
n
 < 
ªadî
->
bufsize
) {

143 
ªadî
->
eof
 = 
åue
;

144 
ªsu…
 = 
UDS_END_OF_FILE
;

147 
n
 = 
	`möSizeT
“, 
Àngth
);

148 
	`mem˝y
(
dp
, 
ªadî
->
buÂos
, 
n
);

149 
dp
 +
n
;

150 
Àngth
 -
n
;

151 
ªadî
->
buÂos
 +
n
;

154 i‡((
ªsu…
 =
UDS_END_OF_FILE
Ë&& (
dp
 - (
byã
 *Ë
d©a
 > 0)) {

155 
ªsu…
 = 
UDS_SHORT_READ
;

157 i‡((
ªsu…
 =
UDS_SHORT_READ
Ë&& (
Àngth
 == 0)) {

158 
ªsu…
 = 
UDS_SUCCESS
;

160 i‡(
cou¡
 !
NULL
) {

161 *
cou¡
 = 
dp
 - (
byã
 *Ë
d©a
;

162 i‡((
ªsu…
 =
UDS_SHORT_READ
Ë|| (ªsu… =
UDS_END_OF_FILE
)) {

164 
ªsu…
 = 
UDS_SUCCESS
;

167  
ªsu…
;

168 
	}
}

171 
	$ªadFromBuf„ªdRódî
(
Buf„ªdRódî
 *
ªadî
, *
d©a
, 
size_t
 
Àngth
)

173  
	`ªadBuf„ªdD©a
(
ªadî
, 
d©a
, 
Àngth
, 
NULL
);

174 
	}
}

177 
INLINE
 
off_t
 
	$cuºítPosôi⁄
(
Buf„ªdRódî
 *
ªadî
)

179  
ªadî
->
off£t
 - (ªadî->
exã¡
 -Ñódî->
buÂos
);

180 
	}
}

183 
INLINE
 
off_t
 
	$buf„rPosôi⁄
(
Buf„ªdRódî
 *
ªadî
)

185  
ªadî
->
off£t
 - (ªadî->
exã¡
 -Ñódî->
buf„r
);

186 
	}
}

189 
off_t
 
	$gëBuf„ªdRódîPosôi⁄
(
Buf„ªdRódî
 *
ªadî
)

191  
	`cuºítPosôi⁄
(
ªadî
);

192 
	}
}

195 
	$ªposôi⁄Ródî
(
Buf„ªdRódî
 *
ªadî
, 
off_t
 
posôi⁄
)

197 i‡(
posôi⁄
 > 
ªadî
->
off£t
) {

198 
off_t
 
limô
 = 0;

199 
ªsu…
 = 
	`gëRegi⁄Limô
(
ªadî
->
ªgi⁄
, &
limô
);

200 i‡(
ªsu…
 !
UDS_SUCCESS
) {

201  
ªsu…
;

203 i‡(
posôi⁄
 > 
limô
) {

204  
	`logEº‹WôhSåögEº‹
(
UDS_OUT_OF_RANGE
,

207 } i‡(
posôi⁄
 > 
	`buf„rPosôi⁄
(
ªadî
)) {

209 i‡(
posôi⁄
 > 
	`cuºítPosôi⁄
(
ªadî
)) {

210 
ªadî
->
buÂos
 +
posôi⁄
 - 
	`cuºítPosôi⁄
(reader);

212 
ªadî
->
buÂos
 -
	`cuºítPosôi⁄
‘ódîË- 
posôi⁄
;

214  
UDS_SUCCESS
;

217 
size_t
 
pha£
 = 
posôi⁄
 % 
ªadî
->
bufsize
;

218 i‡(
pha£
 == 0) {

219 
ªadî
->
buÂos
 =Ñódî->
exã¡
 =Ñódî->
buf„r
;

220 
ªadî
->
off£t
 = 
posôi⁄
;

221 
ªadî
->
eof
 = 
Ál£
;

223 
size_t
 
n
 = 0;

224 
ªsu…
 = 
	`ªadFromRegi⁄
(
ªadî
->
ªgi⁄
, 
posôi⁄
 - 
pha£
,

225 
ªadî
->
buf„r
,Ñódî->
bufsize
, &
n
);

226 i‡(
ªsu…
 !
UDS_SUCCESS
) {

227 
	`logW¨nögWôhSåögEº‹
(
ªsu…
, "%s gotÑeadFromRegionÉrror",

228 
__func__
);

229  
ªsu…
;

231 
ªadî
->
exã¡
 =Ñódî->
buf„r
 + 
n
;

232 
ªadî
->
buÂos
 =Ñódî->
buf„r
 + 
pha£
;

233 
ªadî
->
off£t
 = 
posôi⁄
 + 
n
 - 
pha£
;

234 
ªadî
->
eof
 = (
n
 <Ñódî->
bufsize
);

236  
UDS_SUCCESS
;

237 
	}
}

240 
	$£tBuf„ªdRódîPosôi⁄
(
Buf„ªdRódî
 *
ªadî
, 
off_t
 
posôi⁄
)

242  
	`ªposôi⁄Ródî
(
ªadî
, 
posôi⁄
);

243 
	}
}

246 
	$vîifyBuf„ªdD©a
(
Buf„ªdRódî
 *
ªadî
,

247 c⁄° *
vÆue
,

248 
size_t
 
Àngth
)

250 
ªsu…
 = 
UDS_SUCCESS
;

251 c⁄° 
byã
 *
vp
 = 
vÆue
;

252 c⁄° 
off_t
 
‹igOff£t
 = 
ªadî
->
off£t
;

255 
size_t
 
ªmaöög
 = 
ªadî
->
exã¡
 -Ñódî->
buÂos
;

256 
size_t
 
n
 = 
	`möSizeT
(
Àngth
, 
ªmaöög
);

257 i‡(
n
 > 0) {

258 i‡(
	`memcmp
(
vp
, 
ªadî
->
buÂos
, 
n
) != 0) {

259  
	`logW¨nögWôhSåögEº‹
(
UDS_CORRUPT_FILE
,

260 "%†gŸ u√x≥˘ed d©a", 
__func__
);

262 
vp
 +
n
;

263 
ªadî
->
buÂos
 +
n
;

264 
Àngth
 -
n
;

268 
Àngth
 > 0) {

269 i‡(
ªadî
->
eof
) {

270 
	`ªposôi⁄Ródî
(
ªadî
, 
‹igOff£t
);

271  
	`logW¨nögWôhSåögEº‹
(
UDS_CORRUPT_FILE
,

272 "%†gŸ u√x≥˘ed EOF", 
__func__
);

275 
n
 = 0;

276 
ªsu…
 = 
	`ªadFromRegi⁄
(
ªadî
->
ªgi⁄
,Ñódî->
off£t
,

277 
ªadî
->
buf„r
,Ñódî->
bufsize
, &
n
);

278 i‡(
ªsu…
 !
UDS_SUCCESS
) {

279 
	`ªposôi⁄Ródî
(
ªadî
, 
‹igOff£t
);

280  
	`logW¨nögWôhSåögEº‹
(
ªsu…
, "%s gotÑeadFromRegionÉrror",

281 
__func__
);

282 } i‡(
n
 == 0) {

283 
	`ªposôi⁄Ródî
(
ªadî
, 
‹igOff£t
);

284  
	`logW¨nögWôhSåögEº‹
(
UDS_CORRUPT_FILE
, "%s gotÇo data",

285 
__func__
);

288 
ªadî
->
off£t
 +
n
;

289 
ªadî
->
buÂos
 =Ñódî->
buf„r
;

290 
ªadî
->
exã¡
 =Ñódî->
buf„r
 + 
n
;

292 i‡(
n
 < 
ªadî
->
bufsize
) {

293 
ªadî
->
eof
 = 
åue
;

295 
n
 = 
	`möSizeT
“, 
Àngth
);

296 i‡(
	`memcmp
(
vp
, 
ªadî
->
buÂos
, 
n
) != 0) {

297 
	`ªposôi⁄Ródî
(
ªadî
, 
‹igOff£t
);

298  
	`logW¨nögWôhSåögEº‹
(
UDS_CORRUPT_FILE
,

299 "%†gŸ u√x≥˘ed d©a", 
__func__
);

301 
vp
 +
n
;

302 
Àngth
 -
n
;

303 
ªadî
->
buÂos
 +
n
;

306  
UDS_SUCCESS
;

307 
	}
}

	@uds/bufferedReader.h

22 #i‚de‡
BUFFERED_READER_H


23 
	#BUFFERED_READER_H
 1

	)

25 
	~"comm⁄.h
"

26 
	~"ioRegi⁄.h
"

33 
buf„ªdRódî
 
	tBuf„ªdRódî
;

44 
	$makeBuf„ªdRódî
(
IORegi⁄
 *
ªgi⁄
, 
Buf„ªdRódî
 **
ªadîPå
)

45 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

52 
	`‰ìBuf„ªdRódî
(
Buf„ªdRódî
 *
ªadî
);

63 
	$ªadFromBuf„ªdRódî
(
Buf„ªdRódî
 *
ªadî
, *
d©a
, 
size_t
 
Àngth
)

64 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

76 
	$ªadBuf„ªdD©a
(
Buf„ªdRódî
 *
ªadî
,

77 *
d©a
,

78 
size_t
 
size
,

79 
size_t
 *
cou¡
)

80 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

95 
	$vîifyBuf„ªdD©a
(
Buf„ªdRódî
 *
ªadî
,

96 c⁄° *
vÆue
,

97 
size_t
 
Àngth
)

98 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

107 
off_t
 
	`gëBuf„ªdRódîPosôi⁄
(
Buf„ªdRódî
 *
ªadî
);

124 
	$£tBuf„ªdRódîPosôi⁄
(
Buf„ªdRódî
 *
ªadî
, 
off_t
 
posôi⁄
)

125 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

	@uds/bufferedReaderInternals.h

22 #i‚de‡
BUFFERED_READER_INTERNALS_H


23 
	#BUFFERED_READER_INTERNALS_H


	)

25 
	~"buf„ªdRódî.h
"

27 
	sbuf„ªdRódî
 {

28 
IORegi⁄
 *
	mªgi⁄
;

29 
size_t
 
	mbufsize
;

30 
off_t
 
	moff£t
;

31 
byã
 *
	mbuf„r
;

32 
byã
 *
	mexã¡
;

33 
byã
 *
	mbuÂos
;

34 
boﬁ
 
	meof
;

35 
boﬁ
 
	m˛o£
;

	@uds/bufferedWriter.c

22 
	~"buf„ªdWrôî.h
"

23 
	~"buf„ªdWrôîI¡î«ls.h
"

25 
	~"compûî.h
"

26 
	~"îr‹s.h
"

27 
	~"loggî.h
"

28 
	~"mem‹yAŒoc.h
"

29 
	~"numîic.h
"

32 
	$makeBuf„ªdWrôî
(
IORegi⁄
 *
ªgi⁄
,

33 
size_t
 
bufSize
,

34 
Buf„ªdWrôî
 **
wrôîPå
)

36 
ªsu…
 = 
UDS_SUCCESS
;

38 i‡(
bufSize
 == 0) {

39 
ªsu…
 = 
	`gëRegi⁄Be°Buf„rSize
(
ªgi⁄
, &
bufSize
);

40 i‡(
ªsu…
 !
UDS_SUCCESS
) {

41  
ªsu…
;

44 
size_t
 
blockSize
;

45 
ªsu…
 = 
	`gëRegi⁄BlockSize
(
ªgi⁄
, &
blockSize
);

46 i‡(
ªsu…
 !
UDS_SUCCESS
) {

47  
ªsu…
;

49 i‡(
bufSize
 % 
blockSize
 != 0) {

50  
	`logEº‹WôhSåögEº‹
(
UDS_INVALID_ARGUMENT
,

52 
blockSize
);

56 
Buf„ªdWrôî
 *
wrôî
;

57 
ªsu…
 = 
	`ALLOCATE
(1, 
Buf„ªdWrôî
, "buf„ªd wrôî", &
wrôî
);

58 i‡(
ªsu…
 !
UDS_SUCCESS
) {

59  
ªsu…
;

62 *
wrôî
 = (
Buf„ªdWrôî
) {

63 .
bw_ªgi⁄
 = 
ªgi⁄
,

64 .
bw_size
 = 
bufSize
,

65 .
bw_pos
 = 0,

66 .
bw_îr
 = 
UDS_SUCCESS
,

67 .
bw_u£d
 = 
Ál£
,

68 .
bw_˛o£
 = 
Ál£
,

71 
ªsu…
 = 
	`ALLOCATE_IO_ALIGNED
(
bufSize
, , "buffer writer buffer",

72 &
wrôî
->
bw_buf
);

73 i‡(
ªsu…
 !
UDS_SUCCESS
) {

74 
	`FREE
(
wrôî
);

75  
ªsu…
;

78 
wrôî
->
bw_±r
 = wrôî->
bw_buf
;

79 *
wrôîPå
 = 
wrôî
;

80  
UDS_SUCCESS
;

81 
	}
}

84 
	$‰ìBuf„ªdWrôî
(
Buf„ªdWrôî
 *
bw
)

86 i‡(
bw
) {

87 i‡(
bw
->
bw_˛o£
) {

88 
	`syncAndClo£Regi⁄
(&
bw
->
bw_ªgi⁄
, 
NULL
);

90 
	`FREE
(
bw
->
bw_buf
);

91 
	`FREE
(
bw
);

93 
	}
}

96 
INLINE
 
size_t
 
	$•a˚U£dInBuf„r
(
Buf„ªdWrôî
 *
bw
)

98  
bw
->
bw_±r
 - bw->
bw_buf
;

99 
	}
}

102 
ölöe
 
size_t
 
	$•a˚RemaöögInWrôeBuf„r
(
Buf„ªdWrôî
 *
bw
)

104  
bw
->
bw_size
 - 
	`•a˚U£dInBuf„r
(bw);

105 
	}
}

108 
	$wrôeToBuf„ªdWrôî
(
Buf„ªdWrôî
 *
bw
, c⁄° *
d©a
, 
size_t
 
Àn
)

110 
boﬁ
 
ÆwaysC›y
 = 
Ál£
;

111 i‡(
bw
->
bw_îr
 !
UDS_SUCCESS
) {

112  
bw
->
bw_îr
;

115 c⁄° 
byã
 *
dp
 = 
d©a
;

116 
ªsu…
 = 
UDS_SUCCESS
;

117 (
Àn
 > 0Ë&& (
ªsu…
 =
UDS_SUCCESS
)) {

118 i‡((
Àn
 >
bw
->
bw_size
Ë&& !
ÆwaysC›y
 && (
	`•a˚U£dInBuf„r
(bw) == 0)) {

119 
size_t
 
n
 = 
Àn
 / 
bw
->
bw_size
 * bw->bw_size;

120 
ªsu…
 = 
	`wrôeToRegi⁄
(
bw
->
bw_ªgi⁄
, bw->
bw_pos
, 
dp
, 
n
,Ç);

121 i‡(
ªsu…
 =
UDS_INCORRECT_ALIGNMENT
) {

124 
ªsu…
 = 
UDS_SUCCESS
;

125 
ÆwaysC›y
 = 
åue
;

127 } i‡(
ªsu…
 !
UDS_SUCCESS
) {

128 
	`logW¨nögWôhSåögEº‹
(
ªsu…
, "failed in writeToBufferedWriter");

129 
bw
->
bw_îr
 = 
ªsu…
;

132 
bw
->
bw_pos
 +
n
;

133 
dp
 +
n
;

134 
Àn
 -
n
;

138 
size_t
 
avaû
 = 
	`•a˚RemaöögInWrôeBuf„r
(
bw
);

139 
size_t
 
chunk
 = 
	`möSizeT
(
Àn
, 
avaû
);

140 
	`mem˝y
(
bw
->
bw_±r
, 
dp
, 
chunk
);

141 
Àn
 -
chunk
;

142 
dp
 +
chunk
;

143 
bw
->
bw_±r
 +
chunk
;

145 i‡(
	`•a˚RemaöögInWrôeBuf„r
(
bw
) == 0) {

146 
ªsu…
 = 
	`ÊushBuf„ªdWrôî
(
bw
);

150 
bw
->
bw_u£d
 = 
åue
;

151  
ªsu…
;

152 
	}
}

155 
	$ÊushBuf„ªdWrôî
(
Buf„ªdWrôî
 *
bw
)

157 i‡(
bw
->
bw_îr
 !
UDS_SUCCESS
) {

158  
bw
->
bw_îr
;

161 
size_t
 
n
 = 
	`•a˚U£dInBuf„r
(
bw
);

162 i‡(
n
 > 0) {

163 
ªsu…
 = 
	`wrôeToRegi⁄
(
bw
->
bw_ªgi⁄
, bw->
bw_pos
, bw->
bw_buf
,

164 
bw
->
bw_size
, 
n
);

165 i‡(
ªsu…
 !
UDS_SUCCESS
) {

166  
bw
->
bw_îr
 = 
ªsu…
;

168 
bw
->
bw_±r
 = bw->
bw_buf
;

169 
bw
->
bw_pos
 +bw->
bw_size
;

172  
UDS_SUCCESS
;

173 
	}
}

176 
boﬁ
 
	$wasBuf„ªdWrôîU£d
(c⁄° 
Buf„ªdWrôî
 *
bw
)

178  
bw
->
bw_u£d
;

179 
	}
}

182 
	$nŸeBuf„ªdWrôîU£d
(
Buf„ªdWrôî
 *
bw
)

184 
bw
->
bw_u£d
 = 
åue
;

185 
	}
}

	@uds/bufferedWriter.h

22 #i‚de‡
BUFFERED_WRITER_H


23 
	#BUFFERED_WRITER_H
 1

	)

25 
	~"comm⁄.h
"

26 
	~"ioRegi⁄.h
"

28 
buf„ªdWrôî
 
	tBuf„ªdWrôî
;

40 
	$makeBuf„ªdWrôî
(
IORegi⁄
 *
ªgi⁄
,

41 
size_t
 
bufSize
,

42 
Buf„ªdWrôî
 **
wrôîPå
)

43 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

50 
	`‰ìBuf„ªdWrôî
(
Buf„ªdWrôî
 *
buf„r
);

64 
	$wrôeToBuf„ªdWrôî
(
Buf„ªdWrôî
 *
buf„r
,

65 c⁄° *
d©a
,

66 
size_t
 
Àn
)

67 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

79 
	$ÊushBuf„ªdWrôî
(
Buf„ªdWrôî
 *
buf„r
)

80 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

89 
size_t
 
	$•a˚RemaöögInWrôeBuf„r
(
Buf„ªdWrôî
 *
buf„r
)

90 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

100 
boﬁ
 
	$wasBuf„ªdWrôîU£d
(c⁄° 
Buf„ªdWrôî
 *
buf„r
)

101 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

108 
	`nŸeBuf„ªdWrôîU£d
(
Buf„ªdWrôî
 *
buf„r
);

	@uds/bufferedWriterInternals.h

22 #i‚de‡
BUFFERED_WRITER_INTERNALS_H


23 
	#BUFFERED_WRITER_INTERNALS_H


	)

25 
	~"buf„ªdWrôî.h
"

27 
	sbuf„ªdWrôî
 {

28 
IORegi⁄
 *
	mbw_ªgi⁄
;

29 
off_t
 
	mbw_pos
;

30 
size_t
 
	mbw_size
;

31 *
	mbw_buf
;

32 *
	mbw_±r
;

33 
	mbw_îr
;

34 
boﬁ
 
	mbw_u£d
;

35 
boﬁ
 
	mbw_˛o£
;

	@uds/cacheCounters.c

22 
	~"ˇcheCou¡îs.h
"

24 
	~"compûî.h
"

25 
	~"îr‹s.h
"

26 
	~"≥rmas£π.h
"

27 
	~"°rögUtûs.h
"

28 
	~"uds.h
"

29 
	~"utû/©omic.h
"

32 
INLINE
 
	$addCacheCou¡sByKöd
(
CacheCou¡sByKöd
 *
°©s
,

33 
CacheCou¡sByKöd
 
addíd
)

35 
°©s
->
hôs
 +
addíd
.hits;

36 
°©s
->
mis£s
 +
addíd
.misses;

37 
°©s
->
queued
 +
addíd
.queued;

38 
	}
}

41 
INLINE
 
	$addCacheCou¡sByPageTy≥
(
CacheCou¡sByPageTy≥
 *
°©s
,

42 
CacheCou¡sByPageTy≥
 
addíd
)

44 
	`addCacheCou¡sByKöd
(&
°©s
->
ödexPage
, 
addíd
.indexPage);

45 
	`addCacheCou¡sByKöd
(&
°©s
->
ªc‹dPage
, 
addíd
.recordPage);

46 
	}
}

49 
	$addCacheCou¡îs
(
CacheCou¡îs
 *
°©s
, CacheCou¡î†
addíd
)

51 
	`addCacheCou¡sByPageTy≥
(&
°©s
->
fú°Time
, 
addíd
.firstTime);

52 
	`addCacheCou¡sByPageTy≥
(&
°©s
->
ªåõd
, 
addíd
.retried);

54 
°©s
->
evi˘i⁄s
 +
addíd
.evictions;

55 
°©s
->
expú©i⁄s
 +
addíd
.expirations;

57 
	`addCacheCou¡sByKöd
(&
°©s
->
•¨£Ch≠ãrs
, 
addíd
.sparseChapters);

58 
	`addCacheCou¡sByKöd
(&
°©s
->
•¨£Sórches
, 
addíd
.sparseSearches);

60 
°©s
->
•¨£Evi˘i⁄s
 +
addíd
.sparseEvictions;

61 
°©s
->
•¨£Expú©i⁄s
 +
addíd
.sparseExpirations;

62 
	}
}

65 
	$addToCacheCou¡î
(
CacheCou¡îs
 *
cou¡îs
,

66 
¥obeTy≥
,

67 
CacheResu…Köd
 
köd
,

68 
addíd
)

70 
CacheProbeTy≥
 
basicProbeTy≥
 = 
¥obeTy≥
 & ~
CACHE_PROBE_IGNORE_FAILURE
;

71 
ªsu…
 = 
	`ASSERT
(
basicProbeTy≥
 <
CACHE_PROBE_RECORD_RETRY
,

72 "övÆid cachê¥obêty≥ %#x", 
¥obeTy≥
);

73 i‡(
ªsu…
 !
UDS_SUCCESS
) {

76 
ªsu…
 = 
	`ASSERT
(
köd
 <
CACHE_RESULT_QUEUED
,

77 "övÆid cachê¥obêªsu…Åy≥ %#x", 
köd
);

78 i‡(
ªsu…
 !
UDS_SUCCESS
) {

82 i‡(((
¥obeTy≥
 & 
CACHE_PROBE_IGNORE_FAILURE
) != 0)

83 && (
köd
 !
CACHE_RESULT_HIT
)) {

87 
CacheCou¡sByKöd
 *
ködCou¡s
;

88 
basicProbeTy≥
) {

89 
CACHE_PROBE_INDEX_FIRST
:

90 
ködCou¡s
 = &
cou¡îs
->
fú°Time
.
ödexPage
;

92 
CACHE_PROBE_RECORD_FIRST
:

93 
ködCou¡s
 = &
cou¡îs
->
fú°Time
.
ªc‹dPage
;

95 
CACHE_PROBE_INDEX_RETRY
:

96 
ködCou¡s
 = &
cou¡îs
->
ªåõd
.
ödexPage
;

98 
CACHE_PROBE_RECORD_RETRY
:

99 
ködCou¡s
 = &
cou¡îs
->
ªåõd
.
ªc‹dPage
;

106 
uöt64_t
 *
myCou¡î
;

107 
köd
) {

108 
CACHE_RESULT_MISS
:

109 
myCou¡î
 = &
ködCou¡s
->
mis£s
;

111 
CACHE_RESULT_QUEUED
:

112 
myCou¡î
 = &
ködCou¡s
->
queued
;

114 
CACHE_RESULT_HIT
:

115 
myCou¡î
 = &
ködCou¡s
->
hôs
;

122 
	`©omicAdd64
((
Atomic64
 *Ë
myCou¡î
, 
addíd
);

123 
	}
}

	@uds/cacheCounters.h

22 #i‚de‡
CACHE_COUNTERS_H


23 
	#CACHE_COUNTERS_H


	)

25 
	~"ty≥Defs.h
"

30 
	sˇcheCou¡sByKöd
 {

32 
uöt64_t
 
	mhôs
;

34 
uöt64_t
 
	mmis£s
;

36 
uöt64_t
 
	mqueued
;

37 } 
	tCacheCou¡sByKöd
;

42 
	eˇcheProbeTy≥
 {

44 
	mCACHE_PROBE_INDEX_FIRST
 = 0,

46 
	mCACHE_PROBE_RECORD_FIRST
,

48 
	mCACHE_PROBE_INDEX_RETRY
,

50 
	mCACHE_PROBE_RECORD_RETRY


51 } 
	tCacheProbeTy≥
;

55 
	mCACHE_PROBE_IGNORE_FAILURE
 = 128

61 
	sˇcheCou¡sByPageTy≥
 {

63 
CacheCou¡sByKöd
 
	mödexPage
;

65 
CacheCou¡sByKöd
 
	mªc‹dPage
;

66 } 
	tCacheCou¡sByPageTy≥
;

71 
	sˇcheCou¡îs
 {

74 
CacheCou¡sByPageTy≥
 
	mfú°Time
;

76 
CacheCou¡sByPageTy≥
 
	mªåõd
;

79 
uöt64_t
 
	mevi˘i⁄s
;

81 
uöt64_t
 
	mexpú©i⁄s
;

85 
CacheCou¡sByKöd
 
	m•¨£Ch≠ãrs
;

87 
CacheCou¡sByKöd
 
	m•¨£Sórches
;

90 
uöt64_t
 
	m•¨£Evi˘i⁄s
;

92 
uöt64_t
 
	m•¨£Expú©i⁄s
;

93 } 
	tCacheCou¡îs
;

98 
	eˇcheResu…Köd
 {

100 
	mCACHE_RESULT_HIT
,

102 
	mCACHE_RESULT_MISS
,

104 
	mCACHE_RESULT_QUEUED


105 } 
	tCacheResu…Köd
;

113 
addCacheCou¡îs
(
CacheCou¡îs
 *
°©s
, CacheCou¡î†
addíd
);

123 
addToCacheCou¡î
(
CacheCou¡îs
 *
cou¡îs
,

124 
¥obeTy≥
,

125 
CacheResu…Köd
 
köd
,

126 
addíd
);

	@uds/cachedChapterIndex.c

22 
	~"ˇchedCh≠ãrIndex.h
"

24 
	~"mem‹yAŒoc.h
"

27 
	$öôülizeCachedCh≠ãrIndex
(
CachedCh≠ãrIndex
 *
ch≠ãr
,

28 c⁄° 
Geomëry
 *
geomëry
)

30 
ch≠ãr
->
vútuÆCh≠ãr
 = 
UINT64_MAX
;

32 
∑ges
 = 
geomëry
->
ödexPagesPîCh≠ãr
;

33 
ªsu…
 = 
	`ALLOCATE
(
∑ges
, 
Ch≠ãrIndexPage
, "sparse ChapterIndexPages",

34 &
ch≠ãr
->
ödexPages
);

35 i‡(
ªsu…
 !
UDS_SUCCESS
) {

36  
ªsu…
;

38  
	`ALLOCATE_IO_ALIGNED
(
∑ges
 * 
geomëry
->
byãsPîPage
, 
byã
,

39 "•¨£ indexÖagêd©a", &
ch≠ãr
->
∑geD©a
);

40 
	}
}

43 
	$de°royCachedCh≠ãrIndex
(
CachedCh≠ãrIndex
 *
ch≠ãr
)

45 
	`FREE
(
ch≠ãr
->
ödexPages
);

46 
	`FREE
(
ch≠ãr
->
∑geD©a
);

47 
	}
}

50 
	$ˇcheCh≠ãrIndex
(
CachedCh≠ãrIndex
 *
ch≠ãr
,

51 
uöt64_t
 
vútuÆCh≠ãr
,

52 c⁄° 
Vﬁume
 *
vﬁume
)

55 
ch≠ãr
->
vútuÆCh≠ãr
 = 
UINT64_MAX
;

59 
ªsu…
 = 
	`ªadCh≠ãrIndexFromVﬁume
(
vﬁume
, 
vútuÆCh≠ãr
,

60 
ch≠ãr
->
∑geD©a
,

61 
ch≠ãr
->
ödexPages
);

62 i‡(
ªsu…
 !
UDS_SUCCESS
) {

63  
ªsu…
;

67 
ch≠ãr
->
cou¡îs
.
£¨chHôs
 = 0;

68 
ch≠ãr
->
cou¡îs
.
£¨chMis£s
 = 0;

69 
ch≠ãr
->
cou¡îs
.
c⁄£cutiveMis£s
 = 0;

72 
ch≠ãr
->
vútuÆCh≠ãr
 = virtualChapter;

73 
ch≠ãr
->
övÆid
 = 
Ál£
;

74 
ch≠ãr
->
skùSórch
 = 
Ál£
;

76  
UDS_SUCCESS
;

77 
	}
}

80 
	$£¨chCachedCh≠ãrIndex
(
CachedCh≠ãrIndex
 *
ch≠ãr
,

81 c⁄° 
Geomëry
 *
geomëry
,

82 c⁄° 
IndexPageM≠
 *
ödexPageM≠
,

83 c⁄° 
UdsChunkName
 *
«me
,

84 *
ªc‹dPagePå
)

87 
physiˇlCh≠ãr


88 
	`m≠ToPhysiˇlCh≠ãr
(
geomëry
, 
ch≠ãr
->
vútuÆCh≠ãr
);

89 
ödexPageNumbî
;

90 
ªsu…
 = 
	`födIndexPageNumbî
(
ödexPageM≠
, 
«me
, 
physiˇlCh≠ãr
,

91 &
ödexPageNumbî
);

92 i‡(
ªsu…
 !
UDS_SUCCESS
) {

93  
ªsu…
;

96  
	`£¨chCh≠ãrIndexPage
(&
ch≠ãr
->
ödexPages
[
ödexPageNumbî
],

97 
geomëry
, 
«me
, 
ªc‹dPagePå
);

98 
	}
}

	@uds/cachedChapterIndex.h

22 #i‚de‡
CACHED_CHAPTER_INDEX_H


23 
	#CACHED_CHAPTER_INDEX_H


	)

25 
	~"ch≠ãrIndex.h
"

26 
	~"comm⁄.h
"

27 
	~"compûî.h
"

28 
	~"˝u.h
"

29 
	~"geomëry.h
"

30 
	~"ödexPageM≠.h
"

31 
	~"ty≥Defs.h
"

32 
	~"vﬁume.h
"

40 
__©åibuã__
((
	$Æig√d
(
CACHE_LINE_BYTES
))Ë
ˇchedIndexCou¡îs
 {

42 
uöt64_t
 
£¨chHôs
;

45 
uöt64_t
 
£¨chMis£s
;

48 
uöt64_t
 
c⁄£cutiveMis£s
;

49 
	}
};

50 
ˇchedIndexCou¡îs
 
	tCachedIndexCou¡îs
;

56 
__©åibuã__
((
	$Æig√d
(
CACHE_LINE_BYTES
))Ë
ˇchedCh≠ãrIndex
 {

62 
uöt64_t
 
vútuÆCh≠ãr
;

68 vﬁ©ûê
boﬁ
 
övÆid
;

71 vﬁ©ûê
boﬁ
 
skùSórch
;

77 
Ch≠ãrIndexPage
 *
ödexPages
;

80 
byã
 *
∑geD©a
;

86 
CachedIndexCou¡îs
 
cou¡îs
;

87 
	}
};

88 
ˇchedCh≠ãrIndex
 
	tCachedCh≠ãrIndex
;

98 
	$öôülizeCachedCh≠ãrIndex
(
CachedCh≠ãrIndex
 *
ch≠ãr
,

99 c⁄° 
Geomëry
 *
geomëry
)

100 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

108 
	`de°royCachedCh≠ãrIndex
(
CachedCh≠ãrIndex
 *
ch≠ãr
);

116 
INLINE
 
	$£tSkùSórch
(
CachedCh≠ãrIndex
 *
ch≠ãr
, 
boﬁ
 
skùSórch
)

120 i‡(
ch≠ãr
->
skùSórch
 != skipSearch) {

121 
ch≠ãr
->
skùSórch
 = skipSearch;

123 
	}
}

136 
INLINE
 
boﬁ
 
	$shouldSkùCh≠ãrIndex
(
CachedCh≠ãrIndex
 *
ch≠ãr
,

137 
uöt64_t
 
vútuÆCh≠ãr
)

141 i‡((
ch≠ãr
->
vútuÆCh≠ãr
 =
UINT64_MAX
Ë|| ch≠ãr->
övÆid
) {

142  
åue
;

145 i‡(
vútuÆCh≠ãr
 !
UINT64_MAX
) {

148  (
vútuÆCh≠ãr
 !
ch≠ãr
->virtualChapter);

152  
ch≠ãr
->
skùSórch
;

154 
	}
}

169 
	$ˇcheCh≠ãrIndex
(
CachedCh≠ãrIndex
 *
ch≠ãr
,

170 
uöt64_t
 
vútuÆCh≠ãr
,

171 c⁄° 
Vﬁume
 *
vﬁume
)

172 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

187 
	$£¨chCachedCh≠ãrIndex
(
CachedCh≠ãrIndex
 *
ch≠ãr
,

188 c⁄° 
Geomëry
 *
geomëry
,

189 c⁄° 
IndexPageM≠
 *
ödexPageM≠
,

190 c⁄° 
UdsChunkName
 *
«me
,

191 *
ªc‹dPagePå
)

192 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

	@uds/chapterIndex.c

22 
	~"ch≠ãrIndex.h
"

24 
	~"compûî.h
"

25 
	~"îr‹s.h
"

26 
	~"hashUtûs.h
"

27 
	~"loggî.h
"

28 
	~"mem‹yAŒoc.h
"

29 
	~"≥rmas£π.h
"

30 
	~"uds.h
"

34 
	$makeO≥nCh≠ãrIndex
(
O≥nCh≠ãrIndex
 **
›íCh≠ãrIndex
,

35 c⁄° 
Geomëry
 *
geomëry
)

38 
ªsu…
 = 
	`ALLOCATE
(1, 
O≥nCh≠ãrIndex
, "open chapter index",

39 
›íCh≠ãrIndex
);

40 i‡(
ªsu…
 !
UDS_SUCCESS
) {

41  
ªsu…
;

46 
size_t
 
mem‹ySize


47 (
geomëry
->
ödexPagesPîCh≠ãr
 + 1Ë* geomëry->
byãsPîPage
;

48 (*
›íCh≠ãrIndex
)->
geomëry
 = geometry;

49 
ªsu…
 = 
	`öôülizeDñèIndex
(&(*
›íCh≠ãrIndex
)->
dñèIndex
, 1,

50 
geomëry
->
dñèLi°sPîCh≠ãr
,

51 
geomëry
->
ch≠ãrMónDñè
,

52 
geomëry
->
ch≠ãrPaylﬂdBôs
, 
mem‹ySize
);

53 i‡(
ªsu…
 !
UDS_SUCCESS
) {

54 
	`FREE
(*
›íCh≠ãrIndex
);

55 *
›íCh≠ãrIndex
 = 
NULL
;

57  
ªsu…
;

58 
	}
}

61 
	$‰ìO≥nCh≠ãrIndex
(
O≥nCh≠ãrIndex
 *
›íCh≠ãrIndex
)

63 i‡(
›íCh≠ãrIndex
 =
NULL
) {

68 
	`unöôülizeDñèIndex
(&
›íCh≠ãrIndex
->
dñèIndex
);

69 
	`FREE
(
›íCh≠ãrIndex
);

70 
	}
}

73 
	$em±yO≥nCh≠ãrIndex
(
O≥nCh≠ãrIndex
 *
›íCh≠ãrIndex
,

74 
uöt64_t
 
vútuÆCh≠ãrNumbî
)

76 
	`em±yDñèIndex
(&
›íCh≠ãrIndex
->
dñèIndex
);

77 
›íCh≠ãrIndex
->
vútuÆCh≠ãrNumbî
 = virtualChapterNumber;

78 
	}
}

89 
INLINE
 
boﬁ
 
	$wasE¡ryFound
(c⁄° 
DñèIndexE¡ry
 *
íåy
,

90 
addªss
)

92  (!
íåy
->
©End
 && (íåy->
key
 =
addªss
));

93 
	}
}

96 
	$putO≥nCh≠ãrIndexRec‹d
(
O≥nCh≠ãrIndex
 *
›íCh≠ãrIndex
,

97 c⁄° 
UdsChunkName
 *
«me
,

98 
∑geNumbî
)

100 c⁄° 
Geomëry
 *
geomëry
 = 
›íCh≠ãrIndex
->geometry;

101 
ªsu…


102 
	`ASSERT_WITH_ERROR_CODE
(
∑geNumbî
 < 
geomëry
->
ªc‹dPagesPîCh≠ãr
,

103 
UDS_INVALID_ARGUMENT
,

106 
∑geNumbî
, 
geomëry
->
ªc‹dPagesPîCh≠ãr
);

107 i‡(
ªsu…
 !
UDS_SUCCESS
) {

108  
ªsu…
;

111 
DñèIndexE¡ry
 
íåy
;

112 
addªss
 = 
	`hashToCh≠ãrDñèAddªss
(
«me
, 
geomëry
);

113 
ªsu…
 = 
	`gëDñèIndexE¡ry
(&
›íCh≠ãrIndex
->
dñèIndex
,

114 
	`hashToCh≠ãrDñèLi°
(
«me
, 
geomëry
),

115 
addªss
, 
«me
->«me, 
Ál£
, &
íåy
);

116 i‡(
ªsu…
 !
UDS_SUCCESS
) {

117  
ªsu…
;

119 
boﬁ
 
found
 = 
	`wasE¡ryFound
(&
íåy
, 
addªss
);

120 
ªsu…
 = 
	`ASSERT_WITH_ERROR_CODE
(!(
found
 && 
íåy
.
isCﬁlisi⁄
),

121 
UDS_BAD_STATE
,

123 
PRIu64
,

124 
›íCh≠ãrIndex
->
vútuÆCh≠ãrNumbî
);

125 i‡(
ªsu…
 !
UDS_SUCCESS
) {

126  
ªsu…
;

128  
	`putDñèIndexE¡ry
(&
íåy
, 
addªss
, 
∑geNumbî
,

129 (
found
 ? 
«me
->«mê: 
NULL
));

130 
	}
}

133 
	$∑ckO≥nCh≠ãrIndexPage
(
O≥nCh≠ãrIndex
 *
›íCh≠ãrIndex
,

134 
uöt64_t
 
vﬁumeN⁄˚
,

135 
byã
 *
mem‹y
,

136 
fú°Li°
,

137 
boﬁ
 
œ°Page
,

138 *
numLi°s
)

140 
DñèIndex
 *
dñèIndex
 = &
›íCh≠ãrIndex
->deltaIndex;

141 c⁄° 
Geomëry
 *
geomëry
 = 
›íCh≠ãrIndex
->geometry;

142 
ªmovÆs
 = 0;

144 
ªsu…
 = 
	`∑ckDñèIndexPage
(
dñèIndex
, 
vﬁumeN⁄˚
, 
mem‹y
,

145 
geomëry
->
byãsPîPage
,

146 
›íCh≠ãrIndex
->
vútuÆCh≠ãrNumbî
,

147 
fú°Li°
, 
numLi°s
);

148 i‡(
ªsu…
 !
UDS_SUCCESS
) {

149  
ªsu…
;

151 i‡((
fú°Li°
 + *
numLi°s
Ë=
geomëry
->
dñèLi°sPîCh≠ãr
) {

154 } i‡(*
numLi°s
 == 0) {

157 } i‡(
œ°Page
) {

169 i‡(
ªmovÆs
 == 0) {

170 
DñèIndexSèts
 
°©s
;

171 
	`gëDñèIndexSèts
(
dñèIndex
, &
°©s
);

172 
	`logW¨nög
("Thêch≠ã∏ödex f‹ ch≠ã∏%" 
PRIu64


174 
›íCh≠ãrIndex
->
vútuÆCh≠ãrNumbî
,

175 
°©s
.
ªc‹dCou¡
, sèts.
cﬁlisi⁄Cou¡
);

177 
DñèIndexE¡ry
 
íåy
;

178 
li°Numbî
 = *
numLi°s
;

180 i‡(
li°Numbî
 < 0) {

181  
UDS_OVERFLOW
;

183 
ªsu…
 = 
	`°¨tDñèIndexSórch
(
dñèIndex
, 
fú°Li°
 + 
li°Numbî
--,

184 0, 
Ál£
, &
íåy
);

185 i‡(
ªsu…
 !
UDS_SUCCESS
) {

186  
ªsu…
;

188 
ªsu…
 = 
	`√xtDñèIndexE¡ry
(&
íåy
);

189 i‡(
ªsu…
 !
UDS_SUCCESS
) {

190  
ªsu…
;

192 } 
íåy
.
©End
);

194 
ªsu…
 = 
	`ªmoveDñèIndexE¡ry
(&
íåy
);

195 i‡(
ªsu…
 !
UDS_SUCCESS
) {

196  
ªsu…
;

198 
ªmovÆs
++;

199 } !
íåy
.
©End
);

201 i‡(
ªmovÆs
 > 0) {

202 
	`logW¨nög
("Tÿavoid ch≠ã∏ödexÖagêovîÊow i¿ch≠ã∏%" 
PRIu64


204 
›íCh≠ãrIndex
->
vútuÆCh≠ãrNumbî
, 
ªmovÆs
);

206  
UDS_SUCCESS
;

207 
	}
}

210 
	$gëO≥nCh≠ãrIndexSize
(
O≥nCh≠ãrIndex
 *
›íCh≠ãrIndex
)

212 
DñèIndexSèts
 
°©s
;

213 
	`gëDñèIndexSèts
(&
›íCh≠ãrIndex
->
dñèIndex
, &
°©s
);

214  
°©s
.
ªc‹dCou¡
;

215 
	}
}

218 
size_t
 
	$gëO≥nCh≠ãrIndexMem‹yAŒoˇãd
(
O≥nCh≠ãrIndex
 *
›íCh≠ãrIndex
)

220 
DñèIndexSèts
 
°©s
;

221 
	`gëDñèIndexSèts
(&
›íCh≠ãrIndex
->
dñèIndex
, &
°©s
);

222  
°©s
.
mem‹yAŒoˇãd
 + (
O≥nCh≠ãrIndex
);

223 
	}
}

226 
	$öôülizeCh≠ãrIndexPage
(
Ch≠ãrIndexPage
 *
ch≠ãrIndexPage
,

227 c⁄° 
Geomëry
 *
geomëry
,

228 
byã
 *
ödexPage
,

229 
uöt64_t
 
vﬁumeN⁄˚
)

231  
	`öôülizeDñèIndexPage
(&
ch≠ãrIndexPage
->
dñèIndex
,

232 &
ch≠ãrIndexPage
->
dñèMem‹y
,

233 
vﬁumeN⁄˚
,

234 
geomëry
->
ch≠ãrMónDñè
,

235 
geomëry
->
ch≠ãrPaylﬂdBôs
,

236 
ödexPage
, 
geomëry
->
byãsPîPage
);

237 
	}
}

240 
	$vÆid©eCh≠ãrIndexPage
(c⁄° 
Ch≠ãrIndexPage
 *
ch≠ãrIndexPage
,

241 c⁄° 
Geomëry
 *
geomëry
)

243 c⁄° 
DñèIndex
 *
dñèIndex
 = &
ch≠ãrIndexPage
->deltaIndex;

244 
fú°
 = 
	`gëDñèIndexLowe°Li°Numbî
(
dñèIndex
);

245 
œ°
 = 
	`gëDñèIndexHighe°Li°Numbî
(
dñèIndex
);

247 
li°Numbî
 = 
fú°
;Üi°Numbî <
œ°
;ÜistNumber++) {

248 
DñèIndexE¡ry
 
íåy
;

249 
ªsu…
 = 
	`°¨tDñèIndexSórch
(
dñèIndex
, 
li°Numbî
 - 
fú°
, 0, 
åue
,

250 &
íåy
);

251 i‡(
ªsu…
 !
UDS_SUCCESS
) {

252  
ªsu…
;

255 
ªsu…
 = 
	`√xtDñèIndexE¡ry
(&
íåy
);

256 i‡(
ªsu…
 !
UDS_SUCCESS
) {

257 i‡(
ªsu…
 =
UDS_CORRUPT_DATA
) {

260  
UDS_CORRUPT_COMPONENT
;

262  
ªsu…
;

264 i‡(
íåy
.
©End
) {

268 i‡(
	`gëDñèE¡ryVÆue
(&
íåy
Ë>
geomëry
->
ªc‹dPagesPîCh≠ãr
) {

271  
UDS_CORRUPT_COMPONENT
;

275  
UDS_SUCCESS
;

276 
	}
}

279 
	$£¨chCh≠ãrIndexPage
(
Ch≠ãrIndexPage
 *
ch≠ãrIndexPage
,

280 c⁄° 
Geomëry
 *
geomëry
,

281 c⁄° 
UdsChunkName
 *
«me
,

282 *
ªc‹dPagePå
)

284 
DñèIndex
 *
dñèIndex
 = &
ch≠ãrIndexPage
->deltaIndex;

285 
addªss
 = 
	`hashToCh≠ãrDñèAddªss
(
«me
, 
geomëry
);

286 
dñèLi°Numbî
 = 
	`hashToCh≠ãrDñèLi°
(
«me
, 
geomëry
);

287 
subLi°Numbî


288 
dñèLi°Numbî
 - 
	`gëDñèIndexLowe°Li°Numbî
(
dñèIndex
);

289 
DñèIndexE¡ry
 
íåy
;

290 
ªsu…
 = 
	`gëDñèIndexE¡ry
(
dñèIndex
, 
subLi°Numbî
, 
addªss
,

291 
«me
->«me, 
åue
, &
íåy
);

292 i‡(
ªsu…
 !
UDS_SUCCESS
) {

293  
ªsu…
;

296 i‡(
	`wasE¡ryFound
(&
íåy
, 
addªss
)) {

297 *
ªc‹dPagePå
 = 
	`gëDñèE¡ryVÆue
(&
íåy
);

299 *
ªc‹dPagePå
 = 
NO_CHAPTER_INDEX_ENTRY
;

301  
UDS_SUCCESS
;

302 
	}
}

305 
uöt64_t
 
	$gëCh≠ãrIndexVútuÆCh≠ãrNumbî
(c⁄° 
Ch≠ãrIndexPage
 *
∑ge
)

307  
	`gëDñèIndexVútuÆCh≠ãrNumbî
(&
∑ge
->
dñèIndex
);

308 
	}
}

311 
	$gëCh≠ãrIndexLowe°Li°Numbî
(c⁄° 
Ch≠ãrIndexPage
 *
∑ge
)

313  
	`gëDñèIndexLowe°Li°Numbî
(&
∑ge
->
dñèIndex
);

314 
	}
}

317 
	$gëCh≠ãrIndexHighe°Li°Numbî
(c⁄° 
Ch≠ãrIndexPage
 *
∑ge
)

319  
	`gëDñèIndexHighe°Li°Numbî
(&
∑ge
->
dñèIndex
);

320 
	}
}

	@uds/chapterIndex.h

22 #i‚de‡
CHAPTER_INDEX_H


23 
	#CHAPTER_INDEX_H
 1

	)

25 
	~"dñèIndex.h
"

26 
	~"geomëry.h
"

31 
	mNO_CHAPTER_INDEX_ENTRY
 = -1

34 
	s›íCh≠ãrIndex
 {

35 c⁄° 
Geomëry
 *
	mgeomëry
;

36 
DñèIndex
 
	mdñèIndex
;

37 
uöt64_t
 
	mvútuÆCh≠ãrNumbî
;

38 } 
	tO≥nCh≠ãrIndex
;

40 
	sch≠ãrIndexPage
 {

41 
DñèIndex
 
	mdñèIndex
;

42 
DñèMem‹y
 
	mdñèMem‹y
;

43 } 
	tCh≠ãrIndexPage
;

54 
	$makeO≥nCh≠ãrIndex
(
O≥nCh≠ãrIndex
 **
›íCh≠ãrIndex
,

55 c⁄° 
Geomëry
 *
geomëry
)

56 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

63 
	`‰ìO≥nCh≠ãrIndex
(
O≥nCh≠ãrIndex
 *
›íCh≠ãrIndex
);

72 
	`em±yO≥nCh≠ãrIndex
(
O≥nCh≠ãrIndex
 *
›íCh≠ãrIndex
,

73 
uöt64_t
 
vútuÆCh≠ãrNumbî
);

85 
	$putO≥nCh≠ãrIndexRec‹d
(
O≥nCh≠ãrIndex
 *
›íCh≠ãrIndex
,

86 c⁄° 
UdsChunkName
 *
«me
,

87 
∑geNumbî
)

88 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

107 
	$∑ckO≥nCh≠ãrIndexPage
(
O≥nCh≠ãrIndex
 *
›íCh≠ãrIndex
,

108 
uöt64_t
 
vﬁumeN⁄˚
,

109 
byã
 *
mem‹y
,

110 
fú°Li°
,

111 
boﬁ
 
œ°Page
,

112 *
numLi°s
)

113 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

122 
	$gëO≥nCh≠ãrIndexSize
(
O≥nCh≠ãrIndex
 *
›íCh≠ãrIndex
)

123 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

132 
size_t
 
	`gëO≥nCh≠ãrIndexMem‹yAŒoˇãd
(
O≥nCh≠ãrIndex
 *
›íCh≠ãrIndex
);

145 
	$öôülizeCh≠ãrIndexPage
(
Ch≠ãrIndexPage
 *
ch≠ãrIndexPage
,

146 c⁄° 
Geomëry
 *
geomëry
,

147 
byã
 *
ödexPage
,

148 
uöt64_t
 
vﬁumeN⁄˚
)

149 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

164 
	$vÆid©eCh≠ãrIndexPage
(c⁄° 
Ch≠ãrIndexPage
 *
ch≠ãrIndexPage
,

165 c⁄° 
Geomëry
 *
geomëry
)

166 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

180 
	$£¨chCh≠ãrIndexPage
(
Ch≠ãrIndexPage
 *
ch≠ãrIndexPage
,

181 c⁄° 
Geomëry
 *
geomëry
,

182 c⁄° 
UdsChunkName
 *
«me
,

183 *
ªc‹dPagePå
)

184 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

193 
uöt64_t
 
	`gëCh≠ãrIndexVútuÆCh≠ãrNumbî
(c⁄° 
Ch≠ãrIndexPage
 *
∑ge
);

203 
	`gëCh≠ãrIndexLowe°Li°Numbî
(c⁄° 
Ch≠ãrIndexPage
 *
∑ge
);

213 
	`gëCh≠ãrIndexHighe°Li°Numbî
(c⁄° 
Ch≠ãrIndexPage
 *
∑ge
);

	@uds/chapterWriter.c

22 
	~"ch≠ãrWrôî.h
"

24 
	~"îr‹s.h
"

25 
	~"ödex.h
"

26 
	~"ödexCheckpoöt.h
"

27 
	~"ödexComp⁄ít.h
"

28 
	~"loggî.h
"

29 
	~"mem‹yAŒoc.h
"

30 
	~"›íCh≠ãr.h
"

31 
	~"thªads.h
"

33 
	sch≠ãrWrôî
 {

35 
Index
 *
	mödex
;

37 
Thªad
 
	mthªad
;

39 
Muãx
 
	mmuãx
;

41 
C⁄dV¨
 
	mc⁄d
;

43 
boﬁ
 
	m°›
;

45 
	mªsu…
;

47 
size_t
 
	mmem‹yAŒoˇãd
;

49 
	mz⁄esToWrôe
;

51 
O≥nCh≠ãrIndex
 *
	m›íCh≠ãrIndex
;

53 
UdsChunkRec‹d
 *
	mcﬁœãdRec‹ds
;

55 
O≥nCh≠ãrZ⁄e
 *
	mch≠ãrs
[];

62 
	$˛o£Ch≠ãrs
(*
¨g
)

64 
Ch≠ãrWrôî
 *
wrôî
 = 
¨g
;

65 
	`logDebug
("chapter writer starting");

66 
	`lockMuãx
(&
wrôî
->
muãx
);

67 
boﬁ
 
fú°Ch≠ãrWrôe
 = 
åue
;

69 
wrôî
->
z⁄esToWrôe
 < wrôî->
ödex
->
z⁄eCou¡
) {

70 i‡(
wrôî
->
°›
 && (wrôî->
z⁄esToWrôe
 == 0)) {

73 
	`u∆ockMuãx
(&
wrôî
->
muãx
);

74 
	`logDebug
("chapter writer stopping");

77 
	`waôC⁄d
(&
wrôî
->
c⁄d
, &wrôî->
muãx
);

86 
	`u∆ockMuãx
(&
wrôî
->
muãx
);

88 i‡(
fú°Ch≠ãrWrôe
) {

89 
fú°Ch≠ãrWrôe
 = 
Ál£
;

95 
IndexComp⁄ít
 *
oc
 = 
	`födIndexComp⁄ít
(
wrôî
->
ödex
->
°©e
,

96 &
OPEN_CHAPTER_INFO
);

97 
ªsu…
 = 
	`disˇrdIndexComp⁄ít
(
oc
);

98 i‡(
ªsu…
 =
UDS_SUCCESS
) {

99 
	`logNŸi˚
("Discarding saved open chapter");

103 
ªsu…
 = 
	`˛o£O≥nCh≠ãr
(
wrôî
->
ch≠ãrs
,

104 
wrôî
->
ödex
->
z⁄eCou¡
,

105 
wrôî
->
ödex
->
vﬁume
,

106 
wrôî
->
›íCh≠ãrIndex
,

107 
wrôî
->
cﬁœãdRec‹ds
,

108 
wrôî
->
ödex
->
√we°VútuÆCh≠ãr
);

110 i‡(
ªsu…
 =
UDS_SUCCESS
) {

111 
ªsu…
 = 
	`¥o˚ssCh≠ãrWrôîCheckpoötSaves
(
wrôî
->
ödex
);

114 
	`lockMuãx
(&
wrôî
->
muãx
);

116 
	`adv™˚A˘iveCh≠ãrs
(
wrôî
->
ödex
);

117 
wrôî
->
ªsu…
 =Ñesult;

118 
wrôî
->
z⁄esToWrôe
 = 0;

119 
	`brﬂdˇ°C⁄d
(&
wrôî
->
c⁄d
);

121 
	}
}

124 
	$makeCh≠ãrWrôî
(
Index
 *
ödex
, 
Ch≠ãrWrôî
 **
wrôîPå
)

126 
size_t
 
cﬁœãdRec‹dsSize


127 ((
UdsChunkRec‹d
)

128 * (1 + 
ödex
->
vﬁume
->
geomëry
->
ªc‹dsPîCh≠ãr
));

129 
Ch≠ãrWrôî
 *
wrôî
;

130 
ªsu…
 = 
	`ALLOCATE_EXTENDED
(
Ch≠ãrWrôî
,

131 
ödex
->
z⁄eCou¡
, 
O≥nCh≠ãrZ⁄e
 *,

132 "Ch≠ã∏Wrôî", &
wrôî
);

133 i‡(
ªsu…
 !
UDS_SUCCESS
) {

134  
ªsu…
;

136 
ªsu…
 = 
	`ÆloˇãCacheAlig√d
(
cﬁœãdRec‹dsSize
, "collatedÑecords",

137 &
wrôî
->
cﬁœãdRec‹ds
);

138 i‡(
ªsu…
 !
UDS_SUCCESS
) {

139 
	`FREE
(
wrôî
);

140  
ªsu…
;

142 
ªsu…
 = 
	`makeO≥nCh≠ãrIndex
(&
wrôî
->
›íCh≠ãrIndex
,

143 
ödex
->
vﬁume
->
geomëry
);

144 i‡(
ªsu…
 !
UDS_SUCCESS
) {

145 
	`FREE
(
wrôî
->
cﬁœãdRec‹ds
);

146 
	`FREE
(
wrôî
);

147  
ªsu…
;

150 
size_t
 
›íCh≠ãrIndexMem‹yAŒoˇãd


151 
	`gëO≥nCh≠ãrIndexMem‹yAŒoˇãd
(
wrôî
->
›íCh≠ãrIndex
);

152 
wrôî
->
mem‹yAŒoˇãd
 = ((
Ch≠ãrWrôî
)

153 + 
ödex
->
z⁄eCou¡
 * (
O≥nCh≠ãrZ⁄e
 *)

154 + 
cﬁœãdRec‹dsSize


155 + 
›íCh≠ãrIndexMem‹yAŒoˇãd
);

156 
wrôî
->
ödex
 = index;

157 
	`öôMuãx
(&
wrôî
->
muãx
);

158 
	`öôC⁄d
(&
wrôî
->
c⁄d
);

161 c⁄° 
CHAPTER_WRITER_THREAD_NAME
[] = "chapterWriter";

162 
ªsu…
 = 
	`¸óãThªad
(
˛o£Ch≠ãrs
, 
wrôî
, 
CHAPTER_WRITER_THREAD_NAME
, 0,

163 &
wrôî
->
thªad
);

164 i‡(
ªsu…
 !
UDS_SUCCESS
) {

165 
	`‰ìCh≠ãrWrôî
(
wrôî
);

166  
	`makeUƒecovîabÀ
(
ªsu…
);

169 *
wrôîPå
 = 
wrôî
;

170  
UDS_SUCCESS
;

171 
	}
}

174 
	$‰ìCh≠ãrWrôî
(
Ch≠ãrWrôî
 *
wrôî
)

176 i‡(
wrôî
 =
NULL
) {

180 
ªsu…
 
	`__©åibuã__
((
unu£d
)Ë
	`°›Ch≠ãrWrôî
(
wrôî
);

181 
	`de°royMuãx
(&
wrôî
->
muãx
);

182 
	`de°royC⁄d
(&
wrôî
->
c⁄d
);

183 
	`‰ìO≥nCh≠ãrIndex
(
wrôî
->
›íCh≠ãrIndex
);

184 
	`FREE
(
wrôî
->
cﬁœãdRec‹ds
);

185 
	`FREE
(
wrôî
);

186 
	}
}

189 
	$°¨tClosögCh≠ãr
(
Ch≠ãrWrôî
 *
wrôî
,

190 
z⁄eNumbî
,

191 
O≥nCh≠ãrZ⁄e
 *
ch≠ãr
)

193 
	`lockMuãx
(&
wrôî
->
muãx
);

194 
föishedZ⁄es
 = ++
wrôî
->
z⁄esToWrôe
;

195 
wrôî
->
ch≠ãrs
[
z⁄eNumbî
] = 
ch≠ãr
;

196 
	`brﬂdˇ°C⁄d
(&
wrôî
->
c⁄d
);

197 
	`u∆ockMuãx
(&
wrôî
->
muãx
);

199  
föishedZ⁄es
;

200 
	}
}

203 
	$föishPªviousCh≠ãr
(
Ch≠ãrWrôî
 *
wrôî
, 
uöt64_t
 
cuºítCh≠ãrNumbî
)

205 
ªsu…
;

206 
	`lockMuãx
(&
wrôî
->
muãx
);

207 
wrôî
->
ödex
->
√we°VútuÆCh≠ãr
 < 
cuºítCh≠ãrNumbî
) {

208 
	`waôC⁄d
(&
wrôî
->
c⁄d
, &wrôî->
muãx
);

210 
ªsu…
 = 
wrôî
->result;

211 
	`u∆ockMuãx
(&
wrôî
->
muãx
);

213 i‡(
ªsu…
 !
UDS_SUCCESS
) {

214  
	`logUƒecovîabÀ
(
ªsu…
, "Writing ofÖrevious open chapter failed");

216  
UDS_SUCCESS
;

217 
	}
}

220 
	$°›Ch≠ãrWrôî
(
Ch≠ãrWrôî
 *
wrôî
)

222 
Thªad
 
wrôîThªad
 = 0;

224 
	`lockMuãx
(&
wrôî
->
muãx
);

225 i‡(
wrôî
->
thªad
 != 0) {

226 
wrôîThªad
 = 
wrôî
->
thªad
;

227 
wrôî
->
thªad
 = 0;

228 
wrôî
->
°›
 = 
åue
;

229 
	`brﬂdˇ°C⁄d
(&
wrôî
->
c⁄d
);

231 
ªsu…
 = 
wrôî
->result;

232 
	`u∆ockMuãx
(&
wrôî
->
muãx
);

234 i‡(
wrôîThªad
 != 0) {

235 
	`joöThªads
(
wrôîThªad
);

238 i‡(
ªsu…
 !
UDS_SUCCESS
) {

239  
	`logUƒecovîabÀ
(
ªsu…
, "Writing ofÖrevious open chapter failed");

241  
UDS_SUCCESS
;

242 
	}
}

245 
size_t
 
	$gëCh≠ãrWrôîMem‹yAŒoˇãd
(
Ch≠ãrWrôî
 *
wrôî
)

247  
wrôî
->
mem‹yAŒoˇãd
;

248 
	}
}

	@uds/chapterWriter.h

22 #i‚de‡
CHAPTER_WRITER_H


23 
	#CHAPTER_WRITER_H


	)

25 
	~"›íCh≠ãrZ⁄e.h
"

27 
ch≠ãrWrôî
 
	tCh≠ãrWrôî
;

30 
	gödex
;

40 
	$makeCh≠ãrWrôî
(
ödex
 *index,

41 
Ch≠ãrWrôî
 **
wrôîPå
)

42 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

49 
	`‰ìCh≠ãrWrôî
(
Ch≠ãrWrôî
 *
wrôî
);

61 
	$°¨tClosögCh≠ãr
(
Ch≠ãrWrôî
 *
wrôî
,

62 
z⁄eNumbî
,

63 
O≥nCh≠ãrZ⁄e
 *
ch≠ãr
)

64 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

76 
	$föishPªviousCh≠ãr
(
Ch≠ãrWrôî
 *
wrôî
, 
uöt64_t
 
cuºítCh≠ãrNumbî
)

77 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

87 
	$°›Ch≠ãrWrôî
(
Ch≠ãrWrôî
 *
wrôî
)

88 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

97 
size_t
 
	`gëCh≠ãrWrôîMem‹yAŒoˇãd
(
Ch≠ãrWrôî
 *
wrôî
);

	@uds/chunkName.c

22 
	~"hashUtûs.h
"

23 
	~"sha256.h
"

24 
	~"°rögUtûs.h
"

25 
	~"uds.h
"

28 
UdsChunkName
 
	$udsCÆcuœãSHA256ChunkName
(c⁄° *
d©a
, 
size_t
 
size
)

30 
UdsChunkName
 
ªt
;

31 i‡((Ë
UDS_CHUNK_NAME_SIZE
 =(Ë
SHA256_HASH_LEN
) {

32 
	`sha256
(
d©a
, 
size
, 
ªt
.
«me
);

34 
hash
[
SHA256_HASH_LEN
];

35 
	`sha256
(
d©a
, 
size
, 
hash
);

36 
	`mem˝y
(
ªt
.
«me
, 
hash
, 
UDS_CHUNK_NAME_SIZE
);

38  
ªt
;

39 
	}
}

42 
UdsChunkName
 
	$udsCÆcuœãMurmur3ChunkName
(c⁄° *
d©a
, 
size_t
 
size
)

44  
	`murmurGíî©‹
(
d©a
, 
size
);

45 
	}
}

48 
boﬁ
 
	$udsEquÆChunkName
(c⁄° 
UdsChunkName
 *
«me0
, c⁄° UdsChunkNamê*
«me1
)

50  
	`memcmp
(
«me0
->
«me
, 
«me1
->«me, 
UDS_CHUNK_NAME_SIZE
) == 0;

51 
	}
}

	@uds/common.h

22 #i‚de‡
COMMON_H


23 
	#COMMON_H


	)

25 
	~"°rögUtûs.h
"

26 
	~"ty≥Defs.h
"

27 
	~"uds.h
"

28 
	~"uds-block.h
"

31 
	mKILOBYTE
 = 1024,

32 
	mMEGABYTE
 = 
KILOBYTE
 * KILOBYTE,

33 
	mGIGABYTE
 = 
KILOBYTE
 * 
MEGABYTE


36 
udsChunkD©a
 
	tUdsChunkD©a
;

39 
UdsChunkName
 
	m«me
;

40 
UdsChunkD©a
 
	md©a
;

41 } 
	tUdsChunkRec‹d
;

	@uds/compiler.h

22 #i‚de‡
COMMON_COMPILER_H


23 
	#COMMON_COMPILER_H


	)

25 
	~"compûîDefs.h
"

29 
	#COUNT_OF
(
x
) (((x) / (0[x])) \

30 / ((
size_t
Ë(!((
x
Ë% (0[x])))))

	)

32 
	#c⁄°_c⁄èöî_of
(
±r
, 
ty≥
, 
membî
) \

33 
	`__exãnsi⁄__
 ({ \

34 c⁄° 
	`__ty≥of__
(((
ty≥
 *)0)->
membî
Ë*
__m±r
 = (
±r
); \

35 (c⁄° 
ty≥
 *)((c⁄° *)
__m±r
 - 
	`off£tof
—y≥,
membî
)); \

36 })

	)

40 
	#INLINE
 
	`__©åibuã__
((
Æways_ölöe
)Ë
ölöe


	)

	@uds/compilerDefs.h

22 #i‚de‡
LINUX_KERNEL_COMPILER_DEFS_H


23 
	#LINUX_KERNEL_COMPILER_DEFS_H


	)

25 
	~<löux/compûî.h
>

27 
	#__STRING
(
x
Ë#x

	)

	@uds/componentPortal.h

22 #i‚de‡
COMPONENT_PORTAL_H


23 
	#COMPONENT_PORTAL_H


	)

25 
	~"buf„ªdRódî.h
"

26 
	~"buf„ªdWrôî.h
"

28 
comp⁄ítP‹èl
 
	tComp⁄ítP‹èl
;

29 
ödexComp⁄ít
 
	tIndexComp⁄ít
;

38 
IndexComp⁄ít
 *
ödexComp⁄ítF‹P‹èl
(
Comp⁄ítP‹èl
 *
p‹èl
);

48 
	$cou¡Comp⁄íts
(
Comp⁄ítP‹èl
 *
p‹èl
, *
∑πs
)

49 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

63 
	$gëComp⁄ítSize
(
Comp⁄ítP‹èl
 *
p‹èl
,

64 
∑π
,

65 
off_t
 *
size
)

66 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

79 
	$gëComp⁄ítLimô
(
Comp⁄ítP‹èl
 *
p‹èl
,

80 
∑π
,

81 
off_t
 *
limô
)

82 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

96 
	$gëIORegi⁄
(
Comp⁄ítP‹èl
 *
p‹èl
,

97 
∑π
,

98 
IORegi⁄
 **
ªgi⁄På
)

99 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

112 
	$gëBuf„ªdRódî
(
Comp⁄ítP‹èl
 *
p‹èl
,

113 
∑π
,

114 
Buf„ªdRódî
 **
ªadîPå
)

115 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

128 
	$gëBuf„ªdWrôî
(
Comp⁄ítP‹èl
 *
p‹èl
,

129 
∑π
,

130 
Buf„ªdWrôî
 **
wrôîPå
)

131 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

135 
	#COMPONENT_PORTAL_INLINE


	)

136 
	~"comp⁄ítP‹èlI∆öe.h
"

137 #unde‡
COMPONENT_PORTAL_INLINE


	@uds/componentPortalInline.h

22 #i‚de‡
COMPONENT_PORTAL_INLINE_H


23 
	#COMPONENT_PORTAL_INLINE_H


	)

25 #i‚de‡
COMPONENT_PORTAL_INLINE


29 
	~"compûî.h
"

31 
	scomp⁄ítP‹èlOps
 {

32 (*
	mcou¡
Ë(
	mComp⁄ítP‹èl
 *, *);

33 (*
	mgëSize
Ë(
	mComp⁄ítP‹èl
 *, , 
	moff_t
 *);

34 (*
	mgëLimô
Ë(
	mComp⁄ítP‹èl
 *, , 
	moff_t
 *);

35 (*
	mgëRegi⁄
)(
	mComp⁄ítP‹èl
 *, , 
	mIORegi⁄
 **);

36 (*
	mgëRódî
)(
	mComp⁄ítP‹èl
 *, , 
	mBuf„ªdRódî
 **);

37 (*
	mgëWrôî
)(
	mComp⁄ítP‹èl
 *, , 
	mBuf„ªdWrôî
 **);

38 } 
	tComp⁄ítP‹èlOps
;

40 
	scomp⁄ítP‹èl
 {

41 
IndexComp⁄ít
 *
	mcomp⁄ít
;

42 c⁄° 
Comp⁄ítP‹èlOps
 *
	m›s
;

46 
INLINE
 
IndexComp⁄ít
 *
	$ödexComp⁄ítF‹P‹èl
(
Comp⁄ítP‹èl
 *
p‹èl
)

48  
p‹èl
->
comp⁄ít
;

49 
	}
}

52 
INLINE
 
	$cou¡Comp⁄íts
(
Comp⁄ítP‹èl
 *
p‹èl
, *
∑πs
)

54  
p‹èl
->
›s
->
	`cou¡
’‹èl, 
∑πs
);

55 
	}
}

58 
INLINE
 
	$gëComp⁄ítSize
(
Comp⁄ítP‹èl
 *
p‹èl
,

59 
∑π
,

60 
off_t
 *
size
)

62  
p‹èl
->
›s
->
	`gëSize
’‹èl, 
∑π
, 
size
);

63 
	}
}

66 
INLINE
 
	$gëComp⁄ítLimô
(
Comp⁄ítP‹èl
 *
p‹èl
,

67 
∑π
,

68 
off_t
 *
size
)

70  
p‹èl
->
›s
->
	`gëLimô
’‹èl, 
∑π
, 
size
);

71 
	}
}

74 
INLINE
 
	$gëIORegi⁄
(
Comp⁄ítP‹èl
 *
p‹èl
,

75 
∑π
,

76 
IORegi⁄
 **
ªgi⁄På
)

78  
p‹èl
->
›s
->
	`gëRegi⁄
’‹èl, 
∑π
, 
ªgi⁄På
);

79 
	}
}

82 
INLINE
 
	$gëBuf„ªdRódî
(
Comp⁄ítP‹èl
 *
p‹èl
,

83 
∑π
,

84 
Buf„ªdRódî
 **
ªadîPå
)

86  
p‹èl
->
›s
->
	`gëRódî
’‹èl, 
∑π
, 
ªadîPå
);

87 
	}
}

90 
INLINE
 
	$gëBuf„ªdWrôî
(
Comp⁄ítP‹èl
 *
p‹èl
,

91 
∑π
,

92 
Buf„ªdWrôî
 **
wrôîPå
)

94  
p‹èl
->
›s
->
	`gëWrôî
’‹èl, 
∑π
, 
wrôîPå
);

95 
	}
}

	@uds/config.c

22 
	~"c⁄fig.h
"

24 
	~"loggî.h
"

25 
	~"mem‹yAŒoc.h
"

26 
	~"°rögUtûs.h
"

29 
	$udsInôülizeGridC⁄fig
(
UdsGridC⁄fig
 *
gridC⁄fig
)

31 i‡(
gridC⁄fig
 =
NULL
) {

32  
	`logEº‹WôhSåögEº‹
(
UDS_CONF_PTR_REQUIRED
,

35 
UdsGridC⁄fig
 
c⁄fig
;

36 
ªsu…
 = 
	`ALLOCATE
(1, 
udsGridC⁄fig
, "UdsGridConfig",

37 &
c⁄fig
);

38 i‡(
ªsu…
 =
UDS_SUCCESS
) {

39 *
gridC⁄fig
 = 
c⁄fig
;

41  
ªsu…
;

42 
	}
}

45 
	$‰ìIndexLoˇti⁄
(
IndexLoˇti⁄
 *
loc
)

47 i‡(
loc
 =
NULL
) {

51 
	`FREE
(
loc
->
ho°
);

52 
	`FREE
(
loc
->
p‹t
);

53 
	`FREE
(
loc
->
dúe˘‹y
);

54 
	}
}

57 
	$udsFªeGridC⁄fig
(
UdsGridC⁄fig
 
gridC⁄fig
)

59 i‡(
gridC⁄fig
 =
NULL
) {

62 
i
 = 0; i < 
gridC⁄fig
->
numLoˇti⁄s
; i++) {

63 
	`‰ìIndexLoˇti⁄
(&
gridC⁄fig
->
loˇti⁄s
[
i
]);

65 
	`FREE
(
gridC⁄fig
->
loˇti⁄s
);

66 
	`FREE
(
gridC⁄fig
);

67 
	}
}

70 
	$c›yP¨amëî
(
IndexLoˇti⁄
 *
loˇti⁄
, c⁄° *
§c
, **
de°
)

72 i‡(
§c
 =
NULL
) {

73 *
de°
 = 
NULL
;

74  
UDS_SUCCESS
;

77 
ªsu…
 = 
	`du∂iˇãSåög
(
§c
, "loˇti⁄Ö¨amãr", 
de°
);

78 i‡(
ªsu…
 !
UDS_SUCCESS
) {

79 
	`‰ìIndexLoˇti⁄
(
loˇti⁄
);

81  
ªsu…
;

82 
	}
}

85 
	$addGridSîvî
(
UdsGridC⁄fig
 
gridC⁄fig
,

86 c⁄° *
ho°
,

87 c⁄° *
p‹t
,

88 c⁄° *
dúe˘‹y
)

90 i‡(
gridC⁄fig
->
numLoˇti⁄s
 =gridC⁄fig->
maxLoˇti⁄s
) {

91 
IndexLoˇti⁄
 *
√wLoˇti⁄s
;

93 
size_t
 
√wMax
 = 
gridC⁄fig
->
maxLoˇti⁄s
 + 8;

95 
ªsu…
 = 
	`ALLOCATE
(
√wMax
, 
IndexLoˇti⁄
, "gridÜocations",

96 &
√wLoˇti⁄s
);

98 i‡(
ªsu…
 !
UDS_SUCCESS
) {

99  
ªsu…
;

102 
gridC⁄fig
->
maxLoˇti⁄s
 = 
√wMax
;

104 
i
 = 0; i < 
gridC⁄fig
->
numLoˇti⁄s
; i++) {

105 
√wLoˇti⁄s
[
i
] = 
gridC⁄fig
->
loˇti⁄s
[i];

108 
	`FREE
(
gridC⁄fig
->
loˇti⁄s
);

109 
gridC⁄fig
->
loˇti⁄s
 = 
√wLoˇti⁄s
;

112 
IndexLoˇti⁄
 *
loˇti⁄
 = &
gridC⁄fig
->
loˇti⁄s
[gridC⁄fig->
numLoˇti⁄s
];

113 
loˇti⁄
->
ho°
 =Üoˇti⁄->
p‹t
 =Üoˇti⁄->
dúe˘‹y
 = 
NULL
;

115 
ªsu…
 = 
	`c›yP¨amëî
(
loˇti⁄
, 
ho°
, &location->host);

116 i‡(
ªsu…
 !
UDS_SUCCESS
) {

117  
ªsu…
;

119 
ªsu…
 = 
	`c›yP¨amëî
(
loˇti⁄
, 
p‹t
, &location->port);

120 i‡(
ªsu…
 !
UDS_SUCCESS
) {

121  
ªsu…
;

123 
ªsu…
 = 
	`c›yP¨amëî
(
loˇti⁄
, 
dúe˘‹y
, &location->directory);

124 i‡(
ªsu…
 !
UDS_SUCCESS
) {

125  
ªsu…
;

128 
gridC⁄fig
->
numLoˇti⁄s
++;

129  
UDS_SUCCESS
;

130 
	}
}

133 
	$udsAddGridSîvî
(
UdsGridC⁄fig
 
gridC⁄fig
,

134 c⁄° *
ho°
,

135 c⁄° *
p‹t
)

137 i‡(
gridC⁄fig
 =
NULL
) {

138  
	`logEº‹WôhSåögEº‹
(
UDS_CONF_REQUIRED
,

141  
	`addGridSîvî
(
gridC⁄fig
, 
ho°
, 
p‹t
, 
NULL
);

142 
	}
}

145 
	$¥ötIndexLoˇti⁄
(c⁄° 
IndexLoˇti⁄
 *
ödexLoˇti⁄
,

146 **
ouçut
)

148 
boﬁ
 
gŸHo°
 = (
ödexLoˇti⁄
->
ho°
 !
NULL
);

149 
boﬁ
 
gŸP‹t
 = (
ödexLoˇti⁄
->
p‹t
 !
NULL
);

150 
boﬁ
 
gŸDú
 = (
ödexLoˇti⁄
->
dúe˘‹y
 !
NULL
);

151 *
°r
 = 
NULL
;

153 
ªsu…
 = 
	`ÆlocS¥ötf
(
__func__
, &
°r
, "%s%s%s%s%s",

154 
gŸHo°
 ? 
ödexLoˇti⁄
->
ho°
 : "",

155 
gŸHo°
 ? ":" : "",

156 
gŸP‹t
 ? 
ödexLoˇti⁄
->
p‹t
 : "",

157 (
gŸHo°
 && 
gŸDú
) ? ":" : "",

158 
gŸDú
 ? 
ödexLoˇti⁄
->
dúe˘‹y
 : "");

159 i‡(
ªsu…
 !
UDS_SUCCESS
) {

160  
ªsu…
;

163 *
ouçut
 = 
°r
;

164  
UDS_SUCCESS
;

165 
	}
}

168 
	$gridC⁄figToSåög
(
UdsGridC⁄fig
 
gridC⁄fig
, **
ouçut
)

170 i‡(
gridC⁄fig
->
numLoˇti⁄s
 == 0) {

171 *
°r
;

172 
ªsu…
 = 
	`du∂iˇãSåög
("<none>", "printGridConfig():ÇoÜocations",

173 &
°r
);

174 i‡(
ªsu…
 !
UDS_SUCCESS
) {

175  
ªsu…
;

177 *
ouçut
 = 
°r
;

178  
UDS_SUCCESS
;

181 i‡(
gridC⁄fig
->
numLoˇti⁄s
 == 1) {

183  
	`¥ötIndexLoˇti⁄
(
gridC⁄fig
->
loˇti⁄s
, 
ouçut
);

192 *
tmpSå
 = 
NULL
;

193 *
°r
 = 
NULL
;

194 *
locSå
 = 
NULL
;

196 
i
 = 0; i < 
gridC⁄fig
->
numLoˇti⁄s
; i++) {

197 
ªsu…
 = 
	`¥ötIndexLoˇti⁄
(
gridC⁄fig
->
loˇti⁄s
 + 
i
, &
locSå
);

198 i‡(
ªsu…
 !
UDS_SUCCESS
) {

199 
	`FREE
(
°r
);

200  
ªsu…
;

203 i‡(
°r
 =
NULL
) {

204 
°r
 = 
locSå
;

205 
locSå
 = 
NULL
;

207 
ªsu…
 = 
	`ÆlocS¥ötf
(
__func__
, &
tmpSå
, "%†%s", 
°r
, 
locSå
);

208 
	`FREE
(
°r
);

209 
	`FREE
(
locSå
);

210 i‡(
ªsu…
 !
UDS_SUCCESS
) {

211  
ªsu…
;

213 
°r
 = 
tmpSå
;

214 
tmpSå
 = 
NULL
;

218 *
ouçut
 = 
°r
;

219  
UDS_SUCCESS
;

220 
	}
}

223 
	$logGridC⁄fig
(
UdsGridC⁄fig
 
gridC⁄fig
, c⁄° *
mesßge
)

225 *
gridC⁄figSåög
;

226 
ªsu…
 = 
	`gridC⁄figToSåög
(
gridC⁄fig
, &
gridC⁄figSåög
);

227 i‡(
ªsu…
 !
UDS_SUCCESS
) {

228 
	`logEº‹WôhSåögEº‹
(
ªsu…
, "FailedÅoállocate grid config string");

229 
	`logNŸi˚
("%s", 
mesßge
);

231 
	`logNŸi˚
("%†f‹ index: %s", 
mesßge
, 
gridC⁄figSåög
);

232 
	`FREE
(
gridC⁄figSåög
);

234 
	}
}

237 
boﬁ
 
	$¨eUdsC⁄figuøti⁄sEquÆ
(
UdsC⁄figuøti⁄
 
a
, UdsC⁄figuøti⁄ 
b
)

239 
boﬁ
 
ªsu…
 = 
åue
;

240 i‡(
a
->
ªc‹dPagesPîCh≠ãr
 !
b
->recordPagesPerChapter) {

241 
	`logEº‹
("RecordÖagesÖer chapter (%u) doesÇot match (%u)",

242 
a
->
ªc‹dPagesPîCh≠ãr
, 
b
->recordPagesPerChapter);

243 
ªsu…
 = 
Ál£
;

245 i‡(
a
->
ch≠ãrsPîVﬁume
 !
b
->chaptersPerVolume) {

246 
	`logEº‹
("Chapter count (%u) doesÇot match (%u)",

247 
a
->
ch≠ãrsPîVﬁume
, 
b
->chaptersPerVolume);

248 
ªsu…
 = 
Ál£
;

250 i‡(
a
->
•¨£Ch≠ãrsPîVﬁume
 !
b
->sparseChaptersPerVolume) {

251 
	`logEº‹
("Sparse chapter count (%u) doesÇot match (%u)",

252 
a
->
•¨£Ch≠ãrsPîVﬁume
, 
b
->sparseChaptersPerVolume);

253 
ªsu…
 = 
Ál£
;

255 i‡(
a
->
ˇcheCh≠ãrs
 !
b
->cacheChapters) {

256 
	`logEº‹
("Cache size (%u) doesÇot match (%u)",

257 
a
->
ˇcheCh≠ãrs
, 
b
->cacheChapters);

258 
ªsu…
 = 
Ál£
;

260 i‡(
a
->
checkpoötFªquícy
 !
b
->checkpointFrequency) {

261 
	`logEº‹
("Checkpoint frequency (%u) doesÇot match (%u)",

262 
a
->
checkpoötFªquícy
, 
b
->checkpointFrequency);

263 
ªsu…
 = 
Ál£
;

265 i‡(
a
->
ma°îIndexMónDñè
 !
b
->masterIndexMeanDelta) {

266 
	`logEº‹
("Master index mean delta (%u) doesÇot match (%u)",

267 
a
->
ma°îIndexMónDñè
, 
b
->masterIndexMeanDelta);

268 
ªsu…
 = 
Ál£
;

270 i‡(
a
->
byãsPîPage
 !
b
->bytesPerPage) {

271 
	`logEº‹
("BytesÖerÖage value (%u) doesÇot match (%u)",

272 
a
->
byãsPîPage
, 
b
->bytesPerPage);

273 
ªsu…
 = 
Ál£
;

275 i‡(
a
->
•¨£Sam∂eR©e
 !
b
->sparseSampleRate) {

276 
	`logEº‹
("Sparse sampleÑate (%u) doesÇot match (%u)",

277 
a
->
•¨£Sam∂eR©e
, 
b
->sparseSampleRate);

278 
ªsu…
 = 
Ál£
;

281  
ªsu…
;

282 
	}
}

285 
	$¥ötUdsC⁄figuøti⁄
(
UdsC⁄figuøti⁄
 
c⁄f
, 
ödít
, **
ouçut
)

287 *
°r
 = 
NULL
;

288 
ªsu…
 = 
	`ÆlocS¥ötf
(
__func__
, &
°r
,

297 
ödít
, "", 
c⁄f
->
ªc‹dPagesPîCh≠ãr
,

298 
ödít
, "", 
c⁄f
->
ch≠ãrsPîVﬁume
,

299 
ödít
, "", 
c⁄f
->
•¨£Ch≠ãrsPîVﬁume
,

300 
ödít
, "", 
c⁄f
->
ˇcheCh≠ãrs
,

301 
ödít
, "", 
c⁄f
->
checkpoötFªquícy
,

302 
ödít
, "", 
c⁄f
->
ma°îIndexMónDñè
,

303 
ödít
, "", 
c⁄f
->
byãsPîPage
,

304 
ödít
, "", 
c⁄f
->
•¨£Sam∂eR©e
);

305 i‡(
ªsu…
 !
UDS_SUCCESS
) {

306  
ªsu…
;

309 *
ouçut
 = 
°r
;

310  
UDS_SUCCESS
;

311 
	}
}

	@uds/config.h

22 #i‚de‡
CONFIG_H


23 
	#CONFIG_H


	)

25 
	~"buf„ªdRódî.h
"

26 
	~"buf„ªdWrôî.h
"

27 
	~"geomëry.h
"

28 
	~"uds.h
"

31 
	mDEFAULT_MASTER_INDEX_MEAN_DELTA
 = 4096,

32 
	mDEFAULT_CACHE_CHAPTERS
 = 7,

33 
	mDEFAULT_SPARSE_SAMPLE_RATE
 = 0

39 
	sudsC⁄figuøti⁄
 {

41 
	mªc‹dPagesPîCh≠ãr
;

43 
	mch≠ãrsPîVﬁume
;

45 
	m•¨£Ch≠ãrsPîVﬁume
;

47 
	mˇcheCh≠ãrs
;

49 
	mcheckpoötFªquícy
;

51 
	mma°îIndexMónDñè
;

53 
	mbyãsPîPage
;

55 
	m•¨£Sam∂eR©e
;

61 
	sudsC⁄figuøti⁄4_13
 {

63 
	msubIndexCou¡
;

65 
	mªc‹dPagesPîCh≠ãr
;

67 
	mch≠ãrsPîVﬁume
;

69 
	m•¨£Ch≠ãrsPîVﬁume
;

71 
	mˇcheCh≠ãrs
;

73 
	mcheckpoötFªquícy
;

75 
	mma°îIndexMónDñè
;

77 
	mbyãsPîPage
;

79 
	m•¨£Sam∂eR©e
;

85 
	sudsC⁄figuøti⁄4_12
 {

87 
	msubIndexCou¡
;

89 
	mªc‹dPagesPîCh≠ãr
;

91 
	mch≠ãrsPîVﬁume
;

93 
	m•¨£Ch≠ãrsPîVﬁume
;

95 
	mˇcheCh≠ãrs
;

97 
	mcheckpoötFªquícy
;

99 
	mma°îIndexMónDñè
;

101 
	mma°îIndexAddªssBôs
;

103 
	m•¨£Sam∂eR©e
;

109 
	sudsC⁄figuøti⁄4_11
 {

111 
	msubIndexCou¡
;

113 
	mªc‹dPagesPîCh≠ãr
;

115 
	mch≠ãrsPîVﬁume
;

117 
	m•¨£Ch≠ãrsPîVﬁume
;

119 
	mˇcheCh≠ãrs
;

121 
	mcheckpoötFªquícy
;

123 
	mma°îIndexMónDñè
;

125 
	mma°îIndexDñèBôs
;

127 
	mma°îIndexAddªssBôs
;

129 
	m•¨£Sam∂eR©e
;

135 
	sudsC⁄figuøti⁄4_01
 {

137 
	msubIndexCou¡
;

139 
	mödexSize
;

141 
	mch≠ãrsPîVﬁume
;

143 
	m•¨£Ch≠ãrsPîVﬁume
;

145 
	mˇcheCh≠ãrs
;

147 
	mcheckpoötFªquícy
;

149 
	mma°îIndexVîsi⁄
;

151 
	mma°îIndexDñèBôs
;

153 
	mma°îIndexAddªssBôs
;

155 
	m•¨£Sam∂eR©e
;

158 
	södexLoˇti⁄
 {

159 *
	mho°
;

160 *
	mp‹t
;

161 *
	mdúe˘‹y
;

162 } 
	tIndexLoˇti⁄
;

164 
	sudsGridC⁄fig
 {

165 
	mnumLoˇti⁄s
;

166 
	mmaxLoˇti⁄s
;

167 
IndexLoˇti⁄
 *
	mloˇti⁄s
;

173 
c⁄figuøti⁄
 
	tC⁄figuøti⁄
;

183 
	$makeC⁄figuøti⁄
(
UdsC⁄figuøti⁄
 
c⁄f
,

184 
C⁄figuøti⁄
 **
c⁄figPå
)

185 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

190 
	`‰ìC⁄figuøti⁄
(
C⁄figuøti⁄
 *
c⁄fig
);

200 
	$ªadC⁄figC⁄ã¡s
(
Buf„ªdRódî
 *
ªadî
,

201 
UdsC⁄figuøti⁄
 
c⁄fig
)

202 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

212 
	$wrôeC⁄figC⁄ã¡s
(
Buf„ªdWrôî
 *
wrôî
,

213 
UdsC⁄figuøti⁄
 
c⁄fig
)

214 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

226 
	$addGridSîvî
(
UdsGridC⁄fig
 
gridC⁄fig
,

227 c⁄° *
ho°
,

228 c⁄° *
p‹t
,

229 c⁄° *
dúe˘‹y
)

230 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

237 
	`‰ìIndexLoˇti⁄
(
IndexLoˇti⁄
 *
loc
);

247 
	$¥ötIndexLoˇti⁄
(c⁄° 
IndexLoˇti⁄
 *
ödexLoˇti⁄
,

248 **
ouçut
)

249 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

259 
	`logGridC⁄fig
(
UdsGridC⁄fig
 
gridC⁄fig
, c⁄° *
mesßge
);

269 
boﬁ
 
	$¨eUdsC⁄figuøti⁄sEquÆ
(
UdsC⁄figuøti⁄
 
a
, UdsC⁄figuøti⁄ 
b
)

270 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

281 
	$¥ötUdsC⁄figuøti⁄
(
UdsC⁄figuøti⁄
 
c⁄f
, 
ödít
, **
ouçut
)

282 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

	@uds/context.c

22 
	~"c⁄ãxt.h
"

24 
	~"îr‹s.h
"

25 
	~"„©uªDefs.h
"

26 
	~"grid.h
"

27 
	~"hashUtûs.h
"

28 
	~"ödexSessi⁄.h
"

29 
	~"loggî.h
"

30 
	~"mem‹yAŒoc.h
"

31 
	~"∑ømëî.h
"

32 
	~"≥rmas£π.h
"

33 
	~"ªque°Limô.h
"

34 
	~"sha256.h
"

35 
	~"thªads.h
"

36 
	~"timeUtûs.h
"

37 
	~"udsSèã.h
"

40 
	mDEFAULT_CHUNK_SIZE
 = 4096,

41 
	mDEFAULT_REQUEST_LIMIT
 = 1024,

42 
	mMAX_REQUEST_LIMIT
 = 2048

46 
UdsP¨amëîVÆue
 
	$gëDeÁu…Tu∫¨oundE«bÀd
()

48 
UdsP¨amëîVÆue
 
vÆue
;

50 #i‡
ENVIRONMENT


51 c⁄° *
ív
 = 
	`gëív
(
UDS_TIME_REQUEST_TURNAROUND
);

52 i‡(
ív
 !
NULL
) {

53 
UdsP¨amëîVÆue
 
tmp
 = {

54 .
ty≥
 = 
UDS_PARAM_TYPE_STRING
,

55 .
vÆue
.
u_°rög
 = 
ív
,

57 i‡(
	`vÆid©eBoﬁón
(&
tmp
, 
NULL
, &
vÆue
Ë=
UDS_SUCCESS
) {

58  
vÆue
;

63 
vÆue
.
ty≥
 = 
UDS_PARAM_TYPE_BOOL
;

64 
vÆue
.vÆue.
u_boﬁ
 = 
Ál£
;

65  
vÆue
;

66 
	}
}

69 
	$deföeTimeReque°Tu∫¨ound
(
P¨amëîDeföôi⁄
 *
pd
)

71 
pd
->
vÆid©e
 = 
vÆid©eBoﬁón
;

72 
pd
->
cuºítVÆue
 = 
	`gëDeÁu…Tu∫¨oundE«bÀd
();

73 
pd
->
upd©e
 = 
NULL
;

74  
UDS_SUCCESS
;

75 
	}
}

78 c⁄° *
	$c⁄ãxtTy≥ToSåög
(
C⁄ãxtTy≥
 
c⁄ãxtTy≥
)

80 i‡(
c⁄ãxtTy≥
 =
BLOCK_CONTEXT
) {

85 
	}
}

88 
	$vÆid©eMëad©aSize
(
c⁄ãxtTy≥
, 
mëad©aSize
)

90 
maxSize
;

91 
c⁄ãxtTy≥
) {

92 
BLOCK_CONTEXT
:

93 
maxSize
 = 
UDS_MAX_BLOCK_DATA_SIZE
;

96  
	`logW¨nögWôhSåögEº‹
(
UDS_INVALID_ARGUMENT
,

98 "c⁄ãxàty≥: %d", 
c⁄ãxtTy≥
);

101 i‡(
mëad©aSize
 <
maxSize
) {

102  
UDS_SUCCESS
;

105  
	`logW¨nögWôhSåögEº‹
(
UDS_INVALID_METADATA_SIZE
,

107 
	`c⁄ãxtTy≥ToSåög
(
c⁄ãxtTy≥
),

108 
mëad©aSize
);

109 
	}
}

112 
›íC⁄ãxt
(
UdsIndexSessi⁄
 
£ssi⁄
,

113 #i‡
NAMESPACES


114 c⁄° 
UdsName•a˚
 *
«me•a˚
,

116 
mëad©aSize
,

117 
Mëad©aEncodî
 
mëad©aEncodî
,

118 
chunkSize
,

119 
C⁄ãxtTy≥
 
c⁄ãxtTy≥
,

120 
CÆlbackH™dÀr
 
ˇŒbackH™dÀr
,

121 *
c⁄ãxtID
)

123 
	gªsu…
 = 
vÆid©eMëad©aSize
(
c⁄ãxtTy≥
, 
mëad©aSize
);

124 i‡(
	gªsu…
 !
UDS_SUCCESS
) {

125  
ªsu…
;

128 
udsInôülize
();

130 
lockGlobÆSèãMuãx
();

131 
	gªsu…
 = 
checkLibøryRu¬ög
();

132 i‡(
	gªsu…
 !
UDS_SUCCESS
) {

133 
u∆ockGlobÆSèãMuãx
();

134  
	gªsu…
;

138 
Sessi⁄Group
 *
	gc⁄ãxtGroup
 = 
gëC⁄ãxtGroup
();

139 
	gªsu…
 = 
acquúeSessi⁄Group
(
c⁄ãxtGroup
);

140 i‡(
	gªsu…
 !
UDS_SUCCESS
) {

141 
u∆ockGlobÆSèãMuãx
();

142  
	gªsu…
;

147 
IndexSessi⁄
 *
	gödexSessi⁄
;

148 
	gªsu…
 = 
gëIndexSessi⁄
(
£ssi⁄
.
id
, &
ödexSessi⁄
);

149 i‡(
	gªsu…
 !
UDS_SUCCESS
) {

150 
ªÀa£Sessi⁄Group
(
c⁄ãxtGroup
);

151 
u∆ockGlobÆSèãMuãx
();

152  
	gªsu…
;

155 
UdsC⁄ãxt
 *
	gc⁄ãxt
 = 
NULL
;

156 #i‡
NAMESPACES


157 
	gªsu…
 = 
makeBa£C⁄ãxt
(
ödexSessi⁄
, 
«me•a˚
, 
mëad©aSize
,

158 
mëad©aEncodî
, 
chunkSize
, 
c⁄ãxtTy≥
,

159 
ˇŒbackH™dÀr
, &
c⁄ãxt
);

161 
	gªsu…
 = 
makeBa£C⁄ãxt
(
ödexSessi⁄
, 
mëad©aSize
,

162 
mëad©aEncodî
, 
chunkSize
, 
c⁄ãxtTy≥
,

163 
ˇŒbackH™dÀr
, &
c⁄ãxt
);

165 i‡(
	gªsu…
 !
UDS_SUCCESS
) {

166 
ªÀa£Sessi⁄Group
(
c⁄ãxtGroup
);

167 
ªÀa£IndexSessi⁄
(
ödexSessi⁄
);

168 
u∆ockGlobÆSèãMuãx
();

169  
	gªsu…
;

174 *
	gc⁄ãxtID
 = 
öôülizeSessi⁄
(
c⁄ãxtGroup
,

175 &
c⁄ãxt
->
£ssi⁄
,

176 (
Sessi⁄C⁄ã¡s
Ë
c⁄ãxt
);

177 
	gc⁄ãxt
->
	gid
 = *
c⁄ãxtID
;

178 
logNŸi˚
("Opened %s context (%u)",

179 
c⁄ãxtTy≥ToSåög
(
c⁄ãxt
->
ty≥
),

180 *
c⁄ãxtID
);

181 
ªÀa£Ba£C⁄ãxt
(
c⁄ãxt
);

182 
ªÀa£Sessi⁄Group
(
c⁄ãxtGroup
);

183 
u∆ockGlobÆSèãMuãx
();

184  
	gUDS_SUCCESS
;

188 
	$checkC⁄ãxt
(
UdsC⁄ãxt
 *
c⁄ãxt
, 
C⁄ãxtTy≥
 
c⁄ãxtTy≥
)

190 
c⁄ãxt
->
c⁄ãxtSèã
) {

191 
UDS_CS_READY
:

193 i‡(
c⁄ãxt
->
ty≥
 !
c⁄ãxtTy≥
) {

195  
	`logEº‹WôhSåögEº‹
(
UDS_WRONG_CONTEXT_TYPE
,

198  
	`checkIndexSessi⁄
(
c⁄ãxt
->
ödexSessi⁄
);

201 
UDS_CS_DISABLED
:

202  
UDS_DISABLED
;

204  
UDS_NOCONTEXT
;

206 
	}
}

209 
	$gëBa£C⁄ãxt
(
c⁄ãxtId
,

210 
C⁄ãxtTy≥
 
c⁄ãxtTy≥
,

211 
UdsC⁄ãxt
 **
c⁄ãxtPå
)

213 
Sessi⁄
 *
£ssi⁄
;

214 
ªsu…
 = 
	`gëSessi⁄
(
	`gëC⁄ãxtGroup
(), 
c⁄ãxtId
, &
£ssi⁄
);

215 i‡(
ªsu…
 !
UDS_SUCCESS
) {

216  
ªsu…
;

219 
UdsC⁄ãxt
 *
c⁄ãxt
 = (UdsC⁄ãxà*Ë
	`gëSessi⁄C⁄ã¡s
(
£ssi⁄
);

220 
ªsu…
 = 
	`checkC⁄ãxt
(
c⁄ãxt
, 
c⁄ãxtTy≥
);

221 i‡(
ªsu…
 !
UDS_SUCCESS
) {

222 
	`ªÀa£Sessi⁄
(
£ssi⁄
);

223  
ªsu…
;

226 *
c⁄ãxtPå
 = 
c⁄ãxt
;

227  
ªsu…
;

228 
	}
}

231 
	$ªÀa£Ba£C⁄ãxt
(
UdsC⁄ãxt
 *
c⁄ãxt
)

233 
	`ªÀa£Sessi⁄
(&
c⁄ãxt
->
£ssi⁄
);

234 
	}
}

237 
	$h™dÀEº‹
(
UdsC⁄ãxt
 *
c⁄ãxt
, 
îr‹Code
)

239 i‡(
	`isUƒecovîabÀ
(
îr‹Code
)) {

240 i‡(
c⁄ãxt
 !
NULL
) {

241 
c⁄ãxt
->
c⁄ãxtSèã
 = 
UDS_CS_DISABLED
;

242 i‡(
c⁄ãxt
->
ödexSessi⁄
 !
NULL
) {

243 
	`£tIndexSessi⁄Sèã
(
c⁄ãxt
->
ödexSessi⁄
, 
IS_DISABLED
);

249  
	`ßnsUƒecovîabÀ
(
îr‹Code
);

250 
	}
}

253 
	$h™dÀEº‹AndRñó£Ba£C⁄ãxt
(
UdsC⁄ãxt
 *
c⁄ãxt
, 
îr‹Code
)

255 
ªsu…
 = 
	`h™dÀEº‹
(
c⁄ãxt
, 
îr‹Code
);

256 
	`ªÀa£Ba£C⁄ãxt
(
c⁄ãxt
);

257  
	`ßnsUƒecovîabÀ
(
ªsu…
);

258 
	}
}

261 
	$‰ìC⁄ãxt
(
UdsC⁄ãxt
 *
c⁄ãxt
)

263 i‡(
c⁄ãxt
 =
NULL
) {

267 i‡(
c⁄ãxt
->
ödexSessi⁄
 !
NULL
) {

268 
	`ªÀa£IndexSessi⁄
(
c⁄ãxt
->
ödexSessi⁄
);

271 
	`‰ìReque°Limô
(
c⁄ãxt
->
ªque°Limô
);

272 
	`FREE
(
c⁄ãxt
);

273 
	}
}

276 
	$˛o£C⁄ãxt
(
c⁄ãxtId
, 
C⁄ãxtTy≥
 
c⁄ãxtTy≥
)

278 
Sessi⁄Group
 *
c⁄ãxtGroup
 = 
	`gëC⁄ãxtGroup
();

279 
ªsu…
 = 
	`acquúeSessi⁄Group
(
c⁄ãxtGroup
);

280 i‡(
ªsu…
 !
UDS_SUCCESS
) {

281  
ªsu…
;

284 
Sessi⁄
 *
£ssi⁄
;

285 
ªsu…
 = 
	`gëSessi⁄
(
c⁄ãxtGroup
, 
c⁄ãxtId
, &
£ssi⁄
);

286 i‡(
ªsu…
 !
UDS_SUCCESS
) {

287 
	`ªÀa£Sessi⁄Group
(
c⁄ãxtGroup
);

288  
ªsu…
;

291 
UdsC⁄ãxt
 *
c⁄ãxt
 = (UdsC⁄ãxà*Ë
	`gëSessi⁄C⁄ã¡s
(
£ssi⁄
);

292 i‡(
c⁄ãxt
->
ty≥
 !
c⁄ãxtTy≥
) {

293 
	`ªÀa£Sessi⁄Group
(
c⁄ãxtGroup
);

294  
	`logEº‹WôhSåögEº‹
(
UDS_WRONG_CONTEXT_TYPE
,

298 
	`föishSessi⁄
(
c⁄ãxtGroup
, &
c⁄ãxt
->
£ssi⁄
);

299 
	`logNŸi˚
("Closed %s context (%u)",

300 
	`c⁄ãxtTy≥ToSåög
(
c⁄ãxt
->
ty≥
),

301 
c⁄ãxtId
);

303 
	`‰ìC⁄ãxt
(
c⁄ãxt
);

304 
	`ªÀa£Sessi⁄Group
(
c⁄ãxtGroup
);

305  
UDS_SUCCESS
;

306 
	}
}

309 
makeBa£C⁄ãxt
(
IndexSessi⁄
 *
ödexSessi⁄
,

310 #i‡
NAMESPACES


311 c⁄° 
UdsName•a˚
 *
«me•a˚
,

313 
mëad©aSize
,

314 
Mëad©aEncodî
 
mëad©aEncodî
,

315 
chunkSize
,

316 
C⁄ãxtTy≥
 
c⁄ãxtTy≥
,

317 
CÆlbackH™dÀr
 
ˇŒbackH™dÀr
,

318 
UdsC⁄ãxt
 **
c⁄ãxtPå
)

320 
UdsC⁄ãxt
 *
	gc⁄ãxt
;

321 
	gªsu…


322 
ALLOCATE
(1, 
UdsC⁄ãxt
, "em±y c⁄ãxt", &
c⁄ãxt
);

323 i‡(
	gªsu…
 !
UDS_SUCCESS
) {

324  
ªsu…
;

327 
	gc⁄ãxt
->
	gty≥
 = 
c⁄ãxtTy≥
;

328 
	gc⁄ãxt
->
	gödexSessi⁄
 = 
ödexSessi⁄
;

329 
	gc⁄ãxt
->
	gc⁄ãxtSèã
 = 
UDS_CS_READY
;

330 
	gc⁄ãxt
->
	gmëad©aSize
 = 
mëad©aSize
;

331 
	gc⁄ãxt
->
	gmëad©aEncodî
 = 
mëad©aEncodî
;

332 
	gc⁄ãxt
->
	gchunkSize
 = ((
chunkSize
 > 0)

333 ? 
chunkSize
 : 
DEFAULT_CHUNK_SIZE
);

334 
	gc⁄ãxt
->
	gˇŒbackH™dÀr
 = 
ˇŒbackH™dÀr
;

335 
	gc⁄ãxt
->
	gchunkNameGíî©‹
 = 
udsCÆcuœãSHA256ChunkName
;

336 
ªœxedSt‹e32
(&
c⁄ãxt
->
hashQueueRŸ‹
, 0);

341 
UdsP¨amëîVÆue
 
	gvÆue
;

342 i‡((
udsGëP¨amëî
(
UDS_TIME_REQUEST_TURNAROUND
, &
vÆue
Ë=
UDS_SUCCESS
) &&

343 
vÆue
.
ty≥
 =
UDS_PARAM_TYPE_BOOL
)

345 
c⁄ãxt
->
timeReque°Tu∫¨ound
 = 
vÆue
.vÆue.
u_boﬁ
;

347 
	gc⁄ãxt
->
	gtimeReque°Tu∫¨ound
 = 
Ál£
;

350 #i‡
NAMESPACES


351 i‡((
	g«me•a˚
 =
NULL
)

352 || ((
«me•a˚
->
«me
 =
NULL
Ë&&Çame•a˚->
Àngth
 == 0)) {

353 
mem£t
(&
c⁄ãxt
->
«me•a˚Hash
.
hash
, 0,

354 (
c⁄ãxt
->
«me•a˚Hash
.
hash
));

355 } i‡(
	g«me•a˚
->
	g«me
 =
NULL
) {

356 
‰ìC⁄ãxt
(
c⁄ãxt
);

357  
logEº‹WôhSåögEº‹
(
UDS_BAD_NAMESPACE
,

360 i‡((Ë
	gUDS_CHUNK_NAME_SIZE
 =(Ë
SHA256_HASH_LEN
) {

361 
sha256
(
«me•a˚
->
«me
,Çame•a˚->
Àngth
, 
c⁄ãxt
->
«me•a˚Hash
.
hash
);

363 
	ghash
[
SHA256_HASH_LEN
];

364 
sha256
(
«me•a˚
->
«me
,Çame•a˚->
Àngth
, 
hash
);

365 
mem˝y
(
c⁄ãxt
->
«me•a˚Hash
.
hash
, hash,

366 (
c⁄ãxt
->
«me•a˚Hash
.
hash
));

371 
	gªsu…
 = 
makeReque°Limô
(
DEFAULT_REQUEST_LIMIT
, &
c⁄ãxt
->
ªque°Limô
);

372 i‡(
	gªsu…
 !
UDS_SUCCESS
) {

373 
‰ìC⁄ãxt
(
c⁄ãxt
);

374  
	gªsu…
;

377 
	gc⁄ãxt
->
	g°©s
.
	gª£tTime
 = 
asTimeT
(
cuºítTime
(
CT_REALTIME
));

378 *
	gc⁄ãxtPå
 = 
c⁄ãxt
;

379  
	gUDS_SUCCESS
;

383 
	$ÊushBa£C⁄ãxt
(
UdsC⁄ãxt
 *
c⁄ãxt
)

385 
	`waôF‹IdÀSessi⁄
(&
c⁄ãxt
->
£ssi⁄
);

386 
	}
}

389 
	$ÊushC⁄ãxt
(
c⁄ãxtId
, 
C⁄ãxtTy≥
 
c⁄ãxtTy≥
)

391 
UdsC⁄ãxt
 *
c⁄ãxt
;

392 
ªsu…
 = 
	`gëBa£C⁄ãxt
(
c⁄ãxtId
, 
c⁄ãxtTy≥
, &
c⁄ãxt
);

393 i‡(
ªsu…
 !
UDS_SUCCESS
) {

394  
ªsu…
;

397 
	`ÊushBa£C⁄ãxt
(
c⁄ãxt
);

398 
	`ªÀa£Ba£C⁄ãxt
(
c⁄ãxt
);

399  
UDS_SUCCESS
;

400 
	}
}

403 
	$gëC⁄figuøti⁄
(
c⁄ãxtId
,

404 
C⁄ãxtTy≥
 
c⁄ãxtTy≥
,

405 
UdsC⁄figuøti⁄
 *
u£rC⁄fig
)

407 i‡(
u£rC⁄fig
 =
NULL
) {

408  
	`logEº‹WôhSåögEº‹
(
UDS_CONF_PTR_REQUIRED
,

412 
UdsC⁄ãxt
 *
c⁄ãxt
;

413 
ªsu…
 = 
	`gëBa£C⁄ãxt
(
c⁄ãxtId
, 
c⁄ãxtTy≥
, &
c⁄ãxt
);

414 i‡(
ªsu…
 !
UDS_SUCCESS
) {

415  
	`logEº‹WôhSåögEº‹
(
ªsu…
, "getBaseContext() failed");

418 
ªsu…
 = 
	`ALLOCATE
(1, 
udsC⁄figuøti⁄
, "udsConfiguration",

419 
u£rC⁄fig
);

420 i‡(
ªsu…
 !
UDS_SUCCESS
) {

421 
ªsu…
 = 
	`logEº‹WôhSåögEº‹
(result,

424 **
u£rC⁄fig
 = 
c⁄ãxt
->
ödexSessi⁄
->
grid
->userConfig;

426  
	`h™dÀEº‹AndRñó£Ba£C⁄ãxt
(
c⁄ãxt
, 
ªsu…
);

427 
	}
}

434 
	$£tReque°QueueLimô
(
c⁄ãxtId
,

435 
C⁄ãxtTy≥
 
c⁄ãxtTy≥
,

436 
maxReque°s
)

438 i‡(
maxReque°s
 > 
MAX_REQUEST_LIMIT
) {

439  
	`logW¨nögWôhSåögEº‹
(

440 
UDS_REQUESTS_OUT_OF_RANGE
,

442 } i‡(
maxReque°s
 == 0) {

443  
	`logW¨nögWôhSåögEº‹
(

444 
UDS_REQUESTS_OUT_OF_RANGE
, "attemptÅo setÑequest queueÜimitÅo zero");

447 
UdsC⁄ãxt
 *
c⁄ãxt
;

448 
ªsu…
 = 
	`gëBa£C⁄ãxt
(
c⁄ãxtId
, 
c⁄ãxtTy≥
, &
c⁄ãxt
);

449 i‡(
ªsu…
 !
UDS_SUCCESS
) {

450  
ªsu…
;

453 
	`£tReque°PîmôLimô
(
c⁄ãxt
->
ªque°Limô
, 
maxReque°s
);

455 
	`ªÀa£Ba£C⁄ãxt
(
c⁄ãxt
);

456  
UDS_SUCCESS
;

457 
	}
}

460 
	$£tChunkNameAlg‹ôhm
(
c⁄ãxtId
,

461 
C⁄ãxtTy≥
 
c⁄ãxtTy≥
,

462 
UdsHashAlg‹ôhm
 
Æg‹ôhm
)

464 
UdsC⁄ãxt
 *
c⁄ãxt
;

465 
ªsu…
 = 
	`gëBa£C⁄ãxt
(
c⁄ãxtId
, 
c⁄ãxtTy≥
, &
c⁄ãxt
);

466 i‡(
ªsu…
 !
UDS_SUCCESS
) {

467  
ªsu…
;

470 
Æg‹ôhm
) {

471 
UDS_HASH_ALG_SHA256
:

472 
c⁄ãxt
->
chunkNameGíî©‹
 = 
udsCÆcuœãSHA256ChunkName
;

475 
UDS_HASH_ALG_MURMUR3
:

476 
c⁄ãxt
->
chunkNameGíî©‹
 = 
murmurGíî©‹
;

481 
ªsu…
 = 
	`logW¨nögWôhSåögEº‹
(
UDS_UNKNOWN_ERROR
,

485 
	`ªÀa£Ba£C⁄ãxt
(
c⁄ãxt
);

486  
ªsu…
;

487 
	}
}

490 
UdsChunkName
 
	$gíî©eChunkName
(
c⁄ãxtId
,

491 
C⁄ãxtTy≥
 
c⁄ãxtTy≥
,

492 c⁄° *
d©a
,

493 
size_t
 
size
)

495 
UdsChunkName
 
chunkName
;

496 
UdsC⁄ãxt
 *
c⁄ãxt
;

497 
ªsu…
 = 
	`gëBa£C⁄ãxt
(
c⁄ãxtId
, 
c⁄ãxtTy≥
, &
c⁄ãxt
);

498 i‡(
ªsu…
 !
UDS_SUCCESS
) {

499  
	`udsCÆcuœãSHA256ChunkName
(
d©a
, 
size
);

502 
chunkName
 = 
c⁄ãxt
->
	`chunkNameGíî©‹
(
d©a
, 
size
);

504 
	`ªÀa£Ba£C⁄ãxt
(
c⁄ãxt
);

505  
chunkName
;

506 
	}
}

511 
uöt64_t
 
	$ß„Divide
(
uöt64_t
 
dividíd
, uöt64_à
divis‹
)

513 i‡(
divis‹
 == 0) {

516  
dividíd
 / 
divis‹
;

517 
	}
}

520 
	$gëC⁄ãxtIndexSèts
(
c⁄ãxtId
,

521 
C⁄ãxtTy≥
 
c⁄ãxtTy≥
,

522 
UdsIndexSèts
 *
°©s
)

524 i‡(
°©s
 =
NULL
) {

525  
	`logEº‹WôhSåögEº‹
(
UDS_INDEX_STATS_PTR_REQUIRED
,

529 
UdsC⁄ãxt
 *
c⁄ãxt
;

530 
ªsu…
 = 
	`gëBa£C⁄ãxt
(
c⁄ãxtId
, 
c⁄ãxtTy≥
, &
c⁄ãxt
);

531 i‡(
ªsu…
 !
UDS_SUCCESS
) {

532  
	`logEº‹WôhSåögEº‹
(
ªsu…
, "getBaseContext() failed.");

535 
IndexRouãrSètCou¡îs
 
rouãrSèts
;

536 
ªsu…
 = 
	`gëGridSèti°ics
(
c⁄ãxt
->
ödexSessi⁄
->
grid
, &
rouãrSèts
);

537 i‡(
ªsu…
 !
UDS_SUCCESS
) {

538  
	`h™dÀEº‹AndRñó£Ba£C⁄ãxt
(
c⁄ãxt
, 
ªsu…
);

541 
°©s
->
íåõsIndexed
 = 
rouãrSèts
.entriesIndexed;

542 
°©s
->
mem‹yU£d
 = 
rouãrSèts
.memoryUsed;

543 
°©s
->
diskU£d
 = 
rouãrSèts
.diskUsed;

544 
°©s
->
cﬁlisi⁄s
 = 
rouãrSèts
.collisions;

545 
°©s
->
íåõsDisˇrded
 = 
rouãrSèts
.entriesDiscarded;

546 
°©s
->
checkpoöts
 = 
rouãrSèts
.checkpoints;

548  
	`h™dÀEº‹AndRñó£Ba£C⁄ãxt
(
c⁄ãxt
, 
ªsu…
);

549 
	}
}

552 
	$gëC⁄ãxtSèts
(
c⁄ãxtId
,

553 
C⁄ãxtTy≥
 
c⁄ãxtTy≥
,

554 
UdsC⁄ãxtSèts
 *
°©s
)

556 i‡(
°©s
 =
NULL
) {

558 
	`logW¨nögWôhSåögEº‹
(
UDS_CONTEXT_STATS_PTR_REQUIRED
,

562 
UdsC⁄ãxt
 *
c⁄ãxt
;

563 
ªsu…
 = 
	`gëBa£C⁄ãxt
(
c⁄ãxtId
, 
c⁄ãxtTy≥
, &
c⁄ãxt
);

564 i‡(
ªsu…
 !
UDS_SUCCESS
) {

565  
	`logW¨nögWôhSåögEº‹
(
ªsu…
, "getBaseContext() failed");

570 
Reque°
 *
ªque°
;

571 
ªsu…
 = 
	`œunchClõ¡C⁄åﬁMesßge
(
c⁄ãxt
, 
°©s
,

572 
REQUEST_COLLECT_CONTEXT_STATS
,

573 
STAGE_CALLBACK
, &
ªque°
);

574 i‡(
ªsu…
 !
UDS_SUCCESS
) {

575  
	`h™dÀEº‹AndRñó£Ba£C⁄ãxt
(
c⁄ãxt
, 
ªsu…
);

580 
ªsu…
 = 
ªque°
->
°©us
;

581 
	`‰ìReque°
(
ªque°
);

582  
	`h™dÀEº‹
(
c⁄ãxt
, 
ªsu…
);

583 
	}
}

586 
	$cﬁÀ˘Sèts
(c⁄° 
UdsC⁄ãxt
 *
c⁄ãxt
, 
UdsC⁄ãxtSèts
 *
°©s
)

588 c⁄° 
SètCou¡îs
 *
cou¡îs
 = &
c⁄ãxt
->
°©s
.counters;

590 
°©s
->
ª£tTime
 = 
c⁄ãxt
->stats.resetTime;

591 
°©s
->
cuºítTime
 = 
	`asTimeT
(
	`cuºítTime
(
CT_REALTIME
));

593 
°©s
->
po°sFound
 = 
cou¡îs
->postsFound;

594 
°©s
->
öMem‹yPo°sFound
 = 
cou¡îs
->
po°sFoundO≥nCh≠ãr
;

595 
°©s
->
dí£Po°sFound
 = 
cou¡îs
->
po°sFoundDí£
;

596 
°©s
->
•¨£Po°sFound
 = 
cou¡îs
->
po°sFoundS∑r£
;

597 
°©s
->
po°sNŸFound
 = 
cou¡îs
->postsNotFound;

598 
°©s
->
byãsFound
 = 
cou¡îs
->bytesFound;

599 
°©s
->
byãsNŸFound
 = 
cou¡îs
->bytesNotFound;

600 
°©s
->
avgChunkFound
 = 
	`ß„Divide
(°©s->
byãsFound
,

601 
cou¡îs
->
po°sFoundD©a
);

602 
°©s
->
avgChunkNŸFound
 = 
	`ß„Divide
(°©s->
byãsNŸFound
,

603 
cou¡îs
->
po°sNŸFoundD©a
);

604 
°©s
->
upd©esFound
 = 
cou¡îs
->updatesFound;

605 
°©s
->
upd©esNŸFound
 = 
cou¡îs
->updatesNotFound;

606 
°©s
->
dñëi⁄sFound
 = 
cou¡îs
->deletionsFound;

607 
°©s
->
dñëi⁄sNŸFound
 = 
cou¡îs
->deletionsNotFound;

608 
°©s
->
quîõsFound
 = 
cou¡îs
->queriesFound;

609 
°©s
->
quîõsNŸFound
 = 
cou¡îs
->queriesNotFound;

610 
°©s
->
ªque°s
 = 
cou¡îs
->requests;

611 
°©s
->
ªque°Tu∫¨oundTime
 = 
cou¡îs
->requestTurnaroundTime;

612 
°©s
->
maximumTu∫¨oundTime
 = 
cou¡îs
->maximumTurnaroundTime;

620 
°©s
->
ªque°QueueLimô
 = 
	`gëReque°PîmôLimô
(
c⁄ãxt
->
ªque°Limô
);

621 
	}
}

624 
	$ª£tSèts
(
c⁄ãxtId
, 
C⁄ãxtTy≥
 
c⁄ãxtTy≥
)

626 
UdsC⁄ãxt
 *
c⁄ãxt
;

627 
ªsu…
 = 
	`gëBa£C⁄ãxt
(
c⁄ãxtId
, 
c⁄ãxtTy≥
, &
c⁄ãxt
);

628 i‡(
ªsu…
 !
UDS_SUCCESS
) {

629  
ªsu…
;

634 
Reque°
 *
ªque°
;

635 
ªsu…
 = 
	`œunchClõ¡C⁄åﬁMesßge
(
c⁄ãxt
, 
NULL
,

636 
REQUEST_RESET_CONTEXT_STATS
,

637 
STAGE_CALLBACK
, &
ªque°
);

638 i‡(
ªsu…
 !
UDS_SUCCESS
) {

639  
	`h™dÀEº‹AndRñó£Ba£C⁄ãxt
(
c⁄ãxt
, 
ªsu…
);

642 
ªsu…
 = 
ªque°
->
°©us
;

643 
	`‰ìReque°
(
ªque°
);

644  
	`h™dÀEº‹
(
c⁄ãxt
, 
ªsu…
);

645 
	}
}

648 
	$ªgi°îDedu≥CÆlback
(
c⁄ãxtID
,

649 
C⁄ãxtTy≥
 
c⁄ãxtTy≥
,

650 
IndexCÆlbackFun˘i⁄
 *
ˇŒbackFun˘i⁄
,

651 *
ˇŒbackArgumít
)

653 
UdsC⁄ãxt
 *
c⁄ãxt
;

654 
ªsu…
 = 
	`gëBa£C⁄ãxt
(
c⁄ãxtID
, 
c⁄ãxtTy≥
, &
c⁄ãxt
);

655 i‡(
ªsu…
 !
UDS_SUCCESS
) {

656  
ªsu…
;

659 i‡(
ˇŒbackFun˘i⁄
 =
NULL
) {

660 
c⁄ãxt
->
hasCÆlback
 = 
Ál£
;

661 } i‡(
c⁄ãxt
->
hasCÆlback
) {

662 
ªsu…
 = 
UDS_CALLBACK_ALREADY_REGISTERED
;

664 
c⁄ãxt
->
ˇŒbackFun˘i⁄
 = *callbackFunction;

665 
c⁄ãxt
->
ˇŒbackArgumít
 = callbackArgument;

666 
c⁄ãxt
->
hasCÆlback
 = 
åue
;

669 
	`ªÀa£Ba£C⁄ãxt
(
c⁄ãxt
);

670  
ªsu…
;

671 
	}
}

674 
	$di•©chC⁄ãxtC⁄åﬁReque°
(
Reque°
 *
ªque°
)

676 
C⁄ãxtSèts
 *
°©s
 = &
ªque°
->
c⁄ãxt
->stats;

677 
ªque°
->
a˘i⁄
) {

678 
REQUEST_COLLECT_CONTEXT_STATS
:

679 
	`cﬁÀ˘Sèts
(
ªque°
->
c⁄ãxt
, (
UdsC⁄ãxtSèts
 *Ëªque°->
c⁄åﬁD©a
);

680  
UDS_SUCCESS
;

682 
REQUEST_RESET_CONTEXT_STATS
:

683 
	`mem£t
(&
°©s
->
cou¡îs
, 0, (stats->counters));

684 
°©s
->
ª£tTime
 = 
	`asTimeT
(
	`cuºítTime
(
CT_REALTIME
));

685  
UDS_SUCCESS
;

688  
	`ASSERT_FALSE
("unsupported context controláction %d",

689 
ªque°
->
a˘i⁄
);

691 
	}
}

	@uds/context.h

22 #i‚de‡
CONTEXT_H


23 
	#CONTEXT_H


	)

25 
	~"comm⁄.h
"

26 
	~"˝u.h
"

27 
	~"„©uªDefs.h
"

28 
	~"«me•a˚Hash.h
"

29 
	~"›aqueTy≥s.h
"

30 
	~"£ssi⁄.h
"

31 
	~"uds-block.h
"

32 
	~"utû/©omic.h
"

37 
	eudsC⁄ãxtSèã
 {

38 
	mUDS_CS_READY
 = 1,

39 
	mUDS_CS_DISABLED
 = 2

40 } 
	tUdsC⁄ãxtSèã
;

46 
	mBLOCK_CONTEXT


47 } 
	tC⁄ãxtTy≥
;

49 
	s°©Cou¡îs
 {

50 
uöt64_t
 
	mpo°sFound
;

51 
uöt64_t
 
	mpo°sFoundO≥nCh≠ãr
;

52 
uöt64_t
 
	mpo°sFoundDí£
;

53 
uöt64_t
 
	mpo°sFoundS∑r£
;

54 
uöt64_t
 
	mpo°sNŸFound
;

55 
uöt64_t
 
	mpo°sFoundD©a
;

56 
uöt64_t
 
	mpo°sNŸFoundD©a
;

57 
uöt64_t
 
	mupd©esFound
;

58 
uöt64_t
 
	mupd©esNŸFound
;

59 
uöt64_t
 
	mdñëi⁄sFound
;

60 
uöt64_t
 
	mdñëi⁄sNŸFound
;

61 
uöt64_t
 
	mquîõsFound
;

62 
uöt64_t
 
	mquîõsNŸFound
;

63 
uöt64_t
 
	mªque°s
;

64 
uöt64_t
 
	mbyãsFound
;

65 
uöt64_t
 
	mbyãsNŸFound
;

66 
öt64_t
 
	mªque°Tu∫¨oundTime
;

67 
öt64_t
 
	mmaximumTu∫¨oundTime
;

68 } 
	tSètCou¡îs
;

70 
__©åibuã__
((
	tÆig√d
(
	tCACHE_LINE_BYTES
))Ë
	tc⁄ãxtSèts
 {

71 
time_t
 
ª£tTime
;

72 
SètCou¡îs
 
cou¡îs
;

73 
	}
} 
	tC⁄ãxtSèts
;

76 
UdsDedu≥BlockCÆlback
 
	mblockCÆlback
;

77 } 
	tIndexCÆlbackFun˘i⁄
;

85 (*
	tMëad©aEncodî
)(c⁄° *
	tmëad©a
, 
	tReque°
 *
	tªque°
);

93 (*
	tCÆlbackH™dÀr
)(
	tReque°
 *
	tªque°
);

98 
	`__©åibuã__
((
	tÆig√d
(
	tCACHE_LINE_BYTES
))Ë
	tudsC⁄ãxt
 {

100 
id
;

102 
C⁄ãxtTy≥
 
ty≥
;

104 
UdsC⁄ãxtSèã
 
c⁄ãxtSèã
;

107 
IndexSessi⁄
 *
ödexSessi⁄
;

108 
Sessi⁄
 
£ssi⁄
;

110 #i‡
NAMESPACES


112 
Name•a˚Hash
 
«me•a˚Hash
;

115 
mëad©aSize
;

120 
Mëad©aEncodî
 
mëad©aEncodî
;

122 
chunkSize
;

125 
boﬁ
 
timeReque°Tu∫¨ound
;

128 
boﬁ
 
hasCÆlback
;

129 
CÆlbackH™dÀr
 
ˇŒbackH™dÀr
;

130 
IndexCÆlbackFun˘i⁄
 
ˇŒbackFun˘i⁄
;

131 *
ˇŒbackArgumít
;

134 
Reque°Limô
 *
ªque°Limô
;

137 
C⁄ãxtSèts
 
°©s
;

140 
Atomic32
 
hashQueueRŸ‹
;

143 
	`UdsChunkName
 (*
chunkNameGíî©‹
)(c⁄° *
d©a
, 
size_t
 
size
);

144 
	}
} 
	tUdsC⁄ãxt
;

149 c⁄° *
c⁄ãxtTy≥ToSåög
(
C⁄ãxtTy≥
 
c⁄ãxtTy≥
);

151 #i‡
NAMESPACES


168 
	$›íC⁄ãxt
(
UdsIndexSessi⁄
 
£ssi⁄
,

169 c⁄° 
UdsName•a˚
 *
«me•a˚
,

170 
mëad©aSize
,

171 
Mëad©aEncodî
 
mëad©aEncodî
,

172 
chunkSize
,

173 
C⁄ãxtTy≥
 
c⁄ãxtTy≥
,

174 
CÆlbackH™dÀr
 
ˇŒbackH™dÀr
,

175 *
c⁄ãxtID
)

176 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

193 
	$›íC⁄ãxt
(
UdsIndexSessi⁄
 
£ssi⁄
,

194 
mëad©aSize
,

195 
Mëad©aEncodî
 
mëad©aEncodî
,

196 
chunkSize
,

197 
C⁄ãxtTy≥
 
c⁄ãxtTy≥
,

198 
CÆlbackH™dÀr
 
ˇŒbackH™dÀr
,

199 *
c⁄ãxtID
)

200 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

212 
	$h™dÀEº‹
(
UdsC⁄ãxt
 *
c⁄ãxt
, 
îr‹Code
)

213 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

224 
	$h™dÀEº‹AndRñó£Ba£C⁄ãxt
(
UdsC⁄ãxt
 *
c⁄ãxt
, 
îr‹Code
)

225 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

227 #i‡
NAMESPACES


244 
	$makeBa£C⁄ãxt
(
IndexSessi⁄
 *
ödexSessi⁄
,

245 c⁄° 
UdsName•a˚
 *
«me•a˚
,

246 
mëad©aSize
,

247 
Mëad©aEncodî
 
mëad©aEncodî
,

248 
chunkSize
,

249 
C⁄ãxtTy≥
 
c⁄ãxtTy≥
,

250 
CÆlbackH™dÀr
 
ˇŒbackH™dÀr
,

251 
UdsC⁄ãxt
 **
c⁄ãxtPå
)

252 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

269 
	$makeBa£C⁄ãxt
(
IndexSessi⁄
 *
ödexSessi⁄
,

270 
mëad©aSize
,

271 
Mëad©aEncodî
 
mëad©aEncodî
,

272 
chunkSize
,

273 
C⁄ãxtTy≥
 
c⁄ãxtTy≥
,

274 
CÆlbackH™dÀr
 
ˇŒbackH™dÀr
,

275 
UdsC⁄ãxt
 **
c⁄ãxtPå
)

276 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

288 
	$gëBa£C⁄ãxt
(
c⁄ãxtId
,

289 
C⁄ãxtTy≥
 
c⁄ãxtTy≥
,

290 
UdsC⁄ãxt
 **
c⁄ãxtPå
)

291 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

298 
	`ªÀa£Ba£C⁄ãxt
(
UdsC⁄ãxt
 *
c⁄ãxt
);

305 
	`ÊushBa£C⁄ãxt
(
UdsC⁄ãxt
 *
c⁄ãxt
);

312 
	`‰ìC⁄ãxt
(
UdsC⁄ãxt
 *
c⁄ãxt
);

322 
	$ÊushC⁄ãxt
(
c⁄ãxtId
, 
C⁄ãxtTy≥
 
c⁄ãxtTy≥
)

323 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

331 
	$˛o£C⁄ãxt
(
c⁄ãxtId
, 
C⁄ãxtTy≥
 
c⁄ãxtTy≥
)

332 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

343 
	$gëC⁄figuøti⁄
(
c⁄ãxtId
,

344 
C⁄ãxtTy≥
 
c⁄ãxtTy≥
,

345 
UdsC⁄figuøti⁄
 *
c⁄f
)

346 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

357 
	$gëC⁄ãxtIndexSèts
(
c⁄ãxtId
,

358 
C⁄ãxtTy≥
 
c⁄ãxtTy≥
,

359 
UdsIndexSèts
 *
°©s
)

360 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

371 
	$gëC⁄ãxtSèts
(
c⁄ãxtId
,

372 
C⁄ãxtTy≥
 
c⁄ãxtTy≥
,

373 
UdsC⁄ãxtSèts
 *
°©s
)

374 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

384 
	$ª£tSèts
(
c⁄ãxtId
, 
C⁄ãxtTy≥
 
c⁄ãxtTy≥
)

385 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

397 
	$£tReque°QueueLimô
(
c⁄ãxtId
,

398 
C⁄ãxtTy≥
 
c⁄ãxtTy≥
,

399 
maxReque°s
)

400 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

412 
	$£tChunkNameAlg‹ôhm
(
c⁄ãxtId
,

413 
C⁄ãxtTy≥
 
c⁄ãxtTy≥
,

414 
UdsHashAlg‹ôhm
 
Æg‹ôhm
)

415 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

429 
UdsChunkName
 
	$gíî©eChunkName
(
c⁄ãxtId
,

430 
C⁄ãxtTy≥
 
c⁄ãxtTy≥
,

431 c⁄° *
d©a
,

432 
size_t
 
size
)

433 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

448 
	$ªgi°îDedu≥CÆlback
(
c⁄ãxtID
,

449 
C⁄ãxtTy≥
 
c⁄ãxtTy≥
,

450 
IndexCÆlbackFun˘i⁄
 *
ˇŒbackFun˘i⁄
,

451 *
ˇŒbackArgumít
)

452 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

461 
	$di•©chC⁄ãxtC⁄åﬁReque°
(
Reque°
 *
ªque°
)

462 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

	@uds/cpu.h

22 #i‚de‡
CPU_H


23 
	#CPU_H


	)

25 
	~"compûî.h
"

26 
	~"ty≥Defs.h
"

34 
	#CACHE_LINE_BYTES
 64

	)

44 
INLINE
 
	$¥e„tchAddªss
(c⁄° *
addªss
, 
boﬁ
 
f‹Wrôe
)

48 i‡(
	`__buûtö_c⁄°™t_p
(
f‹Wrôe
)) {

49 
	`__buûtö_¥e„tch
(
addªss
, 
f‹Wrôe
);

51 
	}
}

62 
INLINE
 
	$¥e„tchR™ge
(c⁄° *
°¨t
,

63 
size
,

64 
boﬁ
 
f‹Wrôe
)

68 c⁄° *
addªss
 = (c⁄° *Ë
°¨t
;

69 
off£t
 = ((
uöçå_t
Ë
addªss
 % 
CACHE_LINE_BYTES
);

70 
size
 +
off£t
;

72 
ˇcheLöes
 = (1 + (
size
 / 
CACHE_LINE_BYTES
));

73 
ˇcheLöes
-- > 0) {

74 
	`¥e„tchAddªss
(
addªss
, 
f‹Wrôe
);

75 
addªss
 +
CACHE_LINE_BYTES
;

77 
	}
}

	@uds/deltaIndex.c

21 
	~"dñèIndex.h
"

23 
	~"bôs.h
"

24 
	~"compûî.h
"

25 
	~"˝u.h
"

26 
	~"îr‹s.h
"

27 
	~"loggî.h
"

28 
	~"mem‹yAŒoc.h
"

29 
	~"≥rmas£π.h
"

30 
	~"°rögUtûs.h
"

31 
	~"ty≥Defs.h
"

32 
	~"uds.h
"

33 
	~"z⁄e.h
"

139 íum { 
	mMAGIC_SIZE
 = 8 };

140 c⁄° 
	gMAGIC_DI_START
[] = "DI-00002";

142 
	sdi_hódî
 {

143 
	mmagic
[
MAGIC_SIZE
];

144 
	mz⁄eNumbî
;

145 
	mnumZ⁄es
;

146 
	mfú°Li°
;

147 
	mnumLi°s
;

148 
	mªc‹dCou¡
;

149 
	mcﬁlisi⁄Cou¡
;

162 
INLINE
 
	$moveDñèLi°Sèπ
(
DñèLi°
 *
dñèLi°
, 
ö¸emít
)

164 
dñèLi°
->
°¨tOff£t
 +
ö¸emít
;

165 
dñèLi°
->
size
 -
ö¸emít
;

166 
	}
}

174 
INLINE
 
	$moveDñèLi°End
(
DñèLi°
 *
dñèLi°
, 
ö¸emít
)

176 
dñèLi°
->
size
 +
ö¸emít
;

177 
	}
}

185 
__©åibuã__
((
	t∑cked
)Ë
	tdñèPageHódî
 {

186 
uöt64_t
 
	gn⁄˚
;

187 
uöt64_t
 
	gvútuÆCh≠ãrNumbî
;

188 
uöt16_t
 
	gfú°Li°
;

189 
uöt16_t
 
	gnumLi°s
;

190 } 
	tDñèPageHódî
;

195 íum { 
	mIMMUTABLE_HEADER_SIZE
 = 19 };

204 
INLINE
 
	$gëImmuèbÀHódîOff£t
(
li°Numbî
)

206  ((
DñèPageHódî
Ë* 
CHAR_BIT


207 + 
li°Numbî
 * 
IMMUTABLE_HEADER_SIZE
);

208 
	}
}

218 
INLINE
 
	$gëImmuèbÀSèπ
(c⁄° 
byã
 *
mem‹y
,

219 
li°Numbî
)

221  
	`gëFõld
(
mem‹y
, 
	`gëImmuèbÀHódîOff£t
(
li°Numbî
),

222 
IMMUTABLE_HEADER_SIZE
);

223 
	}
}

232 
INLINE
 
	$£tImmuèbÀSèπ
(
byã
 *
mem‹y
, 
li°Numbî
,

233 
°¨tOff£t
)

235 
	`£tFõld
(
°¨tOff£t
, 
mem‹y
, 
	`gëImmuèbÀHódîOff£t
(
li°Numbî
),

236 
IMMUTABLE_HEADER_SIZE
);

237 
	}
}

251 
INLINE
 
	$decodeDñè
(
DñèIndexE¡ry
 *
dñèE¡ry
)

253 c⁄° 
DñèMem‹y
 *
dñèZ⁄e
 = 
dñèE¡ry
->deltaZone;

254 c⁄° 
byã
 *
mem‹y
 = 
dñèZ⁄e
->memory;

255 
uöt64_t
 
dñèOff£t


256 
	`gëDñèE¡ryOff£t
(
dñèE¡ry
Ë+ dñèE¡ry->
vÆueBôs
;

257 c⁄° 
uöt32_t
 *
addr
 = (c⁄° uöt32_à*Ë(
mem‹y
 + 
dñèOff£t
 / 
CHAR_BIT
);

258 
off£t
 = 
dñèOff£t
 % 
CHAR_BIT
;

259 
uöt32_t
 
d©a
 = *
addr
++ >> 
off£t
;

260 
keyBôs
 = 
dñèZ⁄e
->
möBôs
;

261 
dñè
 = 
d©a
 & ((1 << 
keyBôs
) - 1);

262 i‡(
dñè
 >
dñèZ⁄e
->
möKeys
) {

263 
d©a
 >>
keyBôs
;

264 i‡(
d©a
 == 0) {

265 
keyBôs
 = (
uöt32_t
Ë* 
CHAR_BIT
 - 
off£t
;

266 (
d©a
 = *
addr
++) == 0) {

267 
keyBôs
 +(
uöt32_t
Ë* 
CHAR_BIT
;

270 
keyBôs
 +
	`__buûtö_ffs
(
d©a
);

271 
dñè
 +(
keyBôs
 - 
dñèZ⁄e
->
möBôs
 - 1Ë* dñèZ⁄e->
ö¸Keys
;

273 
dñèE¡ry
->
dñè
 = delta;

274 
dñèE¡ry
->
key
 +
dñè
;

277 i‡(
	`u∆ikñy
((
dñè
 =0Ë&& (
dñèE¡ry
->
off£t
 > 0))) {

278 
dñèE¡ry
->
isCﬁlisi⁄
 = 
åue
;

281 
dñèE¡ry
->
íåyBôs
 = dñèE¡ry->
vÆueBôs
 + 
keyBôs
 + 
COLLISION_BITS
;

283 
dñèE¡ry
->
isCﬁlisi⁄
 = 
Ál£
;

284 
dñèE¡ry
->
íåyBôs
 = dñèE¡ry->
vÆueBôs
 + 
keyBôs
;

286 
	}
}

295 
	$dñëeBôs
(c⁄° 
DñèIndexE¡ry
 *
dñèE¡ry
, 
size
)

297 
DñèLi°
 *
dñèLi°
 = 
dñèE¡ry
->deltaList;

298 
byã
 *
mem‹y
 = 
dñèE¡ry
->
dñèZ⁄e
->memory;

300 
uöt32_t
 
tŸÆSize
 = 
	`gëDñèLi°Size
(
dñèLi°
);

301 
uöt32_t
 
bef‹eSize
 = 
dñèE¡ry
->
off£t
;

302 
uöt32_t
 
a·îSize
 = 
tŸÆSize
 - 
dñèE¡ry
->
off£t
 - 
size
;

307 
boﬁ
 
bef‹eFœg
;

308 i‡(
bef‹eSize
 < 
a·îSize
) {

309 
bef‹eFœg
 = 
åue
;

310 } i‡(
a·îSize
 < 
bef‹eSize
) {

311 
bef‹eFœg
 = 
Ál£
;

313 
uöt64_t
 
‰ìBef‹e


314 
	`gëDñèLi°Sèπ
(&
dñèLi°
[0]Ë- 
	`gëDñèLi°End
(&deltaList[-1]);

315 
uöt64_t
 
‰ìA·î


316 
	`gëDñèLi°Sèπ
(&
dñèLi°
[1]Ë- 
	`gëDñèLi°End
(&deltaList[ 0]);

317 
bef‹eFœg
 = 
‰ìBef‹e
 < 
‰ìA·î
;

320 
uöt64_t
 
sour˚
, 
de°ö©i⁄
;

321 
uöt32_t
 
cou¡
;

322 i‡(
bef‹eFœg
) {

323 
sour˚
 = 
	`gëDñèLi°Sèπ
(
dñèLi°
);

324 
de°ö©i⁄
 = 
sour˚
 + 
size
;

325 
	`moveDñèLi°Sèπ
(
dñèLi°
, 
size
);

326 
cou¡
 = 
bef‹eSize
;

328 
	`moveDñèLi°End
(
dñèLi°
, -
size
);

329 
de°ö©i⁄
 = 
	`gëDñèLi°Sèπ
(
dñèLi°
Ë+ 
dñèE¡ry
->
off£t
;

330 
sour˚
 = 
de°ö©i⁄
 + 
size
;

331 
cou¡
 = 
a·îSize
;

333 
	`moveBôs
(
mem‹y
, 
sour˚
, mem‹y, 
de°ö©i⁄
, 
cou¡
);

334 
	}
}

343 
INLINE
 
uöt64_t
 
	$gëCﬁlisi⁄Off£t
(c⁄° 
DñèIndexE¡ry
 *
íåy
)

345  (
	`gëDñèE¡ryOff£t
(
íåy
Ë+É¡ry->
íåyBôs
 - 
COLLISION_BITS
);

346 
	}
}

353 
	$ícodeDñè
(c⁄° 
DñèIndexE¡ry
 *
dñèE¡ry
)

355 c⁄° 
DñèMem‹y
 *
dñèZ⁄e
 = 
dñèE¡ry
->deltaZone;

356 
byã
 *
mem‹y
 = 
dñèZ⁄e
->memory;

357 
uöt64_t
 
off£t
 = 
	`gëDñèE¡ryOff£t
(
dñèE¡ry
Ë+ dñèE¡ry->
vÆueBôs
;

358 i‡(
dñèE¡ry
->
dñè
 < 
dñèZ⁄e
->
möKeys
) {

359 
	`£tFõld
(
dñèE¡ry
->
dñè
, 
mem‹y
, 
off£t
, 
dñèZ⁄e
->
möBôs
);

362 
ãmp
 = 
dñèE¡ry
->
dñè
 - 
dñèZ⁄e
->
möKeys
;

363 
t1
 = (
ãmp
 % 
dñèZ⁄e
->
ö¸Keys
Ë+ dñèZ⁄e->
möKeys
;

364 
t2
 = 
ãmp
 / 
dñèZ⁄e
->
ö¸Keys
;

365 
	`£tFõld
(
t1
, 
mem‹y
, 
off£t
, 
dñèZ⁄e
->
möBôs
);

366 
	`£tZîo
(
mem‹y
, 
off£t
 + 
dñèZ⁄e
->
möBôs
, 
t2
);

367 
	`£tO√
(
mem‹y
, 
off£t
 + 
dñèZ⁄e
->
möBôs
 + 
t2
, 1);

368 
	}
}

377 
	$ícodeE¡ry
(c⁄° 
DñèIndexE¡ry
 *
dñèE¡ry
, 
vÆue
,

378 c⁄° 
byã
 *
«me
)

380 
byã
 *
mem‹y
 = 
dñèE¡ry
->
dñèZ⁄e
->memory;

381 
uöt64_t
 
off£t
 = 
	`gëDñèE¡ryOff£t
(
dñèE¡ry
);

382 
	`£tFõld
(
vÆue
, 
mem‹y
, 
off£t
, 
dñèE¡ry
->
vÆueBôs
);

383 
	`ícodeDñè
(
dñèE¡ry
);

384 i‡(
«me
 !
NULL
) {

385 
	`£tByãs
(
mem‹y
, 
	`gëCﬁlisi⁄Off£t
(
dñèE¡ry
), 
«me
, 
COLLISION_BYTES
);

387 
	}
}

398 
	$ö£πBôs
(
DñèIndexE¡ry
 *
dñèE¡ry
, 
size
)

400 
DñèMem‹y
 *
dñèZ⁄e
 = 
dñèE¡ry
->deltaZone;

401 
DñèLi°
 *
dñèLi°
 = 
dñèE¡ry
->deltaList;

403 
uöt32_t
 
tŸÆSize
 = 
	`gëDñèLi°Size
(
dñèLi°
);

404 
uöt32_t
 
bef‹eSize
 = 
dñèE¡ry
->
off£t
;

405 
uöt32_t
 
a·îSize
 = 
tŸÆSize
 - 
dñèE¡ry
->
off£t
;

406 i‡((Ë(
tŸÆSize
 + 
size
Ë> 
UINT16_MAX
) {

407 
dñèE¡ry
->
li°OvîÊow
 = 
åue
;

408 
dñèZ⁄e
->
ovîÊowCou¡
++;

409  
UDS_OVERFLOW
;

413 
uöt64_t
 
‰ìBef‹e


414 
	`gëDñèLi°Sèπ
(&
dñèLi°
[0]Ë- 
	`gëDñèLi°End
(&deltaList[-1]);

415 
uöt64_t
 
‰ìA·î


416 
	`gëDñèLi°Sèπ
(&
dñèLi°
[1]Ë- 
	`gëDñèLi°End
(&deltaList[ 0]);

418 
boﬁ
 
bef‹eFœg
;

419 i‡(((Ë
size
 <
‰ìBef‹e
)

420 && ((Ë
size
 <
‰ìA·î
)) {

424 i‡(
bef‹eSize
 < 
a·îSize
) {

425 
bef‹eFœg
 = 
åue
;

426 } i‡(
a·îSize
 < 
bef‹eSize
) {

427 
bef‹eFœg
 = 
Ál£
;

429 
bef‹eFœg
 = 
‰ìBef‹e
 > 
‰ìA·î
;

431 } i‡((Ë
size
 <
‰ìBef‹e
) {

433 
bef‹eFœg
 = 
åue
;

434 } i‡((Ë
size
 <
‰ìA·î
) {

436 
bef‹eFœg
 = 
Ál£
;

441 
growögIndex
 = 
dñèE¡ry
->
li°Numbî
 + 1;

442 
bef‹eFœg
 = 
bef‹eSize
 < 
a·îSize
;

443 i‡(!
bef‹eFœg
) {

444 
growögIndex
++;

446 
ªsu…
 = 
	`exãndDñèMem‹y
(
dñèZ⁄e
, 
growögIndex
,

447 (
size
 + 
CHAR_BIT
 - 1Ë/ CHAR_BIT, 
åue
);

448 i‡(
ªsu…
 !
UDS_SUCCESS
) {

449  
ªsu…
;

453 
uöt64_t
 
sour˚
, 
de°ö©i⁄
;

454 
uöt32_t
 
cou¡
;

455 i‡(
bef‹eFœg
) {

456 
sour˚
 = 
	`gëDñèLi°Sèπ
(
dñèLi°
);

457 
de°ö©i⁄
 = 
sour˚
 - 
size
;

458 
	`moveDñèLi°Sèπ
(
dñèLi°
, -
size
);

459 
cou¡
 = 
bef‹eSize
;

461 
	`moveDñèLi°End
(
dñèLi°
, 
size
);

462 
sour˚
 = 
	`gëDñèLi°Sèπ
(
dñèLi°
Ë+ 
dñèE¡ry
->
off£t
;

463 
de°ö©i⁄
 = 
sour˚
 + 
size
;

464 
cou¡
 = 
a·îSize
;

466 
byã
 *
mem‹y
 = 
dñèZ⁄e
->memory;

467 
	`moveBôs
(
mem‹y
, 
sour˚
, mem‹y, 
de°ö©i⁄
, 
cou¡
);

468  
UDS_SUCCESS
;

469 
	}
}

479 
INLINE
 
size_t
 
	$gëZ⁄eMem‹ySize
(
numZ⁄es
,

480 
size_t
 
mem‹ySize
)

482 
size_t
 
z⁄eSize
 = 
mem‹ySize
 / 
numZ⁄es
;

484 íum { 
ALLOC_BOUNDARY
 = 64 * 
KILOBYTE
 };

485  (
z⁄eSize
 + 
ALLOC_BOUNDARY
 - 1) & -ALLOC_BOUNDARY;

486 
	}
}

494 
boﬁ
 
	$övÆidP¨amëîs
(
mónDñè
,

495 
numPaylﬂdBôs
)

497 c⁄° 
möDñè
 = 10;

498 c⁄° 
maxDñè
 = 1 << 
MAX_FIELD_BITS
;

499 i‡((
mónDñè
 < 
möDñè
Ë|| (mónDñè > 
maxDñè
)) {

500 
	`logW¨nög
("error initializing delta index: "

502 
mónDñè
, 
möDñè
, 
maxDñè
);

503  
åue
;

505 i‡(
numPaylﬂdBôs
 > 
MAX_FIELD_BITS
) {

506 
	`logW¨nög
("error initializing delta index: Too manyÖayload bits (%u)",

507 
numPaylﬂdBôs
);

508  
åue
;

510  
Ál£
;

511 
	}
}

518 
	$£tCﬁlisi⁄
(
DñèIndexE¡ry
 *
dñèE¡ry
)

520 
dñèE¡ry
->
isCﬁlisi⁄
 = 
åue
;

521 
dñèE¡ry
->
íåyBôs
 +
COLLISION_BITS
;

522 
	}
}

530 
	$£tDñè
(
DñèIndexE¡ry
 *
dñèE¡ry
, 
dñè
)

532 c⁄° 
DñèMem‹y
 *
dñèZ⁄e
 = 
dñèE¡ry
->deltaZone;

533 
dñèE¡ry
->
dñè
 = delta;

534 
keyBôs
 = (
dñèZ⁄e
->
möBôs


535 + ((
dñèZ⁄e
->
ö¸Keys
 - dñèZ⁄e->
möKeys
 + 
dñè
)

536 / 
dñèZ⁄e
->
ö¸Keys
));

537 
dñèE¡ry
->
íåyBôs
 = dñèE¡ry->
vÆueBôs
 + 
keyBôs
;

538 
	}
}

544 
	$öôülizeDñèIndex
(
DñèIndex
 *
dñèIndex
, 
numZ⁄es
,

545 
numLi°s
, 
mónDñè
,

546 
numPaylﬂdBôs
, 
size_t
 
mem‹ySize
)

548 
size_t
 
memSize
 = 
	`gëZ⁄eMem‹ySize
(
numZ⁄es
, 
mem‹ySize
);

549 i‡(
	`övÆidP¨amëîs
(
mónDñè
, 
numPaylﬂdBôs
)) {

550  
UDS_INVALID_ARGUMENT
;

553 
ªsu…
 = 
	`ALLOCATE
(
numZ⁄es
, 
DñèMem‹y
, "Delta Index Zones",

554 &
dñèIndex
->
dñèZ⁄es
);

555 i‡(
ªsu…
 !
UDS_SUCCESS
) {

556  
ªsu…
;

559 
dñèIndex
->
numZ⁄es
 =ÇumZones;

560 
dñèIndex
->
numLi°s
 =ÇumLists;

561 
dñèIndex
->
li°sPîZ⁄e
 = (
numLi°s
 + 
numZ⁄es
 - 1) /ÇumZones;

562 
dñèIndex
->
isMuèbÀ
 = 
åue
;

563 
dñèIndex
->
èg
 = 'm';

565 
z
 = 0; z < 
numZ⁄es
; z++) {

566 
fú°Li°InZ⁄e
 = 
z
 * 
dñèIndex
->
li°sPîZ⁄e
;

567 
numLi°sInZ⁄e
 = 
dñèIndex
->
li°sPîZ⁄e
;

568 i‡(
z
 =
numZ⁄es
 - 1) {

578 i‡(
dñèIndex
->
numLi°s
 <
fú°Li°InZ⁄e
) {

579 
	`unöôülizeDñèIndex
(
dñèIndex
);

580  
	`logEº‹WôhSåögEº‹
(
UDS_INVALID_ARGUMENT
,

582 
numLi°s
, 
numZ⁄es
);

584 
numLi°sInZ⁄e
 = 
dñèIndex
->
numLi°s
 - 
fú°Li°InZ⁄e
;

586 
ªsu…
 = 
	`öôülizeDñèMem‹y
(&
dñèIndex
->
dñèZ⁄es
[
z
], 
memSize
,

587 
fú°Li°InZ⁄e
, 
numLi°sInZ⁄e
,

588 
mónDñè
, 
numPaylﬂdBôs
);

589 i‡(
ªsu…
 !
UDS_SUCCESS
) {

590 
	`unöôülizeDñèIndex
(
dñèIndex
);

591  
ªsu…
;

594  
UDS_SUCCESS
;

595 
	}
}

598 
	$öôülizeDñèIndexPage
(
DñèIndex
 *
dñèIndex
, 
DñèMem‹y
 *
dñèMem‹y
,

599 
uöt64_t
 
ex≥˘edN⁄˚
, 
mónDñè
,

600 
numPaylﬂdBôs
, 
byã
 *
mem‹y
,

601 
size_t
 
memSize
)

603 c⁄° 
DñèPageHódî
 *
hódî
 = (c⁄° DñèPageHódî *Ë
mem‹y
;

604 
numLi°s
 = 
hódî
->numLists;

606 i‡((
ex≥˘edN⁄˚
 !0Ë&& (
hódî
->
n⁄˚
 !=ÉxpectedNonce)) {

609  
UDS_CORRUPT_COMPONENT
;

613 i‡(
numLi°s
 >

614 (
memSize
 - (
DñèPageHódî
)Ë* 
CHAR_BIT
 / 
IMMUTABLE_HEADER_SIZE
) {

615  
	`logW¨nögWôhSåögEº‹
(

616 
UDS_CORRUPT_COMPONENT
, "error initializing delta indexÖage: "

617 "%uÜi°†wû»nŸ fô o¿®%zu byãÖage", 
numLi°s
, 
memSize
);

619 i‡(
	`gëImmuèbÀSèπ
(
mem‹y
, 0Ë!
	`gëImmuèbÀHódîOff£t
(
numLi°s
 + 1)) {

620  
	`logW¨nögWôhSåögEº‹
(

621 
UDS_CORRUPT_COMPONENT
, "error initializing delta indexÖage: "

623 
	`gëImmuèbÀSèπ
(
mem‹y
, 0),

624 
	`gëImmuèbÀHódîOff£t
(
numLi°s
 + 1));

627 
i
 = 0; i < 
numLi°s
; i++) {

628 i‡(
	`gëImmuèbÀSèπ
(
mem‹y
, 
i
) > getImmutableStart(memory, i + 1)) {

629  
	`logW¨nögWôhSåögEº‹
(

630 
UDS_CORRUPT_COMPONENT
, "error initializing delta indexÖage: "

632 
i
, 
	`gëImmuèbÀSèπ
(
mem‹y
, i),

633 
i
 + 1, 
	`gëImmuèbÀSèπ
(
mem‹y
, i + 1));

636 i‡(
	`gëImmuèbÀSèπ
(
mem‹y
, 
numLi°s
Ë> 
memSize
 * 
CHAR_BIT
) {

637  
	`logW¨nögWôhSåögEº‹
(

638 
UDS_CORRUPT_COMPONENT
,

641 
	`gëImmuèbÀSèπ
(
mem‹y
, 
numLi°s
), 
memSize
);

643 i‡(
	`gëImmuèbÀSèπ
(
mem‹y
, 
numLi°s
)

644 > (
memSize
 - 
POST_FIELD_GUARD_BYTES
Ë* 
CHAR_BIT
) {

645  
	`logW¨nögWôhSåögEº‹
(

646 
UDS_CORRUPT_COMPONENT
,

650 
	`gëImmuèbÀSèπ
(
mem‹y
, 
numLi°s
),

651 
POST_FIELD_GUARD_BYTES
 * 
CHAR_BIT
, 
memSize
);

654 i‡(
	`övÆidP¨amëîs
(
mónDñè
, 
numPaylﬂdBôs
)) {

655  
UDS_INVALID_ARGUMENT
;

658 
dñèIndex
->
dñèZ⁄es
 = 
dñèMem‹y
;

659 
dñèIndex
->
numZ⁄es
 = 1;

660 
dñèIndex
->
numLi°s
 =ÇumLists;

661 
dñèIndex
->
li°sPîZ⁄e
 = 
numLi°s
;

662 
dñèIndex
->
isMuèbÀ
 = 
Ál£
;

663 
dñèIndex
->
èg
 = 'p';

665 
	`öôülizeDñèMem‹yPage
(
dñèMem‹y
, (
byã
 *Ë
mem‹y
, 
memSize
, 
numLi°s
,

666 
mónDñè
, 
numPaylﬂdBôs
);

667  
UDS_SUCCESS
;

668 
	}
}

671 
	$unöôülizeDñèIndex
(
DñèIndex
 *
dñèIndex
)

673 i‡(
dñèIndex
 !
NULL
) {

674 
z
 = 0; z < 
dñèIndex
->
numZ⁄es
; z++) {

675 
	`unöôülizeDñèMem‹y
(&
dñèIndex
->
dñèZ⁄es
[
z
]);

677 
	`FREE
(
dñèIndex
->
dñèZ⁄es
);

678 
	`mem£t
(
dñèIndex
, 0, (
DñèIndex
));

680 
	}
}

683 
	$em±yDñèIndex
(c⁄° 
DñèIndex
 *
dñèIndex
)

685 
z
 = 0; z < 
dñèIndex
->
numZ⁄es
; z++) {

686 
	`em±yDñèLi°s
(&
dñèIndex
->
dñèZ⁄es
[
z
]);

688 
	}
}

691 
	$em±yDñèIndexZ⁄e
(c⁄° 
DñèIndex
 *
dñèIndex
, 
z⁄eNumbî
)

693 
	`em±yDñèLi°s
(&
dñèIndex
->
dñèZ⁄es
[
z⁄eNumbî
]);

694 
	}
}

697 
	$∑ckDñèIndexPage
(c⁄° 
DñèIndex
 *
dñèIndex
, 
uöt64_t
 
hódîN⁄˚
,

698 
byã
 *
mem‹y
, 
size_t
 
memSize
,

699 
uöt64_t
 
vútuÆCh≠ãrNumbî
, 
fú°Li°
,

700 *
numLi°s
)

702 i‡(!
dñèIndex
->
isMuèbÀ
) {

703  
	`logEº‹WôhSåögEº‹
(
UDS_BAD_STATE
,

706 i‡(
dñèIndex
->
numZ⁄es
 != 1) {

707  
	`logEº‹WôhSåögEº‹
(
UDS_BAD_STATE
,

710 
dñèIndex
->
numZ⁄es
);

712 i‡(
fú°Li°
 > 
dñèIndex
->
numLi°s
) {

713  
	`logEº‹WôhSåögEº‹
(
UDS_BAD_STATE
,

717 
fú°Li°
, 
dñèIndex
->
numLi°s
);

720 c⁄° 
DñèMem‹y
 *
dñèZ⁄e
 = &
dñèIndex
->
dñèZ⁄es
[0];

721 
DñèLi°
 *
dñèLi°s
 = &
dñèZ⁄e
->dñèLi°s[
fú°Li°
 + 1];

722 
maxLi°s
 = 
dñèIndex
->
numLi°s
 - 
fú°Li°
;

725 
numBôs
 = 
memSize
 * 
CHAR_BIT
;

727 
numBôs
 -
	`gëImmuèbÀHódîOff£t
(1);

730 
numBôs
 -
POST_FIELD_GUARD_BYTES
 * 
CHAR_BIT
;

731 i‡(
numBôs
 < 
IMMUTABLE_HEADER_SIZE
) {

733  
	`logEº‹WôhSåögEº‹
(
UDS_OVERFLOW
,

736 
memSize
);

739 
nLi°s
 = 0;

740 
nLi°s
 < 
maxLi°s
) {

742 
bôs
 = 
IMMUTABLE_HEADER_SIZE
 + 
	`gëDñèLi°Size
(&
dñèLi°s
[
nLi°s
]);

743 i‡(
bôs
 > 
numBôs
) {

746 
nLi°s
++;

747 
numBôs
 -
bôs
;

749 *
numLi°s
 = 
nLi°s
;

752 
DñèPageHódî
 *
hódî
 = (DñèPageHódî *Ë
mem‹y
;

753 
hódî
->
n⁄˚
 = 
hódîN⁄˚
;

754 
hódî
->
vútuÆCh≠ãrNumbî
 = virtualChapterNumber;

755 
hódî
->
fú°Li°
 = firstList;

756 
hódî
->
numLi°s
 = 
nLi°s
;

760 
off£t
 = 
	`gëImmuèbÀHódîOff£t
(
nLi°s
 + 1);

761 
	`£tImmuèbÀSèπ
(
mem‹y
, 0, 
off£t
);

762 
i
 = 0; i < 
nLi°s
; i++) {

763 
off£t
 +
	`gëDñèLi°Size
(&
dñèLi°s
[
i
]);

764 
	`£tImmuèbÀSèπ
(
mem‹y
, 
i
 + 1, 
off£t
);

768 
i
 = 0; i < 
nLi°s
; i++) {

769 
DñèLi°
 *
dñèLi°
 = &
dñèLi°s
[
i
];

770 
	`moveBôs
(
dñèZ⁄e
->
mem‹y
, 
	`gëDñèLi°Sèπ
(
dñèLi°
), memory,

771 
	`gëImmuèbÀSèπ
(
mem‹y
, 
i
), 
	`gëDñèLi°Size
(
dñèLi°
));

776 
	`mem£t
(
mem‹y
 + 
memSize
 - 
POST_FIELD_GUARD_BYTES
, ~0,

777 
POST_FIELD_GUARD_BYTES
);

778  
UDS_SUCCESS
;

779 
	}
}

782 
	$£tDñèIndexTag
(
DñèIndex
 *
dñèIndex
, 
byã
 
èg
)

784 
dñèIndex
->
èg
 =Åag;

785 
z
 = 0; z < 
dñèIndex
->
numZ⁄es
; z++) {

786 
dñèIndex
->
dñèZ⁄es
[
z
].
èg
 =Åag;

788 
	}
}

791 
	$°¨tRe°‹ögDñèIndex
(c⁄° 
DñèIndex
 *
dñèIndex
,

792 
Buf„ªdRódî
 **
buf„ªdRódîs
, 
numRódîs
)

794 i‡(!
dñèIndex
->
isMuèbÀ
) {

795  
	`logEº‹WôhSåögEº‹
(
UDS_BAD_STATE
,

798 i‡(
numRódîs
 <= 0) {

799  
	`logW¨nögWôhSåögEº‹
(
UDS_INVALID_ARGUMENT
,

803 
ªc‹dCou¡
 = 0;

804 
cﬁlisi⁄Cou¡
 = 0;

805 
numZ⁄es
 = 
numRódîs
;

806 
fú°Li°
[
numZ⁄es
], 
numLi°s
[numZones];

807 
Buf„ªdRódî
 *
ªadî
[
numZ⁄es
];

808 
boﬁ
 
z⁄eFœgs
[
numZ⁄es
];

809 
	`mem£t
(
z⁄eFœgs
, 
Ál£
, 
numZ⁄es
);

812 
z
 = 0; z < 
numZ⁄es
; z++) {

813 
di_hódî
 
hódî
;

814 
ªsu…
 = 
	`ªadFromBuf„ªdRódî
(
buf„ªdRódîs
[
z
], (
byã
 *)&
hódî
,

815 (
hódî
));

816 i‡(
ªsu…
 !
UDS_SUCCESS
) {

817  
	`logW¨nögWôhSåögEº‹
(
ªsu…
,

820 i‡(
	`memcmp
(
hódî
.
magic
, 
MAGIC_DI_START
, 
MAGIC_SIZE
) != 0) {

821  
	`logW¨nögWôhSåögEº‹
(
UDS_CORRUPT_COMPONENT
,

825 i‡(
numZ⁄es
 !
hódî
.numZones) {

826  
	`logW¨nögWôhSåögEº‹
(
UDS_CORRUPT_COMPONENT
,

829 
numZ⁄es
, 
hódî
.numZones);

831 i‡(
hódî
.
z⁄eNumbî
 >
numZ⁄es
) {

832  
	`logW¨nögWôhSåögEº‹
(
UDS_CORRUPT_COMPONENT
,

835 
hódî
.
z⁄eNumbî
, 
numZ⁄es
);

837 i‡(
z⁄eFœgs
[
hódî
.
z⁄eNumbî
]) {

838  
	`logW¨nögWôhSåögEº‹
(
UDS_CORRUPT_COMPONENT
,

841 
hódî
.
z⁄eNumbî
);

843 
ªadî
[
hódî
.
z⁄eNumbî
] = 
buf„ªdRódîs
[
z
];

844 
fú°Li°
[
hódî
.
z⁄eNumbî
] = header.firstList;

845 
numLi°s
[
hódî
.
z⁄eNumbî
] = header.numLists;

846 
z⁄eFœgs
[
hódî
.
z⁄eNumbî
] = 
åue
;

847 
ªc‹dCou¡
 +
hódî
.recordCount;

848 
cﬁlisi⁄Cou¡
 +
hódî
.collisionCount;

850 
li°Next
 = 0;

851 
z
 = 0; z < 
numZ⁄es
; z++) {

852 i‡(
fú°Li°
[
z
] !
li°Next
) {

853  
	`logW¨nögWôhSåögEº‹
(
UDS_CORRUPT_COMPONENT
,

856 
z
, 
fú°Li°
[z], 
li°Next
);

858 
li°Next
 +
numLi°s
[
z
];

860 i‡(
li°Next
 !
dñèIndex
->
numLi°s
) {

861  
	`logW¨nögWôhSåögEº‹
(
UDS_CORRUPT_COMPONENT
,

864 
li°Next
, 
dñèIndex
->
numLi°s
);

866 i‡(
cﬁlisi⁄Cou¡
 > 
ªc‹dCou¡
) {

867  
	`logW¨nögWôhSåögEº‹
(
UDS_CORRUPT_COMPONENT
,

870 
cﬁlisi⁄Cou¡
, 
ªc‹dCou¡
);

873 
	`em±yDñèIndex
(
dñèIndex
);

874 
dñèIndex
->
dñèZ⁄es
[0].
ªc‹dCou¡
 =ÑecordCount;

875 
dñèIndex
->
dñèZ⁄es
[0].
cﬁlisi⁄Cou¡
 = collisionCount;

879 
z
 = 0; z < 
numZ⁄es
; z++) {

880 
i
 = 0; i < 
numLi°s
[
z
]; i++) {

881 
uöt16_t
 
dñèLi°Size
;

882 
ªsu…
 = 
	`ªadFromBuf„ªdRódî
(
ªadî
[
z
], (
byã
 *)&
dñèLi°Size
,

883 (
dñèLi°Size
));

884 i‡(
ªsu…
 !
UDS_SUCCESS
) {

885  
	`logW¨nögWôhSåögEº‹
(
ªsu…
,

888 
li°Numbî
 = 
fú°Li°
[
z
] + 
i
;

889 
z⁄eNumbî
 = 
	`gëDñèIndexZ⁄e
(
dñèIndex
, 
li°Numbî
);

890 c⁄° 
DñèMem‹y
 *
dñèZ⁄e
 = &
dñèIndex
->
dñèZ⁄es
[
z⁄eNumbî
];

891 
li°Numbî
 -
dñèZ⁄e
->
fú°Li°
;

892 
dñèZ⁄e
->
dñèLi°s
[
li°Numbî
 + 1].
size
 = 
dñèLi°Size
;

897 
z
 = 0; z < 
dñèIndex
->
numZ⁄es
; z++) {

898 
ªsu…
 = 
	`°¨tRe°‹ögDñèMem‹y
(&
dñèIndex
->
dñèZ⁄es
[
z
]);

899 i‡(
ªsu…
 !
UDS_SUCCESS
) {

900  
ªsu…
;

903  
UDS_SUCCESS
;

904 
	}
}

907 
boﬁ
 
	$isRe°‹ögDñèIndexD⁄e
(c⁄° 
DñèIndex
 *
dñèIndex
)

909 
z
 = 0; z < 
dñèIndex
->
numZ⁄es
; z++) {

910 i‡(!
	`¨eDñèMem‹yTøns„rsD⁄e
(&
dñèIndex
->
dñèZ⁄es
[
z
])) {

911  
Ál£
;

914  
åue
;

915 
	}
}

918 
	$ª°‹eDñèLi°ToDñèIndex
(c⁄° 
DñèIndex
 *
dñèIndex
,

919 c⁄° 
DñèLi°SaveInfo
 *
dlsi
,

920 c⁄° 
byã
 
d©a
[
DELTA_LIST_MAX_BYTE_COUNT
])

924 i‡(
dlsi
->
èg
 !
dñèIndex
->tag) {

925  
UDS_CORRUPT_COMPONENT
;

928 i‡(
dlsi
->
ödex
 >
dñèIndex
->
numLi°s
) {

929  
	`logW¨nögWôhSåögEº‹
(
UDS_CORRUPT_COMPONENT
,

931 
dlsi
->
ödex
, 
dñèIndex
->
numLi°s
);

934 
z⁄eNumbî
 = 
	`gëDñèIndexZ⁄e
(
dñèIndex
, 
dlsi
->
ödex
);

935  
	`ª°‹eDñèLi°
(&
dñèIndex
->
dñèZ⁄es
[
z⁄eNumbî
], 
dlsi
, 
d©a
);

936 
	}
}

939 
	$ab‹tRe°‹ögDñèIndex
(c⁄° 
DñèIndex
 *
dñèIndex
)

941 
z
 = 0; z < 
dñèIndex
->
numZ⁄es
; z++) {

942 
	`ab‹tRe°‹ögDñèMem‹y
(&
dñèIndex
->
dñèZ⁄es
[
z
]);

944 
	}
}

947 
	$°¨tSavögDñèIndex
(c⁄° 
DñèIndex
 *
dñèIndex
,

948 
z⁄eNumbî
,

949 
Buf„ªdWrôî
 *
buf„ªdWrôî
)

951 
DñèMem‹y
 *
dñèZ⁄e
 = &
dñèIndex
->
dñèZ⁄es
[
z⁄eNumbî
];

952 
di_hódî
 
hódî
;

953 
	`mem˝y
(
hódî
.
magic
, 
MAGIC_DI_START
, 
MAGIC_SIZE
);

954 
hódî
.
z⁄eNumbî
 = zoneNumber;

955 
hódî
.
numZ⁄es
 = 
dñèIndex
->numZones;

956 
hódî
.
fú°Li°
 = 
dñèZ⁄e
->firstList;

957 
hódî
.
numLi°s
 = 
dñèZ⁄e
->numLists;

958 
hódî
.
ªc‹dCou¡
 = 
dñèZ⁄e
->recordCount;

959 
hódî
.
cﬁlisi⁄Cou¡
 = 
dñèZ⁄e
->collisionCount;

961 
ªsu…
 = 
	`wrôeToBuf„ªdWrôî
(
buf„ªdWrôî
, (c⁄° 
byã
 *Ë&
hódî
,

962 (
hódî
));

963 i‡(
ªsu…
 !
UDS_SUCCESS
) {

964  
	`logW¨nögWôhSåögEº‹
(
ªsu…
,

968 
i
 = 0; i < 
dñèZ⁄e
->
numLi°s
; i++) {

969 
uöt16_t
 
dñèLi°Size
 = 
	`gëDñèLi°Size
(&
dñèZ⁄e
->
dñèLi°s
[
i
 + 1]);

970 
ªsu…
 = 
	`wrôeToBuf„ªdWrôî
(
buf„ªdWrôî
,

971 (c⁄° 
byã
 *Ë&
dñèLi°Size
,

972 (
dñèLi°Size
));

973 i‡(
ªsu…
 !
UDS_SUCCESS
) {

974  
	`logW¨nögWôhSåögEº‹
(
ªsu…
,

979 
	`°¨tSavögDñèMem‹y
(
dñèZ⁄e
, 
buf„ªdWrôî
);

980  
UDS_SUCCESS
;

981 
	}
}

984 
boﬁ
 
	$isSavögDñèIndexD⁄e
(c⁄° 
DñèIndex
 *
dñèIndex
,

985 
z⁄eNumbî
)

987  
	`¨eDñèMem‹yTøns„rsD⁄e
(&
dñèIndex
->
dñèZ⁄es
[
z⁄eNumbî
]);

988 
	}
}

991 
	$föishSavögDñèIndex
(c⁄° 
DñèIndex
 *
dñèIndex
,

992 
z⁄eNumbî
)

994  
	`föishSavögDñèMem‹y
(&
dñèIndex
->
dñèZ⁄es
[
z⁄eNumbî
]);

995 
	}
}

998 
	$ab‹tSavögDñèIndex
(c⁄° 
DñèIndex
 *
dñèIndex
,

999 
z⁄eNumbî
)

1001 
	`ab‹tSavögDñèMem‹y
(&
dñèIndex
->
dñèZ⁄es
[
z⁄eNumbî
]);

1002  
UDS_SUCCESS
;

1003 
	}
}

1006 
size_t
 
	$compuãDñèIndexSaveByãs
(
numLi°s
, 
size_t
 
mem‹ySize
)

1010 
size_t
 
maxMemSize
 = 
mem‹ySize
;

1011 
numZ⁄es
 = 1;ÇumZ⁄e†<
MAX_ZONES
;ÇumZones++) {

1012 
size_t
 
memSize
 = 
	`gëZ⁄eMem‹ySize
(
numZ⁄es
, 
mem‹ySize
);

1013 i‡(
memSize
 > 
maxMemSize
) {

1014 
maxMemSize
 = 
memSize
;

1018  ((
di_hódî
)

1021 + 
numLi°s
 * ((
DñèLi°SaveInfo
) + 1)

1023 + 
maxMemSize
);

1024 
	}
}

1027 
	$vÆid©eDñèIndex
(c⁄° 
DñèIndex
 *
dñèIndex
)

1029 
z
 = 0; z < 
dñèIndex
->
numZ⁄es
; z++) {

1030 
ªsu…
 = 
	`vÆid©eDñèLi°s
(&
dñèIndex
->
dñèZ⁄es
[
z
]);

1031 i‡(
ªsu…
 !
UDS_SUCCESS
) {

1032  
ªsu…
;

1035  
UDS_SUCCESS
;

1036 
	}
}

1039 
	$as£πNŸAtEnd
(c⁄° 
DñèIndexE¡ry
 *
dñèE¡ry
, 
îr‹Code
)

1041  
	`ASSERT_WITH_ERROR_CODE
(!
dñèE¡ry
->
©End
, 
îr‹Code
,

1044 
	}
}

1047 
	$¥e„tchDñèLi°
(c⁄° 
DñèMem‹y
 *
dñèZ⁄e
,

1048 c⁄° 
DñèLi°
 *
dñèLi°
)

1050 c⁄° 
byã
 *
mem‹y
 = 
dñèZ⁄e
->memory;

1051 c⁄° 
byã
 *
addr
 = &
mem‹y
[
	`gëDñèLi°Sèπ
(
dñèLi°
Ë/ 
CHAR_BIT
];

1052 
size
 = 
	`gëDñèLi°Size
(
dñèLi°
Ë/ 
CHAR_BIT
;

1053 
	`¥e„tchR™ge
(
addr
, 
size
, 
Ál£
);

1054 
	}
}

1057 
	$°¨tDñèIndexSórch
(c⁄° 
DñèIndex
 *
dñèIndex
,

1058 
li°Numbî
, 
key
,

1059 
boﬁ
 
ªadO∆y
, 
DñèIndexE¡ry
 *
dñèE¡ry
)

1061 
ªsu…


1062 
	`ASSERT_WITH_ERROR_CODE
((
li°Numbî
 < 
dñèIndex
->
numLi°s
),

1063 
UDS_CORRUPT_DATA
,

1065 
li°Numbî
, 
dñèIndex
->
numLi°s
);

1066 i‡(
ªsu…
 !
UDS_SUCCESS
) {

1067  
ªsu…
;

1070 
z⁄eNumbî
 = 
	`gëDñèIndexZ⁄e
(
dñèIndex
, 
li°Numbî
);

1071 
DñèMem‹y
 *
dñèZ⁄e
 = &
dñèIndex
->
dñèZ⁄es
[
z⁄eNumbî
];

1072 
li°Numbî
 -
dñèZ⁄e
->
fú°Li°
;

1073 
ªsu…
 = 
	`ASSERT_WITH_ERROR_CODE
((
li°Numbî
 < 
dñèZ⁄e
->
numLi°s
),

1074 
UDS_CORRUPT_DATA
,

1077 
li°Numbî
, 
dñèZ⁄e
->
numLi°s
, 
z⁄eNumbî
);

1078 i‡(
ªsu…
 !
UDS_SUCCESS
) {

1079  
ªsu…
;

1082 
DñèLi°
 *
dñèLi°
;

1083 i‡(
dñèIndex
->
isMuèbÀ
) {

1084 
dñèLi°
 = &
dñèZ⁄e
->
dñèLi°s
[
li°Numbî
 + 1];

1085 i‡(!
ªadO∆y
) {

1087 
	`œzyFlushDñèLi°
(
dñèZ⁄e
, 
li°Numbî
);

1092 
dñèLi°
 = &
dñèE¡ry
->
ãmpDñèLi°
;

1093 
dñèLi°
->
°¨tOff£t
 = 
	`gëImmuèbÀSèπ
(
dñèZ⁄e
->
mem‹y
, 
li°Numbî
);

1094 
ídOff£t
 = 
	`gëImmuèbÀSèπ
(
dñèZ⁄e
->
mem‹y
,

1095 
li°Numbî
 + 1);

1096 
dñèLi°
->
size
 = 
ídOff£t
 - dñèLi°->
°¨tOff£t
;

1097 
dñèLi°
->
ßveKey
 = 0;

1098 
dñèLi°
->
ßveOff£t
 = 0;

1101 i‡(
key
 > 
dñèLi°
->
ßveKey
) {

1102 
dñèE¡ry
->
key
 = 
dñèLi°
->
ßveKey
;

1103 
dñèE¡ry
->
off£t
 = 
dñèLi°
->
ßveOff£t
;

1105 
dñèE¡ry
->
key
 = 0;

1106 
dñèE¡ry
->
off£t
 = 0;

1107 i‡(
key
 == 0) {

1110 
	`¥e„tchDñèLi°
(
dñèZ⁄e
, 
dñèLi°
);

1114 
dñèE¡ry
->
©End
 = 
Ál£
;

1115 
dñèE¡ry
->
dñèZ⁄e
 = deltaZone;

1116 
dñèE¡ry
->
dñèLi°
 = deltaList;

1117 
dñèE¡ry
->
íåyBôs
 = 0;

1118 
dñèE¡ry
->
isCﬁlisi⁄
 = 
Ál£
;

1119 
dñèE¡ry
->
li°Numbî
 =ÜistNumber;

1120 
dñèE¡ry
->
li°OvîÊow
 = 
Ál£
;

1121 
dñèE¡ry
->
vÆueBôs
 = 
dñèZ⁄e
->valueBits;

1122  
UDS_SUCCESS
;

1123 
	}
}

1126 
__©åibuã__
((
__noölöe__
))

1127 
	$√xtDñèIndexE¡ry
(
DñèIndexE¡ry
 *
dñèE¡ry
)

1129 
ªsu…
 = 
	`as£πNŸAtEnd
(
dñèE¡ry
, 
UDS_BAD_STATE
);

1130 i‡(
ªsu…
 !
UDS_SUCCESS
) {

1131  
ªsu…
;

1134 c⁄° 
DñèLi°
 *
dñèLi°
 = 
dñèE¡ry
->deltaList;

1135 
dñèE¡ry
->
off£t
 +dñèE¡ry->
íåyBôs
;

1136 
size
 = 
	`gëDñèLi°Size
(
dñèLi°
);

1137 i‡(
	`u∆ikñy
(
dñèE¡ry
->
off£t
 >
size
)) {

1138 
dñèE¡ry
->
©End
 = 
åue
;

1139 
dñèE¡ry
->
dñè
 = 0;

1140 
dñèE¡ry
->
isCﬁlisi⁄
 = 
Ál£
;

1141  
	`ASSERT_WITH_ERROR_CODE
((
dñèE¡ry
->
off£t
 =
size
),

1142 
UDS_CORRUPT_DATA
,

1146 
	`decodeDñè
(
dñèE¡ry
);

1148 
√xtOff£t
 = 
dñèE¡ry
->
off£t
 + dñèE¡ry->
íåyBôs
;

1149 i‡(
√xtOff£t
 > 
size
) {

1152 
	`logW¨nög
("DecodedÖastÅheÉnd ofÅhe deltaÜist");

1153  
UDS_CORRUPT_DATA
;

1155  
UDS_SUCCESS
;

1156 
	}
}

1159 
ölöe
 
	$ªmembîDñèIndexOff£t
(c⁄° 
DñèIndexE¡ry
 *
dñèE¡ry
)

1161 
ªsu…
 = 
	`ASSERT
(!
dñèE¡ry
->
isCﬁlisi⁄
, "entry isÇotá collision");

1162 i‡(
ªsu…
 !
UDS_SUCCESS
) {

1163  
ªsu…
;

1166 
DñèLi°
 *
dñèLi°
 = 
dñèE¡ry
->deltaList;

1167 
dñèLi°
->
ßveKey
 = 
dñèE¡ry
->
key
 - dñèE¡ry->
dñè
;

1168 
dñèLi°
->
ßveOff£t
 = 
dñèE¡ry
->
off£t
;

1169  
UDS_SUCCESS
;

1170 
	}
}

1173 
	$gëDñèIndexE¡ry
(c⁄° 
DñèIndex
 *
dñèIndex
, 
li°Numbî
,

1174 
key
, c⁄° 
byã
 *
«me
, 
boﬁ
 
ªadO∆y
,

1175 
DñèIndexE¡ry
 *
dñèE¡ry
)

1177 
ªsu…
 = 
	`°¨tDñèIndexSórch
(
dñèIndex
, 
li°Numbî
, 
key
, 
ªadO∆y
,

1178 
dñèE¡ry
);

1179 i‡(
ªsu…
 !
UDS_SUCCESS
) {

1180  
ªsu…
;

1183 
ªsu…
 = 
	`√xtDñèIndexE¡ry
(
dñèE¡ry
);

1184 i‡(
ªsu…
 !
UDS_SUCCESS
) {

1185  
ªsu…
;

1187 } !
dñèE¡ry
->
©End
 && (
key
 > deltaEntry->key));

1189 
ªsu…
 = 
	`ªmembîDñèIndexOff£t
(
dñèE¡ry
);

1190 i‡(
ªsu…
 !
UDS_SUCCESS
) {

1191  
ªsu…
;

1194 i‡(!
dñèE¡ry
->
©End
 && (
key
 == deltaEntry->key)) {

1195 
DñèIndexE¡ry
 
cﬁlisi⁄E¡ry
;

1196 
cﬁlisi⁄E¡ry
 = *
dñèE¡ry
;

1198 
ªsu…
 = 
	`√xtDñèIndexE¡ry
(&
cﬁlisi⁄E¡ry
);

1199 i‡(
ªsu…
 !
UDS_SUCCESS
) {

1200  
ªsu…
;

1202 i‡(
cﬁlisi⁄E¡ry
.
©End
 || !cﬁlisi⁄E¡ry.
isCﬁlisi⁄
) {

1205 
byã
 
cﬁlisi⁄Name
[
COLLISION_BYTES
];

1206 
	`gëByãs
(
dñèE¡ry
->
dñèZ⁄e
->
mem‹y
,

1207 
	`gëCﬁlisi⁄Off£t
(&
cﬁlisi⁄E¡ry
), 
cﬁlisi⁄Name
,

1208 
COLLISION_BYTES
);

1209 i‡(
	`memcmp
(
cﬁlisi⁄Name
, 
«me
, 
COLLISION_BYTES
) == 0) {

1210 *
dñèE¡ry
 = 
cﬁlisi⁄E¡ry
;

1215  
UDS_SUCCESS
;

1216 
	}
}

1219 
	$gëDñèE¡ryCﬁlisi⁄
(c⁄° 
DñèIndexE¡ry
 *
dñèE¡ry
, 
byã
 *
«me
)

1221 
ªsu…
 = 
	`as£πNŸAtEnd
(
dñèE¡ry
, 
UDS_BAD_STATE
);

1222 i‡(
ªsu…
 !
UDS_SUCCESS
) {

1223  
ªsu…
;

1225 
ªsu…
 = 
	`ASSERT_WITH_ERROR_CODE
(
dñèE¡ry
->
isCﬁlisi⁄
, 
UDS_BAD_STATE
,

1228 i‡(
ªsu…
 !
UDS_SUCCESS
) {

1229  
ªsu…
;

1232 
	`gëByãs
(
dñèE¡ry
->
dñèZ⁄e
->
mem‹y
, 
	`gëCﬁlisi⁄Off£t
(deltaEntry),

1233 
«me
, 
COLLISION_BYTES
);

1234  
UDS_SUCCESS
;

1235 
	}
}

1238 
	$as£πMuèbÀE¡ry
(c⁄° 
DñèIndexE¡ry
 *
dñèE¡ry
)

1240  
	`ASSERT_WITH_ERROR_CODE
(
dñèE¡ry
->
dñèLi°


1241 !&
dñèE¡ry
->
ãmpDñèLi°
,

1242 
UDS_BAD_STATE
,

1244 
	}
}

1247 
	$£tDñèE¡ryVÆue
(c⁄° 
DñèIndexE¡ry
 *
dñèE¡ry
, 
vÆue
)

1249 
ªsu…
 = 
	`as£πMuèbÀE¡ry
(
dñèE¡ry
);

1250 i‡(
ªsu…
 !
UDS_SUCCESS
) {

1251  
ªsu…
;

1253 
ªsu…
 = 
	`as£πNŸAtEnd
(
dñèE¡ry
, 
UDS_BAD_STATE
);

1254 i‡(
ªsu…
 !
UDS_SUCCESS
) {

1255  
ªsu…
;

1258 
ªsu…
 = 
	`ASSERT_WITH_ERROR_CODE
(((
vÆue
 & ((1 << 
dñèE¡ry
->
vÆueBôs
) - 1))

1259 =
vÆue
), 
UDS_INVALID_ARGUMENT
,

1262 
vÆue
, 
dñèE¡ry
->
vÆueBôs
);

1263 i‡(
ªsu…
 !
UDS_SUCCESS
) {

1264  
ªsu…
;

1267 
	`£tFõld
(
vÆue
, 
dñèE¡ry
->
dñèZ⁄e
->
mem‹y
,

1268 
	`gëDñèE¡ryOff£t
(
dñèE¡ry
), dñèE¡ry->
vÆueBôs
);

1269  
UDS_SUCCESS
;

1270 
	}
}

1273 
	$putDñèIndexE¡ry
(
DñèIndexE¡ry
 *
dñèE¡ry
, 
key
,

1274 
vÆue
, c⁄° 
byã
 *
«me
)

1276 
ªsu…
 = 
	`as£πMuèbÀE¡ry
(
dñèE¡ry
);

1277 i‡(
ªsu…
 !
UDS_SUCCESS
) {

1278  
ªsu…
;

1280 i‡(
dñèE¡ry
->
isCﬁlisi⁄
) {

1288  
UDS_DUPLICATE_NAME
;

1291 i‡(
dñèE¡ry
->
off£t
 < dñèE¡ry->
dñèLi°
->
ßveOff£t
) {

1294 
ªsu…
 = 
	`ªmembîDñèIndexOff£t
(
dñèE¡ry
);

1295 i‡(
ªsu…
 !
UDS_SUCCESS
) {

1296  
ªsu…
;

1300 i‡(
«me
 !
NULL
) {

1302 
ªsu…
 = 
	`as£πNŸAtEnd
(
dñèE¡ry
, 
UDS_BAD_STATE
);

1303 i‡(
ªsu…
 !
UDS_SUCCESS
) {

1304  
ªsu…
;

1306 
ªsu…
 = 
	`ASSERT
((
key
 =
dñèE¡ry
->key),

1308 i‡(
ªsu…
 !
UDS_SUCCESS
) {

1309  
ªsu…
;

1312 
dñèE¡ry
->
off£t
 +dñèE¡ry->
íåyBôs
;

1313 
	`£tDñè
(
dñèE¡ry
, 0);

1314 
	`£tCﬁlisi⁄
(
dñèE¡ry
);

1315 
ªsu…
 = 
	`ö£πBôs
(
dñèE¡ry
, dñèE¡ry->
íåyBôs
);

1316 } i‡(
dñèE¡ry
->
©End
) {

1318 
ªsu…
 = 
	`ASSERT
((
key
 >
dñèE¡ry
->key), "keyÖastÉnd ofÜist");

1319 i‡(
ªsu…
 !
UDS_SUCCESS
) {

1320  
ªsu…
;

1323 
	`£tDñè
(
dñèE¡ry
, 
key
 - deltaEntry->key);

1324 
dñèE¡ry
->
key
 = key;

1325 
dñèE¡ry
->
©End
 = 
Ál£
;

1326 
ªsu…
 = 
	`ö£πBôs
(
dñèE¡ry
, dñèE¡ry->
íåyBôs
);

1330 
ªsu…
 = 
	`ASSERT
((
key
 < 
dñèE¡ry
->key), "keyÖrecedes followingÉntry");

1331 i‡(
ªsu…
 !
UDS_SUCCESS
) {

1332  
ªsu…
;

1334 
ªsu…
 = 
	`ASSERT
((
key
 >
dñèE¡ry
->key - dñèE¡ry->
dñè
),

1336 i‡(
ªsu…
 !
UDS_SUCCESS
) {

1337  
ªsu…
;

1340 
ﬁdE¡rySize
 = 
dñèE¡ry
->
íåyBôs
;

1341 
DñèIndexE¡ry
 
√xtE¡ry
 = *
dñèE¡ry
;

1342 
√xtVÆue
 = 
	`gëDñèE¡ryVÆue
(&
√xtE¡ry
);

1343 
	`£tDñè
(
dñèE¡ry
, 
key
 - (dñèE¡ry->key - dñèE¡ry->
dñè
));

1344 
dñèE¡ry
->
key
 = key;

1345 
	`£tDñè
(&
√xtE¡ry
,ÇextE¡ry.
key
 - key);

1346 
√xtE¡ry
.
off£t
 +
dñèE¡ry
->
íåyBôs
;

1348 
addôi⁄ÆSize


1349 
dñèE¡ry
->
íåyBôs
 + 
√xtE¡ry
.íåyBô†- 
ﬁdE¡rySize
;

1350 
ªsu…
 = 
	`ö£πBôs
(
dñèE¡ry
, 
addôi⁄ÆSize
);

1351 i‡(
ªsu…
 !
UDS_SUCCESS
) {

1352  
ªsu…
;

1354 
	`ícodeE¡ry
(&
√xtE¡ry
, 
√xtVÆue
, 
NULL
);

1356 i‡(
ªsu…
 !
UDS_SUCCESS
) {

1357  
ªsu…
;

1359 
	`ícodeE¡ry
(
dñèE¡ry
, 
vÆue
, 
«me
);

1361 
DñèMem‹y
 *
dñèZ⁄e
 = 
dñèE¡ry
->deltaZone;

1362 
dñèZ⁄e
->
ªc‹dCou¡
++;

1363 
dñèZ⁄e
->
cﬁlisi⁄Cou¡
 +
dñèE¡ry
->
isCﬁlisi⁄
 ? 1 : 0;

1364  
UDS_SUCCESS
;

1365 
	}
}

1368 
	$ªmoveDñèIndexE¡ry
(
DñèIndexE¡ry
 *
dñèE¡ry
)

1370 
ªsu…
 = 
	`as£πMuèbÀE¡ry
(
dñèE¡ry
);

1371 i‡(
ªsu…
 !
UDS_SUCCESS
) {

1372  
ªsu…
;

1375 
DñèIndexE¡ry
 
√xtE¡ry
 = *
dñèE¡ry
;

1376 
ªsu…
 = 
	`√xtDñèIndexE¡ry
(&
√xtE¡ry
);

1377 i‡(
ªsu…
 !
UDS_SUCCESS
) {

1378  
ªsu…
;

1381 
DñèMem‹y
 *
dñèZ⁄e
 = 
dñèE¡ry
->deltaZone;

1383 i‡(
dñèE¡ry
->
isCﬁlisi⁄
) {

1385 
	`dñëeBôs
(
dñèE¡ry
, dñèE¡ry->
íåyBôs
);

1386 
√xtE¡ry
.
off£t
 = 
dñèE¡ry
->offset;

1387 
dñèZ⁄e
->
cﬁlisi⁄Cou¡
 -= 1;

1388 } i‡(
√xtE¡ry
.
©End
) {

1390 
	`dñëeBôs
(
dñèE¡ry
, dñèE¡ry->
íåyBôs
);

1391 
√xtE¡ry
.
key
 -
dñèE¡ry
->
dñè
;

1392 
√xtE¡ry
.
off£t
 = 
dñèE¡ry
->offset;

1395 
√xtVÆue
 = 
	`gëDñèE¡ryVÆue
(&
√xtE¡ry
);

1396 
ﬁdSize
 = 
dñèE¡ry
->
íåyBôs
 + 
√xtE¡ry
.entryBits;

1397 i‡(
√xtE¡ry
.
isCﬁlisi⁄
) {

1400 
√xtE¡ry
.
isCﬁlisi⁄
 = 
Ál£
;

1401 
dñèZ⁄e
->
cﬁlisi⁄Cou¡
 -= 1;

1403 
	`£tDñè
(&
√xtE¡ry
, 
dñèE¡ry
->
dñè
 +ÇextEntry.delta);

1404 
√xtE¡ry
.
off£t
 = 
dñèE¡ry
->offset;

1406 
	`dñëeBôs
(
dñèE¡ry
, 
ﬁdSize
 - 
√xtE¡ry
.
íåyBôs
);

1407 
	`ícodeE¡ry
(&
√xtE¡ry
, 
√xtVÆue
, 
NULL
);

1409 
dñèZ⁄e
->
ªc‹dCou¡
--;

1410 
dñèZ⁄e
->
disˇrdCou¡
++;

1411 *
dñèE¡ry
 = 
√xtE¡ry
;

1413 
DñèLi°
 *
dñèLi°
 = 
dñèE¡ry
->deltaList;

1414 i‡(
dñèE¡ry
->
off£t
 < 
dñèLi°
->
ßveOff£t
) {

1418 
dñèLi°
->
ßveKey
 = 0;

1419 
dñèLi°
->
ßveOff£t
 = 0;

1421  
UDS_SUCCESS
;

1422 
	}
}

1425 
	$gëDñèIndexZ⁄eFú°Li°
(c⁄° 
DñèIndex
 *
dñèIndex
,

1426 
z⁄eNumbî
)

1428  
dñèIndex
->
dñèZ⁄es
[
z⁄eNumbî
].
fú°Li°
;

1429 
	}
}

1432 
	$gëDñèIndexZ⁄eNumLi°s
(c⁄° 
DñèIndex
 *
dñèIndex
,

1433 
z⁄eNumbî
)

1435  
dñèIndex
->
dñèZ⁄es
[
z⁄eNumbî
].
numLi°s
;

1436 
	}
}

1439 
uöt64_t
 
	$gëDñèIndexZ⁄eDli°BôsU£d
(c⁄° 
DñèIndex
 *
dñèIndex
,

1440 
z⁄eNumbî
)

1442 
uöt64_t
 
bôCou¡
 = 0;

1443 c⁄° 
DñèMem‹y
 *
dñèZ⁄e
 = &
dñèIndex
->
dñèZ⁄es
[
z⁄eNumbî
];

1444 
i
 = 0; i < 
dñèZ⁄e
->
numLi°s
; i++) {

1445 
bôCou¡
 +
	`gëDñèLi°Size
(&
dñèZ⁄e
->
dñèLi°s
[
i
 + 1]);

1447  
bôCou¡
;

1448 
	}
}

1451 
uöt64_t
 
	$gëDñèIndexDli°BôsU£d
(c⁄° 
DñèIndex
 *
dñèIndex
)

1453 
uöt64_t
 
bôCou¡
 = 0;

1454 
z
 = 0; z < 
dñèIndex
->
numZ⁄es
; z++) {

1455 
bôCou¡
 +
	`gëDñèIndexZ⁄eDli°BôsU£d
(
dñèIndex
, 
z
);

1457  
bôCou¡
;

1458 
	}
}

1461 
uöt64_t
 
	$gëDñèIndexDli°BôsAŒoˇãd
(c⁄° 
DñèIndex
 *
dñèIndex
)

1463 
uöt64_t
 
byãCou¡
 = 0;

1464 
z
 = 0; z < 
dñèIndex
->
numZ⁄es
; z++) {

1465 c⁄° 
DñèMem‹y
 *
dñèZ⁄e
 = &
dñèIndex
->
dñèZ⁄es
[
z
];

1466 
byãCou¡
 +
dñèZ⁄e
->
size
;

1468  
byãCou¡
 * 
CHAR_BIT
;

1469 
	}
}

1472 
	$gëDñèIndexSèts
(c⁄° 
DñèIndex
 *
dñèIndex
, 
DñèIndexSèts
 *
°©s
)

1474 
	`mem£t
(
°©s
, 0, (
DñèIndexSèts
));

1475 
°©s
->
mem‹yAŒoˇãd
 = 
dñèIndex
->
numZ⁄es
 * (
DñèMem‹y
);

1476 
z
 = 0; z < 
dñèIndex
->
numZ⁄es
; z++) {

1477 c⁄° 
DñèMem‹y
 *
dñèZ⁄e
 = &
dñèIndex
->
dñèZ⁄es
[
z
];

1478 
°©s
->
mem‹yAŒoˇãd
 +
	`gëDñèMem‹yAŒoˇãd
(
dñèZ⁄e
);

1479 
°©s
->
ªbÆ™˚Time
 +
dñèZ⁄e
->rebalanceTime;

1480 
°©s
->
ªbÆ™˚Cou¡
 +
dñèZ⁄e
->rebalanceCount;

1481 
°©s
->
ªc‹dCou¡
 +
dñèZ⁄e
->recordCount;

1482 
°©s
->
cﬁlisi⁄Cou¡
 +
dñèZ⁄e
->collisionCount;

1483 
°©s
->
disˇrdCou¡
 +
dñèZ⁄e
->discardCount;

1484 
°©s
->
ovîÊowCou¡
 +
dñèZ⁄e
->overflowCount;

1485 
°©s
->
numLi°s
 +
dñèZ⁄e
->numLists;

1487 
	}
}

1490 
uöt64_t
 
	$gëDñèIndexVútuÆCh≠ãrNumbî
(c⁄° 
DñèIndex
 *
dñèIndex
)

1492 c⁄° 
DñèPageHódî
 *
hódî


1493 (c⁄° 
DñèPageHódî
 *Ë
dñèIndex
->
dñèZ⁄es
[0].
mem‹y
;

1494  
hódî
->
vútuÆCh≠ãrNumbî
;

1495 
	}
}

1498 
	$gëDñèIndexLowe°Li°Numbî
(c⁄° 
DñèIndex
 *
dñèIndex
)

1500 c⁄° 
DñèMem‹y
 *
dñèZ⁄e
 = &
dñèIndex
->
dñèZ⁄es
[0];

1501  (
dñèIndex
->
isMuèbÀ


1502 ? 
dñèZ⁄e
->
fú°Li°


1503 : ((
DñèPageHódî
 *Ë
dñèZ⁄e
->
mem‹y
)->
fú°Li°
);

1504 
	}
}

1507 
	$gëDñèIndexHighe°Li°Numbî
(c⁄° 
DñèIndex
 *
dñèIndex
)

1509  
	`gëDñèIndexLowe°Li°Numbî
(
dñèIndex
Ë+ dñèIndex->
numLi°s
 - 1;

1510 
	}
}

1513 
	$gëDñèIndexPageCou¡
(
numE¡rõs
,

1514 
numLi°s
,

1515 
mónDñè
,

1516 
numPaylﬂdBôs
,

1517 
size_t
 
byãsPîPage
)

1520 
size_t
 
bôsPîIndex


1521 
	`gëDñèMem‹ySize
(
numE¡rõs
, 
mónDñè
, 
numPaylﬂdBôs
);

1523 
bôsPîDñèLi°
 = 
bôsPîIndex
 / 
numLi°s
;

1525 
bôsPîIndex
 +
numLi°s
 * 
IMMUTABLE_HEADER_SIZE
;

1527 
bôsPîPage


1528 (
byãsPîPage
 - (
DñèPageHódî
)Ë* 
CHAR_BIT
;

1531 
bôsPîPage
 -
IMMUTABLE_HEADER_SIZE
 + 
bôsPîDñèLi°
;

1533  (
bôsPîIndex
 + 
bôsPîPage
 - 1) / bitsPerPage;

1534 
	}
}

1537 
	$logDñèIndexE¡ry
(
DñèIndexE¡ry
 *
dñèE¡ry
)

1539 
	`logInfo
("List 0x%X Key 0x%X Offset 0x%X%s%s ListSize 0x%X%s",

1540 
dñèE¡ry
->
li°Numbî
, dñèE¡ry->
key
, dñèE¡ry->
off£t
,

1541 
dñèE¡ry
->
©End
 ? "Énd" : "",

1542 
dñèE¡ry
->
isCﬁlisi⁄
 ? " collision" : "",

1543 
	`gëDñèLi°Size
(
dñèE¡ry
->
dñèLi°
),

1544 
dñèE¡ry
->
li°OvîÊow
 ? " overflow" : "");

1545 
dñèE¡ry
->
li°OvîÊow
 = 
Ál£
;

1546 
	}
}

	@uds/deltaIndex.h

22 #i‚de‡
DELTAINDEX_H


23 
	#DELTAINDEX_H
 1

	)

25 
	~"compûî.h
"

26 
	~"dñèMem‹y.h
"

30 
	mCOLLISION_BYTES
 = 
UDS_CHUNK_NAME_SIZE
,

31 
	mCOLLISION_BITS
 = 
COLLISION_BYTES
 * 
CHAR_BIT


34 
	sdñèIndex
 {

35 
DñèMem‹y
 *
	mdñèZ⁄es
;

36 
	mnumZ⁄es
;

37 
	mnumLi°s
;

38 
	mli°sPîZ⁄e
;

39 
boﬁ
 
	misMuèbÀ
;

40 
byã
 
	mèg
;

41 } 
	tDñèIndex
;

74 
	sdñèIndexE¡ry
 {

76 
	mkey
;

77 
boﬁ
 
	m©End
;

78 
boﬁ
 
	misCﬁlisi⁄
;

80 
boﬁ
 
	mli°OvîÊow
;

81 
	mvÆueBôs
;

82 
	míåyBôs
;

83 
DñèMem‹y
 *
	mdñèZ⁄e
;

84 
DñèLi°
 *
	mdñèLi°
;

85 
	mli°Numbî
;

86 
uöt32_t
 
	moff£t
;

87 
	mdñè
;

88 
DñèLi°
 
	mãmpDñèLi°
;

89 } 
	tDñèIndexE¡ry
;

92 
size_t
 
	mmem‹yAŒoˇãd
;

93 
RñTime
 
	mªbÆ™˚Time
;

94 
	mªbÆ™˚Cou¡
;

95 
	mªc‹dCou¡
;

96 
	mcﬁlisi⁄Cou¡
;

97 
	mdisˇrdCou¡
;

98 
	movîÊowCou¡
;

99 
	mnumLi°s
;

100 } 
	tDñèIndexSèts
;

114 
	$öôülizeDñèIndex
(
DñèIndex
 *
dñèIndex
, 
numZ⁄es
,

115 
numLi°s
, 
mónDñè
,

116 
numPaylﬂdBôs
, 
size_t
 
mem‹ySize
)

117 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

132 
	$öôülizeDñèIndexPage
(
DñèIndex
 *
dñèIndex
, 
DñèMem‹y
 *
dñèMem‹y
,

133 
uöt64_t
 
ex≥˘edN⁄˚
, 
mónDñè
,

134 
numPaylﬂdBôs
, 
byã
 *
mem‹y
,

135 
size_t
 
memSize
)

136 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

143 
	`unöôülizeDñèIndex
(
DñèIndex
 *
dñèIndex
);

150 
	`em±yDñèIndex
(c⁄° 
DñèIndex
 *
dñèIndex
);

158 
	`em±yDñèIndexZ⁄e
(c⁄° 
DñèIndex
 *
dñèIndex
,

159 
z⁄eNumbî
);

179 
	$∑ckDñèIndexPage
(c⁄° 
DñèIndex
 *
dñèIndex
, 
uöt64_t
 
hódîN⁄˚
,

180 
byã
 *
mem‹y
, 
size_t
 
memSize
,

181 
uöt64_t
 
vútuÆCh≠ãrNumbî
, 
fú°Li°
,

182 *
numLi°s
)

183 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

191 
	`£tDñèIndexTag
(
DñèIndex
 *
dñèIndex
, 
byã
 
èg
);

202 
	$°¨tRe°‹ögDñèIndex
(c⁄° 
DñèIndex
 *
dñèIndex
,

203 
Buf„ªdRódî
 **
buf„ªdRódîs
, 
numRódîs
)

204 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

214 
boﬁ
 
	`isRe°‹ögDñèIndexD⁄e
(c⁄° 
DñèIndex
 *
dñèIndex
);

225 
	$ª°‹eDñèLi°ToDñèIndex
(c⁄° 
DñèIndex
 *
dñèIndex
,

226 c⁄° 
DñèLi°SaveInfo
 *
dlsi
,

227 c⁄° 
byã
 
d©a
[
DELTA_LIST_MAX_BYTE_COUNT
])

228 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

235 
	`ab‹tRe°‹ögDñèIndex
(c⁄° 
DñèIndex
 *
dñèIndex
);

246 
	$°¨tSavögDñèIndex
(c⁄° 
DñèIndex
 *
dñèIndex
,

247 
z⁄eNumbî
,

248 
Buf„ªdWrôî
 *
buf„ªdWrôî
)

249 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

261 
boﬁ
 
	`isSavögDñèIndexD⁄e
(c⁄° 
DñèIndex
 *
dñèIndex
,

262 
z⁄eNumbî
);

274 
	$föishSavögDñèIndex
(c⁄° 
DñèIndex
 *
dñèIndex
,

275 
z⁄eNumbî
)

276 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

287 
	$ab‹tSavögDñèIndex
(c⁄° 
DñèIndex
 *
dñèIndex
,

288 
z⁄eNumbî
)

289 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

299 
size_t
 
	$compuãDñèIndexSaveByãs
(
numLi°s
, 
size_t
 
mem‹ySize
)

300 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

309 
	$vÆid©eDñèIndex
(c⁄° 
DñèIndex
 *
dñèIndex
)

310 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

328 
	$°¨tDñèIndexSórch
(c⁄° 
DñèIndex
 *
dñèIndex
,

329 
li°Numbî
, 
key
,

330 
boﬁ
 
ªadO∆y
, 
DñèIndexE¡ry
 *
ôî©‹
)

331 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

341 
	$√xtDñèIndexE¡ry
(
DñèIndexE¡ry
 *
dñèE¡ry
)

342 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

355 
	$ªmembîDñèIndexOff£t
(c⁄° 
DñèIndexE¡ry
 *
dñèE¡ry
)

356 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

371 
	$gëDñèIndexE¡ry
(c⁄° 
DñèIndex
 *
dñèIndex
, 
li°Numbî
,

372 
key
, c⁄° 
byã
 *
«me
, 
boﬁ
 
ªadO∆y
,

373 
DñèIndexE¡ry
 *
dñèE¡ry
)

374 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

384 
	$gëDñèE¡ryCﬁlisi⁄
(c⁄° 
DñèIndexE¡ry
 *
dñèE¡ry
, 
byã
 *
«me
)

385 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

394 
INLINE
 
uöt64_t
 
	$gëDñèE¡ryOff£t
(c⁄° 
DñèIndexE¡ry
 *
dñèE¡ry
)

396  
	`gëDñèLi°Sèπ
(
dñèE¡ry
->
dñèLi°
Ë+ dñèE¡ry->
off£t
;

397 
	}
}

406 
INLINE
 
	$gëDñèE¡ryKeyBôs
(c⁄° 
DñèIndexE¡ry
 *
íåy
)

413  (
íåy
->
íåyBôs
 -É¡ry->
vÆueBôs


414 - (
íåy
->
isCﬁlisi⁄
 ? 
COLLISION_BITS
 : 0));

415 
	}
}

424 
INLINE
 
	$gëDñèE¡ryVÆue
(c⁄° 
DñèIndexE¡ry
 *
dñèE¡ry
)

426  
	`gëFõld
(
dñèE¡ry
->
dñèZ⁄e
->
mem‹y
,

427 
	`gëDñèE¡ryOff£t
(
dñèE¡ry
), dñèE¡ry->
vÆueBôs
);

428 
	}
}

438 
	$£tDñèE¡ryVÆue
(c⁄° 
DñèIndexE¡ry
 *
dñèE¡ry
, 
vÆue
)

439 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

456 
	$putDñèIndexE¡ry
(
DñèIndexE¡ry
 *
dñèE¡ry
, 
key
,

457 
vÆue
, c⁄° 
byã
 *
«me
)

458 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

469 
	$ªmoveDñèIndexE¡ry
(
DñèIndexE¡ry
 *
dñèE¡ry
)

470 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

480 
INLINE
 
	$gëDñèIndexZ⁄e
(c⁄° 
DñèIndex
 *
dñèIndex
,

481 
li°Numbî
)

483  
li°Numbî
 / 
dñèIndex
->
li°sPîZ⁄e
;

484 
	}
}

494 
gëDñèIndexZ⁄eFú°Li°
(c⁄° 
DñèIndex
 *
dñèIndex
,

495 
z⁄eNumbî
);

505 
gëDñèIndexZ⁄eNumLi°s
(c⁄° 
DñèIndex
 *
dñèIndex
,

506 
z⁄eNumbî
);

516 
uöt64_t
 
	$gëDñèIndexZ⁄eDli°BôsU£d
(c⁄° 
DñèIndex
 *
dñèIndex
,

517 
z⁄eNumbî
)

518 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

527 
uöt64_t
 
	$gëDñèIndexDli°BôsU£d
(c⁄° 
DñèIndex
 *
dñèIndex
)

528 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

537 
uöt64_t
 
	$gëDñèIndexDli°BôsAŒoˇãd
(c⁄° 
DñèIndex
 *
dñèIndex
)

538 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

546 
	`gëDñèIndexSèts
(c⁄° 
DñèIndex
 *
dñèIndex
, 
DñèIndexSèts
 *
°©s
);

555 
uöt64_t
 
	$gëDñèIndexVútuÆCh≠ãrNumbî
(c⁄° 
DñèIndex
 *
dñèIndex
)

556 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

565 
	$gëDñèIndexLowe°Li°Numbî
(c⁄° 
DñèIndex
 *
dñèIndex
)

566 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

575 
	$gëDñèIndexHighe°Li°Numbî
(c⁄° 
DñèIndex
 *
dñèIndex
)

576 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

589 
	`gëDñèIndexPageCou¡
(
numE¡rõs
,

590 
numLi°s
,

591 
mónDñè
,

592 
numPaylﬂdBôs
,

593 
size_t
 
byãsPîPage
);

600 
	`logDñèIndexE¡ry
(
DñèIndexE¡ry
 *
dñèE¡ry
);

	@uds/deltaMemory.c

21 
	~"dñèMem‹y.h
"

23 
	~"bôs.h
"

24 
	~"compûî.h
"

25 
	~"îr‹s.h
"

26 
	~"„©uªDefs.h
"

27 
	~"hashUtûs.h
"

28 
	~"loggî.h
"

29 
	~"mem‹yAŒoc.h
"

30 
	~"≥rmas£π.h
"

31 
	~"timeUtûs.h
"

32 
	~"ty≥Defs.h
"

33 
	~"uds.h
"

44 íum { 
	mGUARD_BITS
 = 
POST_FIELD_GUARD_BYTES
 * 
CHAR_BIT
 };

53 
INLINE
 
uöt64_t
 
	$gëDñèLi°ByãSèπ
(c⁄° 
DñèLi°
 *
dñèLi°
)

55  
	`gëDñèLi°Sèπ
(
dñèLi°
Ë/ 
CHAR_BIT
;

56 
	}
}

65 
INLINE
 
uöt16_t
 
	$gëDñèLi°ByãSize
(c⁄° 
DñèLi°
 *
dñèLi°
)

67 
uöt16_t
 
°¨tBôOff£t
 = 
	`gëDñèLi°Sèπ
(
dñèLi°
Ë% 
CHAR_BIT
;

68 
uöt16_t
 
bôSize
 = 
	`gëDñèLi°Size
(
dñèLi°
);

69  ((Ë
°¨tBôOff£t
 + 
bôSize
 + 
CHAR_BIT
 - 1) / CHAR_BIT;

70 
	}
}

79 
INLINE
 
size_t
 
	$gëSizeOfDñèLi°s
(
numLi°s
)

81  (
numLi°s
 + 2Ë* (
DñèLi°
);

82 
	}
}

92 
INLINE
 
size_t
 
	$gëSizeOfFœgs
(
numLi°s
)

94  (
numLi°s
 + 
CHAR_BIT
 - 1Ë/ CHAR_BIT + 
POST_FIELD_GUARD_BYTES
;

95 
	}
}

104 
INLINE
 
size_t
 
	$gëSizeOfTempOff£ts
(
numLi°s
)

106  (
numLi°s
 + 2Ë* (
uöt64_t
);

107 
	}
}

116 
	$˛órTøns„rFœgs
(
DñèMem‹y
 *
dñèMem‹y
)

118 
	`mem£t
(
dñèMem‹y
->
Êags
, 0, 
	`gëSizeOfFœgs
(dñèMem‹y->
numLi°s
));

119 
dñèMem‹y
->
numTøns„rs
 = 0;

120 
dñèMem‹y
->
å™s„rSètus
 = 
UDS_SUCCESS
;

121 
	}
}

131 
	$ÊagN⁄Em±yDñèLi°s
(
DñèMem‹y
 *
dñèMem‹y
)

133 
	`˛órTøns„rFœgs
(
dñèMem‹y
);

134 
i
 = 0; i < 
dñèMem‹y
->
numLi°s
; i++) {

135 i‡(
	`gëDñèLi°Size
(&
dñèMem‹y
->
dñèLi°s
[
i
 + 1]) > 0) {

136 
	`£tO√
(
dñèMem‹y
->
Êags
, 
i
, 1);

137 
dñèMem‹y
->
numTøns„rs
++;

140 
	}
}

143 
	$em±yDñèLi°s
(
DñèMem‹y
 *
dñèMem‹y
)

146 
DñèLi°
 *
dñèLi°s
 = 
dñèMem‹y
->deltaLists;

147 
	`mem£t
(
dñèLi°s
, 0, 
	`gëSizeOfDñèLi°s
(
dñèMem‹y
->
numLi°s
));

162 
uöt64_t
 
numBôs
 = (uöt64_tË
dñèMem‹y
->
size
 * 
CHAR_BIT
;

163 
dñèLi°s
[
dñèMem‹y
->
numLi°s
 + 1].
°¨tOff£t
 = 
numBôs
 - 
GUARD_BITS
;

164 
dñèLi°s
[
dñèMem‹y
->
numLi°s
 + 1].
size
 = 
GUARD_BITS
;

168 
	`mem£t
(
dñèMem‹y
->
mem‹y
 + dñèMem‹y->
size
 - 
POST_FIELD_GUARD_BYTES
,

169 ~0, 
POST_FIELD_GUARD_BYTES
);

173 
uöt64_t
 
•acög
 = (
numBôs
 - 
GUARD_BITS
Ë/ 
dñèMem‹y
->
numLi°s
;

174 
uöt64_t
 
off£t
 = 
•acög
 / 2;

175 
i
 = 1; i <
dñèMem‹y
->
numLi°s
; i++) {

176 
dñèLi°s
[
i
].
°¨tOff£t
 = 
off£t
;

177 
off£t
 +
•acög
;

181 
dñèMem‹y
->
disˇrdCou¡
 +dñèMem‹y->
ªc‹dCou¡
;

182 
dñèMem‹y
->
ªc‹dCou¡
 = 0;

183 
dñèMem‹y
->
cﬁlisi⁄Cou¡
 = 0;

184 
	}
}

193 
	$öôülizeCodögC⁄°™ts
(
DñèMem‹y
 *
dñèMem‹y
,

194 
mónDñè
)

198 
dñèMem‹y
->
ö¸Keys
 = (836158UL * 
mónDñè
 + 603160UL) / 1206321UL;

199 
dñèMem‹y
->
möBôs
 = 
	`compuãBôs
(dñèMem‹y->
ö¸Keys
 + 1);

200 
dñèMem‹y
->
möKeys
 = (1 << dñèMem‹y->
möBôs
Ë- dñèMem‹y->
ö¸Keys
;

201 
	}
}

211 
	$ªbÆ™˚DñèMem‹y
(c⁄° 
DñèMem‹y
 *
dñèMem‹y
,

212 
fú°
, 
œ°
)

214 i‡(
fú°
 =
œ°
) {

215 
DñèLi°
 *
dñèLi°
 = &
dñèMem‹y
->
dñèLi°s
[
fú°
];

216 
uöt64_t
 
√wSèπ
 = 
dñèMem‹y
->
ãmpOff£ts
[
fú°
];

218 i‡(
	`gëDñèLi°Sèπ
(
dñèLi°
Ë!
√wSèπ
) {

220 
uöt64_t
 
sour˚
 = 
	`gëDñèLi°ByãSèπ
(
dñèLi°
);

222 
dñèLi°
->
°¨tOff£t
 = 
√wSèπ
;

224 
uöt64_t
 
de°ö©i⁄
 = 
	`gëDñèLi°ByãSèπ
(
dñèLi°
);

225 
	`memmove
(
dñèMem‹y
->
mem‹y
 + 
de°ö©i⁄
, dñèMem‹y->mem‹y + 
sour˚
,

226 
	`gëDñèLi°ByãSize
(
dñèLi°
));

232 
middÀ
 = (
fú°
 + 
œ°
) / 2;

233 c⁄° 
DñèLi°
 *
dñèLi°
 = &
dñèMem‹y
->
dñèLi°s
[
middÀ
];

234 
uöt64_t
 
√wSèπ
 = 
dñèMem‹y
->
ãmpOff£ts
[
middÀ
];

237 i‡(
√wSèπ
 > 
	`gëDñèLi°Sèπ
(
dñèLi°
)) {

238 
	`ªbÆ™˚DñèMem‹y
(
dñèMem‹y
, 
middÀ
 + 1, 
œ°
);

239 
	`ªbÆ™˚DñèMem‹y
(
dñèMem‹y
, 
fú°
, 
middÀ
);

241 
	`ªbÆ™˚DñèMem‹y
(
dñèMem‹y
, 
fú°
, 
middÀ
);

242 
	`ªbÆ™˚DñèMem‹y
(
dñèMem‹y
, 
middÀ
 + 1, 
œ°
);

245 
	}
}

248 
	$öôülizeDñèMem‹y
(
DñèMem‹y
 *
dñèMem‹y
, 
size_t
 
size
,

249 
fú°Li°
, 
numLi°s
,

250 
mónDñè
, 
numPaylﬂdBôs
)

252 i‡(
numLi°s
 == 0) {

253  
	`logW¨nögWôhSåögEº‹
(
UDS_INVALID_ARGUMENT
,

257 
byã
 *
mem‹y
 = 
NULL
;

258 
ªsu…
 = 
	`ALLOCATE
(
size
, 
byã
, "dñèÜi°", &
mem‹y
);

259 i‡(
ªsu…
 !
UDS_SUCCESS
) {

260  
ªsu…
;

262 
uöt64_t
 *
ãmpOff£ts
 = 
NULL
;

263 
ªsu…
 = 
	`ALLOCATE
(
numLi°s
 + 2, 
uöt64_t
, "deltaÜistÅemp",

264 &
ãmpOff£ts
);

265 i‡(
ªsu…
 !
UDS_SUCCESS
) {

266 
	`FREE
(
mem‹y
);

267  
ªsu…
;

269 
byã
 *
Êags
 = 
NULL
;

270 
ªsu…
 = 
	`ALLOCATE
(
	`gëSizeOfFœgs
(
numLi°s
), 
byã
, "deltaÜist flags",

271 &
Êags
);

272 i‡(
ªsu…
 !
UDS_SUCCESS
) {

273 
	`FREE
(
mem‹y
);

274 
	`FREE
(
ãmpOff£ts
);

275  
ªsu…
;

278 
	`öôülizeCodögC⁄°™ts
(
dñèMem‹y
, 
mónDñè
);

279 
dñèMem‹y
->
vÆueBôs
 = 
numPaylﬂdBôs
;

280 
dñèMem‹y
->
mem‹y
 = memory;

281 
dñèMem‹y
->
dñèLi°s
 = 
NULL
;

282 
dñèMem‹y
->
ãmpOff£ts
 =ÅempOffsets;

283 
dñèMem‹y
->
Êags
 = flags;

284 
dñèMem‹y
->
buf„ªdWrôî
 = 
NULL
;

285 
dñèMem‹y
->
size
 = size;

286 
dñèMem‹y
->
ªbÆ™˚Time
 = 0;

287 
dñèMem‹y
->
ªbÆ™˚Cou¡
 = 0;

288 
dñèMem‹y
->
ªc‹dCou¡
 = 0;

289 
dñèMem‹y
->
cﬁlisi⁄Cou¡
 = 0;

290 
dñèMem‹y
->
disˇrdCou¡
 = 0;

291 
dñèMem‹y
->
ovîÊowCou¡
 = 0;

292 
dñèMem‹y
->
fú°Li°
 = firstList;

293 
dñèMem‹y
->
numLi°s
 =ÇumLists;

294 
dñèMem‹y
->
numTøns„rs
 = 0;

295 
dñèMem‹y
->
å™s„rSètus
 = 
UDS_SUCCESS
;

296 
dñèMem‹y
->
èg
 = 'm';

299 
ªsu…
 = 
	`ALLOCATE
(
dñèMem‹y
->
numLi°s
 + 2, 
DñèLi°
,

300 "dñèÜi°s", &
dñèMem‹y
->
dñèLi°s
);

301 i‡(
ªsu…
 !
UDS_SUCCESS
) {

302 
	`unöôülizeDñèMem‹y
(
dñèMem‹y
);

303  
ªsu…
;

306 
	`em±yDñèLi°s
(
dñèMem‹y
);

307  
UDS_SUCCESS
;

308 
	}
}

311 
	$unöôülizeDñèMem‹y
(
DñèMem‹y
 *
dñèMem‹y
)

313 
	`FREE
(
dñèMem‹y
->
Êags
);

314 
dñèMem‹y
->
Êags
 = 
NULL
;

315 
	`FREE
(
dñèMem‹y
->
ãmpOff£ts
);

316 
dñèMem‹y
->
ãmpOff£ts
 = 
NULL
;

317 
	`FREE
(
dñèMem‹y
->
dñèLi°s
);

318 
dñèMem‹y
->
dñèLi°s
 = 
NULL
;

319 
	`FREE
(
dñèMem‹y
->
mem‹y
);

320 
dñèMem‹y
->
mem‹y
 = 
NULL
;

321 
	}
}

324 
	$öôülizeDñèMem‹yPage
(
DñèMem‹y
 *
dñèMem‹y
, 
byã
 *
mem‹y
,

325 
size_t
 
size
, 
numLi°s
,

326 
mónDñè
,

327 
numPaylﬂdBôs
)

329 
	`öôülizeCodögC⁄°™ts
(
dñèMem‹y
, 
mónDñè
);

330 
dñèMem‹y
->
vÆueBôs
 = 
numPaylﬂdBôs
;

331 
dñèMem‹y
->
mem‹y
 = memory;

332 
dñèMem‹y
->
dñèLi°s
 = 
NULL
;

333 
dñèMem‹y
->
ãmpOff£ts
 = 
NULL
;

334 
dñèMem‹y
->
Êags
 = 
NULL
;

335 
dñèMem‹y
->
buf„ªdWrôî
 = 
NULL
;

336 
dñèMem‹y
->
size
 = size;

337 
dñèMem‹y
->
ªbÆ™˚Time
 = 0;

338 
dñèMem‹y
->
ªbÆ™˚Cou¡
 = 0;

339 
dñèMem‹y
->
ªc‹dCou¡
 = 0;

340 
dñèMem‹y
->
cﬁlisi⁄Cou¡
 = 0;

341 
dñèMem‹y
->
disˇrdCou¡
 = 0;

342 
dñèMem‹y
->
ovîÊowCou¡
 = 0;

343 
dñèMem‹y
->
fú°Li°
 = 0;

344 
dñèMem‹y
->
numLi°s
 =ÇumLists;

345 
dñèMem‹y
->
numTøns„rs
 = 0;

346 
dñèMem‹y
->
å™s„rSètus
 = 
UDS_SUCCESS
;

347 
dñèMem‹y
->
èg
 = 'p';

348 
	}
}

351 
boﬁ
 
	$¨eDñèMem‹yTøns„rsD⁄e
(c⁄° 
DñèMem‹y
 *
dñèMem‹y
)

353  
dñèMem‹y
->
numTøns„rs
 == 0;

354 
	}
}

357 
	$°¨tRe°‹ögDñèMem‹y
(
DñèMem‹y
 *
dñèMem‹y
)

360 
ªsu…
 = 
	`exãndDñèMem‹y
(
dñèMem‹y
, 0, 0, 
Ál£
);

361 i‡(
ªsu…
 !
UDS_SUCCESS
) {

362  
UDS_SUCCESS
;

366 
DñèLi°
 *
dñèLi°
 = &
dñèMem‹y
->
dñèLi°s
[dñèMem‹y->
numLi°s
 + 1];

367 
	`£tO√
(
dñèMem‹y
->
mem‹y
, 
	`gëDñèLi°Sèπ
(
dñèLi°
),

368 
	`gëDñèLi°Size
(
dñèLi°
));

370 
	`ÊagN⁄Em±yDñèLi°s
(
dñèMem‹y
);

371  
UDS_SUCCESS
;

372 
	}
}

375 
	$ªadSavedDñèLi°
(
DñèLi°SaveInfo
 *
dlsi
,

376 
byã
 
d©a
[
DELTA_LIST_MAX_BYTE_COUNT
],

377 
Buf„ªdRódî
 *
buf„ªdRódî
)

379 
ªsu…
 = 
	`ªadFromBuf„ªdRódî
(
buf„ªdRódî
, (
byã
 *Ë
dlsi
,

380 (
DñèLi°SaveInfo
));

381 i‡(
ªsu…
 =
UDS_END_OF_FILE
) {

382  
UDS_END_OF_FILE
;

384 i‡(
ªsu…
 !
UDS_SUCCESS
) {

385  
	`logW¨nögWôhSåögEº‹
(
ªsu…
, "failedÅoÑead deltaÜist data");

387 i‡((
dlsi
->
bôOff£t
 >
CHAR_BIT
)

388 || (
dlsi
->
byãCou¡
 > 
DELTA_LIST_MAX_BYTE_COUNT
)) {

389  
	`logW¨nögWôhSåögEº‹
(
UDS_CORRUPT_COMPONENT
,

392 i‡(
dlsi
->
èg
 == 'z') {

393  
UDS_END_OF_FILE
;

395 
ªsu…
 = 
	`ªadFromBuf„ªdRódî
(
buf„ªdRódî
, 
d©a
, 
dlsi
->
byãCou¡
);

396 i‡(
ªsu…
 !
UDS_SUCCESS
) {

397  
	`logW¨nögWôhSåögEº‹
(
ªsu…
, "failedÅoÑead deltaÜist data");

399  
UDS_SUCCESS
;

400 
	}
}

403 
	$ª°‹eDñèLi°
(
DñèMem‹y
 *
dñèMem‹y
, c⁄° 
DñèLi°SaveInfo
 *
dlsi
,

404 c⁄° 
byã
 
d©a
[
DELTA_LIST_MAX_BYTE_COUNT
])

406 
li°Numbî
 = 
dlsi
->
ödex
 - 
dñèMem‹y
->
fú°Li°
;

407 i‡(
li°Numbî
 >
dñèMem‹y
->
numLi°s
) {

408  
	`logW¨nögWôhSåögEº‹
(
UDS_CORRUPT_COMPONENT
,

411 
dlsi
->
ödex
, 
dñèMem‹y
->
fú°Li°
,

412 
dñèMem‹y
->
fú°Li°


413 + 
dñèMem‹y
->
numLi°s
);

416 i‡(
	`gëFõld
(
dñèMem‹y
->
Êags
, 
li°Numbî
, 1) == 0) {

417  
	`logW¨nögWôhSåögEº‹
(
UDS_CORRUPT_COMPONENT
,

419 
dlsi
->
ödex
);

422 
DñèLi°
 *
dñèLi°
 = &
dñèMem‹y
->
dñèLi°s
[
li°Numbî
 + 1];

423 
uöt16_t
 
bôSize
 = 
	`gëDñèLi°Size
(
dñèLi°
);

424 
byãCou¡


425 ((Ë
dlsi
->
bôOff£t
 + 
bôSize
 + 
CHAR_BIT
 - 1) / CHAR_BIT;

426 i‡(
dlsi
->
byãCou¡
 != byteCount) {

427  
	`logW¨nögWôhSåögEº‹
(
UDS_CORRUPT_COMPONENT
,

429 
dlsi
->
byãCou¡
, byteCount);

432 
	`moveBôs
(
d©a
, 
dlsi
->
bôOff£t
, 
dñèMem‹y
->
mem‹y
,

433 
	`gëDñèLi°Sèπ
(
dñèLi°
), 
bôSize
);

434 
	`£tZîo
(
dñèMem‹y
->
Êags
, 
li°Numbî
, 1);

435 
dñèMem‹y
->
numTøns„rs
--;

436  
UDS_SUCCESS
;

437 
	}
}

440 
	$ab‹tRe°‹ögDñèMem‹y
(
DñèMem‹y
 *
dñèMem‹y
)

442 
	`˛órTøns„rFœgs
(
dñèMem‹y
);

443 
	`em±yDñèLi°s
(
dñèMem‹y
);

444 
	}
}

447 
	$°¨tSavögDñèMem‹y
(
DñèMem‹y
 *
dñèMem‹y
,

448 
Buf„ªdWrôî
 *
buf„ªdWrôî
)

450 
	`ÊagN⁄Em±yDñèLi°s
(
dñèMem‹y
);

451 
dñèMem‹y
->
buf„ªdWrôî
 = bufferedWriter;

452 
	}
}

455 
	$föishSavögDñèMem‹y
(
DñèMem‹y
 *
dñèMem‹y
)

457 
i
 = 0;

458 !
	`¨eDñèMem‹yTøns„rsD⁄e
(
dñèMem‹y
)

459 && (
i
 < 
dñèMem‹y
->
numLi°s
);

460 
i
++) {

461 
	`œzyFlushDñèLi°
(
dñèMem‹y
, 
i
);

463 i‡(
dñèMem‹y
->
numTøns„rs
 > 0) {

464 
dñèMem‹y
->
å™s„rSètus


465 
	`logW¨nögWôhSåögEº‹
(
UDS_CORRUPT_DATA
,

468 
dñèMem‹y
->
buf„ªdWrôî
 = 
NULL
;

469  
dñèMem‹y
->
å™s„rSètus
;

470 
	}
}

473 
	$ab‹tSavögDñèMem‹y
(
DñèMem‹y
 *
dñèMem‹y
)

475 
	`˛órTøns„rFœgs
(
dñèMem‹y
);

476 
dñèMem‹y
->
buf„ªdWrôî
 = 
NULL
;

477 
	}
}

480 
	$ÊushDñèLi°
(
DñèMem‹y
 *
dñèMem‹y
, 
ÊushIndex
)

482 
	`ASSERT_LOG_ONLY
((
	`gëFõld
(
dñèMem‹y
->
Êags
, 
ÊushIndex
, 1) != 0),

484 
	`£tZîo
(
dñèMem‹y
->
Êags
, 
ÊushIndex
, 1);

485 
dñèMem‹y
->
numTøns„rs
--;

487 
DñèLi°
 *
dñèLi°
 = &
dñèMem‹y
->
dñèLi°s
[
ÊushIndex
 + 1];

488 
DñèLi°SaveInfo
 
dlsi
;

489 
dlsi
.
èg
 = 
dñèMem‹y
->tag;

490 
dlsi
.
bôOff£t
 = 
	`gëDñèLi°Sèπ
(
dñèLi°
Ë% 
CHAR_BIT
;

491 
dlsi
.
byãCou¡
 = 
	`gëDñèLi°ByãSize
(
dñèLi°
);

492 
dlsi
.
ödex
 = 
dñèMem‹y
->
fú°Li°
 + 
ÊushIndex
;

493 
ªsu…
 = 
	`wrôeToBuf„ªdWrôî
(
dñèMem‹y
->
buf„ªdWrôî
,

494 (c⁄° 
byã
 *Ë&
dlsi
,

495 (
DñèLi°SaveInfo
));

496 i‡(
ªsu…
 !
UDS_SUCCESS
) {

497 
	`logW¨nögWôhSåögEº‹
(
ªsu…
, "failedÅo write deltaÜist memory");

498 i‡(
dñèMem‹y
->
å™s„rSètus
 =
UDS_SUCCESS
) {

499 
dñèMem‹y
->
å™s„rSètus
 = 
ªsu…
;

502 
ªsu…
 = 
	`wrôeToBuf„ªdWrôî
(
dñèMem‹y
->
buf„ªdWrôî
,

503 
dñèMem‹y
->
mem‹y


504 + 
	`gëDñèLi°ByãSèπ
(
dñèLi°
),

505 
dlsi
.
byãCou¡
);

506 i‡(
ªsu…
 !
UDS_SUCCESS
) {

507 
	`logW¨nögWôhSåögEº‹
(
ªsu…
, "failedÅo write deltaÜist memory");

508 i‡(
dñèMem‹y
->
å™s„rSètus
 =
UDS_SUCCESS
) {

509 
dñèMem‹y
->
å™s„rSètus
 = 
ªsu…
;

512 
	}
}

515 
	$wrôeGu¨dDñèLi°
(
Buf„ªdWrôî
 *
buf„ªdWrôî
)

517 
DñèLi°SaveInfo
 
dlsi
;

518 
dlsi
.
èg
 = 'z';

519 
dlsi
.
bôOff£t
 = 0;

520 
dlsi
.
byãCou¡
 = 0;

521 
dlsi
.
ödex
 = 0;

522 
ªsu…
 = 
	`wrôeToBuf„ªdWrôî
(
buf„ªdWrôî
, (c⁄° 
byã
 *Ë&
dlsi
,

523 (
DñèLi°SaveInfo
));

524 i‡(
ªsu…
 !
UDS_SUCCESS
) {

525 
	`logW¨nögWôhSåögEº‹
(
ªsu…
, "failedÅo write guard deltaÜist");

527  
ªsu…
;

528 
	}
}

531 
	$exãndDñèMem‹y
(
DñèMem‹y
 *
dñèMem‹y
, 
growögIndex
,

532 
size_t
 
growögSize
, 
boﬁ
 
doC›y
)

534 i‡(!
	`isMuèbÀ
(
dñèMem‹y
)) {

535  
	`logEº‹WôhSåögEº‹
(
UDS_BAD_STATE
,

540 
AbsTime
 
°¨tTime
 = 
	`cuºítTime
(
CT_MONOTONIC
);

544 
DñèLi°
 *
dñèLi°s
 = 
dñèMem‹y
->deltaLists;

545 
size_t
 
u£dS∑˚
 = 
growögSize
;

546 
i
 = 0; i <
dñèMem‹y
->
numLi°s
 + 1; i++) {

547 
u£dS∑˚
 +
	`gëDñèLi°ByãSize
(&
dñèLi°s
[
i
]);

550 i‡(
dñèMem‹y
->
size
 < 
u£dS∑˚
) {

551  
UDS_OVERFLOW
;

555 
size_t
 
•acög
 = (
dñèMem‹y
->
size
 - 
u£dS∑˚
Ë/ dñèMem‹y->
numLi°s
;

556 
dñèMem‹y
->
ãmpOff£ts
[0] = 0;

557 
i
 = 0; i <
dñèMem‹y
->
numLi°s
; i++) {

558 
dñèMem‹y
->
ãmpOff£ts
[
i
 + 1] = (deltaMemory->tempOffsets[i]

559 + 
	`gëDñèLi°ByãSize
(&
dñèLi°s
[
i
])

560 + 
•acög
);

561 
dñèMem‹y
->
ãmpOff£ts
[
i
] *
CHAR_BIT
;

562 
dñèMem‹y
->
ãmpOff£ts
[
i
]

563 +
	`gëDñèLi°Sèπ
(&
dñèLi°s
[
i
]Ë% 
CHAR_BIT
;

564 i‡(
i
 == 0) {

565 
dñèMem‹y
->
ãmpOff£ts
[
i
 + 1] -
•acög
 / 2;

567 i‡(
i
 + 1 =
growögIndex
) {

568 
dñèMem‹y
->
ãmpOff£ts
[
i
 + 1] +
growögSize
;

571 
dñèMem‹y
->
ãmpOff£ts
[dñèMem‹y->
numLi°s
 + 1]

572 (
dñèMem‹y
->
size
 * 
CHAR_BIT


573 - 
	`gëDñèLi°Size
(&
dñèLi°s
[
dñèMem‹y
->
numLi°s
 + 1]));

577 i‡(
doC›y
) {

578 
	`ªbÆ™˚DñèMem‹y
(
dñèMem‹y
, 1, dñèMem‹y->
numLi°s
 + 1);

579 
AbsTime
 
ídTime
 = 
	`cuºítTime
(
CT_MONOTONIC
);

580 
dñèMem‹y
->
ªbÆ™˚Cou¡
++;

581 
dñèMem‹y
->
ªbÆ™˚Time
 +
	`timeDif„ªn˚
(
ídTime
, 
°¨tTime
);

583 
i
 = 1; i <
dñèMem‹y
->
numLi°s
 + 1; i++) {

584 
dñèLi°s
[
i
].
°¨tOff£t
 = 
dñèMem‹y
->
ãmpOff£ts
[i];

587  
UDS_SUCCESS
;

588 
	}
}

591 
	$vÆid©eDñèLi°s
(c⁄° 
DñèMem‹y
 *
dñèMem‹y
)

594 i‡(
dñèMem‹y
->
cﬁlisi⁄Cou¡
 > dñèMem‹y->
ªc‹dCou¡
) {

595  
	`logW¨nögWôhSåögEº‹
(
UDS_BAD_STATE
,

598 
dñèMem‹y
->
cﬁlisi⁄Cou¡
,

599 
dñèMem‹y
->
ªc‹dCou¡
);

603 
DñèLi°
 *
dñèLi°s
 = 
dñèMem‹y
->deltaLists;

604 i‡(
	`gëDñèLi°Sèπ
(&
dñèLi°s
[0]) != 0) {

605  
	`logW¨nögWôhSåögEº‹
(
UDS_BAD_STATE
,

607 "áà0: %" 
PRIu64
,

608 
	`gëDñèLi°Sèπ
(&
dñèLi°s
[0]));

610 
uöt64_t
 
numBôs
 = 
	`gëDñèLi°End
(&
dñèLi°s
[
dñèMem‹y
->
numLi°s
 + 1]);

611 i‡(
numBôs
 !
dñèMem‹y
->
size
 * 
CHAR_BIT
) {

612  
	`logW¨nögWôhSåögEº‹
(
UDS_BAD_STATE
,

614 "©Énd o‡Æloˇãd mem‹y: %" 
PRIu64


616 
numBôs
, 
dñèMem‹y
->
size
 * 
CHAR_BIT
);

618 
numGu¨dBôs
 = 
	`gëDñèLi°Size
(&
dñèLi°s
[
dñèMem‹y
->
numLi°s
 + 1]);

619 i‡(
numGu¨dBôs
 < 
GUARD_BITS
) {

620  
	`logW¨nögWôhSåögEº‹
(
UDS_BAD_STATE
,

623 
numGu¨dBôs
, 
GUARD_BITS
);

625 
i
 = 0; i <
dñèMem‹y
->
numLi°s
 + 1; i++) {

626 i‡(
	`gëDñèLi°Sèπ
(&
dñèLi°s
[
i
]Ë> 
	`gëDñèLi°End
(&deltaLists[i])) {

627  
	`logW¨nögWôhSåögEº‹
(
UDS_BAD_STATE
,

628 "övÆid dñèÜi° %u: [%" 
PRIu64


629 ", %" 
PRIu64
 ")",

630 
i
,

631 
	`gëDñèLi°Sèπ
(&
dñèLi°s
[
i
]),

632 
	`gëDñèLi°End
(&
dñèLi°s
[
i
]));

634 i‡(
i
 > 
dñèMem‹y
->
numLi°s
) {

638 i‡(
	`gëDñèLi°End
(&
dñèLi°s
[
i
])

639 > 
	`gëDñèLi°Sèπ
(&
dñèLi°s
[
i
 + 1])) {

640  
	`logW¨nögWôhSåögEº‹
(
UDS_BAD_STATE
,

642 
PRIu64
 " > %" PRIu64,

643 
i
, i + 1,

644 
	`gëDñèLi°End
(&
dñèLi°s
[
i
]),

645 
	`gëDñèLi°Sèπ
(&
dñèLi°s
[
i
 + 1]));

647 i‡(
i
 == 0) {

651 i‡(
dñèLi°s
[
i
].
ßveOff£t
 > 
	`gëDñèLi°Size
(&deltaLists[i])) {

652  
	`logW¨nögWôhSåögEº‹
(
UDS_BAD_STATE
,

655 
i
, 
dñèLi°s
[i].
ßveOff£t
,

656 
	`gëDñèLi°Size
(&
dñèLi°s
[
i
]));

660  
UDS_SUCCESS
;

661 
	}
}

664 
size_t
 
	$gëDñèMem‹yAŒoˇãd
(c⁄° 
DñèMem‹y
 *
dñèMem‹y
)

666  (
dñèMem‹y
->
size


667 + 
	`gëSizeOfDñèLi°s
(
dñèMem‹y
->
numLi°s
)

668 + 
	`gëSizeOfFœgs
(
dñèMem‹y
->
numLi°s
)

669 + 
	`gëSizeOfTempOff£ts
(
dñèMem‹y
->
numLi°s
));

670 
	}
}

673 
size_t
 
	$gëDñèMem‹ySize
(
numE¡rõs
, 
mónDñè
,

674 
numPaylﬂdBôs
)

676 
DñèMem‹y
 
dñèMem‹y
;

677 
	`öôülizeCodögC⁄°™ts
(&
dñèMem‹y
, 
mónDñè
);

679  (
numE¡rõs
 * (
numPaylﬂdBôs
 + 
dñèMem‹y
.
möBôs
 + 1)

680 + 
numE¡rõs
 / 2);

681 
	}
}

	@uds/deltaMemory.h

22 #i‚de‡
DELTAMEMORY_H


23 
	#DELTAMEMORY_H
 1

	)

25 
	~"bôs.h
"

26 
	~"buf„ªdRódî.h
"

27 
	~"buf„ªdWrôî.h
"

28 
	~"compûî.h
"

29 
	~"˝u.h
"

30 
	~"timeUtûs.h
"

48 
	sdñèLi°
 {

49 
uöt64_t
 
	m°¨tOff£t
;

50 
uöt16_t
 
	msize
;

51 
uöt16_t
 
	mßveOff£t
;

52 
	mßveKey
;

53 } 
	tDñèLi°
;

55 
__©åibuã__
((
	tÆig√d
(
	tCACHE_LINE_BYTES
))Ë
	tdñèMem‹y
 {

56 
byã
 *
mem‹y
;

57 
DñèLi°
 *
dñèLi°s
;

58 
uöt64_t
 *
ãmpOff£ts
;

59 
byã
 *
Êags
;

60 
Buf„ªdWrôî
 *
buf„ªdWrôî
;

61 
size_t
 
size
;

62 
RñTime
 
ªbÆ™˚Time
;

63 
ªbÆ™˚Cou¡
;

64 
vÆueBôs
;

65 
möBôs
;

66 
möKeys
;

67 
ö¸Keys
;

68 
ªc‹dCou¡
;

69 
cﬁlisi⁄Cou¡
;

70 
disˇrdCou¡
;

71 
ovîÊowCou¡
;

72 
fú°Li°
;

73 
numLi°s
;

74 
numTøns„rs
;

75 
å™s„rSètus
;

76 
byã
 
èg
;

77 
	}
} 
	tDñèMem‹y
;

79 
	sdñèLi°SaveInfo
 {

80 
uöt8_t
 
	mèg
;

81 
uöt8_t
 
	mbôOff£t
;

82 
uöt16_t
 
	mbyãCou¡
;

83 
uöt32_t
 
	mödex
;

84 } 
	tDñèLi°SaveInfo
;

88 íum { 
	mDELTA_LIST_MAX_BYTE_COUNT
 = ((
UINT16_MAX
 + 
CHAR_BIT
) / CHAR_BIT

89 + 
POST_FIELD_GUARD_BYTES
) };

103 
	$öôülizeDñèMem‹y
(
DñèMem‹y
 *
dñèMem‹y
, 
size_t
 
size
,

104 
fú°Li°
, 
numLi°s
,

105 
mónDñè
, 
numPaylﬂdBôs
)

106 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

113 
	`unöôülizeDñèMem‹y
(
DñèMem‹y
 *
dñèMem‹y
);

125 
	`öôülizeDñèMem‹yPage
(
DñèMem‹y
 *
dñèMem‹y
, 
byã
 *
mem‹y
,

126 
size_t
 
size
, 
numLi°s
,

127 
mónDñè
,

128 
numPaylﬂdBôs
);

135 
	`em±yDñèLi°s
(
DñèMem‹y
 *
dñèMem‹y
);

145 
boﬁ
 
	`¨eDñèMem‹yTøns„rsD⁄e
(c⁄° 
DñèMem‹y
 *
dñèMem‹y
);

154 
	$°¨tRe°‹ögDñèMem‹y
(
DñèMem‹y
 *
dñèMem‹y
)

155 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

167 
	$ªadSavedDñèLi°
(
DñèLi°SaveInfo
 *
dlsi
,

168 
byã
 
d©a
[
DELTA_LIST_MAX_BYTE_COUNT
],

169 
Buf„ªdRódî
 *
buf„ªdRódî
)

170 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

181 
	$ª°‹eDñèLi°
(
DñèMem‹y
 *
dñèMem‹y
, c⁄° 
DñèLi°SaveInfo
 *
dlsi
,

182 c⁄° 
byã
 
d©a
[
DELTA_LIST_MAX_BYTE_COUNT
])

183 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

190 
	`ab‹tRe°‹ögDñèMem‹y
(
DñèMem‹y
 *
dñèMem‹y
);

198 
	`°¨tSavögDñèMem‹y
(
DñèMem‹y
 *
dñèMem‹y
,

199 
Buf„ªdWrôî
 *
buf„ªdWrôî
);

210 
	$föishSavögDñèMem‹y
(
DñèMem‹y
 *
dñèMem‹y
)

211 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

219 
	`ab‹tSavögDñèMem‹y
(
DñèMem‹y
 *
dñèMem‹y
);

227 
	`ÊushDñèLi°
(
DñèMem‹y
 *
dñèMem‹y
, 
ÊushIndex
);

236 
	$wrôeGu¨dDñèLi°
(
Buf„ªdWrôî
 *
buf„ªdWrôî
)

237 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

259 
	$exãndDñèMem‹y
(
DñèMem‹y
 *
dñèMem‹y
, 
growögIndex
,

260 
size_t
 
growögSize
, 
boﬁ
 
doC›y
)

261 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

270 
	$vÆid©eDñèLi°s
(c⁄° 
DñèMem‹y
 *
dñèMem‹y
)

271 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

281 
size_t
 
	`gëDñèMem‹yAŒoˇãd
(c⁄° 
DñèMem‹y
 *
dñèMem‹y
);

292 
size_t
 
	$gëDñèMem‹ySize
(
numE¡rõs
, 
mónDñè
,

293 
numPaylﬂdBôs
)

294 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

303 
INLINE
 
uöt64_t
 
	$gëDñèLi°Sèπ
(c⁄° 
DñèLi°
 *
dñèLi°
)

305  
dñèLi°
->
°¨tOff£t
;

306 
	}
}

315 
INLINE
 
uöt16_t
 
	$gëDñèLi°Size
(c⁄° 
DñèLi°
 *
dñèLi°
)

317  
dñèLi°
->
size
;

318 
	}
}

327 
INLINE
 
uöt64_t
 
	$gëDñèLi°End
(c⁄° 
DñèLi°
 *
dñèLi°
)

329  
	`gëDñèLi°Sèπ
(
dñèLi°
Ë+ 
	`gëDñèLi°Size
(deltaList);

330 
	}
}

352 
INLINE
 
boﬁ
 
	$isMuèbÀ
(c⁄° 
DñèMem‹y
 *
dñèMem‹y
)

354  
dñèMem‹y
->
dñèLi°s
 !
NULL
;

355 
	}
}

363 
INLINE
 
	$œzyFlushDñèLi°
(
DñèMem‹y
 *
dñèMem‹y
,

364 
ÊushIndex
)

366 i‡(
	`gëFõld
(
dñèMem‹y
->
Êags
, 
ÊushIndex
, 1) != 0) {

367 
	`ÊushDñèLi°
(
dñèMem‹y
, 
ÊushIndex
);

369 
	}
}

	@uds/errorDefs.h

22 #i‚de‡
LINUX_KERNEL_ERROR_DEFS_H


23 
	#LINUX_KERNEL_ERROR_DEFS_H


	)

25 
	~"ty≥Defs.h
"

37 c⁄° *
sy°emSåögEº‹
(
î∫um
, *
buf
, 
size_t
 
buÊí
);

	@uds/errors.c

22 
	~"îr‹s.h
"

24 
	~"comm⁄.h
"

25 
	~"îr‹Defs.h
"

26 
	~"≥rmas£π.h
"

27 
	~"°rögUtûs.h
"

28 
	~"thªads.h
"

30 c⁄° 
îr‹Info
 
	gsuc˚ssful
 = { "UDS_SUCCESS", "Success" };

32 c⁄° 
îr‹Info
 
	gîr‹Li°
[] = {

92 c⁄° 
îr‹Info
 
	göã∫ÆEº‹Li°
[] = {

122 
	mUDS_UNRECOVERABLE
 = (1 << 17)

125 
	sîr‹Block
 {

126 c⁄° *
	m«me
;

127 
	mba£
;

128 
	mœ°
;

129 
	mmax
;

130 c⁄° 
Eº‹Info
 *
	möfos
;

131 } 
	tEº‹Block
;

134 
	mMAX_ERROR_BLOCKS
 = 6

137 
	sîr‹Inf‹m©i⁄
 {

138 
	mÆloˇãd
;

139 
	mcou¡
;

140 
Eº‹Block
 
	mblocks
[
MAX_ERROR_BLOCKS
];

141 } 
	gªgi°îedEº‹s
;

143 
On˚Sèã
 
	gîr‹BlocksInôülized
 = 
ONCE_STATE_INITIALIZER
;

146 
	$öôülizeSènd¨dEº‹Blocks
()

148 
ªgi°îedEº‹s
.
Æloˇãd
 = 
MAX_ERROR_BLOCKS
;

149 
ªgi°îedEº‹s
.
cou¡
 = 0;

152 
ªgi°îedEº‹s
.
blocks
[ªgi°îedEº‹s.
cou¡
++] = (
Eº‹Block
) {

153 .
«me
 = "UDS Error",

154 .
ba£
 = 
UDS_ERROR_CODE_BASE
,

155 .
œ°
 = 
UDS_ERROR_CODE_LAST
,

156 .
max
 = 
UDS_ERROR_CODE_BLOCK_END
,

157 .
öfos
 = 
îr‹Li°
,

160 
ªgi°îedEº‹s
.
blocks
[ªgi°îedEº‹s.
cou¡
++] = (
Eº‹Block
) {

161 .
«me
 = "UDS Internal Error",

162 .
ba£
 = 
UDS_INTERNAL_ERROR_CODE_BASE
,

163 .
œ°
 = 
UDS_INTERNAL_ERROR_CODE_LAST
,

164 .
max
 = 
UDS_INTERNAL_ERROR_CODE_BLOCK_END
,

165 .
öfos
 = 
öã∫ÆEº‹Li°
,

167 
	}
}

170 
	$ísuªSènd¨dEº‹Blocks
()

172 
	`≥rf‹mOn˚
(&
îr‹BlocksInôülized
, 
öôülizeSènd¨dEº‹Blocks
);

173 
	}
}

184 c⁄° *
	$gëEº‹Info
(
î∫um
, c⁄° 
Eº‹Info
 **
öfoPå
)

186 
	`ísuªSènd¨dEº‹Blocks
();

188 i‡(
î∫um
 =
UDS_SUCCESS
) {

189 i‡(
öfoPå
 !
NULL
) {

190 *
öfoPå
 = &
suc˚ssful
;

192  
NULL
;

195 
Eº‹Block
 *
block
 = 
ªgi°îedEº‹s
.
blocks
;

196 
block
 < 
ªgi°îedEº‹s
.
blocks
 +Ñegi°îedEº‹s.
cou¡
;

197 ++
block
) {

198 i‡((
î∫um
 >
block
->
ba£
Ë&& (î∫um < block->
œ°
)) {

199 i‡(
öfoPå
 !
NULL
) {

200 *
öfoPå
 = 
block
->
öfos
 + (
î∫um
 - block->
ba£
);

202  
block
->
«me
;

203 } i‡((
î∫um
 >
block
->
œ°
Ë&& (î∫um < block->
max
)) {

204 i‡(
öfoPå
 !
NULL
) {

205 *
öfoPå
 = 
NULL
;

207  
block
->
«me
;

210 i‡(
öfoPå
 !
NULL
) {

211 *
öfoPå
 = 
NULL
;

213  
NULL
;

214 
	}
}

217 c⁄° *
	$°rögEº‹
(
î∫um
, *
buf
, 
size_t
 
buÊí
)

219 i‡(
buf
 =
NULL
) {

220  
NULL
;

223 *
buf„r
 = 
buf
;

224 *
bufEnd
 = 
buf
 + 
buÊí
;

226 i‡(
	`isUƒecovîabÀ
(
î∫um
)) {

227 
buf„r
 = 
	`≠≥ndToBuf„r
(buf„r, 
bufEnd
, "UnrecoverableÉrror: ");

228 
î∫um
 = 
	`ßnsUƒecovîabÀ
(errnum);

231 c⁄° 
Eº‹Info
 *
öfo
 = 
NULL
;

232 c⁄° *
blockName
 = 
	`gëEº‹Info
(
î∫um
, &
öfo
);

234 i‡(
blockName
 !
NULL
) {

235 i‡(
öfo
 !
NULL
) {

236 
buf„r
 = 
	`≠≥ndToBuf„r
(buf„r, 
bufEnd
,

237 "%s: %s", 
blockName
, 
öfo
->
mesßge
);

239 
buf„r
 = 
	`≠≥ndToBuf„r
(buf„r, 
bufEnd
,

240 "Unknow¿%†%d", 
blockName
, 
î∫um
);

242 } i‡(
öfo
 !
NULL
) {

243 
buf„r
 = 
	`≠≥ndToBuf„r
(buf„r, 
bufEnd
, "%s", 
öfo
->
mesßge
);

245 c⁄° *
tmp
 = 
	`sy°emSåögEº‹
(
î∫um
, 
buf„r
, 
bufEnd
 - buffer);

246 i‡(
tmp
 !
buf„r
) {

247 
buf„r
 = 
	`≠≥ndToBuf„r
(buf„r, 
bufEnd
, "%s", 
tmp
);

249 
buf„r
 +
	`°æí
(
tmp
);

252  
buf
;

253 
	}
}

256 c⁄° *
	$°rögEº‹Name
(
î∫um
, *
buf
, 
size_t
 
buÊí
)

258 i‡(
	`isUƒecovîabÀ
(
î∫um
)) {

259 
î∫um
 = 
	`ßnsUƒecovîabÀ
(errnum);

262 *
buf„r
 = 
buf
;

263 *
bufEnd
 = 
buf
 + 
buÊí
;

265 c⁄° 
Eº‹Info
 *
öfo
 = 
NULL
;

266 c⁄° *
blockName
 = 
	`gëEº‹Info
(
î∫um
, &
öfo
);

268 i‡(
blockName
 !
NULL
) {

269 i‡(
öfo
 !
NULL
) {

270 
buf„r
 = 
	`≠≥ndToBuf„r
(buf„r, 
bufEnd
, "%s", 
öfo
->
«me
);

272 
buf„r
 = 
	`≠≥ndToBuf„r
(buf„r, 
bufEnd
, "%†%d", 
blockName
, 
î∫um
);

274 } i‡(
öfo
 !
NULL
) {

275 
buf„r
 = 
	`≠≥ndToBuf„r
(buf„r, 
bufEnd
, "%s", 
öfo
->
«me
);

277 c⁄° *
tmp
 = 
	`sy°emSåögEº‹
(
î∫um
, 
buf„r
, 
bufEnd
 - buffer);

278 i‡(
tmp
 !
buf„r
) {

279 
buf„r
 = 
	`≠≥ndToBuf„r
(buf„r, 
bufEnd
, "%s", 
tmp
);

281 
buf„r
 +
	`°æí
(
tmp
);

284  
buf
;

285 
	}
}

288 
	$makeUƒecovîabÀ
(
ªsu…Code
)

290  ((
ªsu…Code
 =
UDS_SUCCESS
)

291 ? 
ªsu…Code


292 : (
ªsu…Code
 | 
UDS_UNRECOVERABLE
));

293 
	}
}

296 
	$ßnsUƒecovîabÀ
(
ªsu…Code
)

298  
ªsu…Code
 & ~
UDS_UNRECOVERABLE
;

299 
	}
}

302 
boﬁ
 
	$isUƒecovîabÀ
(
ªsu…Code
)

304  (
boﬁ
)(
ªsu…Code
 & 
UDS_UNRECOVERABLE
);

305 
	}
}

308 
	$ªgi°îEº‹Block
(c⁄° *
blockName
,

309 
fú°Eº‹
,

310 
œ°Re£rvedEº‹
,

311 c⁄° 
Eº‹Info
 *
öfos
,

312 
size_t
 
öfoSize
)

314 
ªsu…
 = 
	`ASSERT
(
fú°Eº‹
 < 
œ°Re£rvedEº‹
,

316 i‡(
ªsu…
 !
UDS_SUCCESS
) {

317  
ªsu…
;

320 
	`ísuªSènd¨dEº‹Blocks
();

322 i‡(
ªgi°îedEº‹s
.
cou¡
 =ªgi°îedEº‹s.
Æloˇãd
) {

324  
UDS_OVERFLOW
;

327 
Eº‹Block
 *
block
 = 
ªgi°îedEº‹s
.
blocks
;

328 
block
 < 
ªgi°îedEº‹s
.
blocks
 +Ñegi°îedEº‹s.
cou¡
;

329 ++
block
) {

330 i‡(
	`°rcmp
(
blockName
, 
block
->
«me
) == 0) {

331  
UDS_DUPLICATE_NAME
;

334 i‡((
fú°Eº‹
 < 
block
->
max
Ë&& (
œ°Re£rvedEº‹
 > block->
ba£
)) {

335  
UDS_ALREADY_REGISTERED
;

339 
ªgi°îedEº‹s
.
blocks
[ªgi°îedEº‹s.
cou¡
++] = (
Eº‹Block
) {

340 .
«me
 = 
blockName
,

341 .
ba£
 = 
fú°Eº‹
,

342 .
œ°
 = 
fú°Eº‹
 + (
öfoSize
 / (
Eº‹Info
)),

343 .
max
 = 
œ°Re£rvedEº‹
,

344 .
öfos
 = infos

347  
UDS_SUCCESS
;

348 
	}
}

	@uds/errors.h

22 #i‚de‡
ERRORS_H


23 
	#ERRORS_H


	)

25 
	~"compûî.h
"

26 
	~"ty≥Defs.h
"

27 
	~"uds-îr‹.h
"

29 
	eudsI¡î«lEº‹Codes
 {

31 
	mUDS_INTERNAL_ERROR_CODE_BASE
 = 66560,

33 
	mUDS_PROTOCOL_ERROR
 = 
UDS_INTERNAL_ERROR_CODE_BASE
 + 0,

35 
	mUDS_OVERFLOW
 = 
UDS_INTERNAL_ERROR_CODE_BASE
 + 1,

37 
	mUDS_FILLDONE
 = 
UDS_INTERNAL_ERROR_CODE_BASE
 + 2,

39 
	mUDS_INVALID_ARGUMENT
 = 
UDS_INTERNAL_ERROR_CODE_BASE
 + 3,

41 
	mUDS_BAD_STATE
 = 
UDS_INTERNAL_ERROR_CODE_BASE
 + 4,

43 
	mUDS_DUPLICATE_NAME
 = 
UDS_INTERNAL_ERROR_CODE_BASE
 + 5,

45 
	mUDS_UNEXPECTED_RESULT
 = 
UDS_INTERNAL_ERROR_CODE_BASE
 + 6,

47 
	mUDS_INJECTED_ERROR
 = 
UDS_INTERNAL_ERROR_CODE_BASE
 + 7,

49 
	mUDS_ASSERTION_FAILED
 = 
UDS_INTERNAL_ERROR_CODE_BASE
 + 8,

51 
	mUDS_UNSCANNABLE
 = 
UDS_INTERNAL_ERROR_CODE_BASE
 + 9,

53 
	mUDS_QUEUED
 = 
UDS_INTERNAL_ERROR_CODE_BASE
 + 10,

55 
	mUDS_QUEUE_ALREADY_CONNECTED
 = 
UDS_INTERNAL_ERROR_CODE_BASE
 + 11,

57 
	mUDS_BAD_FILL_PHASE
 = 
UDS_INTERNAL_ERROR_CODE_BASE
 + 12,

59 
	mUDS_BUFFER_ERROR
 = 
UDS_INTERNAL_ERROR_CODE_BASE
 + 13,

61 
	mUDS_CONNECTION_LOST
 = 
UDS_INTERNAL_ERROR_CODE_BASE
 + 14,

63 
	mUDS_TIMEOUT
 = 
UDS_INTERNAL_ERROR_CODE_BASE
 + 15,

65 
	mUDS_NO_DIRECTORY
 = 
UDS_INTERNAL_ERROR_CODE_BASE
 + 16,

67 
	mUDS_CHECKPOINT_INCOMPLETE
 = 
UDS_INTERNAL_ERROR_CODE_BASE
 + 17,

69 
	mUDS_INVALID_RUN_ID
 = 
UDS_INTERNAL_ERROR_CODE_BASE
 + 18,

71 
	mUDS_RUN_CANCELED
 = 
UDS_INTERNAL_ERROR_CODE_BASE
 + 19,

73 
	mUDS_ALREADY_REGISTERED
 = 
UDS_INTERNAL_ERROR_CODE_BASE
 + 20,

75 
	mUDS_BAD_IO_DIRECTION
 = 
UDS_INTERNAL_ERROR_CODE_BASE
 + 21,

77 
	mUDS_INCORRECT_ALIGNMENT
 = 
UDS_INTERNAL_ERROR_CODE_BASE
 + 22,

79 
	mUDS_OUT_OF_RANGE
 = 
UDS_INTERNAL_ERROR_CODE_BASE
 + 23,

81 
	mUDS_INTERNAL_ERROR_CODE_LAST
,

83 
	mUDS_INTERNAL_ERROR_CODE_BLOCK_END
 = 
UDS_INTERNAL_ERROR_CODE_BASE
 + 440

87 
	mERRBUF_SIZE
 = 128

90 c⁄° *
°rögEº‹
(
î∫um
, *
buf
, 
size_t
 
buÊí
);

91 c⁄° *
°rögEº‹Name
(
î∫um
, *
buf
, 
size_t
 
buÊí
);

93 
	$makeUƒecovîabÀ
(
ªsu…Code
Ë
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

94 
boﬁ
 
	$isUƒecovîabÀ
(
ªsu…Code
Ë
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

95 
	$ßnsUƒecovîabÀ
(
ªsu…Code
Ë
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

97 
	sîr‹Info
 {

98 c⁄° *
«me
;

99 c⁄° *
mesßge
;

100 } 
	tEº‹Info
;

107 
	`ísuªSènd¨dEº‹Blocks
();

124 
	`ªgi°îEº‹Block
(c⁄° *
blockName
,

125 
fú°Eº‹
,

126 
œ°Re£rvedEº‹
,

127 c⁄° 
Eº‹Info
 *
öfos
,

128 
size_t
 
öfoSize
);

138 
INLINE
 
	$fú°Eº‹
(
ªsu…1
, 
ªsu…2
)

140  
ªsu…1
 =
UDS_SUCCESS
 ? 
ªsu…2
 :Ñesult1;

141 
	}
}

	@uds/errorsLinuxKernel.c

23 
	~<löux/î∫o.h
>

25 
	~"compûî.h
"

26 
	~"îr‹Defs.h
"

28 * 
	gmesßgeTabÀ
[] = {

29 [
EPERM
] = "OperationÇotÖermitted",

30 [
ENOENT
] = "No such file or directory",

31 [
ESRCH
] = "No suchÖrocess",

32 [
EINTR
] = "Interrupted system call",

33 [
EIO
] = "Input/outputÉrror",

34 [
ENXIO
] = "No such device oráddress",

35 [
E2BIG
] = "ArgumentÜistÅooÜong",

36 [
ENOEXEC
] = "Exec formatÉrror",

37 [
EBADF
] = "Bad file descriptor",

38 [
ECHILD
] = "No childÖrocesses",

39 [
EAGAIN
] = "ResourceÅemporarily unavailable",

40 [
ENOMEM
] = "Cannotállocate memory",

41 [
EACCES
] = "Permission denied",

42 [
EFAULT
] = "Badáddress",

43 [
ENOTBLK
] = "Block deviceÑequired",

44 [
EBUSY
] = "Device orÑesource busy",

45 [
EEXIST
] = "FileÉxists",

46 [
EXDEV
] = "Invalid cross-deviceÜink",

47 [
ENODEV
] = "No such device",

48 [
ENOTDIR
] = "Notá directory",

49 [
EISDIR
] = "Isá directory",

50 [
EINVAL
] = "Invalidárgument",

51 [
ENFILE
] = "Too many open files in system",

52 [
EMFILE
] = "Too many open files",

53 [
ENOTTY
] = "Inappropriate ioctl for device",

54 [
ETXTBSY
] = "Text file busy",

55 [
EFBIG
] = "FileÅooÜarge",

56 [
ENOSPC
] = "No spaceÜeft on device",

57 [
ESPIPE
] = "Illegal seek",

58 [
EROFS
] = "Read-only file system",

59 [
EMLINK
] = "Too manyÜinks",

60 [
EPIPE
] = "BrokenÖipe",

61 [
EDOM
] = "Numericalárgument out of domain",

62 [
ERANGE
] = "NumericalÑesult out ofÑange"

66 c⁄° *
	$sy°emSåögEº‹
(
î∫um
, *
buf
, 
size_t
 
buÊí
)

68 *
îr‹Såög
 = 
NULL
;

69 i‡((
î∫um
 > 0Ë&& (î∫um < 
	`COUNT_OF
(
mesßgeTabÀ
))) {

70 
îr‹Såög
 = 
mesßgeTabÀ
[
î∫um
];

73 
size_t
 
Àn
 = ((
îr‹Såög
 =
NULL
)

74 ? 
	`¢¥ötf
(
buf
, 
buÊí
, "Unknow¿îr‹ %d", 
î∫um
)

75 : 
	`¢¥ötf
(
buf
, 
buÊí
, "%s", 
îr‹Såög
));

76 i‡(
Àn
 < 
buÊí
) {

77  
buf
;

80 
buf
[0] = '\0';

82 
	}
}

	@uds/featureDefs.h

22 #i‚de‡
LINUX_KERNEL_FEATURE_DEFS_H


23 
	#LINUX_KERNEL_FEATURE_DEFS_H
 1

	)

25 
	#DESTRUCTOR
 0

26 
	#ENVIRONMENT
 0

27 
	#FLOATING_POINT
 0

28 
	#GRID
 0

29 
	#HISTOGRAMS
 0

30 
	#NAMESPACES
 0

31 

	)

	@uds/geometry.c

22 
	~"geomëry.h
"

24 
	~"dñèIndex.h
"

25 
	~"îr‹s.h
"

26 
	~"hashUtûs.h
"

27 
	~"loggî.h
"

28 
	~"mem‹yAŒoc.h
"

29 
	~"≥rmas£π.h
"

30 
	~"uds.h
"

33 
	$öôülizeGeomëry
(
Geomëry
 *
geomëry
,

34 
size_t
 
byãsPîPage
,

35 
ªc‹dPagesPîCh≠ãr
,

36 
ch≠ãrsPîVﬁume
,

37 
•¨£Ch≠ãrsPîVﬁume
)

39 
ªsu…
 = 
	`ASSERT_WITH_ERROR_CODE
(
byãsPîPage
 >
BYTES_PER_RECORD
,

40 
UDS_BAD_STATE
,

42 
byãsPîPage
);

43 i‡(
ªsu…
 !
UDS_SUCCESS
) {

44  
ªsu…
;

47 
ªsu…
 = 
	`ASSERT_WITH_ERROR_CODE
(
ch≠ãrsPîVﬁume
 > 
•¨£Ch≠ãrsPîVﬁume
,

48 
UDS_INVALID_ARGUMENT
,

51 
•¨£Ch≠ãrsPîVﬁume
,

52 
ch≠ãrsPîVﬁume
);

53 i‡(
ªsu…
 !
UDS_SUCCESS
) {

54  
ªsu…
;

57 
geomëry
->
byãsPîPage
 = bytesPerPage;

58 
geomëry
->
ªc‹dPagesPîCh≠ãr
 =ÑecordPagesPerChapter;

59 
geomëry
->
ch≠ãrsPîVﬁume
 = chaptersPerVolume;

60 
geomëry
->
•¨£Ch≠ãrsPîVﬁume
 = sparseChaptersPerVolume;

61 
geomëry
->
dí£Ch≠ãrsPîVﬁume
 =

62 
ch≠ãrsPîVﬁume
 - 
•¨£Ch≠ãrsPîVﬁume
;

65 
geomëry
->
ªc‹dsPîPage
 = 
byãsPîPage
 / 
BYTES_PER_RECORD
;

66 
geomëry
->
ªc‹dsPîCh≠ãr


67 
geomëry
->
ªc‹dsPîPage
 * 
ªc‹dPagesPîCh≠ãr
;

68 
geomëry
->
ªc‹dsPîVﬁume


69 (Ë
geomëry
->
ªc‹dsPîCh≠ãr
 * 
ch≠ãrsPîVﬁume
;

70 
geomëry
->
›íCh≠ãrLﬂdR©io
 = 
DEFAULT_OPEN_CHAPTER_LOAD_RATIO
;

73 
geomëry
->
ch≠ãrMónDñè
 = 1 << 
DEFAULT_CHAPTER_MEAN_DELTA_BITS
;

74 
geomëry
->
ch≠ãrPaylﬂdBôs
 = 
	`compuãBôs
(
ªc‹dPagesPîCh≠ãr
 - 1);

77 
geomëry
->
ch≠ãrDñèLi°Bôs


78 
	`compuãBôs
((
geomëry
->
ªc‹dsPîCh≠ãr
 - 1) | 077) - 6;

79 
geomëry
->
dñèLi°sPîCh≠ãr
 = 1 << geomëry->
ch≠ãrDñèLi°Bôs
;

81 
geomëry
->
ch≠ãrAddªssBôs


82 (
DEFAULT_CHAPTER_MEAN_DELTA_BITS
 - 
geomëry
->
ch≠ãrDñèLi°Bôs


83 + 
	`compuãBôs
(
geomëry
->
ªc‹dsPîCh≠ãr
 - 1));

85 
geomëry
->
ödexPagesPîCh≠ãr


86 
	`gëDñèIndexPageCou¡
(
geomëry
->
ªc‹dsPîCh≠ãr
,

87 
geomëry
->
dñèLi°sPîCh≠ãr
,

88 
geomëry
->
ch≠ãrMónDñè
,

89 
geomëry
->
ch≠ãrPaylﬂdBôs
,

90 
byãsPîPage
);

94 
geomëry
->
∑gesPîCh≠ãr


95 
geomëry
->
ödexPagesPîCh≠ãr
 + 
ªc‹dPagesPîCh≠ãr
;

96 
geomëry
->
∑gesPîVﬁume
 = geomëry->
∑gesPîCh≠ãr
 * 
ch≠ãrsPîVﬁume
;

97 
geomëry
->
hódîPagesPîVﬁume
 = 1;

98 
geomëry
->
byãsPîVﬁume
 = 
byãsPîPage
 *

99 (
geomëry
->
∑gesPîVﬁume
 + geomëry->
hódîPagesPîVﬁume
);

100 
geomëry
->
byãsPîCh≠ãr
 = 
byãsPîPage
 * geomëry->
∑gesPîCh≠ãr
;

101 
geomëry
->
ªc‹dPageOff£t
 = geomëry->
ödexPagesPîCh≠ãr
 * 
byãsPîPage
;

103  
UDS_SUCCESS
;

104 
	}
}

107 
	$makeGeomëry
(
size_t
 
byãsPîPage
,

108 
ªc‹dPagesPîCh≠ãr
,

109 
ch≠ãrsPîVﬁume
,

110 
•¨£Ch≠ãrsPîVﬁume
,

111 
Geomëry
 **
geomëryPå
)

113 
Geomëry
 *
geomëry
;

114 
ªsu…
 = 
	`ALLOCATE
(1, 
Geomëry
, "geomëry", &
geomëry
);

115 i‡(
ªsu…
 !
UDS_SUCCESS
) {

116  
ªsu…
;

118 
ªsu…
 = 
	`öôülizeGeomëry
(
geomëry
, 
byãsPîPage
, 
ªc‹dPagesPîCh≠ãr
,

119 
ch≠ãrsPîVﬁume
, 
•¨£Ch≠ãrsPîVﬁume
);

120 i‡(
ªsu…
 !
UDS_SUCCESS
) {

121 
	`‰ìGeomëry
(
geomëry
);

122  
ªsu…
;

125 *
geomëryPå
 = 
geomëry
;

126  
UDS_SUCCESS
;

127 
	}
}

130 
	$c›yGeomëry
(
Geomëry
 *
sour˚
, Geomëry **
geomëryPå
)

132  
	`makeGeomëry
(
sour˚
->
byãsPîPage
,

133 
sour˚
->
ªc‹dPagesPîCh≠ãr
,

134 
sour˚
->
ch≠ãrsPîVﬁume
,

135 
sour˚
->
•¨£Ch≠ãrsPîVﬁume
,

136 
geomëryPå
);

137 
	}
}

140 
boﬁ
 
	$vîifyGeomëry
(c⁄° 
Geomëry
 *
ex≥˘ed
, c⁄° Geomëry *
a˘uÆ
)

142  (
ex≥˘ed
->
byãsPîPage
 =
a˘uÆ
->bytesPerPage) &&

143 (
ex≥˘ed
->
ªc‹dPagesPîCh≠ãr
 =
a˘uÆ
->recordPagesPerChapter) &&

144 (
ex≥˘ed
->
ch≠ãrsPîVﬁume
 =
a˘uÆ
->chaptersPerVolume) &&

145 (
ex≥˘ed
->
•¨£Ch≠ãrsPîVﬁume
 =
a˘uÆ
->sparseChaptersPerVolume) &&

146 (
ex≥˘ed
->
dí£Ch≠ãrsPîVﬁume
 =
a˘uÆ
->denseChaptersPerVolume) &&

147 (
ex≥˘ed
->
dí£Ch≠ãrsPîVﬁume
 ==

148 (
ex≥˘ed
->
ch≠ãrsPîVﬁume
 -Éx≥˘ed->
•¨£Ch≠ãrsPîVﬁume
)) &&

149 (
ex≥˘ed
->
ch≠ãrDñèLi°Bôs
 =
a˘uÆ
->chapterDeltaListBits) &&

150 (
ex≥˘ed
->
∑gesPîVﬁume
 =
a˘uÆ
->pagesPerVolume) &&

151 (
ex≥˘ed
->
byãsPîVﬁume
 =
a˘uÆ
->bytesPerVolume) &&

152 (
ex≥˘ed
->
byãsPîCh≠ãr
 =
a˘uÆ
->bytesPerChapter) &&

153 (
ex≥˘ed
->
∑gesPîCh≠ãr
 =
a˘uÆ
->pagesPerChapter) &&

154 (
ex≥˘ed
->
ödexPagesPîCh≠ãr
 =
a˘uÆ
->indexPagesPerChapter) &&

155 (
ex≥˘ed
->
›íCh≠ãrLﬂdR©io
 =
a˘uÆ
->openChapterLoadRatio) &&

156 (
ex≥˘ed
->
ªc‹dsPîPage
 =
a˘uÆ
->recordsPerPage) &&

157 (
ex≥˘ed
->
ªc‹dsPîCh≠ãr
 =
a˘uÆ
->recordsPerChapter) &&

158 (
ex≥˘ed
->
ªc‹dsPîVﬁume
 =
a˘uÆ
->recordsPerVolume) &&

159 (
ex≥˘ed
->
ªc‹dPageOff£t
 =
a˘uÆ
->recordPageOffset) &&

160 (
ex≥˘ed
->
dñèLi°sPîCh≠ãr
 =
a˘uÆ
->deltaListsPerChapter) &&

161 (
ex≥˘ed
->
ch≠ãrMónDñè
 =
a˘uÆ
->chapterMeanDelta) &&

162 (
ex≥˘ed
->
ch≠ãrPaylﬂdBôs
 =
a˘uÆ
->chapterPayloadBits) &&

163 (
ex≥˘ed
->
ch≠ãrAddªssBôs
 =
a˘uÆ
->chapterAddressBits);

164 
	}
}

167 
	$‰ìGeomëry
(
Geomëry
 *
geomëry
)

169 
	`FREE
(
geomëry
);

170 
	}
}

173 
uöt64_t
 
	$m≠ToVútuÆCh≠ãrNumbî
(
Geomëry
 *
geomëry
,

174 
uöt64_t
 
√we°VútuÆCh≠ãr
,

175 
physiˇlCh≠ãr
)

177 
√we°PhysiˇlCh≠ãr


178 
	`m≠ToPhysiˇlCh≠ãr
(
geomëry
, 
√we°VútuÆCh≠ãr
);

179 
uöt64_t
 
vútuÆCh≠ãr


180 
√we°VútuÆCh≠ãr
 - 
√we°PhysiˇlCh≠ãr
 + 
physiˇlCh≠ãr
;

181 i‡(
physiˇlCh≠ãr
 > 
√we°PhysiˇlCh≠ãr
) {

182 
vútuÆCh≠ãr
 -
geomëry
->
ch≠ãrsPîVﬁume
;

184  
vútuÆCh≠ãr
;

185 
	}
}

188 
boﬁ
 
	$hasS∑r£Ch≠ãrs
(c⁄° 
Geomëry
 *
geomëry
,

189 
uöt64_t
 
ﬁde°VútuÆCh≠ãr
,

190 
uöt64_t
 
√we°VútuÆCh≠ãr
)

192  (
	`isS∑r£
(
geomëry
)

193 && ((
√we°VútuÆCh≠ãr
 - 
ﬁde°VútuÆCh≠ãr
 + 1)

194 > 
geomëry
->
dí£Ch≠ãrsPîVﬁume
));

195 
	}
}

198 
boﬁ
 
	$isCh≠ãrS∑r£
(c⁄° 
Geomëry
 *
geomëry
,

199 
uöt64_t
 
ﬁde°VútuÆCh≠ãr
,

200 
uöt64_t
 
√we°VútuÆCh≠ãr
,

201 
uöt64_t
 
vútuÆCh≠ãrNumbî
)

203  (
	`hasS∑r£Ch≠ãrs
(
geomëry
, 
ﬁde°VútuÆCh≠ãr
,

204 
√we°VútuÆCh≠ãr
)

205 && ((
vútuÆCh≠ãrNumbî
 + 
geomëry
->
dí£Ch≠ãrsPîVﬁume
)

206 <
√we°VútuÆCh≠ãr
));

207 
	}
}

210 
boﬁ
 
	$¨eSamePhysiˇlCh≠ãr
(c⁄° 
Geomëry
 *
geomëry
,

211 
uöt64_t
 
ch≠ãr1
,

212 
uöt64_t
 
ch≠ãr2
)

214  ((
ch≠ãr1
 % 
geomëry
->
ch≠ãrsPîVﬁume
)

215 =(
ch≠ãr2
 % 
geomëry
->
ch≠ãrsPîVﬁume
));

216 
	}
}

	@uds/geometry.h

22 #i‚de‡
GEOMETRY_H


23 
	#GEOMETRY_H
 1

	)

25 
	~"compûî.h
"

26 
	~"ty≥Defs.h
"

27 
	~"uds.h
"

28 
	~"uds-block.h
"

52 
	sgeomëry
 {

54 
size_t
 
	mbyãsPîPage
;

56 
	mªc‹dPagesPîCh≠ãr
;

58 
	mch≠ãrsPîVﬁume
;

60 
	m•¨£Ch≠ãrsPîVﬁume
;

62 
	mch≠ãrDñèLi°Bôs
;

66 
	m∑gesPîVﬁume
;

68 
	mhódîPagesPîVﬁume
;

70 
size_t
 
	mbyãsPîVﬁume
;

72 
size_t
 
	mbyãsPîCh≠ãr
;

74 
	m∑gesPîCh≠ãr
;

76 
	mödexPagesPîCh≠ãr
;

78 
	m›íCh≠ãrLﬂdR©io
;

80 
	mªc‹dsPîPage
;

82 
	mªc‹dsPîCh≠ãr
;

84 
uöt64_t
 
	mªc‹dsPîVﬁume
;

86 
	mªc‹dPageOff£t
;

88 
	mdñèLi°sPîCh≠ãr
;

90 
	mch≠ãrMónDñè
;

92 
	mch≠ãrPaylﬂdBôs
;

94 
	mch≠ãrAddªssBôs
;

96 
	mdí£Ch≠ãrsPîVﬁume
;

97 } 
	tGeomëry
;

101 
	mBYTES_PER_RECORD
 = (
UDS_CHUNK_NAME_SIZE
 + 
UDS_MAX_BLOCK_DATA_SIZE
),

104 
	mDEFAULT_BYTES_PER_PAGE
 = 1024 * 
BYTES_PER_RECORD
,

107 
	mDEFAULT_RECORDS_PER_PAGE
 = 
DEFAULT_BYTES_PER_PAGE
 / 
BYTES_PER_RECORD
,

110 
	mDEFAULT_RECORD_PAGES_PER_CHAPTER
 = 256,

113 
	mSMALL_RECORD_PAGES_PER_CHAPTER
 = 64,

116 
	mDEFAULT_CHAPTERS_PER_VOLUME
 = 1024,

119 
	mDEFAULT_SPARSE_CHAPTERS_PER_VOLUME
 = 0,

122 
	mDEFAULT_CHAPTER_MEAN_DELTA_BITS
 = 16,

125 
	mDEFAULT_CHAPTER_DELTA_LIST_BITS
 = 12,

128 
	mSMALL_CHAPTER_DELTA_LIST_BITS
 = 10,

131 
	mDEFAULT_OPEN_CHAPTER_LOAD_RATIO
 = 2,

134 
	mDEFAULT_CHECKPOINT_FREQUENCY
 = 0

149 
	$makeGeomëry
(
size_t
 
byãsPîPage
,

150 
ªc‹dPagesPîCh≠ãr
,

151 
ch≠ãrsPîVﬁume
,

152 
•¨£Ch≠ãrsPîVﬁume
,

153 
Geomëry
 **
geomëryPå
)

154 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

165 
	$c›yGeomëry
(
Geomëry
 *
sour˚
,

166 
Geomëry
 **
geomëryPå
)

167 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

179 
boﬁ
 
	$vîifyGeomëry
(c⁄° 
Geomëry
 *
ex≥˘ed
, c⁄° Geomëry *
a˘uÆ
)

180 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

187 
	`‰ìGeomëry
(
Geomëry
 *
geomëry
);

197 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
))

198 
INLINE
 
	$m≠ToPhysiˇlCh≠ãr
(c⁄° 
Geomëry
 *
geomëry
,

199 
uöt64_t
 
vútuÆCh≠ãr
)

201  (
vútuÆCh≠ãr
 % 
geomëry
->
ch≠ãrsPîVﬁume
);

202 
	}
}

214 
uöt64_t
 
m≠ToVútuÆCh≠ãrNumbî
(
Geomëry
 *
geomëry
,

215 
uöt64_t
 
√we°VútuÆCh≠ãr
,

216 
physiˇlCh≠ãr
);

225 
__©åibuã__
((
w¨n_unu£d_ªsu…
))

226 
INLINE
 
boﬁ
 
	$isS∑r£
(c⁄° 
Geomëry
 *
geomëry
)

228  (
geomëry
->
•¨£Ch≠ãrsPîVﬁume
 > 0);

229 
	}
}

242 
boﬁ
 
	$hasS∑r£Ch≠ãrs
(c⁄° 
Geomëry
 *
geomëry
,

243 
uöt64_t
 
ﬁde°VútuÆCh≠ãr
,

244 
uöt64_t
 
√we°VútuÆCh≠ãr
)

245 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

257 
boﬁ
 
	$isCh≠ãrS∑r£
(c⁄° 
Geomëry
 *
geomëry
,

258 
uöt64_t
 
ﬁde°VútuÆCh≠ãr
,

259 
uöt64_t
 
√we°VútuÆCh≠ãr
,

260 
uöt64_t
 
vútuÆCh≠ãrNumbî
)

261 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

274 
boﬁ
 
	$¨eSamePhysiˇlCh≠ãr
(c⁄° 
Geomëry
 *
geomëry
,

275 
uöt64_t
 
ch≠ãr1
,

276 
uöt64_t
 
ch≠ãr2
)

277 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

	@uds/grid.c

22 
	~"grid.h
"

24 
	~"hashUtûs.h
"

25 
	~"loˇlIndexRouãr.h
"

26 
	~"loggî.h
"

27 
	~"mem‹yAŒoc.h
"

28 
	~"thªads.h
"

31 
	sfûlD©a
 {

33 
IndexRouãr
 *
	mrouãr
;

35 
	m£ed
;

37 
	mªsu…
;

41 
	$¥ötU£rC⁄figuøti⁄
(
Grid
 *
grid
)

43 *
udsC⁄figSåög
;

44 
ªsu…
 = 
	`¥ötUdsC⁄figuøti⁄
(&
grid
->
u£rC⁄fig
, 2, &
udsC⁄figSåög
);

45 i‡(
ªsu…
 =
UDS_SUCCESS
) {

46 
	`logDebug
("C⁄figuøti⁄:\n%s", 
udsC⁄figSåög
);

48 
	`logEº‹WôhSåögEº‹
(
ªsu…
, "Failedállocate configuration string");

50 
	`FREE
(
udsC⁄figSåög
);

51  
ªsu…
;

52 
	}
}

55 
	$makeLoˇlGrid
(
IndexLayout
 *
œyout
,

56 
LﬂdTy≥
 
lﬂdTy≥
,

57 
UdsC⁄figuøti⁄
 
u£rC⁄fig
,

58 
IndexRouãrCÆlback
 
ödexCÆlback
,

59 
Grid
 **
grid
)

61 
Grid
 *
√wGrid
;

62 
ªsu…
 = 
	`ALLOCATE
(1, 
grid
, "grid", &
√wGrid
);

63 i‡(
ªsu…
 !
UDS_SUCCESS
) {

64  
ªsu…
;

67 i‡(
u£rC⁄fig
 !
NULL
) {

68 
√wGrid
->
u£rC⁄fig
 = *userConfig;

71 i‡(
lﬂdTy≥
 =
LOAD_CREATE
) {

72 
ªsu…
 = 
	`wrôeIndexC⁄fig
(
œyout
, &
√wGrid
->
u£rC⁄fig
);

74 
ªsu…
 = 
	`ªadIndexC⁄fig
(
œyout
, &
√wGrid
->
u£rC⁄fig
);

77 i‡(
ªsu…
 !
UDS_SUCCESS
) {

78 
	`‰ìGrid
(
√wGrid
);

79  
ªsu…
;

82 
√wGrid
->
numRouãrs
 = 1;

83 
ªsu…
 = 
	`ALLOCATE
(1,

84 
IndexRouãr
 *,

86 &
√wGrid
->
rouãrs
);

87 i‡(
ªsu…
 !
UDS_SUCCESS
) {

88 
	`logEº‹WôhSåögEº‹
(
ªsu…
, "FailedÅoállocateÑouters");

89 
	`‰ìGrid
(
√wGrid
);

90  
ªsu…
;

93 
C⁄figuøti⁄
 *
ödexC⁄fig
;

94 
ªsu…
 = 
	`makeC⁄figuøti⁄
(&
√wGrid
->
u£rC⁄fig
, &
ödexC⁄fig
);

95 i‡(
ªsu…
 !
UDS_SUCCESS
) {

96 
	`logEº‹WôhSåögEº‹
(
ªsu…
, "FailedÅoállocate config");

97 
	`‰ìGrid
(
√wGrid
);

98  
ªsu…
;

101 
ªsu…
 = 
	`makeLoˇlIndexRouãr
(
œyout
,

102 
ödexC⁄fig
,

103 
lﬂdTy≥
,

104 
ödexCÆlback
,

105 &
√wGrid
->
rouãrs
[0]);

106 
	`‰ìC⁄figuøti⁄
(
ödexC⁄fig
);

107 i‡(
ªsu…
 !
UDS_SUCCESS
) {

108 
	`logEº‹WôhSåögEº‹
(
ªsu…
, "FailedÅo makeÑouter");

109 
	`‰ìGrid
(
√wGrid
);

110  
ªsu…
;

113 
ªsu…
 = 
	`¥ötU£rC⁄figuøti⁄
(
√wGrid
);

114 i‡(
ªsu…
 !
UDS_SUCCESS
) {

115 
	`‰ìGrid
(
√wGrid
);

116  
ªsu…
;

121 
√wGrid
->
œyout
 =Üayout;

122 *
grid
 = 
√wGrid
;

123  
UDS_SUCCESS
;

124 
	}
}

127 
IndexRouãr
 *
	$£À˘GridRouãr
(
Grid
 *
grid
, 
UdsChunkName
 *
«me
)

129 
gridByãs
 = 
	`exåa˘GridRouãrByãs
(
«me
);

130 
numRouãrs
 = 
grid
->numRouters;

131 
rouãrNumbî
 = (
numRouãrs
 =1Ë? 0 : (
gridByãs
 %ÇumRouters);

132  
grid
->
rouãrs
[
rouãrNumbî
];

133 
	}
}

136 
	$gëGridSèti°ics
(
Grid
 *
grid
, 
IndexRouãrSètCou¡îs
 *
cou¡îs
)

138 
	`mem£t
(
cou¡îs
, 0, (
IndexRouãrSètCou¡îs
));

139 
i
 = 0; i < 
grid
->
numRouãrs
; i++) {

140 
IndexRouãr
 *
rouãr
 = 
grid
->
rouãrs
[
i
];

141 
IndexRouãrSètCou¡îs
 
rouãrSèts
;

142 
ªsu…
 = 
rouãr
->
mëhods
->
	`gëSèti°ics
‘ouãr, &
rouãrSèts
);

143 i‡(
ªsu…
 !
UDS_SUCCESS
) {

144  
ªsu…
;

146 
cou¡îs
->
íåõsIndexed
 +
rouãrSèts
.entriesIndexed;

147 
cou¡îs
->
mem‹yU£d
 +
rouãrSèts
.memoryUsed;

148 
cou¡îs
->
diskU£d
 +
rouãrSèts
.diskUsed;

149 
cou¡îs
->
cﬁlisi⁄s
 +
rouãrSèts
.collisions;

150 
cou¡îs
->
íåõsDisˇrded
 +
rouãrSèts
.entriesDiscarded;

151 
cou¡îs
->
checkpoöts
 +
rouãrSèts
.checkpoints;

152 
	`addCacheCou¡îs
(&
cou¡îs
->
vﬁumeCache
, 
rouãrSèts
.volumeCache);

154  
UDS_SUCCESS
;

155 
	}
}

158 
	$£tGridCheckpoötFªquícy
(
Grid
 *
grid
, 
‰equícy
)

160 
i
 = 0; i < 
grid
->
numRouãrs
; i++) {

161 
IndexRouãr
 *
rouãr
 = 
grid
->
rouãrs
[
i
];

162 
rouãr
->
mëhods
->
	`£tCheckpoötFªquícy
‘ouãr, 
‰equícy
);

164  
UDS_SUCCESS
;

165 
	}
}

168 
	$ßveGrid
(
Grid
 *
grid
)

170 i‡(
grid
 =
NULL
) {

171  
UDS_SUCCESS
;

174 
ªsu…
 = 
UDS_SUCCESS
;

175 
i
 = 0; i < 
grid
->
numRouãrs
; i++) {

176 
IndexRouãr
 *
rouãr
 = 
grid
->
rouãrs
[
i
];

177 i‡(
rouãr
 !
NULL
) {

178 
ªsu…
 = 
rouãr
->
mëhods
->
	`ßveSèã
(router);

179 i‡(
ªsu…
 !
UDS_SUCCESS
) {

180 
	`logW¨nögWôhSåögEº‹
(
ªsu…
, "indexÑouter save stateÖroblem");

184  
ªsu…
;

185 
	}
}

188 
	$‰ìGrid
(
Grid
 *
grid
)

190 i‡(
grid
 =
NULL
) {

194 
i
 = 0; i < 
grid
->
numRouãrs
; i++) {

195 
	`‰ìIndexRouãr
(
grid
->
rouãrs
[
i
]);

197 
	`‰ìIndexLayout
(&
grid
->
œyout
);

198 
	`FREE
(
grid
->
rouãrs
);

199 
	`FREE
(
grid
);

200 
	}
}

	@uds/grid.h

22 #i‚de‡
GRID_H


23 
	#GRID_H


	)

25 
	~"compûî.h
"

26 
	~"c⁄fig.h
"

27 
	~"lﬂdTy≥.h
"

28 
	~"ödexLayout.h
"

29 
	~"ödexRouãr.h
"

31 
	sgrid
 {

32 
udsC⁄figuøti⁄
 
	mu£rC⁄fig
;

33 
	mnumRouãrs
;

34 
IndexRouãr
 **
	mrouãrs
;

35 
IndexLayout
 *
	mœyout
;

52 
	$makeLoˇlGrid
(
IndexLayout
 *
œyout
,

53 
LﬂdTy≥
 
lﬂdTy≥
,

54 
UdsC⁄figuøti⁄
 
u£rC⁄fig
,

55 
IndexRouãrCÆlback
 
ödexCÆlback
,

56 
Grid
 **
grid
)

57 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

68 
	$makeRemŸeGrid
(
UdsGridC⁄fig
 
gridC⁄fig
,

69 
IndexRouãrCÆlback
 
ödexCÆlback
,

70 
Grid
 **
grid
)

71 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

81 
IndexRouãr
 *
	$£À˘GridRouãr
(
Grid
 *
grid
, 
UdsChunkName
 *
«me
)

82 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

92 
	$gëGridSèti°ics
(
Grid
 *
grid
, 
IndexRouãrSètCou¡îs
 *
°©s
)

93 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

103 
	$£tGridCheckpoötFªquícy
(
Grid
 *
grid
, 
‰equícy
)

104 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

113 
	$ßveGrid
(
Grid
 *
grid
Ë
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

120 
	`‰ìGrid
(
Grid
 *
grid
);

129 
INLINE
 
boﬁ
 
	$isGridLoˇl
(
Grid
 *
grid
)

131  
	`isRouãrLoˇl
(
grid
->
rouãrs
[0]);

132 
	}
}

	@uds/hashUtils.c

22 
	~"hashUtûs.h
"

24 
	~"îr‹s.h
"

25 
	~"loggî.h
"

26 
	~"≥rmas£π.h
"

27 
	~"°rögUtûs.h
"

28 
	~"uds.h
"

42 
	$d©aToHex
(c⁄° *
d©a
, 
size_t
 
d©aLí
,

43 *
hex
, 
size_t
 
hexLí
)

45 i‡(
hexLí
 < 2 * 
d©aLí
 + 1) {

46  
	`logW¨nögWôhSåögEº‹
(
UDS_INVALID_ARGUMENT
,

49 
size_t
 
i
 = 0; i < 
d©aLí
; ++i) {

50 
rc
 = 
	`fixedS¥ötf
(
__func__
, &
hex
[2 * 
i
], 
hexLí
 - (2 * i),

51 
UDS_INVALID_ARGUMENT
, "%02X", 
d©a
[
i
]);

53 i‡(
rc
 !
UDS_SUCCESS
) {

54  
rc
;

57  
UDS_SUCCESS
;

58 
	}
}

61 
	$chunkNameToHex
(c⁄° 
UdsChunkName
 *
chunkName
,

62 *
hexD©a
, 
size_t
 
hexD©aLí
)

64  
	`d©aToHex
(
chunkName
->
«me
, 
UDS_CHUNK_NAME_SIZE
,

65 
hexD©a
, 
hexD©aLí
);

66 
	}
}

69 
	$chunkD©aToHex
(c⁄° 
UdsChunkD©a
 *
chunkD©a
,

70 *
hexD©a
, 
size_t
 
hexD©aLí
)

72  
	`d©aToHex
(
chunkD©a
->
d©a
, 
UDS_MAX_BLOCK_DATA_SIZE
,

73 
hexD©a
, 
hexD©aLí
);

74 
	}
}

77 
	$compuãBôs
(
maxVÆue
)

83 
bôs
 = 0;

84 
maxVÆue
 > 0) {

85 
maxVÆue
 >>= 1;

86 
bôs
++;

88  
bôs
;

89 
	}
}

92 
	$hashUtûsCompûeTimeAs£πi⁄s
()

94 
	`STATIC_ASSERT
((
UDS_CHUNK_NAME_SIZE
 % (
uöt64_t
)) == 0);

95 
	`STATIC_ASSERT
((
UDS_CHUNK_NAME_SIZE
 == 32) || (UDS_CHUNK_NAME_SIZE == 16));

96 
	}
}

	@uds/hashUtils.h

22 #i‚de‡
HASH_UTILS_H


23 
	#HASH_UTILS_H
 1

	)

25 
	~"compûî.h
"

26 
	~"comm⁄.h
"

27 
	~"geomëry.h
"

28 
	~"murmur/MurmurHash3.h
"

29 
	~"numîic.h
"

30 
	~"uds.h
"

33 #i‡
UDS_CHUNK_NAME_SIZE
 == 16

35 
	mMASTER_INDEX_BYTES_OFFSET
 = 0,

36 
	mCHAPTER_INDEX_BYTES_OFFSET
 = 8,

37 
	mSAMPLE_BYTES_OFFSET
 = 14,

38 
	mMASTER_INDEX_BYTES_COUNT
 = 8,

39 
	mCHAPTER_INDEX_BYTES_COUNT
 = 6,

40 
	mSAMPLE_BYTES_COUNT
 = 2,

44 
	mSAMPLE_BYTES_OFFSET
 = 0,

45 
	mCHAPTER_INDEX_BYTES_OFFSET
 = 12,

46 
	mGRID_BYTES_OFFSET
 = 20,

47 
	mMASTER_INDEX_BYTES_OFFSET
 = 24,

48 
	mSAMPLE_BYTES_COUNT
 = 4,

49 
	mCHAPTER_INDEX_BYTES_COUNT
 = 8,

50 
	mGRID_BYTES_COUNT
 = 4,

51 
	mMASTER_INDEX_BYTES_COUNT
 = 8

62 
INLINE
 
uöt64_t
 
	$exåa˘Ch≠ãrIndexByãs
(c⁄° 
UdsChunkName
 *
«me
)

64 i‡(
UDS_CHUNK_NAME_SIZE
 == 16) {

66 
uöt64_t
 
byãs


67 (
uöt64_t
Ë
	`gëUI¡16BE
(&
«me
->«me[
CHAPTER_INDEX_BYTES_OFFSET
]) << 32;

68 
byãs
 |
	`gëUI¡32BE
(&
«me
->«me[
CHAPTER_INDEX_BYTES_OFFSET
 + 2]);

69  
byãs
;

71  
	`gëUI¡64BE
(&
«me
->«me[
CHAPTER_INDEX_BYTES_OFFSET
]);

73 
	}
}

82 
INLINE
 
uöt32_t
 
exåa˘GridRouãrByãs
(c⁄° 
UdsChunkName
 *
«me


83 
__©åibuã__
((
unu£d
)))

85 #i‡
UDS_CHUNK_NAME_SIZE
 == 16

88  
gëUI¡32BE
(&
«me
->«me[
GRID_BYTES_OFFSET
]);

99 
INLINE
 
uöt64_t
 
	$exåa˘Ma°îIndexByãs
(c⁄° 
UdsChunkName
 *
«me
)

101  
	`gëUI¡64BE
(&
«me
->«me[
MASTER_INDEX_BYTES_OFFSET
]);

102 
	}
}

111 
INLINE
 
uöt32_t
 
	$exåa˘Sam∂ögByãs
(c⁄° 
UdsChunkName
 *
«me
)

113 i‡(
UDS_CHUNK_NAME_SIZE
 == 16) {

114  
	`gëUI¡16BE
(&
«me
->«me[
SAMPLE_BYTES_OFFSET
]);

116  
	`gëUI¡32BE
(&
«me
->«me[
SAMPLE_BYTES_OFFSET
]);

118 
	}
}

128 
INLINE
 
	$hashToCh≠ãrDñèLi°
(c⁄° 
UdsChunkName
 *
«me
,

129 c⁄° 
Geomëry
 *
geomëry
)

131 i‡(
UDS_CHUNK_NAME_SIZE
 == 16) {

132  (Ë((
	`exåa˘Ch≠ãrIndexByãs
(
«me
)

133 >> 
geomëry
->
ch≠ãrAddªssBôs
)

134 & ((1 << 
geomëry
->
ch≠ãrDñèLi°Bôs
) - 1));

136  (Ë((
	`exåa˘Ch≠ãrIndexByãs
(
«me
))

137 & ((1 << 
geomëry
->
ch≠ãrDñèLi°Bôs
) - 1));

139 
	}
}

149 
INLINE
 
	$hashToCh≠ãrDñèAddªss
(c⁄° 
UdsChunkName
 *
«me
,

150 c⁄° 
Geomëry
 *
geomëry
)

152 i‡(
UDS_CHUNK_NAME_SIZE
 == 16) {

153  (Ë(
	`exåa˘Ch≠ãrIndexByãs
(
«me
)

154 & ((1 << 
geomëry
->
ch≠ãrAddªssBôs
) - 1));

157  (Ë((
	`exåa˘Ch≠ãrIndexByãs
(
«me
) >> 32)

158 & ((1 << 
geomëry
->
ch≠ãrAddªssBôs
) - 1));

160 
	}
}

172 
INLINE
 
	$«meToHashSlŸ
(c⁄° 
UdsChunkName
 *
«me
,

173 
¶ŸCou¡
)

175  (Ë(
	`exåa˘Ch≠ãrIndexByãs
(
«me
Ë% 
¶ŸCou¡
);

176 
	}
}

189 
	$chunkNameToHex
(c⁄° 
UdsChunkName
 *
chunkName
,

190 *
hexD©a
,

191 
size_t
 
hexD©aLí
)

192 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

205 
	$chunkD©aToHex
(c⁄° 
UdsChunkD©a
 *
chunkD©a
,

206 *
hexD©a
,

207 
size_t
 
hexD©aLí
)

208 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

218 
	$compuãBôs
(
maxVÆue
)

219 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

231 
INLINE
 
UdsChunkName
 
	$murmurHashChunkName
(c⁄° *
d©a
,

232 
size_t
 
size
,

233 
uöt32_t
 
£ed
)

236 íum { 
SEED1
 = 0x62ó60be, 
SEED2
 = 0x3eeb36cd };

237 
UdsChunkName
 
«me
;

238 i‡(
UDS_CHUNK_NAME_SIZE
 == 16) {

239 
	`MurmurHash3_x64_128
(
d©a
, 
size
, 
SEED1
 ^ 
£ed
, &
«me
.name[0]);

241 
	`MurmurHash3_x64_128_doubÀ
(
d©a
, 
size
, 
SEED1
 ^ 
£ed
, 
SEED2
 ^ seed,

242 &
«me
.name[0]);

244  
«me
;

245 
	}
}

257 
INLINE
 
UdsChunkName
 
	$murmurGíî©‹
(c⁄° *
d©a
, 
size_t
 
size
)

259  
	`murmurHashChunkName
(
d©a
, 
size
, 0);

260 
	}
}

268 
INLINE
 
	$£tCh≠ãrIndexByãs
(
UdsChunkName
 *
«me
, 
uöt64_t
 
vÆue
)

270 i‡(
UDS_CHUNK_NAME_SIZE
 == 16) {

272 
	`°‹eUI¡16BE
(&
«me
->«me[
CHAPTER_INDEX_BYTES_OFFSET
],

273 (
uöt16_t
)(
vÆue
 >> 32));

274 
	`°‹eUI¡32BE
(&
«me
->«me[
CHAPTER_INDEX_BYTES_OFFSET
 + 2],

275 (
uöt32_t
)
vÆue
);

277 
	`°‹eUI¡64BE
(&
«me
->«me[
CHAPTER_INDEX_BYTES_OFFSET
], 
vÆue
);

279 
	}
}

288 
INLINE
 
	$£tCh≠ãrDñèLi°Bôs
(
UdsChunkName
 *
«me
,

289 c⁄° 
Geomëry
 *
geomëry
,

290 
uöt64_t
 
vÆue
)

292 
uöt64_t
 
dñèAddªss
 = 
	`hashToCh≠ãrDñèAddªss
(
«me
, 
geomëry
);

293 i‡(
UDS_CHUNK_NAME_SIZE
 == 16) {

294 
dñèAddªss
 |
vÆue
 << 
geomëry
->
ch≠ãrAddªssBôs
;

295 
	`£tCh≠ãrIndexByãs
(
«me
, 
dñèAddªss
);

298 
	`£tCh≠ãrIndexByãs
(
«me
, (
dñèAddªss
 << 32Ë| 
vÆue
);

300 
	}
}

308 
INLINE
 
	$£tMa°îIndexByãs
(
UdsChunkName
 *
«me
, 
uöt64_t
 
vÆ
)

310 i‡(
UDS_CHUNK_NAME_SIZE
 == 16) {

311 
	`°‹eUI¡64BE
(&
«me
->«me[
MASTER_INDEX_BYTES_OFFSET
], 
vÆ
);

313 
	`°‹eUI¡64BE
(&
«me
->«me[
MASTER_INDEX_BYTES_OFFSET
], 
vÆ
);

315 
	}
}

323 
INLINE
 
	$£tSam∂ögByãs
(
UdsChunkName
 *
«me
, 
uöt32_t
 
vÆue
)

325 i‡(
UDS_CHUNK_NAME_SIZE
 == 16) {

326 
	`°‹eUI¡16BE
(&
«me
->«me[
SAMPLE_BYTES_OFFSET
], (
uöt16_t
)
vÆue
);

328 
	`°‹eUI¡32BE
(&
«me
->«me[
SAMPLE_BYTES_OFFSET
], 
vÆue
);

330 
	}
}

337 
hashUtûsCompûeTimeAs£πi⁄s
();

	@uds/index.c

22 
	~"ödex.h
"

24 
	~"hashUtûs.h
"

25 
	~"ödexCheckpoöt.h
"

26 
	~"ödexI¡î«ls.h
"

27 
	~"loggî.h
"

29 c⁄° 
uöt64_t
 
	gNO_LAST_CHECKPOINT
 = 
UINT_MAX
;

40 
	$ª∂ayIndexFromCheckpoöt
(
Index
 *
ödex
,

41 
uöt64_t
 
œ°CheckpoötCh≠ãr
)

44 
uöt64_t
 
lowe°VCN
, 
highe°VCN
;

45 
boﬁ
 
isEm±y
 = 
Ál£
;

46 
ªsu…
 = 
	`födVﬁumeCh≠ãrBound¨õs
(
ödex
->
vﬁume
, &
lowe°VCN
,

47 &
highe°VCN
, &
isEm±y
);

48 i‡(
ªsu…
 !
UDS_SUCCESS
) {

49  
	`logF©ÆWôhSåögEº‹
(
ªsu…
,

52 
ödex
->
id
);

54 i‡(
lowe°VCN
 > 
highe°VCN
) {

55 
	`logF©Æ
("index_%u: cannotÑeplay index:Ço valid chaptersÉxist",

56 
ödex
->
id
);

57  
UDS_CORRUPT_COMPONENT
;

60 i‡(
isEm±y
) {

62 i‡(
ödex
->
√we°VútuÆCh≠ãr
 != 0) {

63 
	`logF©Æ
("ödex_%u: c™nŸÑïœy index fromÉm±y vﬁume", 
ödex
->
id
);

64  
UDS_CORRUPT_COMPONENT
;

66  
UDS_SUCCESS
;

69 
ch≠ãrsPîVﬁume
 = 
ödex
->
vﬁume
->
geomëry
->chaptersPerVolume;

70 
ödex
->
ﬁde°VútuÆCh≠ãr
 = 
lowe°VCN
;

71 
ödex
->
√we°VútuÆCh≠ãr
 = 
highe°VCN
 + 1;

72 i‡(
ödex
->
√we°VútuÆCh≠ãr
 =
lowe°VCN
 + 
ch≠ãrsPîVﬁume
) {

74 
ödex
->
ﬁde°VútuÆCh≠ãr
++;

77 
uöt64_t
 
fú°RïœyCh≠ãr
 = 
œ°CheckpoötCh≠ãr
;

78 i‡(
fú°RïœyCh≠ãr
 < 
ödex
->
ﬁde°VútuÆCh≠ãr
) {

79 
fú°RïœyCh≠ãr
 = 
ödex
->
ﬁde°VútuÆCh≠ãr
;

81  
	`ª∂ayVﬁume
(
ödex
, 
fú°RïœyCh≠ãr
);

82 
	}
}

85 
	$lﬂdIndex
(
Index
 *
ödex
, 
boﬁ
 
ÆlowRïœy
)

87 
boﬁ
 
ª∂ayRequúed
 = 
Ál£
;

89 
ªsu…
 = 
	`lﬂdIndexSèã
(
ödex
->
°©e
, &
ª∂ayRequúed
);

90 i‡(
ªsu…
 !
UDS_SUCCESS
) {

91  
ªsu…
;

94 i‡(
ª∂ayRequúed
 && !
ÆlowRïœy
) {

95  
	`logEº‹WôhSåögEº‹
(

96 
UDS_INDEX_NOT_SAVED_CLEANLY
,

100 
uöt64_t
 
œ°CheckpoötCh≠ãr


101 ((
ödex
->
œ°Checkpoöt
 !
NO_LAST_CHECKPOINT
)

102 ? 
ödex
->
œ°Checkpoöt
 : 0);

104 
	`logInfo
("ödex_%u:Üﬂded index from ch≠ã∏%" 
PRIu64
 "Åhrough chapter %"

105 
PRIu64
,

106 
ödex
->
id
, index->
ﬁde°VútuÆCh≠ãr
, 
œ°CheckpoötCh≠ãr
);

108 i‡(
ª∂ayRequúed
) {

109 
ªsu…
 = 
	`ª∂ayIndexFromCheckpoöt
(
ödex
, 
œ°CheckpoötCh≠ãr
);

110 i‡(
ªsu…
 !
UDS_SUCCESS
) {

111  
ªsu…
;

115 
i
 = 0; i < 
ödex
->
z⁄eCou¡
; i++) {

116 
	`£tA˘iveCh≠ãrs
(
ödex
->
z⁄es
[
i
]);

119  
UDS_SUCCESS
;

120 
	}
}

123 
	$ªbuûdIndex
(
Index
 *
ödex
)

126 
uöt64_t
 
lowe°VCN
, 
highe°VCN
;

127 
boﬁ
 
isEm±y
 = 
Ál£
;

128 
ªsu…
 = 
	`födVﬁumeCh≠ãrBound¨õs
(
ödex
->
vﬁume
, &
lowe°VCN
,

129 &
highe°VCN
, &
isEm±y
);

130 i‡(
ªsu…
 !
UDS_SUCCESS
) {

131  
	`logF©ÆWôhSåögEº‹
(
ªsu…
,

134 
ödex
->
id
);

136 i‡(
lowe°VCN
 > 
highe°VCN
) {

137 
	`logF©Æ
("index_%u: cannotÑebuild index:Ço valid chaptersÉxist",

138 
ödex
->
id
);

139  
UDS_CORRUPT_COMPONENT
;

142 i‡(
isEm±y
) {

143 
ödex
->
√we°VútuÆCh≠ãr
 = index->
ﬁde°VútuÆCh≠ãr
 = 0;

145 
numCh≠ãrs
 = 
ödex
->
vﬁume
->
geomëry
->
ch≠ãrsPîVﬁume
;

146 
ödex
->
√we°VútuÆCh≠ãr
 = 
highe°VCN
 + 1;

147 
ödex
->
ﬁde°VútuÆCh≠ãr
 = 
lowe°VCN
;

148 i‡(
ödex
->
√we°VútuÆCh≠ãr


149 =(
ödex
->
ﬁde°VútuÆCh≠ãr
 + 
numCh≠ãrs
)) {

151 
ödex
->
ﬁde°VútuÆCh≠ãr
++;

155 i‡((
ödex
->
√we°VútuÆCh≠ãr
 - index->
ﬁde°VútuÆCh≠ãr
) >

156 
ödex
->
vﬁume
->
geomëry
->
ch≠ãrsPîVﬁume
) {

157  
	`logF©ÆWôhSåögEº‹
(
UDS_CORRUPT_COMPONENT
,

160 
ödex
->
id
);

163 
	`£tMa°îIndexO≥nCh≠ãr
(
ödex
->
ma°îIndex
, 0);

164 i‡(
isEm±y
) {

165  
UDS_SUCCESS
;

168 
ªsu…
 = 
	`ª∂ayVﬁume
(
ödex
, index->
ﬁde°VútuÆCh≠ãr
);

169 i‡(
ªsu…
 !
UDS_SUCCESS
) {

170  
ªsu…
;

173 
i
 = 0; i < 
ödex
->
z⁄eCou¡
; i++) {

174 
	`£tA˘iveCh≠ãrs
(
ödex
->
z⁄es
[
i
]);

177  
UDS_SUCCESS
;

178 
	}
}

181 
	$makeIndex
(
IndexLayout
 *
œyout
,

182 c⁄° 
C⁄figuøti⁄
 *
c⁄fig
,

183 
id
,

184 
z⁄eCou¡
,

185 
LﬂdTy≥
 
lﬂdTy≥
,

186 
Index
 **
√wIndex
)

188 
Index
 *
ödex
;

189 
ªsu…
 = 
	`ÆloˇãIndex
(
œyout
, 
c⁄fig
, 
id
, 
z⁄eCou¡
, 
lﬂdTy≥
,

190 !
READ_ONLY_INDEX
, &
ödex
);

191 i‡(
ªsu…
 !
UDS_SUCCESS
) {

192  
	`logEº‹WôhSåögEº‹
(
ªsu…
,

194 
id
);

197 
uöt64_t
 
n⁄˚
 = 0;

198 
ªsu…
 = 
	`gëVﬁumeN⁄˚
(
œyout
, 
id
, &
n⁄˚
);

199 i‡(
ªsu…
 !
UDS_SUCCESS
) {

200  
ªsu…
;

203 
ªsu…
 = 
	`makeMa°îIndex
(
c⁄fig
, 
z⁄eCou¡
, 
n⁄˚
, &
ödex
->
ma°îIndex
);

204 i‡(
ªsu…
 !
UDS_SUCCESS
) {

205 
	`‰ìIndex
(
ödex
);

206  
	`logEº‹WôhSåögEº‹
(
ªsu…
,

208 
id
);

211 
ªsu…
 = 
	`addIndexSèãComp⁄ít
(
ödex
->
°©e
, 
MASTER_INDEX_INFO
, 
NULL
,

212 
ödex
->
ma°îIndex
);

213 i‡(
ªsu…
 !
UDS_SUCCESS
) {

214 
	`‰ìIndex
(
ödex
);

215  
ªsu…
;

218 
ªsu…
 = 
	`addIndexSèãComp⁄ít
(
ödex
->
°©e
, &
INDEX_PAGE_MAP_INFO
,

219 
ödex
->
vﬁume
->
ödexPageM≠
, 
NULL
);

220 i‡(
ªsu…
 !
UDS_SUCCESS
) {

221 
	`‰ìIndex
(
ödex
);

222  
ªsu…
;

225 
ªsu…
 = 
	`makeCh≠ãrWrôî
(
ödex
, &ödex->
ch≠ãrWrôî
);

226 i‡(
ªsu…
 !
UDS_SUCCESS
) {

227 
	`‰ìIndex
(
ödex
);

228  
ªsu…
;

231 i‡((
lﬂdTy≥
 =
LOAD_LOAD
Ë|| (lﬂdTy≥ =
LOAD_REBUILD
)) {

232 i‡(!
ödex
->
exi°ed
) {

233 
	`‰ìIndex
(
ödex
);

234  
UDS_NO_INDEX
;

236 
ªsu…
 = 
	`lﬂdIndex
(
ödex
, 
lﬂdTy≥
 =
LOAD_REBUILD
);

237 i‡(
ªsu…
 !
UDS_SUCCESS
) {

238 
	`logEº‹WôhSåögEº‹
(
ªsu…
, "index_%u: index couldÇot beÜoaded",

239 
ödex
->
id
);

240 i‡(
lﬂdTy≥
 =
LOAD_REBUILD
) {

241 
ªsu…
 = 
	`ªbuûdIndex
(
ödex
);

242 i‡(
ªsu…
 !
UDS_SUCCESS
) {

243 
	`logEº‹WôhSåögEº‹
(
ªsu…
,

245 
ödex
->
id
);

250 
	`disˇrdIndexSèãD©a
(
ödex
->
°©e
);

253 i‡(
ªsu…
 !
UDS_SUCCESS
) {

254 
	`‰ìIndex
(
ödex
);

255  
	`logUƒecovîabÀ
(
ªsu…
, "ödex_%u: f©ÆÉº‹ i¿makeIndex", 
id
);

258 *
√wIndex
 = 
ödex
;

259  
UDS_SUCCESS
;

260 
	}
}

263 
	$‰ìIndex
(
Index
 *
ödex
)

265 i‡(
ödex
 =
NULL
) {

268 
	`‰ìCh≠ãrWrôî
(
ödex
->
ch≠ãrWrôî
);

270 i‡(
ödex
->
ma°îIndex
 !
NULL
) {

271 
	`‰ìMa°îIndex
(
ödex
->
ma°îIndex
);

273 
	`ªÀa£Index
(
ödex
, !
READ_ONLY_INDEX
);

274 
	}
}

277 
	$ßveIndexComp⁄íts
(
Index
 *
ödex
)

279 
ªsu…
 = 
	`föishCheckpoötög
(
ödex
);

280 i‡(
ªsu…
 !
UDS_SUCCESS
) {

281 
	`logInfo
("ödex_%u: savêÁûed", 
ödex
->
id
);

282  
ªsu…
;

284 
	`begöSave
(
ödex
, 
Ál£
, index->
√we°VútuÆCh≠ãr
);

286 
ªsu…
 = 
	`ßveIndexSèã
(
ödex
->
°©e
);

287 i‡(
ªsu…
 !
UDS_SUCCESS
) {

288 
	`logInfo
("ödex_%u: savêÁûed", 
ödex
->
id
);

289 
ödex
->
œ°Checkpoöt
 = index->
¥evCheckpoöt
;

292  
ªsu…
;

293 
	}
}

296 
	$ßveIndex
(
Index
 *
ödex
)

299 
ªsu…
 = 
	`°›Ch≠ãrWrôî
(
ödex
->
ch≠ãrWrôî
);

300 i‡(
ªsu…
 !
UDS_SUCCESS
) {

302 
	`disˇrdIndexSèãD©a
(
ödex
->
°©e
);

303  
ªsu…
;

307 
ªsu…
 = 
	`˛o£Vﬁume
(
ödex
->
vﬁume
);

308 i‡(
ªsu…
 !
UDS_SUCCESS
) {

310 
	`disˇrdIndexSèãD©a
(
ödex
->
°©e
);

311  
ªsu…
;

314  
	`ßveIndexComp⁄íts
(
ödex
);

315 
	}
}

325 
IndexZ⁄e
 *
	$gëReque°Z⁄e
(
Index
 *
ödex
, 
Reque°
 *
ªque°
)

327  
ödex
->
z⁄es
[
ªque°
->
z⁄eNumbî
];

328 
	}
}

338 
	$£¨chIndexZ⁄e
(
IndexZ⁄e
 *
z⁄e
, 
Reque°
 *
ªque°
)

340 
Ma°îIndexRec‹d
 
ªc‹d
;

341 
ªsu…
 = 
	`gëMa°îIndexRec‹d
(
z⁄e
->
ödex
->
ma°îIndex
, &
ªque°
->
hash
,

342 &
ªc‹d
);

343 i‡(
ªsu…
 !
UDS_SUCCESS
) {

344  
ªsu…
;

347 
boﬁ
 
found
 = 
Ál£
;

348 i‡(
ªc‹d
.
isFound
) {

349 
ªsu…
 = 
	`gëRec‹dFromZ⁄e
(
z⁄e
, 
ªque°
, &
found
, 
ªc‹d
.
vútuÆCh≠ãr
);

350 i‡(
ªsu…
 !
UDS_SUCCESS
) {

351  
ªsu…
;

353 i‡(
found
) {

354 
ªque°
->
loˇti⁄
 = 
	`compuãIndexRegi⁄
(
z⁄e
, 
ªc‹d
.
vútuÆCh≠ãr
);

364 
boﬁ
 
ovîÊowRec‹d
 = (
ªc‹d
.
isFound
 &&Ñec‹d.
isCﬁlisi⁄
 && !
found
);

365 
uöt64_t
 
ch≠ãr
 = 
z⁄e
->
√we°VútuÆCh≠ãr
;

366 i‡(
found
 || 
ovîÊowRec‹d
) {

367 i‡((
ªque°
->
a˘i⁄
 =
REQUEST_QUERY
)

368 && (!
ªque°
->
upd©e
 || 
ovîÊowRec‹d
)) {

370  
UDS_SUCCESS
;

373 i‡(
ªc‹d
.
vútuÆCh≠ãr
 !
ch≠ãr
) {

379 
ªsu…
 = 
	`£tMa°îIndexRec‹dCh≠ãr
(&
ªc‹d
, 
ch≠ãr
);

380 } i‡(
ªque°
->
a˘i⁄
 !
REQUEST_UPDATE
) {

382  
UDS_SUCCESS
;

387 i‡(!
	`isMa°îIndexSam∂e
(
z⁄e
->
ödex
->
ma°îIndex
, &
ªque°
->
hash
)) {

389 
ªsu…
 = 
	`£¨chVﬁumeS∑r£Cache
(
z⁄e
->
ödex
->
vﬁume
, 
ªque°
,

390 
UINT64_MAX
, &
found
);

391 i‡(
ªsu…
 !
UDS_SUCCESS
) {

392  
ªsu…
;

395 i‡(
found
) {

396 
ªque°
->
loˇti⁄
 = 
LOC_IN_SPARSE
;

400 i‡(
ªque°
->
a˘i⁄
 =
REQUEST_QUERY
) {

401 i‡(!
found
 || !
ªque°
->
upd©e
) {

403  
UDS_SUCCESS
;

412 
ªsu…
 = 
	`putMa°îIndexRec‹d
(&
ªc‹d
, 
ch≠ãr
);

415 i‡(
ªsu…
 =
UDS_OVERFLOW
) {

421  
UDS_SUCCESS
;

424 i‡(
ªsu…
 !
UDS_SUCCESS
) {

425  
ªsu…
;

428 
UdsChunkD©a
 *
mëad©a
;

429 i‡(!
found
 || (
ªque°
->
a˘i⁄
 =
REQUEST_UPDATE
)) {

431 
mëad©a
 = &
ªque°
->
√wMëad©a
;

434 
mëad©a
 = &
ªque°
->
ﬁdMëad©a
;

436  
	`putRec‹dInZ⁄e
(
z⁄e
, 
ªque°
, 
mëad©a
);

437 
	}
}

440 
	$ªmoveFromIndexZ⁄e
(
IndexZ⁄e
 *
z⁄e
, 
Reque°
 *
ªque°
)

442 
Ma°îIndexRec‹d
 
ªc‹d
;

443 
ªsu…
 = 
	`gëMa°îIndexRec‹d
(
z⁄e
->
ödex
->
ma°îIndex
, &
ªque°
->
hash
,

444 &
ªc‹d
);

445 i‡(
ªsu…
 !
UDS_SUCCESS
) {

446  
ªsu…
;

449 i‡(!
ªc‹d
.
isFound
) {

451  
UDS_SUCCESS
;

454 i‡(!
ªc‹d
.
isCﬁlisi⁄
) {

456 
boﬁ
 
found
;

457 
ªsu…
 = 
	`gëRec‹dFromZ⁄e
(
z⁄e
, 
ªque°
, &
found
,

458 
ªc‹d
.
vútuÆCh≠ãr
);

459 i‡(
ªsu…
 !
UDS_SUCCESS
) {

460  
ªsu…
;

463 i‡(!
found
) {

465  
UDS_SUCCESS
;

469 
ªque°
->
loˇti⁄
 = 
	`compuãIndexRegi⁄
(
z⁄e
, 
ªc‹d
.
vútuÆCh≠ãr
);

476 
ªsu…
 = 
	`ªmoveMa°îIndexRec‹d
(&
ªc‹d
);

477 i‡(
ªsu…
 !
UDS_SUCCESS
) {

478  
ªsu…
;

483 i‡(
ªque°
->
loˇti⁄
 =
LOC_IN_OPEN_CHAPTER
) {

484 
boﬁ
 
hashExi°s
 = 
Ál£
;

485 
	`ªmoveFromO≥nCh≠ãr
(
z⁄e
->
›íCh≠ãr
, &
ªque°
->
hash
, &
hashExi°s
);

486 
ªsu…
 = 
	`ASSERT
(
hashExi°s
, "removingÑecordÇot found in open chapter");

487 i‡(
ªsu…
 !
UDS_SUCCESS
) {

488  
ªsu…
;

492  
UDS_SUCCESS
;

493 
	}
}

509 
	$simuœãIndexZ⁄eB¨rõrMesßge
(
IndexZ⁄e
 *
z⁄e
, 
Reque°
 *
ªque°
)

512 i‡((
z⁄e
->
ödex
->
z⁄eCou¡
 > 1)

513 || !
	`isS∑r£
(
z⁄e
->
ödex
->
vﬁume
->
geomëry
)) {

514  
UDS_SUCCESS
;

518 
uöt64_t
 
•¨£VútuÆCh≠ãr
 = 
	`åügeIndexReque°
(
z⁄e
->
ödex
, 
ªque°
);

519 i‡(
•¨£VútuÆCh≠ãr
 =
UINT64_MAX
) {

522  
UDS_SUCCESS
;

530 
B¨rõrMesßgeD©a
 
b¨rõr
 = { .
vútuÆCh≠ãr
 = 
•¨£VútuÆCh≠ãr
 };

531  
	`execuãS∑r£CacheB¨rõrMesßge
(
z⁄e
, &
b¨rõr
);

532 
	}
}

535 
	$di•©chIndexZ⁄eReque°
(
IndexZ⁄e
 *
z⁄e
, 
Reque°
 *
ªque°
)

537 i‡(!
ªque°
->
ªqueued
) {

540 
ªsu…
 = 
	`simuœãIndexZ⁄eB¨rõrMesßge
(
z⁄e
, 
ªque°
);

541 i‡(
ªsu…
 !
UDS_SUCCESS
) {

542  
ªsu…
;

547 
ªque°
->
loˇti⁄
 = 
LOC_UNAVAILABLE
;

549 
ªsu…
;

550 
ªque°
->
a˘i⁄
) {

551 
REQUEST_INDEX
:

552 
REQUEST_UPDATE
:

553 
REQUEST_QUERY
:

554 
ªsu…
 = 
	`£¨chIndexZ⁄e
(
z⁄e
, 
ªque°
);

555 
ªsu…
 = 
	`logUƒecovîabÀ
(result, "index_%u: searchLockedIndex() failed",

556 
z⁄e
->
ödex
->
id
);

559 
REQUEST_DELETE
:

560 
ªsu…
 = 
	`ªmoveFromIndexZ⁄e
(
z⁄e
, 
ªque°
);

561 
ªsu…
 = 
	`logUƒecovîabÀ
(result, "index_%u:ÑemoveFromIndexZone() failed",

562 
z⁄e
->
ödex
->
id
);

566 
ªsu…
 = 
	`logW¨nögWôhSåögEº‹
(
UDS_INVALID_ARGUMENT
,

568 
ªque°
->
a˘i⁄
);

571  
ªsu…
;

572 
	}
}

575 
	$di•©chIndexReque°
(
Index
 *
ödex
, 
Reque°
 *
ªque°
)

577  
	`di•©chIndexZ⁄eReque°
(
	`gëReque°Z⁄e
(
ödex
, 
ªque°
),Ñequest);

578 
	}
}

592 
	$gëPageF‹Rebuûd
(
Index
 *
ödex
,

593 
uöt64_t
 
vútuÆCh≠ãrNumbî
,

594 
∑geNumbî
,

595 
CacheProbeTy≥
 
¥obeTy≥
,

596 
byã
 **
∑gePå
)

598 
physiˇlCh≠ãrNumbî


599 
	`m≠ToPhysiˇlCh≠ãr
(
ödex
->
vﬁume
->
geomëry
, 
vútuÆCh≠ãrNumbî
);

601  
	`gëPage
(
ödex
->
vﬁume
, 
NULL
, 
physiˇlCh≠ãrNumbî
, 
∑geNumbî
,

602 
¥obeTy≥
, 
∑gePå
);

603 
	}
}

606 
	$ªbuûdIndexPageM≠
(
Index
 *
ödex
, 
uöt64_t
 
v˙
)

608 
Geomëry
 *
geomëry
 = 
ödex
->
vﬁume
->geometry;

609 
ch≠ãr
 = 
	`m≠ToPhysiˇlCh≠ãr
(
ödex
->
vﬁume
->
geomëry
, 
v˙
);

610 
ödexPageNumbî
 = 0;

611 
ödexPageNumbî
 < 
geomëry
->
ödexPagesPîCh≠ãr
;

612 
ödexPageNumbî
++) {

613 
byã
 *
ödexPage
;

614 
ªsu…
 = 
	`gëPageF‹Rebuûd
(
ödex
, 
ch≠ãr
, 
ödexPageNumbî
,

615 
CACHE_PROBE_INDEX_FIRST
, &
ödexPage
);

616 i‡(
ªsu…
 !
UDS_SUCCESS
) {

617  
	`logEº‹WôhSåögEº‹
(
ªsu…
,

620 
ödex
->
id
, 
ödexPageNumbî
, 
ch≠ãr
);

623 
Ch≠ãrIndexPage
 
ch≠ãrIndexPage
;

624 
ªsu…
 = 
	`öôülizeCh≠ãrIndexPage
(&
ch≠ãrIndexPage
, 
geomëry
, 
ödexPage
,

625 
ödex
->
vﬁume
->
n⁄˚
);

626 i‡(
ªsu…
 !
UDS_SUCCESS
) {

627  
	`logEº‹WôhSåögEº‹
(

628 
ªsu…
, "index_%u: failedÅo initialize chapter %u indexÖage %u",

629 
ödex
->
id
, 
ch≠ãr
, 
ödexPageNumbî
);

632 
highe°DñèLi°


633 
	`gëDñèIndexHighe°Li°Numbî
(&
ch≠ãrIndexPage
.
dñèIndex
);

634 
ªsu…
 = 
	`upd©eIndexPageM≠
(
ödex
->
vﬁume
->
ödexPageM≠
,

635 
v˙
,

636 
ch≠ãr
,

637 
ödexPageNumbî
,

638 
highe°DñèLi°
);

639 i‡(
ªsu…
 !
UDS_SUCCESS
) {

640  
	`logEº‹WôhSåögEº‹
(

641 
ªsu…
, "index_%u: failedÅo update chapter %u indexÖage %u",

642 
ödex
->
id
, 
ch≠ãr
, 
ödexPageNumbî
);

646  
UDS_SUCCESS
;

647 
	}
}

661 
	$ª∂ayRec‹d
(
Index
 *
ödex
,

662 c⁄° 
UdsChunkName
 *
«me
,

663 
uöt64_t
 
vútuÆCh≠ãr
,

664 
boﬁ
 
wûlBeS∑r£Ch≠ãr
)

666 i‡(
wûlBeS∑r£Ch≠ãr
 && !
	`isMa°îIndexSam∂e
(
ödex
->
ma°îIndex
, 
«me
)) {

669  
UDS_SUCCESS
;

672 
Ma°îIndexRec‹d
 
ªc‹d
;

673 
ªsu…
 = 
	`gëMa°îIndexRec‹d
(
ödex
->
ma°îIndex
, 
«me
, &
ªc‹d
);

674 i‡(
ªsu…
 !
UDS_SUCCESS
) {

675  
ªsu…
;

678 
boﬁ
 
upd©eRec‹d
;

679 i‡(
ªc‹d
.
isFound
) {

680 i‡(
ªc‹d
.
isCﬁlisi⁄
) {

681 i‡(
ªc‹d
.
vútuÆCh≠ãr
 == virtualChapter) {

683  
UDS_SUCCESS
;

685 
upd©eRec‹d
 = 
åue
;

686 } i‡(
ªc‹d
.
vútuÆCh≠ãr
 == virtualChapter) {

695 
upd©eRec‹d
 = 
Ál£
;

708 
ªsu…
 = 
	`£¨chVﬁume
(
ödex
->
vﬁume
, 
NULL
, 
«me
, 
ªc‹d
.
vútuÆCh≠ãr
,

709 
Ál£
, 
NULL
, &
upd©eRec‹d
);

710 i‡(
ªsu…
 !
UDS_SUCCESS
) {

711  
ªsu…
;

715 
upd©eRec‹d
 = 
Ál£
;

718 i‡(
upd©eRec‹d
) {

724 
ªsu…
 = 
	`£tMa°îIndexRec‹dCh≠ãr
(&
ªc‹d
, 
vútuÆCh≠ãr
);

733 
ªsu…
 = 
	`putMa°îIndexRec‹d
(&
ªc‹d
, 
vútuÆCh≠ãr
);

736 i‡((
ªsu…
 =
UDS_DUPLICATE_NAME
Ë|| (ªsu… =
UDS_OVERFLOW
)) {

738  
UDS_SUCCESS
;

741  
ªsu…
;

742 
	}
}

745 
	$begöSave
(
Index
 *
ödex
, 
boﬁ
 
checkpoöt
, 
uöt64_t
 
›íCh≠ãrNumbî
)

747 
ödex
->
¥evCheckpoöt
 = index->
œ°Checkpoöt
;

748 
ödex
->
œ°Checkpoöt
 = ((
›íCh≠ãrNumbî
 == 0)

749 ? 
NO_LAST_CHECKPOINT


750 : 
›íCh≠ãrNumbî
 - 1);

752 c⁄° *
wh©
 = (
checkpoöt
 ? "checkpoint" : "save");

753 
	`logInfo
("ödex_%u: begönög %†(v˙ %"
PRIu64
")",

754 
ödex
->
id
, 
wh©
, index->
œ°Checkpoöt
);

756 
	}
}

759 
	$ª∂ayVﬁume
(
Index
 *
ödex
, 
uöt64_t
 
‰omVCN
)

761 
ªsu…
;

762 
uöt64_t
 
u±oVCN
 = 
ödex
->
√we°VútuÆCh≠ãr
;

763 
	`logInfo
("ödex_%u: Rïœyög vﬁumê‰om ch≠ã∏%"
PRIu64


764 "Åhrough ch≠ã∏%"
PRIu64
, 
ödex
->
id
, 
‰omVCN
, 
u±oVCN
);

765 
	`£tMa°îIndexO≥nCh≠ãr
(
ödex
->
ma°îIndex
, 
u±oVCN
);

766 
	`£tMa°îIndexO≥nCh≠ãr
(
ödex
->
ma°îIndex
, 
‰omVCN
);

775 
IndexLookupMode
 
ﬁdLookupMode
 = 
ödex
->
vﬁume
->
lookupMode
;

776 
ödex
->
vﬁume
->
lookupMode
 = 
LOOKUP_FOR_REBUILD
;

787 c⁄° 
Geomëry
 *
geomëry
 = 
ödex
->
vﬁume
->geometry;

788 
uöt64_t
 
ﬁdIPMupd©e
 = 
	`gëLa°Upd©e
(
ödex
->
vﬁume
->
ödexPageM≠
);

789 
uöt64_t
 
v˙
 = 
‰omVCN
; v˙ < 
u±oVCN
; ++vcn) {

790 
boﬁ
 
wûlBeS∑r£Ch≠ãr
 = 
	`isCh≠ãrS∑r£
(
ödex
->
vﬁume
->
geomëry
,

791 
‰omVCN
, 
u±oVCN
, 
v˙
);

792 
ch≠ãr
 = 
	`m≠ToPhysiˇlCh≠ãr
(
geomëry
, 
v˙
);

793 
	`£tMa°îIndexO≥nCh≠ãr
(
ödex
->
ma°îIndex
, 
v˙
);

794 
ªsu…
 = 
	`ªbuûdIndexPageM≠
(
ödex
, 
v˙
);

795 i‡(
ªsu…
 !
UDS_SUCCESS
) {

796 
ödex
->
vﬁume
->
lookupMode
 = 
ﬁdLookupMode
;

797  
	`logEº‹WôhSåögEº‹
(

798 
ªsu…
, "index_%u: couldÇotÑebuild indexÖage map for chapter %u",

799 
ödex
->
id
, 
ch≠ãr
);

802 
j
 = 0; j < 
geomëry
->
ªc‹dPagesPîCh≠ãr
; j++) {

803 
ªc‹dPageNumbî
 = 
geomëry
->
ödexPagesPîCh≠ãr
 + 
j
;

804 
byã
 *
ªc‹dPage
;

805 
ªsu…
 = 
	`gëPageF‹Rebuûd
(
ödex
, 
ch≠ãr
, 
ªc‹dPageNumbî
,

806 
CACHE_PROBE_RECORD_FIRST
, &
ªc‹dPage
);

807 i‡(
ªsu…
 !
UDS_SUCCESS
) {

808 
ödex
->
vﬁume
->
lookupMode
 = 
ﬁdLookupMode
;

809  
	`logUƒecovîabÀ
(
ªsu…
, "index_%u: couldÇot getÖage %d",

810 
ödex
->
id
, 
ªc‹dPageNumbî
);

812 
k
 = 0; k < 
geomëry
->
ªc‹dsPîPage
; k++) {

813 c⁄° 
byã
 *
«meByãs
 = 
ªc‹dPage
 + (
k
 * 
BYTES_PER_RECORD
);

815 
UdsChunkName
 
«me
;

816 
	`mem˝y
(&
«me
.«me, 
«meByãs
, 
UDS_CHUNK_NAME_SIZE
);

818 
ªsu…
 = 
	`ª∂ayRec‹d
(
ödex
, &
«me
, 
v˙
, 
wûlBeS∑r£Ch≠ãr
);

819 i‡(
ªsu…
 !
UDS_SUCCESS
) {

820 
hexName
[(2 * 
UDS_CHUNK_NAME_SIZE
) + 1];

821 i‡(
	`chunkNameToHex
(&
«me
, 
hexName
, (hexName)Ë!
UDS_SUCCESS
) {

822 
	`°∫˝y
(
hexName
, "<unknown>", (hexName));

824 
ödex
->
vﬁume
->
lookupMode
 = 
ﬁdLookupMode
;

825  
	`logUƒecovîabÀ
(
ªsu…
, "index_%u: "

827 
ödex
->
id
, 
hexName
);

832 
ödex
->
vﬁume
->
lookupMode
 = 
ﬁdLookupMode
;

835 
	`£tMa°îIndexO≥nCh≠ãr
(
ödex
->
ma°îIndex
, 
u±oVCN
);

837 
uöt64_t
 
√wIPMupd©e
 = 
	`gëLa°Upd©e
(
ödex
->
vﬁume
->
ödexPageM≠
);

839 i‡(
√wIPMupd©e
 !
ﬁdIPMupd©e
) {

840 
	`logInfo
("ª∂ay ch™ged indexÖagêm≠ upd©ê‰om %" 
PRIu64
 "Åo %" PRIu64,

841 
ﬁdIPMupd©e
, 
√wIPMupd©e
);

844  
UDS_SUCCESS
;

845 
	}
}

848 
	$gëIndexSèts
(
Index
 *
ödex
, 
IndexRouãrSètCou¡îs
 *
cou¡îs
)

850 
uöt64_t
 
cwAŒoˇãd
 = 
	`gëCh≠ãrWrôîMem‹yAŒoˇãd
(
ödex
->
ch≠ãrWrôî
);

853 
Ma°îIndexSèts
 
dí£Sèts
, 
•¨£Sèts
;

854 
	`gëMa°îIndexSèts
(
ödex
->
ma°îIndex
, &
dí£Sèts
, &
•¨£Sèts
);

856 
	`mem£t
(
cou¡îs
, 0, (
IndexRouãrSètCou¡îs
));

857 
	`gëCacheCou¡îs
(
ödex
->
vﬁume
, &
cou¡îs
->
vﬁumeCache
);

859 
cou¡îs
->
íåõsIndexed
 = (
dí£Sèts
.
ªc‹dCou¡


860 + 
•¨£Sèts
.
ªc‹dCou¡
);

861 
cou¡îs
->
mem‹yU£d
 = ((
uöt64_t
Ë
dí£Sèts
.
mem‹yAŒoˇãd


862 + (
uöt64_t
Ë
•¨£Sèts
.
mem‹yAŒoˇãd


863 + (
uöt64_t
Ë
	`gëCacheSize
(
ödex
->
vﬁume
)

864 + 
cwAŒoˇãd
);

865 
cou¡îs
->
diskU£d
 = (
uöt64_t
Ë
	`gëVﬁumeSize
(
ödex
->
vﬁume
);

866 
cou¡îs
->
numDli°s
 = ((
uöt64_t
Ë
dí£Sèts
.
numLi°s


867 + (
uöt64_t
Ë
•¨£Sèts
.
numLi°s
);

868 
cou¡îs
->
cﬁlisi⁄s
 = (
dí£Sèts
.
cﬁlisi⁄Cou¡


869 + 
•¨£Sèts
.
cﬁlisi⁄Cou¡
);

870 
cou¡îs
->
íåõsDisˇrded
 = (
dí£Sèts
.
disˇrdCou¡


871 + 
•¨£Sèts
.
disˇrdCou¡
);

872 
cou¡îs
->
checkpoöts
 = 
	`gëCheckpoötCou¡
(
ödex
->
checkpoöt
);

873 
	}
}

876 
	$adv™˚A˘iveCh≠ãrs
(
Index
 *
ödex
)

878 
ödex
->
√we°VútuÆCh≠ãr
++;

879 i‡(
	`¨eSamePhysiˇlCh≠ãr
(
ödex
->
vﬁume
->
geomëry
,

880 
ödex
->
√we°VútuÆCh≠ãr
,

881 
ödex
->
ﬁde°VútuÆCh≠ãr
)) {

882 
ödex
->
ﬁde°VútuÆCh≠ãr
++;

884 
	}
}

887 
uöt64_t
 
	$åügeIndexReque°
(
Index
 *
ödex
, 
Reque°
 *
ªque°
)

889 
Ma°îIndexTrüge
 
åüge
;

890 
	`lookupMa°îIndexName
(
ödex
->
ma°îIndex
, &
ªque°
->
hash
, &
åüge
);

891 i‡(!
åüge
.
öSam∂edCh≠ãr
) {

893  
UINT64_MAX
;

896 
IndexZ⁄e
 *
z⁄e
 = 
	`gëReque°Z⁄e
(
ödex
, 
ªque°
);

897 i‡(!
	`isZ⁄eCh≠ãrS∑r£
(
z⁄e
, 
åüge
.
vútuÆCh≠ãr
)) {

898  
UINT64_MAX
;

905  
åüge
.
vútuÆCh≠ãr
;

906 
	}
}

	@uds/index.h

22 #i‚de‡
INDEX_H


23 
	#INDEX_H


	)

25 
	~"ch≠ãrWrôî.h
"

26 
	~"ödexRouãrSèts.h
"

27 
	~"ödexLayout.h
"

28 
	~"ödexZ⁄e.h
"

29 
	~"lﬂdTy≥.h
"

30 
	~"ma°îIndexOps.h
"

31 
	~"vﬁume.h
"

36 
ödexCheckpoöt
 
	tIndexCheckpoöt
;

38 
	södex
 {

39 
	mid
;

40 
boﬁ
 
	mexi°ed
;

41 
IndexLayout
 *
	mœyout
;

42 
IndexSèã
 *
	m°©e
;

43 
Ma°îIndex
 *
	mma°îIndex
;

44 
Vﬁume
 *
	mvﬁume
;

45 
	mz⁄eCou¡
;

46 
IndexZ⁄e
 **
	mz⁄es
;

57 
uöt64_t
 
	mﬁde°VútuÆCh≠ãr
;

58 
uöt64_t
 
	m√we°VútuÆCh≠ãr
;

60 
uöt64_t
 
	mœ°Checkpoöt
;

61 
uöt64_t
 
	m¥evCheckpoöt
;

62 
Ch≠ãrWrôî
 *
	mch≠ãrWrôî
;

65 
IndexCheckpoöt
 *
	mcheckpoöt
;

66 } 
	tIndex
;

82 
	$makeIndex
(
IndexLayout
 *
œyout
,

83 c⁄° 
C⁄figuøti⁄
 *
c⁄fig
,

84 
id
,

85 
z⁄eCou¡
,

86 
LﬂdTy≥
 
lﬂdTy≥
,

87 
Index
 **
√wIndex
)

88 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

97 
	$ßveIndex
(
Index
 *
ödex
Ë
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

104 
	`‰ìIndex
(
Index
 *
ödex
);

137 
	$di•©chIndexReque°
(
Index
 *
ödex
, 
Reque°
 *
ªque°
)

138 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

147 
	`begöSave
(
Index
 *
ödex
, 
boﬁ
 
checkpoöt
, 
uöt64_t
 
›íCh≠ãrNumbî
);

157 
	$ª∂ayVﬁume
(
Index
 *
ödex
, 
uöt64_t
 
‰omVCN
)

158 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

166 
	`gëIndexSèts
(
Index
 *
ödex
, 
IndexRouãrSètCou¡îs
 *
cou¡îs
);

176 
	`£tIndexLookupSèã
(
Index
 *
ödex
, 
boﬁ
 
íabÀd
);

184 
	`adv™˚A˘iveCh≠ãrs
(
Index
 *
ödex
);

203 
uöt64_t
 
	$åügeIndexReque°
(
Index
 *
ödex
, 
Reque°
 *
ªque°
)

204 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

	@uds/indexCheckpoint.c

22 
	~"ödexCheckpoöt.h
"

24 
	~"îr‹s.h
"

25 
	~"loggî.h
"

26 
	~"mem‹yAŒoc.h
"

27 
	~"≥rmas£π.h
"

28 
	~"thªads.h
"

29 
	~"ty≥Defs.h
"

37 
	echeckpoötSèã
 {

38 
	mNOT_CHECKPOINTING
,

39 
	mCHECKPOINT_IN_PROGRESS
,

40 
	mCHECKPOINT_ABORTING


41 } 
	tCheckpoötSèã
;

46 
	södexCheckpoöt
 {

47 
Muãx
 
	mmuãx
;

48 
uöt64_t
 
	mch≠ãr
;

49 
CheckpoötSèã
 
	m°©e
;

50 
	mz⁄esBusy
;

51 
	m‰equícy
;

52 
uöt64_t
 
	mcheckpoöts
;

58 
	eödexCheckpoötTriggîVÆue
 {

59 
	mICTV_IDLE
,

60 
	mICTV_START
,

61 
	mICTV_CONTINUE
,

62 
	mICTV_FINISH
,

63 
	mICTV_ABORT


64 } 
	tIndexCheckpoötTriggîVÆue
;

66 
	tCheckpoötFun˘i⁄
(
	tIndex
 *
	tödex
, 
	tz⁄e
);

71 
CheckpoötFun˘i⁄
 
	gdoCheckpoötSèπ
;

72 
CheckpoötFun˘i⁄
 
	gdoCheckpoötPro˚ss
;

73 
CheckpoötFun˘i⁄
 
	gdoCheckpoötFöish
;

74 
CheckpoötFun˘i⁄
 
	gdoCheckpoötAb‹t
;

76 
CheckpoötFun˘i⁄
 *c⁄° 
	gcheckpoötFuncs
[] = {

77 
NULL
,

78 
doCheckpoötSèπ
,

79 
doCheckpoötPro˚ss
,

80 
doCheckpoötFöish
,

81 
doCheckpoötAb‹t


85 
	$makeIndexCheckpoöt
(
Index
 *
ödex
)

87 
IndexCheckpoöt
 *
checkpoöt
;

88 
ªsu…


89 
	`ALLOCATE
(1, 
IndexCheckpoöt
, "IndexCheckpoöt", &
checkpoöt
);

90 i‡(
ªsu…
 !
UDS_SUCCESS
) {

91  
ªsu…
;

94 
ªsu…
 = 
	`öôMuãx
(&
checkpoöt
->
muãx
);

95 i‡(
ªsu…
 !
UDS_SUCCESS
) {

96 
	`FREE
(
checkpoöt
);

97  
ªsu…
;

100 
checkpoöt
->
checkpoöts
 = 0;

102 
ödex
->
checkpoöt
 = checkpoint;

103  
UDS_SUCCESS
;

104 
	}
}

107 
	$‰ìIndexCheckpoöt
(
IndexCheckpoöt
 *
checkpoöt
)

109 i‡(
checkpoöt
 !
NULL
) {

110 
	`de°royMuãx
(&
checkpoöt
->
muãx
);

111 
	`FREE
(
checkpoöt
);

113 
	}
}

116 
	$gëIndexCheckpoötFªquícy
(
IndexCheckpoöt
 *
checkpoöt
)

118 
	`lockMuãx
(&
checkpoöt
->
muãx
);

119 
‰equícy
 = 
checkpoöt
->frequency;

120 
	`u∆ockMuãx
(&
checkpoöt
->
muãx
);

121  
‰equícy
;

122 
	}
}

125 
	$£tIndexCheckpoötFªquícy
(
IndexCheckpoöt
 *
checkpoöt
,

126 
‰equícy
)

128 
	`lockMuãx
(&
checkpoöt
->
muãx
);

129 
ﬁdFªquícy
 = 
checkpoöt
->
‰equícy
;

130 
checkpoöt
->
‰equícy
 = frequency;

131 
	`u∆ockMuãx
(&
checkpoöt
->
muãx
);

132  
ﬁdFªquícy
;

133 
	}
}

136 
uöt64_t
 
	$gëCheckpoötCou¡
(
IndexCheckpoöt
 *
checkpoöt
)

138  
checkpoöt
->
checkpoöts
;

139 
	}
}

142 
IndexCheckpoötTriggîVÆue


143 
	$gëCheckpoötA˘i⁄
(
IndexCheckpoöt
 *
checkpoöt
,

144 
uöt64_t
 
vútuÆCh≠ãr
)

146 i‡(
checkpoöt
->
‰equícy
 == 0) {

147  
ICTV_IDLE
;

149 
vÆue
 = 
vútuÆCh≠ãr
 % 
checkpoöt
->
‰equícy
;

150 i‡(
checkpoöt
->
°©e
 =
CHECKPOINT_ABORTING
) {

151  
ICTV_ABORT
;

152 } i‡(
checkpoöt
->
°©e
 =
CHECKPOINT_IN_PROGRESS
) {

153 i‡(
vÆue
 =
checkpoöt
->
‰equícy
 - 1) {

154  
ICTV_FINISH
;

156  
ICTV_CONTINUE
;

159 i‡(
vÆue
 == 0) {

160  
ICTV_START
;

162  
ICTV_IDLE
;

165 
	}
}

168 
	$¥o˚ssCheckpoötög
(
Index
 *
ödex
,

169 
z⁄e
,

170 
uöt64_t
 
√wVútuÆCh≠ãr
)

172 
IndexCheckpoöt
 *
checkpoöt
 = 
ödex
->checkpoint;

173 
	`lockMuãx
(&
checkpoöt
->
muãx
);

175 
IndexCheckpoötTriggîVÆue
 
i˘v


176 
	`gëCheckpoötA˘i⁄
(
checkpoöt
, 
√wVútuÆCh≠ãr
);

178 i‡(
i˘v
 =
ICTV_START
) {

179 
checkpoöt
->
ch≠ãr
 = 
√wVútuÆCh≠ãr
;

182 
CheckpoötFun˘i⁄
 *
func
 = 
checkpoötFuncs
[
i˘v
];

183 i‡(
func
 =
NULL
) {

185 
	`u∆ockMuãx
(&
checkpoöt
->
muãx
);

186  
UDS_SUCCESS
;

189  (*
func
)(
ödex
, 
z⁄e
);

190 
	}
}

193 
	$¥o˚ssCh≠ãrWrôîCheckpoötSaves
(
Index
 *
ödex
)

195 
IndexCheckpoöt
 *
checkpoöt
 = 
ödex
->checkpoint;

197 
ªsu…
 = 
UDS_SUCCESS
;

199 
	`lockMuãx
(&
checkpoöt
->
muãx
);

200 i‡(
checkpoöt
->
°©e
 =
CHECKPOINT_IN_PROGRESS
) {

201 
ªsu…
 =

202 
	`≥rf‹mIndexSèãCheckpoötCh≠ãrSynchr⁄izedSaves
(
ödex
->
°©e
);

204 i‡(
ªsu…
 !
UDS_SUCCESS
) {

205 
checkpoöt
->
°©e
 = 
CHECKPOINT_ABORTING
;

206 
	`logInfo
("ödex_%u: checkpoöàÁûed", 
ödex
->
id
);

207 
ödex
->
œ°Checkpoöt
 = index->
¥evCheckpoöt
;

211 
	`u∆ockMuãx
(&
checkpoöt
->
muãx
);

212  
ªsu…
;

213 
	}
}

223 
	$ab‹tCheckpoötög
(
Index
 *
ödex
, 
ªsu…
)

225 i‡(
ödex
->
checkpoöt
->
°©e
 !
NOT_CHECKPOINTING
) {

226 
ödex
->
checkpoöt
->
°©e
 = 
CHECKPOINT_ABORTING
;

227 
	`logInfo
("ödex_%u: checkpoöàÁûed", 
ödex
->
id
);

228 
ödex
->
œ°Checkpoöt
 = index->
¥evCheckpoöt
;

230  
ªsu…
;

231 
	}
}

234 
	$föishCheckpoötög
(
Index
 *
ödex
)

236 
IndexCheckpoöt
 *
checkpoöt
 = 
ödex
->checkpoint;

238 
ªsu…
 = 
	`¥o˚ssCh≠ãrWrôîCheckpoötSaves
(
ödex
);

239 i‡(
ªsu…
 !
UDS_SUCCESS
) {

240  
ªsu…
;

243 
	`lockMuãx
(&
checkpoöt
->
muãx
);

245 
z
 = 0; z < 
ödex
->
z⁄eCou¡
; ++z) {

246 i‡(
checkpoöt
->
°©e
 !
CHECKPOINT_IN_PROGRESS
) {

249 
ªsu…
 = 
	`doCheckpoötFöish
(
ödex
, 
z
);

251 
	`lockMuãx
(&
checkpoöt
->
muãx
);

252 i‡(
ªsu…
 !
UDS_SUCCESS
) {

257 i‡((
ªsu…
 =
UDS_SUCCESS
) &&

258 (
checkpoöt
->
°©e
 =
CHECKPOINT_IN_PROGRESS
)) {

259 
ªsu…
 = 
	`föishIndexSèãCheckpoöt
(
ödex
->
°©e
);

260 i‡(
ªsu…
 =
UDS_SUCCESS
) {

261 
checkpoöt
->
°©e
 = 
NOT_CHECKPOINTING
;

265 
	`u∆ockMuãx
(&
checkpoöt
->
muãx
);

266  
ªsu…
;

267 
	}
}

279 
	$doCheckpoötSèπ
(
Index
 *
ödex
, 
z⁄e
)

281 
IndexCheckpoöt
 *
checkpoöt
 = 
ödex
->checkpoint;

282 
	`begöSave
(
ödex
, 
åue
, 
checkpoöt
->
ch≠ãr
);

283 
ªsu…
 = 
	`°¨tIndexSèãCheckpoöt
(
ödex
->
°©e
);

284 i‡(
ªsu…
 !
UDS_SUCCESS
) {

285 
	`logEº‹WôhSåögEº‹
(
ªsu…
,

287 
ödex
->
id
);

288 
ödex
->
œ°Checkpoöt
 = index->
¥evCheckpoöt
;

289 
	`u∆ockMuãx
(&
checkpoöt
->
muãx
);

290  
ªsu…
;

293 
checkpoöt
->
°©e
 = 
CHECKPOINT_IN_PROGRESS
;

294 
checkpoöt
->
z⁄esBusy
 = 
ödex
->
z⁄eCou¡
;

296  
	`doCheckpoötPro˚ss
(
ödex
, 
z⁄e
);

297 
	}
}

300 
	$doCheckpoötPro˚ss
(
Index
 *
ödex
, 
z⁄e
)

302 
IndexCheckpoöt
 *
checkpoöt
 = 
ödex
->checkpoint;

303 
	`u∆ockMuãx
(&
checkpoöt
->
muãx
);

304 
Com∂ëi⁄Sètus
 
°©us
 = 
CS_NOT_COMPLETED
;

305 
ªsu…
 = 
	`≥rf‹mIndexSèãCheckpoötInZ⁄e
(
ödex
->
°©e
, 
z⁄e
, &
°©us
);

306 i‡(
ªsu…
 !
UDS_SUCCESS
) {

307 
	`lockMuãx
(&
checkpoöt
->
muãx
);

308 
	`logEº‹WôhSåögEº‹
(
ªsu…
,

310 
ödex
->
id
);

311 
ªsu…
 = 
	`ab‹tCheckpoötög
(
ödex
,Ñesult);

312 
	`u∆ockMuãx
(&
checkpoöt
->
muãx
);

313 } i‡(
°©us
 =
CS_JUST_COMPLETED
) {

314 
	`lockMuãx
(&
checkpoöt
->
muãx
);

315 i‡(--
checkpoöt
->
z⁄esBusy
 == 0) {

316 
checkpoöt
->
checkpoöts
 += 1;

317 
	`logInfo
("ödex_%u: föished checkpoöt", 
ödex
->
id
);

318 
ªsu…
 = 
	`föishIndexSèãCheckpoöt
(
ödex
->
°©e
);

319 i‡(
ªsu…
 !
UDS_SUCCESS
) {

320 
	`logEº‹WôhSåögEº‹
(
ªsu…
,

322 
ödex
->
id
,

323 
__func__
);

325 
checkpoöt
->
°©e
 = 
NOT_CHECKPOINTING
;

327 
	`u∆ockMuãx
(&
checkpoöt
->
muãx
);

329  
ªsu…
;

330 
	}
}

333 
	$doCheckpoötAb‹t
(
Index
 *
ödex
, 
z⁄e
)

335 
IndexCheckpoöt
 *
checkpoöt
 = 
ödex
->checkpoint;

336 
Com∂ëi⁄Sètus
 
°©us
 = 
CS_NOT_COMPLETED
;

337 
ªsu…
 = 
	`ab‹tIndexSèãCheckpoötInZ⁄e
(
ödex
->
°©e
, 
z⁄e
, &
°©us
);

338 i‡(
ªsu…
 !
UDS_SUCCESS
) {

339 
	`logEº‹WôhSåögEº‹
(
ªsu…
,

341 
ödex
->
id
);

342 } i‡(
°©us
 =
CS_JUST_COMPLETED
) {

343 i‡(--
checkpoöt
->
z⁄esBusy
 == 0) {

344 
	`logInfo
("ödex_%u:áb‹ãd checkpoöt", 
ödex
->
id
);

345 
ªsu…
 = 
	`ab‹tIndexSèãCheckpoöt
(
ödex
->
°©e
);

346 i‡(
ªsu…
 !
UDS_SUCCESS
) {

347 
	`logEº‹WôhSåögEº‹
(
ªsu…
,

349 
ödex
->
id
);

351 
checkpoöt
->
°©e
 = 
NOT_CHECKPOINTING
;

354 
	`u∆ockMuãx
(&
checkpoöt
->
muãx
);

356  
ªsu…
;

357 
	}
}

360 
	$doCheckpoötFöish
(
Index
 *
ödex
, 
z⁄e
)

362 
IndexCheckpoöt
 *
checkpoöt
 = 
ödex
->checkpoint;

363 
Com∂ëi⁄Sètus
 
°©us
 = 
CS_NOT_COMPLETED
;

364 
	`u∆ockMuãx
(&
checkpoöt
->
muãx
);

365 
ªsu…
 = 
	`föishIndexSèãCheckpoötInZ⁄e
(
ödex
->
°©e
, 
z⁄e
, &
°©us
);

366 i‡(
ªsu…
 !
UDS_SUCCESS
) {

367 
	`logEº‹WôhSåögEº‹
(
ªsu…
,

369 
ödex
->
id
);

370 
	`lockMuãx
(&
checkpoöt
->
muãx
);

371 
ªsu…
 = 
	`ab‹tCheckpoötög
(
ödex
,Ñesult);

372 
	`u∆ockMuãx
(&
checkpoöt
->
muãx
);

373 } i‡(
°©us
 =
CS_JUST_COMPLETED
) {

374 
	`lockMuãx
(&
checkpoöt
->
muãx
);

375 i‡(--
checkpoöt
->
z⁄esBusy
 == 0) {

376 
checkpoöt
->
checkpoöts
 += 1;

377 
	`logInfo
("ödex_%u: föished checkpoöt", 
ödex
->
id
);

378 
ªsu…
 = 
	`föishIndexSèãCheckpoöt
(
ödex
->
°©e
);

379 i‡(
ªsu…
 !
UDS_SUCCESS
) {

380 
	`logEº‹WôhSåögEº‹
(
ªsu…
,

382 
ödex
->
id
,

383 
__func__
);

385 
checkpoöt
->
°©e
 = 
NOT_CHECKPOINTING
;

387 
	`u∆ockMuãx
(&
checkpoöt
->
muãx
);

389  
ªsu…
;

390 
	}
}

	@uds/indexCheckpoint.h

22 #i‚de‡
INDEX_CHECKPOINT_H


23 
	#INDEX_CHECKPOINT_H


	)

25 
	~"ödex.h
"

34 
	$makeIndexCheckpoöt
(
Index
 *
ödex
Ë
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

41 
	`‰ìIndexCheckpoöt
(
IndexCheckpoöt
 *
checkpoöt
);

50 
	$gëIndexCheckpoötFªquícy
(
IndexCheckpoöt
 *
checkpoöt
)

51 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

61 
	`£tIndexCheckpoötFªquícy
(
IndexCheckpoöt
 *
checkpoöt
,

62 
‰equícy
);

71 
uöt64_t
 
	$gëCheckpoötCou¡
(
IndexCheckpoöt
 *
checkpoöt
)

72 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

87 
	$föishCheckpoötög
(
Index
 *
ödex
Ë
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

104 
	$¥o˚ssCheckpoötög
(
Index
 *
ödex
,

105 
z⁄e
,

106 
uöt64_t
 
√wVútuÆCh≠ãr
)

107 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

118 
	$¥o˚ssCh≠ãrWrôîCheckpoötSaves
(
Index
 *
ödex
)

119 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

	@uds/indexComponent.c

22 
	~"ödexComp⁄ítI¡î«l.h
"

24 
	~"compûî.h
"

25 
	~"îr‹s.h
"

26 
	~"loggî.h
"

27 
	~"mem‹yAŒoc.h
"

28 
	~"≥rmas£π.h
"

29 
	~"ty≥Defs.h
"

32 
	$öôIndexComp⁄ít
(
IndexComp⁄ít
 *
comp⁄ít
,

33 c⁄° 
IndexComp⁄ítInfo
 *
öfo
,

34 
z⁄eCou¡
,

35 *
d©a
,

36 *
c⁄ãxt
,

37 c⁄° 
IndexComp⁄ítOps
 *
›s
)

39 i‡((
öfo
 =
NULL
Ë|| (öfo->
«me
 == NULL)) {

40  
	`logEº‹WôhSåögEº‹
(
UDS_INVALID_ARGUMENT
,

43 i‡(
öfo
->
lﬂdî
 =
NULL
) {

44  
	`logEº‹WôhSåögEº‹
(
UDS_INVALID_ARGUMENT
,

47 
öfo
->
«me
);

49 i‡((
öfo
->
ßvî
 =
NULL
Ë&& (öfo->
ö¸emíèl
 == NULL)) {

50  
	`logEº‹WôhSåögEº‹
(
UDS_INVALID_ARGUMENT
,

53 
öfo
->
«me
);

56 
comp⁄ít
->
öfo
 = info;

57 
comp⁄ít
->
comp⁄ítD©a
 = 
d©a
;

58 
comp⁄ít
->
c⁄ãxt
 = context;

59 
comp⁄ít
->
numZ⁄es
 = (comp⁄ít->
öfo
->
mu…iZ⁄e
 ? 
z⁄eCou¡
 : 1);

60 
comp⁄ít
->
wrôeZ⁄es
 = 
NULL
;

61 
comp⁄ít
->
›s
 = ops;

63  
UDS_SUCCESS
;

64 
	}
}

67 
	$de°royIndexComp⁄ít
(
IndexComp⁄ít
 *
comp⁄ít
)

69 i‡(
comp⁄ít
 =
NULL
) {

72 i‡(
comp⁄ít
->
wrôeZ⁄es
) {

73 
comp⁄ít
->
›s
->
	`‰ìZ⁄es
(component);

75 
	}
}

82 
	$de°royRódP‹èl
(
RódP‹èl
 *
ªadP‹èl
)

84 i‡(
ªadP‹èl
 !
NULL
) {

85 
z
 = 0; z < 
ªadP‹èl
->
z⁄es
; ++z) {

86 i‡(
ªadP‹èl
->
ªadîs
[
z
]) {

87 
	`‰ìBuf„ªdRódî
(
ªadP‹èl
->
ªadîs
[
z
]);

89 i‡(
ªadP‹èl
->
ªgi⁄s
[
z
]) {

90 
	`˛o£IORegi⁄
(&
ªadP‹èl
->
ªgi⁄s
[
z
]);

93 
	`FREE
(
ªadP‹èl
->
ªadîs
);

94 
	`FREE
(
ªadP‹èl
->
ªgi⁄s
);

96 
	}
}

98 c⁄° 
Comp⁄ítP‹èlOps
 *
gëRódP‹èlOps
();

100 
	$öôRódP‹èl
(
RódP‹èl
 *
p‹èl
,

101 
IndexComp⁄ít
 *
comp⁄ít
,

102 
ªadZ⁄es
)

104 
ªsu…
 = 
	`ALLOCATE
(
ªadZ⁄es
, 
IORegi⁄
 *, "read zone IOÑegions",

105 &
p‹èl
->
ªgi⁄s
);

106 i‡(
ªsu…
 !
UDS_SUCCESS
) {

107  
ªsu…
;

109 
ªsu…
 = 
	`ALLOCATE
(
ªadZ⁄es
, 
Buf„ªdRódî
 *, "read zone bufferedÑeaders",

110 &
p‹èl
->
ªadîs
);

111 i‡(
ªsu…
 !
UDS_SUCCESS
) {

112 
	`FREE
(
p‹èl
->
ªgi⁄s
);

113  
ªsu…
;

116 
p‹èl
->
z⁄es
 = 
ªadZ⁄es
;

118 
p‹èl
->
comm⁄
 = (
Comp⁄ítP‹èl
) {

119 .
comp⁄ít
 = component,

120 .
›s
 = 
	`gëRódP‹èlOps
(),

123  
UDS_SUCCESS
;

124 
	}
}

127 
INLINE
 
RódP‹èl
 *
	$asRódP‹èl
(
Comp⁄ítP‹èl
 *
p‹èl
)

129  
	`c⁄èöî_of
(
p‹èl
, 
RódP‹èl
, 
comm⁄
);

130 
	}
}

133 
	$Ω_cou¡Comp⁄íts
(
Comp⁄ítP‹èl
 *
p‹èl
, *
∑πs
)

135 
RódP‹èl
 *
Ω
 = 
	`asRódP‹èl
(
p‹èl
);

137 *
∑πs
 = 
Ω
->
z⁄es
;

138  
UDS_SUCCESS
;

139 
	}
}

142 
	$Ω_gëComp⁄ítSize
(
Comp⁄ítP‹èl
 *
p‹èl
,

143 
∑π
,

144 
off_t
 *
size
)

146 
RódP‹èl
 *
Ω
 = 
	`asRódP‹èl
(
p‹èl
);

148 i‡(
∑π
 >
Ω
->
z⁄es
) {

149  
	`logEº‹WôhSåögEº‹
(
UDS_INVALID_ARGUMENT
,

151 
__func__
, 
∑π
, 
Ω
->
z⁄es
);

154 i‡(
Ω
->
ªgi⁄s
[
∑π
] =
NULL
) {

155  
	`logEº‹WôhSåögEº‹
(
UDS_UNEXPECTED_RESULT
,

157 
__func__
, 
∑π
);

160  
	`gëRegi⁄D©aSize
(
Ω
->
ªgi⁄s
[
∑π
], 
size
);

161 
	}
}

164 
	$Ω_gëComp⁄ítLimô
(
Comp⁄ítP‹èl
 *
p‹èl
,

165 
∑π
,

166 
off_t
 *
limô
)

168 
RódP‹èl
 *
Ω
 = 
	`asRódP‹èl
(
p‹èl
);

170 i‡(
∑π
 >
Ω
->
z⁄es
) {

171  
	`logEº‹WôhSåögEº‹
(
UDS_INVALID_ARGUMENT
,

173 
__func__
, 
∑π
, 
Ω
->
z⁄es
);

176 i‡(
Ω
->
ªgi⁄s
[
∑π
] =
NULL
) {

177  
	`logEº‹WôhSåögEº‹
(
UDS_UNEXPECTED_RESULT
,

179 
__func__
, 
∑π
);

182  
	`gëRegi⁄Limô
(
Ω
->
ªgi⁄s
[
∑π
], 
limô
);

183 
	}
}

186 
	$Ω_gëIORegi⁄
(
Comp⁄ítP‹èl
 *
p‹èl
,

187 
∑π
,

188 
IORegi⁄
 **
ªgi⁄På
)

190 
RódP‹èl
 *
Ω
 = 
	`asRódP‹èl
(
p‹èl
);

192 i‡(
∑π
 >
Ω
->
z⁄es
) {

193  
	`logEº‹WôhSåögEº‹
(
UDS_INVALID_ARGUMENT
,

195 
__func__
, 
∑π
, 
Ω
->
z⁄es
);

198 i‡(
Ω
->
ªgi⁄s
[
∑π
] =
NULL
) {

199  
	`logEº‹WôhSåögEº‹
(
UDS_UNEXPECTED_RESULT
,

201 
__func__
, 
∑π
);

204 *
ªgi⁄På
 = 
Ω
->
ªgi⁄s
[
∑π
];

205  
UDS_SUCCESS
;

206 
	}
}

209 
	$Ω_gëBuf„ªdRódî
(
Comp⁄ítP‹èl
 *
p‹èl
,

210 
∑π
,

211 
Buf„ªdRódî
 **
ªadîPå
)

213 
RódP‹èl
 *
Ω
 = 
	`asRódP‹èl
(
p‹èl
);

215 i‡(
∑π
 >
Ω
->
z⁄es
) {

216  
	`logEº‹WôhSåögEº‹
(
UDS_INVALID_ARGUMENT
,

218 
__func__
, 
∑π
, 
Ω
->
z⁄es
);

221 i‡(
Ω
->
ªadîs
[
∑π
] =
NULL
) {

222 i‡(
Ω
->
ªgi⁄s
[
∑π
] =
NULL
) {

223  
	`logEº‹WôhSåögEº‹
(
UDS_UNEXPECTED_RESULT
,

225 
__func__
, 
∑π
);

228 
ªsu…
 = 
	`makeBuf„ªdRódî
(
Ω
->
ªgi⁄s
[
∑π
], &Ω->
ªadîs
[part]);

229 i‡(
ªsu…
 !
UDS_SUCCESS
) {

230  
	`logEº‹WôhSåögEº‹
(
ªsu…
,

232 "f‹ z⁄ê%u", 
__func__
, 
∑π
);

236 *
ªadîPå
 = 
Ω
->
ªadîs
[
∑π
];

237  
UDS_SUCCESS
;

238 
	}
}

241 
Ω_gëBuf„ªdWrôî
(
Comp⁄ítP‹èl
 *
p‹èl


242 
__©åibuã__
((
unu£d
)),

243 
∑π
 
__©åibuã__
((
unu£d
)),

244 
Buf„ªdWrôî
 **
wrôîPå


245 
__©åibuã__
((
unu£d
)))

247  
logEº‹WôhSåögEº‹
(
UDS_BAD_IO_DIRECTION
,

253 c⁄° 
Comp⁄ítP‹èlOps
 
	gªadP‹èlOps
 = {

254 .
cou¡
 = 
Ω_cou¡Comp⁄íts
,

255 .
	ggëSize
 = 
Ω_gëComp⁄ítSize
,

256 .
	ggëLimô
 = 
Ω_gëComp⁄ítLimô
,

257 .
	ggëRegi⁄
 = 
Ω_gëIORegi⁄
,

258 .
	ggëRódî
 = 
Ω_gëBuf„ªdRódî
,

259 .
	ggëWrôî
 = 
Ω_gëBuf„ªdWrôî
,

262 c⁄° 
Comp⁄ítP‹èlOps
 *
	$gëRódP‹èlOps
()

264  &
ªadP‹èlOps
;

265 
	}
}

268 
	$ªadIndexComp⁄ít
(
IndexComp⁄ít
 *
comp⁄ít
)

270 
RódP‹èl
 *
ªadP‹èl
 = 
NULL
;

271 
ªsu…
 = 
comp⁄ít
->
›s
->
	`¸óãRódP‹èl
(comp⁄ít, &
ªadP‹èl
);

272 i‡(
ªsu…
 !
UDS_SUCCESS
) {

273  
ªsu…
;

276 
ªsu…
 = (*
comp⁄ít
->
öfo
->
lﬂdî
)(&
ªadP‹èl
->
comm⁄
);

278 
comp⁄ít
->
›s
->
	`‰ìRódP‹èl
(
ªadP‹èl
);

279  
ªsu…
;

280 
	}
}

291 
	$ªsﬁveWrôeZ⁄e
(c⁄° 
IndexComp⁄ít
 *
comp⁄ít
,

292 
z⁄e
,

293 
WrôeZ⁄e
 **
wrôeZ⁄ePå
)

295 
ªsu…
 = 
	`ASSERT
(
wrôeZ⁄ePå
 !
NULL
,

297 i‡(
ªsu…
 !
UDS_SUCCESS
) {

298  
ªsu…
;

301 i‡(
comp⁄ít
->
wrôeZ⁄es
 =
NULL
) {

302  
	`logEº‹WôhSåögEº‹
(
UDS_BAD_STATE
,

307 i‡(
z⁄e
 >
comp⁄ít
->
numZ⁄es
) {

308  
	`logEº‹WôhSåögEº‹
(
UDS_INVALID_ARGUMENT
,

312 *
wrôeZ⁄ePå
 = 
comp⁄ít
->
wrôeZ⁄es
[
z⁄e
];

313  
UDS_SUCCESS
;

314 
	}
}

326 
	$ödexComp⁄ítSavîIn¸emíèlWøµî
(
IndexComp⁄ít
 *
comp⁄ít
,

327 
Buf„ªdWrôî
 *
wrôî
,

328 
z⁄e
)

330 
In¸emíèlWrôî
 
ö¸Func
 = 
comp⁄ít
->
öfo
->
ö¸emíèl
;

331 
boﬁ
 
com∂ëed
 = 
Ál£
;

333 
ªsu…
 = (*
ö¸Func
)(
comp⁄ít
, 
wrôî
, 
z⁄e
, 
IWC_START
, &
com∂ëed
);

334 i‡(
ªsu…
 !
UDS_SUCCESS
) {

335  
ªsu…
;

338 i‡(!
com∂ëed
) {

339 
ªsu…
 = (*
ö¸Func
)(
comp⁄ít
, 
wrôî
, 
z⁄e
, 
IWC_FINISH
, &
com∂ëed
);

340 i‡(
ªsu…
 !
UDS_SUCCESS
) {

341  
ªsu…
;

345 
ªsu…
 = 
	`ÊushBuf„ªdWrôî
(
wrôî
);

346 i‡(
ªsu…
 !
UDS_SUCCESS
) {

347  
ªsu…
;

350  
UDS_SUCCESS
;

351 
	}
}

365 
	$d⁄eWôhZ⁄e
(
WrôeZ⁄e
 *
wrôeZ⁄e
)

367 c⁄° 
IndexComp⁄ít
 *
comp⁄ít
 = 
wrôeZ⁄e
->component;

368 
ªsu…
 = 
UDS_SUCCESS
;

370 i‡(
wrôeZ⁄e
->
wrôî
 !
NULL
) {

371 
ªsu…
 = 
	`ÊushBuf„ªdWrôî
(
wrôeZ⁄e
->
wrôî
);

372 i‡(
ªsu…
 !
UDS_SUCCESS
) {

373  
	`logEº‹WôhSåögEº‹
(
ªsu…
,

376 
comp⁄ít
->
öfo
->
«me
, 
wrôeZ⁄e
->
z⁄e
);

379 i‡(
wrôeZ⁄e
->
ªgi⁄
 =
NULL
) {

380  
UDS_SUCCESS
;

382  
	`syncAndClo£Regi⁄
(&
wrôeZ⁄e
->
ªgi⁄
,

384 
	}
}

387 
	$de°royWrôeZ⁄e
(
WrôeZ⁄e
 *
wrôeZ⁄e
)

389 i‡(
wrôeZ⁄e
 =
NULL
) {

392 
	`‰ìBuf„ªdWrôî
(
wrôeZ⁄e
->
wrôî
);

393 
	`˛o£IORegi⁄
(&
wrôeZ⁄e
->
ªgi⁄
);

394 
wrôeZ⁄e
->
wrôî
 = 
NULL
;

395 
	}
}

398 
‰ìWrôeZ⁄esHñ≥r
(
IndexComp⁄ít
 *
comp⁄ít
,

399 (*
z⁄eFªeFunc
)(
WrôeZ⁄e
 *))

401 i‡(
comp⁄ít
->
wrôeZ⁄es
 !
NULL
) {

402 
z
 = 0; z < 
comp⁄ít
->
numZ⁄es
; ++z) {

403 
WrôeZ⁄e
 *
wz
 = 
comp⁄ít
->
wrôeZ⁄es
[
z
];

404 i‡(
wz
 =
NULL
) {

407 
	`de°royWrôeZ⁄e
(
wz
);

408 i‡(
z⁄eFªeFunc
 !
NULL
) {

409 
	`z⁄eFªeFunc
(
comp⁄ít
->
wrôeZ⁄es
[
z
]);

411 
	`FREE
(
wz
);

414 
	`FREE
(
comp⁄ít
->
wrôeZ⁄es
);

415 
comp⁄ít
->
wrôeZ⁄es
 = 
NULL
;

417 
	}
}

429 
	$makeWrôeZ⁄es
(
IndexComp⁄ít
 *
comp⁄ít
)

431 i‡(
comp⁄ít
->
wrôeZ⁄es
 !
NULL
) {

433 
z
 = 0; z < 
comp⁄ít
->
numZ⁄es
; ++z) {

434 
WrôeZ⁄e
 *
wz
 = 
comp⁄ít
->
wrôeZ⁄es
[
z
];

435 
wz
->
pha£
 = 
IWC_IDLE
;

437  
UDS_SUCCESS
;

440 
ªsu…
 = 
	`ALLOCATE
(
comp⁄ít
->
numZ⁄es
, 
WrôeZ⁄e
 *,

442 &
comp⁄ít
->
wrôeZ⁄es
);

443 i‡(
ªsu…
 !
UDS_SUCCESS
) {

444  
ªsu…
;

447 
ªsu…
 = 
comp⁄ít
->
›s
->
	`p›uœãZ⁄es
(component);

448 i‡(
ªsu…
 !
UDS_SUCCESS
) {

449 
comp⁄ít
->
›s
->
	`‰ìZ⁄es
(component);

450  
ªsu…
;

452  
UDS_SUCCESS
;

453 
	}
}

456 
	$›íBuf„ªdWrôîs
(
IndexComp⁄ít
 *
comp⁄ít
)

458 
ªsu…
 = 
UDS_SUCCESS
;

460 
WrôeZ⁄e
 **
wzp
 = 
comp⁄ít
->
wrôeZ⁄es
;

461 
wzp
 < 
comp⁄ít
->
wrôeZ⁄es
 + comp⁄ít->
numZ⁄es
;

462 ++
wzp
)

464 
WrôeZ⁄e
 *
wz
 = *
wzp
;

465 
wz
->
pha£
 = 
IWC_START
;

467 
ªsu…
 = 
	`ASSERT
(
wz
->
ªgi⁄
 =
NULL
, "write zoneÑegionálreadyÉxists");

468 i‡(
ªsu…
 !
UDS_SUCCESS
) {

469  
ªsu…
;

472 
ªsu…
 = 
	`ASSERT
(
wz
->
wrôî
 =
NULL
, "write zone writerálreadyÉxists");

473 i‡(
ªsu…
 !
UDS_SUCCESS
) {

474  
ªsu…
;

477 
ªsu…
 = 
comp⁄ít
->
›s
->
	`›íWrôeRegi⁄
(
wz
);

478 i‡(
ªsu…
 !
UDS_SUCCESS
) {

482 
ªsu…
 = 
	`makeBuf„ªdWrôî
(
wz
->
ªgi⁄
, 0, &wz->
wrôî
);

483 i‡(
ªsu…
 !
UDS_SUCCESS
) {

484 
	`˛o£IORegi⁄
(&
wz
->
ªgi⁄
);

485  
ªsu…
;

489  
ªsu…
;

490 
	}
}

493 
	$°¨tIndexComp⁄ítSave
(
IndexComp⁄ít
 *
comp⁄ít
)

495 
ªsu…
 = 
	`makeWrôeZ⁄es
(
comp⁄ít
);

496 i‡(
ªsu…
 !
UDS_SUCCESS
) {

497  
ªsu…
;

500 
ªsu…
 = 
comp⁄ít
->
›s
->
	`¥ï¨eZ⁄es
(comp⁄ít, comp⁄ít->
numZ⁄es
);

501 i‡(
ªsu…
 !
UDS_SUCCESS
) {

502  
ªsu…
;

505 
ªsu…
 = 
	`›íBuf„ªdWrôîs
(
comp⁄ít
);

506 i‡(
ªsu…
 !
UDS_SUCCESS
) {

507  
ªsu…
;

510  
UDS_SUCCESS
;

511 
	}
}

514 
	$°¨tIndexComp⁄ítIn¸emíèlSave
(
IndexComp⁄ít
 *
comp⁄ít
)

516  
	`°¨tIndexComp⁄ítSave
(
comp⁄ít
);

517 
	}
}

520 
	$wrôeIndexComp⁄ít
(
IndexComp⁄ít
 *
comp⁄ít
)

522 
Savî
 
ßvî
 = 
comp⁄ít
->
öfo
->saver;

523 i‡((
ßvî
 =
NULL
Ë&& (
comp⁄ít
->
öfo
->
ö¸emíèl
 != NULL)) {

524 
ßvî
 = 
ödexComp⁄ítSavîIn¸emíèlWøµî
;

527 
ªsu…
 = 
	`°¨tIndexComp⁄ítSave
(
comp⁄ít
);

528 i‡(
ªsu…
 !
UDS_SUCCESS
) {

529  
ªsu…
;

532 
z
 = 0; z < 
comp⁄ít
->
numZ⁄es
; ++z) {

533 
WrôeZ⁄e
 *
wrôeZ⁄e
 = 
comp⁄ít
->
wrôeZ⁄es
[
z
];

535 
ªsu…
 = (*
ßvî
)(
comp⁄ít
, 
wrôeZ⁄e
->
wrôî
, 
z
);

536 i‡(
ªsu…
 !
UDS_SUCCESS
) {

540 
ªsu…
 = 
	`d⁄eWôhZ⁄e
(
wrôeZ⁄e
);

541 i‡(
ªsu…
 !
UDS_SUCCESS
) {

545 
	`‰ìBuf„ªdWrôî
(
wrôeZ⁄e
->
wrôî
);

546 
wrôeZ⁄e
->
wrôî
 = 
NULL
;

549 i‡(
ªsu…
 !
UDS_SUCCESS
) {

550 
comp⁄ít
->
›s
->
	`‰ìZ⁄es
(component);

551 
comp⁄ít
->
›s
->
	`˛ónupWrôe
(component);

552  
	`logEº‹WôhSåögEº‹
(
ªsu…
, "index component write failed");

555  
UDS_SUCCESS
;

556 
	}
}

568 
	$˛o£Buf„ªdWrôî
(
WrôeZ⁄e
 *
wrôeZ⁄e
)

570 i‡(
wrôeZ⁄e
->
wrôî
 =
NULL
) {

571  
UDS_SUCCESS
;

574 
ªsu…
 = 
	`d⁄eWôhZ⁄e
(
wrôeZ⁄e
);

575 
	`‰ìBuf„ªdWrôî
(
wrôeZ⁄e
->
wrôî
);

576 
wrôeZ⁄e
->
wrôî
 = 
NULL
;

578  
ªsu…
;

579 
	}
}

596 
	$wøpSavîAsIn¸emíèl
(
IndexComp⁄ít
 *
comp⁄ít
,

597 
Buf„ªdWrôî
 *
wrôî
,

598 
z⁄e
,

599 
In¸emíèlWrôîComm™d
 
comm™d
,

600 
boﬁ
 *
com∂ëed
)

602 
ªsu…
 = 
UDS_SUCCESS
;

604 i‡((
comm™d
 >
IWC_START
Ë&& (comm™d <
IWC_FINISH
)) {

605 
ªsu…
 = (*
comp⁄ít
->
öfo
->
ßvî
)(comp⁄ít, 
wrôî
, 
z⁄e
);

606 i‡(
ªsu…
 =
UDS_SUCCESS
) {

607 
	`nŸeBuf„ªdWrôîU£d
(
wrôî
);

610 i‡((
ªsu…
 =
UDS_SUCCESS
Ë&& (
com∂ëed
 !
NULL
)) {

611 *
com∂ëed
 = 
åue
;

613  
ªsu…
;

614 
	}
}

625 
In¸emíèlWrôî
 
	$gëIn¸emíèlWrôî
(
IndexComp⁄ít
 *
comp⁄ít
)

627 
In¸emíèlWrôî
 
ö¸Func
 = 
comp⁄ít
->
öfo
->
ö¸emíèl
;

629 i‡(
ö¸Func
 =
NULL
) {

630 
ö¸Func
 = &
wøpSavîAsIn¸emíèl
;

633  
ö¸Func
;

634 
	}
}

637 
	$≥rf‹mIndexComp⁄ítZ⁄eSave
(
IndexComp⁄ít
 *
comp⁄ít
,

638 
z⁄e
,

639 
Com∂ëi⁄Sètus
 *
com∂ëed
)

641 
Com∂ëi⁄Sètus
 
comp
 = 
CS_NOT_COMPLETED
;

643 
WrôeZ⁄e
 *
wz
 = 
NULL
;

644 
ªsu…
 = 
	`ªsﬁveWrôeZ⁄e
(
comp⁄ít
, 
z⁄e
, &
wz
);

645 i‡(
ªsu…
 !
UDS_SUCCESS
) {

646  
ªsu…
;

649 i‡(
wz
->
pha£
 =
IWC_IDLE
) {

650 
comp
 = 
CS_COMPLETED_PREVIOUSLY
;

651 } i‡(
wz
->
pha£
 =
IWC_DONE
) {

652 
comp
 = 
CS_JUST_COMPLETED
;

653 
wz
->
pha£
 = 
IWC_IDLE
;

654 } i‡(!
comp⁄ít
->
öfo
->
ch≠ãrSync
) {

655 
boﬁ
 
d⁄e
 = 
Ál£
;

656 
In¸emíèlWrôî
 
ö¸Func
 = 
	`gëIn¸emíèlWrôî
(
comp⁄ít
);

657 
ªsu…
 = (*
ö¸Func
)(
comp⁄ít
, 
wz
->
wrôî
, 
z⁄e
, wz->
pha£
, &
d⁄e
);

658 i‡(
ªsu…
 !
UDS_SUCCESS
) {

659 i‡(
wz
->
pha£
 =
IWC_ABORT
) {

660 
wz
->
pha£
 = 
IWC_IDLE
;

662 
wz
->
pha£
 = 
IWC_ABORT
;

664  
ªsu…
;

666 i‡(
d⁄e
) {

667 
comp
 = 
CS_JUST_COMPLETED
;

668 
wz
->
pha£
 = 
IWC_IDLE
;

669 } i‡(
wz
->
pha£
 =
IWC_START
) {

670 
wz
->
pha£
 = 
IWC_CONTINUE
;

674 i‡(
com∂ëed
 !
NULL
) {

675 *
com∂ëed
 = 
comp
;

677  
UDS_SUCCESS
;

678 
	}
}

681 
	$≥rf‹mIndexComp⁄ítCh≠ãrWrôîSave
(
IndexComp⁄ít
 *
comp⁄ít
)

683 
WrôeZ⁄e
 *
wz
 = 
NULL
;

684 
ªsu…
 = 
	`ªsﬁveWrôeZ⁄e
(
comp⁄ít
, 0, &
wz
);

685 i‡(
ªsu…
 !
UDS_SUCCESS
) {

686  
ªsu…
;

689 i‡((
wz
->
pha£
 !
IWC_IDLE
Ë&& (wz->pha£ !
IWC_DONE
)) {

690 
boﬁ
 
d⁄e
 = 
Ál£
;

691 
In¸emíèlWrôî
 
ö¸Func
 = 
	`gëIn¸emíèlWrôî
(
comp⁄ít
);

692 
ªsu…
 = 
	`ASSERT
(
ö¸Func
 !
NULL
, "no writer function");

693 i‡(
ªsu…
 !
UDS_SUCCESS
) {

694  
ªsu…
;

696 
ªsu…
 = (*
ö¸Func
)(
comp⁄ít
, 
wz
->
wrôî
, 0, wz->
pha£
, &
d⁄e
);

697 i‡(
ªsu…
 !
UDS_SUCCESS
) {

698 i‡(
wz
->
pha£
 =
IWC_ABORT
) {

699 
wz
->
pha£
 = 
IWC_IDLE
;

701 
wz
->
pha£
 = 
IWC_ABORT
;

703  
ªsu…
;

705 i‡(
d⁄e
) {

706 
wz
->
pha£
 = 
IWC_DONE
;

707 } i‡(
wz
->
pha£
 =
IWC_START
) {

708 
wz
->
pha£
 = 
IWC_CONTINUE
;

711  
UDS_SUCCESS
;

712 
	}
}

715 
	$föishIndexComp⁄ítZ⁄eSave
(
IndexComp⁄ít
 *
comp⁄ít
,

716 
z⁄e
,

717 
Com∂ëi⁄Sètus
 *
com∂ëed
)

719 
WrôeZ⁄e
 *
wz
 = 
NULL
;

720 
ªsu…
 = 
	`ªsﬁveWrôeZ⁄e
(
comp⁄ít
, 
z⁄e
, &
wz
);

721 i‡(
ªsu…
 !
UDS_SUCCESS
) {

722  
ªsu…
;

725 
Com∂ëi⁄Sètus
 
comp
;

726 
wz
->
pha£
) {

727 
IWC_IDLE
:

728 
comp
 = 
CS_COMPLETED_PREVIOUSLY
;

731 
IWC_DONE
:

732 
comp
 = 
CS_JUST_COMPLETED
;

736 
comp
 = 
CS_NOT_COMPLETED
;

739 
In¸emíèlWrôî
 
ö¸Func
 = 
	`gëIn¸emíèlWrôî
(
comp⁄ít
);

740 i‡((
wz
->
pha£
 >
IWC_START
Ë&& (wz->pha£ < 
IWC_ABORT
)) {

741 
boﬁ
 
d⁄e
 = 
Ál£
;

742 
ªsu…
 = (*
ö¸Func
)(
comp⁄ít
, 
wz
->
wrôî
, 
z⁄e
, 
IWC_FINISH
, &
d⁄e
);

743 i‡(
ªsu…
 !
UDS_SUCCESS
) {

744 
wz
->
pha£
 = 
IWC_ABORT
;

745  
ªsu…
;

747 i‡(!
d⁄e
) {

748 
	`logW¨nög
("finish incremental save didÇot complete for %s zone %u",

749 
comp⁄ít
->
öfo
->
«me
, 
z⁄e
);

750  
UDS_CHECKPOINT_INCOMPLETE
;

752 
wz
->
pha£
 = 
IWC_IDLE
;

753 
comp
 = 
CS_JUST_COMPLETED
;

756 i‡(
com∂ëed
 !
NULL
) {

757 *
com∂ëed
 = 
comp
;

759  
UDS_SUCCESS
;

760 
	}
}

763 
	$föishIndexComp⁄ítIn¸emíèlSave
(
IndexComp⁄ít
 *
comp⁄ít
)

765 
z⁄e
 = 0; z⁄ê< 
comp⁄ít
->
numZ⁄es
; ++zone) {

766 
WrôeZ⁄e
 *
wz
 = 
comp⁄ít
->
wrôeZ⁄es
[
z⁄e
];

767 
In¸emíèlWrôî
 
ö¸Func
 = 
	`gëIn¸emíèlWrôî
(
comp⁄ít
);

768 i‡((
wz
->
pha£
 !
IWC_IDLE
Ë&& (wz->pha£ !
IWC_DONE
)) {

771 
boﬁ
 
d⁄e
 = 
Ál£
;

772 
ªsu…
 = (*
ö¸Func
)(
comp⁄ít
, 
wz
->
wrôî
, 
z⁄e
, 
IWC_FINISH
, &
d⁄e
);

773 i‡(
ªsu…
 !
UDS_SUCCESS
) {

774  
ªsu…
;

776 i‡(!
d⁄e
) {

777 
	`logW¨nög
("finishing incremental save didÇot complete for %s zone %u",

778 
comp⁄ít
->
öfo
->
«me
, 
z⁄e
);

779  
UDS_UNEXPECTED_RESULT
;

781 
wz
->
pha£
 = 
IWC_IDLE
;

784 i‡((
wz
->
wrôî
 !
NULL
Ë&& !
	`wasBuf„ªdWrôîU£d
(wz->writer)) {

785  
	`logEº‹WôhSåögEº‹
(
UDS_CHECKPOINT_INCOMPLETE
,

787 
comp⁄ít
->
öfo
->
«me
, 
z⁄e
);

790 
ªsu…
 = 
	`˛o£Buf„ªdWrôî
(
wz
);

791 i‡(
ªsu…
 !
UDS_SUCCESS
) {

792  
ªsu…
;

796  
UDS_SUCCESS
;

797 
	}
}

800 
	$ab‹tIndexComp⁄ítZ⁄eSave
(
IndexComp⁄ít
 *
comp⁄ít
,

801 
z⁄e
,

802 
Com∂ëi⁄Sètus
 *
°©us
)

804 
WrôeZ⁄e
 *
wz
 = 
NULL
;

805 
ªsu…
 = 
	`ªsﬁveWrôeZ⁄e
(
comp⁄ít
, 
z⁄e
, &
wz
);

806 i‡(
ªsu…
 !
UDS_SUCCESS
) {

807  
ªsu…
;

810 
Com∂ëi⁄Sètus
 
comp
 = 
CS_COMPLETED_PREVIOUSLY
;

812 
In¸emíèlWrôî
 
ö¸Func
 = 
	`gëIn¸emíèlWrôî
(
comp⁄ít
);

813 i‡((
wz
->
pha£
 !
IWC_IDLE
Ë&& (wz->pha£ !
IWC_DONE
)) {

814 
ªsu…
 = (*
ö¸Func
)(
comp⁄ít
, 
wz
->
wrôî
, 
z⁄e
, 
IWC_ABORT
, 
NULL
);

815 
wz
->
pha£
 = 
IWC_IDLE
;

816 i‡(
ªsu…
 !
UDS_SUCCESS
) {

817  
ªsu…
;

819 
comp
 = 
CS_JUST_COMPLETED
;

822 i‡(
°©us
 !
NULL
) {

823 *
°©us
 = 
comp
;

825  
UDS_SUCCESS
;

826 
	}
}

829 
	$ab‹tIndexComp⁄ítIn¸emíèlSave
(
IndexComp⁄ít
 *
comp⁄ít
)

831 
ªsu…
 = 
UDS_SUCCESS
;

833 
z⁄e
 = 0; z⁄ê< 
comp⁄ít
->
numZ⁄es
; ++zone) {

834 
WrôeZ⁄e
 *
wz
 = 
comp⁄ít
->
wrôeZ⁄es
[
z⁄e
];

835 
In¸emíèlWrôî
 
ö¸Func
 = 
	`gëIn¸emíèlWrôî
(
comp⁄ít
);

836 i‡((
wz
->
pha£
 !
IWC_IDLE
Ë&& (wz->pha£ !
IWC_DONE
)) {

839 
ªsu…
 = (*
ö¸Func
)(
comp⁄ít
, 
wz
->
wrôî
, 
z⁄e
, 
IWC_ABORT
, 
NULL
);

840 
wz
->
pha£
 = 
IWC_IDLE
;

841 i‡(
ªsu…
 !
UDS_SUCCESS
) {

842  
ªsu…
;

846 
ªsu…
 = 
	`˛o£Buf„ªdWrôî
(
wz
);

847 i‡(
ªsu…
 !
UDS_SUCCESS
) {

848  
ªsu…
;

852  
UDS_SUCCESS
;

853 
	}
}

	@uds/indexComponent.h

22 #i‚de‡
INDEX_COMPONENT_H


23 
	#INDEX_COMPONENT_H
 1

	)

25 
	~"comm⁄.h
"

27 
	~"buf„ªdWrôî.h
"

28 
	~"compûî.h
"

29 
	~"comp⁄ítP‹èl.h
"

30 
	~"ªgi⁄Idítifõrs.h
"

34 
	ecom∂ëi⁄Sètus
 {

35 
	mCS_NOT_COMPLETED
,

36 
	mCS_JUST_COMPLETED
,

37 
	mCS_COMPLETED_PREVIOUSLY


38 } 
	tCom∂ëi⁄Sètus
;

48 (*
	tLﬂdî
)(
	tComp⁄ítP‹èl
 *
	tp‹èl
);

59 (*
	tSavî
)(
	tIndexComp⁄ít
 *
	tcomp⁄ít
,

60 
	tBuf„ªdWrôî
 *
	twrôî
,

61 
	tz⁄e
);

66 
	eö¸emíèlWrôîComm™d
 {

67 
IWC_START
,

68 
IWC_CONTINUE
,

69 
IWC_FINISH
,

70 
IWC_ABORT
,

71 
IWC_IDLE
 = -1,

72 
IWC_DONE
 = -2

73 } 
	tIn¸emíèlWrôîComm™d
;

84 (*
	tIn¸emíèlWrôî
)(
	tIndexComp⁄ít
 *
	tcomp⁄ít
,

85 
	tBuf„ªdWrôî
 *
	twrôî
,

86 
	tz⁄e
,

87 
	tIn¸emíèlWrôîComm™d
 
	tcomm™d
,

88 
	tboﬁ
 *
	tcom∂ëed
);

95 
Regi⁄Köd
 
köd
;

96 c⁄° *
«me
;

97 c⁄° *
fûeName
;

98 
boﬁ
 
ßveO∆y
;

99 
boﬁ
 
ch≠ãrSync
;

100 
boﬁ
 
mu…iZ⁄e
;

101 
Lﬂdî
 
lﬂdî
;

102 
Savî
 
ßvî
;

103 
In¸emíèlWrôî
 
ö¸emíèl
;

104 } 
	tIndexComp⁄ítInfo
;

111 
ölöe
 
	`‰ìIndexComp⁄ít
(
IndexComp⁄ít
 **
comp⁄ítPå
);

116 
ölöe
 c⁄° *
	`ödexComp⁄ítName
(
IndexComp⁄ít
 *
comp⁄ít
);

121 
ölöe
 *
	`ödexComp⁄ítD©a
(
IndexComp⁄ít
 *
comp⁄ít
);

126 
ölöe
 *
	`ödexComp⁄ítC⁄ãxt
(
IndexComp⁄ít
 *
comp⁄ít
);

131 
ölöe
 c⁄° *
	`comp⁄ítNameF‹P‹èl
(
Comp⁄ítP‹èl
 *
p‹èl
);

136 
ölöe
 *
	`comp⁄ítD©aF‹P‹èl
(
Comp⁄ítP‹èl
 *
p‹èl
);

141 
ölöe
 *
	`comp⁄ítC⁄ãxtF‹P‹èl
(
Comp⁄ítP‹èl
 *
p‹èl
);

150 
ölöe
 
boﬁ
 
	`skùIndexComp⁄ítOnCheckpoöt
(
IndexComp⁄ít
 *
comp⁄ít
);

156 
ölöe
 
boﬁ


157 
	`de„rIndexComp⁄ítCheckpoötToCh≠ãrWrôî
(
IndexComp⁄ít
 *
comp⁄ít
);

166 
ölöe
 
boﬁ


167 
	`missögIndexComp⁄ítRequúesRïœy
(
IndexComp⁄ít
 *
comp⁄ít
);

177 
	$ªadIndexComp⁄ít
(
IndexComp⁄ít
 *
comp⁄ít
)

178 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

188 
	$wrôeIndexComp⁄ít
(
IndexComp⁄ít
 *
comp⁄ít
)

189 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

198 
	$°¨tIndexComp⁄ítIn¸emíèlSave
(
IndexComp⁄ít
 *
comp⁄ít
)

199 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

213 
	$≥rf‹mIndexComp⁄ítZ⁄eSave
(
IndexComp⁄ít
 *
comp⁄ít
,

214 
z⁄e
,

215 
Com∂ëi⁄Sètus
 *
com∂ëed
)

216 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

224 
	$≥rf‹mIndexComp⁄ítCh≠ãrWrôîSave
(
IndexComp⁄ít
 *
comp⁄ít
)

225 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

237 
	$föishIndexComp⁄ítZ⁄eSave
(
IndexComp⁄ít
 *
comp⁄ít
,

238 
z⁄e
,

239 
Com∂ëi⁄Sètus
 *
com∂ëed
)

240 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

255 
	$föishIndexComp⁄ítIn¸emíèlSave
(
IndexComp⁄ít
 *
comp⁄ít
)

256 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

271 
	$ab‹tIndexComp⁄ítZ⁄eSave
(
IndexComp⁄ít
 *
comp⁄ít
,

272 
z⁄e
,

273 
Com∂ëi⁄Sètus
 *
com∂ëed
)

274 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

288 
	$ab‹tIndexComp⁄ítIn¸emíèlSave
(
IndexComp⁄ít
 *
comp⁄ít
)

289 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

297 
ölöe
 
	$disˇrdIndexComp⁄ít
(
IndexComp⁄ít
 *
comp⁄ít
)

298 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

300 
	#INDEX_COMPONENT_INLINE


	)

301 
	~"ödexComp⁄ítI∆öe.h
"

302 #unde‡
INDEX_COMPONENT_INLINE


	@uds/indexComponentInline.h

22 #i‚de‡
INDEX_COMPONENT_INLINE_H


23 
	#INDEX_COMPONENT_INLINE_H


	)

25 #i‚de‡
INDEX_COMPONENT_INLINE


29 
	~"compûî.h
"

31 
ªadP‹èl
 
	tRódP‹èl
;

32 
wrôeZ⁄e
 
	tWrôeZ⁄e
;

34 
	södexComp⁄ítOps
 {

35 (*
	m‰ìMe
)(
	mIndexComp⁄ít
 *);

36 (*
	m›íWrôeRegi⁄
)(
	mWrôeZ⁄e
 *);

37 (*
	m˛ónupWrôe
)(
	mIndexComp⁄ít
 *);

38 (*
	mp›uœãZ⁄es
)(
	mIndexComp⁄ít
 *);

39 (*
	m‰ìZ⁄es
)(
	mIndexComp⁄ít
 *);

40 (*
	m¥ï¨eZ⁄es
)(
	mIndexComp⁄ít
 *, );

41 (*
	m¸óãRódP‹èl
)(
	mIndexComp⁄ít
 *, 
	mRódP‹èl
 **);

42 (*
	m‰ìRódP‹èl
)(
	mRódP‹èl
 *);

43 (*
	mdisˇrd
)(
	mIndexComp⁄ít
 *);

44 } 
	tIndexComp⁄ítOps
;

49 
	södexComp⁄ít
 {

50 c⁄° 
IndexComp⁄ítInfo
 *
	möfo
;

51 *
	mcomp⁄ítD©a
;

52 *
	mc⁄ãxt
;

53 
	mnumZ⁄es
;

54 
WrôeZ⁄e
 **
	mwrôeZ⁄es
;

55 c⁄° 
IndexComp⁄ítOps
 *
	m›s
;

59 
INLINE
 
	$‰ìIndexComp⁄ít
(
IndexComp⁄ít
 **
comp⁄ítPå
)

61 i‡(
comp⁄ítPå
 =
NULL
 || *componentPtr == NULL) {

64 (*
comp⁄ítPå
)->
›s
->
	`‰ìMe
(*componentPtr);

65 *
comp⁄ítPå
 = 
NULL
;

66 
	}
}

69 
INLINE
 c⁄° *
	$ödexComp⁄ítName
(
IndexComp⁄ít
 *
comp⁄ít
)

71  
comp⁄ít
->
öfo
->
«me
;

72 
	}
}

75 
INLINE
 *
	$ödexComp⁄ítD©a
(
IndexComp⁄ít
 *
comp⁄ít
)

77  
comp⁄ít
->
comp⁄ítD©a
;

78 
	}
}

81 
INLINE
 *
	$ödexComp⁄ítC⁄ãxt
(
IndexComp⁄ít
 *
comp⁄ít
)

83  
comp⁄ít
->
c⁄ãxt
;

84 
	}
}

87 
INLINE
 c⁄° *
	$comp⁄ítNameF‹P‹èl
(
Comp⁄ítP‹èl
 *
p‹èl
)

89  
	`ödexComp⁄ítName
(
	`ödexComp⁄ítF‹P‹èl
(
p‹èl
));

90 
	}
}

93 
INLINE
 *
	$comp⁄ítD©aF‹P‹èl
(
Comp⁄ítP‹èl
 *
p‹èl
)

95  
	`ödexComp⁄ítD©a
(
	`ödexComp⁄ítF‹P‹èl
(
p‹èl
));

96 
	}
}

99 
INLINE
 *
	$comp⁄ítC⁄ãxtF‹P‹èl
(
Comp⁄ítP‹èl
 *
p‹èl
)

101  
	`ödexComp⁄ítC⁄ãxt
(
	`ödexComp⁄ítF‹P‹èl
(
p‹èl
));

102 
	}
}

105 
INLINE
 
boﬁ
 
	$skùIndexComp⁄ítOnCheckpoöt
(
IndexComp⁄ít
 *
comp⁄ít
)

107  
comp⁄ít
->
öfo
->
ßveO∆y
;

108 
	}
}

111 
INLINE
 
boﬁ


112 
	$de„rIndexComp⁄ítCheckpoötToCh≠ãrWrôî
(
IndexComp⁄ít
 *
comp⁄ít
)

114  
comp⁄ít
->
öfo
->
ch≠ãrSync
;

115 
	}
}

118 
INLINE
 
boﬁ


119 
	$missögIndexComp⁄ítRequúesRïœy
(
IndexComp⁄ít
 *
comp⁄ít
)

121  
comp⁄ít
->
öfo
->
ßveO∆y
;

122 
	}
}

125 
INLINE
 
	$disˇrdIndexComp⁄ít
(
IndexComp⁄ít
 *
comp⁄ít
)

127  
comp⁄ít
->
›s
->
	`disˇrd
(component);

128 
	}
}

	@uds/indexComponentInternal.h

22 #i‚de‡
INDEX_COMPONENT_INTERNAL_H


23 
	#INDEX_COMPONENT_INTERNAL_H


	)

25 
	~"ödexComp⁄ít.h
"

27 
	sªadP‹èl
 {

28 
	mz⁄es
;

29 
Comp⁄ítP‹èl
 
	mcomm⁄
;

30 
IORegi⁄
 **
	mªgi⁄s
;

31 
Buf„ªdRódî
 **
	mªadîs
;

34 
	swrôeZ⁄e
 {

35 
IndexComp⁄ít
 *
	mcomp⁄ít
;

36 
In¸emíèlWrôîComm™d
 
	mpha£
;

37 
IORegi⁄
 *
	mªgi⁄
;

38 
Buf„ªdWrôî
 *
	mwrôî
;

39 
	mz⁄e
;

54 
	$öôIndexComp⁄ít
(
IndexComp⁄ít
 *
comp⁄ít
,

55 c⁄° 
IndexComp⁄ítInfo
 *
öfo
,

56 
z⁄eCou¡
,

57 *
d©a
,

58 *
c⁄ãxt
,

59 c⁄° 
IndexComp⁄ítOps
 *
›s
)

60 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

67 
	`de°royIndexComp⁄ít
(
IndexComp⁄ít
 *
comp⁄ít
);

79 
	$öôRódP‹èl
(
RódP‹èl
 *
p‹èl
,

80 
IndexComp⁄ít
 *
comp⁄ít
,

81 
ªadZ⁄es
)

82 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

89 
	`de°royRódP‹èl
(
RódP‹èl
 *
ªadP‹èl
);

96 
	`de°royWrôeZ⁄e
(
WrôeZ⁄e
 *
wrôeZ⁄e
);

104 
	`‰ìWrôeZ⁄esHñ≥r
(
IndexComp⁄ít
 *
comp⁄ít
,

105 (*
z⁄eFªeFunc
)(
WrôeZ⁄e
 *
wz
));

	@uds/indexConfig.c

22 
	~"ödexC⁄fig.h
"

24 
	~"loggî.h
"

25 
	~"mem‹yAŒoc.h
"

27 c⁄° 
byã
 
	gINDEX_CONFIG_MAGIC
[] = "ALBIC";

28 c⁄° 
byã
 
	gINDEX_CONFIG_VERSION
[] = "06.01";

29 c⁄° 
byã
 
	gINDEX_CONFIG_VERSION_4_13
[] = "04.13";

30 c⁄° 
byã
 
	gINDEX_CONFIG_VERSION_4_12
[] = "04.12";

31 c⁄° 
byã
 
	gINDEX_CONFIG_VERSION_4_11
[] = "04.11";

32 c⁄° 
byã
 
	gINDEX_CONFIG_VERSION_4_01
[] = "04.01";

35 
	mINDEX_CONFIG_MAGIC_LENGTH
 = (
INDEX_CONFIG_MAGIC
) - 1,

36 
	mINDEX_CONFIG_VERSION_LENGTH
 = (
INDEX_CONFIG_VERSION
) - 1

40 
	$ªadVîsi⁄
(
Buf„ªdRódî
 *
ªadî
,

41 
UdsC⁄figuøti⁄
 
c⁄f
,

42 c⁄° **
vîsi⁄På
)

44 
byã
 
buf„r
[
INDEX_CONFIG_VERSION_LENGTH
];

45 
ªsu…
 = 
	`ªadFromBuf„ªdRódî
(
ªadî
, 
buf„r
,

46 
INDEX_CONFIG_VERSION_LENGTH
);

47 i‡(
ªsu…
 !
UDS_SUCCESS
) {

48  
	`logEº‹WôhSåögEº‹
(
ªsu…
,

51 i‡(
	`memcmp
(
INDEX_CONFIG_VERSION
, 
buf„r
, 
INDEX_CONFIG_VERSION_LENGTH
) == 0) {

52 
ªsu…
 = 
	`ªadFromBuf„ªdRódî
(
ªadî
, 
c⁄f
, (*conf));

53 i‡(
ªsu…
 !
UDS_SUCCESS
) {

54 
	`logEº‹WôhSåögEº‹
(
ªsu…
, "cannotÑead config data");

56 i‡(
vîsi⁄På
 !
NULL
) {

57 *
vîsi⁄På
 = "current";

59  
ªsu…
;

60 } i‡(
	`memcmp
(
INDEX_CONFIG_VERSION_4_13
,

61 
buf„r
, 
INDEX_CONFIG_VERSION_LENGTH
) == 0) {

62 
udsC⁄figuøti⁄4_13
 
ﬁdC⁄f
;

63 
ªsu…
 = 
	`ªadFromBuf„ªdRódî
(
ªadî
, &
ﬁdC⁄f
, (oldConf));

64 i‡(
ªsu…
 !
UDS_SUCCESS
) {

65 
	`logEº‹WôhSåögEº‹
(
ªsu…
,

67  
ªsu…
;

70 
c⁄f
->
ªc‹dPagesPîCh≠ãr
 = 
ﬁdC⁄f
.recordPagesPerChapter;

71 
c⁄f
->
ch≠ãrsPîVﬁume
 = 
ﬁdC⁄f
.chaptersPerVolume;

72 
c⁄f
->
•¨£Ch≠ãrsPîVﬁume
 = 
ﬁdC⁄f
.sparseChaptersPerVolume;

73 
c⁄f
->
ˇcheCh≠ãrs
 = 
ﬁdC⁄f
.cacheChapters;

74 
c⁄f
->
checkpoötFªquícy
 = 
ﬁdC⁄f
.checkpointFrequency;

75 
c⁄f
->
ma°îIndexMónDñè
 = 
ﬁdC⁄f
.masterIndexMeanDelta;

76 
c⁄f
->
byãsPîPage
 = 
DEFAULT_BYTES_PER_PAGE
;

78 
c⁄f
->
•¨£Sam∂eR©e
 = 
ﬁdC⁄f
.sparseSampleRate;

79 i‡(
vîsi⁄På
 !
NULL
) {

80 *
vîsi⁄På
 = "4.12";

82 i‡(
ﬁdC⁄f
.
subIndexCou¡
 != 1) {

83  
UDS_INVALID_ARGUMENT
;

85  
UDS_UNSUPPORTED_VERSION
;

86 } i‡(
	`memcmp
(
INDEX_CONFIG_VERSION_4_12
,

87 
buf„r
, 
INDEX_CONFIG_VERSION_LENGTH
) == 0) {

88 
udsC⁄figuøti⁄4_12
 
ﬁdC⁄f
;

89 
ªsu…
 = 
	`ªadFromBuf„ªdRódî
(
ªadî
, &
ﬁdC⁄f
, (oldConf));

90 i‡(
ªsu…
 !
UDS_SUCCESS
) {

91 
	`logEº‹WôhSåögEº‹
(
ªsu…
,

93  
ªsu…
;

95 
c⁄f
->
ªc‹dPagesPîCh≠ãr
 = 
ﬁdC⁄f
.recordPagesPerChapter;

96 
c⁄f
->
ch≠ãrsPîVﬁume
 = 
ﬁdC⁄f
.chaptersPerVolume;

97 
c⁄f
->
•¨£Ch≠ãrsPîVﬁume
 = 
ﬁdC⁄f
.sparseChaptersPerVolume;

98 
c⁄f
->
ˇcheCh≠ãrs
 = 
ﬁdC⁄f
.cacheChapters;

99 
c⁄f
->
checkpoötFªquícy
 = 
ﬁdC⁄f
.checkpointFrequency;

100 
c⁄f
->
ma°îIndexMónDñè
 = 
ﬁdC⁄f
.masterIndexMeanDelta;

101 
c⁄f
->
byãsPîPage
 = 
DEFAULT_BYTES_PER_PAGE
;

103 
c⁄f
->
•¨£Sam∂eR©e
 = 
ﬁdC⁄f
.sparseSampleRate;

104 i‡(
vîsi⁄På
 !
NULL
) {

105 *
vîsi⁄På
 = "4.12";

107 i‡(
ﬁdC⁄f
.
subIndexCou¡
 != 1) {

108  
UDS_INVALID_ARGUMENT
;

110  
UDS_UNSUPPORTED_VERSION
;

111 } i‡(
	`memcmp
(
INDEX_CONFIG_VERSION_4_11
,

112 
buf„r
, 
INDEX_CONFIG_VERSION_LENGTH
) == 0) {

113 
udsC⁄figuøti⁄4_11
 
ﬁdC⁄f
;

114 
ªsu…
 = 
	`ªadFromBuf„ªdRódî
(
ªadî
, &
ﬁdC⁄f
, (oldConf));

115 i‡(
ªsu…
 !
UDS_SUCCESS
) {

116 
	`logEº‹WôhSåögEº‹
(
ªsu…
,

118  
ªsu…
;

120 
c⁄f
->
ªc‹dPagesPîCh≠ãr
 = 
ﬁdC⁄f
.recordPagesPerChapter;

121 
c⁄f
->
ch≠ãrsPîVﬁume
 = 
ﬁdC⁄f
.chaptersPerVolume;

122 
c⁄f
->
•¨£Ch≠ãrsPîVﬁume
 = 
ﬁdC⁄f
.sparseChaptersPerVolume;

123 
c⁄f
->
ˇcheCh≠ãrs
 = 
ﬁdC⁄f
.cacheChapters;

124 
c⁄f
->
checkpoötFªquícy
 = 
ﬁdC⁄f
.checkpointFrequency;

125 
c⁄f
->
ma°îIndexMónDñè
 = 
ﬁdC⁄f
.masterIndexMeanDelta;

126 
c⁄f
->
byãsPîPage
 = 
DEFAULT_BYTES_PER_PAGE
;

129 
c⁄f
->
•¨£Sam∂eR©e
 = 
ﬁdC⁄f
.sparseSampleRate;

130 i‡(
vîsi⁄På
 !
NULL
) {

131 *
vîsi⁄På
 = "4.11";

133 i‡(
ﬁdC⁄f
.
subIndexCou¡
 != 1) {

134  
UDS_INVALID_ARGUMENT
;

136  
UDS_UNSUPPORTED_VERSION
;

137 } i‡(
	`memcmp
(
INDEX_CONFIG_VERSION_4_01
,

138 
buf„r
, 
INDEX_CONFIG_VERSION_LENGTH
) == 0) {

139 
udsC⁄figuøti⁄4_01
 
ﬁdC⁄f
;

140 
ªsu…
 = 
	`ªadFromBuf„ªdRódî
(
ªadî
, &
ﬁdC⁄f
, (oldConf));

141 i‡(
ªsu…
 !
UDS_SUCCESS
) {

142  
	`logEº‹WôhSåögEº‹
(
ªsu…
,

145 
c⁄f
->
ªc‹dPagesPîCh≠ãr
 = 
ﬁdC⁄f
.
ödexSize
 / 4;

146 
c⁄f
->
ch≠ãrsPîVﬁume
 = 
ﬁdC⁄f
.chaptersPerVolume;

147 
c⁄f
->
•¨£Ch≠ãrsPîVﬁume
 = 
ﬁdC⁄f
.sparseChaptersPerVolume;

148 
c⁄f
->
ˇcheCh≠ãrs
 = 
ﬁdC⁄f
.cacheChapters;

149 
c⁄f
->
checkpoötFªquícy
 = 
ﬁdC⁄f
.checkpointFrequency;

150 
c⁄f
->
ma°îIndexMónDñè
 = 
DEFAULT_MASTER_INDEX_MEAN_DELTA
;

151 
c⁄f
->
byãsPîPage
 = 
DEFAULT_BYTES_PER_PAGE
;

154 
c⁄f
->
•¨£Sam∂eR©e
 = 
ﬁdC⁄f
.sparseSampleRate;

156 i‡(
vîsi⁄På
 !
NULL
) {

157 *
vîsi⁄På
 = "4.01";

159 i‡(
ﬁdC⁄f
.
subIndexCou¡
 != 1) {

160  
UDS_INVALID_ARGUMENT
;

162  
UDS_UNSUPPORTED_VERSION
;

165  
	`logEº‹WôhSåögEº‹
(
UDS_CORRUPT_COMPONENT
,

167 
INDEX_CONFIG_VERSION_LENGTH
, 
buf„r
);

168 
	}
}

171 
	$ªadC⁄figC⁄ã¡s
(
Buf„ªdRódî
 *
ªadî
,

172 
UdsC⁄figuøti⁄
 
c⁄fig
)

174 
ªsu…
 = 
	`vîifyBuf„ªdD©a
(
ªadî
, 
INDEX_CONFIG_MAGIC
,

175 
INDEX_CONFIG_MAGIC_LENGTH
);

176 i‡(
ªsu…
 !
UDS_SUCCESS
) {

177  
ªsu…
;

180 c⁄° *
vîsi⁄
 = 
NULL
;

181 
ªsu…
 = 
	`ªadVîsi⁄
(
ªadî
, 
c⁄fig
, &
vîsi⁄
);

182 i‡(
ªsu…
 !
UDS_SUCCESS
) {

183 i‡(
ªsu…
 =
UDS_UNSUPPORTED_VERSION
) {

184 
	`logNŸi˚WôhSåögEº‹
(
ªsu…
, "Found index config version %s",

185 
vîsi⁄
);

187 
	`logEº‹WôhSåögEº‹
(
ªsu…
, "FailedÅoÑead index config");

190  
ªsu…
;

191 
	}
}

194 
	$wrôeC⁄figC⁄ã¡s
(
Buf„ªdWrôî
 *
wrôî
,

195 
UdsC⁄figuøti⁄
 
c⁄fig
)

197 
ªsu…
 = 
	`wrôeToBuf„ªdWrôî
(
wrôî
, 
INDEX_CONFIG_MAGIC
,

198 
INDEX_CONFIG_MAGIC_LENGTH
);

199 i‡(
ªsu…
 !
UDS_SUCCESS
) {

200  
ªsu…
;

202 
ªsu…
 = 
	`wrôeToBuf„ªdWrôî
(
wrôî
, 
INDEX_CONFIG_VERSION
,

203 
INDEX_CONFIG_VERSION_LENGTH
);

204 i‡(
ªsu…
 !
UDS_SUCCESS
) {

205  
ªsu…
;

207  
	`wrôeToBuf„ªdWrôî
(
wrôî
, 
c⁄fig
, (*config));

208 
	}
}

211 
	$makeC⁄figuøti⁄
(
UdsC⁄figuøti⁄
 
c⁄f
, 
C⁄figuøti⁄
 **
c⁄figPå
)

213 *
c⁄figPå
 = 
NULL
;

214 i‡(
c⁄f
 =
NULL
) {

215  
	`logEº‹WôhSåögEº‹
(
UDS_CONF_REQUIRED
,

219 
C⁄figuøti⁄
 *
c⁄fig
;

220 
ªsu…
 = 
	`ALLOCATE
(1, 
C⁄figuøti⁄
, "c⁄figuøti⁄", &
c⁄fig
);

221 i‡(
ªsu…
 !
UDS_SUCCESS
) {

222  
ªsu…
;

225 
ªsu…
 = 
	`makeGeomëry
(
c⁄f
->
byãsPîPage
,

226 
c⁄f
->
ªc‹dPagesPîCh≠ãr
,

227 
c⁄f
->
ch≠ãrsPîVﬁume
,

228 
c⁄f
->
•¨£Ch≠ãrsPîVﬁume
,

229 &
c⁄fig
->
geomëry
);

230 i‡(
ªsu…
 !
UDS_SUCCESS
) {

231 
	`‰ìC⁄figuøti⁄
(
c⁄fig
);

232  
ªsu…
;

235 
c⁄fig
->
checkpoötFªquícy
 = 
c⁄f
->checkpointFrequency;

236 
c⁄fig
->
•¨£Sam∂eR©e
 = 
c⁄f
->sparseSampleRate;

237 
c⁄fig
->
ˇcheCh≠ãrs
 = 
c⁄f
->cacheChapters;

238 
c⁄fig
->
ma°îIndexMónDñè
 = 
c⁄f
->masterIndexMeanDelta;

240 *
c⁄figPå
 = 
c⁄fig
;

241  
UDS_SUCCESS
;

242 
	}
}

245 
	$‰ìC⁄figuøti⁄
(
C⁄figuøti⁄
 *
c⁄fig
)

247 i‡(
c⁄fig
 !
NULL
) {

248 
	`‰ìGeomëry
(
c⁄fig
->
geomëry
);

249 
	`FREE
(
c⁄fig
);

251 
	}
}

	@uds/indexConfig.h

22 #i‚de‡
INDEX_CONFIG_H


23 
	#INDEX_CONFIG_H
 1

	)

25 
	~"c⁄fig.h
"

26 
	~"geomëry.h
"

31 
	sc⁄figuøti⁄
 {

35 
Geomëry
 *
	mgeomëry
;

38 
	mˇcheCh≠ãrs
;

41 
	mcheckpoötFªquícy
;

46 
	mma°îIndexMónDñè
;

49 
	m•¨£Sam∂eR©e
;

	@uds/indexInternals.c

22 
	~"ödexI¡î«ls.h
"

24 
	~"îr‹s.h
"

25 
	~"ödexCheckpoöt.h
"

26 
	~"ödexSèãD©a.h
"

27 
	~"ödexZ⁄e.h
"

28 
	~"loggî.h
"

29 
	~"mem‹yAŒoc.h
"

30 
	~"›íCh≠ãr.h
"

31 
	~"ªadO∆yVﬁume.h
"

32 
	~"ªque°.h
"

33 
	~"°rögUtûs.h
"

34 
	~"thªads.h
"

35 
	~"ty≥Defs.h
"

36 
	~"vﬁume.h
"

37 
	~"z⁄e.h
"

39 c⁄° 
boﬁ
 
	gREAD_ONLY_INDEX
 = 
åue
;

41 c⁄° 
	gMAX_COMPONENT_COUNT
 = 4;

44 
	$ÆloˇãIndex
(
IndexLayout
 *
œyout
,

45 c⁄° 
C⁄figuøti⁄
 *
c⁄fig
,

46 
id
,

47 
z⁄eCou¡
,

48 
LﬂdTy≥
 
lﬂdTy≥
,

49 
boﬁ
 
ªadO∆y
,

50 
Index
 **
√wIndex
)

52 i‡(
lﬂdTy≥
 =
LOAD_CREATE
) {

53 i‡(
ªadO∆y
) {

54 
	`logEº‹
("Can't createáÑead only index");

55  
EINVAL
;

57 
IORegi⁄
 *
ªgi⁄
 = 
NULL
;

58 
ªsu…
 = 
	`›íVﬁumeRegi⁄
(
œyout
, 
id
, 
IO_CREATE_WRITE
, &
ªgi⁄
);

59 i‡(
ªsu…
 !
UDS_SUCCESS
) {

60  
ªsu…
;

62 
ªsu…
 = 
	`f‹m©Vﬁume
(
ªgi⁄
, 
c⁄fig
->
geomëry
);

63 i‡(
ªsu…
 !
UDS_SUCCESS
) {

64  
ªsu…
;

66 
ªsu…
 = 
	`˛o£IORegi⁄
(&
ªgi⁄
);

67 i‡(
ªsu…
 !
UDS_SUCCESS
) {

68  
ªsu…
;

72 
Index
 *
ödex
;

73 
ªsu…
 = 
	`ALLOCATE
(1, 
Index
, "ödex", &
ödex
);

74 i‡(
ªsu…
 !
UDS_SUCCESS
) {

75  
ªsu…
;

78 
ödex
->
exi°ed
 = (
lﬂdTy≥
 !
LOAD_CREATE
);

80 
ªsu…
 = 
	`makeIndexCheckpoöt
(
ödex
);

81 i‡(
ªsu…
 !
UDS_SUCCESS
) {

82 
	`‰ìIndex
(
ödex
);

83  
ªsu…
;

85 
	`£tIndexCheckpoötFªquícy
(
ödex
->
checkpoöt
, 
c⁄fig
->
checkpoötFªquícy
);

87 
ödex
->
œyout
 =Üayout;

88 
ödex
->
id
 = id;

89 
ödex
->
z⁄eCou¡
 = (
ªadO∆y
 ? 1 : zoneCount);

91 
ªsu…
 = 
	`ALLOCATE
(
ödex
->
z⁄eCou¡
, 
IndexZ⁄e
 *, "zones",

92 &
ödex
->
z⁄es
);

93 i‡(
ªsu…
 !
UDS_SUCCESS
) {

94 
	`‰ìIndex
(
ödex
);

95  
ªsu…
;

98 
ªsu…
 = 
	`makeIndexSèã
(
œyout
, 
ödex
->
id
, index->
z⁄eCou¡
,

99 
MAX_COMPONENT_COUNT
, &
ödex
->
°©e
);

100 i‡(
ªsu…
 !
UDS_SUCCESS
) {

101 
	`‰ìIndex
(
ödex
);

102  
ªsu…
;

105 
ªsu…
 = 
	`addIndexSèãComp⁄ít
(
ödex
->
°©e
, &
INDEX_STATE_INFO
, index,

106 
NULL
);

107 i‡(
ªsu…
 !
UDS_SUCCESS
) {

108 
	`‰ìIndex
(
ödex
);

109  
ªsu…
;

112 i‡(
ªadO∆y
) {

113 
ªsu…
 = 
	`makeRódO∆yVﬁume
(
c⁄fig
, 
ödex
->
œyout
, index->
id
,

114 &
ödex
->
vﬁume
);

116 
ªsu…
 = 
	`makeVﬁume
(
c⁄fig
, 
ödex
->
œyout
, index->
id
,

117 
VOLUME_CACHE_DEFAULT_MAX_QUEUED_READS
,

118 
ödex
->
z⁄eCou¡
, &ödex->
vﬁume
);

121 i‡(
ªsu…
 !
UDS_SUCCESS
) {

122 
	`‰ìIndex
(
ödex
);

123  
ªsu…
;

125 
ödex
->
vﬁume
->
lookupMode
 = 
LOOKUP_NORMAL
;

127 
i
 = 0; i < 
ödex
->
z⁄eCou¡
; i++) {

128 
ªsu…
 = 
	`makeIndexZ⁄e
(
ödex
, 
i
, 
ªadO∆y
);

129 i‡(
ªsu…
 !
UDS_SUCCESS
) {

130 
	`‰ìIndex
(
ödex
);

131  
	`logEº‹WôhSåögEº‹
(
ªsu…
, "CouldÇot create index zone");

135 
ªsu…
 = 
	`addIndexSèãComp⁄ít
(
ödex
->
°©e
, &
OPEN_CHAPTER_INFO
, index,

136 
NULL
);

137 i‡(
ªsu…
 !
UDS_SUCCESS
) {

138 
	`‰ìIndex
(
ödex
);

139  
	`logEº‹WôhSåögEº‹
(
ªsu…
, "CouldÇot create open chapter");

142 *
√wIndex
 = 
ödex
;

143  
UDS_SUCCESS
;

144 
	}
}

147 
	$ªÀa£Index
(
Index
 *
ödex
, 
boﬁ
 
ªadO∆y
)

149 i‡(
ödex
 =
NULL
) {

153 i‡(
ödex
->
z⁄es
 !
NULL
) {

154 
i
 = 0; i < 
ödex
->
z⁄eCou¡
; i++) {

155 
	`‰ìIndexZ⁄e
(
ödex
->
z⁄es
[
i
]);

157 
	`FREE
(
ödex
->
z⁄es
);

160 i‡(
ªadO∆y
) {

161 
	`‰ìRódO∆yVﬁume
(
ödex
->
vﬁume
);

163 
	`‰ìVﬁume
(
ödex
->
vﬁume
);

166 
	`‰ìIndexSèã
(&
ödex
->
°©e
);

167 
	`‰ìIndexCheckpoöt
(
ödex
->
checkpoöt
);

168 
	`FREE
(
ödex
);

169 
	}
}

	@uds/indexInternals.h

22 #i‚de‡
INDEX_INTERNALS_H


23 
	#INDEX_INTERNALS_H


	)

25 
	~"ödex.h
"

26 
	~"lﬂdTy≥.h
"

27 
	~"ªque°.h
"

29 c⁄° 
boﬁ
 
READ_ONLY_INDEX
;

47 
	$ÆloˇãIndex
(
IndexLayout
 *
œyout
,

48 c⁄° 
C⁄figuøti⁄
 *
c⁄fig
,

49 
id
,

50 
z⁄eCou¡
,

51 
LﬂdTy≥
 
lﬂdTy≥
,

52 
boﬁ
 
ªadO∆y
,

53 
Index
 **
√wIndex
)

54 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

63 
	`ªÀa£Index
(
Index
 *
ödex
, 
boﬁ
 
ªadO∆y
);

	@uds/indexLayout.c

22 
	~"ödexLayoutI¡î«l.h
"

24 
	$öôIndexLayout
(
IndexLayout
 *
œyout
, c⁄° 
IndexLayoutOps
 *
›s
)

26 *
œyout
 = (
IndexLayout
) {

27 .
›s
 = ops,

29  
UDS_SUCCESS
;

30 
	}
}

	@uds/indexLayout.h

22 #i‚de‡
INDEX_LAYOUT_H


23 
	#INDEX_LAYOUT_H


	)

25 
	~"ac˚ssMode.h
"

26 
	~"ödexSèã.h
"

27 
	~"ioRegi⁄.h
"

28 
	~"uds.h
"

36 
ödexLayout
 
	tIndexLayout
;

55 
	$makeIndexLayout
(c⁄° *
öfo
,

56 
boﬁ
 
√wLayout
,

57 c⁄° 
UdsC⁄figuøti⁄
 
c⁄fig
,

58 
IndexLayout
 **
œyoutPå
)

59 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

67 
ölöe
 
	`‰ìIndexLayout
(
IndexLayout
 **
œyoutPå
);

76 
ölöe
 
	$wrôeSa„tySól
(
IndexLayout
 *
œyout
)

77 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

86 
ölöe
 
	$ªmoveSa„tySól
(
IndexLayout
 *
œyout
)

87 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

97 
ölöe
 
	$checkIndexExi°s
(
IndexLayout
 *
œyout
, 
boﬁ
 *
exi°s
)

98 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

108 
ölöe
 
	$checkIndexIsSóÀd
(
IndexLayout
 *
œyout
, 
boﬁ
 *
£Æed
)

109 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

119 
ölöe
 
	$wrôeIndexC⁄fig
(
IndexLayout
 *
œyout
, 
UdsC⁄figuøti⁄
 
c⁄fig
)

120 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

130 
ölöe
 
	$ªadIndexC⁄fig
(
IndexLayout
 *
œyout
, 
UdsC⁄figuøti⁄
 
c⁄fig
)

131 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

143 
ölöe
 
	$›íVﬁumeRegi⁄
(
IndexLayout
 *
œyout
,

144 
ödexId
,

145 
IOAc˚ssMode
 
ac˚ss
,

146 
IORegi⁄
 **
ªgi⁄På
)

147 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

160 
ölöe
 
	$makeIndexSèã
(
IndexLayout
 *
œyout
,

161 
ödexId
,

162 
numZ⁄es
,

163 
comp⁄íts
,

164 
IndexSèã
 **
°©ePå
)

165 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

175 
ölöe
 
	$gëVﬁumeN⁄˚
(
IndexLayout
 *
œyout
,

176 
ödexId
,

177 
uöt64_t
 *
n⁄˚
)

178 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

187 
ölöe
 c⁄° *
	`ödexLayoutName
(
IndexLayout
 *
œyout
);

189 
	#INDEX_LAYOUT_INLINE


	)

190 
	~"ödexLayoutI∆öe.h
"

191 #unde‡
INDEX_LAYOUT_INLINE


	@uds/indexLayoutInline.h

22 #i‚de‡
INDEX_LAYOUT_INLINE_H


23 
	#INDEX_LAYOUT_INLINE_H


	)

25 #i‚de‡
INDEX_LAYOUT_INLINE


29 
	~"compûî.h
"

31 
	södexLayoutOps
 {

32 (*
	m‰ìFunc
Ë(
	mIndexLayout
 *);

33 (*
	mwrôeSól
Ë(
	mIndexLayout
 *);

34 (*
	mªmoveSól
Ë(
	mIndexLayout
 *);

35 (*
	mcheckIndexExi°s
)(
	mIndexLayout
 *, 
	mboﬁ
 *);

36 (*
	mcheckSóÀd
Ë(
	mIndexLayout
 *, 
	mboﬁ
 *);

37 (*
	mwrôeC⁄fig
Ë(
	mIndexLayout
 *, 
	mUdsC⁄figuøti⁄
);

38 (*
	mªadC⁄fig
Ë(
IndexLayout
 *
	mœyout
, 
	mUdsC⁄figuøti⁄
);

39 (*
	m›íVﬁumeRegi⁄
)(
	mIndexLayout
 *, ,

40 
	mIOAc˚ssMode
, 
	mIORegi⁄
 **);

41 (*
	mmakeIndexSèã
Ë(
	mIndexLayout
 *, , ,

42 , 
	mIndexSèã
 **);

43 (*
	mgëVﬁumeN⁄˚
Ë(
	mIndexLayout
 *, , 
	muöt64_t
 *);

44 c⁄° *(*
	m«me
Ë(
	mIndexLayout
 *);

45 } 
	tIndexLayoutOps
;

47 
	södexLayout
 {

48 c⁄° 
IndexLayoutOps
 *
	m›s
;

52 
INLINE
 
	$‰ìIndexLayout
(
IndexLayout
 **
œyoutPå
)

54 i‡(*
œyoutPå
 !
NULL
) {

55 (*
œyoutPå
)->
›s
->
	`‰ìFunc
(*layoutPtr);

56 *
œyoutPå
 = 
NULL
;

58 
	}
}

61 
INLINE
 
	$wrôeSa„tySól
(
IndexLayout
 *
œyout
)

63  
œyout
->
›s
->
	`wrôeSól
(layout);

64 
	}
}

67 
INLINE
 
	$ªmoveSa„tySól
(
IndexLayout
 *
œyout
)

69  
œyout
->
›s
->
	`ªmoveSól
(layout);

70 
	}
}

73 
INLINE
 
	$checkIndexExi°s
(
IndexLayout
 *
œyout
, 
boﬁ
 *
exi°s
)

75  
œyout
->
›s
->
	`checkIndexExi°s
÷ayout, 
exi°s
);

76 
	}
}

79 
INLINE
 
	$checkIndexIsSóÀd
(
IndexLayout
 *
œyout
, 
boﬁ
 *
£Æed
)

81  
œyout
->
›s
->
	`checkSóÀd
÷ayout, 
£Æed
);

82 
	}
}

85 
INLINE
 
	$wrôeIndexC⁄fig
(
IndexLayout
 *
œyout
,

86 
UdsC⁄figuøti⁄
 
c⁄fig
)

88  
œyout
->
›s
->
	`wrôeC⁄fig
÷ayout, 
c⁄fig
);

89 
	}
}

92 
INLINE
 
	$ªadIndexC⁄fig
(
IndexLayout
 *
œyout
,

93 
UdsC⁄figuøti⁄
 
c⁄fig
)

95  
œyout
->
›s
->
	`ªadC⁄fig
÷ayout, 
c⁄fig
);

96 
	}
}

99 
INLINE
 
	$›íVﬁumeRegi⁄
(
IndexLayout
 *
œyout
,

100 
ödexId
,

101 
IOAc˚ssMode
 
ac˚ss
,

102 
IORegi⁄
 **
ªgi⁄På
)

104  
œyout
->
›s
->
	`›íVﬁumeRegi⁄
÷ayout, 
ödexId
, 
ac˚ss
, 
ªgi⁄På
);

105 
	}
}

108 
INLINE
 
	$makeIndexSèã
(
IndexLayout
 *
œyout
,

109 
ödexId
,

110 
numZ⁄es
,

111 
comp⁄íts
,

112 
IndexSèã
 **
°©ePå
)

114  
œyout
->
›s
->
	`makeIndexSèã
÷ayout, 
ödexId
, 
numZ⁄es
, 
comp⁄íts
,

115 
°©ePå
);

116 
	}
}

119 
INLINE
 
	$gëVﬁumeN⁄˚
(
IndexLayout
 *
œyout
,

120 
ödexId
,

121 
uöt64_t
 *
n⁄˚
)

123  
œyout
->
›s
->
	`gëVﬁumeN⁄˚
÷ayout, 
ödexId
, 
n⁄˚
);

124 
	}
}

127 
INLINE
 c⁄° *
	$ödexLayoutName
(
IndexLayout
 *
œyout
)

129  
œyout
->
›s
->
	`«me
(layout);

130 
	}
}

	@uds/indexLayoutInternal.h

22 #i‚de‡
INDEX_LAYOUT_INTERNAL_H


23 
	#INDEX_LAYOUT_INTERNAL_H


	)

25 
	~"ödexLayout.h
"

35 
öôIndexLayout
(
IndexLayout
 *
œyout
, c⁄° 
IndexLayoutOps
 *
›s
);

	@uds/indexLayoutLinuxKernel.c

22 
	~"ödexLayout.h
"

23 
	~"ödexLayoutP¨£r.h
"

24 
	~"loggî.h
"

25 
	~"mem‹yAŒoc.h
"

26 
	~"sögÀFûeLayout.h
"

27 
	~"löuxIORegi⁄.h
"

30 
	$makeIndexLayout
(c⁄° *
«me
,

31 
boﬁ
 
√wLayout
,

32 c⁄° 
UdsC⁄figuøti⁄
 
c⁄fig
,

33 
IndexLayout
 **
œyoutPå
)

35 *
dev
 = 
NULL
;

36 
uöt64_t
 
off£t
 = 0;

37 
uöt64_t
 
size
 = 0;

39 
LayoutP¨amëî
 
∑ømëîTabÀ
[] = {

40 { "dev", 
LP_STRING
 | 
LP_DEFAULT
, { .
°r
 = &
dev
 } },

41 { "off£t", 
LP_UINT64
, { .
num
 = &
off£t
 } },

42 { "size", 
LP_UINT64
, { .
num
 = &
size
 } },

44 
size_t
 
numP¨amëîs
 = (
∑ømëîTabÀ
) / (*parameterTable);

46 *
∑øms
 = 
NULL
;

47 
ªsu…
 = 
	`du∂iˇãSåög
(
«me
, "makeIndexLayouà∑ømëîs", &
∑øms
);

48 i‡(
ªsu…
 !
UDS_SUCCESS
) {

49  
ªsu…
;

53 
ªsu…
 = 
	`∑r£LayoutSåög
(
∑øms
, 
∑ømëîTabÀ
, 
numP¨amëîs
);

54 i‡(
ªsu…
 !
UDS_SUCCESS
) {

55 
	`FREE
(
∑øms
);

56  
ªsu…
;

59 i‡(
size
 == 0) {

60 i‡(
c⁄fig
 =
NULL
) {

61 
size
 = 1L << 40;

63 
ªsu…
 = 
	`udsCompuãIndexSize
(
c⁄fig
, 0, &
size
);

64 i‡(
ªsu…
 !
UDS_SUCCESS
) {

65 
	`FREE
(
∑øms
);

66  
ªsu…
;

71 
IORegi⁄
 *
ªgi⁄
 = 
NULL
;

72 i‡(
dev
 !
NULL
) {

73 
ªsu…
 = 
	`›íLöuxRegi⁄
(
dev
, 
off£t
 + 
size
, &
ªgi⁄
);

75 
	`FREE
(
∑øms
);

76  
	`logEº‹WôhSåögEº‹
(
UDS_INDEX_NAME_REQUIRED
,

79 
	`FREE
(
∑øms
);

80 i‡(
ªsu…
 !
UDS_SUCCESS
) {

81 
	`˛o£IORegi⁄
(&
ªgi⁄
);

82  
ªsu…
;

85 i‡(
√wLayout
) {

86 
ªsu…
 = 
	`¸óãSögÀFûeLayout
(
ªgi⁄
, 
off£t
, 
size
, 
c⁄fig
, 
œyoutPå
);

88 
ªsu…
 = 
	`lﬂdSögÀFûeLayout
(
ªgi⁄
, 
off£t
, 
œyoutPå
);

90 i‡(
ªsu…
 !
UDS_SUCCESS
) {

91 
	`˛o£IORegi⁄
(&
ªgi⁄
);

93  
ªsu…
;

94 
	}
}

	@uds/indexLayoutParser.c

22 
	~"ödexLayoutP¨£r.h
"

24 
	~"îr‹s.h
"

25 
	~"loggî.h
"

26 
	~"≥rmas£π.h
"

27 
	~"°rögUtûs.h
"

28 
	~"ty≥Defs.h
"

29 
	~"uds.h
"

32 
__©åibuã__
((
w¨n_unu£d_ªsu…
))

33 
	$£tP¨amëîVÆue
(c⁄° 
LayoutP¨amëî
 *
Õ
,

34 *
d©a
)

36 i‡((
Õ
->
ty≥
 & 
LP_TYPE_MASK
Ë=
LP_UINT64
) {

37 
ªsu…
 = 
	`∑r£Uöt64
(
d©a
, 
Õ
->
vÆue
.
num
);

38 i‡(
ªsu…
 !
UDS_SUCCESS
) {

39  
	`logEº‹WôhSåögEº‹
(
UDS_INDEX_NAME_REQUIRED
,

40 "badÇumîi¯vÆuê%s", 
d©a
);

42 } i‡((
Õ
->
ty≥
 & 
LP_TYPE_MASK
Ë=
LP_STRING
) {

43 *
Õ
->
vÆue
.
°r
 = 
d©a
;

45  
	`logEº‹WôhSåögEº‹
(
UDS_INVALID_ARGUMENT
,

47 (
Õ
->
ty≥
 & 
LP_TYPE_MASK
));

49  
UDS_SUCCESS
;

50 
	}
}

53 
	$∑r£LayoutSåög
(*
öfo
,

54 c⁄° 
LayoutP¨amëî
 *
∑øms
,

55 
size_t
 
cou¡
)

57 i‡(!
	`°rchr
(
öfo
, '=')) {

58 c⁄° 
LayoutP¨amëî
 *
Õ
 = 
∑øms
;Ü∞<Ö¨am†+ 
cou¡
; ++lp) {

59 i‡(
Õ
->
ty≥
 & 
LP_DEFAULT
) {

60 
ªsu…
 = 
	`£tP¨amëîVÆue
(
Õ
, 
öfo
);

61 i‡(
ªsu…
 !
UDS_SUCCESS
) {

62  
ªsu…
;

68 
boﬁ
 
£í
[
cou¡
];

69 
	`mem£t
(
£í
, 0, (seen));

71 *
d©a
 = 
NULL
, *
tokí
 = 
	`√xtTokí
(
öfo
, " ", &data);

72 
tokí
;

73 
tokí
 = 
	`√xtTokí
(
NULL
, " ", &
d©a
))

75 *
equÆ
 = 
	`°rchr
(
tokí
, '=');

76 c⁄° 
LayoutP¨amëî
 *
Õ
 = 
NULL
;

77 
Õ
 = 
∑øms
;Ü∞<Ö¨am†+ 
cou¡
; ++lp) {

78 i‡(!
equÆ
 && (
Õ
->
ty≥
 & 
LP_DEFAULT
)) {

80 } i‡(
	`°∫cmp
(
tokí
, 
Õ
->
«me
, 
equÆ
 -Åoken) == 0 &&

81 
	`°æí
(
Õ
->
«me
Ë=(
size_t
Ë(
equÆ
 - 
tokí
)) {

85 i‡(
Õ
 =
NULL
) {

86  
	`logEº‹WôhSåögEº‹
(
UDS_INDEX_NAME_REQUIRED
,

88 
tokí
);

90 i‡(
£í
[
Õ
 - 
∑øms
]) {

91  
	`logEº‹WôhSåögEº‹
(
UDS_INDEX_NAME_REQUIRED
,

93 
tokí
);

95 
ªsu…
 = 
	`£tP¨amëîVÆue
(
Õ
, 
equÆ
 ?ÉquÆ + 1 : 
tokí
);

96 i‡(
ªsu…
 !
UDS_SUCCESS
) {

97  
ªsu…
;

99 
£í
[
Õ
 - 
∑øms
] = 
åue
;

102  
UDS_SUCCESS
;

103 
	}
}

	@uds/indexLayoutParser.h

22 #i‚de‡
INDEX_LAYOUT_PARSER_H


23 
	#INDEX_LAYOUT_PARSER_H


	)

25 
	~"ty≥Defs.h
"

28 
	mLP_STRING
 = 0x001,

29 
	mLP_UINT64
 = 0x002,

30 
	mLP_TYPE_MASK
 = 0x0FF,

31 
	mLP_DEFAULT
 = 0x100,

32 } 
	tLPTy≥
;

34 
	sœyoutP¨amëî
 {

35 c⁄° *
	m«me
;

36 
LPTy≥
 
	mty≥
;

38 **
	m°r
;

39 
uöt64_t
 *
	mnum
;

40 } 
	mvÆue
;

41 } 
	tLayoutP¨amëî
;

67 
	$∑r£LayoutSåög
(*
öfo
,

68 c⁄° 
LayoutP¨amëî
 *
∑øms
,

69 
size_t
 
cou¡
)

70 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

	@uds/indexPageMap.c

22 
	~"ödexPageM≠.h
"

24 
	~"buf„ªdWrôî.h
"

25 
	~"compûî.h
"

26 
	~"îr‹s.h
"

27 
	~"hashUtûs.h
"

28 
	~"ödexComp⁄ít.h
"

29 
	~"loggî.h
"

30 
	~"mem‹yAŒoc.h
"

31 
	~"≥rmas£π.h
"

32 
	~"°rögUtûs.h
"

33 
	~"thªads.h
"

34 
	~"uds.h
"

36 
ªadIndexPageM≠
(
Comp⁄ítP‹èl
 *
p‹èl
);

37 
wrôeIndexPageM≠
(
IndexComp⁄ít
 *
comp⁄ít
,

38 
Buf„ªdWrôî
 *
wrôî
,

39 
z⁄e
);

41 c⁄° 
IndexComp⁄ítInfo
 
	gINDEX_PAGE_MAP_INFO
 = {

42 .
köd
 = 
RL_KIND_INDEX_PAGE_MAP
,

43 .
	g«me
 = "indexÖage map",

44 .
	gfûeName
 = "page_map",

45 .
	gßveO∆y
 = 
Ál£
,

46 .
	gch≠ãrSync
 = 
åue
,

47 .
	gmu…iZ⁄e
 = 
Ál£
,

48 .
	glﬂdî
 = 
ªadIndexPageM≠
,

49 .
	gßvî
 = 
wrôeIndexPageM≠
,

50 .
	gö¸emíèl
 = 
NULL
,

54 
INLINE
 
size_t
 
	$numE¡rõs
(c⁄° 
Geomëry
 *
geomëry
)

56  
geomëry
->
ch≠ãrsPîVﬁume
 * (geomëry->
ödexPagesPîCh≠ãr
 - 1);

57 
	}
}

60 
	$makeIndexPageM≠
(c⁄° 
Geomëry
 *
geomëry
, 
IndexPageM≠
 **
m≠På
)

62 
dñèLi°sPîCh≠ãr
 = 
geomëry
->deltaListsPerChapter;

63 
ªsu…


64 
	`ASSERT_WITH_ERROR_CODE
(((
dñèLi°sPîCh≠ãr
 - 1Ë<
UINT16_MAX
),

65 
UDS_BAD_STATE
,

67 
dñèLi°sPîCh≠ãr
);

68 i‡(
ªsu…
 !
UDS_SUCCESS
) {

69  
ªsu…
;

72 
IndexPageM≠
 *
m≠
;

73 
ªsu…
 = 
	`ALLOCATE
(1, 
IndexPageM≠
, "Index PagêM≠", &
m≠
);

74 i‡(
ªsu…
 !
UDS_SUCCESS
) {

75  
ªsu…
;

78 
m≠
->
geomëry
 = geometry;

80 
ªsu…
 = 
	`ALLOCATE
(
	`numE¡rõs
(
geomëry
),

81 
IndexPageM≠E¡ry
,

83 &
m≠
->
íåõs
);

84 i‡(
ªsu…
 !
UDS_SUCCESS
) {

85 
	`‰ìIndexPageM≠
(
m≠
);

86  
ªsu…
;

89 *
m≠På
 = 
m≠
;

90  
UDS_SUCCESS
;

91 
	}
}

94 
	$‰ìIndexPageM≠
(
IndexPageM≠
 *
m≠
)

96 i‡(
m≠
 !
NULL
) {

97 
	`FREE
(
m≠
->
íåõs
);

98 
	`FREE
(
m≠
);

100 
	}
}

103 
uöt64_t
 
	$gëLa°Upd©e
(c⁄° 
IndexPageM≠
 *
m≠
)

105  
m≠
->
œ°Upd©e
;

106 
	}
}

109 
	$upd©eIndexPageM≠
(
IndexPageM≠
 *
m≠
,

110 
uöt64_t
 
vútuÆCh≠ãrNumbî
,

111 
ch≠ãrNumbî
,

112 
ödexPageNumbî
,

113 
dñèLi°Numbî
)

115 c⁄° 
Geomëry
 *
geomëry
 = 
m≠
->geometry;

116 i‡((
vútuÆCh≠ãrNumbî
 < 
m≠
->
œ°Upd©e
)

117 || (
vútuÆCh≠ãrNumbî
 > 
m≠
->
œ°Upd©e
 + 1)) {

118 
	`logW¨nög
("u√x≥˘ed indexÖagêm≠ upd©e, jumpög from %" 
PRIu64


119 "Åÿ%" 
PRIu64
,

120 
m≠
->
œ°Upd©e
, 
vútuÆCh≠ãrNumbî
);

122 
m≠
->
œ°Upd©e
 = 
vútuÆCh≠ãrNumbî
;

124 i‡(
ch≠ãrNumbî
 >
geomëry
->
ch≠ãrsPîVﬁume
) {

125  
	`logEº‹WôhSåögEº‹
(

126 
UDS_INVALID_ARGUMENT
, "chapterÇumber %uÉxceeds maximum %u",

127 
ch≠ãrNumbî
, 
geomëry
->
ch≠ãrsPîVﬁume
 - 1);

129 i‡(
ödexPageNumbî
 >
geomëry
->
ödexPagesPîCh≠ãr
) {

130  
	`logEº‹WôhSåögEº‹
(

131 
UDS_INVALID_ARGUMENT
, "indexÖageÇumber %uÉxceeds maximum %u",

132 
ödexPageNumbî
, 
geomëry
->
ödexPagesPîCh≠ãr
 - 1);

134 i‡(
dñèLi°Numbî
 >
geomëry
->
dñèLi°sPîCh≠ãr
) {

135  
	`logEº‹WôhSåögEº‹
(

136 
UDS_INVALID_ARGUMENT
, "deltaÜistÇumber %uÉxceeds maximum %u",

137 
dñèLi°Numbî
, 
geomëry
->
dñèLi°sPîCh≠ãr
 - 1);

140 i‡(
ödexPageNumbî
 =(
geomëry
->
ödexPagesPîCh≠ãr
 - 1)) {

145  
UDS_SUCCESS
;

148 
size_t
 
¶Ÿ


149 (
ch≠ãrNumbî
 * (
geomëry
->
ödexPagesPîCh≠ãr
 - 1)Ë+ 
ödexPageNumbî
;

150 
m≠
->
íåõs
[
¶Ÿ
] = (
IndexPageM≠E¡ry
Ë
dñèLi°Numbî
;

151  
UDS_SUCCESS
;

152 
	}
}

155 
	$födIndexPageNumbî
(c⁄° 
IndexPageM≠
 *
m≠
,

156 c⁄° 
UdsChunkName
 *
«me
,

157 
ch≠ãrNumbî
,

158 *
ödexPageNumbîPå
)

160 c⁄° 
Geomëry
 *
geomëry
 = 
m≠
->geometry;

161 i‡(
ch≠ãrNumbî
 >
geomëry
->
ch≠ãrsPîVﬁume
) {

162  
	`logEº‹WôhSåögEº‹
(

163 
UDS_INVALID_ARGUMENT
, "chapterÇumber %uÉxceeds maximum %u",

164 
ch≠ãrNumbî
, 
geomëry
->
ch≠ãrsPîVﬁume
 - 1);

167 
dñèLi°Numbî
 = 
	`hashToCh≠ãrDñèLi°
(
«me
, 
geomëry
);

168 
¶Ÿ
 = (
ch≠ãrNumbî
 * (
geomëry
->
ödexPagesPîCh≠ãr
 - 1));

169 
limô
 = 
¶Ÿ
 + (
geomëry
->
ödexPagesPîCh≠ãr
 - 1);

170 
ödexPageNumbî
 = 0;

171 ; 
¶Ÿ
 < 
limô
; 
ödexPageNumbî
++, slot++) {

172 i‡(
dñèLi°Numbî
 <
m≠
->
íåõs
[
¶Ÿ
]) {

179 
ªsu…
 = 
	`ASSERT
((
ödexPageNumbî
 < 
geomëry
->
ödexPagesPîCh≠ãr
),

181 i‡(
ªsu…
 !
UDS_SUCCESS
) {

182  
ªsu…
;

185 *
ödexPageNumbîPå
 = 
ödexPageNumbî
;

186  
UDS_SUCCESS
;

187 
	}
}

190 
	$gëLi°NumbîBounds
(c⁄° 
IndexPageM≠
 *
m≠
,

191 
ch≠ãrNumbî
,

192 
ödexPageNumbî
,

193 
IndexPageBounds
 *
bounds
)

195 c⁄° 
Geomëry
 *
geomëry
 = 
m≠
->geometry;

196 
ªsu…
 = 
	`ASSERT
((
ch≠ãrNumbî
 < 
geomëry
->
ch≠ãrsPîVﬁume
),

198 i‡(
ªsu…
 !
UDS_SUCCESS
) {

199  
ªsu…
;

202 
ªsu…
 = 
	`ASSERT
((
ödexPageNumbî
 < 
geomëry
->
ödexPagesPîCh≠ãr
),

204 i‡(
ªsu…
 !
UDS_SUCCESS
) {

205  
ªsu…
;

208 
¶Ÿ
 = 
ch≠ãrNumbî
 * (
geomëry
->
ödexPagesPîCh≠ãr
 - 1);

209 
bounds
->
lowe°Li°
 = ((
ödexPageNumbî
 == 0)

211 : 
m≠
->
íåõs
[
¶Ÿ
 + 
ödexPageNumbî
 - 1] + 1);

212 
bounds
->
highe°Li°
 = ((
ödexPageNumbî
 =
geomëry
->
ödexPagesPîCh≠ãr
 - 1)

213 ? 
geomëry
->
dñèLi°sPîCh≠ãr
 - 1

214 : 
m≠
->
íåõs
[
¶Ÿ
 + 
ödexPageNumbî
]);

216  
UDS_SUCCESS
;

217 
	}
}

220 
size_t
 
	$ödexPageM≠Size
(c⁄° 
Geomëry
 *
geomëry
)

222  (
IndexPageM≠E¡ry
Ë* 
	`numE¡rõs
(
geomëry
);

223 
	}
}

225 c⁄° 
byã
 
	gINDEX_PAGE_MAP_MAGIC
[] = "ALBIPM";

226 c⁄° 
	gINDEX_PAGE_MAP_VERSION_FORMAT
[] = "%02u";

228 
	mINDEX_PAGE_MAP_MAGIC_LENGTH
 = (
INDEX_PAGE_MAP_MAGIC
) - 1,

229 
	mINDEX_PAGE_MAP_VERSION_LENGTH
 = 2,

230 
	mINDEX_PAGE_MAP_HEADER_LENGTH
 =

231 
INDEX_PAGE_MAP_MAGIC_LENGTH
 + 
INDEX_PAGE_MAP_VERSION_LENGTH


233 c⁄° 
byã
 
	gINDEX_PAGE_MAP_V1
 = 1;

234 c⁄° 
byã
 
	gINDEX_PAGE_MAP_V2
 = 2;

245 
	$wrôeIndexPageM≠
(
IndexComp⁄ít
 *
comp⁄ít
,

246 
Buf„ªdWrôî
 *
wrôî
,

247 
z⁄e
)

249 
ªsu…
 = 
	`ASSERT
((
z⁄e
 == 0), "unimplemented zone %d", zone);

250 i‡(
ªsu…
 !
UDS_SUCCESS
) {

251  
ªsu…
;

254 
IndexPageM≠
 *
m≠
 = 
	`ödexComp⁄ítD©a
(
comp⁄ít
);

255 
buf
[
INDEX_PAGE_MAP_HEADER_LENGTH
 + (
m≠
->
œ°Upd©e
)];

256 
	`mem˝y
(
buf
, 
INDEX_PAGE_MAP_MAGIC
, 
INDEX_PAGE_MAP_MAGIC_LENGTH
);

257 
ªsu…
 = 
	`fixedS¥ötf
(
__func__
,

258 
buf
 + 
INDEX_PAGE_MAP_MAGIC_LENGTH
,

259 
INDEX_PAGE_MAP_VERSION_LENGTH
 + 1,

260 
UDS_INVALID_ARGUMENT
,

261 
INDEX_PAGE_MAP_VERSION_FORMAT
, 
INDEX_PAGE_MAP_V2
);

262 i‡(
ªsu…
 !
UDS_SUCCESS
) {

263  
ªsu…
;

266 
	`mem˝y
(
buf
 + 
INDEX_PAGE_MAP_HEADER_LENGTH
,

267 &
m≠
->
œ°Upd©e
, (map->lastUpdate));

269 
ªsu…
 = 
	`wrôeToBuf„ªdWrôî
(
wrôî
, 
buf
, (buf));

270 i‡(
ªsu…
 !
UDS_SUCCESS
) {

271  
	`logEº‹WôhSåögEº‹
(
ªsu…
,

274 
ªsu…
 = 
	`wrôeToBuf„ªdWrôî
(
wrôî
, 
m≠
->
íåõs
,

275 
	`ödexPageM≠Size
(
m≠
->
geomëry
));

276 i‡(
ªsu…
 !
UDS_SUCCESS
) {

277  
	`logEº‹WôhSåögEº‹
(
ªsu…
,

280  
UDS_SUCCESS
;

281 
	}
}

284 
uöt64_t
 
	$compuãIndexPageM≠SaveSize
(c⁄° 
Geomëry
 *
geomëry
)

286  
	`ödexPageM≠Size
(
geomëry
) +

287 
INDEX_PAGE_MAP_HEADER_LENGTH
 + (((
IndexPageM≠
 *Ë0)->
œ°Upd©e
);

288 
	}
}

301 
	$ªåõveFûeVîsi⁄
(
Comp⁄ítP‹èl
 *
p‹èl
,

302 c⁄° 
Geomëry
 *
geomëry
,

303 
byã
 *
vîsi⁄
,

304 
Buf„ªdRódî
 **
ªadîPå
)

306 
off_t
 
size
 = 0;

307 
ªsu…
 = 
	`gëComp⁄ítSize
(
p‹èl
, 0, &
size
);

308 i‡(
ªsu…
 !
UDS_SUCCESS
) {

309 
	`logEº‹
("couldÇot determine indexÖage map info size");

310  
ªsu…
;

312 
Buf„ªdRódî
 *
ªadî
 = 
NULL
;

313 
ªsu…
 = 
	`gëBuf„ªdRódî
(
p‹èl
, 0, &
ªadî
);

314 i‡(
ªsu…
 !
UDS_SUCCESS
) {

315  
ªsu…
;

318 
size_t
 
ùmSize
 = 
	`ödexPageM≠Size
(
geomëry
);

319 i‡((
off_t
Ë
ùmSize
 =
size
) {

320 i‡(
vîsi⁄
 !
NULL
) {

321 *
vîsi⁄
 = 
INDEX_PAGE_MAP_V1
;

323 i‡(
ªadîPå
 !
NULL
) {

324 *
ªadîPå
 = 
ªadî
;

326  
UDS_SUCCESS
;

329 
ªsu…
 = 
	`vîifyBuf„ªdD©a
(
ªadî
, 
INDEX_PAGE_MAP_MAGIC
,

330 
INDEX_PAGE_MAP_MAGIC_LENGTH
);

331 i‡(
ªsu…
 !
UDS_SUCCESS
) {

332  
	`logEº‹WôhSåögEº‹
(
ªsu…
, "bad indexÖage map saved magic");

334 
buf
[
INDEX_PAGE_MAP_VERSION_LENGTH
 + 1];

335 
ªsu…
 = 
	`ªadFromBuf„ªdRódî
(
ªadî
, 
buf
, 
INDEX_PAGE_MAP_VERSION_LENGTH
);

336 i‡(
ªsu…
 !
UDS_SUCCESS
) {

337  
	`logEº‹WôhSåögEº‹
(
ªsu…
,

340 
buf
[
INDEX_PAGE_MAP_VERSION_LENGTH
] = '\0';

341 
vîs
;

342 
ªsu…
 = 
	`°rögToUnsig√dL⁄g
(
buf
, &
vîs
);

343 i‡(
ªsu…
 !
UDS_SUCCESS
) {

344  
	`logEº‹WôhSåögEº‹
(
UDS_CORRUPT_COMPONENT
,

345 "övÆid indexÖagêßvêvîsi⁄ %s", 
buf
);

347 i‡(
vîs
 !
INDEX_PAGE_MAP_V2
) {

348  
	`logEº‹WôhSåögEº‹
(
UDS_CORRUPT_COMPONENT
,

350 
vîs
);

352 i‡(
vîsi⁄
 !
NULL
) {

353 *
vîsi⁄
 = 
INDEX_PAGE_MAP_V2
;

355 i‡(
ªadîPå
 !
NULL
) {

356 *
ªadîPå
 = 
ªadî
;

358  
UDS_SUCCESS
;

359 
	}
}

362 
	$ªadIndexPageM≠
(
Comp⁄ítP‹èl
 *
p‹èl
)

364 
IndexPageM≠
 *
m≠
 = 
	`comp⁄ítD©aF‹P‹èl
(
p‹èl
);

366 
byã
 
vîsi⁄
 = 0;

367 
Buf„ªdRódî
 *
ªadî
 = 
NULL
;

368 
ªsu…
 = 
	`ªåõveFûeVîsi⁄
(
p‹èl
, 
m≠
->
geomëry
, &
vîsi⁄
, &
ªadî
);

369 i‡(
ªsu…
 !
UDS_SUCCESS
) {

370  
ªsu…
;

373 i‡(
vîsi⁄
 =
INDEX_PAGE_MAP_V1
) {

374 
m≠
->
œ°Upd©e
 = 0;

376 
ªsu…
 = 
	`ªadFromBuf„ªdRódî
(
ªadî
, &
m≠
->
œ°Upd©e
,

377 (
m≠
->
œ°Upd©e
));

378 i‡(
ªsu…
 !
UDS_SUCCESS
) {

379  
ªsu…
;

381 
	`logInfo
("ªad indexÖagêm≠,Üa° upd©ê%" 
PRIu64
, 
m≠
->
œ°Upd©e
);

383 
ªsu…
 = 
	`ªadFromBuf„ªdRódî
(
ªadî
, 
m≠
->
íåõs
,

384 
	`ödexPageM≠Size
(
m≠
->
geomëry
));

385 i‡(
ªsu…
 !
UDS_SUCCESS
) {

386 
	`logEº‹WôhSåögEº‹
(
ªsu…
, "cannotÑead indexÖage map data");

388  
UDS_SUCCESS
;

389 
	}
}

392 
	$dumpIndexPageM≠
(c⁄° 
IndexPageM≠
 *
m≠
, 
ch≠ãrNumbî
)

394 c⁄° 
Geomëry
 *
geomëry
 = 
m≠
->geometry;

395 i‡(
ch≠ãrNumbî
 >
geomëry
->
ch≠ãrsPîVﬁume
) {

396  
	`logEº‹WôhSåögEº‹
(

397 
UDS_INVALID_ARGUMENT
, "chapterÇumber %uÉxceeds maximum %u",

398 
ch≠ãrNumbî
, 
geomëry
->
ch≠ãrsPîVﬁume
 - 1);

401 
¶Ÿ
 = (
ch≠ãrNumbî
 * (
geomëry
->
ödexPagesPîCh≠ãr
 - 1));

402 
limô
 = 
¶Ÿ
 + (
geomëry
->
ödexPagesPîCh≠ãr
 - 1);

403 
ödexPageNumbî
 = 0;

404 
dñèLi°
 = 0;

405 
	`logInfo
("ödexÖagêm≠Üa° upd©ê%" 
PRIu64
, 
m≠
->
œ°Upd©e
);

406 ; 
¶Ÿ
 < 
limô
; 
ödexPageNumbî
++, slot++) {

407 
	`logInfo
("chapter %u indexÖage %uÜists %u-%u",

408 
ch≠ãrNumbî
, 
¶Ÿ
, 
dñèLi°
, 
m≠
->
íåõs
[slot]);

409 
dñèLi°
 = 
m≠
->
íåõs
[
¶Ÿ
] + 1;

411 
	`logInfo
("chapter %u indexÖage %uÜists %u-%u",

412 
ch≠ãrNumbî
, 
¶Ÿ
, 
dñèLi°
, 
geomëry
->
dñèLi°sPîCh≠ãr
);

413  
UDS_SUCCESS
;

414 
	}
}

	@uds/indexPageMap.h

22 #i‚de‡
INDEX_PAGE_MAP_H


23 
	#INDEX_PAGE_MAP_H
 1

	)

25 
	~"comm⁄.h
"

26 
	~"geomëry.h
"

27 
	~"ödexComp⁄ít.h
"

29 c⁄° 
IndexComp⁄ítInfo
 
INDEX_PAGE_MAP_INFO
;

31 
ödexPageM≠
 
	tIndexPageM≠
;

34 
	mlowe°Li°
;

35 
	mhighe°Li°
;

36 } 
	tIndexPageBounds
;

51 
uöt16_t
 
	tIndexPageM≠E¡ry
;

53 
	södexPageM≠
 {

54 c⁄° 
Geomëry
 *
	mgeomëry
;

55 
uöt64_t
 
	mœ°Upd©e
;

56 
IndexPageM≠E¡ry
 *
	míåõs
;

67 
	$makeIndexPageM≠
(c⁄° 
Geomëry
 *
geomëry
, 
IndexPageM≠
 **
m≠På
)

68 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

75 
	`‰ìIndexPageM≠
(
IndexPageM≠
 *
m≠
);

84 
uöt64_t
 
	`gëLa°Upd©e
(c⁄° 
IndexPageM≠
 *
m≠
);

97 
	$upd©eIndexPageM≠
(
IndexPageM≠
 *
m≠
,

98 
uöt64_t
 
vútuÆCh≠ãrNumbî
,

99 
ch≠ãrNumbî
,

100 
ödexPageNumbî
,

101 
dñèLi°Numbî
)

102 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

117 
	$födIndexPageNumbî
(c⁄° 
IndexPageM≠
 *
m≠
,

118 c⁄° 
UdsChunkName
 *
«me
,

119 
ch≠ãrNumbî
,

120 *
ödexPageNumbîPå
)

121 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

135 
	$gëLi°NumbîBounds
(c⁄° 
IndexPageM≠
 *
m≠
,

136 
ch≠ãrNumbî
,

137 
ödexPageNumbî
,

138 
IndexPageBounds
 *
bounds
)

139 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

150 
	`dumpIndexPageM≠
(c⁄° 
IndexPageM≠
 *
m≠
, 
ch≠ãr
);

159 
uöt64_t
 
	`compuãIndexPageM≠SaveSize
(c⁄° 
Geomëry
 *
geomëry
);

169 
size_t
 
	$ödexPageM≠Size
(c⁄° 
Geomëry
 *
geomëry
)

170 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

	@uds/indexRouter.c

22 
	~"ödexRouãr.h
"

25 
	$‰ìIndexRouãr
(
IndexRouãr
 *
rouãr
)

27 i‡(
rouãr
 !
NULL
) {

28 
rouãr
->
mëhods
->
	`‰ì
(router);

30 
	}
}

	@uds/indexRouter.h

22 #i‚de‡
INDEX_ROUTER_H


23 
	#INDEX_ROUTER_H


	)

25 
	~"compûî.h
"

26 
	~"ödexRouãrSèts.h
"

27 
	~"ªque°.h
"

33 
	mROUTER_LOCAL
,

34 
	mROUTER_REMOTE


35 } 
	tRouãrTy≥
;

44 (*
	tIndexRouãrCÆlback
)(
	tReque°
 *
	tªque°
);

50 
ödexRouãrMëhods
 
	tIndexRouãrMëhods
;

56 
	södexRouãr
 {

57 
RouãrTy≥
 
ty≥
;

58 c⁄° 
IndexRouãrMëhods
 *
mëhods
;

59 
IndexRouãrCÆlback
 
ˇŒback
;

67 
	`‰ìIndexRouãr
(
IndexRouãr
 *
rouãr
);

72 
	södexRouãrMëhods
 {

80 (*
ßveSèã
)(
IndexRouãr
 *
rouãr
);

87 (*
‰ì
)(
IndexRouãr
 *
rouãr
);

101 
Reque°Queue
 *(*
£À˘Queue
)(
IndexRouãr
 *
rouãr
,

102 
Reque°
 *
ªque°
,

103 
Reque°Sège
 
√xtSège
);

112 (*
execuã
)(
IndexRouãr
 *
rouãr
, 
Reque°
 *
ªque°
);

122 (*
gëSèti°ics
)(
IndexRouãr
 *
rouãr
, 
IndexRouãrSètCou¡îs
 *
cou¡îs
);

130 (*
£tCheckpoötFªquícy
)(
IndexRouãr
 *
rouãr
, 
‰equícy
);

140 
INLINE
 
boﬁ
 
	$isRouãrLoˇl
(
IndexRouãr
 *
rouãr
)

142  (
rouãr
->
ty≥
 =
ROUTER_LOCAL
);

143 
	}
}

	@uds/indexRouterStats.h

22 #i‚de‡
INDEX_ROUTER_STATS_H


23 
	#INDEX_ROUTER_STATS_H


	)

25 
	~"ˇcheCou¡îs.h
"

27 
	södexRouãrSètCou¡îs
 {

28 
uöt64_t
 
	míåõsIndexed
;

29 
uöt64_t
 
	mmem‹yU£d
;

30 
uöt64_t
 
	mdiskU£d
;

31 
uöt64_t
 
	mnumDli°s
;

32 
uöt64_t
 
	mcﬁlisi⁄s
;

33 
uöt64_t
 
	míåõsDisˇrded
;

34 
uöt64_t
 
	mcheckpoöts
;

35 
CacheCou¡îs
 
	mvﬁumeCache
;

	@uds/indexSession.c

22 
	~"ödexSessi⁄.h
"

24 
	~"grid.h
"

25 
	~"loggî.h
"

26 
	~"mem‹yAŒoc.h
"

27 
	~"nŸifiˇti⁄Defs.h
"

28 
	~"udsSèã.h
"

31 
	$checkIndexSessi⁄
(
IndexSessi⁄
 *
ödexSessi⁄
)

33 
	`gëIndexSessi⁄Sèã
(
ödexSessi⁄
)) {

34 
IS_READY
:

35  
UDS_SUCCESS
;

36 
IS_DISABLED
:

37  
UDS_DISABLED
;

38 
IS_INIT
:

40  
UDS_NO_INDEXSESSION
;

42 
	}
}

45 
IndexSessi⁄Sèã
 
	$gëIndexSessi⁄Sèã
(
IndexSessi⁄
 *
ödexSessi⁄
)

47  (
IndexSessi⁄Sèã
Ë(
öt32_t
Ë
	`©omicLﬂd32
(&
ödexSessi⁄
->
°©e
);

48 
	}
}

51 
	$£tIndexSessi⁄Sèã
(
IndexSessi⁄
 *
ödexSessi⁄
,

52 
IndexSessi⁄Sèã
 
°©e
)

54 
	`©omicSt‹e32
(&
ödexSessi⁄
->
°©e
, state);

55 
	}
}

58 
	$gëIndexSessi⁄
(
ödexSessi⁄ID
,

59 
IndexSessi⁄
 **
ödexSessi⁄På
)

61 
Sessi⁄
 *
£ssi⁄
;

62 
ªsu…
 = 
	`gëSessi⁄
(
	`gëIndexSessi⁄Group
(), 
ödexSessi⁄ID
, &
£ssi⁄
);

63 i‡(
ªsu…
 !
UDS_SUCCESS
) {

64  
ªsu…
;

67 
IndexSessi⁄
 *
ödexSessi⁄
 = (IndexSessi⁄ *Ë
	`gëSessi⁄C⁄ã¡s
(
£ssi⁄
);

68 
ªsu…
 = 
	`checkIndexSessi⁄
(
ödexSessi⁄
);

69 i‡(
ªsu…
 !
UDS_SUCCESS
) {

70 
	`ªÀa£Sessi⁄
(
£ssi⁄
);

71  
ªsu…
;

74 *
ödexSessi⁄På
 = 
ödexSessi⁄
;

75  
UDS_SUCCESS
;

76 
	}
}

79 
	$ªÀa£IndexSessi⁄
(
IndexSessi⁄
 *
ödexSessi⁄
)

81 
	`ªÀa£Sessi⁄
(&
ödexSessi⁄
->
£ssi⁄
);

82 
	}
}

85 
	$makeEm±yIndexSessi⁄
(
IndexSessi⁄
 **
ödexSessi⁄På
)

87 
IndexSessi⁄
 *
£ssi⁄
;

88 
ªsu…


89 
	`ALLOCATE
(1, 
IndexSessi⁄
, "em±y index sessi⁄", &
£ssi⁄
);

90 i‡(
ªsu…
 !
UDS_SUCCESS
) {

91  
ªsu…
;

94 
	`£tIndexSessi⁄Sèã
(
£ssi⁄
, 
IS_INIT
);

96 *
ödexSessi⁄På
 = 
£ssi⁄
;

97  
UDS_SUCCESS
;

98 
	}
}

101 
	$ßveIndexSessi⁄
(
IndexSessi⁄
 *
ödexSessi⁄
)

103 i‡(
ödexSessi⁄
 =
NULL
) {

104  
UDS_SUCCESS
;

107 
ªsu…
 = 
	`ßveGrid
(
ödexSessi⁄
->
grid
);

108 
	`‰ìGrid
(
ödexSessi⁄
->
grid
);

109  
ªsu…
;

110 
	}
}

113 
	$ßveAndFªeIndexSessi⁄
(
IndexSessi⁄
 *
ödexSessi⁄
)

115 
ªsu…
 = 
	`ßveIndexSessi⁄
(
ödexSessi⁄
);

116 i‡(
ªsu…
 !
UDS_SUCCESS
) {

117 
	`logInfoWôhSåögEº‹
(
ªsu…
, "ignoringÉrror from saveIndexSession");

119 
	`logNŸi˚
("Closed index session (%u, %p)",

120 
ödexSessi⁄
->
£ssi⁄
.
id
, (*) indexSession);

121 
	`FREE
(
ödexSessi⁄
);

122  
ªsu…
;

123 
	}
}

126 
	$udsClo£IndexSessi⁄
(
UdsIndexSessi⁄
 
£ssi⁄
)

128 
Sessi⁄Group
 *
ödexSessi⁄Group
 = 
	`gëIndexSessi⁄Group
();

129 
ªsu…
 = 
	`acquúeSessi⁄Group
(
ödexSessi⁄Group
);

131 
Sessi⁄
 *
ba£Sessi⁄
;

132 
ªsu…
 = 
	`gëSessi⁄
(
ödexSessi⁄Group
, 
£ssi⁄
.
id
, &
ba£Sessi⁄
);

133 i‡(
ªsu…
 !
UDS_SUCCESS
) {

134 
	`ªÀa£Sessi⁄Group
(
ödexSessi⁄Group
);

135  
ªsu…
;

137 
IndexSessi⁄
 *
ödexSessi⁄


138 (
IndexSessi⁄
 *Ë
	`gëSessi⁄C⁄ã¡s
(
ba£Sessi⁄
);

140 
	`logNŸi˚
("Closing index session (%u, %p)",

141 
£ssi⁄
.
id
, (*Ë
ödexSessi⁄
);

142 
	`föishSessi⁄
(
ödexSessi⁄Group
, &
ödexSessi⁄
->
£ssi⁄
);

143 
ªsu…
 = 
	`ßveAndFªeIndexSessi⁄
(
ödexSessi⁄
);

144 
	`ªÀa£Sessi⁄Group
(
ödexSessi⁄Group
);

145 
	`nŸifyIndexClo£d
(
£ssi⁄
);

146  
ªsu…
;

147 
	}
}

150 
	$udsSëCheckpoötFªquícy
(
UdsIndexSessi⁄
 
£ssi⁄
, 
‰equícy
)

152 
IndexSessi⁄
 *
ödexSessi⁄
;

153 
ªsu…
 = 
	`gëIndexSessi⁄
(
£ssi⁄
.
id
, &
ödexSessi⁄
);

154 i‡(
ªsu…
 !
UDS_SUCCESS
) {

155  
ªsu…
;

158 
ªsu…
 = 
	`£tGridCheckpoötFªquícy
(
ödexSessi⁄
->
grid
, 
‰equícy
);

159 
	`ªÀa£IndexSessi⁄
(
ödexSessi⁄
);

160  
ªsu…
;

161 
	}
}

	@uds/indexSession.h

22 #i‚de‡
INDEX_SESSION_H


23 
	#INDEX_SESSION_H


	)

25 
	~"›aqueTy≥s.h
"

26 
	~"£ssi⁄.h
"

27 
	~"uds.h
"

28 
	~"utû/©omic.h
"

31 
	mIS_INIT
 = 1,

32 
	mIS_READY
 = 2,

33 
	mIS_DISABLED
 = 3

34 } 
	tIndexSessi⁄Sèã
;

39 
	södexSessi⁄
 {

40 
Sessi⁄
 
	m£ssi⁄
;

41 
Atomic32
 
	m°©e
;

42 
Grid
 *
	mgrid
;

52 
	$checkIndexSessi⁄
(
IndexSessi⁄
 *
ödexSessi⁄
)

53 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

60 
IndexSessi⁄Sèã
 
	`gëIndexSessi⁄Sèã
(
IndexSessi⁄
 *
ödexSessi⁄
);

68 
	`£tIndexSessi⁄Sèã
(
IndexSessi⁄
 *
ödexSessi⁄
,

69 
IndexSessi⁄Sèã
 
°©e
);

82 
	$gëIndexSessi⁄
(
ödexSessi⁄ID
,

83 
IndexSessi⁄
 **
ödexSessi⁄På
)

84 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

91 
	`ªÀa£IndexSessi⁄
(
IndexSessi⁄
 *
ödexSessi⁄
);

100 
	$makeEm±yIndexSessi⁄
(
IndexSessi⁄
 **
ödexSessi⁄På
)

101 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

110 
	`ßveAndFªeIndexSessi⁄
(
IndexSessi⁄
 *
ödexSessi⁄
);

121 
	$udsSëCheckpoötFªquícy
(
UdsIndexSessi⁄
 
£ssi⁄
, 
‰equícy
)

122 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

	@uds/indexState.c

22 
	~"ödexSèãI¡î«ls.h
"

24 
	~"îr‹s.h
"

25 
	~"ödexComp⁄ítI¡î«l.h
"

26 
	~"loggî.h
"

27 
	~"mem‹yAŒoc.h
"

30 
	$öôIndexSèã
(
IndexSèã
 *
°©e
,

31 
id
,

32 
z⁄eCou¡
,

33 
Àngth
,

34 c⁄° 
IndexSèãOps
 *
›s
)

36 i‡(
Àngth
 == 0) {

37  
	`logEº‹WôhSåögEº‹
(

38 
UDS_INVALID_ARGUMENT
, "cannot make index state withÜength 0");

41 
°©e
->
id
 = id;

42 
°©e
->
z⁄eCou¡
 = zoneCount;

43 
°©e
->
cou¡
 = 0;

44 
°©e
->
Àngth
 =Üength;

45 
°©e
->
ßvög
 = 
Ál£
;

46 
°©e
->
›s
 = ops;

48  
	`ALLOCATE
(
°©e
->
Àngth
, 
IndexComp⁄ít
 *, "index stateÉntries",

49 &
°©e
->
íåõs
);

50 
	}
}

53 
	$de°royIndexSèã
(
IndexSèã
 *
°©e
)

55 i‡(
°©e
 !
NULL
) {

56 
i
 = 0; i < 
°©e
->
cou¡
; ++i) {

57 
	`‰ìIndexComp⁄ít
(&
°©e
->
íåõs
[
i
]);

59 
	`FREE
(
°©e
->
íåõs
);

61 
	}
}

64 
	$‰ìIndexSèã
(
IndexSèã
 **
°©ePå
)

66 i‡(*
°©ePå
 !
NULL
) {

67 (*
°©ePå
)->
›s
->
	`‰ìFunc
(*statePtr);

68 *
°©ePå
 = 
NULL
;

70 
	}
}

73 
	$addIndexSèãComp⁄ít
(
IndexSèã
 *
°©e
,

74 c⁄° 
IndexComp⁄ítInfo
 *
öfo
,

75 *
d©a
,

76 *
c⁄ãxt
)

78  
°©e
->
›s
->
	`addComp⁄ít
(°©e, 
öfo
, 
d©a
, 
c⁄ãxt
);

79 
	}
}

82 
	$addComp⁄ítToIndexSèã
(
IndexSèã
 *
°©e
,

83 
IndexComp⁄ít
 *
comp⁄ít
)

85 i‡(
	`födIndexComp⁄ít
(
°©e
, 
comp⁄ít
->
öfo
Ë!
NULL
) {

86  
	`logEº‹WôhSåögEº‹
(

87 
UDS_INVALID_ARGUMENT
, "cannotádd state component %s:álreadyÖresent",

88 
comp⁄ít
->
öfo
->
«me
);

91 i‡(
°©e
->
cou¡
 >°©e->
Àngth
) {

92  
	`logEº‹WôhSåögEº‹
(

93 
UDS_RESOURCE_LIMIT_EXCEEDED
,

95 
comp⁄ít
->
öfo
->
«me
, 
°©e
->
cou¡
);

98 
°©e
->
íåõs
[°©e->
cou¡
] = 
comp⁄ít
;

99 ++
°©e
->
cou¡
;

100  
UDS_SUCCESS
;

101 
	}
}

104 
IndexComp⁄ít
 *
	$födIndexComp⁄ít
(c⁄° 
IndexSèã
 *
°©e
,

105 c⁄° 
IndexComp⁄ítInfo
 *
öfo
)

107 
i
 = 0; i < 
°©e
->
cou¡
; ++i) {

108 
IndexComp⁄ít
 *
comp⁄ít
 = 
°©e
->
íåõs
[
i
];

109 i‡((
öfo
 =
comp⁄ít
->info)

110 || (
	`°rcmp
(
öfo
->
fûeName
, 
comp⁄ít
->info->fileName) == 0)) {

111  
comp⁄ít
;

114  
NULL
;

115 
	}
}

117 
	$lﬂdIndexSèã
(
IndexSèã
 *
°©e
,

118 
boﬁ
 *
ª∂ayPå
)

120  
°©e
->
›s
->
	`lﬂdSèã
(°©e, 
ª∂ayPå
);

121 
	}
}

135 
	$¥ï¨eToSave
(
IndexSèã
 *
°©e
, 
IndexSaveTy≥
 
ty≥
)

137 i‡(
°©e
->
ßvög
) {

138  
	`logEº‹WôhSåögEº‹
(
UDS_BAD_STATE
,

141  
°©e
->
›s
->
	`¥ï¨eSave
(°©e, 
ty≥
);

142 
	}
}

152 
	$com∂ëeIndexSavög
(
IndexSèã
 *
°©e
)

154 
°©e
->
ßvög
 = 
Ál£
;

156 
ªsu…
 = 
°©e
->
›s
->
	`commôSave
(state);

157 i‡(
ªsu…
 !
UDS_SUCCESS
) {

158  
	`logEº‹WôhSåögEº‹
(
ªsu…
, "cannot commit index state");

160  
UDS_SUCCESS
;

161 
	}
}

164 
	$gíîicLﬂdIndexSèã
(
IndexSèã
 *
°©e
,

165 
boﬁ
 *
ª∂ayPå
)

167 
boﬁ
 
ª∂ayRequúed
 = 
Ál£
;

168 
i
 = 0; i < 
°©e
->
cou¡
; ++i) {

169 
IndexComp⁄ít
 *
comp⁄ít
 = 
°©e
->
íåõs
[
i
];

170 
ªsu…
 = 
	`ªadIndexComp⁄ít
(
comp⁄ít
);

171 i‡(
ªsu…
 !
UDS_SUCCESS
) {

172 i‡(!
	`missögIndexComp⁄ítRequúesRïœy
(
comp⁄ít
)) {

173  
	`logEº‹WôhSåögEº‹
(
ªsu…
,

175 
	`ödexComp⁄ítName
(
comp⁄ít
));

177 
ª∂ayRequúed
 = 
åue
;

181 i‡(
ª∂ayPå
 !
NULL
) {

182 *
ª∂ayPå
 = 
ª∂ayRequúed
;

184  
UDS_SUCCESS
;

185 
	}
}

188 
	$gíîicSaveIndexSèã
(
IndexSèã
 *
°©e
)

190 
ªsu…
 = 
UDS_SUCCESS
;

191 
i
 = 0; i < 
°©e
->
cou¡
; ++i) {

192 
IndexComp⁄ít
 *
comp⁄ít
 = 
°©e
->
íåõs
[
i
];

193 
ªsu…
 = 
	`wrôeIndexComp⁄ít
(
comp⁄ít
);

194 i‡(
ªsu…
 !
UDS_SUCCESS
) {

198  
ªsu…
;

199 
	}
}

202 
	$gíîicWrôeIndexSèãCheckpoöt
(
IndexSèã
 *
°©e
)

204 
ªsu…
 = 
UDS_SUCCESS
;

205 
i
 = 0; i < 
°©e
->
cou¡
; ++i) {

206 
IndexComp⁄ít
 *
comp⁄ít
 = 
°©e
->
íåõs
[
i
];

207 i‡(
	`skùIndexComp⁄ítOnCheckpoöt
(
comp⁄ít
)) {

210 
ªsu…
 = 
	`wrôeIndexComp⁄ít
(
comp⁄ít
);

211 i‡(
ªsu…
 !
UDS_SUCCESS
) {

216  
ªsu…
;

217 
	}
}

220 
	$ßveIndexSèã
(
IndexSèã
 *
°©e
)

222 
ªsu…
 = 
	`¥ï¨eToSave
(
°©e
, 
IS_SAVE
);

223 i‡(
ªsu…
 !
UDS_SUCCESS
) {

224  
ªsu…
;

227 
ªsu…
 = 
°©e
->
›s
->
	`ßveSèã
(state);

228 i‡(
ªsu…
 !
UDS_SUCCESS
) {

229 
°©e
->
›s
->
	`˛ónupSave
(state);

230  
ªsu…
;

233 
ªsu…
 = 
	`com∂ëeIndexSavög
(
°©e
);

234 i‡(
ªsu…
 !
UDS_SUCCESS
) {

235  
ªsu…
;

238  
UDS_SUCCESS
;

239 
	}
}

242 
	$wrôeIndexSèãCheckpoöt
(
IndexSèã
 *
°©e
)

244 
ªsu…
 = 
	`¥ï¨eToSave
(
°©e
, 
IS_CHECKPOINT
);

245 i‡(
ªsu…
 !
UDS_SUCCESS
) {

246  
ªsu…
;

249 
ªsu…
 = 
°©e
->
›s
->
	`wrôeCheckpoöt
(state);

250 i‡(
ªsu…
 !
UDS_SUCCESS
) {

251 
°©e
->
›s
->
	`˛ónupSave
(state);

252  
ªsu…
;

255 
ªsu…
 = 
	`com∂ëeIndexSavög
(
°©e
);

256 i‡(
ªsu…
 !
UDS_SUCCESS
) {

257  
ªsu…
;

260  
UDS_SUCCESS
;

261 
	}
}

264 
	$°¨tIndexSèãCheckpoöt
(
IndexSèã
 *
°©e
)

266 
ªsu…
 = 
	`¥ï¨eToSave
(
°©e
, 
IS_CHECKPOINT
);

267 i‡(
ªsu…
 !
UDS_SUCCESS
) {

268  
ªsu…
;

271 
°©e
->
ßvög
 = 
åue
;

273 
i
 = 0; i < 
°©e
->
cou¡
; ++i) {

274 
IndexComp⁄ít
 *
comp⁄ít
 = 
°©e
->
íåõs
[
i
];

275 i‡(
	`skùIndexComp⁄ítOnCheckpoöt
(
comp⁄ít
)) {

278 
ªsu…
 = 
	`°¨tIndexComp⁄ítIn¸emíèlSave
(
comp⁄ít
);

279 i‡(
ªsu…
 !
UDS_SUCCESS
) {

280 
	`ab‹tIndexSèãCheckpoöt
(
°©e
);

281  
ªsu…
;

285  
ªsu…
;

286 
	}
}

289 
	$≥rf‹mIndexSèãCheckpoötCh≠ãrSynchr⁄izedSaves
(
IndexSèã
 *
°©e
)

291 i‡(!
°©e
->
ßvög
) {

292  
UDS_SUCCESS
;

295 
i
 = 0; i < 
°©e
->
cou¡
; ++i) {

296 
IndexComp⁄ít
 *
comp⁄ít
 = 
°©e
->
íåõs
[
i
];

297 i‡(
	`skùIndexComp⁄ítOnCheckpoöt
(
comp⁄ít
) ||

298 !
	`de„rIndexComp⁄ítCheckpoötToCh≠ãrWrôî
(
comp⁄ít
)) {

301 
ªsu…
 = 
	`≥rf‹mIndexComp⁄ítCh≠ãrWrôîSave
(
comp⁄ít
);

302 i‡(
ªsu…
 !
UDS_SUCCESS
) {

303  
ªsu…
;

307  
UDS_SUCCESS
;

308 
	}
}

321 
doIndexSèãCheckpoötInZ⁄e
(
IndexSèã
 *
°©e
,

322 
z⁄e
,

323 (*
compFunc
)(
IndexComp⁄ít
 *,

325 
Com∂ëi⁄Sètus
 *),

326 
Com∂ëi⁄Sètus
 *
com∂ëed
)

328 i‡(!
°©e
->
ßvög
) {

329 i‡(
com∂ëed
 !
NULL
) {

330 *
com∂ëed
 = 
CS_COMPLETED_PREVIOUSLY
;

332  
UDS_SUCCESS
;

335 
Com∂ëi⁄Sètus
 
°©us
 = 
CS_COMPLETED_PREVIOUSLY
;

337 
i
 = 0; i < 
°©e
->
cou¡
; ++i) {

338 
IndexComp⁄ít
 *
comp⁄ít
 = 
°©e
->
íåõs
[
i
];

339 i‡(
	`skùIndexComp⁄ítOnCheckpoöt
(
comp⁄ít
)) {

342 i‡(
z⁄e
 > 0 && !
comp⁄ít
->
öfo
->
mu…iZ⁄e
) {

345 
Com∂ëi⁄Sètus
 
comp⁄ítSètus
 = 
CS_NOT_COMPLETED
;

346 
ªsu…
 = (*
compFunc
)(
comp⁄ít
, 
z⁄e
, &
comp⁄ítSètus
);

347 i‡(
ªsu…
 !
UDS_SUCCESS
) {

348  
ªsu…
;

351 i‡(
comp⁄ítSètus
 < 
°©us
) {

352 
°©us
 = 
comp⁄ítSètus
;

356 i‡(
com∂ëed
 !
NULL
) {

357 *
com∂ëed
 = 
°©us
;

359  
UDS_SUCCESS
;

360 
	}
}

363 
	$≥rf‹mIndexSèãCheckpoötInZ⁄e
(
IndexSèã
 *
°©e
,

364 
z⁄e
,

365 
Com∂ëi⁄Sètus
 *
com∂ëed
)

367  
	`doIndexSèãCheckpoötInZ⁄e
(
°©e
, 
z⁄e
,

368 &
≥rf‹mIndexComp⁄ítZ⁄eSave
,

369 
com∂ëed
);

370 
	}
}

373 
	$föishIndexSèãCheckpoötInZ⁄e
(
IndexSèã
 *
°©e
,

374 
z⁄e
,

375 
Com∂ëi⁄Sètus
 *
com∂ëed
)

377  
	`doIndexSèãCheckpoötInZ⁄e
(
°©e
, 
z⁄e
,

378 &
föishIndexComp⁄ítZ⁄eSave
,

379 
com∂ëed
);

380 
	}
}

383 
	$ab‹tIndexSèãCheckpoötInZ⁄e
(
IndexSèã
 *
°©e
,

384 
z⁄e
,

385 
Com∂ëi⁄Sètus
 *
com∂ëed
)

387  
	`doIndexSèãCheckpoötInZ⁄e
(
°©e
, 
z⁄e
,

388 &
ab‹tIndexComp⁄ítZ⁄eSave
,

389 
com∂ëed
);

390 
	}
}

393 
	$föishIndexSèãCheckpoöt
(
IndexSèã
 *
°©e
)

395 i‡(!
°©e
->
ßvög
) {

396  
UDS_SUCCESS
;

399 
i
 = 0; i < 
°©e
->
cou¡
; ++i) {

400 
IndexComp⁄ít
 *
comp⁄ít
 = 
°©e
->
íåõs
[
i
];

401 i‡(
	`skùIndexComp⁄ítOnCheckpoöt
(
comp⁄ít
)) {

404 
ªsu…
 = 
	`föishIndexComp⁄ítIn¸emíèlSave
(
comp⁄ít
);

405 i‡(
ªsu…
 !
UDS_SUCCESS
) {

406 
	`ab‹tIndexSèãCheckpoöt
(
°©e
);

407  
ªsu…
;

411 
ªsu…
 = 
	`com∂ëeIndexSavög
(
°©e
);

412 i‡(
ªsu…
 !
UDS_SUCCESS
) {

413  
ªsu…
;

416  
UDS_SUCCESS
;

417 
	}
}

420 
	$ab‹tIndexSèãCheckpoöt
(
IndexSèã
 *
°©e
)

422 i‡(!
°©e
->
ßvög
) {

423  
	`logEº‹WôhSåögEº‹
(
UDS_BAD_STATE
,

427 
	`logEº‹
("aborting index state checkpoint");

429 
ªsu…
 = 
UDS_SUCCESS
;

430 
i
 = 0; i < 
°©e
->
cou¡
; ++i) {

431 
IndexComp⁄ít
 *
comp⁄ít
 = 
°©e
->
íåõs
[
i
];

432 i‡(
	`skùIndexComp⁄ítOnCheckpoöt
(
comp⁄ít
)) {

435 
tmp
 = 
	`ab‹tIndexComp⁄ítIn¸emíèlSave
(
comp⁄ít
);

436 i‡(
ªsu…
 =
UDS_SUCCESS
) {

437 
ªsu…
 = 
tmp
;

441 
°©e
->
›s
->
	`˛ónupSave
(state);

442 
°©e
->
ßvög
 = 
Ál£
;

444  
ªsu…
;

445 
	}
}

448 
	$wrôeSögÀIndexSèãComp⁄ít
(
IndexSèã
 *
°©e
,

449 c⁄° 
IndexComp⁄ítInfo
 *
öfo
)

451 
IndexComp⁄ít
 *
comp⁄ít
 = 
	`födIndexComp⁄ít
(
°©e
, 
öfo
);

453 i‡(
comp⁄ít
 =
NULL
) {

454  
UDS_INVALID_ARGUMENT
;

457 
ªsu…
 = 
	`¥ï¨eToSave
(
°©e
, 
IS_SAVE
);

458 i‡(
ªsu…
 !
UDS_SUCCESS
) {

459  
ªsu…
;

462  
°©e
->
›s
->
	`wrôeSögÀComp⁄ít
(°©e, 
comp⁄ít
);

463 
	}
}

466 
	$disˇrdIndexSèãD©a
(
IndexSèã
 *
°©e
)

468  
°©e
->
›s
->
	`disˇrdSaves
(°©e, 
DT_DISCARD_ALL
);

469 
	}
}

472 
	$disˇrdLa°IndexSèãSave
(
IndexSèã
 *
°©e
)

474  
°©e
->
›s
->
	`disˇrdSaves
(°©e, 
DT_DISCARD_LATEST
);

475 
	}
}

478 c⁄° *
	$ödexSaveTy≥Name
(
IndexSaveTy≥
 
ßveTy≥
)

480  
ßveTy≥
 =
IS_SAVE
 ? "save" : "checkpoint";

481 
	}
}

	@uds/indexState.h

22 #i‚de‡
INDEX_STATE_H


23 
	#INDEX_STATE_H
 1

	)

25 
	~"ödexComp⁄ít.h
"

27 
ödexSèãOps
 
	tIndexSèãOps
;

33 
	mIS_SAVE
,

34 
	mIS_CHECKPOINT
,

35 
	mNO_SAVE
 = 9999,

36 } 
	tIndexSaveTy≥
;

45 
	södexSèã
 {

46 
	mid
;

47 
	mz⁄eCou¡
;

48 
	mcou¡
;

49 
	mÀngth
;

50 
IndexComp⁄ít
 **
	míåõs
;

51 
boﬁ
 
	mßvög
;

52 c⁄° 
IndexSèãOps
 *
	m›s
;

53 } 
	tIndexSèã
;

61 
‰ìIndexSèã
(
IndexSèã
 **
°©ePå
);

73 
	$addIndexSèãComp⁄ít
(
IndexSèã
 *
°©e
,

74 c⁄° 
IndexComp⁄ítInfo
 *
öfo
,

75 *
d©a
,

76 *
c⁄ãxt
)

77 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

87 
	$lﬂdIndexSèã
(
IndexSèã
 *
°©e
,

88 
boﬁ
 *
ª∂ayPå
)

89 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

98 
	$ßveIndexSèã
(
IndexSèã
 *
°©e
)

99 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

108 
	$wrôeIndexSèãCheckpoöt
(
IndexSèã
 *
°©e
)

109 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

119 
	$°¨tIndexSèãCheckpoöt
(
IndexSèã
 *
°©e
)

120 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

130 
	$≥rf‹mIndexSèãCheckpoötCh≠ãrSynchr⁄izedSaves
(
IndexSèã
 *
°©e
)

131 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

143 
	$≥rf‹mIndexSèãCheckpoötInZ⁄e
(
IndexSèã
 *
°©e
,

144 
z⁄e
,

145 
Com∂ëi⁄Sètus
 *
com∂ëed
)

146 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

159 
	$föishIndexSèãCheckpoötInZ⁄e
(
IndexSèã
 *
°©e
,

160 
z⁄e
,

161 
Com∂ëi⁄Sètus
 *
com∂ëed
)

162 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

172 
	$föishIndexSèãCheckpoöt
(
IndexSèã
 *
°©e
)

173 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

186 
	`ab‹tIndexSèãCheckpoötInZ⁄e
(
IndexSèã
 *
°©e
,

187 
z⁄e
,

188 
Com∂ëi⁄Sètus
 *
com∂ëed
);

198 
	`ab‹tIndexSèãCheckpoöt
(
IndexSèã
 *
°©e
);

209 
	`disˇrdIndexSèãD©a
(
IndexSèã
 *
°©e
);

220 
	`disˇrdLa°IndexSèãSave
(
IndexSèã
 *
°©e
);

230 
IndexComp⁄ít
 *
	$födIndexComp⁄ít
(c⁄° 
IndexSèã
 *
°©e
,

231 c⁄° 
IndexComp⁄ítInfo
 *
öfo
)

232 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

242 
	$wrôeSögÀIndexSèãComp⁄ít
(
IndexSèã
 *
°©e
,

243 c⁄° 
IndexComp⁄ítInfo
 *
öfo
)

244 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

	@uds/indexStateData.c

22 
	~"ödexSèãD©a.h
"

24 
	~"îr‹s.h
"

25 
	~"ödex.h
"

26 
	~"loggî.h
"

27 
	~"≥rmas£π.h
"

28 
	~"uds.h
"

47 
öt32_t
 
	msig«tuª
;

48 
öt32_t
 
	mvîsi⁄ID
;

49 } 
	tIndexSèãVîsi⁄
;

52 (*
	tIndexSèãRódî
)(
	tBuf„ªdRódî
 *
	tªadî
, 
	tIndex
 *
	tödex
);

53 (*
	tIndexSèãWrôî
)(
	tBuf„ªdWrôî
 *
	twrôî
, 
	tIndex
 *
	tödex
);

57 c⁄° 
IndexSèãVîsi⁄
 *
vîsi⁄
;

58 
IndexSèãRódî
 
ªadî
;

59 
IndexSèãWrôî
 
wrôî
;

60 } 
	tIndexSèãFûe
;

64 
uöt64_t
 
√we°Ch≠ãr
;

65 
uöt32_t
 
ﬁde°Ch≠ãr
;

66 
uöt32_t
 
œ°Checkpoöt
;

67 
uöt32_t
 
id
;

68 } 
	tIndexSèãD©a300
;

70 c⁄° 
IndexSèãVîsi⁄
 
INDEX_STATE_VERSION_300
 = {

71 .
sig«tuª
 = -1,

72 .
vîsi⁄ID
 = 300,

73 
	}
};

75 
ªadIndexSèã300
(
Buf„ªdRódî
 *
ªadî
, 
Index
 *
ödex
);

77 c⁄° 
IndexSèãFûe
 
	gINDEX_STATE_300
 = {

78 .
vîsi⁄
 = &
INDEX_STATE_VERSION_300
,

79 .
	gªadî
 = &
ªadIndexSèã300
,

80 .
	gwrôî
 = 
NULL
,

85 
uöt64_t
 
	m√we°Ch≠ãr
;

86 
uöt64_t
 
	mﬁde°Ch≠ãr
;

87 
uöt64_t
 
	mœ°Checkpoöt
;

88 
uöt32_t
 
	mid
;

89 
uöt32_t
 
	m∑ddög
;

90 } 
	tIndexSèãD©a301
;

92 c⁄° 
IndexSèãVîsi⁄
 
	gINDEX_STATE_VERSION_301
 = {

93 .
sig«tuª
 = -1,

94 .
	gvîsi⁄ID
 = 301,

97 
ªadIndexSèã301
(
Buf„ªdRódî
 *
ªadî
, 
Index
 *
ödex
);

98 
wrôeIndexSèã301
(
Buf„ªdWrôî
 *
wrôî
, 
Index
 *
ödex
);

100 c⁄° 
IndexSèãFûe
 
	gINDEX_STATE_301
 = {

101 .
vîsi⁄
 = &
INDEX_STATE_VERSION_301
,

102 .
	gªadî
 = &
ªadIndexSèã301
,

103 .
	gwrôî
 = &
wrôeIndexSèã301
,

107 c⁄° 
IndexSèãFûe
 *c⁄° 
	gSUPPORTED_STATES
[] = {

108 &
INDEX_STATE_301
,

109 &
INDEX_STATE_300
,

110 
NULL


114 c⁄° 
IndexSèãFûe
 *c⁄° 
	gCURRENT_INDEX_STATE
 = &
INDEX_STATE_301
;

117 
ªadIndexSèãD©a
(
Comp⁄ítP‹èl
 *
p‹èl
);

118 
wrôeIndexSèãD©a
(
IndexComp⁄ít
 *
comp⁄ít
,

119 
Buf„ªdWrôî
 *
wrôî
,

120 
z⁄e
);

123 c⁄° 
IndexComp⁄ítInfo
 
	gINDEX_STATE_INFO
 = {

124 .
köd
 = 
RL_KIND_INDEX_STATE
,

125 .
	g«me
 = "index state",

126 .
	gfûeName
 = "index_state",

127 .
	gßveO∆y
 = 
Ál£
,

128 .
	gch≠ãrSync
 = 
åue
,

129 .
	gmu…iZ⁄e
 = 
Ál£
,

130 .
	glﬂdî
 = 
ªadIndexSèãD©a
,

131 .
	gßvî
 = 
wrôeIndexSèãD©a
,

132 .
	gö¸emíèl
 = 
NULL
,

143 
	$ªadIndexSèã301
(
Buf„ªdRódî
 *
ªadî
, 
Index
 *
ödex
)

145 
IndexSèãD©a301
 
°©e
;

146 
ªsu…
 = 
	`ªadFromBuf„ªdRódî
(
ªadî
, &
°©e
, (state));

147 i‡(
ªsu…
 !
UDS_SUCCESS
) {

148  
ªsu…
;

151 
ödex
->
√we°VútuÆCh≠ãr
 = 
°©e
.
√we°Ch≠ãr
;

152 
ödex
->
ﬁde°VútuÆCh≠ãr
 = 
°©e
.
ﬁde°Ch≠ãr
;

153 
ödex
->
œ°Checkpoöt
 = 
°©e
.lastCheckpoint;

154 
ödex
->
id
 = 
°©e
.id;

156  
UDS_SUCCESS
;

157 
	}
}

167 
	$wrôeIndexSèã301
(
Buf„ªdWrôî
 *
wrôî
, 
Index
 *
ödex
)

169 
IndexSèãD©a301
 
°©e
 = {

170 .
√we°Ch≠ãr
 = 
ödex
->
√we°VútuÆCh≠ãr
,

171 .
ﬁde°Ch≠ãr
 = 
ödex
->
ﬁde°VútuÆCh≠ãr
,

172 .
œ°Checkpoöt
 = 
ödex
->lastCheckpoint,

173 .
id
 = 
ödex
->id,

175  
	`wrôeToBuf„ªdWrôî
(
wrôî
, &
°©e
, (
IndexSèãD©a301
));

176 
	}
}

186 
	$ªadIndexSèã300
(
Buf„ªdRódî
 *
ªadî
, 
Index
 *
ödex
)

188 
IndexSèãD©a300
 
°©e
;

189 
ªsu…
 = 
	`ªadFromBuf„ªdRódî
(
ªadî
, &
°©e
, (state));

190 i‡(
ªsu…
 !
UDS_SUCCESS
) {

191  
ªsu…
;

194 
Geomëry
 *
geomëry
 = 
ödex
->
vﬁume
->geometry;

196 
ödex
->
√we°VútuÆCh≠ãr
 = 
°©e
.
√we°Ch≠ãr
;

197 
ödex
->
ﬁde°VútuÆCh≠ãr
 = 
	`m≠ToVútuÆCh≠ãrNumbî
(
geomëry
,

198 
°©e
.
√we°Ch≠ãr
,

199 
°©e
.
ﬁde°Ch≠ãr
);

200 
ödex
->
œ°Checkpoöt
 = 
	`m≠ToVútuÆCh≠ãrNumbî
(
geomëry
,

201 
°©e
.
√we°Ch≠ãr
,

202 
°©e
.
œ°Checkpoöt
);

203 
ödex
->
id
 = 
	`m≠ToVútuÆCh≠ãrNumbî
(
geomëry
,

204 
°©e
.
√we°Ch≠ãr
,

205 
°©e
.
id
);

207  
UDS_SUCCESS
;

208 
	}
}

218 
	$ªadIndexSèãD©a
(
Comp⁄ítP‹èl
 *
p‹èl
)

220 
Buf„ªdRódî
 *
ªadî
 = 
NULL
;

221 
ªsu…
 = 
	`gëBuf„ªdRódî
(
p‹èl
, 0, &
ªadî
);

222 i‡(
ªsu…
 !
UDS_SUCCESS
) {

223  
ªsu…
;

226 
IndexSèãVîsi⁄
 
fûeVîsi⁄
;

227 
ªsu…
 = 
	`ªadFromBuf„ªdRódî
(
ªadî
, &
fûeVîsi⁄
,

228 (
IndexSèãVîsi⁄
));

229 i‡(
ªsu…
 !
UDS_SUCCESS
) {

230  
ªsu…
;

233 
Index
 *
ödex
 = 
	`comp⁄ítD©aF‹P‹èl
(
p‹èl
);

235 i‡(
fûeVîsi⁄
.
sig«tuª
 == -1) {

236 
i
 = 0; 
SUPPORTED_STATES
[i] !
NULL
; i++) {

237 i‡(
fûeVîsi⁄
.
vîsi⁄ID
 =
SUPPORTED_STATES
[
i
]->
vîsi⁄
->versionID) {

238  
SUPPORTED_STATES
[
i
]->
	`ªadî
(
ªadî
, 
ödex
);

243  
	`logEº‹WôhSåögEº‹
(
UDS_UNSUPPORTED_VERSION
,

245 
fûeVîsi⁄
.
sig«tuª
,

246 
fûeVîsi⁄
.
vîsi⁄ID
);

247 
	}
}

258 
	$wrôeIndexSèãD©a
(
IndexComp⁄ít
 *
comp⁄ít
,

259 
Buf„ªdWrôî
 *
wrôî
,

260 
z⁄e
)

262 
ªsu…
 = 
	`ASSERT
((
z⁄e
 == 0), "unimplemented zone %d", zone);

263 i‡(
ªsu…
 !
UDS_SUCCESS
) {

264  
ªsu…
;

267 
ªsu…
 = 
	`wrôeToBuf„ªdWrôî
(
wrôî
, 
CURRENT_INDEX_STATE
->
vîsi⁄
,

268 (
IndexSèãVîsi⁄
));

269 i‡(
ªsu…
 !
UDS_SUCCESS
) {

270  
ªsu…
;

273 
Index
 *
ödex
 = 
	`ödexComp⁄ítD©a
(
comp⁄ít
);

274  
CURRENT_INDEX_STATE
->
	`wrôî
(
wrôî
, 
ödex
);

275 
	}
}

	@uds/indexStateData.h

22 #i‚de‡
INDEX_STATE_DATA_H


23 
	#INDEX_STATE_DATA_H
 1

	)

25 
	~"ödexComp⁄ít.h
"

27 c⁄° 
IndexComp⁄ítInfo
 
INDEX_STATE_INFO
;

	@uds/indexStateInternals.h

22 #i‚de‡
INDEX_STATE_INTERNALS_H


23 
	#INDEX_STATE_INTERNALS_H


	)

25 
	~"ödexSèã.h
"

28 
	mDT_DISCARD_LATEST
,

29 
	mDT_DISCARD_ALL
,

30 } 
	tDisˇrdTy≥
;

32 
	södexSèãOps
 {

33 (*
	m‰ìFunc
)(
	mIndexSèã
 *);

34 (*
	maddComp⁄ít
)(
	mIndexSèã
 *, c⁄° 
	mIndexComp⁄ítInfo
 *, *,

36 (*
	mlﬂdSèã
)(
	mIndexSèã
 *, 
	mboﬁ
 *);

37 (*
	mßveSèã
)(
	mIndexSèã
 *);

38 (*
	m¥ï¨eSave
)(
	mIndexSèã
 *, 
	mIndexSaveTy≥
);

39 (*
	mcommôSave
)(
	mIndexSèã
 *);

40 (*
	m˛ónupSave
)(
	mIndexSèã
 *);

41 (*
	mwrôeCheckpoöt
)(
	mIndexSèã
 *);

42 (*
	mwrôeSögÀComp⁄ít
)(
	mIndexSèã
 *, 
	mIndexComp⁄ít
 *);

43 (*
	mdisˇrdSaves
)(
	mIndexSèã
 *, 
	mDisˇrdTy≥
);

57 
	$öôIndexSèã
(
IndexSèã
 *
°©e
,

58 
id
,

59 
z⁄eCou¡
,

60 
Àngth
,

61 c⁄° 
IndexSèãOps
 *
›s
)

62 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

69 
	`de°royIndexSèã
(
IndexSèã
 *
°©e
);

79 
	$addComp⁄ítToIndexSèã
(
IndexSèã
 *
°©e
,

80 
IndexComp⁄ít
 *
comp⁄ít
)

81 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

91 
	$gíîicLﬂdIndexSèã
(
IndexSèã
 *
°©e
,

92 
boﬁ
 *
ª∂ayPå
)

93 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

102 
	$gíîicSaveIndexSèã
(
IndexSèã
 *
°©e
)

103 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

113 
	$gíîicWrôeIndexSèãCheckpoöt
(
IndexSèã
 *
°©e
)

114 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

123 c⁄° *
	`ödexSaveTy≥Name
(
IndexSaveTy≥
 
ßveTy≥
);

	@uds/indexZone.c

22 
	~"ödexZ⁄e.h
"

24 
	~"îr‹s.h
"

25 
	~"ödex.h
"

26 
	~"ödexCheckpoöt.h
"

27 
	~"ödexRouãr.h
"

28 
	~"loggî.h
"

29 
	~"mem‹yAŒoc.h
"

30 
	~"≥rmas£π.h
"

31 
	~"ªque°.h
"

32 
	~"•¨£Cache.h
"

33 
	~"uds.h
"

36 
	$makeIndexZ⁄e
(
ödex
 *ödex, 
z⁄eNumbî
, 
boﬁ
 
ªadO∆y
)

38 
IndexZ⁄e
 *
z⁄e
;

39 
ªsu…
 = 
	`ALLOCATE
(1, 
IndexZ⁄e
, "ödex z⁄e", &
z⁄e
);

40 i‡(
ªsu…
 !
UDS_SUCCESS
) {

41  
ªsu…
;

44 
ªsu…
 = 
	`makeO≥nCh≠ãr
(
ödex
->
vﬁume
->
geomëry
, index->
z⁄eCou¡
,

45 &
z⁄e
->
›íCh≠ãr
);

46 i‡(
ªsu…
 !
UDS_SUCCESS
) {

47 
	`‰ìIndexZ⁄e
(
z⁄e
);

48  
ªsu…
;

51 i‡(!
ªadO∆y
) {

52 
ªsu…
 = 
	`makeO≥nCh≠ãr
(
ödex
->
vﬁume
->
geomëry
, index->
z⁄eCou¡
,

53 &
z⁄e
->
wrôögCh≠ãr
);

54 i‡(
ªsu…
 !
UDS_SUCCESS
) {

55 
	`‰ìIndexZ⁄e
(
z⁄e
);

56  
ªsu…
;

60 
z⁄e
->
ödex
 = index;

61 
z⁄e
->
id
 = 
z⁄eNumbî
;

62 
ödex
->
z⁄es
[
z⁄eNumbî
] = 
z⁄e
;

64  
UDS_SUCCESS
;

65 
	}
}

68 
	$‰ìIndexZ⁄e
(
IndexZ⁄e
 *
z⁄e
)

70 i‡(
z⁄e
 =
NULL
) {

74 
	`‰ìO≥nCh≠ãr
(
z⁄e
->
›íCh≠ãr
);

75 
	`‰ìO≥nCh≠ãr
(
z⁄e
->
wrôögCh≠ãr
);

76 
	`FREE
(
z⁄e
);

77 
	}
}

80 
boﬁ
 
	$isZ⁄eCh≠ãrS∑r£
(c⁄° 
IndexZ⁄e
 *
z⁄e
,

81 
uöt64_t
 
vútuÆCh≠ãr
)

83  
	`isCh≠ãrS∑r£
(
z⁄e
->
ödex
->
vﬁume
->
geomëry
,

84 
z⁄e
->
ﬁde°VútuÆCh≠ãr
,

85 
z⁄e
->
√we°VútuÆCh≠ãr
,

86 
vútuÆCh≠ãr
);

87 
	}
}

90 
	$£tA˘iveCh≠ãrs
(
IndexZ⁄e
 *
z⁄e
)

92 
z⁄e
->
ﬁde°VútuÆCh≠ãr
 = z⁄e->
ödex
->oldestVirtualChapter;

93 
z⁄e
->
√we°VútuÆCh≠ãr
 = z⁄e->
ödex
->newestVirtualChapter;

94 
	}
}

104 
	$sw≠O≥nCh≠ãr
(
IndexZ⁄e
 *
z⁄e
)

107 
ªsu…
 = 
	`föishPªviousCh≠ãr
(
z⁄e
->
ödex
->
ch≠ãrWrôî
,

108 
z⁄e
->
√we°VútuÆCh≠ãr
);

109 i‡(
ªsu…
 !
UDS_SUCCESS
) {

110  
ªsu…
;

114 
O≥nCh≠ãrZ⁄e
 *
ãmpCh≠ãr
 = 
z⁄e
->
›íCh≠ãr
;

115 
z⁄e
->
›íCh≠ãr
 = z⁄e->
wrôögCh≠ãr
;

116 
z⁄e
->
wrôögCh≠ãr
 = 
ãmpCh≠ãr
;

117  
UDS_SUCCESS
;

118 
	}
}

128 
	$ª≠Olde°Ch≠ãr
(
IndexZ⁄e
 *
z⁄e
)

130 
Index
 *
ödex
 = 
z⁄e
->index;

131 
ch≠ãrsPîVﬁume
 = 
ödex
->
vﬁume
->
geomëry
->chaptersPerVolume;

132 
ªsu…


133 
	`ASSERT
(((
z⁄e
->
√we°VútuÆCh≠ãr
 - z⁄e->
ﬁde°VútuÆCh≠ãr
)

134 <
ch≠ãrsPîVﬁume
),

135 "√we° (%" 
PRIu64
 ")ánd oldest (%" PRIu64 ") virtual chapters "

137 
z⁄e
->
√we°VútuÆCh≠ãr
, z⁄e->
ﬁde°VútuÆCh≠ãr
,

138 
ch≠ãrsPîVﬁume
);

139 i‡(
ªsu…
 !
UDS_SUCCESS
) {

140  
ªsu…
;

143 
	`£tMa°îIndexZ⁄eO≥nCh≠ãr
(
ödex
->
ma°îIndex
, 
z⁄e
->
id
,

144 
z⁄e
->
√we°VútuÆCh≠ãr
);

145  
UDS_SUCCESS
;

146 
	}
}

149 
	$execuãS∑r£CacheB¨rõrMesßge
(
IndexZ⁄e
 *
z⁄e
,

150 
B¨rõrMesßgeD©a
 *
b¨rõr
)

157  
	`upd©eS∑r£Cache
(
z⁄e
->
ödex
->
vﬁume
->
•¨£Cache
,

158 
b¨rõr
->
vútuÆCh≠ãr
,

159 
z⁄e
->
ödex
,

160 
z⁄e
->
id
);

161 
	}
}

173 
	$h™dÀCh≠ãrClo£d
(
IndexZ⁄e
 *
z⁄e
,

174 
Ch≠ãrClo£dMesßgeD©a
 *
ch≠ãrClo£d
)

176 i‡(
z⁄e
->
√we°VútuÆCh≠ãr
 =
ch≠ãrClo£d
->
vútuÆCh≠ãr
) {

177  
	`›íNextCh≠ãr
(
z⁄e
, 
NULL
);

180  
UDS_SUCCESS
;

181 
	}
}

184 
	$di•©chIndexZ⁄eC⁄åﬁReque°
(
Reque°
 *
ªque°
)

186 
Z⁄eMesßge
 *
mesßge
 = &
ªque°
->
z⁄eMesßge
;

187 
IndexZ⁄e
 *
z⁄e
 = 
mesßge
->
ödex
->
z⁄es
[
ªque°
->
z⁄eNumbî
];

189 
ªque°
->
a˘i⁄
) {

190 
REQUEST_SPARSE_CACHE_BARRIER
:

191  
	`execuãS∑r£CacheB¨rõrMesßge
(
z⁄e
, &
mesßge
->
d©a
.
b¨rõr
);

193 
REQUEST_ANNOUNCE_CHAPTER_CLOSED
:

194  
	`h™dÀCh≠ãrClo£d
(
z⁄e
, &
mesßge
->
d©a
.
ch≠ãrClo£d
);

197  
	`ASSERT_FALSE
("vÆid c⁄åﬁ mesßgêty≥: %d", 
ªque°
->
a˘i⁄
);

199 
	}
}

211 
	$™noun˚Ch≠ãrClo£d
(
Reque°
 *
ªque°
,

212 
IndexZ⁄e
 *
z⁄e
,

213 
uöt64_t
 
˛o£dCh≠ãr
)

215 
IndexRouãr
 *
rouãr
 = ((
ªque°
 !
NULL
) ?Ñequest->router : NULL);

217 
Z⁄eMesßge
 
z⁄eMesßge
 = {

218 .
ödex
 = 
z⁄e
->index,

219 .
d©a
 = {

220 .
ch≠ãrClo£d
 = { .
vútuÆCh≠ãr
 = 
˛o£dCh≠ãr
 }

224 
i
 = 0; i < 
z⁄e
->
ödex
->
z⁄eCou¡
; i++) {

225 i‡(
z⁄e
->
id
 =
i
) {

228 
ªsu…
;

229 i‡(
rouãr
 !
NULL
) {

230 
ªsu…
 = 
	`œunchZ⁄eC⁄åﬁMesßge
(
REQUEST_ANNOUNCE_CHAPTER_CLOSED
,

231 
z⁄eMesßge
, 
i
, 
rouãr
);

235 
ªsu…
 = 
	`h™dÀCh≠ãrClo£d
(
z⁄e
->
ödex
->
z⁄es
[
i
],

236 &
z⁄eMesßge
.
d©a
.
ch≠ãrClo£d
);

238 i‡(
ªsu…
 !
UDS_SUCCESS
) {

239  
ªsu…
;

243  
UDS_SUCCESS
;

244 
	}
}

247 
	$›íNextCh≠ãr
(
IndexZ⁄e
 *
z⁄e
, 
Reque°
 *
ªque°
)

249 
	`logDebug
("˛osög ch≠ã∏%" 
PRIu64
 " of zone %dáfter %uÉntries (%u short)",

250 
z⁄e
->
√we°VútuÆCh≠ãr
, z⁄e->
id
, z⁄e->
›íCh≠ãr
->
size
,

251 
z⁄e
->
›íCh≠ãr
->
ˇ∑côy
 - z⁄e->›íCh≠ãr->
size
);

253 
ªsu…
 = 
	`sw≠O≥nCh≠ãr
(
z⁄e
);

254 i‡(
ªsu…
 !
UDS_SUCCESS
) {

255  
ªsu…
;

258 
uöt64_t
 
˛o£dCh≠ãr
 = 
z⁄e
->
√we°VútuÆCh≠ãr
++;

259 
ªsu…
 = 
	`ª≠Olde°Ch≠ãr
(
z⁄e
);

260 i‡(
ªsu…
 !
UDS_SUCCESS
) {

261  
	`logUƒecovîabÀ
(
ªsu…
,

263 
z⁄e
->
ödex
->
id
);

266 
	`ª£tO≥nCh≠ãr
(
z⁄e
->
›íCh≠ãr
);

271 
ªsu…
 = 
	`¥o˚ssCheckpoötög
(
z⁄e
->
ödex
,

272 
z⁄e
->
id
,

273 
z⁄e
->
√we°VútuÆCh≠ãr
);

274 i‡(
ªsu…
 !
UDS_SUCCESS
) {

275  
ªsu…
;

278 
föishedZ⁄es
 = 
	`°¨tClosögCh≠ãr
(
z⁄e
->
ödex
->
ch≠ãrWrôî
,

279 
z⁄e
->
id
,

280 
z⁄e
->
wrôögCh≠ãr
);

281 i‡((
föishedZ⁄es
 =1Ë&& (
z⁄e
->
ödex
->
z⁄eCou¡
 > 1)) {

284 
ªsu…
 = 
	`™noun˚Ch≠ãrClo£d
(
ªque°
, 
z⁄e
, 
˛o£dCh≠ãr
);

285 i‡(
ªsu…
 !
UDS_SUCCESS
) {

286  
ªsu…
;

292 i‡(!
	`¨eSamePhysiˇlCh≠ãr
(
z⁄e
->
ödex
->
vﬁume
->
geomëry
,

293 
z⁄e
->
√we°VútuÆCh≠ãr
,

294 
z⁄e
->
ﬁde°VútuÆCh≠ãr
)) {

295  
UDS_SUCCESS
;

298 
uöt64_t
 
vi˘im
 = 
z⁄e
->
ﬁde°VútuÆCh≠ãr
++;

299 i‡(
föishedZ⁄es
 < 
z⁄e
->
ödex
->
z⁄eCou¡
) {

301  
UDS_SUCCESS
;

311  
	`f‹gëCh≠ãr
(
z⁄e
->
ödex
->
vﬁume
, 
vi˘im
, 
INVALIDATION_EXPIRE
);

312 
	}
}

315 
IndexRegi⁄
 
	$compuãIndexRegi⁄
(c⁄° 
IndexZ⁄e
 *
z⁄e
,

316 
uöt64_t
 
vútuÆCh≠ãr
)

318 i‡(
vútuÆCh≠ãr
 =
z⁄e
->
√we°VútuÆCh≠ãr
) {

319  
LOC_IN_OPEN_CHAPTER
;

321  (
	`isZ⁄eCh≠ãrS∑r£
(
z⁄e
, 
vútuÆCh≠ãr
)

322 ? 
LOC_IN_SPARSE
 : 
LOC_IN_DENSE
);

323 
	}
}

326 
	$gëRec‹dFromZ⁄e
(
IndexZ⁄e
 *
z⁄e
,

327 
Reque°
 *
ªque°
,

328 
boﬁ
 *
found
,

329 
uöt64_t
 
vútuÆCh≠ãr
)

331 i‡(
vútuÆCh≠ãr
 =
z⁄e
->
√we°VútuÆCh≠ãr
) {

332 
	`£¨chO≥nCh≠ãr
(
z⁄e
->
›íCh≠ãr
, &
ªque°
->
hash
,

333 &
ªque°
->
ﬁdMëad©a
, 
found
);

334  
UDS_SUCCESS
;

337 i‡((
z⁄e
->
√we°VútuÆCh≠ãr
 > 0)

338 && (
vútuÆCh≠ãr
 =(
z⁄e
->
√we°VútuÆCh≠ãr
 - 1))

339 && (
z⁄e
->
wrôögCh≠ãr
->
size
 > 0)) {

341 
	`£¨chO≥nCh≠ãr
(
z⁄e
->
wrôögCh≠ãr
, &
ªque°
->
hash
,

342 &
ªque°
->
ﬁdMëad©a
, 
found
);

343  
UDS_SUCCESS
;

346 
boﬁ
 
•¨£
 = 
	`isZ⁄eCh≠ãrS∑r£
(
z⁄e
, 
vútuÆCh≠ãr
);

347  
	`£¨chVﬁume
(
z⁄e
->
ödex
->
vﬁume
, 
ªque°
, &ªque°->
hash
,

348 
vútuÆCh≠ãr
, 
•¨£
, &
ªque°
->
ﬁdMëad©a
, 
found
);

349 
	}
}

352 
	$putRec‹dInZ⁄e
(
IndexZ⁄e
 *
z⁄e
,

353 
Reque°
 *
ªque°
,

354 c⁄° 
UdsChunkD©a
 *
mëad©a
)

356 
ªmaöög
;

357 
ªsu…
 = 
	`putO≥nCh≠ãr
(
z⁄e
->
›íCh≠ãr
, &
ªque°
->
hash
, 
mëad©a
,

358 &
ªmaöög
);

359 i‡(
ªsu…
 !
UDS_SUCCESS
) {

360  
ªsu…
;

363 i‡(
ªmaöög
 == 0) {

364  
	`›íNextCh≠ãr
(
z⁄e
, 
ªque°
);

367  
UDS_SUCCESS
;

368 
	}
}

	@uds/indexZone.h

22 #i‚de‡
INDEX_ZONE_H


23 
	#INDEX_ZONE_H


	)

25 
	~"comm⁄.h
"

26 
	~"›íCh≠ãrZ⁄e.h
"

27 
	~"ªque°.h
"

30 
ödex
 *
	mödex
;

31 
O≥nCh≠ãrZ⁄e
 *
	m›íCh≠ãr
;

32 
O≥nCh≠ãrZ⁄e
 *
	mwrôögCh≠ãr
;

33 
uöt64_t
 
	mﬁde°VútuÆCh≠ãr
;

34 
uöt64_t
 
	m√we°VútuÆCh≠ãr
;

35 
	mid
;

36 } 
	tIndexZ⁄e
;

47 
	$makeIndexZ⁄e
(
ödex
 *ödex, 
z⁄eNumbî
, 
boﬁ
 
ªadO∆y
)

48 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

57 
	`‰ìIndexZ⁄e
(
IndexZ⁄e
 *
z⁄e
);

68 
boﬁ
 
	$isZ⁄eCh≠ãrS∑r£
(c⁄° 
IndexZ⁄e
 *
z⁄e
,

69 
uöt64_t
 
vútuÆCh≠ãr
)

70 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

79 
	`£tA˘iveCh≠ãrs
(
IndexZ⁄e
 *
z⁄e
);

88 
	$di•©chIndexZ⁄eC⁄åﬁReque°
(
Reque°
 *
ªque°
)

89 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

102 
	$execuãS∑r£CacheB¨rõrMesßge
(
IndexZ⁄e
 *
z⁄e
,

103 
B¨rõrMesßgeD©a
 *
b¨rõr
)

104 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

115 
	$›íNextCh≠ãr
(
IndexZ⁄e
 *
z⁄e
, 
Reque°
 *
ªque°
)

116 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

126 
IndexRegi⁄
 
	`compuãIndexRegi⁄
(c⁄° 
IndexZ⁄e
 *
z⁄e
,

127 
uöt64_t
 
vútuÆCh≠ãr
);

140 
	$gëRec‹dFromZ⁄e
(
IndexZ⁄e
 *
z⁄e
,

141 
Reque°
 *
ªque°
,

142 
boﬁ
 *
found
,

143 
uöt64_t
 
vútuÆCh≠ãr
)

144 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

156 
	$putRec‹dInZ⁄e
(
IndexZ⁄e
 *
z⁄e
,

157 
Reque°
 *
ªque°
,

158 c⁄° 
UdsChunkD©a
 *
mëad©a
)

159 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

	@uds/ioRegion.c

22 
	~"ioRegi⁄.h
"

24 
	~"loggî.h
"

27 
	$syncAndClo£Regi⁄
(
IORegi⁄
 **
ªgi⁄På
, c⁄° *
ÁûuªMsg
)

29 i‡(*
ªgi⁄På
 =
NULL
) {

30  
UDS_SUCCESS
;

32 
ªsu…
 = 
	`syncRegi⁄C⁄ã¡s
(*
ªgi⁄På
);

33 
ªsu…2
 = 
	`˛o£IORegi⁄
(
ªgi⁄På
);

34 i‡((
ªsu…
 !
UDS_SUCCESS
Ë&& (ªsu… !
UDS_UNSUPPORTED
)) {

35  
	`logEº‹WôhSåögEº‹
(
ªsu…
, "%s%scannot sync IORegion",

36 
ÁûuªMsg
 =
NULL
 ? "" : failureMsg,

37 
ÁûuªMsg
 =
NULL
 ? "" : ": ");

39 i‡(
ªsu…2
 !
UDS_SUCCESS
) {

40  
	`logEº‹WôhSåögEº‹
(
ªsu…2
, "%s%scannot close IORegion",

41 
ÁûuªMsg
 =
NULL
 ? "" : failureMsg,

42 
ÁûuªMsg
 =
NULL
 ? "" : ": ");

44  
UDS_SUCCESS
;

45 
	}
}

	@uds/ioRegion.h

22 #i‚de‡
IO_REGION_H


23 
	#IO_REGION_H


	)

25 
	~"ty≥Defs.h
"

35 
ioRegi⁄
 
	tIORegi⁄
;

44 
˛o£IORegi⁄
(
IORegi⁄
 **
ªgi⁄På
);

56 
	$gëRegi⁄Limô
(
IORegi⁄
 *
ªgi⁄
,

57 
off_t
 *
limô
)

58 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

70 
	$gëRegi⁄D©aSize
(
IORegi⁄
 *
ªgi⁄
,

71 
off_t
 *
exã¡
)

72 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

81 
	$˛órRegi⁄
(
IORegi⁄
 *
ªgi⁄
)

82 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

103 
	$wrôeToRegi⁄
(
IORegi⁄
 *
ªgi⁄
,

104 
off_t
 
off£t
,

105 c⁄° *
d©a
,

106 
size_t
 
size
,

107 
size_t
 
Àngth
)

108 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

131 
	$ªadFromRegi⁄
(
IORegi⁄
 *
ªgi⁄
,

132 
off_t
 
off£t
,

133 *
buf„r
,

134 
size_t
 
size
,

135 
size_t
 *
Àngth
)

136 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

148 
	$gëRegi⁄BlockSize
(
IORegi⁄
 *
ªgi⁄
,

149 
size_t
 *
blockSize
)

150 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

160 
	$gëRegi⁄Be°Buf„rSize
(
IORegi⁄
 *
ªgi⁄
,

161 
size_t
 *
buf„rSize
)

162 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

172 
	$syncRegi⁄C⁄ã¡s
(
IORegi⁄
 *
ªgi⁄
)

173 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

185 
	`syncAndClo£Regi⁄
(
IORegi⁄
 **
ªgi⁄På
, c⁄° *
ÁûuªMsg
);

189 
	#IO_REGION_INLINE


	)

190 
	~"ioRegi⁄I∆öe.h
"

191 #unde‡
IO_REGION_INLINE


	@uds/ioRegionInline.h

22 #i‚de‡
IO_REGION_INLINE_H


23 
	#IO_REGION_INLINE_H


	)

25 
	~"compûî.h
"

26 
	~"uds-îr‹.h
"

28 #i‚de‡
IO_REGION_INLINE


32 
	sioRegi⁄Ops
 {

33 (*
	m˛o£
Ë(
	mIORegi⁄
 *);

34 (*
	mgëLimô
Ë(
	mIORegi⁄
 *, 
	moff_t
 *);

35 (*
	mgëD©aSize
Ë(
	mIORegi⁄
 *, 
	moff_t
 *);

36 (*
	m˛ór
Ë(
	mIORegi⁄
 *);

37 (*
	mwrôe
Ë(
	mIORegi⁄
 *, 
	moff_t
, c⁄° *, 
	msize_t
, size_t);

38 (*
	mªad
Ë(
	mIORegi⁄
 *, 
	moff_t
, *, 
	msize_t
, size_t *);

39 (*
	mgëBlockSize
)(
	mIORegi⁄
 *, 
	msize_t
 *);

40 (*
	mgëBe°Size
Ë(
	mIORegi⁄
 *, 
	msize_t
 *);

41 (*
	msyncC⁄ã¡s
)(
	mIORegi⁄
 *);

42 } 
	tIORegi⁄Ops
;

44 
	sioRegi⁄
 {

45 c⁄° 
IORegi⁄Ops
 *
	m›s
;

49 
INLINE
 
	$˛o£IORegi⁄
(
IORegi⁄
 **
ªgi⁄På
)

51 
ªsu…
 = 
UDS_SUCCESS
;

52 i‡((
ªgi⁄På
 !
NULL
) && (*regionPtr != NULL)) {

53 
ªsu…
 = (*
ªgi⁄På
)->
›s
->
	`˛o£
(*regionPtr);

54 i‡(
ªsu…
 =
UDS_SUCCESS
) {

55 *
ªgi⁄På
 = 
NULL
;

58  
ªsu…
;

59 
	}
}

62 
INLINE
 
	$gëRegi⁄Limô
(
IORegi⁄
 *
ªgi⁄
,

63 
off_t
 *
limô
)

65  
ªgi⁄
->
›s
->
	`gëLimô
‘egi⁄, 
limô
);

66 
	}
}

69 
INLINE
 
	$gëRegi⁄D©aSize
(
IORegi⁄
 *
ªgi⁄
,

70 
off_t
 *
exã¡
)

72  
ªgi⁄
->
›s
->
	`gëD©aSize
‘egi⁄, 
exã¡
);

73 
	}
}

76 
INLINE
 
	$˛órRegi⁄
(
IORegi⁄
 *
ªgi⁄
)

78  
ªgi⁄
->
›s
->
	`˛ór
(region);

79 
	}
}

82 
INLINE
 
	$wrôeToRegi⁄
(
IORegi⁄
 *
ªgi⁄
,

83 
off_t
 
off£t
,

84 c⁄° *
d©a
,

85 
size_t
 
size
,

86 
size_t
 
Àngth
)

88  
ªgi⁄
->
›s
->
	`wrôe
‘egi⁄, 
off£t
, 
d©a
, 
size
, 
Àngth
);

89 
	}
}

92 
INLINE
 
	$ªadFromRegi⁄
(
IORegi⁄
 *
ªgi⁄
,

93 
off_t
 
off£t
,

94 *
buf„r
,

95 
size_t
 
size
,

96 
size_t
 *
Àngth
)

98  
ªgi⁄
->
›s
->
	`ªad
‘egi⁄, 
off£t
, 
buf„r
, 
size
, 
Àngth
);

99 
	}
}

102 
INLINE
 
	$gëRegi⁄BlockSize
(
IORegi⁄
 *
ªgi⁄
,

103 
size_t
 *
blockSize
)

105  
ªgi⁄
->
›s
->
	`gëBlockSize
‘egi⁄, 
blockSize
);

106 
	}
}

109 
INLINE
 
	$gëRegi⁄Be°Buf„rSize
(
IORegi⁄
 *
ªgi⁄
,

110 
size_t
 *
buf„rSize
)

112  
ªgi⁄
->
›s
->
	`gëBe°Size
‘egi⁄, 
buf„rSize
);

113 
	}
}

116 
INLINE
 
	$syncRegi⁄C⁄ã¡s
(
IORegi⁄
 *
ªgi⁄
)

118  
ªgi⁄
->
›s
->
	`syncC⁄ã¡s
(region);

119 
	}
}

	@uds/isCallbackThreadDefs.h

22 #i‚de‡
LINUX_KERNEL_IS_CALLBACK_THREAD_DEFS_H


23 
	#LINUX_KERNEL_IS_CALLBACK_THREAD_DEFS_H
 1

	)

25 
	~"compûî.h
"

26 
	~"ty≥Defs.h
"

29 
INLINE
 
	$¸óãCÆlbackThªad
()

31 
	}
}

34 
INLINE
 
	$dñëeCÆlbackThªad
()

36 
	}
}

39 
INLINE
 
boﬁ
 
	$isCÆlbackThªad
()

41  
Ál£
;

42 
	}
}

45 
INLINE
 
£tCÆlbackThªad
(c⁄° *
p
 
__©åibuã__
((
unu£d
)))

	@uds/layoutRegion.h

22 #i‚de‡
LAYOUT_REGION_H


23 
	#LAYOUT_REGION_H


	)

33 c⁄° 
uöt64_t
 
	gREGION_MAGIC
 = 0x416c6252676e3031;

35 
	sªgi⁄Hódî
 {

36 
uöt64_t
 
	mmagic
;

37 
uöt64_t
 
	mªgi⁄Blocks
;

38 
uöt16_t
 
	mty≥
;

39 
uöt16_t
 
	mvîsi⁄
;

40 
uöt16_t
 
	mnumRegi⁄s
;

41 
uöt16_t
 
	m∑ylﬂd
;

42 } 
	tRegi⁄Hódî
;

44 
	sœyoutRegi⁄
 {

45 
uöt64_t
 
	m°¨tBlock
;

46 
uöt64_t
 
	mnumBlocks
;

47 
uöt32_t
 
	mchecksum
;

48 
uöt16_t
 
	mköd
;

49 
uöt16_t
 
	mö°™˚
;

50 } 
	tLayoutRegi⁄
;

52 
	sªgi⁄TabÀ
 {

53 
Regi⁄Hódî
 
	mhódî
;

54 
LayoutRegi⁄
 
	mªgi⁄s
[];

55 } 
	tRegi⁄TabÀ
;

	@uds/linuxIORegion.c

22 
	~"löuxIORegi⁄.h
"

24 
	~<löux/bio.h
>

25 
	~<löux/fs.h
>

26 
	~<löux/mm.h
>

27 
	~<löux/èsk_io_accou¡ög_›s.h
>

28 
	~<löux/vîsi⁄.h
>

30 
	~"loggî.h
"

31 
	~"mem‹yAŒoc.h
"

32 
	~"numîic.h
"

33 
	~"timeUtûs.h
"

40 #i‡
LINUX_VERSION_CODE
 <
KERNEL_VERSION
(2,6,32)

41 
block_devi˚
 *
blkdev_gë_by_∑th
(c⁄° *
∑th
,

42 
fmode_t
 
mode
,

43 *
h
 
__©åibuã__
((
unu£d
)))

45 
block_devi˚
 *
	gbdev
 = 
lookup_bdev
(
∑th
);

46 i‡(
	gbdev
 =
NULL
) {

47  
bdev
;

49 
	gªsu…
 = 
blkdev_gë
(
bdev
, 
mode
);

50 i‡(
	gªsu…
 != 0) {

51  
NULL
;

53  
	gbdev
;

58 íum { 
	mBVEC_COUNT
 = 64 * 1024 / 
PAGE_SIZE
 };

60 íum { 
	mBLK_FMODE
 = 
FMODE_READ
 | 
FMODE_WRITE
 };

63 
com∂ëi⁄
 *
	mwaô
;

64 
	mªsu…
;

65 } 
	tLöuxIOCom∂ëi⁄
;

67 íum { 
	mSECTOR_SHIFT
 = 9 };

68 íum { 
	mSECTOR_SIZE
 = 1 << 
SECTOR_SHIFT
 };

71 
IORegi⁄
 
	mcomm⁄
;

72 
block_devi˚
 *
	mbdev
;

73 
uöt64_t
 
	msize
;

74 *
	mzîoBlock
;

75 } 
	tLöuxIORegi⁄
;

78 
INLINE
 
LöuxIORegi⁄
 *
	$asLöuxIORegi⁄
(
IORegi⁄
 *
ªgi⁄
)

80  
	`c⁄èöî_of
(
ªgi⁄
, 
LöuxIORegi⁄
, 
comm⁄
);

81 
	}
}

84 
	$li‹_˛o£
(
IORegi⁄
 *
ªgi⁄
)

86 
LöuxIORegi⁄
 *
li‹
 = 
	`asLöuxIORegi⁄
(
ªgi⁄
);

87 
	`blkdev_put
(
li‹
->
bdev
, 
BLK_FMODE
);

88 
	`FREE
(
li‹
->
zîoBlock
);

89 
	`FREE
(
li‹
);

90  
UDS_SUCCESS
;

91 
	}
}

94 
	$vÆid©eIO
(
LöuxIORegi⁄
 *
li‹
,

95 
off_t
 
off£t
,

96 *
buf„r
,

97 
size_t
 
size
,

98 
size_t
 *
Àngth
,

99 
boﬁ
 
wrôög
)

101 i‡(
	`off£t_ö_∑ge
(
buf„r
) != 0) {

103  
UDS_INCORRECT_ALIGNMENT
;

106 i‡(
off£t
 % 
SECTOR_SIZE
 != 0) {

107  
	`logEº‹WôhSåögEº‹
(
UDS_INCORRECT_ALIGNMENT
,

109 
off£t
, 
SECTOR_SIZE
);

112 i‡(
size
 % 
SECTOR_SIZE
 != 0) {

113  
	`logEº‹WôhSåögEº‹
(
UDS_BUFFER_ERROR
,

115 
size
, 
SECTOR_SIZE
);

118 i‡(*
Àngth
 > 
size
) {

119  
	`logEº‹WôhSåögEº‹
(
UDS_BUFFER_ERROR
,

121 *
Àngth
, 
size
);

124 i‡(
off£t
 > (
off_t
Ë
li‹
->
size
) {

125  
	`logEº‹WôhSåögEº‹
(
UDS_OUT_OF_RANGE
,

126 "off£à%zdÉx˚ed†limô o‡%" 
PRId64
,

127 
off£t
, 
li‹
->
size
);

130 i‡((
off£t
 =(
off_t
Ë
li‹
->
size
Ë&& (*
Àngth
 > 0)) {

131  
UDS_END_OF_FILE
;

134 i‡(!
wrôög
) {

135 *
Àngth
 = 
	`möSizeT
(
li‹
->
size
, 
off£t
 + size) - offset;

137 i‡((
off£t
 < 0Ë|| ((off£à+ *
Àngth
Ë> 
li‹
->
size
)) {

138  
	`logEº‹WôhSåögEº‹
(
UDS_OUT_OF_RANGE
,

139 "øngê%zd-%zdÇŸ i¿øngê0Åÿ%" 
PRIu64
,

140 
off£t
, off£à+ *
Àngth
, 
li‹
->
size
);

143  
UDS_SUCCESS
;

144 
	}
}

147 
	$li‹_gëLimô
(
IORegi⁄
 *
ªgi⁄
, 
off_t
 *
limô
)

149 
LöuxIORegi⁄
 *
li‹
 = 
	`asLöuxIORegi⁄
(
ªgi⁄
);

150 *
limô
 = 
li‹
->
size
;

151  
UDS_SUCCESS
;

152 
	}
}

155 
	$li‹_gëD©aSize
(
IORegi⁄
 *
ªgi⁄
, 
off_t
 *
exã¡
)

157 
LöuxIORegi⁄
 *
li‹
 = 
	`asLöuxIORegi⁄
(
ªgi⁄
);

158 *
exã¡
 = 
li‹
->
size
;

159  
UDS_SUCCESS
;

160 
	}
}

163 #i‡
LINUX_VERSION_CODE
 >
KERNEL_VERSION
(4,4,0)

164 
	$li‹_ídio
(
bio
 *bio)

166 
	$li‹_ídio
(
bio
 *bio, 
îr
)

169 
LöuxIOCom∂ëi⁄
 *
lioc
 = (LöuxIOCom∂ëi⁄ *)
bio
->
bi_¥iv©e
;

170 #i‡
LINUX_VERSION_CODE
 >
	`KERNEL_VERSION
(4,13,0)

171 
lioc
->
ªsu…
 = -
bio
->
bi_°©us
;

172 #ñi‡
LINUX_VERSION_CODE
 >
	`KERNEL_VERSION
(4,4,0)

173 
lioc
->
ªsu…
 = -
bio
->
bi_îr‹
;

175 
lioc
->
ªsu…
 = -
îr
;

177 
	`com∂ëe
(
lioc
->
waô
);

178 
	}
}

181 
	$li‹_bio_öô
(
bio
 *bio, 
LöuxIORegi⁄
 *
li‹
, 
off_t
 
off£t
)

183 #i‡
LINUX_VERSION_CODE
 > 
	`KERNEL_VERSION
(3,13,0)

184 
	`bio_ª£t
(
bio
);

185 
bio
->
bi_ôî
.
bi_£˘‹
 = 
off£t
 >> 
SECTOR_SHIFT
;

187 
bio
->
bi_idx
 = 0;

188 
bio
->
bi_√xt
 = 
NULL
;

189 
bio
->
bi_£˘‹
 = 
off£t
 >> 
SECTOR_SHIFT
;

190 
bio
->
bi_size
 = 0;

191 
bio
->
bi_v˙t
 = 0;

193 
bio
->
bi_bdev
 = 
li‹
->
bdev
;

194 
	}
}

197 
	$li‹_bio_submô
(
bio
 *bio, 
rw
)

199 
	`DECLARE_COMPLETION_ONSTACK
(
waô
);

200 
	`öô_com∂ëi⁄
(&
waô
);

201 
LöuxIOCom∂ëi⁄
 
lioc
 = { .
ªsu…
 = 
UDS_SUCCESS
, .
waô
 = &wait };

202 
bio
->
bi_íd_io
 = 
li‹_ídio
;

203 
bio
->
bi_¥iv©e
 = &
lioc
;

204 #i‡
LINUX_VERSION_CODE
 >
	`KERNEL_VERSION
(4,8,0)

205 
	`submô_bio
(
bio
);

207 
	`submô_bio
(
rw
, 
bio
);

209 
	`waô_f‹_com∂ëi⁄
(&
waô
);

210  
lioc
.
ªsu…
;

211 
	}
}

214 
	$li‹_io
(
LöuxIORegi⁄
 *
li‹
,

215 
off_t
 
off£t
,

216 
byã
 *
buf„r
,

217 
size_t
 
size
,

218 
rw
)

220 
bio
 *biÿ
	`bio_Æloc
(
GFP_KERNEL
, 
BVEC_COUNT
);

221 i‡(
	`IS_ERR
(
bio
)) {

222  
	`logEº‹WôhSåögEº‹
(
ENOMEM
, "cannotállocateá struct bio");

224 
	`li‹_bio_öô
(
bio
, 
li‹
, 
off£t
);

226 
ªsu…
 = 
UDS_SUCCESS
;

227 (
ªsu…
 =
UDS_SUCCESS
Ë&& (
size
 > 0)) {

228 
ioSize
 = 
size
 > 
PAGE_SIZE
 ? PAGE_SIZE : size;

229 
∑ge
 *∑gê(
	`is_vmÆloc_addr
(
buf„r
)

230 ? 
	`vmÆloc_to_∑ge
(
buf„r
)

231 : 
	`vút_to_∑ge
(
buf„r
));

232 i‡(
	`bio_add_∑ge
(
bio
, 
∑ge
, 
ioSize
, 0) == 0) {

234 
ªsu…
 = 
	`li‹_bio_submô
(
bio
, 
rw
);

236 
	`li‹_bio_öô
(
bio
, 
li‹
, 
off£t
);

238 
buf„r
 +
ioSize
;

239 
size
 -
ioSize
;

240 
off£t
 +
ioSize
;

243 i‡(
ªsu…
 =
UDS_SUCCESS
) {

245 
ªsu…
 = 
	`li‹_bio_submô
(
bio
, 
rw
);

247 
	`bio_put
(
bio
);

248  
ªsu…
;

249 
	}
}

252 
	$li‹_wrôe
(
IORegi⁄
 *
ªgi⁄
,

253 
off_t
 
off£t
,

254 c⁄° *
d©a
,

255 
size_t
 
size
,

256 
size_t
 
Àngth
)

258 uni⁄ { c⁄° *
d©a
; *
buf„r
; } 
dec⁄°
;

259 
dec⁄°
.
d©a
 = data;

260 *
buf„r
 = 
dec⁄°
.buffer;

261 
LöuxIORegi⁄
 *
li‹
 = 
	`asLöuxIORegi⁄
(
ªgi⁄
);

262 
ªsu…
 = 
	`vÆid©eIO
(
li‹
, 
off£t
, 
buf„r
, 
size
, &
Àngth
, 
åue
);

263 i‡(
ªsu…
 !
UDS_SUCCESS
) {

264  
ªsu…
;

266 
	`èsk_io_accou¡_wrôe
(
size
);

267  
	`li‹_io
(
li‹
, 
off£t
, 
buf„r
, 
size
, 
WRITE
);

268 
	}
}

271 
	$li‹_˛ór
(
IORegi⁄
 *
ªgi⁄
)

276 
LöuxIORegi⁄
 *
li‹
 = 
	`asLöuxIORegi⁄
(
ªgi⁄
);

277  
	`li‹_wrôe
(
ªgi⁄
, 0, 
li‹
->
zîoBlock
, 
SECTOR_SIZE
, SECTOR_SIZE);

278 
	}
}

281 
	$li‹_ªad
(
IORegi⁄
 *
ªgi⁄
,

282 
off_t
 
off£t
,

283 *
buf„r
,

284 
size_t
 
size
,

285 
size_t
 *
Àngth
)

287 
LöuxIORegi⁄
 *
li‹
 = 
	`asLöuxIORegi⁄
(
ªgi⁄
);

288 
size_t
 
Àn
 = (
Àngth
 =
NULL
Ë? 
size
 : *length;

289 
ªsu…
 = 
	`vÆid©eIO
(
li‹
, 
off£t
, 
buf„r
, 
size
, &
Àn
, 
Ál£
);

290 i‡(
ªsu…
 !
UDS_SUCCESS
) {

291  
ªsu…
;

294 
ªsu…
 = 
	`li‹_io
(
li‹
, 
off£t
, 
buf„r
, 
size
, 
READ
);

296 i‡((
Àngth
 !
NULL
Ë&& (
ªsu…
 =
UDS_SUCCESS
)) {

297 *
Àngth
 = 
size
;

299  
ªsu…
;

300 
	}
}

303 
	$li‹_gëBlockSize
(
IORegi⁄
 *
ªgi⁄
, 
size_t
 *
blockSize
)

305 *
blockSize
 = 
SECTOR_SIZE
;

306  
UDS_SUCCESS
;

307 
	}
}

310 
	$li‹_gëBe°Size
(
IORegi⁄
 *
ªgi⁄
, 
size_t
 *
buf„rSize
)

312 *
buf„rSize
 = 
PAGE_SIZE
;

313  
UDS_SUCCESS
;

314 
	}
}

317 
li‹_syncC⁄ã¡s
(
IORegi⁄
 *
ªgi⁄
 
__©åibuã__
((
unu£d
)))

319  
	gUDS_SUCCESS
;

324 c⁄° 
IORegi⁄Ops
 
	glöuxIORegi⁄Ops
 = {

325 .
˛o£
 = 
li‹_˛o£
,

326 .
	ggëLimô
 = 
li‹_gëLimô
,

327 .
	ggëD©aSize
 = 
li‹_gëD©aSize
,

328 .
	g˛ór
 = 
li‹_˛ór
,

329 .
	gwrôe
 = 
li‹_wrôe
,

330 .
	gªad
 = 
li‹_ªad
,

331 .
	ggëBlockSize
 = 
li‹_gëBlockSize
,

332 .
	ggëBe°Size
 = 
li‹_gëBe°Size
,

333 .
	gsyncC⁄ã¡s
 = 
li‹_syncC⁄ã¡s
,

337 
	$›íLöuxRegi⁄
(c⁄° *
∑th
, 
uöt64_t
 
size
, 
IORegi⁄
 **
ªgi⁄På
)

339 i‡(
size
 % 
SECTOR_SIZE
 != 0) {

340  
	`logEº‹WôhSåögEº‹
(
UDS_INVALID_ARGUMENT
,

344 
block_devi˚
 *
bdev
 = 
	`blkdev_gë_by_∑th
(
∑th
, 
BLK_FMODE
, 
NULL
);

345 i‡(
	`IS_ERR
(
bdev
)) {

346 
	`logEº‹WôhSåögEº‹
(-
	`PTR_ERR
(
bdev
), "%†i†nŸá block devi˚", 
∑th
);

347  
UDS_INVALID_ARGUMENT
;

350 
LöuxIORegi⁄
 *
li‹
 = 
NULL
;

351 
ªsu…
 = 
	`ALLOCATE
(1, 
LöuxIORegi⁄
, "Löux IOÑegi⁄", &
li‹
);

352 i‡(
ªsu…
 !
UDS_SUCCESS
) {

353 
	`blkdev_put
(
bdev
, 
BLK_FMODE
);

354  
ªsu…
;

357 
byã
 *
buf
;

358 
ªsu…
 = 
	`ALLOCATE_IO_ALIGNED
(
PAGE_SIZE
, 
byã
, "Löux zîÿblock", &
buf
);

359 i‡(
ªsu…
 !
UDS_SUCCESS
) {

360 
	`FREE
(
li‹
);

361 
	`blkdev_put
(
bdev
, 
BLK_FMODE
);

362  
ªsu…
;

364 
	`mem£t
(
buf
, 0, 
PAGE_SIZE
);

366 
li‹
->
comm⁄
.
›s
 = &
löuxIORegi⁄Ops
;

367 
li‹
->
bdev
 = bdev;

368 
li‹
->
size
 = size;

369 
li‹
->
zîoBlock
 = 
buf
;

370 *
ªgi⁄På
 = &
li‹
->
comm⁄
;

371  
UDS_SUCCESS
;

372 
	}
}

	@uds/linuxIORegion.h

22 #i‚de‡
LINUX_IO_REGION_H


23 
	#LINUX_IO_REGION_H


	)

25 
	~"ioRegi⁄.h
"

36 
	$›íLöuxRegi⁄
(c⁄° *
∑th
, 
uöt64_t
 
size
, 
IORegi⁄
 **
ªgi⁄På
)

37 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

	@uds/loadType.c

22 
	~"lﬂdTy≥.h
"

24 
	~"loggî.h
"

27 
	$logLﬂdTy≥
(
LﬂdTy≥
 
lﬂdTy≥
)

29 
lﬂdTy≥
) {

30 
LOAD_CREATE
:

31 
	`logNŸi˚
("CreatingÇew index.");

34 
LOAD_LOAD
:

35 
	`logNŸi˚
("Loading index from saved state.");

38 
LOAD_REBUILD
:

39 
	`logNŸi˚
("Loading index from saved stateándÑebuilding ifÇecessary.");

42 
LOAD_ATTACH
:

43 
	`logNŸi˚
("AttachingÅoáÑemote index.");

47 
	`logNŸi˚
("NoÜoad method specified.");

49 
	}
}

	@uds/loadType.h

22 #i‚de‡
LOAD_TYPE_H


23 
	#LOAD_TYPE_H


	)

31 
	mLOAD_UNDEFINED
 = 0,

32 
	mLOAD_CREATE
,

33 
	mLOAD_LOAD
,

34 
	mLOAD_REBUILD
,

35 
	mLOAD_ATTACH


36 } 
	tLﬂdTy≥
;

43 
logLﬂdTy≥
(
LﬂdTy≥
 
lﬂdTy≥
);

	@uds/localIndexRouter.c

22 
	~"loˇlIndexRouãr.h
"

24 
	~"compûî.h
"

25 
	~"c⁄ãxt.h
"

26 
	~"îr‹s.h
"

27 
	~"„©uªDefs.h
"

28 
	~"hashUtûs.h
"

29 
	~"ödex.h
"

30 
	~"ödexCheckpoöt.h
"

31 
	~"ödexC⁄fig.h
"

32 
	~"ödexRouãr.h
"

33 
	~"loˇlIndexRouãrPriv©e.h
"

34 
	~"loggî.h
"

35 
	~"mem‹yAŒoc.h
"

36 
	~"≥rmas£π.h
"

37 
	~"ªque°.h
"

38 
	~"ªque°Queue.h
"

39 
	~"thªads.h
"

40 
	~"timeUtûs.h
"

41 
	~"uds.h
"

42 
	~"z⁄e.h
"

45 
	sfûlD©a
 {

47 
Index
 *
	msubödex
;

49 
	m£ed
;

51 
	mªsu…
;

54 
ßveIndexRouãrSèã
(
IndexRouãr
 *
hódî
);

55 
‰ìLoˇlIndexRouãr
(
IndexRouãr
 *
hódî
);

56 
Reque°Queue
 *
£À˘IndexRouãrQueue
(
IndexRouãr
 *
hódî
,

57 
Reque°
 *
ªque°
,

58 
Reque°Sège
 
√xtSège
);

59 
execuãIndexRouãrReque°
(
IndexRouãr
 *
hódî
, 
Reque°
 *
ªque°
);

60 
gëRouãrSèti°ics
(
IndexRouãr
 *
hódî
,

61 
IndexRouãrSètCou¡îs
 *
cou¡îs
);

62 
£tCheckpoötFªquícy
(
IndexRouãr
 *
hódî
, 
‰equícy
);

64 c⁄° 
IndexRouãrMëhods
 
	gmëhods
 = {

65 .
ßveSèã
 = 
ßveIndexRouãrSèã
,

66 .
	g‰ì
 = 
‰ìLoˇlIndexRouãr
,

67 .
	g£À˘Queue
 = 
£À˘IndexRouãrQueue
,

68 .
	gexecuã
 = 
execuãIndexRouãrReque°
,

69 .
	ggëSèti°ics
 = 
gëRouãrSèti°ics
,

70 .
	g£tCheckpoötFªquícy
 = 
£tCheckpoötFªquícy
,

74 #i‡
HISTOGRAMS


75 
	~"hi°ogøm.h
"

77 
Hi°ogøm
 *
	gexecuãIndexRouãrReque°Hi°ogøm
 = 
NULL
;

78 c⁄° *
	gexecuãIndexRouãrReque°Hi°ogømName
 = 
NULL
;

80 
	$föishSîvi˚Hi°ogøm
()

82 
	`∂ŸHi°ogøm
(
execuãIndexRouãrReque°Hi°ogømName
,

83 
execuãIndexRouãrReque°Hi°ogøm
);

84 
	`‰ìHi°ogøm
(&
execuãIndexRouãrReque°Hi°ogøm
);

85 
	}
}

87 
	$doSîvi˚Hi°ogøm
(c⁄° *
«me
)

89 
execuãIndexRouãrReque°Hi°ogømName
 = 
«me
;

90 
execuãIndexRouãrReque°Hi°ogøm


91 
	`makeLog¨ôhmicHi°ogøm
("executeIndexRouterRequest duration", 6);

92 
	`©exô
(
föishSîvi˚Hi°ogøm
);

93 
	}
}

100 
INLINE
 
IndexRouãr
 *
	$asIndexRouãr
(
LoˇlIndexRouãr
 *
rouãr
)

102  &
rouãr
->
hódî
;

103 
	}
}

111 
	$execuãZ⁄eReque°
(
Reque°
 *
ªque°
)

113 
ªque°
->
rouãr
->
mëhods
->
	`execuã
(request->router,Ñequest);

114 
	}
}

124 
	$íqueueB¨rõrMesßges
(
LoˇlIndexRouãr
 *
rouãr
,

125 
Index
 *
ödex
,

126 
uöt64_t
 
vútuÆCh≠ãr
)

128 
Z⁄eMesßge
 
b¨rõr
 = {

129 .
ödex
 = index,

130 .
d©a
 = {

131 .
b¨rõr
 = {

132 .
vútuÆCh≠ãr
 = virtualChapter,

136 
z⁄e
 = 0; z⁄ê< 
rouãr
->
z⁄eCou¡
; zone++) {

137 
ªsu…
 = 
	`œunchZ⁄eC⁄åﬁMesßge
(
REQUEST_SPARSE_CACHE_BARRIER
,

138 
b¨rõr
, 
z⁄e
,

139 
	`asIndexRouãr
(
rouãr
));

140 
	`ASSERT_LOG_ONLY
((
ªsu…
 =
UDS_SUCCESS
), "barrier messageállocation");

142 
	}
}

153 
	$åügeReque°
(
Reque°
 *
ªque°
)

155 
LoˇlIndexRouãr
 *
rouãr
 = 
	`asLoˇlIndexRouãr
(
ªque°
->router);

156 
Index
 *
ödex
 = 
rouãr
->index;

159 
uöt64_t
 
•¨£VútuÆCh≠ãr
 = 
	`åügeIndexReque°
(
ödex
, 
ªque°
);

160 i‡(
•¨£VútuÆCh≠ãr
 !
UINT64_MAX
) {

162 
	`íqueueB¨rõrMesßges
(
rouãr
, 
ödex
, 
•¨£VútuÆCh≠ãr
);

165 
	`íqueueReque°
(
ªque°
, 
STAGE_INDEX
);

166 
	}
}

176 
	$öôülizeLoˇlIndexQueues
(
LoˇlIndexRouãr
 *
rouãr
,

177 c⁄° 
Geomëry
 *
geomëry
)

179 
ªsu…
 = 
	`ALLOCATE
(
rouãr
->
z⁄eCou¡
, 
Reque°Queue
 *,

180 "z⁄êqueuê¨øy", &
rouãr
->
z⁄eQueues
);

181 i‡(
ªsu…
 !
UDS_SUCCESS
) {

182  
ªsu…
;

185 
i
 = 0; i < 
rouãr
->
z⁄eCou¡
; i++) {

186 
ªsu…
 = 
	`makeReque°Queue
("z⁄eIndexW‹kî", &
execuãZ⁄eReque°
,

187 &
rouãr
->
z⁄eQueues
[
i
]);

188 i‡(
ªsu…
 !
UDS_SUCCESS
) {

189  
ªsu…
;

194 i‡((
rouãr
->
z⁄eCou¡
 > 1Ë&& 
	`isS∑r£
(
geomëry
)) {

195 
ªsu…
 = 
	`makeReque°Queue
("åügeW‹kî", &
åügeReque°
,

196 &
rouãr
->
åügeQueue
);

197 i‡(
ªsu…
 !
UDS_SUCCESS
) {

198  
ªsu…
;

202  
UDS_SUCCESS
;

203 
	}
}

210 
	$shutdownLoˇlIndexQueues
(
LoˇlIndexRouãr
 *
rouãr
)

212 
	`ªque°QueueFöish
(
rouãr
->
åügeQueue
);

213 
i
 = 0; i < 
rouãr
->
z⁄eCou¡
; i++) {

214 
	`ªque°QueueFöish
(
rouãr
->
z⁄eQueues
[
i
]);

216 
	`FREE
(
rouãr
->
z⁄eQueues
);

217 
	}
}

220 
INLINE
 
Reque°Queue
 *
	$gëZ⁄eQueue
(
LoˇlIndexRouãr
 *
rouãr
,

221 
z⁄eNumbî
)

223  
rouãr
->
z⁄eQueues
[
z⁄eNumbî
];

224 
	}
}

227 
	$makeLoˇlIndexRouãr
(
IndexLayout
 *
œyout
,

228 c⁄° 
C⁄figuøti⁄
 *
c⁄fig
,

229 
LﬂdTy≥
 
lﬂdTy≥
,

230 
IndexRouãrCÆlback
 
ˇŒback
,

231 
IndexRouãr
 **
√wRouãr
)

233 
LoˇlIndexRouãr
 *
rouãr
;

234 
ªsu…
 = 
	`ALLOCATE_EXTENDED
(
LoˇlIndexRouãr
, 1, 
Index
 *,

235 "ödexÑouãr", &
rouãr
);

236 i‡(
ªsu…
 !
UDS_SUCCESS
) {

237  
ªsu…
;

240 
rouãr
->
hódî
.
ty≥
 = 
ROUTER_LOCAL
;

241 
rouãr
->
hódî
.
mëhods
 = &methods;

242 
rouãr
->
hódî
.
ˇŒback
 = callback;

243 
rouãr
->
z⁄eCou¡
 = 
	`gëZ⁄eCou¡
();

245 
ªsu…
 = 
	`öôülizeLoˇlIndexQueues
(
rouãr
, 
c⁄fig
->
geomëry
);

246 i‡(
ªsu…
 !
UDS_SUCCESS
) {

247 
	`‰ìIndexRouãr
(
	`asIndexRouãr
(
rouãr
));

248  
ªsu…
;

251 
ªsu…
 = 
	`makeIndex
(
œyout
, 
c⁄fig
, 0, 
rouãr
->
z⁄eCou¡
, 
lﬂdTy≥
,

252 &
rouãr
->
ödex
);

253 i‡(
ªsu…
 !
UDS_SUCCESS
) {

254 
	`‰ìIndexRouãr
(
	`asIndexRouãr
(
rouãr
));

255  
	`logEº‹WôhSåögEº‹
(
ªsu…
, "failedÅo create index");

258 *
√wRouãr
 = 
	`asIndexRouãr
(
rouãr
);

259  
UDS_SUCCESS
;

260 
	}
}

263 
	$ßveIndexRouãrSèã
(
IndexRouãr
 *
hódî
)

265 
LoˇlIndexRouãr
 *
rouãr
 = 
	`asLoˇlIndexRouãr
(
hódî
);

266  
	`ßveIndex
(
rouãr
->
ödex
);

267 
	}
}

270 
	$‰ìLoˇlIndexRouãr
(
IndexRouãr
 *
hódî
)

272 
LoˇlIndexRouãr
 *
rouãr
 = 
	`asLoˇlIndexRouãr
(
hódî
);

273 i‡(
rouãr
 =
NULL
) {

276 
	`shutdownLoˇlIndexQueues
(
rouãr
);

277 
	`‰ìIndex
(
rouãr
->
ödex
);

278 
	`FREE
(
rouãr
);

279 
	}
}

282 
Reque°Queue
 *
	$£À˘IndexRouãrQueue
(
IndexRouãr
 *
hódî
,

283 
Reque°
 *
ªque°
,

284 
Reque°Sège
 
√xtSège
)

286 
LoˇlIndexRouãr
 *
rouãr
 = 
	`asLoˇlIndexRouãr
(
hódî
);

288 i‡(
ªque°
->
isC⁄åﬁMesßge
) {

289  
	`gëZ⁄eQueue
(
rouãr
, 
ªque°
->
z⁄eNumbî
);

292 i‡(
√xtSège
 =
STAGE_TRIAGE
) {

295 i‡(
rouãr
->
åügeQueue
 !
NULL
) {

296  
rouãr
->
åügeQueue
;

299 } i‡(
√xtSège
 !
STAGE_INDEX
) {

300 
	`ASSERT_LOG_ONLY
(
Ál£
, "övÆid index sège: %d", 
√xtSège
);

301  
NULL
;

304 
Index
 *
ödex
 = 
rouãr
->index;

305 
ªque°
->
z⁄eNumbî
 = 
	`gëMa°îIndexZ⁄e
(
ödex
->
ma°îIndex
, &ªque°->
hash
);

306  
	`gëZ⁄eQueue
(
rouãr
, 
ªque°
->
z⁄eNumbî
);

307 
	}
}

310 
	$execuãIndexRouãrReque°
(
IndexRouãr
 *
hódî
, 
Reque°
 *
ªque°
)

312 
LoˇlIndexRouãr
 *
rouãr
 = 
	`asLoˇlIndexRouãr
(
hódî
);

314 i‡(
ªque°
->
isC⁄åﬁMesßge
) {

315 
ªsu…
 = 
	`di•©chIndexZ⁄eC⁄åﬁReque°
(
ªque°
);

316 i‡(
ªsu…
 !
UDS_SUCCESS
) {

317 
	`logEº‹WôhSåögEº‹
(
ªsu…
, "errorÉxecuting control message: %d",

318 
ªque°
->
a˘i⁄
);

320 
ªque°
->
°©us
 = 
ªsu…
;

321 
	`íãrCÆlbackSège
(
ªque°
);

325 i‡(
ªque°
->
ªqueued
 &&

326 (
ªque°
->
°©us
 !
UDS_SUCCESS
) &&

327 (
ªque°
->
°©us
 !
UDS_QUEUED
)) {

328 
ªque°
->
°©us
 = 
	`makeUƒecovîabÀ
(request->status);

329 
rouãr
->
hódî
.
	`ˇŒback
(
ªque°
);

333 #i‡
HISTOGRAMS


334 
AbsTime
 
°¨tTime
 = 
ABSTIME_EPOCH
;

335 i‡(
execuãIndexRouãrReque°Hi°ogøm
 !
NULL
) {

336 
°¨tTime
 = 
	`cuºítTime
(
CT_MONOTONIC
);

340 
Index
 *
ödex
 = 
rouãr
->index;

341 
ªsu…
 = 
	`di•©chIndexReque°
(
ödex
, 
ªque°
);

342 i‡(
ªsu…
 =
UDS_QUEUED
) {

347 
ªque°
->
°©us
 = 
ªsu…
;

348 
rouãr
->
hódî
.
	`ˇŒback
(
ªque°
);

350 #i‡
HISTOGRAMS


351 i‡(
execuãIndexRouãrReque°Hi°ogøm
 !
NULL
) {

352 
AbsTime
 
ídTime
 = 
	`cuºítTime
(
CT_MONOTONIC
);

353 
	`íãrHi°ogømSam∂e
(
execuãIndexRouãrReque°Hi°ogøm
,

354 
	`ªlTimeToMi¸o£c⁄ds
(
	`timeDif„ªn˚
(
ídTime
,

355 
°¨tTime
)));;

358 
	}
}

361 
	$gëRouãrSèti°ics
(
IndexRouãr
 *
hódî
,

362 
IndexRouãrSètCou¡îs
 *
cou¡îs
)

364 
LoˇlIndexRouãr
 *
rouãr
 = 
	`asLoˇlIndexRouãr
(
hódî
);

365 
IndexRouãrSètCou¡îs
 
ödexSèts
;

366 
	`gëIndexSèts
(
rouãr
->
ödex
, &
ödexSèts
);

367 
cou¡îs
->
íåõsIndexed
 = 
ödexSèts
.entriesIndexed;

368 
cou¡îs
->
mem‹yU£d
 = 
ödexSèts
.memoryUsed;

369 
cou¡îs
->
diskU£d
 = 
ödexSèts
.diskUsed;

370 
cou¡îs
->
numDli°s
 = 
ödexSèts
.numDlists;

371 
cou¡îs
->
cﬁlisi⁄s
 = 
ödexSèts
.collisions;

372 
cou¡îs
->
íåõsDisˇrded
 = 
ödexSèts
.entriesDiscarded;

373 
cou¡îs
->
checkpoöts
 = 
ödexSèts
.checkpoints;

374 
	`addCacheCou¡îs
(&
cou¡îs
->
vﬁumeCache
, 
ödexSèts
.volumeCache);

375  
UDS_SUCCESS
;

376 
	}
}

379 
	$£tCheckpoötFªquícy
(
IndexRouãr
 *
hódî
, 
‰equícy
)

381 
LoˇlIndexRouãr
 *
rouãr
 = 
	`asLoˇlIndexRouãr
(
hódî
);

382 
	`£tIndexCheckpoötFªquícy
(
rouãr
->
ödex
->
checkpoöt
, 
‰equícy
);

383 
	}
}

	@uds/localIndexRouter.h

22 #i‚de‡
LOCAL_INDEX_ROUTER_H


23 
	#LOCAL_INDEX_ROUTER_H


	)

25 
	~"c⁄fig.h
"

26 
	~"ödexLayout.h
"

27 
	~"ödexRouãr.h
"

28 
	~"lﬂdTy≥.h
"

29 
	~"ªque°.h
"

53 
	$makeLoˇlIndexRouãr
(
IndexLayout
 *
œyout
,

54 c⁄° 
C⁄figuøti⁄
 *
c⁄fig
,

55 
LﬂdTy≥
 
lﬂdTy≥
,

56 
IndexRouãrCÆlback
 
ˇŒback
,

57 
IndexRouãr
 **
√wRouãr
)

58 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

	@uds/localIndexRouterPrivate.h

22 #i‚de‡
LOCAL_INDEX_ROUTER_PRIVATE_H


23 
	#LOCAL_INDEX_ROUTER_PRIVATE_H


	)

25 
	~"compûî.h
"

26 
	~"ödex.h
"

31 
	sloˇlIndexRouãr
 {

32 
IndexRouãr
 
	mhódî
;

33 
	mz⁄eCou¡
;

34 
Reque°Queue
 **
	mz⁄eQueues
;

35 
Reque°Queue
 *
	måügeQueue
;

36 
Index
 *
	mödex
;

37 } 
	tLoˇlIndexRouãr
;

42 
INLINE
 
LoˇlIndexRouãr
 *
	$asLoˇlIndexRouãr
(
IndexRouãr
 *
hódî
)

44  
	`c⁄èöî_of
(
hódî
, 
LoˇlIndexRouãr
, header);

45 
	}
}

	@uds/logger.c

22 
	~"loggî.h
"

24 
	~"comm⁄.h
"

25 
	~"îr‹s.h
"

26 
	~"°rögUtûs.h
"

27 
	~"thªads.h
"

28 
	~"uds.h
"

31 c⁄° *
	m«me
;

32 c⁄° 
	m¥i‹ôy
;

33 } 
	tPri‹ôyName
;

35 c⁄° 
Pri‹ôyName
 
	gPRIORITIES
[] = {

36 { "ALERT", 
LOG_ALERT
 },

37 { "CRITICAL", 
LOG_CRIT
 },

38 { "CRIT", 
LOG_CRIT
 },

39 { "DEBUG", 
LOG_DEBUG
 },

40 { "EMERGENCY", 
LOG_EMERG
 },

41 { "EMERG", 
LOG_EMERG
 },

42 { "ERROR", 
LOG_ERR
 },

43 { "ERR", 
LOG_ERR
 },

44 { "INFO", 
LOG_INFO
 },

45 { "NOTICE", 
LOG_NOTICE
 },

46 { "PANIC", 
LOG_EMERG
 },

47 { "WARN", 
LOG_WARNING
 },

48 { "WARNING", 
LOG_WARNING
 },

49 { 
NULL
, -1 },

52 c⁄° *c⁄° 
	gPRIORITY_STRINGS
[] = {

63 
	glogLevñ
 = 
LOG_INFO
;

66 
	$gëLogLevñ
()

68  
logLevñ
;

69 
	}
}

72 
	$£tLogLevñ
(
√wLogLevñ
)

74 
logLevñ
 = 
√wLogLevñ
;

75 
	}
}

78 
	$°rögToPri‹ôy
(c⁄° *
°rög
)

80 
i
 = 0; 
PRIORITIES
[i].
«me
 !
NULL
; i++) {

81 i‡(
	`°rˇ£cmp
(
°rög
, 
PRIORITIES
[
i
].
«me
) == 0) {

82  
PRIORITIES
[
i
].
¥i‹ôy
;

85  
LOG_INFO
;

86 
	}
}

89 c⁄° *
	$¥i‹ôyToSåög
(
¥i‹ôy
)

91 i‡((
¥i‹ôy
 < 0Ë|| (¥i‹ôy >(Ë
	`COUNT_OF
(
PRIORITY_STRINGS
))) {

94  
PRIORITY_STRINGS
[
¥i‹ôy
];

95 
	}
}

98 
	$logEmbeddedMesßge
(
¥i‹ôy
,

99 c⁄° *
¥efix
,

100 c⁄° *
fmt1
,

101 
va_li°
 
¨gs1
,

102 c⁄° *
fmt2
,

105 
va_li°
 
≠
;

106 
	`va_°¨t
(
≠
, 
fmt2
);

107 
	`logMesßgePack
(
¥i‹ôy
, 
¥efix
, 
fmt1
, 
¨gs1
, 
fmt2
, 
≠
);

108 
	`va_íd
(
≠
);

109 
	}
}

112 
	$vLogMesßge
(
¥i‹ôy
, c⁄° *
f‹m©
, 
va_li°
 
¨gs
)

114 
va_li°
 
dummy
;

115 
	`logMesßgePack
(
¥i‹ôy
, 
NULL
, 
f‹m©
, 
¨gs
, NULL, 
dummy
);

116 
	}
}

119 
	$logMesßge
(
¥i‹ôy
, c⁄° *
f‹m©
, ...)

121 
va_li°
 
¨gs
;

123 
	`va_°¨t
(
¨gs
, 
f‹m©
);

124 
	`vLogMesßge
(
¥i‹ôy
, 
f‹m©
, 
¨gs
);

125 
	`va_íd
(
¨gs
);

126 
	}
}

129 
	$logDebug
(c⁄° *
f‹m©
, ...)

131 
va_li°
 
¨gs
;

133 
	`va_°¨t
(
¨gs
, 
f‹m©
);

134 
	`vLogMesßge
(
LOG_DEBUG
, 
f‹m©
, 
¨gs
);

135 
	`va_íd
(
¨gs
);

136 
	}
}

139 
	$logInfo
(c⁄° *
f‹m©
, ...)

141 
va_li°
 
¨gs
;

143 
	`va_°¨t
(
¨gs
, 
f‹m©
);

144 
	`vLogMesßge
(
LOG_INFO
, 
f‹m©
, 
¨gs
);

145 
	`va_íd
(
¨gs
);

146 
	}
}

149 
	$logNŸi˚
(c⁄° *
f‹m©
, ...)

151 
va_li°
 
¨gs
;

153 
	`va_°¨t
(
¨gs
, 
f‹m©
);

154 
	`vLogMesßge
(
LOG_NOTICE
, 
f‹m©
, 
¨gs
);

155 
	`va_íd
(
¨gs
);

156 
	}
}

159 
	$logW¨nög
(c⁄° *
f‹m©
, ...)

161 
va_li°
 
¨gs
;

163 
	`va_°¨t
(
¨gs
, 
f‹m©
);

164 
	`vLogMesßge
(
LOG_WARNING
, 
f‹m©
, 
¨gs
);

165 
	`va_íd
(
¨gs
);

166 
	}
}

169 
	$logEº‹
(c⁄° *
f‹m©
, ...)

171 
va_li°
 
¨gs
;

173 
	`va_°¨t
(
¨gs
, 
f‹m©
);

174 
	`vLogMesßge
(
LOG_ERR
, 
f‹m©
, 
¨gs
);

175 
	`va_íd
(
¨gs
);

176 
	}
}

179 
	$vLogWôhSåögEº‹
(
¥i‹ôy
,

180 
î∫um
,

181 c⁄° *
f‹m©
,

182 
va_li°
 
¨gs
)

184 
îrbuf
[
ERRBUF_SIZE
];

185 
	`logEmbeddedMesßge
(
¥i‹ôy
, 
NULL
, 
f‹m©
, 
¨gs
, ": %s (%d)",

186 
	`°rögEº‹
(
î∫um
, 
îrbuf
, (errbuf)),

187 
î∫um
);

188  
î∫um
;

189 
	}
}

192 
	$logWôhSåögEº‹
(
¥i‹ôy
, 
î∫um
, c⁄° *
f‹m©
, ...)

194 
va_li°
 
¨gs
;

196 
	`va_°¨t
(
¨gs
, 
f‹m©
);

197 
	`vLogWôhSåögEº‹
(
¥i‹ôy
, 
î∫um
, 
f‹m©
, 
¨gs
);

198 
	`va_íd
(
¨gs
);

199  
î∫um
;

200 
	}
}

203 
	$logEº‹WôhSåögEº‹
(
î∫um
, c⁄° *
f‹m©
, ...)

205 
va_li°
 
¨gs
;

207 
	`va_°¨t
(
¨gs
, 
f‹m©
);

208 
	`vLogWôhSåögEº‹
(
LOG_ERR
, 
î∫um
, 
f‹m©
, 
¨gs
);

209 
	`va_íd
(
¨gs
);

210  
î∫um
;

211 
	}
}

214 
	$logW¨nögWôhSåögEº‹
(
î∫um
, c⁄° *
f‹m©
, ...)

216 
va_li°
 
¨gs
;

218 
	`va_°¨t
(
¨gs
, 
f‹m©
);

219 
	`vLogWôhSåögEº‹
(
LOG_WARNING
, 
î∫um
, 
f‹m©
, 
¨gs
);

220 
	`va_íd
(
¨gs
);

221  
î∫um
;

222 
	}
}

225 
	$logDebugWôhSåögEº‹
(
î∫um
, c⁄° *
f‹m©
, ...)

227 
va_li°
 
¨gs
;

229 
	`va_°¨t
(
¨gs
, 
f‹m©
);

230 
	`vLogWôhSåögEº‹
(
LOG_DEBUG
, 
î∫um
, 
f‹m©
, 
¨gs
);

231 
	`va_íd
(
¨gs
);

232  
î∫um
;

233 
	}
}

236 
	$logInfoWôhSåögEº‹
(
î∫um
, c⁄° *
f‹m©
, ...)

238 
va_li°
 
¨gs
;

240 
	`va_°¨t
(
¨gs
, 
f‹m©
);

241 
	`vLogWôhSåögEº‹
(
LOG_INFO
, 
î∫um
, 
f‹m©
, 
¨gs
);

242 
	`va_íd
(
¨gs
);

243  
î∫um
;

244 
	}
}

247 
	$logNŸi˚WôhSåögEº‹
(
î∫um
, c⁄° *
f‹m©
, ...)

249 
va_li°
 
¨gs
;

251 
	`va_°¨t
(
¨gs
, 
f‹m©
);

252 
	`vLogWôhSåögEº‹
(
LOG_NOTICE
, 
î∫um
, 
f‹m©
, 
¨gs
);

253 
	`va_íd
(
¨gs
);

254  
î∫um
;

255 
	}
}

258 
	$logF©ÆWôhSåögEº‹
(
î∫um
, c⁄° *
f‹m©
, ...)

260 
va_li°
 
¨gs
;

262 
	`va_°¨t
(
¨gs
, 
f‹m©
);

263 
	`vLogWôhSåögEº‹
(
LOG_CRIT
, 
î∫um
, 
f‹m©
, 
¨gs
);

264 
	`va_íd
(
¨gs
);

265  
î∫um
;

266 
	}
}

269 
	$logUƒecovîabÀ
(
î∫um
, c⁄° *
f‹m©
, ...)

271 i‡((
î∫um
 =
UDS_SUCCESS
 ||Éºnum =
UDS_QUEUED
) || (errnum == 0)) {

272  
î∫um
;

274 
va_li°
 
¨gs
;

275 
	`va_°¨t
(
¨gs
, 
f‹m©
);

276 
	`vLogWôhSåögEº‹
(
LOG_CRIT
, 
î∫um
, 
f‹m©
, 
¨gs
);

277 
	`va_íd
(
¨gs
);

278  
	`makeUƒecovîabÀ
(
î∫um
);

279 
	}
}

282 
	$logF©Æ
(c⁄° *
f‹m©
, ...)

284 
va_li°
 
¨gs
;

286 
	`va_°¨t
(
¨gs
, 
f‹m©
);

287 
	`vLogMesßge
(
LOG_CRIT
, 
f‹m©
, 
¨gs
);

288 
	`va_íd
(
¨gs
);

289 
	}
}

	@uds/logger.h

22 #i‚de‡
LOGGER_H


23 
	#LOGGER_H
 1

	)

25 
	~<°d¨g.h
>

27 
	~"loggîDefs.h
"

45 
›íLoggî
();

50 
˛o£Loggî
();

57 
gëLogLevñ
();

64 
£tLogLevñ
(
√wLogLevñ
);

73 
°rögToPri‹ôy
(c⁄° *
°rög
);

80 c⁄° *
¥i‹ôyToSåög
(
¥i‹ôy
);

87 
	$logDebug
(c⁄° *
f‹m©
, ...Ë
	`__©åibuã__
((
	`f‹m©
(
¥ötf
, 1, 2)));

94 
	$logInfo
(c⁄° *
f‹m©
, ...Ë
	`__©åibuã__
((
	`f‹m©
(
¥ötf
, 1, 2)));

101 
	$logNŸi˚
(c⁄° *
f‹m©
, ...Ë
	`__©åibuã__
((
	`f‹m©
(
¥ötf
, 1, 2)));

108 
	$logW¨nög
(c⁄° *
f‹m©
, ...Ë
	`__©åibuã__
((
	`f‹m©
(
¥ötf
, 1, 2)));

115 
	$logEº‹
(c⁄° *
f‹m©
, ...Ë
	`__©åibuã__
((
	`f‹m©
(
¥ötf
, 1, 2)));

126 
	$logEmbeddedMesßge
(
¥i‹ôy
,

127 c⁄° *
¥efix
,

128 c⁄° *
fmt1
,

129 
va_li°
 
¨gs1
,

130 c⁄° *
fmt2
,

132 
	`__©åibuã__
((
	`f‹m©
(
¥ötf
, 3, 0), format(printf, 5, 6)));

144 
	$logMesßgePack
(
¥i‹ôy
,

145 c⁄° *
¥efix
,

146 c⁄° *
fmt1
,

147 
va_li°
 
¨gs1
,

148 c⁄° *
fmt2
,

149 
va_li°
 
¨gs2
)

150 
	`__©åibuã__
((
	`f‹m©
(
¥ötf
, 3, 0)));

157 
	`logBackåa˚
(
¥i‹ôy
);

168 
	$logWôhSåögEº‹
(
¥i‹ôy
, 
î∫um
, c⁄° *
f‹m©
, ...)

169 
	`__©åibuã__
((
	`f‹m©
(
¥ötf
, 3, 4)));

181 
	$vLogWôhSåögEº‹
(
¥i‹ôy
,

182 
î∫um
,

183 c⁄° *
f‹m©
,

184 
va_li°
 
¨gs
)

185 
	`__©åibuã__
((
	`f‹m©
(
¥ötf
, 3, 0)));

195 
	$logEº‹WôhSåögEº‹
(
î∫um
, c⁄° *
f‹m©
, ...)

196 
	`__©åibuã__
((
	`f‹m©
(
¥ötf
, 2, 3)));

199 
	$logDebugWôhSåögEº‹
(
î∫um
, c⁄° *
f‹m©
, ...)

200 
	`__©åibuã__
((
	`f‹m©
(
¥ötf
, 2, 3)));

203 
	$logInfoWôhSåögEº‹
(
î∫um
, c⁄° *
f‹m©
, ...)

204 
	`__©åibuã__
((
	`f‹m©
(
¥ötf
, 2, 3)));

207 
	$logNŸi˚WôhSåögEº‹
(
î∫um
, c⁄° *
f‹m©
, ...)

208 
	`__©åibuã__
((
	`f‹m©
(
¥ötf
, 2, 3)));

211 
	$logW¨nögWôhSåögEº‹
(
î∫um
, c⁄° *
f‹m©
, ...)

212 
	`__©åibuã__
((
	`f‹m©
(
¥ötf
, 2, 3)));

215 
	$logF©ÆWôhSåögEº‹
(
î∫um
, c⁄° *
f‹m©
, ...)

216 
	`__©åibuã__
((
	`f‹m©
(
¥ötf
, 2, 3)));

226 
	$logUƒecovîabÀ
(
î∫um
, c⁄° *
f‹m©
, ...)

227 
	`__©åibuã__
((
	`f‹m©
(
¥ötf
, 2, 3)));

234 
	$logF©Æ
(c⁄° *
f‹m©
, ...Ë
	`__©åibuã__
((
	`f‹m©
(
¥ötf
, 1, 2)));

243 
	$vLogMesßge
(
¥i‹ôy
, c⁄° *
f‹m©
, 
va_li°
 
¨gs
)

244 
	`__©åibuã__
((
	`f‹m©
(
¥ötf
, 2, 0)));

252 
	$logMesßge
(
¥i‹ôy
, c⁄° *
f‹m©
, ...)

253 
	`__©åibuã__
((
	`f‹m©
(
¥ötf
, 2, 3)));

262 
	`∑u£F‹Loggî
();

	@uds/loggerDefs.h

22 #i‚de‡
LINUX_KERNEL_LOGGER_DEFS_H


23 
	#LINUX_KERNEL_LOGGER_DEFS_H


	)

25 
	#LOG_EMERG
 0

	)

26 
	#LOG_ALERT
 1

	)

27 
	#LOG_CRIT
 2

	)

28 
	#LOG_ERR
 3

	)

29 
	#LOG_WARNING
 4

	)

30 
	#LOG_NOTICE
 5

	)

31 
	#LOG_INFO
 6

	)

32 
	#LOG_DEBUG
 7

	)

	@uds/loggerLinuxKernel.c

22 
	~<löux/dñay.h
>

23 
	~<löux/h¨dúq.h
>

24 
	~<löux/moduÀ.h
>

25 
	~<löux/sched.h
>

27 
	~"loggî.h
"

30 
	$›íLoggî
()

32 
	}
}

35 
	$˛o£Loggî
()

37 
	}
}

40 
	$logMesßgePack
(
¥i‹ôy
,

41 c⁄° *
¥efix
,

42 c⁄° *
fmt1
,

43 
va_li°
 
¨gs1
,

44 c⁄° *
fmt2
,

45 
va_li°
 
¨gs2
)

47 i‡(
¥i‹ôy
 > 
	`gëLogLevñ
()) {

50 
¥i‹ôy
) {

51 
LOG_EMERG
:

52 
LOG_ALERT
:

53 
LOG_CRIT
:

54 
	`¥ötk
(
KERN_CRIT
);

56 
LOG_ERR
:

57 
	`¥ötk
(
KERN_ERR
);

59 
LOG_WARNING
:

60 
	`¥ötk
(
KERN_WARNING
);

62 
LOG_NOTICE
:

63 
	`¥ötk
(
KERN_NOTICE
);

65 
LOG_INFO
:

66 
	`¥ötk
(
KERN_INFO
);

68 
LOG_DEBUG
:

69 
	`¥ötk
(
KERN_DEBUG
);

72 i‡(
	`ö_öãºu±
()) {

73 *
ty≥
 = "INTR";

74 i‡(
	`ö_nmi
()) {

75 
ty≥
 = "NMI";

76 } i‡(
	`ö_úq
()) {

77 
ty≥
 = "HI";

78 } i‡(
	`ö_so·úq
()) {

79 
ty≥
 = "SI";

81 
	`¥ötk
("%s[%s]: ", 
THIS_MODULE
->
«me
, 
ty≥
);

84 
	`¥ötk
("%s: %s: ", 
THIS_MODULE
->
«me
, 
cuºít
->
comm
);

86 i‡(
¥efix
 !
NULL
) {

87 
	`¥ötk
("%s", 
¥efix
);

89 i‡(
fmt1
 !
NULL
) {

90 
	`v¥ötk
(
fmt1
, 
¨gs1
);

92 i‡(
fmt2
 !
NULL
) {

93 
	`v¥ötk
(
fmt2
, 
¨gs2
);

95 
	`¥ötk
("\n");

96 
	}
}

99 
	$logBackåa˚
(
¥i‹ôy
)

101 i‡(
¥i‹ôy
 > 
	`gëLogLevñ
()) {

104 
	`logMesßge
(
¥i‹ôy
, "[backtrace]");

105 
	`dump_°ack
();

106 
	}
}

109 
	$∑u£F‹Loggî
()

113 
	`m¶ìp
(4);

114 
	}
}

	@uds/masterIndex005.c

21 
	~"ma°îIndex005.h
"

23 
	~"compûî.h
"

24 
	~"îr‹s.h
"

25 
	~"„©uªDefs.h
"

26 
	~"hashUtûs.h
"

27 
	~"loggî.h
"

28 
	~"mem‹yAŒoc.h
"

29 
	~"uds.h
"

30 
	~"z⁄e.h
"

57 
__©åibuã__
((
	tÆig√d
(
	tCACHE_LINE_BYTES
))Ë
	tma°îIndexZ⁄e
 {

58 
uöt64_t
 
vútuÆCh≠ãrLow
;

59 
uöt64_t
 
vútuÆCh≠ãrHigh
;

60 
numE¨lyFlushes
;

61 
	}
} 
	tMa°îIndexZ⁄e
;

64 
Ma°îIndex
 
	mcomm⁄
;

65 
DñèIndex
 
	mdñèIndex
;

66 
uöt64_t
 *
	mÊushCh≠ãrs
;

67 
Ma°îIndexZ⁄e
 *
	mma°îZ⁄es
;

68 
uöt64_t
 
	mvﬁumeN⁄˚
;

69 
uöt64_t
 
	mch≠ãrZ⁄eBôs
;

70 
uöt64_t
 
	mmaxZ⁄eBôs
;

71 
	maddªssBôs
;

72 
	maddªssMask
;

73 
	mch≠ãrBôs
;

74 
	mch≠ãrMask
;

75 
	mnumCh≠ãrs
;

76 
	mnumDñèLi°s
;

77 
	mnumZ⁄es
;

78 } 
	tMa°îIndex5
;

80 
	sch≠ãrR™ge
 {

81 
	mch≠ãrSèπ
;

82 
	mch≠ãrCou¡
;

83 } 
	tCh≠ãrR™ge
;

86 c⁄° 
byã
 
	gma°îIndexRec‹dMagic
 = 0xAA;

87 c⁄° 
byã
 
	gbadMagic
 = 0;

95 
	gmöMa°îIndexDñèLi°s
;

105 
INLINE
 
	$maxUöt
(
a
, 
b
)

107  
a
 > 
b
 ?á : b;

108 
	}
}

118 
INLINE
 
	$exåa˘Addªss
(c⁄° 
Ma°îIndex5
 *
mi5
,

119 c⁄° 
UdsChunkName
 *
«me
)

121  
	`exåa˘Ma°îIndexByãs
(
«me
Ë& 
mi5
->
addªssMask
;

122 
	}
}

132 
INLINE
 
	$exåa˘DLi°Num
(c⁄° 
Ma°îIndex5
 *
mi5
,

133 c⁄° 
UdsChunkName
 *
«me
)

135 
uöt64_t
 
bôs
 = 
	`exåa˘Ma°îIndexByãs
(
«me
);

136  (
bôs
 >> 
mi5
->
addªssBôs
Ë% mi5->
numDñèLi°s
;

137 
	}
}

146 
INLINE
 c⁄° 
Ma°îIndexZ⁄e
 *
	$gëMa°îZ⁄e
(c⁄° 
Ma°îIndexRec‹d
 *
ªc‹d
)

148 c⁄° 
Ma°îIndex5
 *
mi5
 = 
	`c⁄èöî_of
(
ªc‹d
->
ma°îIndex
, MasterIndex5,

149 
comm⁄
);

150  &
mi5
->
ma°îZ⁄es
[
ªc‹d
->
z⁄eNumbî
];

151 
	}
}

161 
INLINE
 
uöt64_t
 
	$c⁄vîtIndexToVútuÆ
(c⁄° 
Ma°îIndexRec‹d
 *
ªc‹d
,

162 
ödexCh≠ãr
)

164 c⁄° 
Ma°îIndex5
 *
mi5
 = 
	`c⁄èöî_of
(
ªc‹d
->
ma°îIndex
, MasterIndex5,

165 
comm⁄
);

166 c⁄° 
Ma°îIndexZ⁄e
 *
ma°îZ⁄e
 = 
	`gëMa°îZ⁄e
(
ªc‹d
);

167 
rﬁlögCh≠ãr


168 ((
ödexCh≠ãr
 - 
ma°îZ⁄e
->
vútuÆCh≠ãrLow
Ë& 
mi5
->
ch≠ãrMask
);

169  
ma°îZ⁄e
->
vútuÆCh≠ãrLow
 + 
rﬁlögCh≠ãr
;

170 
	}
}

180 
INLINE
 
	$c⁄vîtVútuÆToIndex
(c⁄° 
Ma°îIndex5
 *
mi5
,

181 
uöt64_t
 
vútuÆCh≠ãr
)

183  
vútuÆCh≠ãr
 & 
mi5
->
ch≠ãrMask
;

184 
	}
}

194 
INLINE
 
boﬁ
 
	$isVútuÆCh≠ãrIndexed
(c⁄° 
Ma°îIndexRec‹d
 *
ªc‹d
,

195 
uöt64_t
 
vútuÆCh≠ãr
)

197 c⁄° 
Ma°îIndexZ⁄e
 *
ma°îZ⁄e
 = 
	`gëMa°îZ⁄e
(
ªc‹d
);

198  ((
vútuÆCh≠ãr
 >
ma°îZ⁄e
->
vútuÆCh≠ãrLow
)

199 && (
vútuÆCh≠ãr
 <
ma°îZ⁄e
->
vútuÆCh≠ãrHigh
));

200 
	}
}

214 
INLINE
 
	$ÊushInvÆidE¡rõs
(
Ma°îIndexRec‹d
 *
ªc‹d
,

215 
Ch≠ãrR™ge
 *
ÊushR™ge
,

216 *
√xtCh≠ãrToInvÆid©e
)

218 c⁄° 
Ma°îIndex5
 *
mi5
 = 
	`c⁄èöî_of
(
ªc‹d
->
ma°îIndex
, MasterIndex5,

219 
comm⁄
);

220 
ªsu…
 = 
	`√xtDñèIndexE¡ry
(&
ªc‹d
->
dñèE¡ry
);

221 i‡(
ªsu…
 !
UDS_SUCCESS
) {

222  
ªsu…
;

224 !
ªc‹d
->
dñèE¡ry
.
©End
) {

225 
ödexCh≠ãr
 = 
	`gëDñèE¡ryVÆue
(&
ªc‹d
->
dñèE¡ry
);

226 
ªœtiveCh≠ãr
 = ((
ödexCh≠ãr
 - 
ÊushR™ge
->
ch≠ãrSèπ
)

227 & 
mi5
->
ch≠ãrMask
);

228 i‡(
	`likñy
(
ªœtiveCh≠ãr
 >
ÊushR™ge
->
ch≠ãrCou¡
)) {

229 i‡(
ªœtiveCh≠ãr
 < *
√xtCh≠ãrToInvÆid©e
) {

230 *
√xtCh≠ãrToInvÆid©e
 = 
ªœtiveCh≠ãr
;

234 
ªsu…
 = 
	`ªmoveDñèIndexE¡ry
(&
ªc‹d
->
dñèE¡ry
);

235 i‡(
ªsu…
 !
UDS_SUCCESS
) {

236  
ªsu…
;

239  
UDS_SUCCESS
;

240 
	}
}

253 
	$gëMa°îIndexE¡ry
(
Ma°îIndexRec‹d
 *
ªc‹d
,

254 
li°Numbî
,

255 
key
,

256 
Ch≠ãrR™ge
 *
ÊushR™ge
)

258 c⁄° 
Ma°îIndex5
 *
mi5
 = 
	`c⁄èöî_of
(
ªc‹d
->
ma°îIndex
, MasterIndex5,

259 
comm⁄
);

260 
√xtCh≠ãrToInvÆid©e
 = 
mi5
->
ch≠ãrMask
;

262 
ªsu…
 = 
	`°¨tDñèIndexSórch
(&
mi5
->
dñèIndex
, 
li°Numbî
, 0,

263 
Ál£
, &
ªc‹d
->
dñèE¡ry
);

264 i‡(
ªsu…
 !
UDS_SUCCESS
) {

265  
ªsu…
;

268 
ªsu…
 = 
	`ÊushInvÆidE¡rõs
(
ªc‹d
, 
ÊushR™ge
, &
√xtCh≠ãrToInvÆid©e
);

269 i‡(
ªsu…
 !
UDS_SUCCESS
) {

270  
ªsu…
;

272 } !
ªc‹d
->
dñèE¡ry
.
©End
 && (
key
 >Ñecord->deltaEntry.key));

274 
ªsu…
 = 
	`ªmembîDñèIndexOff£t
(&
ªc‹d
->
dñèE¡ry
);

275 i‡(
ªsu…
 !
UDS_SUCCESS
) {

276  
ªsu…
;

280 
Ma°îIndexRec‹d
 
ŸhîRec‹d
 = *
ªc‹d
;

281 i‡(!
ŸhîRec‹d
.
dñèE¡ry
.
©End
 && (
key
 == otherRecord.deltaEntry.key)) {

283 
ªsu…
 = 
	`ÊushInvÆidE¡rõs
(&
ŸhîRec‹d
, 
ÊushR™ge
,

284 &
√xtCh≠ãrToInvÆid©e
);

285 i‡(
ªsu…
 !
UDS_SUCCESS
) {

286  
ªsu…
;

288 i‡(
ŸhîRec‹d
.
dñèE¡ry
.
©End


289 || !
ŸhîRec‹d
.
dñèE¡ry
.
isCﬁlisi⁄
) {

292 
byã
 
cﬁlisi⁄Name
[
UDS_CHUNK_NAME_SIZE
];

293 
ªsu…
 = 
	`gëDñèE¡ryCﬁlisi⁄
(&
ŸhîRec‹d
.
dñèE¡ry
, 
cﬁlisi⁄Name
);

294 i‡(
ªsu…
 !
UDS_SUCCESS
) {

295  
ªsu…
;

297 i‡(
	`memcmp
(
cﬁlisi⁄Name
, 
ªc‹d
->
«me
, 
UDS_CHUNK_NAME_SIZE
) == 0) {

299 *
ªc‹d
 = 
ŸhîRec‹d
;

304 !
ŸhîRec‹d
.
dñèE¡ry
.
©End
) {

305 
ªsu…
 = 
	`ÊushInvÆidE¡rõs
(&
ŸhîRec‹d
, 
ÊushR™ge
,

306 &
√xtCh≠ãrToInvÆid©e
);

307 i‡(
ªsu…
 !
UDS_SUCCESS
) {

308  
ªsu…
;

311 
√xtCh≠ãrToInvÆid©e
 +
ÊushR™ge
->
ch≠ãrSèπ
;

312 
√xtCh≠ãrToInvÆid©e
 &
mi5
->
ch≠ãrMask
;

313 
ÊushR™ge
->
ch≠ãrSèπ
 = 
√xtCh≠ãrToInvÆid©e
;

314 
ÊushR™ge
->
ch≠ãrCou¡
 = 0;

315  
UDS_SUCCESS
;

316 
	}
}

324 
	$‰ìMa°îIndex_005
(
Ma°îIndex
 *
ma°îIndex
)

326 i‡(
ma°îIndex
 !
NULL
) {

327 
Ma°îIndex5
 *
mi5
 = 
	`c⁄èöî_of
(
ma°îIndex
, Ma°îIndex5, 
comm⁄
);

328 
	`FREE
(
mi5
->
ÊushCh≠ãrs
);

329 
mi5
->
ÊushCh≠ãrs
 = 
NULL
;

330 
	`FREE
(
mi5
->
ma°îZ⁄es
);

331 
mi5
->
ma°îZ⁄es
 = 
NULL
;

332 
	`unöôülizeDñèIndex
(&
mi5
->
dñèIndex
);

333 
	`FREE
(
ma°îIndex
);

335 
	}
}

342 íum { 
	mMAGIC_SIZE
 = 8 };

343 c⁄° 
	gMAGIC_MI_START
[] = "MI5-0005";

345 
	smi005_d©a
 {

346 
	mmagic
[
MAGIC_SIZE
];

347 
uöt64_t
 
	mvﬁumeN⁄˚
;

348 
uöt64_t
 
	mvútuÆCh≠ãrLow
;

349 
uöt64_t
 
	mvútuÆCh≠ãrHigh
;

350 
	mfú°Li°
;

351 
	mnumLi°s
;

361 
	$£tMa°îIndexTag_005
(
Ma°îIndex
 *
ma°îIndex
, 
byã
 
èg
)

363 
Ma°îIndex5
 *
mi5
 = 
	`c⁄èöî_of
(
ma°îIndex
, Ma°îIndex5, 
comm⁄
);

364 
	`£tDñèIndexTag
(&
mi5
->
dñèIndex
, 
èg
);

365 
	}
}

377 
	$°¨tSavögMa°îIndex_005
(c⁄° 
Ma°îIndex
 *
ma°îIndex
,

378 
z⁄eNumbî
,

379 
Buf„ªdWrôî
 *
buf„ªdWrôî
)

381 c⁄° 
Ma°îIndex5
 *
mi5
 = 
	`c⁄°_c⁄èöî_of
(
ma°îIndex
, MasterIndex5,

382 
comm⁄
);

383 
Ma°îIndexZ⁄e
 *
ma°îZ⁄e
 = &
mi5
->
ma°îZ⁄es
[
z⁄eNumbî
];

384 
fú°Li°
 = 
	`gëDñèIndexZ⁄eFú°Li°
(&
mi5
->
dñèIndex
,

385 
z⁄eNumbî
);

386 
numLi°s
 = 
	`gëDñèIndexZ⁄eNumLi°s
(&
mi5
->
dñèIndex
,

387 
z⁄eNumbî
);

389 
mi005_d©a
 
hódî
;

390 
	`mem£t
(&
hódî
, 0, (header));

391 
	`mem˝y
(
hódî
.
magic
, 
MAGIC_MI_START
, 
MAGIC_SIZE
);

392 
hódî
.
vﬁumeN⁄˚
 = 
mi5
->volumeNonce;

393 
hódî
.
vútuÆCh≠ãrLow
 = 
ma°îZ⁄e
->virtualChapterLow;

394 
hódî
.
vútuÆCh≠ãrHigh
 = 
ma°îZ⁄e
->virtualChapterHigh;

395 
hódî
.
fú°Li°
 = firstList;

396 
hódî
.
numLi°s
 =ÇumLists;

398 
ªsu…
 = 
	`wrôeToBuf„ªdWrôî
(
buf„ªdWrôî
, (c⁄° 
byã
 *Ë&
hódî
,

399 (
hódî
));

400 i‡(
ªsu…
 !
UDS_SUCCESS
) {

401  
	`logW¨nögWôhSåögEº‹
(
ªsu…
,

405 
uöt64_t
 *
fú°FlushCh≠ãr
 = &
mi5
->
ÊushCh≠ãrs
[
fú°Li°
];

406 
ªsu…
 = 
	`wrôeToBuf„ªdWrôî
(
buf„ªdWrôî
,

407 (c⁄° 
byã
 *Ë
fú°FlushCh≠ãr
,

408 
numLi°s
 * (
uöt64_t
));

409 i‡(
ªsu…
 !
UDS_SUCCESS
) {

410  
	`logW¨nögWôhSåögEº‹
(
ªsu…
,

415  
	`°¨tSavögDñèIndex
(&
mi5
->
dñèIndex
, 
z⁄eNumbî
, 
buf„ªdWrôî
);

416 
	}
}

429 
boﬁ
 
	$isSavögMa°îIndexD⁄e_005
(c⁄° 
Ma°îIndex
 *
ma°îIndex
,

430 
z⁄eNumbî
)

432 c⁄° 
Ma°îIndex5
 *
mi5
 = 
	`c⁄°_c⁄èöî_of
(
ma°îIndex
, MasterIndex5,

433 
comm⁄
);

434  
	`isSavögDñèIndexD⁄e
(&
mi5
->
dñèIndex
, 
z⁄eNumbî
);

435 
	}
}

448 
	$föishSavögMa°îIndex_005
(c⁄° 
Ma°îIndex
 *
ma°îIndex
,

449 
z⁄eNumbî
)

451 c⁄° 
Ma°îIndex5
 *
mi5
 = 
	`c⁄°_c⁄èöî_of
(
ma°îIndex
, MasterIndex5,

452 
comm⁄
);

453  
	`föishSavögDñèIndex
(&
mi5
->
dñèIndex
, 
z⁄eNumbî
);

454 
	}
}

466 
	$ab‹tSavögMa°îIndex_005
(c⁄° 
Ma°îIndex
 *
ma°îIndex
,

467 
z⁄eNumbî
)

469 c⁄° 
Ma°îIndex5
 *
mi5
 = 
	`c⁄°_c⁄èöî_of
(
ma°îIndex
, MasterIndex5,

470 
comm⁄
);

471  
	`ab‹tSavögDñèIndex
(&
mi5
->
dñèIndex
, 
z⁄eNumbî
);

472 
	}
}

484 
	$°¨tRe°‹ögMa°îIndex_005
(
Ma°îIndex
 *
ma°îIndex
,

485 
Buf„ªdRódî
 **
buf„ªdRódîs
,

486 
numRódîs
)

488 i‡(
ma°îIndex
 =
NULL
) {

489  
	`logW¨nögWôhSåögEº‹
(
UDS_BAD_STATE
,

492 
Ma°îIndex5
 *
mi5
 = 
	`c⁄èöî_of
(
ma°îIndex
, Ma°îIndex5, 
comm⁄
);

493 
	`em±yDñèIndex
(&
mi5
->
dñèIndex
);

495 
Ma°îIndexZ⁄e
 
ma°îZ⁄e
 = {

496 .
vútuÆCh≠ãrLow
 = 0,

497 .
vútuÆCh≠ãrHigh
 = 0,

499 
i
 = 0; i < 
numRódîs
; i++) {

500 
mi005_d©a
 
hódî
;

501 
ªsu…
 = 
	`ªadFromBuf„ªdRódî
(
buf„ªdRódîs
[
i
], (
byã
 *Ë&
hódî
,

502 (
hódî
));

503 i‡(
ªsu…
 !
UDS_SUCCESS
) {

504  
	`logW¨nögWôhSåögEº‹
(
ªsu…
,

507 i‡(
	`memcmp
(
hódî
.
magic
, 
MAGIC_MI_START
, 
MAGIC_SIZE
) != 0) {

508  
	`logW¨nögWôhSåögEº‹
(
UDS_CORRUPT_COMPONENT
,

512 i‡(
mi5
->
vﬁumeN⁄˚
 == 0) {

513 
mi5
->
vﬁumeN⁄˚
 = 
hódî
.volumeNonce;

514 } i‡(
hódî
.
vﬁumeN⁄˚
 !
mi5
->volumeNonce) {

515  
	`logW¨nögWôhSåögEº‹
(
UDS_CORRUPT_COMPONENT
,

518 i‡(
i
 == 0) {

519 
ma°îZ⁄e
.
vútuÆCh≠ãrLow
 = 
hódî
.virtualChapterLow;

520 
ma°îZ⁄e
.
vútuÆCh≠ãrHigh
 = 
hódî
.virtualChapterHigh;

521 } i‡(
ma°îZ⁄e
.
vútuÆCh≠ãrHigh
 !
hódî
.virtualChapterHigh) {

522  
	`logW¨nögWôhSåögEº‹
(
UDS_CORRUPT_COMPONENT
,

524 " Ch≠ã∏øngêi†[%" 
PRIu64
 ",%"

525 
PRIu64
 "], chapterÑange %d is [%" PRIu64

526 ",%" 
PRIu64
 "]",

527 
ma°îZ⁄e
.
vútuÆCh≠ãrLow
,

528 
ma°îZ⁄e
.
vútuÆCh≠ãrHigh
,

529 
i
, 
hódî
.
vútuÆCh≠ãrLow
,

530 
hódî
.
vútuÆCh≠ãrHigh
);

531 } i‡(
ma°îZ⁄e
.
vútuÆCh≠ãrLow
 < 
hódî
.virtualChapterLow) {

532 
ma°îZ⁄e
.
vútuÆCh≠ãrLow
 = 
hódî
.virtualChapterLow;

534 
uöt64_t
 *
fú°FlushCh≠ãr
 = &
mi5
->
ÊushCh≠ãrs
[
hódî
.
fú°Li°
];

535 
ªsu…
 = 
	`ªadFromBuf„ªdRódî
(
buf„ªdRódîs
[
i
],

536 (
byã
 *Ë
fú°FlushCh≠ãr
,

537 
hódî
.
numLi°s
 * (
uöt64_t
));

538 i‡(
ªsu…
 !
UDS_SUCCESS
) {

539  
	`logW¨nögWôhSåögEº‹
(
ªsu…
,

545 
z
 = 0; z < 
mi5
->
numZ⁄es
; z++) {

546 
mi5
->
ma°îZ⁄es
[
z
] = 
ma°îZ⁄e
;

549 
ªsu…
 = 
	`°¨tRe°‹ögDñèIndex
(&
mi5
->
dñèIndex
, 
buf„ªdRódîs
,

550 
numRódîs
);

551 i‡(
ªsu…
 !
UDS_SUCCESS
) {

552  
	`logW¨nögWôhSåögEº‹
(
ªsu…
, "restoring delta index failed");

554  
UDS_SUCCESS
;

555 
	}
}

566 
boﬁ
 
	$isRe°‹ögMa°îIndexD⁄e_005
(c⁄° 
Ma°îIndex
 *
ma°îIndex
)

568 c⁄° 
Ma°îIndex5
 *
mi5
 = 
	`c⁄°_c⁄èöî_of
(
ma°îIndex
, MasterIndex5,

569 
comm⁄
);

570  
	`isRe°‹ögDñèIndexD⁄e
(&
mi5
->
dñèIndex
);

571 
	}
}

583 
	$ª°‹eDñèLi°ToMa°îIndex_005
(
Ma°îIndex
 *
ma°îIndex
,

584 c⁄° 
DñèLi°SaveInfo
 *
dlsi
,

585 c⁄° 
byã
 
d©a
[
DELTA_LIST_MAX_BYTE_COUNT
])

587 
Ma°îIndex5
 *
mi5
 = 
	`c⁄èöî_of
(
ma°îIndex
, Ma°îIndex5, 
comm⁄
);

588  
	`ª°‹eDñèLi°ToDñèIndex
(&
mi5
->
dñèIndex
, 
dlsi
, 
d©a
);

589 
	}
}

597 
	$ab‹tRe°‹ögMa°îIndex_005
(
Ma°îIndex
 *
ma°îIndex
)

599 
Ma°îIndex5
 *
mi5
 = 
	`c⁄èöî_of
(
ma°îIndex
, Ma°îIndex5, 
comm⁄
);

600 
	`ab‹tRe°‹ögDñèIndex
(&
mi5
->
dñèIndex
);

601 
	}
}

604 
	$ªmoveNewe°Ch≠ãrs
(
Ma°îIndex5
 *
mi5
,

605 
z⁄eNumbî
,

606 
uöt64_t
 
vútuÆCh≠ãr
)

609 
fú°Li°
 = 
	`gëDñèIndexZ⁄eFú°Li°
(&
mi5
->
dñèIndex
,

610 
z⁄eNumbî
);

611 
numLi°s
 = 
	`gëDñèIndexZ⁄eNumLi°s
(&
mi5
->
dñèIndex
,

612 
z⁄eNumbî
);

613 
œ°Li°
 = 
fú°Li°
 + 
numLi°s
 - 1;

615 i‡(
vútuÆCh≠ãr
 > 
mi5
->
ch≠ãrMask
) {

618 
vútuÆCh≠ãr
 -
mi5
->
ch≠ãrMask
 + 1;

621 
i
 = 
fú°Li°
; i <
œ°Li°
; i++) {

622 i‡(
vútuÆCh≠ãr
 < 
mi5
->
ÊushCh≠ãrs
[
i
]) {

623 
mi5
->
ÊushCh≠ãrs
[
i
] = 
vútuÆCh≠ãr
;

628 
Ma°îIndexZ⁄e
 *
ma°îZ⁄e
 = &
mi5
->
ma°îZ⁄es
[
z⁄eNumbî
];

629 
Ch≠ãrR™ge
 
ønge
;

630 
ønge
.
ch≠ãrSèπ
 = 
	`c⁄vîtVútuÆToIndex
(
mi5
, 
vútuÆCh≠ãr
);

631 
ønge
.
ch≠ãrCou¡
 = (
mi5
->
ch≠ãrMask
 + 1

632 - (
vútuÆCh≠ãr
 - 
ma°îZ⁄e
->
vútuÆCh≠ãrLow
));

633 
Ma°îIndexRec‹d
 
ªc‹d
;

634 
UdsChunkName
 
«me
;

635 
	`mem£t
(&
«me
, 0, (
UdsChunkName
));

636 
ªc‹d
.
ma°îIndex
 = &
mi5
->
comm⁄
;

637 
ªc‹d
.
«me
 = &name;

638 
i
 = 
fú°Li°
; i <
œ°Li°
; i++) {

639 
Ch≠ãrR™ge
 
ãmpR™ge
 = 
ønge
;

640 
	`gëMa°îIndexE¡ry
(&
ªc‹d
, 
i
, 0, &
ãmpR™ge
);

643 
	}
}

655 
	$£tMa°îIndexZ⁄eO≥nCh≠ãr_005
(
Ma°îIndex
 *
ma°îIndex
,

656 
z⁄eNumbî
,

657 
uöt64_t
 
vútuÆCh≠ãr
)

659 
Ma°îIndex5
 *
mi5
 = 
	`c⁄èöî_of
(
ma°îIndex
, Ma°îIndex5, 
comm⁄
);

660 
Ma°îIndexZ⁄e
 *
ma°îZ⁄e
 = &
mi5
->
ma°îZ⁄es
[
z⁄eNumbî
];

664 
uöt64_t
 
√wVútuÆLow
 = (
vútuÆCh≠ãr
 >
mi5
->
numCh≠ãrs


665 ? 
vútuÆCh≠ãr
 - 
mi5
->
numCh≠ãrs
 + 1

668 i‡(
vútuÆCh≠ãr
 <
ma°îZ⁄e
->
vútuÆCh≠ãrLow
) {

674 
	`em±yDñèIndexZ⁄e
(&
mi5
->
dñèIndex
, 
z⁄eNumbî
);

675 
ma°îZ⁄e
->
vútuÆCh≠ãrLow
 = 
vútuÆCh≠ãr
;

676 
ma°îZ⁄e
->
vútuÆCh≠ãrHigh
 = 
vútuÆCh≠ãr
;

677 } i‡(
vútuÆCh≠ãr
 <
ma°îZ⁄e
->
vútuÆCh≠ãrHigh
) {

681 
	`ªmoveNewe°Ch≠ãrs
(
mi5
, 
z⁄eNumbî
, 
vútuÆCh≠ãr
);

682 
ma°îZ⁄e
->
vútuÆCh≠ãrHigh
 = 
vútuÆCh≠ãr
;

683 } i‡(
√wVútuÆLow
 < 
ma°îZ⁄e
->
vútuÆCh≠ãrLow
) {

685 
ma°îZ⁄e
->
vútuÆCh≠ãrHigh
 = 
vútuÆCh≠ãr
;

686 } i‡(
√wVútuÆLow
 <
ma°îZ⁄e
->
vútuÆCh≠ãrHigh
) {

688 
ma°îZ⁄e
->
vútuÆCh≠ãrLow
 = 
√wVútuÆLow
;

689 
ma°îZ⁄e
->
vútuÆCh≠ãrHigh
 = 
vútuÆCh≠ãr
;

692 
ma°îZ⁄e
->
vútuÆCh≠ãrLow
 = 
vútuÆCh≠ãr
;

693 
ma°îZ⁄e
->
vútuÆCh≠ãrHigh
 = 
vútuÆCh≠ãr
;

696 i‡(
ma°îZ⁄e
->
vútuÆCh≠ãrLow
 < ma°îZ⁄e->
vútuÆCh≠ãrHigh
) {

697 
uöt64_t
 
u£dBôs
 = 
	`gëDñèIndexZ⁄eDli°BôsU£d
(&
mi5
->
dñèIndex
,

698 
z⁄eNumbî
);

699 i‡(
u£dBôs
 > 
mi5
->
maxZ⁄eBôs
) {

701 
uöt64_t
 
expúeCou¡


702 1 + (
u£dBôs
 - 
mi5
->
maxZ⁄eBôs
Ë/ mi5->
ch≠ãrZ⁄eBôs
;

703 i‡(
expúeCou¡
 == 1) {

704 
	`logInfo
("ma°îZ⁄ê%u: Aàch≠ã∏%" 
PRIu64
 ",Éxpiring chapter %"

705 
PRIu64
 "Éarly",

706 
z⁄eNumbî
, 
vútuÆCh≠ãr
, 
ma°îZ⁄e
->
vútuÆCh≠ãrLow
);

707 
ma°îZ⁄e
->
numE¨lyFlushes
++;

708 
ma°îZ⁄e
->
vútuÆCh≠ãrLow
++;

710 
uöt64_t
 
fú°Expúed
 = 
ma°îZ⁄e
->
vútuÆCh≠ãrLow
;

711 i‡(
fú°Expúed
 + 
expúeCou¡
 < 
ma°îZ⁄e
->
vútuÆCh≠ãrHigh
) {

712 
ma°îZ⁄e
->
numE¨lyFlushes
 +
expúeCou¡
;

713 
ma°îZ⁄e
->
vútuÆCh≠ãrLow
 +
expúeCou¡
;

715 
ma°îZ⁄e
->
numE¨lyFlushes


716 +
ma°îZ⁄e
->
vútuÆCh≠ãrHigh
 - ma°îZ⁄e->
vútuÆCh≠ãrLow
;

717 
ma°îZ⁄e
->
vútuÆCh≠ãrLow
 = ma°îZ⁄e->
vútuÆCh≠ãrHigh
;

719 
	`logInfo
("ma°îZ⁄ê%u: Aàch≠ã∏%" 
PRIu64
 ",Éxpiring chapters %"

720 
PRIu64
 "Åÿ%" PRIu64 "É¨ly", 
z⁄eNumbî
, 
vútuÆCh≠ãr
,

721 
fú°Expúed
, 
ma°îZ⁄e
->
vútuÆCh≠ãrLow
 - 1);

725 
	}
}

735 
	$£tMa°îIndexO≥nCh≠ãr_005
(
Ma°îIndex
 *
ma°îIndex
,

736 
uöt64_t
 
vútuÆCh≠ãr
)

738 
Ma°îIndex5
 *
mi5
 = 
	`c⁄èöî_of
(
ma°îIndex
, Ma°îIndex5, 
comm⁄
);

739 
z
 = 0; z < 
mi5
->
numZ⁄es
; z++) {

742 
Ma°îIndexZ⁄e
 *
ma°îZ⁄e
 = &
mi5
->
ma°îZ⁄es
[
z
];

743 
boﬁ
 
logMove
 = 
vútuÆCh≠ãr
 !
ma°îZ⁄e
->
vútuÆCh≠ãrHigh
 + 1;

744 i‡(
logMove
) {

745 
	`logDebug
("masterZone %u: TheÑange of indexed chapters is moving from [%"

746 
PRIu64
 ", %" PRIu64 "] ...",

747 
z
,

748 
ma°îZ⁄e
->
vútuÆCh≠ãrLow
,

749 
ma°îZ⁄e
->
vútuÆCh≠ãrHigh
);

752 
	`£tMa°îIndexZ⁄eO≥nCh≠ãr_005
(
ma°îIndex
, 
z
, 
vútuÆCh≠ãr
);

754 i‡(
logMove
) {

755 
	`logDebug
("ma°îZ⁄ê%u: ...ánd movögÅÿ[%" 
PRIu64
 ", %" PRIu64 "]",

756 
z
,

757 
ma°îZ⁄e
->
vútuÆCh≠ãrLow
,

758 
ma°îZ⁄e
->
vútuÆCh≠ãrHigh
);

761 
	}
}

772 
	$gëMa°îIndexZ⁄e_005
(c⁄° 
Ma°îIndex
 *
ma°îIndex
,

773 c⁄° 
UdsChunkName
 *
«me
)

775 c⁄° 
Ma°îIndex5
 *
mi5
 = 
	`c⁄°_c⁄èöî_of
(
ma°îIndex
, MasterIndex5,

776 
comm⁄
);

777 
dñèLi°Numbî
 = 
	`exåa˘DLi°Num
(
mi5
, 
«me
);

778  
	`gëDñèIndexZ⁄e
(&
mi5
->
dñèIndex
, 
dñèLi°Numbî
);

779 
	}
}

792 
	$lookupMa°îIndexName_005
(c⁄° 
Ma°îIndex
 *
ma°îIndex
,

793 c⁄° 
UdsChunkName
 *
«me
,

794 
Ma°îIndexTrüge
 *
åüge
)

796 
åüge
->
isSam∂e
 = 
Ál£
;

797 
åüge
->
öSam∂edCh≠ãr
 = 
Ál£
;

798 
åüge
->
z⁄e
 = 
	`gëMa°îIndexZ⁄e_005
(
ma°îIndex
, 
«me
);

799  
UDS_SUCCESS
;

800 
	}
}

816 
	$lookupMa°îIndexSam∂edName_005
(c⁄° 
Ma°îIndex
 *
ma°îIndex
,

817 c⁄° 
UdsChunkName
 *
«me
,

818 
Ma°îIndexTrüge
 *
åüge
)

820 c⁄° 
Ma°îIndex5
 *
mi5
 = 
	`c⁄°_c⁄èöî_of
(
ma°îIndex
, MasterIndex5,

821 
comm⁄
);

822 
addªss
 = 
	`exåa˘Addªss
(
mi5
, 
«me
);

823 
dñèLi°Numbî
 = 
	`exåa˘DLi°Num
(
mi5
, 
«me
);

824 
DñèIndexE¡ry
 
dñèE¡ry
;

825 
ªsu…
 = 
	`gëDñèIndexE¡ry
(&
mi5
->
dñèIndex
, 
dñèLi°Numbî
, 
addªss
,

826 
«me
->«me, 
åue
, &
dñèE¡ry
);

827 i‡(
ªsu…
 !
UDS_SUCCESS
) {

828  
ªsu…
;

830 
åüge
->
öSam∂edCh≠ãr
 = !
dñèE¡ry
.
©End
 && (dñèE¡ry.
key
 =
addªss
);

831 i‡(
åüge
->
öSam∂edCh≠ãr
) {

832 c⁄° 
Ma°îIndexZ⁄e
 *
ma°îZ⁄e
 = &
mi5
->
ma°îZ⁄es
[
åüge
->
z⁄e
];

833 
ödexCh≠ãr
 = 
	`gëDñèE¡ryVÆue
(&
dñèE¡ry
);

834 
rﬁlögCh≠ãr
 = ((
ödexCh≠ãr


835 - 
ma°îZ⁄e
->
vútuÆCh≠ãrLow
)

836 & 
mi5
->
ch≠ãrMask
);

837 
åüge
->
vútuÆCh≠ãr
 = 
ma°îZ⁄e
->
vútuÆCh≠ãrLow
 + 
rﬁlögCh≠ãr
;

838 i‡(
åüge
->
vútuÆCh≠ãr
 > 
ma°îZ⁄e
->
vútuÆCh≠ãrHigh
) {

839 
åüge
->
öSam∂edCh≠ãr
 = 
Ál£
;

842  
UDS_SUCCESS
;

843 
	}
}

872 
	$gëMa°îIndexRec‹d_005
(
Ma°îIndex
 *
ma°îIndex
,

873 c⁄° 
UdsChunkName
 *
«me
,

874 
Ma°îIndexRec‹d
 *
ªc‹d
)

876 
Ma°îIndex5
 *
mi5
 = 
	`c⁄èöî_of
(
ma°îIndex
, Ma°îIndex5, 
comm⁄
);

877 
addªss
 = 
	`exåa˘Addªss
(
mi5
, 
«me
);

878 
dñèLi°Numbî
 = 
	`exåa˘DLi°Num
(
mi5
, 
«me
);

879 
uöt64_t
 
ÊushCh≠ãr
 = 
mi5
->
ÊushCh≠ãrs
[
dñèLi°Numbî
];

880 
ªc‹d
->
magic
 = 
ma°îIndexRec‹dMagic
;

881 
ªc‹d
->
ma°îIndex
 = masterIndex;

882 
ªc‹d
->
muãx
 = 
NULL
;

883 
ªc‹d
->
«me
 =Çame;

884 
ªc‹d
->
z⁄eNumbî
 = 
	`gëDñèIndexZ⁄e
(&
mi5
->
dñèIndex
, 
dñèLi°Numbî
);

885 c⁄° 
Ma°îIndexZ⁄e
 *
ma°îZ⁄e
 = 
	`gëMa°îZ⁄e
(
ªc‹d
);

887 
ªsu…
;

888 i‡(
ÊushCh≠ãr
 < 
ma°îZ⁄e
->
vútuÆCh≠ãrLow
) {

889 
Ch≠ãrR™ge
 
ønge
;

890 
uöt64_t
 
ÊushCou¡
 = 
ma°îZ⁄e
->
vútuÆCh≠ãrLow
 - 
ÊushCh≠ãr
;

891 
ønge
.
ch≠ãrSèπ
 = 
	`c⁄vîtVútuÆToIndex
(
mi5
, 
ÊushCh≠ãr
);

892 
ønge
.
ch≠ãrCou¡
 = (
ÊushCou¡
 > 
mi5
->
ch≠ãrMask


893 ? 
mi5
->
ch≠ãrMask
 + 1

894 : 
ÊushCou¡
);

895 
ªsu…
 = 
	`gëMa°îIndexE¡ry
(
ªc‹d
, 
dñèLi°Numbî
, 
addªss
, &
ønge
);

896 
ÊushCh≠ãr
 = 
	`c⁄vîtIndexToVútuÆ
(
ªc‹d
, 
ønge
.
ch≠ãrSèπ
);

897 i‡(
ÊushCh≠ãr
 > 
ma°îZ⁄e
->
vútuÆCh≠ãrHigh
) {

898 
ÊushCh≠ãr
 = 
ma°îZ⁄e
->
vútuÆCh≠ãrHigh
;

900 
mi5
->
ÊushCh≠ãrs
[
dñèLi°Numbî
] = 
ÊushCh≠ãr
;

902 
ªsu…
 = 
	`gëDñèIndexE¡ry
(&
mi5
->
dñèIndex
, 
dñèLi°Numbî
, 
addªss
,

903 
«me
->«me, 
Ál£
, &
ªc‹d
->
dñèE¡ry
);

905 i‡(
ªsu…
 !
UDS_SUCCESS
) {

906  
ªsu…
;

908 
ªc‹d
->
isFound
 = (!ªc‹d->
dñèE¡ry
.
©End


909 && (
ªc‹d
->
dñèE¡ry
.
key
 =
addªss
));

910 i‡(
ªc‹d
->
isFound
) {

911 
ödexCh≠ãr
 = 
	`gëDñèE¡ryVÆue
(&
ªc‹d
->
dñèE¡ry
);

912 
ªc‹d
->
vútuÆCh≠ãr
 = 
	`c⁄vîtIndexToVútuÆ
‘ec‹d, 
ödexCh≠ãr
);

914 
ªc‹d
->
isCﬁlisi⁄
 =Ñec‹d->
dñèE¡ry
.isCollision;

915  
UDS_SUCCESS
;

916 
	}
}

927 
	$putMa°îIndexRec‹d
(
Ma°îIndexRec‹d
 *
ªc‹d
, 
uöt64_t
 
vútuÆCh≠ãr
)

929 c⁄° 
Ma°îIndex5
 *
mi5
 = 
	`c⁄èöî_of
(
ªc‹d
->
ma°îIndex
, MasterIndex5,

930 
comm⁄
);

931 i‡(
ªc‹d
->
magic
 !
ma°îIndexRec‹dMagic
) {

932  
	`logW¨nögWôhSåögEº‹
(
UDS_BAD_STATE
,

935 i‡(!
	`isVútuÆCh≠ãrIndexed
(
ªc‹d
, 
vútuÆCh≠ãr
)) {

936 c⁄° 
Ma°îIndexZ⁄e
 *
ma°îZ⁄e
 = 
	`gëMa°îZ⁄e
(
ªc‹d
);

937  
	`logW¨nögWôhSåögEº‹
(
UDS_INVALID_ARGUMENT
,

939 
PRIu64
 "Åhat is out ofÅhe validÑange %"

940 
PRIu64
 "Åo %" PRIu64,

941 
vútuÆCh≠ãr
,

942 
ma°îZ⁄e
->
vútuÆCh≠ãrLow
,

943 
ma°îZ⁄e
->
vútuÆCh≠ãrHigh
);

945 
addªss
 = 
	`exåa˘Addªss
(
mi5
, 
ªc‹d
->
«me
);

946 i‡(
	`u∆ikñy
(
ªc‹d
->
muãx
 !
NULL
)) {

947 
	`lockMuãx
(
ªc‹d
->
muãx
);

949 
ªsu…
 = 
	`putDñèIndexE¡ry
(&
ªc‹d
->
dñèE¡ry
, 
addªss
,

950 
	`c⁄vîtVútuÆToIndex
(
mi5
, 
vútuÆCh≠ãr
),

951 
ªc‹d
->
isFound
 ?Ñec‹d->
«me
->«mê: 
NULL
);

952 i‡(
	`u∆ikñy
(
ªc‹d
->
muãx
 !
NULL
)) {

953 
	`u∆ockMuãx
(
ªc‹d
->
muãx
);

955 
ªsu…
) {

956 
UDS_SUCCESS
:

957 
ªc‹d
->
vútuÆCh≠ãr
 = virtualChapter;

958 
ªc‹d
->
isCﬁlisi⁄
 =Ñec‹d->
dñèE¡ry
.isCollision;

959 
ªc‹d
->
isFound
 = 
åue
;

961 
UDS_OVERFLOW
:

962 
	`logW¨nögWôhSåögEº‹
(
UDS_OVERFLOW
,

965 
	`logDñèIndexE¡ry
(&
ªc‹d
->
dñèE¡ry
);

970  
ªsu…
;

971 
	}
}

974 
INLINE
 
	$vÆid©eRec‹d
(
Ma°îIndexRec‹d
 *
ªc‹d
)

976 i‡(
ªc‹d
->
magic
 !
ma°îIndexRec‹dMagic
) {

977  
	`logW¨nögWôhSåögEº‹
(

978 
UDS_BAD_STATE
, "bad magicÇumber in master indexÑecord");

980 i‡(!
ªc‹d
->
isFound
) {

981  
	`logW¨nögWôhSåögEº‹
(
UDS_BAD_STATE
,

984  
UDS_SUCCESS
;

985 
	}
}

995 
	$ªmoveMa°îIndexRec‹d
(
Ma°îIndexRec‹d
 *
ªc‹d
)

997 
ªsu…
 = 
	`vÆid©eRec‹d
(
ªc‹d
);

998 i‡(
ªsu…
 !
UDS_SUCCESS
) {

999  
ªsu…
;

1002 
ªc‹d
->
magic
 = 
badMagic
;

1003 i‡(
	`u∆ikñy
(
ªc‹d
->
muãx
 !
NULL
)) {

1004 
	`lockMuãx
(
ªc‹d
->
muãx
);

1006 
ªsu…
 = 
	`ªmoveDñèIndexE¡ry
(&
ªc‹d
->
dñèE¡ry
);

1007 i‡(
	`u∆ikñy
(
ªc‹d
->
muãx
 !
NULL
)) {

1008 
	`u∆ockMuãx
(
ªc‹d
->
muãx
);

1010  
ªsu…
;

1011 
	}
}

1022 
	$£tMa°îIndexRec‹dCh≠ãr
(
Ma°îIndexRec‹d
 *
ªc‹d
,

1023 
uöt64_t
 
vútuÆCh≠ãr
)

1025 c⁄° 
Ma°îIndex5
 *
mi5
 = 
	`c⁄èöî_of
(
ªc‹d
->
ma°îIndex
, MasterIndex5,

1026 
comm⁄
);

1027 
ªsu…
 = 
	`vÆid©eRec‹d
(
ªc‹d
);

1028 i‡(
ªsu…
 !
UDS_SUCCESS
) {

1029  
ªsu…
;

1031 i‡(!
	`isVútuÆCh≠ãrIndexed
(
ªc‹d
, 
vútuÆCh≠ãr
)) {

1032 c⁄° 
Ma°îIndexZ⁄e
 *
ma°îZ⁄e
 = 
	`gëMa°îZ⁄e
(
ªc‹d
);

1033  
	`logW¨nögWôhSåögEº‹
(
UDS_INVALID_ARGUMENT
,

1034 "ˇ¬Ÿ së ch≠ã∏numbî %" 
PRIu64


1035 "Åh© i†ouào‡thêvÆidÑ™gê%" 
PRIu64


1036 "Åÿ%" 
PRIu64
,

1037 
vútuÆCh≠ãr
,

1038 
ma°îZ⁄e
->
vútuÆCh≠ãrLow
,

1039 
ma°îZ⁄e
->
vútuÆCh≠ãrHigh
);

1041 i‡(
	`u∆ikñy
(
ªc‹d
->
muãx
 !
NULL
)) {

1042 
	`lockMuãx
(
ªc‹d
->
muãx
);

1044 
ªsu…
 = 
	`£tDñèE¡ryVÆue
(&
ªc‹d
->
dñèE¡ry
,

1045 
	`c⁄vîtVútuÆToIndex
(
mi5
, 
vútuÆCh≠ãr
));

1046 i‡(
	`u∆ikñy
(
ªc‹d
->
muãx
 !
NULL
)) {

1047 
	`u∆ockMuãx
(
ªc‹d
->
muãx
);

1049 i‡(
ªsu…
 !
UDS_SUCCESS
) {

1050  
ªsu…
;

1052 
ªc‹d
->
vútuÆCh≠ãr
 = virtualChapter;

1053  
UDS_SUCCESS
;

1054 
	}
}

1064 
size_t
 
	$gëMa°îIndexMem‹yU£d_005
(c⁄° 
Ma°îIndex
 *
ma°îIndex
)

1066 c⁄° 
Ma°îIndex5
 *
mi5
 = 
	`c⁄°_c⁄èöî_of
(
ma°îIndex
, MasterIndex5,

1067 
comm⁄
);

1068 
uöt64_t
 
bôs
 = 
	`gëDñèIndexDli°BôsU£d
(&
mi5
->
dñèIndex
);

1069  (
bôs
 + 
CHAR_BIT
 - 1) / CHAR_BIT;

1070 
	}
}

1082 
	$gëMa°îIndexSèts_005
(c⁄° 
Ma°îIndex
 *
ma°îIndex
,

1083 
Ma°îIndexSèts
 *
dí£
,

1084 
Ma°îIndexSèts
 *
•¨£
)

1086 c⁄° 
Ma°îIndex5
 *
mi5
 = 
	`c⁄°_c⁄èöî_of
(
ma°îIndex
, MasterIndex5,

1087 
comm⁄
);

1088 
DñèIndexSèts
 
dis
;

1089 
	`gëDñèIndexSèts
(&
mi5
->
dñèIndex
, &
dis
);

1090 
dí£
->
mem‹yAŒoˇãd
 = (
dis
.memoryAllocated

1091 + (
Ma°îIndex5
)

1092 + 
mi5
->
numDñèLi°s
 * (
uöt64_t
)

1093 + 
mi5
->
numZ⁄es
 * (
Ma°îIndexZ⁄e
));

1094 
dí£
->
ªbÆ™˚Time
 = 
dis
.rebalanceTime;

1095 
dí£
->
ªbÆ™˚Cou¡
 = 
dis
.rebalanceCount;

1096 
dí£
->
ªc‹dCou¡
 = 
dis
.recordCount;

1097 
dí£
->
cﬁlisi⁄Cou¡
 = 
dis
.collisionCount;

1098 
dí£
->
disˇrdCou¡
 = 
dis
.discardCount;

1099 
dí£
->
ovîÊowCou¡
 = 
dis
.overflowCount;

1100 
dí£
->
numLi°s
 = 
dis
.numLists;

1101 
dí£
->
óæyFlushes
 = 0;

1102 
z
 = 0; z < 
mi5
->
numZ⁄es
; z++) {

1103 
dí£
->
óæyFlushes
 +
mi5
->
ma°îZ⁄es
[
z
].
numE¨lyFlushes
;

1105 
	`mem£t
(
•¨£
, 0, (
Ma°îIndexSèts
));

1106 
	}
}

1117 
boﬁ
 
isMa°îIndexSam∂e_005
(c⁄° 
Ma°îIndex
 *
ma°îIndex


1118 
__©åibuã__
((
unu£d
)),

1119 c⁄° 
UdsChunkName
 *
«me


1120 
__©åibuã__
((
unu£d
)))

1122  
	gÁl£
;

1127 
	maddªssBôs
;

1128 
	mch≠ãrBôs
;

1129 
	mmónDñè
;

1130 
	mnumDñèLi°s
;

1131 
	mnumCh≠ãrs
;

1132 
size_t
 
	mnumBôsPîCh≠ãr
;

1133 
size_t
 
	mmem‹ySize
;

1134 
size_t
 
	mèrgëFªeSize
;

1135 } 
	tP¨amëîs005
;

1138 
	$compuãMa°îIndexP¨amëîs005
(c⁄° 
C⁄figuøti⁄
 *
c⁄fig
,

1139 
P¨amëîs005
 *
∑øms
)

1141 íum { 
DELTA_LIST_SIZE
 = 256 };

1151 
möDñèLi°s
 = (
möMa°îIndexDñèLi°s


1152 ? 
möMa°îIndexDñèLi°s


1153 : 
MAX_ZONES
 * MAX_ZONES);

1155 
Geomëry
 *
geomëry
 = 
c⁄fig
->geometry;

1156 
ªc‹dsPîCh≠ãr
 = 
geomëry
->recordsPerChapter;

1157 
∑øms
->
numCh≠ãrs
 = 
geomëry
->
ch≠ãrsPîVﬁume
;

1158 
ªc‹dsPîVﬁume
 = 
ªc‹dsPîCh≠ãr
 * 
∑øms
->
numCh≠ãrs
;

1159 
numAddªs£s
 = 
c⁄fig
->
ma°îIndexMónDñè
 * 
DELTA_LIST_SIZE
;

1160 
∑øms
->
numDñèLi°s


1161 
	`maxUöt
(
ªc‹dsPîVﬁume
 / 
DELTA_LIST_SIZE
, 
möDñèLi°s
);

1162 
∑øms
->
addªssBôs
 = 
	`compuãBôs
(
numAddªs£s
 - 1);

1163 
∑øms
->
ch≠ãrBôs
 = 
	`compuãBôs
’¨ams->
numCh≠ãrs
 - 1);

1165 i‡((Ë
∑øms
->
numDñèLi°s
 !=Öarams->numDeltaLists) {

1166  
	`logW¨nögWôhSåögEº‹
(
UDS_INVALID_ARGUMENT
,

1169 
∑øms
->
numDñèLi°s
);

1171 i‡(
∑øms
->
addªssBôs
 > 31) {

1172  
	`logW¨nögWôhSåögEº‹
(
UDS_INVALID_ARGUMENT
,

1175 
∑øms
->
addªssBôs
);

1177 i‡(
geomëry
->
•¨£Ch≠ãrsPîVﬁume
 > 0) {

1178  
	`logW¨nögWôhSåögEº‹
(
UDS_INVALID_ARGUMENT
,

1181 
geomëry
->
•¨£Ch≠ãrsPîVﬁume
);

1183 i‡(
ªc‹dsPîCh≠ãr
 == 0) {

1184  
	`logW¨nögWôhSåögEº‹
(
UDS_INVALID_ARGUMENT
,

1187 
ªc‹dsPîCh≠ãr
);

1189 i‡(
∑øms
->
numCh≠ãrs
 == 0) {

1190  
	`logW¨nögWôhSåögEº‹
(
UDS_INVALID_ARGUMENT
,

1193 
∑øms
->
numCh≠ãrs
);

1215 
övÆidCh≠ãrs
 = 
	`maxUöt
(
∑øms
->
numCh≠ãrs
 / 256, 2);

1216 
ch≠ãrsInMa°îIndex
 = 
∑øms
->
numCh≠ãrs
 + 
övÆidCh≠ãrs
;

1217 
íåõsInMa°îIndex


1218 
ªc‹dsPîCh≠ãr
 * 
ch≠ãrsInMa°îIndex
;

1220 
addªssS∑n
 = 
∑øms
->
numDñèLi°s
 <<Ö¨ams->
addªssBôs
;

1221 
∑øms
->
mónDñè
 = 
addªssS∑n
 / 
íåõsInMa°îIndex
;

1223 
∑øms
->
numBôsPîCh≠ãr
 = 
	`gëDñèMem‹ySize
(
ªc‹dsPîCh≠ãr
,

1224 
∑øms
->
mónDñè
,

1225 
∑øms
->
ch≠ãrBôs
);

1227 
size_t
 
numBôsPîIndex
 = 
∑øms
->
numBôsPîCh≠ãr
 * 
ch≠ãrsInMa°îIndex
;

1228 
size_t
 
ex≥˘edIndexSize
 = 
numBôsPîIndex
 / 
CHAR_BIT
;

1235 
∑øms
->
mem‹ySize
 = 
ex≥˘edIndexSize
 * 106 / 100;

1237 
∑øms
->
èrgëFªeSize
 = 
ex≥˘edIndexSize
 / 20;

1238  
UDS_SUCCESS
;

1239 
	}
}

1242 
	$compuãMa°îIndexSaveByãs005
(c⁄° 
C⁄figuøti⁄
 *
c⁄fig
,

1243 
size_t
 *
numByãs
)

1245 
P¨amëîs005
 
∑øms
 = { .
addªssBôs
 = 0 };

1246 
ªsu…
 = 
	`compuãMa°îIndexP¨amëîs005
(
c⁄fig
, &
∑øms
);

1247 i‡(
ªsu…
 !
UDS_SUCCESS
) {

1248  
ªsu…
;

1252 *
numByãs
 = ((
mi005_d©a
)

1253 + 
∑øms
.
numDñèLi°s
 * (
uöt64_t
)

1254 + 
	`compuãDñèIndexSaveByãs
(
∑øms
.
numDñèLi°s
,

1255 
∑øms
.
mem‹ySize
));

1256  
UDS_SUCCESS
;

1257 
	}
}

1260 
	$makeMa°îIndex005
(c⁄° 
C⁄figuøti⁄
 *
c⁄fig
, 
numZ⁄es
,

1261 
uöt64_t
 
vﬁumeN⁄˚
, 
Ma°îIndex
 **
ma°îIndex
)

1263 
P¨amëîs005
 
∑øms
 = { .
addªssBôs
 = 0 };

1264 
ªsu…
 = 
	`compuãMa°îIndexP¨amëîs005
(
c⁄fig
, &
∑øms
);

1265 i‡(
ªsu…
 !
UDS_SUCCESS
) {

1266  
ªsu…
;

1269 
Ma°îIndex5
 *
mi5
;

1270 
ªsu…
 = 
	`ALLOCATE
(1, 
Ma°îIndex5
, "ma°î index", &
mi5
);

1271 i‡(
ªsu…
 !
UDS_SUCCESS
) {

1272 *
ma°îIndex
 = 
NULL
;

1273  
ªsu…
;

1276 
mi5
->
comm⁄
.
ab‹tRe°‹ögMa°îIndex
 = 
ab‹tRe°‹ögMa°îIndex_005
;

1277 
mi5
->
comm⁄
.
ab‹tSavögMa°îIndex
 = 
ab‹tSavögMa°îIndex_005
;

1278 
mi5
->
comm⁄
.
föishSavögMa°îIndex
 = 
föishSavögMa°îIndex_005
;

1279 
mi5
->
comm⁄
.
‰ìMa°îIndex
 = 
‰ìMa°îIndex_005
;

1280 
mi5
->
comm⁄
.
gëMa°îIndexMem‹yU£d
 = 
gëMa°îIndexMem‹yU£d_005
;

1281 
mi5
->
comm⁄
.
gëMa°îIndexRec‹d
 = 
gëMa°îIndexRec‹d_005
;

1282 
mi5
->
comm⁄
.
gëMa°îIndexSèts
 = 
gëMa°îIndexSèts_005
;

1283 
mi5
->
comm⁄
.
gëMa°îIndexZ⁄e
 = 
gëMa°îIndexZ⁄e_005
;

1284 
mi5
->
comm⁄
.
isMa°îIndexSam∂e
 = 
isMa°îIndexSam∂e_005
;

1285 
mi5
->
comm⁄
.
isRe°‹ögMa°îIndexD⁄e
 = 
isRe°‹ögMa°îIndexD⁄e_005
;

1286 
mi5
->
comm⁄
.
isSavögMa°îIndexD⁄e
 = 
isSavögMa°îIndexD⁄e_005
;

1287 
mi5
->
comm⁄
.
lookupMa°îIndexName
 = 
lookupMa°îIndexName_005
;

1288 
mi5
->
comm⁄
.
lookupMa°îIndexSam∂edName
 = 
lookupMa°îIndexSam∂edName_005
;

1289 
mi5
->
comm⁄
.
ª°‹eDñèLi°ToMa°îIndex
 = 
ª°‹eDñèLi°ToMa°îIndex_005
;

1290 
mi5
->
comm⁄
.
£tMa°îIndexO≥nCh≠ãr
 = 
£tMa°îIndexO≥nCh≠ãr_005
;

1291 
mi5
->
comm⁄
.
£tMa°îIndexTag
 = 
£tMa°îIndexTag_005
;

1292 
mi5
->
comm⁄
.
£tMa°îIndexZ⁄eO≥nCh≠ãr
 = 
£tMa°îIndexZ⁄eO≥nCh≠ãr_005
;

1293 
mi5
->
comm⁄
.
°¨tRe°‹ögMa°îIndex
 = 
°¨tRe°‹ögMa°îIndex_005
;

1294 
mi5
->
comm⁄
.
°¨tSavögMa°îIndex
 = 
°¨tSavögMa°îIndex_005
;

1296 
mi5
->
addªssBôs
 = 
∑øms
.addressBits;

1297 
mi5
->
addªssMask
 = (1u << 
∑øms
.
addªssBôs
) - 1;

1298 
mi5
->
ch≠ãrBôs
 = 
∑øms
.chapterBits;

1299 
mi5
->
ch≠ãrMask
 = (1u << 
∑øms
.
ch≠ãrBôs
) - 1;

1300 
mi5
->
numCh≠ãrs
 = 
∑øms
.numChapters;

1301 
mi5
->
numDñèLi°s
 = 
∑øms
.numDeltaLists;

1302 
mi5
->
numZ⁄es
 =ÇumZones;

1303 
mi5
->
ch≠ãrZ⁄eBôs
 = 
∑øms
.
numBôsPîCh≠ãr
 / 
numZ⁄es
;

1304 
mi5
->
vﬁumeN⁄˚
 = volumeNonce;

1306 
ªsu…
 = 
	`öôülizeDñèIndex
(&
mi5
->
dñèIndex
, 
numZ⁄es
,

1307 
∑øms
.
numDñèLi°s
,Ö¨ams.
mónDñè
,

1308 
∑øms
.
ch≠ãrBôs
,Ö¨ams.
mem‹ySize
);

1309 i‡(
ªsu…
 =
UDS_SUCCESS
) {

1310 
mi5
->
maxZ⁄eBôs
 = ((
	`gëDñèIndexDli°BôsAŒoˇãd
(&mi5->
dñèIndex
)

1311 - 
∑øms
.
èrgëFªeSize
 * 
CHAR_BIT
)

1312 / 
numZ⁄es
);

1317 i‡(
ªsu…
 =
UDS_SUCCESS
) {

1318 
ªsu…
 = 
	`ALLOCATE
(
∑øms
.
numDñèLi°s
, 
uöt64_t
,

1319 "fú° ch≠ã∏tÿÊush", &
mi5
->
ÊushCh≠ãrs
);

1324 i‡(
ªsu…
 =
UDS_SUCCESS
) {

1325 
ªsu…
 = 
	`ALLOCATE
(
numZ⁄es
, 
Ma°îIndexZ⁄e
, "master index zones",

1326 &
mi5
->
ma°îZ⁄es
);

1329 i‡(
ªsu…
 =
UDS_SUCCESS
) {

1330 *
ma°îIndex
 = &
mi5
->
comm⁄
;

1332 
	`‰ìMa°îIndex_005
(&
mi5
->
comm⁄
);

1333 *
ma°îIndex
 = 
NULL
;

1335  
ªsu…
;

1336 
	}
}

	@uds/masterIndex005.h

22 #i‚de‡
MASTERINDEX005_H


23 
	#MASTERINDEX005_H
 1

	)

25 
	~"ma°îIndexOps.h
"

36 
	$makeMa°îIndex005
(c⁄° 
C⁄figuøti⁄
 *
c⁄fig
, 
numZ⁄es
,

37 
uöt64_t
 
vﬁumeN⁄˚
, 
Ma°îIndex
 **
ma°îIndex
)

38 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

49 
	$compuãMa°îIndexSaveByãs005
(c⁄° 
C⁄figuøti⁄
 *
c⁄fig
,

50 
size_t
 *
numByãs
)

51 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

	@uds/masterIndex006.c

21 
	~"ma°îIndex006.h
"

23 
	~"compûî.h
"

24 
	~"îr‹s.h
"

25 
	~"hashUtûs.h
"

26 
	~"loggî.h
"

27 
	~"ma°îIndex005.h
"

28 
	~"mem‹yAŒoc.h
"

29 
	~"≥rmas£π.h
"

30 
	~"thªads.h
"

31 
	~"uds.h
"

51 
__©åibuã__
((
	tÆig√d
(
	tCACHE_LINE_BYTES
))Ë
	tma°îIndexZ⁄e
 {

52 
Muãx
 
hookMuãx
;

53 
	}
} 
	tMa°îIndexZ⁄e
;

56 
Ma°îIndex
 
	mcomm⁄
;

57 
	m•¨£Sam∂eR©e
;

58 
	mnumZ⁄es
;

59 
Ma°îIndex
 *
	mmiN⁄Hook
;

60 
Ma°îIndex
 *
	mmiHook
;

61 
Ma°îIndexZ⁄e
 *
	mma°îZ⁄es
;

62 } 
	tMa°îIndex6
;

72 
INLINE
 
boﬁ
 
	$isMa°îIndexSam∂e_006
(c⁄° 
Ma°îIndex
 *
ma°îIndex
,

73 c⁄° 
UdsChunkName
 *
«me
)

75 c⁄° 
Ma°îIndex6
 *
mi6
 = 
	`c⁄°_c⁄èöî_of
(
ma°îIndex
, MasterIndex6,

76 
comm⁄
);

77  (
	`exåa˘Sam∂ögByãs
(
«me
Ë% 
mi6
->
•¨£Sam∂eR©e
) == 0;

78 
	}
}

89 
INLINE
 
Ma°îIndex
 *
	$gëSubIndex
(c⁄° 
Ma°îIndex
 *
ma°îIndex
,

90 c⁄° 
UdsChunkName
 *
«me
)

92 c⁄° 
Ma°îIndex6
 *
mi6
 = 
	`c⁄°_c⁄èöî_of
(
ma°îIndex
, MasterIndex6,

93 
comm⁄
);

94  (
	`isMa°îIndexSam∂e_006
(
ma°îIndex
, 
«me
)

95 ? 
mi6
->
miHook


96 : 
mi6
->
miN⁄Hook
);

97 
	}
}

105 
	$‰ìMa°îIndex_006
(
Ma°îIndex
 *
ma°îIndex
)

107 i‡(
ma°îIndex
 !
NULL
) {

108 
Ma°îIndex6
 *
mi6
 = 
	`c⁄èöî_of
(
ma°îIndex
, Ma°îIndex6, 
comm⁄
);

109 i‡(
mi6
->
ma°îZ⁄es
 !
NULL
) {

110 
z⁄e
 = 0; z⁄ê< 
mi6
->
numZ⁄es
; zone++) {

111 
	`de°royMuãx
(&
mi6
->
ma°îZ⁄es
[
z⁄e
].
hookMuãx
);

113 
	`FREE
(
mi6
->
ma°îZ⁄es
);

114 
mi6
->
ma°îZ⁄es
 = 
NULL
;

116 i‡(
mi6
->
miN⁄Hook
 !
NULL
) {

117 
	`‰ìMa°îIndex
(
mi6
->
miN⁄Hook
);

118 
mi6
->
miN⁄Hook
 = 
NULL
;

120 i‡(
mi6
->
miHook
 !
NULL
) {

121 
	`‰ìMa°îIndex
(
mi6
->
miHook
);

122 
mi6
->
miHook
 = 
NULL
;

124 
	`FREE
(
ma°îIndex
);

126 
	}
}

134 íum { 
	mMAGIC_SIZE
 = 8 };

135 c⁄° 
	gMAGIC_MI_START
[] = "MI6-0001";

137 
	smi006_d©a
 {

138 
	mmagic
[
MAGIC_SIZE
];

139 
	m•¨£Sam∂eR©e
;

149 
£tMa°îIndexTag_006
(
Ma°îIndex
 *
ma°îIndex


150 
__©åibuã__
((
unu£d
)),

151 
byã
 
èg
 
__©åibuã__
((
unu£d
)))

165 
	$°¨tSavögMa°îIndex_006
(c⁄° 
Ma°îIndex
 *
ma°îIndex
,

166 
z⁄eNumbî
,

167 
Buf„ªdWrôî
 *
buf„ªdWrôî
)

169 c⁄° 
Ma°îIndex6
 *
mi6
 = 
	`c⁄°_c⁄èöî_of
(
ma°îIndex
, MasterIndex6,

170 
comm⁄
);

171 
mi006_d©a
 
hódî
;

172 
	`mem£t
(&
hódî
, 0, (header));

173 
	`mem˝y
(
hódî
.
magic
, 
MAGIC_MI_START
, 
MAGIC_SIZE
);

174 
hódî
.
•¨£Sam∂eR©e
 = 
mi6
->sparseSampleRate;

176 
ªsu…
 = 
	`wrôeToBuf„ªdWrôî
(
buf„ªdWrôî
, (c⁄° 
byã
 *Ë&
hódî
,

177 (
hódî
));

178 i‡(
ªsu…
 !
UDS_SUCCESS
) {

179 
	`logW¨nögWôhSåögEº‹
(
ªsu…
, "failedÅo write master index header");

180  
ªsu…
;

183 
ªsu…
 = 
	`°¨tSavögMa°îIndex
(
mi6
->
miN⁄Hook
, 
z⁄eNumbî
, 
buf„ªdWrôî
);

184 i‡(
ªsu…
 !
UDS_SUCCESS
) {

185  
ªsu…
;

188 
ªsu…
 = 
	`°¨tSavögMa°îIndex
(
mi6
->
miHook
, 
z⁄eNumbî
, 
buf„ªdWrôî
);

189 i‡(
ªsu…
 !
UDS_SUCCESS
) {

190  
ªsu…
;

192  
UDS_SUCCESS
;

193 
	}
}

206 
boﬁ
 
	$isSavögMa°îIndexD⁄e_006
(c⁄° 
Ma°îIndex
 *
ma°îIndex
,

207 
z⁄eNumbî
)

209 c⁄° 
Ma°îIndex6
 *
mi6
 = 
	`c⁄°_c⁄èöî_of
(
ma°îIndex
, MasterIndex6,

210 
comm⁄
);

211  (
	`isSavögMa°îIndexD⁄e
(
mi6
->
miN⁄Hook
, 
z⁄eNumbî
)

212 && 
	`isSavögMa°îIndexD⁄e
(
mi6
->
miHook
, 
z⁄eNumbî
));

213 
	}
}

226 
	$föishSavögMa°îIndex_006
(c⁄° 
Ma°îIndex
 *
ma°îIndex
,

227 
z⁄eNumbî
)

229 c⁄° 
Ma°îIndex6
 *
mi6
 = 
	`c⁄°_c⁄èöî_of
(
ma°îIndex
, MasterIndex6,

230 
comm⁄
);

231 
ªsu…
 = 
	`föishSavögMa°îIndex
(
mi6
->
miN⁄Hook
, 
z⁄eNumbî
);

232 i‡(
ªsu…
 =
UDS_SUCCESS
) {

233 
ªsu…
 = 
	`föishSavögMa°îIndex
(
mi6
->
miHook
, 
z⁄eNumbî
);

235  
ªsu…
;

236 
	}
}

248 
	$ab‹tSavögMa°îIndex_006
(c⁄° 
Ma°îIndex
 *
ma°îIndex
,

249 
z⁄eNumbî
)

251 c⁄° 
Ma°îIndex6
 *
mi6
 = 
	`c⁄°_c⁄èöî_of
(
ma°îIndex
, MasterIndex6,

252 
comm⁄
);

253 
ªsu…
 = 
	`ab‹tSavögMa°îIndex
(
mi6
->
miN⁄Hook
, 
z⁄eNumbî
);

254 
ªsu…2
 = 
	`ab‹tSavögMa°îIndex
(
mi6
->
miHook
, 
z⁄eNumbî
);

255 i‡(
ªsu…
 =
UDS_SUCCESS
) {

256 
ªsu…
 = 
ªsu…2
;

258  
ªsu…
;

259 
	}
}

271 
	$°¨tRe°‹ögMa°îIndex_006
(
Ma°îIndex
 *
ma°îIndex
,

272 
Buf„ªdRódî
 **
buf„ªdRódîs
,

273 
numRódîs
)

275 
Ma°îIndex6
 *
mi6
 = 
	`c⁄èöî_of
(
ma°îIndex
, Ma°îIndex6, 
comm⁄
);

276 
ªsu…
 = 
	`ASSERT_WITH_ERROR_CODE
(
ma°îIndex
 !
NULL
, 
UDS_BAD_STATE
,

278 i‡(
ªsu…
 !
UDS_SUCCESS
) {

279  
ªsu…
;

282 
i
 = 0; i < 
numRódîs
; i++) {

283 
mi006_d©a
 
hódî
;

284 
ªsu…
 = 
	`ªadFromBuf„ªdRódî
(
buf„ªdRódîs
[
i
], (
byã
 *Ë&
hódî
,

285 (
hódî
));

286 i‡(
ªsu…
 !
UDS_SUCCESS
) {

287  
	`logW¨nögWôhSåögEº‹
(
ªsu…
,

290 i‡(
	`memcmp
(
hódî
.
magic
, 
MAGIC_MI_START
, 
MAGIC_SIZE
) != 0) {

291  
	`logW¨nögWôhSåögEº‹
(
UDS_CORRUPT_COMPONENT
,

295 i‡(
i
 == 0) {

296 
mi6
->
•¨£Sam∂eR©e
 = 
hódî
.sparseSampleRate;

297 } i‡(
mi6
->
•¨£Sam∂eR©e
 !
hódî
.sparseSampleRate) {

298 
	`logW¨nögWôhSåögEº‹
(
UDS_CORRUPT_COMPONENT
,

301 
mi6
->
•¨£Sam∂eR©e
,

302 
hódî
.
•¨£Sam∂eR©e
);

303  
UDS_CORRUPT_COMPONENT
;

307 
ªsu…
 = 
	`°¨tRe°‹ögMa°îIndex
(
mi6
->
miN⁄Hook
, 
buf„ªdRódîs
,

308 
numRódîs
);

309 i‡(
ªsu…
 !
UDS_SUCCESS
) {

310  
ªsu…
;

312  
	`°¨tRe°‹ögMa°îIndex
(
mi6
->
miHook
, 
buf„ªdRódîs
, 
numRódîs
);

313 
	}
}

324 
boﬁ
 
	$isRe°‹ögMa°îIndexD⁄e_006
(c⁄° 
Ma°îIndex
 *
ma°îIndex
)

326 c⁄° 
Ma°îIndex6
 *
mi6
 = 
	`c⁄°_c⁄èöî_of
(
ma°îIndex
, MasterIndex6,

327 
comm⁄
);

328  (
	`isRe°‹ögMa°îIndexD⁄e
(
mi6
->
miN⁄Hook
)

329 && 
	`isRe°‹ögMa°îIndexD⁄e
(
mi6
->
miHook
));

330 
	}
}

342 
	$ª°‹eDñèLi°ToMa°îIndex_006
(
Ma°îIndex
 *
ma°îIndex
,

343 c⁄° 
DñèLi°SaveInfo
 *
dlsi
,

344 c⁄° 
byã
 
d©a
[
DELTA_LIST_MAX_BYTE_COUNT
])

346 
Ma°îIndex6
 *
mi6
 = 
	`c⁄èöî_of
(
ma°îIndex
, Ma°îIndex6, 
comm⁄
);

347 
ªsu…
 = 
	`ª°‹eDñèLi°ToMa°îIndex
(
mi6
->
miN⁄Hook
, 
dlsi
, 
d©a
);

348 i‡(
ªsu…
 !
UDS_SUCCESS
) {

349 
ªsu…
 = 
	`ª°‹eDñèLi°ToMa°îIndex
(
mi6
->
miHook
, 
dlsi
, 
d©a
);

351  
ªsu…
;

352 
	}
}

360 
	$ab‹tRe°‹ögMa°îIndex_006
(
Ma°îIndex
 *
ma°îIndex
)

362 
Ma°îIndex6
 *
mi6
 = 
	`c⁄èöî_of
(
ma°îIndex
, Ma°îIndex6, 
comm⁄
);

363 
	`ab‹tRe°‹ögMa°îIndex
(
mi6
->
miN⁄Hook
);

364 
	`ab‹tRe°‹ögMa°îIndex
(
mi6
->
miHook
);

365 
	}
}

377 
	$£tMa°îIndexZ⁄eO≥nCh≠ãr_006
(
Ma°îIndex
 *
ma°îIndex
,

378 
z⁄eNumbî
,

379 
uöt64_t
 
vútuÆCh≠ãr
)

381 
Ma°îIndex6
 *
mi6
 = 
	`c⁄èöî_of
(
ma°îIndex
, Ma°îIndex6, 
comm⁄
);

382 
	`£tMa°îIndexZ⁄eO≥nCh≠ãr
(
mi6
->
miN⁄Hook
, 
z⁄eNumbî
, 
vútuÆCh≠ãr
);

386 
Muãx
 *
muãx
 = &
mi6
->
ma°îZ⁄es
[
z⁄eNumbî
].
hookMuãx
;

387 
	`lockMuãx
(
muãx
);

388 
	`£tMa°îIndexZ⁄eO≥nCh≠ãr
(
mi6
->
miHook
, 
z⁄eNumbî
, 
vútuÆCh≠ãr
);

389 
	`u∆ockMuãx
(
muãx
);

390 
	}
}

400 
	$£tMa°îIndexO≥nCh≠ãr_006
(
Ma°îIndex
 *
ma°îIndex
,

401 
uöt64_t
 
vútuÆCh≠ãr
)

403 
Ma°îIndex6
 *
mi6
 = 
	`c⁄èöî_of
(
ma°îIndex
, Ma°îIndex6, 
comm⁄
);

404 
z⁄e
 = 0; z⁄ê< 
mi6
->
numZ⁄es
; zone++) {

405 
	`£tMa°îIndexZ⁄eO≥nCh≠ãr_006
(
ma°îIndex
, 
z⁄e
, 
vútuÆCh≠ãr
);

407 
	}
}

418 
	$gëMa°îIndexZ⁄e_006
(c⁄° 
Ma°îIndex
 *
ma°îIndex
,

419 c⁄° 
UdsChunkName
 *
«me
)

421  
	`gëMa°îIndexZ⁄e
(
	`gëSubIndex
(
ma°îIndex
, 
«me
),Çame);

422 
	}
}

435 
	$lookupMa°îIndexName_006
(c⁄° 
Ma°îIndex
 *
ma°îIndex
,

436 c⁄° 
UdsChunkName
 *
«me
,

437 
Ma°îIndexTrüge
 *
åüge
)

439 c⁄° 
Ma°îIndex6
 *
mi6
 = 
	`c⁄°_c⁄èöî_of
(
ma°îIndex
, MasterIndex6,

440 
comm⁄
);

441 
åüge
->
isSam∂e
 = 
	`isMa°îIndexSam∂e_006
(
ma°îIndex
, 
«me
);

442 
åüge
->
öSam∂edCh≠ãr
 = 
Ál£
;

443 
åüge
->
z⁄e
 = 
	`gëMa°îIndexZ⁄e_006
(
ma°îIndex
, 
«me
);

444 
ªsu…
 = 
UDS_SUCCESS
;

445 i‡(
åüge
->
isSam∂e
) {

446 
Muãx
 *
muãx
 = &
mi6
->
ma°îZ⁄es
[
åüge
->
z⁄e
].
hookMuãx
;

447 
	`lockMuãx
(
muãx
);

448 
ªsu…
 = 
	`lookupMa°îIndexSam∂edName
(
mi6
->
miHook
, 
«me
, 
åüge
);

449 
	`u∆ockMuãx
(
muãx
);

451  
ªsu…
;

452 
	}
}

468 
lookupMa°îIndexSam∂edName_006
(c⁄° 
Ma°îIndex
 *
ma°îIndex


469 
__©åibuã__
((
unu£d
)),

470 c⁄° 
UdsChunkName
 *
«me


471 
__©åibuã__
((
unu£d
)),

472 
Ma°îIndexTrüge
 *
åüge


473 
__©åibuã__
((
unu£d
)))

475  
ASSERT_WITH_ERROR_CODE
(
Ál£
, 
UDS_BAD_STATE
,

476 "%†shouldÇŸ bêˇŒed", 
__func__
);

506 
	$gëMa°îIndexRec‹d_006
(
Ma°îIndex
 *
ma°îIndex
,

507 c⁄° 
UdsChunkName
 *
«me
,

508 
Ma°îIndexRec‹d
 *
ªc‹d
)

510 c⁄° 
Ma°îIndex6
 *
mi6
 = 
	`c⁄°_c⁄èöî_of
(
ma°îIndex
, MasterIndex6,

511 
comm⁄
);

512 
ªsu…
;

513 i‡(
	`isMa°îIndexSam∂e_006
(
ma°îIndex
, 
«me
)) {

520 
z⁄e
 = 
	`gëMa°îIndexZ⁄e
(
mi6
->
miHook
, 
«me
);

521 
Muãx
 *
muãx
 = &
mi6
->
ma°îZ⁄es
[
z⁄e
].
hookMuãx
;

522 
	`lockMuãx
(
muãx
);

523 
ªsu…
 = 
	`gëMa°îIndexRec‹d
(
mi6
->
miHook
, 
«me
, 
ªc‹d
);

524 
	`u∆ockMuãx
(
muãx
);

527 
ªc‹d
->
muãx
 = mutex;

529 
ªsu…
 = 
	`gëMa°îIndexRec‹d
(
mi6
->
miN⁄Hook
, 
«me
, 
ªc‹d
);

531  
ªsu…
;

532 
	}
}

542 
size_t
 
	$gëMa°îIndexMem‹yU£d_006
(c⁄° 
Ma°îIndex
 *
ma°îIndex
)

544 c⁄° 
Ma°îIndex6
 *
mi6
 = 
	`c⁄°_c⁄èöî_of
(
ma°îIndex
, MasterIndex6,

545 
comm⁄
);

546  (
	`gëMa°îIndexMem‹yU£d
(
mi6
->
miN⁄Hook
)

547 + 
	`gëMa°îIndexMem‹yU£d
(
mi6
->
miHook
));

548 
	}
}

560 
	$gëMa°îIndexSèts_006
(c⁄° 
Ma°îIndex
 *
ma°îIndex
,

561 
Ma°îIndexSèts
 *
dí£
,

562 
Ma°îIndexSèts
 *
•¨£
)

564 c⁄° 
Ma°îIndex6
 *
mi6
 = 
	`c⁄°_c⁄èöî_of
(
ma°îIndex
, MasterIndex6,

565 
comm⁄
);

566 
Ma°îIndexSèts
 
dummySèts
;

567 
	`gëMa°îIndexSèts
(
mi6
->
miN⁄Hook
, 
dí£
, &
dummySèts
);

568 
	`gëMa°îIndexSèts
(
mi6
->
miHook
, 
•¨£
, &
dummySèts
);

569 
	}
}

573 
C⁄figuøti⁄
 
	mhookC⁄fig
;

574 
Geomëry
 
	mhookGeomëry
;

575 
C⁄figuøti⁄
 
	mn⁄HookC⁄fig
;

576 
Geomëry
 
	mn⁄HookGeomëry
;

577 } 
	tS∂ôC⁄fig
;

580 
	$•lôC⁄figuøti⁄006
(c⁄° 
C⁄figuøti⁄
 *
c⁄fig
,

581 
S∂ôC⁄fig
 *
•lô
)

583 
ªsu…


584 
	`ASSERT_WITH_ERROR_CODE
(
c⁄fig
->
geomëry
->
•¨£Ch≠ãrsPîVﬁume
 != 0,

585 
UDS_INVALID_ARGUMENT
,

588 i‡(
ªsu…
 !
UDS_SUCCESS
) {

589  
ªsu…
;

591 
ªsu…
 = 
	`ASSERT_WITH_ERROR_CODE
(
c⁄fig
->
•¨£Sam∂eR©e
 != 0,

592 
UDS_INVALID_ARGUMENT
,

595 
c⁄fig
->
•¨£Sam∂eR©e
);

596 i‡(
ªsu…
 !
UDS_SUCCESS
) {

597  
ªsu…
;

601 
•lô
->
hookC⁄fig
 = *
c⁄fig
;

602 
•lô
->
hookGeomëry
 = *
c⁄fig
->
geomëry
;

603 
•lô
->
hookC⁄fig
.
geomëry
 = &•lô->
hookGeomëry
;

604 
•lô
->
n⁄HookC⁄fig
 = *
c⁄fig
;

605 
•lô
->
n⁄HookGeomëry
 = *
c⁄fig
->
geomëry
;

606 
•lô
->
n⁄HookC⁄fig
.
geomëry
 = &•lô->
n⁄HookGeomëry
;

608 
uöt64_t
 
ßm∂eR©e
 = 
c⁄fig
->
•¨£Sam∂eR©e
;

609 
uöt64_t
 
numCh≠ãrs
 = 
c⁄fig
->
geomëry
->
ch≠ãrsPîVﬁume
;

610 
uöt64_t
 
numS∑r£Ch≠ãrs
 = 
c⁄fig
->
geomëry
->
•¨£Ch≠ãrsPîVﬁume
;

611 
uöt64_t
 
numDí£Ch≠ãrs
 = 
numCh≠ãrs
 - 
numS∑r£Ch≠ãrs
;

612 
uöt64_t
 
ßm∂eRec‹ds
 = 
c⁄fig
->
geomëry
->
ªc‹dsPîCh≠ãr
 / 
ßm∂eR©e
;

615 
•lô
->
hookGeomëry
.
ªc‹dsPîCh≠ãr
 = 
ßm∂eRec‹ds
;

616 
•lô
->
n⁄HookGeomëry
.
ªc‹dsPîCh≠ãr
 -
ßm∂eRec‹ds
;

619 
•lô
->
hookGeomëry
.
•¨£Ch≠ãrsPîVﬁume
 = 0;

620 
•lô
->
n⁄HookGeomëry
.
•¨£Ch≠ãrsPîVﬁume
 = 0;

621 
•lô
->
n⁄HookGeomëry
.
ch≠ãrsPîVﬁume
 = 
numDí£Ch≠ãrs
;

622  
UDS_SUCCESS
;

623 
	}
}

626 
	$compuãMa°îIndexSaveByãs006
(c⁄° 
C⁄figuøti⁄
 *
c⁄fig
,

627 
size_t
 *
numByãs
)

629 
S∂ôC⁄fig
 
•lô
;

630 
ªsu…
 = 
	`•lôC⁄figuøti⁄006
(
c⁄fig
, &
•lô
);

631 i‡(
ªsu…
 !
UDS_SUCCESS
) {

632  
ªsu…
;

634 
size_t
 
hookByãs
, 
n⁄HookByãs
;

635 
ªsu…
 = 
	`compuãMa°îIndexSaveByãs005
(&
•lô
.
hookC⁄fig
, &
hookByãs
);

636 i‡(
ªsu…
 !
UDS_SUCCESS
) {

637  
ªsu…
;

639 
ªsu…
 = 
	`compuãMa°îIndexSaveByãs005
(&
•lô
.
n⁄HookC⁄fig
, &
n⁄HookByãs
);

640 i‡(
ªsu…
 !
UDS_SUCCESS
) {

641  
ªsu…
;

645 *
numByãs
 = (
mi006_d©a
Ë+ 
hookByãs
 + 
n⁄HookByãs
;

646  
UDS_SUCCESS
;

647 
	}
}

650 
	$makeMa°îIndex006
(c⁄° 
C⁄figuøti⁄
 *
c⁄fig
, 
numZ⁄es
,

651 
uöt64_t
 
vﬁumeN⁄˚
, 
Ma°îIndex
 **
ma°îIndex
)

653 
S∂ôC⁄fig
 
•lô
;

654 
ªsu…
 = 
	`•lôC⁄figuøti⁄006
(
c⁄fig
, &
•lô
);

655 i‡(
ªsu…
 !
UDS_SUCCESS
) {

656  
ªsu…
;

659 
Ma°îIndex6
 *
mi6
;

660 
ªsu…
 = 
	`ALLOCATE
(1, 
Ma°îIndex6
, "ma°î index", &
mi6
);

661 i‡(
ªsu…
 !
UDS_SUCCESS
) {

662  
ªsu…
;

665 
mi6
->
comm⁄
.
ab‹tRe°‹ögMa°îIndex
 = 
ab‹tRe°‹ögMa°îIndex_006
;

666 
mi6
->
comm⁄
.
ab‹tSavögMa°îIndex
 = 
ab‹tSavögMa°îIndex_006
;

667 
mi6
->
comm⁄
.
föishSavögMa°îIndex
 = 
föishSavögMa°îIndex_006
;

668 
mi6
->
comm⁄
.
‰ìMa°îIndex
 = 
‰ìMa°îIndex_006
;

669 
mi6
->
comm⁄
.
gëMa°îIndexMem‹yU£d
 = 
gëMa°îIndexMem‹yU£d_006
;

670 
mi6
->
comm⁄
.
gëMa°îIndexRec‹d
 = 
gëMa°îIndexRec‹d_006
;

671 
mi6
->
comm⁄
.
gëMa°îIndexSèts
 = 
gëMa°îIndexSèts_006
;

672 
mi6
->
comm⁄
.
gëMa°îIndexZ⁄e
 = 
gëMa°îIndexZ⁄e_006
;

673 
mi6
->
comm⁄
.
isMa°îIndexSam∂e
 = 
isMa°îIndexSam∂e_006
;

674 
mi6
->
comm⁄
.
isRe°‹ögMa°îIndexD⁄e
 = 
isRe°‹ögMa°îIndexD⁄e_006
;

675 
mi6
->
comm⁄
.
isSavögMa°îIndexD⁄e
 = 
isSavögMa°îIndexD⁄e_006
;

676 
mi6
->
comm⁄
.
lookupMa°îIndexName
 = 
lookupMa°îIndexName_006
;

677 
mi6
->
comm⁄
.
lookupMa°îIndexSam∂edName
 = 
lookupMa°îIndexSam∂edName_006
;

678 
mi6
->
comm⁄
.
ª°‹eDñèLi°ToMa°îIndex
 = 
ª°‹eDñèLi°ToMa°îIndex_006
;

679 
mi6
->
comm⁄
.
£tMa°îIndexO≥nCh≠ãr
 = 
£tMa°îIndexO≥nCh≠ãr_006
;

680 
mi6
->
comm⁄
.
£tMa°îIndexTag
 = 
£tMa°îIndexTag_006
;

681 
mi6
->
comm⁄
.
£tMa°îIndexZ⁄eO≥nCh≠ãr
 = 
£tMa°îIndexZ⁄eO≥nCh≠ãr_006
;

682 
mi6
->
comm⁄
.
°¨tRe°‹ögMa°îIndex
 = 
°¨tRe°‹ögMa°îIndex_006
;

683 
mi6
->
comm⁄
.
°¨tSavögMa°îIndex
 = 
°¨tSavögMa°îIndex_006
;

685 
mi6
->
numZ⁄es
 =ÇumZones;

686 
mi6
->
•¨£Sam∂eR©e
 = 
c⁄fig
->sparseSampleRate;

688 
ªsu…
 = 
	`ALLOCATE
(
numZ⁄es
, 
Ma°îIndexZ⁄e
, "master index zones",

689 &
mi6
->
ma°îZ⁄es
);

690 
z⁄e
 = 0; z⁄ê< 
numZ⁄es
; zone++) {

691 i‡(
ªsu…
 =
UDS_SUCCESS
) {

692 
ªsu…
 = 
	`öôMuãx
(&
mi6
->
ma°îZ⁄es
[
z⁄e
].
hookMuãx
);

695 i‡(
ªsu…
 !
UDS_SUCCESS
) {

696 
	`‰ìMa°îIndex_006
(&
mi6
->
comm⁄
);

697  
ªsu…
;

700 
ªsu…
 = 
	`makeMa°îIndex005
(&
•lô
.
n⁄HookC⁄fig
, 
numZ⁄es
, 
vﬁumeN⁄˚
,

701 &
mi6
->
miN⁄Hook
);

702 i‡(
ªsu…
 !
UDS_SUCCESS
) {

703 
	`‰ìMa°îIndex_006
(&
mi6
->
comm⁄
);

704  
	`logEº‹WôhSåögEº‹
(
ªsu…
,

707 
	`£tMa°îIndexTag
(
mi6
->
miN⁄Hook
, 'd');

709 
ªsu…
 = 
	`makeMa°îIndex005
(&
•lô
.
hookC⁄fig
, 
numZ⁄es
, 
vﬁumeN⁄˚
,

710 &
mi6
->
miHook
);

711 i‡(
ªsu…
 !
UDS_SUCCESS
) {

712 
	`‰ìMa°îIndex_006
(&
mi6
->
comm⁄
);

713  
	`logEº‹WôhSåögEº‹
(
ªsu…
,

716 
	`£tMa°îIndexTag
(
mi6
->
miHook
, 's');

718 *
ma°îIndex
 = &
mi6
->
comm⁄
;

719  
UDS_SUCCESS
;

720 
	}
}

	@uds/masterIndex006.h

22 #i‚de‡
MASTERINDEX006_H


23 
	#MASTERINDEX006_H
 1

	)

25 
	~"ma°îIndexOps.h
"

36 
	$makeMa°îIndex006
(c⁄° 
C⁄figuøti⁄
 *
c⁄fig
, 
numZ⁄es
,

37 
uöt64_t
 
vﬁumeN⁄˚
, 
Ma°îIndex
 **
ma°îIndex
)

38 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

49 
	$compuãMa°îIndexSaveByãs006
(c⁄° 
C⁄figuøti⁄
 *
c⁄fig
,

50 
size_t
 *
numByãs
)

51 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

	@uds/masterIndexOps.c

21 
	~"ma°îIndexOps.h
"

23 
	~"compûî.h
"

24 
	~"îr‹s.h
"

25 
	~"ödexComp⁄ít.h
"

26 
	~"loggî.h
"

27 
	~"ma°îIndex005.h
"

28 
	~"ma°îIndex006.h
"

29 
	~"mem‹yAŒoc.h
"

30 
	~"≥rmas£π.h
"

31 
	~"uds.h
"

32 
	~"z⁄e.h
"

35 
INLINE
 
boﬁ
 
	$u£sS∑r£
(c⁄° 
C⁄figuøti⁄
 *
c⁄fig
)

37  
c⁄fig
->
geomëry
->
•¨£Ch≠ãrsPîVﬁume
 > 0;

38 
	}
}

41 
	$gëMa°îIndexComböedSèts
(c⁄° 
Ma°îIndex
 *
ma°îIndex
,

42 
Ma°îIndexSèts
 *
°©s
)

44 
Ma°îIndexSèts
 
dí£
, 
•¨£
;

45 
	`gëMa°îIndexSèts
(
ma°îIndex
, &
dí£
, &
•¨£
);

46 
°©s
->
mem‹yAŒoˇãd
 = 
dí£
.mem‹yAŒoˇãd + 
•¨£
.memoryAllocated;

47 
°©s
->
ªbÆ™˚Time
 = 
dí£
.ªbÆ™˚Timê+ 
•¨£
.rebalanceTime;

48 
°©s
->
ªbÆ™˚Cou¡
 = 
dí£
.ªbÆ™˚Cou¡ + 
•¨£
.rebalanceCount;

49 
°©s
->
ªc‹dCou¡
 = 
dí£
.ªc‹dCou¡ + 
•¨£
.recordCount;

50 
°©s
->
cﬁlisi⁄Cou¡
 = 
dí£
.cﬁlisi⁄Cou¡ + 
•¨£
.collisionCount;

51 
°©s
->
disˇrdCou¡
 = 
dí£
.disˇrdCou¡ + 
•¨£
.discardCount;

52 
°©s
->
ovîÊowCou¡
 = 
dí£
.ovîÊowCou¡ + 
•¨£
.overflowCount;

53 
°©s
->
numLi°s
 = 
dí£
.numLi°†+ 
•¨£
.numLists;

54 
°©s
->
óæyFlushes
 = 
dí£
.óæyFlushe†+ 
•¨£
.earlyFlushes;

55 
	}
}

58 
	$makeMa°îIndex
(c⁄° 
C⁄figuøti⁄
 *
c⁄fig
, 
numZ⁄es
,

59 
uöt64_t
 
vﬁumeN⁄˚
, 
Ma°îIndex
 **
ma°îIndex
)

61 i‡(
	`u£sS∑r£
(
c⁄fig
)) {

62  
	`makeMa°îIndex006
(
c⁄fig
, 
numZ⁄es
, 
vﬁumeN⁄˚
, 
ma°îIndex
);

64  
	`makeMa°îIndex005
(
c⁄fig
, 
numZ⁄es
, 
vﬁumeN⁄˚
, 
ma°îIndex
);

66 
	}
}

69 
	$compuãMa°îIndexSaveBlocks
(c⁄° 
C⁄figuøti⁄
 *
c⁄fig
,

70 
size_t
 
blockSize
, 
uöt64_t
 *
blockCou¡
)

72 
size_t
 
numByãs
;

73 
ªsu…
 = (
	`u£sS∑r£
(
c⁄fig
)

74 ? 
	`compuãMa°îIndexSaveByãs006
(
c⁄fig
, &
numByãs
)

75 : 
	`compuãMa°îIndexSaveByãs005
(
c⁄fig
, &
numByãs
));

76 i‡(
ªsu…
 !
UDS_SUCCESS
) {

77  
ªsu…
;

79 
numByãs
 +(
DñèLi°SaveInfo
);

80 *
blockCou¡
 = (
numByãs
 + 
blockSize
 - 1Ë/ blockSizê+ 
MAX_ZONES
;

81  
UDS_SUCCESS
;

82 
	}
}

85 
	$ªadMa°îIndex
(
Comp⁄ítP‹èl
 *
p‹èl
)

87 
numZ⁄es
 = 0;

88 
ªsu…
 = 
	`cou¡Comp⁄íts
(
p‹èl
, &
numZ⁄es
);

89 i‡(
ªsu…
 !
UDS_SUCCESS
) {

90  
ªsu…
;

92 
Ma°îIndex
 *
ma°îIndex
 = 
	`comp⁄ítC⁄ãxtF‹P‹èl
(
p‹èl
);

93 
Buf„ªdRódî
 *
ªadîs
[
numZ⁄es
];

94 
z
 = 0; z < 
numZ⁄es
; ++z) {

95 
ªsu…
 = 
	`gëBuf„ªdRódî
(
p‹èl
, 
z
, &
ªadîs
[z]);

96 i‡(
ªsu…
 !
UDS_SUCCESS
) {

97  
	`logEº‹WôhSåögEº‹
(
ªsu…
,

98 "ˇ¬ŸÑód comp⁄íàf‹ z⁄ê%u", 
z
);

101  
	`ª°‹eMa°îIndex
(
ªadîs
, 
numZ⁄es
, 
ma°îIndex
);

102 
	}
}

105 
	$wrôeMa°îIndex
(
IndexComp⁄ít
 *
comp⁄ít
,

106 
Buf„ªdWrôî
 *
wrôî
,

107 
z⁄e
,

108 
In¸emíèlWrôîComm™d
 
comm™d
,

109 
boﬁ
 *
com∂ëed
)

111 
Ma°îIndex
 *
ma°îIndex
 = 
	`ödexComp⁄ítC⁄ãxt
(
comp⁄ít
);

112 
boﬁ
 
isCom∂ëe
 = 
Ál£
;

114 
ªsu…
 = 
UDS_SUCCESS
;

116 
comm™d
) {

117 
IWC_START
:

118 
ªsu…
 = 
	`°¨tSavögMa°îIndex
(
ma°îIndex
, 
z⁄e
, 
wrôî
);

119 
isCom∂ëe
 = 
ªsu…
 !
UDS_SUCCESS
;

121 
IWC_CONTINUE
:

122 
isCom∂ëe
 = 
	`isSavögMa°îIndexD⁄e
(
ma°îIndex
, 
z⁄e
);

124 
IWC_FINISH
:

125 
ªsu…
 = 
	`föishSavögMa°îIndex
(
ma°îIndex
, 
z⁄e
);

126 i‡(
ªsu…
 =
UDS_SUCCESS
) {

127 
ªsu…
 = 
	`wrôeGu¨dDñèLi°
(
wrôî
);

129 
isCom∂ëe
 = 
åue
;

131 
IWC_ABORT
:

132 
ªsu…
 = 
	`ab‹tSavögMa°îIndex
(
ma°îIndex
, 
z⁄e
);

133 
isCom∂ëe
 = 
åue
;

136 
ªsu…
 = 
	`logW¨nögWôhSåögEº‹
(
UDS_INVALID_ARGUMENT
,

140 i‡(
com∂ëed
 !
NULL
) {

141 *
com∂ëed
 = 
isCom∂ëe
;

143  
ªsu…
;

144 
	}
}

148 c⁄° 
IndexComp⁄ítInfo
 
	gMASTER_INDEX_INFO_DATA
 = {

149 .
köd
 = 
RL_KIND_MASTER_INDEX
,

150 .
	g«me
 = "master index",

151 .
	gfûeName
 = "master_index",

152 .
	gßveO∆y
 = 
Ál£
,

153 .
	gch≠ãrSync
 = 
Ál£
,

154 .
	gmu…iZ⁄e
 = 
åue
,

155 .
	glﬂdî
 = 
ªadMa°îIndex
,

156 .
	gßvî
 = 
NULL
,

157 .
	gö¸emíèl
 = 
wrôeMa°îIndex
,

159 c⁄° 
IndexComp⁄ítInfo
 *c⁄° 
	gMASTER_INDEX_INFO
 = &
MASTER_INDEX_INFO_DATA
;

162 
	$ª°‹eMa°îIndexBody
(
Buf„ªdRódî
 **
buf„ªdRódîs
,

163 
numRódîs
,

164 
Ma°îIndex
 *
ma°îIndex
,

165 
byã
 
dlD©a
[
DELTA_LIST_MAX_BYTE_COUNT
])

168 
ªsu…
 = 
	`°¨tRe°‹ögMa°îIndex
(
ma°îIndex
, 
buf„ªdRódîs
,

169 
numRódîs
);

170 i‡(
ªsu…
 !
UDS_SUCCESS
) {

171  
ªsu…
;

174 
z
 = 0; z < 
numRódîs
; z++) {

176 
DñèLi°SaveInfo
 
dlsi
;

177 
ªsu…
 = 
	`ªadSavedDñèLi°
(&
dlsi
, 
dlD©a
, 
buf„ªdRódîs
[
z
]);

178 i‡(
ªsu…
 =
UDS_END_OF_FILE
) {

180 } i‡(
ªsu…
 !
UDS_SUCCESS
) {

181 
	`ab‹tRe°‹ögMa°îIndex
(
ma°îIndex
);

182  
ªsu…
;

184 
ªsu…
 = 
	`ª°‹eDñèLi°ToMa°îIndex
(
ma°îIndex
, &
dlsi
, 
dlD©a
);

185 i‡(
ªsu…
 !
UDS_SUCCESS
) {

186 
	`ab‹tRe°‹ögMa°îIndex
(
ma°îIndex
);

187  
ªsu…
;

191 i‡(!
	`isRe°‹ögMa°îIndexD⁄e
(
ma°îIndex
)) {

192 
	`ab‹tRe°‹ögMa°îIndex
(
ma°îIndex
);

193  
	`logW¨nögWôhSåögEº‹
(
UDS_CORRUPT_COMPONENT
,

196  
UDS_SUCCESS
;

197 
	}
}

200 
	$ª°‹eMa°îIndex
(
Buf„ªdRódî
 **
buf„ªdRódîs
,

201 
numRódîs
,

202 
Ma°îIndex
 *
ma°îIndex
)

204 
byã
 *
dlD©a
;

205 
ªsu…
 = 
	`ALLOCATE
(
DELTA_LIST_MAX_BYTE_COUNT
, 
byã
, 
__func__
, &
dlD©a
);

206 i‡(
ªsu…
 !
UDS_SUCCESS
) {

207  
ªsu…
;

209 
ªsu…
 = 
	`ª°‹eMa°îIndexBody
(
buf„ªdRódîs
, 
numRódîs
, 
ma°îIndex
,

210 
dlD©a
);

211 
	`FREE
(
dlD©a
);

212  
ªsu…
;

213 
	}
}

	@uds/masterIndexOps.h

22 #i‚de‡
MASTERINDEXOPS_H


23 
	#MASTERINDEXOPS_H
 1

	)

25 
	~"compûî.h
"

26 
	~"dñèIndex.h
"

27 
	~"ödexComp⁄ít.h
"

28 
	~"ödexC⁄fig.h
"

29 
	~"thªads.h
"

30 
	~"uds.h
"

32 c⁄° 
IndexComp⁄ítInfo
 *c⁄° 
MASTER_INDEX_INFO
;

33 
möMa°îIndexDñèLi°s
;

35 
ma°îIndex
 
	tMa°îIndex
;

38 
size_t
 
	mmem‹yAŒoˇãd
;

39 
RñTime
 
	mªbÆ™˚Time
;

40 
	mªbÆ™˚Cou¡
;

41 
	mªc‹dCou¡
;

42 
	mcﬁlisi⁄Cou¡
;

43 
	mdisˇrdCou¡
;

44 
	movîÊowCou¡
;

45 
	mnumLi°s
;

46 
	móæyFlushes
;

47 } 
	tMa°îIndexSèts
;

56 
uöt64_t
 
	mvútuÆCh≠ãr
;

58 
	mz⁄e
;

59 
boﬁ
 
	misSam∂e
;

61 
boﬁ
 
	möSam∂edCh≠ãr
;

63 } 
	tMa°îIndexTrüge
;

76 
uöt64_t
 
	mvútuÆCh≠ãr
;

77 
boﬁ
 
	misCﬁlisi⁄
;

78 
boﬁ
 
	misFound
;

81 
	mmagic
;

82 
	mz⁄eNumbî
;

83 
Ma°îIndex
 *
	mma°îIndex
;

84 
Muãx
 *
	mmuãx
;

87 c⁄° 
UdsChunkName
 *
	m«me
;

88 
DñèIndexE¡ry
 
	mdñèE¡ry
;

89 } 
	tMa°îIndexRec‹d
;

91 
	sma°îIndex
 {

92 (*
	mab‹tRe°‹ögMa°îIndex
)(
Ma°îIndex
 *
	mma°îIndex
);

93 (*
	mab‹tSavögMa°îIndex
)(c⁄° 
Ma°îIndex
 *
	mma°îIndex
,

94 
	mz⁄eNumbî
);

95 (*
	mföishSavögMa°îIndex
)(c⁄° 
Ma°îIndex
 *
	mma°îIndex
,

96 
	mz⁄eNumbî
);

97 (*
	m‰ìMa°îIndex
)(
Ma°îIndex
 *
	mma°îIndex
);

98 
size_t
 (*
gëMa°îIndexMem‹yU£d
)(c⁄° 
Ma°îIndex
 *
	mma°îIndex
);

99 (*
	mgëMa°îIndexRec‹d
)(
Ma°îIndex
 *
	mma°îIndex
,

100 c⁄° 
UdsChunkName
 *
	m«me
,

101 
Ma°îIndexRec‹d
 *
	mªc‹d
);

102 (*
	mgëMa°îIndexSèts
)(c⁄° 
Ma°îIndex
 *
	mma°îIndex
,

103 
Ma°îIndexSèts
 *
	mdí£
,

104 
Ma°îIndexSèts
 *
	m•¨£
);

105 (*
	mgëMa°îIndexZ⁄e
)(c⁄° 
Ma°îIndex
 *
	mma°îIndex
,

106 c⁄° 
UdsChunkName
 *
	m«me
);

107 
boﬁ
 (*
isMa°îIndexSam∂e
)(c⁄° 
Ma°îIndex
 *
	mma°îIndex
,

108 c⁄° 
UdsChunkName
 *
	m«me
);

109 
boﬁ
 (*
isRe°‹ögMa°îIndexD⁄e
)(c⁄° 
Ma°îIndex
 *
	mma°îIndex
);

110 
boﬁ
 (*
isSavögMa°îIndexD⁄e
)(c⁄° 
Ma°îIndex
 *
	mma°îIndex
,

111 
	mz⁄eNumbî
);

112 (*
	mlookupMa°îIndexName
)(c⁄° 
Ma°îIndex
 *
	mma°îIndex
,

113 c⁄° 
UdsChunkName
 *
	m«me
,

114 
Ma°îIndexTrüge
 *
	måüge
);

115 (*
	mlookupMa°îIndexSam∂edName
)(c⁄° 
Ma°îIndex
 *
	mma°îIndex
,

116 c⁄° 
UdsChunkName
 *
	m«me
,

117 
Ma°îIndexTrüge
 *
	måüge
);

118 (*
	mª°‹eDñèLi°ToMa°îIndex
)(
Ma°îIndex
 *
	mma°îIndex
,

119 c⁄° 
DñèLi°SaveInfo
 *
	mdlsi
,

120 c⁄° 
byã
 
	md©a
[
DELTA_LIST_MAX_BYTE_COUNT
]);

121 (*
	m£tMa°îIndexO≥nCh≠ãr
)(
Ma°îIndex
 *
	mma°îIndex
,

122 
uöt64_t
 
	mvútuÆCh≠ãr
);

123 (*
	m£tMa°îIndexTag
)(
Ma°îIndex
 *
	mma°îIndex
, 
byã
 
	mèg
);

124 (*
	m£tMa°îIndexZ⁄eO≥nCh≠ãr
)(
Ma°îIndex
 *
	mma°îIndex
,

125 
	mz⁄eNumbî
,

126 
uöt64_t
 
	mvútuÆCh≠ãr
);

127 (*
	m°¨tRe°‹ögMa°îIndex
)(
Ma°îIndex
 *
	mma°îIndex
,

128 
Buf„ªdRódî
 **
	mbuf„ªdRódîs
,

129 
	mnumRódîs
);

130 (*
	m°¨tSavögMa°îIndex
)(c⁄° 
Ma°îIndex
 *
	mma°îIndex
,

131 
	mz⁄eNumbî
,

132 
Buf„ªdWrôî
 *
	mbuf„ªdWrôî
);

141 
gëMa°îIndexComböedSèts
(c⁄° 
Ma°îIndex
 *
ma°îIndex
,

142 
Ma°îIndexSèts
 *
°©s
);

154 
	$makeMa°îIndex
(c⁄° 
C⁄figuøti⁄
 *
c⁄fig
, 
numZ⁄es
,

155 
uöt64_t
 
vﬁumeN⁄˚
, 
Ma°îIndex
 **
ma°îIndex
)

156 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

168 
	$compuãMa°îIndexSaveBlocks
(c⁄° 
C⁄figuøti⁄
 *
c⁄fig
,

169 
size_t
 
blockSize
,

170 
uöt64_t
 *
blockCou¡
)

171 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

182 
	$ª°‹eMa°îIndex
(
Buf„ªdRódî
 **
ªadîs
,

183 
numRódîs
,

184 
Ma°îIndex
 *
ma°îIndex
)

185 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

192 
INLINE
 
	$ab‹tRe°‹ögMa°îIndex
(
Ma°îIndex
 *
ma°îIndex
)

194 
ma°îIndex
->
	`ab‹tRe°‹ögMa°îIndex
(masterIndex);

195 
	}
}

206 
INLINE
 
	$ab‹tSavögMa°îIndex
(c⁄° 
Ma°îIndex
 *
ma°îIndex
,

207 
z⁄eNumbî
)

209  
ma°îIndex
->
	`ab‹tSavögMa°îIndex
(ma°îIndex, 
z⁄eNumbî
);

210 
	}
}

222 
INLINE
 
	$föishSavögMa°îIndex
(c⁄° 
Ma°îIndex
 *
ma°îIndex
,

223 
z⁄eNumbî
)

225  
ma°îIndex
->
	`föishSavögMa°îIndex
(ma°îIndex, 
z⁄eNumbî
);

226 
	}
}

233 
INLINE
 
	$‰ìMa°îIndex
(
Ma°îIndex
 *
ma°îIndex
)

235 
ma°îIndex
->
	`‰ìMa°îIndex
(masterIndex);

236 
	}
}

245 
INLINE
 
size_t
 
	$gëMa°îIndexMem‹yU£d
(c⁄° 
Ma°îIndex
 *
ma°îIndex
)

247  
ma°îIndex
->
	`gëMa°îIndexMem‹yU£d
(masterIndex);

248 
	}
}

275 
INLINE
 
	$gëMa°îIndexRec‹d
(
Ma°îIndex
 *
ma°îIndex
,

276 c⁄° 
UdsChunkName
 *
«me
,

277 
Ma°îIndexRec‹d
 *
ªc‹d
)

279  
ma°îIndex
->
	`gëMa°îIndexRec‹d
(ma°îIndex, 
«me
, 
ªc‹d
);

280 
	}
}

289 
INLINE
 
	$gëMa°îIndexSèts
(c⁄° 
Ma°îIndex
 *
ma°îIndex
,

290 
Ma°îIndexSèts
 *
dí£
,

291 
Ma°îIndexSèts
 *
•¨£
)

293 
ma°îIndex
->
	`gëMa°îIndexSèts
(ma°îIndex, 
dí£
, 
•¨£
);

294 
	}
}

304 
INLINE
 
	$gëMa°îIndexZ⁄e
(c⁄° 
Ma°îIndex
 *
ma°îIndex
,

305 c⁄° 
UdsChunkName
 *
«me
)

307  
ma°îIndex
->
	`gëMa°îIndexZ⁄e
(ma°îIndex, 
«me
);

308 
	}
}

318 
INLINE
 
boﬁ
 
	$isMa°îIndexSam∂e
(c⁄° 
Ma°îIndex
 *
ma°îIndex
,

319 c⁄° 
UdsChunkName
 *
«me
)

321  
ma°îIndex
->
	`isMa°îIndexSam∂e
(ma°îIndex, 
«me
);

322 
	}
}

332 
INLINE
 
boﬁ
 
	$isRe°‹ögMa°îIndexD⁄e
(c⁄° 
Ma°îIndex
 *
ma°îIndex
)

334  
ma°îIndex
->
	`isRe°‹ögMa°îIndexD⁄e
(masterIndex);

335 
	}
}

347 
INLINE
 
boﬁ
 
	$isSavögMa°îIndexD⁄e
(c⁄° 
Ma°îIndex
 *
ma°îIndex
,

348 
z⁄eNumbî
)

350  
ma°îIndex
->
	`isSavögMa°îIndexD⁄e
(ma°îIndex, 
z⁄eNumbî
);

351 
	}
}

363 
INLINE
 
	$lookupMa°îIndexName
(c⁄° 
Ma°îIndex
 *
ma°îIndex
,

364 c⁄° 
UdsChunkName
 *
«me
,

365 
Ma°îIndexTrüge
 *
åüge
)

367  
ma°îIndex
->
	`lookupMa°îIndexName
(ma°îIndex, 
«me
, 
åüge
);

368 
	}
}

383 
INLINE
 
	$lookupMa°îIndexSam∂edName
(c⁄° 
Ma°îIndex
 *
ma°îIndex
,

384 c⁄° 
UdsChunkName
 *
«me
,

385 
Ma°îIndexTrüge
 *
åüge
)

387  
ma°îIndex
->
	`lookupMa°îIndexSam∂edName
(ma°îIndex, 
«me
, 
åüge
);

388 
	}
}

398 
	$putMa°îIndexRec‹d
(
Ma°îIndexRec‹d
 *
ªc‹d
, 
uöt64_t
 
vútuÆCh≠ãr
)

399 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

408 
	$ªmoveMa°îIndexRec‹d
(
Ma°îIndexRec‹d
 *
ªc‹d
)

409 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

420 
INLINE
 
	$ª°‹eDñèLi°ToMa°îIndex
(
Ma°îIndex
 *
ma°îIndex
,

421 c⁄° 
DñèLi°SaveInfo
 *
dlsi
,

422 c⁄° 
byã
 
d©a
[
DELTA_LIST_MAX_BYTE_COUNT
])

424  
ma°îIndex
->
	`ª°‹eDñèLi°ToMa°îIndex
(ma°îIndex, 
dlsi
, 
d©a
);

425 
	}
}

448 
INLINE
 
	$£tMa°îIndexO≥nCh≠ãr
(
Ma°îIndex
 *
ma°îIndex
,

449 
uöt64_t
 
vútuÆCh≠ãr
)

451 
ma°îIndex
->
	`£tMa°îIndexO≥nCh≠ãr
(ma°îIndex, 
vútuÆCh≠ãr
);

452 
	}
}

462 
	$£tMa°îIndexRec‹dCh≠ãr
(
Ma°îIndexRec‹d
 *
ªc‹d
, 
uöt64_t
 
ch≠ãr
)

463 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

471 
INLINE
 
	$£tMa°îIndexTag
(
Ma°îIndex
 *
ma°îIndex
, 
byã
 
èg
)

473 
ma°îIndex
->
	`£tMa°îIndexTag
(ma°îIndex, 
èg
);

474 
	}
}

485 
INLINE
 
	$£tMa°îIndexZ⁄eO≥nCh≠ãr
(
Ma°îIndex
 *
ma°îIndex
,

486 
z⁄eNumbî
,

487 
uöt64_t
 
vútuÆCh≠ãr
)

489 
ma°îIndex
->
	`£tMa°îIndexZ⁄eO≥nCh≠ãr
(ma°îIndex, 
z⁄eNumbî
,

490 
vútuÆCh≠ãr
);

491 
	}
}

502 
INLINE
 
	$°¨tRe°‹ögMa°îIndex
(
Ma°îIndex
 *
ma°îIndex
,

503 
Buf„ªdRódî
 **
buf„ªdRódîs
,

504 
numRódîs
)

506  
ma°îIndex
->
	`°¨tRe°‹ögMa°îIndex
(ma°îIndex, 
buf„ªdRódîs
,

507 
numRódîs
);

508 
	}
}

519 
INLINE
 
	$°¨tSavögMa°îIndex
(c⁄° 
Ma°îIndex
 *
ma°îIndex
,

520 
z⁄eNumbî
,

521 
Buf„ªdWrôî
 *
buf„ªdWrôî
)

523  
ma°îIndex
->
	`°¨tSavögMa°îIndex
(ma°îIndex, 
z⁄eNumbî
,

524 
buf„ªdWrôî
);

525 
	}
}

	@uds/memoryAlloc.c

22 
	~"mem‹yAŒoc.h
"

24 
	~"°rögUtûs.h
"

27 
	$du∂iˇãSåög
(c⁄° *
°rög
, c⁄° *
wh©
, **
√wSåög
)

29  
	`memdup
(
°rög
, 
	`°æí
(°rögË+ 1, 
wh©
, 
√wSåög
);

30 
	}
}

33 
	$memdup
(c⁄° *
buf„r
, 
size_t
 
size
, c⁄° *
wh©
, *
dupPå
)

35 
byã
 *
dup
;

36 
ªsu…
 = 
	`ALLOCATE
(
size
, 
byã
, 
wh©
, &
dup
);

37 i‡(
ªsu…
 !
UDS_SUCCESS
) {

38  
ªsu…
;

41 
	`mem˝y
(
dup
, 
buf„r
, 
size
);

42 *((**Ë
dupPå
Ë
dup
;

43  
UDS_SUCCESS
;

44 
	}
}

	@uds/memoryAlloc.h

22 #i‚de‡
MEMORY_ALLOC_H


23 
	#MEMORY_ALLOC_H
 1

	)

25 
	~<°d¨g.h
>

27 
	~"compûî.h
"

28 
	~"˝u.h
"

29 
	~"mem‹yDefs.h
"

30 
	~"≥rmas£π.h
"

43 
	$ÆloˇãMem‹y
(
size_t
 
size
, size_à
Æign
, c⁄° *
wh©
, *
±r
)

44 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

51 
	`‰ìMem‹y
(*
±r
);

62 
	$doPœtf‹mVa•rötf
(**
°Ω
, c⁄° *
fmt
, 
va_li°
 
≠
)

63 
	`__©åibuã__
((
	`f‹m©
(
¥ötf
, 2, 0), 
w¨n_unu£d_ªsu…
));

90 
INLINE
 
	$doAŒoˇti⁄
(
size_t
 
cou¡
,

91 
size_t
 
size
,

92 
size_t
 
exåa
,

93 
size_t
 
Æign
,

94 c⁄° *
wh©
,

95 *
±r
)

97 
size_t
 
tŸÆSize
;

101 
	tuöt128_t
 
	t__©åibuã__
((
	tmode
(
	tTI
)));

103 
	`STATIC_ASSERT
((
uöt128_t
Ë>(2 * (
size_t
)));

104 
uöt128_t
 
wideCou¡
 = 
cou¡
;

105 
uöt128_t
 
wideSize
 = 
size
;

106 
uöt128_t
 
¥odu˘
 = 
wideCou¡
 * 
wideSize
 + 
exåa
;

114 
tŸÆSize
 = ((
¥odu˘
 >> 64Ë!0Ë? 
SIZE_MAX
 : (
size_t
)Öroduct;

116  
	`ÆloˇãMem‹y
(
tŸÆSize
, 
Æign
, 
wh©
, 
±r
);

117 
	}
}

131 
	$ªÆloˇãMem‹y
(*
±r
,

132 
size_t
 
ﬁdSize
,

133 
size_t
 
size
,

134 c⁄° *
wh©
,

135 *
√wPå
)

136 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

150 
	#ALLOCATE
(
COUNT
, 
TYPE
, 
WHAT
, 
PTR
) \

151 
	`doAŒoˇti⁄
(
COUNT
, (
TYPE
), 0, 
	`__Æignof__
(TYPE), 
WHAT
, 
PTR
)

	)

167 
	#ALLOCATE_EXTENDED
(
TYPE1
, 
COUNT
, 
TYPE2
, 
WHAT
, 
PTR
) \

168 
	`__exãnsi⁄__
 ({ \

169 
TYPE1
 **
_±r
 = (
PTR
); \

170 
	`STATIC_ASSERT
(
	`__Æignof__
(
TYPE1
Ë>__Æignof__(
TYPE2
)); \

171 
_ªsu…
 = 
	`doAŒoˇti⁄
(
COUNT
, (
TYPE2
), (
TYPE1
), \

172 
	`__Æignof__
(
TYPE1
), 
WHAT
, 
_±r
); \

173 
_ªsu…
; \

174 
	}
})

	)

181 
INLINE
 
	$FREE
(*
±r
)

183 
	`‰ìMem‹y
(
±r
);

184 
	}
}

196 
__©åibuã__
((
w¨n_unu£d_ªsu…
))

197 
INLINE
 
	$ÆloˇãCacheAlig√d
(
size_t
 
size
,

198 c⁄° *
wh©
,

199 *
±r
)

201  
	`ÆloˇãMem‹y
(
size
, 
CACHE_LINE_BYTES
, 
wh©
, 
±r
);

202 
	}
}

213 
	$du∂iˇãSåög
(c⁄° *
°rög
, c⁄° *
wh©
, **
√wSåög
)

214 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

226 
	$memdup
(c⁄° *
±r
, 
size_t
 
size
, c⁄° *
wh©
, *
dupPå
)

227 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

234 
INLINE
 
	$‰ìC⁄°
(c⁄° *
poöãr
)

237 c⁄° *
c⁄°P
;

238 *
nŸC⁄°
;

239 } 
u
 = { .
c⁄°P
 = 
poöãr
 };

240 
	`FREE
(
u
.
nŸC⁄°
);

241 
	}
}

248 
INLINE
 
	$‰ìVﬁ©ûe
(vﬁ©ûê*
poöãr
)

251 vﬁ©ûê*
vﬁP
;

252 *
nŸVﬁ
;

253 } 
u
 = { .
vﬁP
 = 
poöãr
 };

254 
	`FREE
(
u
.
nŸVﬁ
);

255 
	}
}

	@uds/memoryDefs.h

22 #i‚de‡
LINUX_KERNEL_MEMORY_DEFS_H


23 
	#LINUX_KERNEL_MEMORY_DEFS_H
 1

	)

25 
	~<löux/io.h
>

27 
	~"thªadRegi°ry.h
"

28 
	~"ty≥Defs.h
"

42 
	#ALLOCATE_IO_ALIGNED
(
COUNT
, 
TYPE
, 
WHAT
, 
PTR
) \

43 
	`doAŒoˇti⁄
(
COUNT
, (
TYPE
), 0, 
PAGE_SIZE
, 
WHAT
, 
PTR
)

	)

48 
mem‹yExô
();

53 
mem‹yInô
();

69 
ªgi°îAŒoˇtögThªad
(
Regi°îedThªad
 *
√wThªad
,

70 c⁄° 
boﬁ
 *
ÊagPå
);

75 
uƒegi°îAŒoˇtögThªad
();

85 
ªc‹dBioAŒoc
();

95 
ªc‹dBioFªe
();

107 
gëMem‹ySèts
(
uöt64_t
 *
byãsU£d
,

108 
uöt64_t
 *
≥akByãsU£d
,

109 
uöt64_t
 *
biosU£d
,

110 
uöt64_t
 *
≥akBioCou¡
);

118 
ªp‹tMem‹yUßge
();

	@uds/memoryLinuxKernel.c

22 
	~<löux/dñay.h
>

23 
	~<löux/mm.h
>

24 
	~<löux/moduÀ.h
>

25 
	~<löux/¶ab.h
>

26 
	~<löux/vmÆloc.h
>

27 
	~<löux/vîsi⁄.h
>

29 
	~"loggî.h
"

30 
	~"mem‹yAŒoc.h
"

31 
	~"≥rmas£π.h
"

37 
ThªadRegi°ry
 
	gÆloˇtögThªads
;

41 
	svmÆlocBlockInfo
 {

42 *
	m±r
;

43 
size_t
 
	msize
;

44 
vmÆlocBlockInfo
 *
	m√xt
;

45 } 
	tVmÆlocBlockInfo
;

48 
•ölock_t
 
	mlock
;

49 
size_t
 
	mkmÆlocBlocks
;

50 
size_t
 
	mkmÆlocByãs
;

51 
size_t
 
	mvmÆlocBlocks
;

52 
size_t
 
	mvmÆlocByãs
;

53 
size_t
 
	m≥akByãs
;

54 
size_t
 
	mbioCou¡
;

55 
size_t
 
	m≥akBioCou¡
;

56 
VmÆlocBlockInfo
 *
	mvmÆlocLi°
;

57 } 
mem‹ySèts
 
	g__ˇchñöe_Æig√d
;

97 
INLINE
 
boﬁ
 
	$u£KmÆloc
(
size_t
 
size
)

99  
size
 <
PAGE_SIZE
;

100 
	}
}

103 
boﬁ
 
	$Æloˇti⁄sAŒowed
()

105 c⁄° 
boﬁ
 *
poöãr
 = 
	`lookupThªad
(&
ÆloˇtögThªads
);

106  
poöãr
 !
NULL
 ? *poöã∏: 
Ál£
;

107 
	}
}

110 
	$ªgi°îAŒoˇtögThªad
(
Regi°îedThªad
 *
√wThªad
, c⁄° 
boﬁ
 *
ÊagPå
)

112 i‡(
ÊagPå
 =
NULL
) {

113 c⁄° 
boﬁ
 
Æloˇti⁄AlwaysAŒowed
 = 
åue
;

114 
ÊagPå
 = &
Æloˇti⁄AlwaysAŒowed
;

116 
	`ªgi°îThªad
(&
ÆloˇtögThªads
, 
√wThªad
, 
ÊagPå
);

117 
	}
}

120 
	$uƒegi°îAŒoˇtögThªad
()

122 
	`uƒegi°îThªad
(&
ÆloˇtögThªads
);

123 
	}
}

126 
	$upd©ePókUßge
()

128 
size_t
 
tŸÆByãs
 = 
mem‹ySèts
.
kmÆlocByãs
 + mem‹ySèts.
vmÆlocByãs
;

129 i‡(
tŸÆByãs
 > 
mem‹ySèts
.
≥akByãs
) {

130 
mem‹ySèts
.
≥akByãs
 = 
tŸÆByãs
;

132 
	}
}

135 
	$addKmÆlocBlock
(
size_t
 
size
)

137 
Êags
;

138 
	`•ö_lock_úqßve
(&
mem‹ySèts
.
lock
, 
Êags
);

139 
mem‹ySèts
.
kmÆlocBlocks
++;

140 
mem‹ySèts
.
kmÆlocByãs
 +
size
;

141 
	`upd©ePókUßge
();

142 
	`•ö_u∆ock_úqª°‹e
(&
mem‹ySèts
.
lock
, 
Êags
);

143 
	}
}

146 
	$ªmoveKmÆlocBlock
(
size_t
 
size
)

148 
Êags
;

149 
	`•ö_lock_úqßve
(&
mem‹ySèts
.
lock
, 
Êags
);

150 
mem‹ySèts
.
kmÆlocBlocks
--;

151 
mem‹ySèts
.
kmÆlocByãs
 -
size
;

152 
	`•ö_u∆ock_úqª°‹e
(&
mem‹ySèts
.
lock
, 
Êags
);

153 
	}
}

156 
	$addVmÆlocBlock
(
VmÆlocBlockInfo
 *
block
)

158 
Êags
;

159 
	`•ö_lock_úqßve
(&
mem‹ySèts
.
lock
, 
Êags
);

160 
block
->
√xt
 = 
mem‹ySèts
.
vmÆlocLi°
;

161 
mem‹ySèts
.
vmÆlocLi°
 = 
block
;

162 
mem‹ySèts
.
vmÆlocBlocks
++;

163 
mem‹ySèts
.
vmÆlocByãs
 +
block
->
size
;

164 
	`upd©ePókUßge
();

165 
	`•ö_u∆ock_úqª°‹e
(&
mem‹ySèts
.
lock
, 
Êags
);

166 
	}
}

169 
	$ªmoveVmÆlocBlock
(*
±r
)

171 
VmÆlocBlockInfo
 *
block
, **
blockPå
;

172 
Êags
;

173 
	`•ö_lock_úqßve
(&
mem‹ySèts
.
lock
, 
Êags
);

174 
blockPå
 = &
mem‹ySèts
.
vmÆlocLi°
;

175 (
block
 = *
blockPå
Ë!
NULL
;

176 
blockPå
 = &
block
->
√xt
) {

177 i‡(
block
->
±r
 ==Ötr) {

178 *
blockPå
 = 
block
->
√xt
;

179 
mem‹ySèts
.
vmÆlocBlocks
--;

180 
mem‹ySèts
.
vmÆlocByãs
 -
block
->
size
;

184 
	`•ö_u∆ock_úqª°‹e
(&
mem‹ySèts
.
lock
, 
Êags
);

185 i‡(
block
 !
NULL
) {

186 
	`FREE
(
block
);

188 
	`logInfo
("©ãm±ögÅÿªmovê±∏%∞nŸ found i¿vmÆlo¯li°", 
±r
);

190 
	}
}

193 
	$ÆloˇãMem‹y
(
size_t
 
size
, size_à
Æign
, c⁄° *
wh©
, *
±r
)

195 i‡(
±r
 =
NULL
) {

196  
UDS_INVALID_ARGUMENT
;

214 #i‡
LINUX_VERSION_CODE
 >
	`KERNEL_VERSION
(4,13,0)

215 
gÂ_t
 
gÂFœgs
 = 
__GFP_NORETRY
 | 
__GFP_RETRY_MAYFAIL
 | 
__GFP_ZERO
;

217 
gÂ_t
 
gÂFœgs
 = 
__GFP_NORETRY
 | 
__GFP_REPEAT
 | 
__GFP_ZERO
;

219 i‡(
	`Æloˇti⁄sAŒowed
()) {

226 
gÂFœgs
 |
GFP_KERNEL
;

236 
gÂFœgs
 |
GFP_NOIO
;

239 
°¨tTime
 = 
jiffõs
;

240 *
p
 = 
NULL
;

241 i‡(
size
 > 0) {

242 i‡(
	`u£KmÆloc
(
size
Ë&& (
Æign
 < 
PAGE_SIZE
)) {

243 
p
 = 
	`kmÆloc
(
size
, 
gÂFœgs
 | 
__GFP_NOWARN
);

244 i‡(
p
 =
NULL
) {

254 
	`m¶ìp
(1);

255 
p
 = 
	`kmÆloc
(
size
, 
gÂFœgs
);

257 i‡(
p
 !
NULL
) {

258 
	`addKmÆlocBlock
(
	`ksize
(
p
));

261 
VmÆlocBlockInfo
 *
block
;

262 i‡(
	`ALLOCATE
(1, 
VmÆlocBlockInfo
, 
__func__
, &
block
Ë=
UDS_SUCCESS
) {

279 
p
 = 
	`__vmÆloc
(
size
, 
gÂFœgs
 | 
__GFP_NOWARN
, 
PAGE_KERNEL
);

281 i‡((
p
 !
NULL
Ë|| (
	`jiffõs_to_m£cs
(
jiffõs
 - 
°¨tTime
) > 1000)) {

284 
	`m¶ìp
(1);

286 i‡(
p
 =
NULL
) {

288 
p
 = 
	`__vmÆloc
(
size
, 
gÂFœgs
, 
PAGE_KERNEL
);

290 i‡(
p
 =
NULL
) {

291 
	`FREE
(
block
);

293 
block
->
±r
 = 
p
;

294 
block
->
size
 = 
	`PAGE_ALIGN
(size);

295 
	`addVmÆlocBlock
(
block
);

299 i‡(
p
 =
NULL
) {

300 
duøti⁄
 = 
	`jiffõs_to_m£cs
(
jiffõs
 - 
°¨tTime
);

301 
	`logEº‹
("CouldÇotállocate %lu bytes for %s in %u msecs",

302 
size
, 
wh©
, 
duøti⁄
);

303  
ENOMEM
;

306 *((**Ë
±r
Ë
p
;

307  
UDS_SUCCESS
;

308 
	}
}

311 
	$‰ìMem‹y
(*
±r
)

313 i‡(
±r
 !
NULL
) {

314 i‡(
	`is_vmÆloc_addr
(
±r
)) {

315 
	`ªmoveVmÆlocBlock
(
±r
);

316 
	`v‰ì
(
±r
);

318 
	`ªmoveKmÆlocBlock
(
	`ksize
(
±r
));

319 
	`k‰ì
(
±r
);

322 
	}
}

325 
	$doPœtf‹mVa•rötf
(**
°Ω
, c⁄° *
fmt
, 
va_li°
 
≠
)

327 
va_li°
 
¨gs
;

328 
	`va_c›y
(
¨gs
, 
≠
);

329 
cou¡
 = 
	`v¢¥ötf
(
NULL
, 0, 
fmt
, 
¨gs
) + 1;

330 
	`va_íd
(
¨gs
);

331 
ªsu…
 = 
	`ALLOCATE
(
cou¡
, , 
NULL
, 
°Ω
);

332 i‡(
ªsu…
 !
UDS_SUCCESS
) {

333  
ªsu…
;

335 
	`v¢¥ötf
(*
°Ω
, 
cou¡
, 
fmt
, 
≠
);

336  
UDS_SUCCESS
;

337 
	}
}

340 
	$ªÆloˇãMem‹y
(*
±r
,

341 
size_t
 
ﬁdSize
,

342 
size_t
 
size
,

343 c⁄° *
wh©
,

344 *
√wPå
)

347 i‡(
size
 == 0) {

348 
	`FREE
(
±r
);

349 *(**)
√wPå
 = 
NULL
;

350  
UDS_SUCCESS
;

353 
ªsu…
 = 
	`ALLOCATE
(
size
, , 
wh©
, 
√wPå
);

354 i‡(
ªsu…
 !
UDS_SUCCESS
) {

355  
ªsu…
;

358 i‡(
±r
 !
NULL
) {

359 i‡(
ﬁdSize
 < 
size
) {

360 
size
 = 
ﬁdSize
;

362 
	`mem˝y
(*((**Ë
√wPå
), 
±r
, 
size
);

363 
	`FREE
(
±r
);

365  
UDS_SUCCESS
;

366 
	}
}

369 
	$mem‹yInô
()

371 
	`•ö_lock_öô
(&
mem‹ySèts
.
lock
);

372 
	`öôülizeThªadRegi°ry
(&
ÆloˇtögThªads
);

373 
	}
}

377 
	$mem‹yExô
()

379 
	`ASSERT_LOG_ONLY
(
mem‹ySèts
.
kmÆlocByãs
 == 0,

382 
mem‹ySèts
.
kmÆlocByãs
, mem‹ySèts.
kmÆlocBlocks
);

383 
	`ASSERT_LOG_ONLY
(
mem‹ySèts
.
vmÆlocByãs
 == 0,

386 
mem‹ySèts
.
vmÆlocByãs
, mem‹ySèts.
vmÆlocBlocks
);

387 
	`logDebug
("%†≥ak ußgê%zd byãs", 
THIS_MODULE
->
«me
,

388 
mem‹ySèts
.
≥akByãs
);

390 
	`ASSERT_LOG_ONLY
(
mem‹ySèts
.
bioCou¡
 == 0,

392 
mem‹ySèts
.
bioCou¡
);

393 
	`logDebug
("%†≥ak ußgê%zd biÿ°ru˘uªs", 
THIS_MODULE
->
«me
,

394 
mem‹ySèts
.
≥akBioCou¡
);

395 
	}
}

398 
	$ªc‹dBioAŒoc
()

400 
Êags
;

401 
	`•ö_lock_úqßve
(&
mem‹ySèts
.
lock
, 
Êags
);

402 
mem‹ySèts
.
bioCou¡
++;

403 i‡(
mem‹ySèts
.
bioCou¡
 > mem‹ySèts.
≥akBioCou¡
) {

404 
mem‹ySèts
.
≥akBioCou¡
 = mem‹ySèts.
bioCou¡
;

406 
	`•ö_u∆ock_úqª°‹e
(&
mem‹ySèts
.
lock
, 
Êags
);

407 
	}
}

410 
	$ªc‹dBioFªe
()

412 
Êags
;

413 
	`•ö_lock_úqßve
(&
mem‹ySèts
.
lock
, 
Êags
);

414 
mem‹ySèts
.
bioCou¡
--;

415 
	`•ö_u∆ock_úqª°‹e
(&
mem‹ySèts
.
lock
, 
Êags
);

416 
	}
}

419 
	$gëMem‹ySèts
(
uöt64_t
 *
byãsU£d
,

420 
uöt64_t
 *
≥akByãsU£d
,

421 
uöt64_t
 *
biosU£d
,

422 
uöt64_t
 *
≥akBioCou¡
)

424 
Êags
;

425 
	`•ö_lock_úqßve
(&
mem‹ySèts
.
lock
, 
Êags
);

426 *
byãsU£d
 = 
mem‹ySèts
.
kmÆlocByãs
 + mem‹ySèts.
vmÆlocByãs
;

427 *
≥akByãsU£d
 = 
mem‹ySèts
.
≥akByãs
;

428 *
biosU£d
 = 
mem‹ySèts
.
bioCou¡
;

429 *
≥akBioCou¡
 = 
mem‹ySèts
.peakBioCount;

430 
	`•ö_u∆ock_úqª°‹e
(&
mem‹ySèts
.
lock
, 
Êags
);

431 
	}
}

434 
	$ªp‹tMem‹yUßge
()

436 
Êags
;

437 
	`•ö_lock_úqßve
(&
mem‹ySèts
.
lock
, 
Êags
);

438 
uöt64_t
 
kmÆlocBlocks
 = 
mem‹ySèts
.kmallocBlocks;

439 
uöt64_t
 
kmÆlocByãs
 = 
mem‹ySèts
.kmallocBytes;

440 
uöt64_t
 
vmÆlocBlocks
 = 
mem‹ySèts
.vmallocBlocks;

441 
uöt64_t
 
vmÆlocByãs
 = 
mem‹ySèts
.vmallocBytes;

442 
uöt64_t
 
≥akUßge
 = 
mem‹ySèts
.
≥akByãs
;

443 
uöt64_t
 
bioCou¡
 = 
mem‹ySèts
.bioCount;

444 
uöt64_t
 
≥akBioCou¡
 = 
mem‹ySèts
.peakBioCount;

445 
	`•ö_u∆ock_úqª°‹e
(&
mem‹ySèts
.
lock
, 
Êags
);

446 
uöt64_t
 
tŸÆByãs
 = 
kmÆlocByãs
 + 
vmÆlocByãs
;

447 
	`logInfo
("current module memoryÅracking"

449 
	`logInfo
(" %" 
PRIu64
 " bytes in %" PRIu64 " kmalloc blocks",

450 
kmÆlocByãs
, 
kmÆlocBlocks
);

451 
	`logInfo
(" %" 
PRIu64
 " bytes in %" PRIu64 " vmalloc blocks",

452 
vmÆlocByãs
, 
vmÆlocBlocks
);

453 
	`logInfo
("ÅŸÆ %" 
PRIu64
 " bytes,Öeak usage %" PRIu64 " bytes",

454 
tŸÆByãs
, 
≥akUßge
);

456 
	`logInfo
(" %" 
PRIu64
 " bio structs,Öeak %" PRIu64,

457 
bioCou¡
, 
≥akBioCou¡
);

458 
	}
}

	@uds/murmur/MurmurHash3.c

10 
	~"MurmurHash3.h
"

12 
	~"˝u.h
"

14 íum { 
	mPREFETCH_ADVANCE
 = 512 };

21 #i‡
deföed
(
_MSC_VER
)

23 
	#FORCE_INLINE
 
__f‹˚ölöe


	)

25 
	~<°dlib.h
>

27 
	#ROTL32
(
x
,
y
Ë
	`_rŸl
(x,y)

	)

28 
	#ROTL64
(
x
,
y
Ë
	`_rŸl64
(x,y)

	)

30 
	#BIG_CONSTANT
(
x
Ë(x)

	)

36 
	#FORCE_INLINE
 
	`__©åibuã__
((
Æways_ölöe
)Ë
ölöe


	)

38 
ölöe
 
uöt32_t
 
	$rŸl32
 ( 
uöt32_t
 
x
, 
öt8_t
 
r
 )

40  (
x
 << 
r
) | (x >> (32 -Ñ));

41 
	}
}

43 
ölöe
 
uöt64_t
 
	$rŸl64
 ( 
uöt64_t
 
x
, 
öt8_t
 
r
 )

45  (
x
 << 
r
) | (x >> (64 -Ñ));

46 
	}
}

48 
	#ROTL32
(
x
,
y
Ë
	`rŸl32
(x,y)

	)

49 
	#ROTL64
(
x
,
y
Ë
	`rŸl64
(x,y)

	)

51 
	#BIG_CONSTANT
(
x
Ë(x##
LLU
)

	)

59 
FORCE_INLINE
 
uöt32_t
 
	$gëblock
 ( c⁄° 
uöt32_t
 * 
p
, 
i
 )

61  
p
[
i
];

62 
	}
}

64 
FORCE_INLINE
 
uöt64_t
 
	$gëblock64
 ( c⁄° 
uöt64_t
 * 
p
, 
i
 )

66  
p
[
i
];

67 
	}
}

72 
FORCE_INLINE
 
uöt32_t
 
	$fmix32
 ( 
uöt32_t
 
h
 )

74 
h
 ^= h >> 16;

75 
h
 *= 0x85ebca6b;

76 
h
 ^= h >> 13;

77 
h
 *= 0xc2b2ae35;

78 
h
 ^= h >> 16;

80  
h
;

81 
	}
}

85 
FORCE_INLINE
 
uöt64_t
 
	$fmix64
 ( 
uöt64_t
 
k
 )

87 
k
 ^= k >> 33;

88 
k
 *
	`BIG_CONSTANT
(0xff51afd7ed558ccd);

89 
k
 ^= k >> 33;

90 
k
 *
	`BIG_CONSTANT
(0xc4ceb9fe1a85ec53);

91 
k
 ^= k >> 33;

93  
k
;

94 
	}
}

98 
	$MurmurHash3_x86_32
 ( c⁄° * 
key
, 
Àn
,

99 
uöt32_t
 
£ed
, * 
out
 )

101 c⁄° 
uöt8_t
 * 
d©a
 = (c⁄° uöt8_t*)
key
;

102 c⁄° 
nblocks
 = 
Àn
 / 4;

104 
uöt32_t
 
h1
 = 
£ed
;

106 
uöt32_t
 
c1
 = 0xcc9e2d51;

107 
uöt32_t
 
c2
 = 0x1b873593;

112 c⁄° 
uöt32_t
 * 
blocks
 = (c⁄° uöt32_à*)(
d©a
 + 
nblocks
*4);

114 
i
 = -
nblocks
; i; i++)

116 
uöt32_t
 
k1
 = 
	`gëblock
(
blocks
,
i
);

118 
k1
 *
c1
;

119 
k1
 = 
	`ROTL32
(k1,15);

120 
k1
 *
c2
;

122 
h1
 ^
k1
;

123 
h1
 = 
	`ROTL32
(h1,13);

124 
h1
 = h1*5+0xe6546b64;

130 c⁄° 
uöt8_t
 * 
èû
 = (c⁄° uöt8_t*)(
d©a
 + 
nblocks
*4);

132 
uöt32_t
 
k1
 = 0;

134 
Àn
 & 3)

136 3: 
k1
 ^
èû
[2] << 16;

137 2: 
k1
 ^
èû
[1] << 8;

138 1: 
k1
 ^
èû
[0];

139 
k1
 *
c1
; k1 = 
	`ROTL32
(k1,15); k1 *
c2
; 
h1
 ^= k1;

146 
h1
 ^
Àn
;

148 
h1
 = 
	`fmix32
(h1);

150 *(
uöt32_t
*)
out
 = 
h1
;

151 
	}
}

155 
	$MurmurHash3_x86_128
 ( c⁄° * 
key
, c⁄° 
Àn
,

156 
uöt32_t
 
£ed
, * 
out
 )

158 c⁄° 
uöt8_t
 * 
d©a
 = (c⁄° uöt8_t*)
key
;

159 c⁄° 
nblocks
 = 
Àn
 / 16;

161 
uöt32_t
 
h1
 = 
£ed
;

162 
uöt32_t
 
h2
 = 
£ed
;

163 
uöt32_t
 
h3
 = 
£ed
;

164 
uöt32_t
 
h4
 = 
£ed
;

166 
uöt32_t
 
c1
 = 0x239b961b;

167 
uöt32_t
 
c2
 = 0xab0e9789;

168 
uöt32_t
 
c3
 = 0x38b34ae5;

169 
uöt32_t
 
c4
 = 0xa1e38b93;

174 c⁄° 
uöt32_t
 * 
blocks
 = (c⁄° uöt32_à*)(
d©a
 + 
nblocks
*16);

176 
i
 = -
nblocks
; i; i++)

178 
uöt32_t
 
k1
 = 
	`gëblock
(
blocks
,
i
*4+0);

179 
uöt32_t
 
k2
 = 
	`gëblock
(
blocks
,
i
*4+1);

180 
uöt32_t
 
k3
 = 
	`gëblock
(
blocks
,
i
*4+2);

181 
uöt32_t
 
k4
 = 
	`gëblock
(
blocks
,
i
*4+3);

183 
k1
 *
c1
; k1 = 
	`ROTL32
(k1,15); k1 *
c2
; 
h1
 ^= k1;

185 
h1
 = 
	`ROTL32
(h1,19); h1 +
h2
; h1 = h1*5+0x561ccd1b;

187 
k2
 *
c2
; k2 = 
	`ROTL32
(k2,16); k2 *
c3
; 
h2
 ^= k2;

189 
h2
 = 
	`ROTL32
(h2,17); h2 +
h3
; h2 = h2*5+0x0bcaa747;

191 
k3
 *
c3
; k3 = 
	`ROTL32
(k3,17); k3 *
c4
; 
h3
 ^= k3;

193 
h3
 = 
	`ROTL32
(h3,15); h3 +
h4
; h3 = h3*5+0x96cd1c35;

195 
k4
 *
c4
; k4 = 
	`ROTL32
(k4,18); k4 *
c1
; 
h4
 ^= k4;

197 
h4
 = 
	`ROTL32
(h4,13); h4 +
h1
; h4 = h4*5+0x32ac3b17;

203 c⁄° 
uöt8_t
 * 
èû
 = (c⁄° uöt8_t*)(
d©a
 + 
nblocks
*16);

205 
uöt32_t
 
k1
 = 0;

206 
uöt32_t
 
k2
 = 0;

207 
uöt32_t
 
k3
 = 0;

208 
uöt32_t
 
k4
 = 0;

210 
Àn
 & 15)

212 15: 
k4
 ^
èû
[14] << 16;

213 14: 
k4
 ^
èû
[13] << 8;

214 13: 
k4
 ^
èû
[12] << 0;

215 
k4
 *
c4
; k4 = 
	`ROTL32
(k4,18); k4 *
c1
; 
h4
 ^= k4;

217 12: 
k3
 ^
èû
[11] << 24;

218 11: 
k3
 ^
èû
[10] << 16;

219 10: 
k3
 ^
èû
[ 9] << 8;

220 9: 
k3
 ^
èû
[ 8] << 0;

221 
k3
 *
c3
; k3 = 
	`ROTL32
(k3,17); k3 *
c4
; 
h3
 ^= k3;

223 8: 
k2
 ^
èû
[ 7] << 24;

224 7: 
k2
 ^
èû
[ 6] << 16;

225 6: 
k2
 ^
èû
[ 5] << 8;

226 5: 
k2
 ^
èû
[ 4] << 0;

227 
k2
 *
c2
; k2 = 
	`ROTL32
(k2,16); k2 *
c3
; 
h2
 ^= k2;

229 4: 
k1
 ^
èû
[ 3] << 24;

230 3: 
k1
 ^
èû
[ 2] << 16;

231 2: 
k1
 ^
èû
[ 1] << 8;

232 1: 
k1
 ^
èû
[ 0] << 0;

233 
k1
 *
c1
; k1 = 
	`ROTL32
(k1,15); k1 *
c2
; 
h1
 ^= k1;

240 
h1
 ^
Àn
; 
h2
 ^Àn; 
h3
 ^Àn; 
h4
 ^=Üen;

242 
h1
 +
h2
; h1 +
h3
; h1 +
h4
;

243 
h2
 +
h1
; 
h3
 +h1; 
h4
 += h1;

245 
h1
 = 
	`fmix32
(h1);

246 
h2
 = 
	`fmix32
(h2);

247 
h3
 = 
	`fmix32
(h3);

248 
h4
 = 
	`fmix32
(h4);

250 
h1
 +
h2
; h1 +
h3
; h1 +
h4
;

251 
h2
 +
h1
; 
h3
 +h1; 
h4
 += h1;

253 ((
uöt32_t
*)
out
)[0] = 
h1
;

254 ((
uöt32_t
*)
out
)[1] = 
h2
;

255 ((
uöt32_t
*)
out
)[2] = 
h3
;

256 ((
uöt32_t
*)
out
)[3] = 
h4
;

257 
	}
}

261 
	$MurmurHash3_x64_128
 ( c⁄° * 
key
, c⁄° 
Àn
,

262 c⁄° 
uöt32_t
 
£ed
, * 
out
 )

264 c⁄° 
uöt8_t
 * 
d©a
 = (c⁄° uöt8_t*)
key
;

265 c⁄° 
nblocks
 = 
Àn
 / 16;

267 
uöt64_t
 
h1
 = 
£ed
;

268 
uöt64_t
 
h2
 = 
£ed
;

270 
uöt64_t
 
c1
 = 
	`BIG_CONSTANT
(0x87c37b91114253d5);

271 
uöt64_t
 
c2
 = 
	`BIG_CONSTANT
(0x4cf5ad432745937f);

276 c⁄° 
uöt64_t
 * 
blocks
 = (c⁄° uöt64_à*)(
d©a
);

278 
i
 = 0; i < 
nblocks
; i++)

280 
uöt64_t
 
k1
 = 
	`gëblock64
(
blocks
,
i
*2+0);

281 
uöt64_t
 
k2
 = 
	`gëblock64
(
blocks
,
i
*2+1);

283 
k1
 *
c1
; k1 = 
	`ROTL64
(k1,31); k1 *
c2
; 
h1
 ^= k1;

285 
h1
 = 
	`ROTL64
(h1,27); h1 +
h2
; h1 = h1*5+0x52dce729;

287 
k2
 *
c2
; k2 = 
	`ROTL64
(k2,33); k2 *
c1
; 
h2
 ^= k2;

289 
h2
 = 
	`ROTL64
(h2,31); h2 +
h1
; h2 = h2*5+0x38495ab5;

295 c⁄° 
uöt8_t
 * 
èû
 = (c⁄° uöt8_t*)(
d©a
 + 
nblocks
*16);

297 
uöt64_t
 
k1
 = 0;

298 
uöt64_t
 
k2
 = 0;

300 
Àn
 & 15)

302 15: 
k2
 ^((
uöt64_t
)
èû
[14]) << 48;

303 14: 
k2
 ^((
uöt64_t
)
èû
[13]) << 40;

304 13: 
k2
 ^((
uöt64_t
)
èû
[12]) << 32;

305 12: 
k2
 ^((
uöt64_t
)
èû
[11]) << 24;

306 11: 
k2
 ^((
uöt64_t
)
èû
[10]) << 16;

307 10: 
k2
 ^((
uöt64_t
)
èû
[ 9]) << 8;

308 9: 
k2
 ^((
uöt64_t
)
èû
[ 8]) << 0;

309 
k2
 *
c2
; k2 = 
	`ROTL64
(k2,33); k2 *
c1
; 
h2
 ^= k2;

311 8: 
k1
 ^((
uöt64_t
)
èû
[ 7]) << 56;

312 7: 
k1
 ^((
uöt64_t
)
èû
[ 6]) << 48;

313 6: 
k1
 ^((
uöt64_t
)
èû
[ 5]) << 40;

314 5: 
k1
 ^((
uöt64_t
)
èû
[ 4]) << 32;

315 4: 
k1
 ^((
uöt64_t
)
èû
[ 3]) << 24;

316 3: 
k1
 ^((
uöt64_t
)
èû
[ 2]) << 16;

317 2: 
k1
 ^((
uöt64_t
)
èû
[ 1]) << 8;

318 1: 
k1
 ^((
uöt64_t
)
èû
[ 0]) << 0;

319 
k1
 *
c1
; k1 = 
	`ROTL64
(k1,31); k1 *
c2
; 
h1
 ^= k1;

326 
h1
 ^
Àn
; 
h2
 ^=Üen;

328 
h1
 +
h2
;

329 
h2
 +
h1
;

331 
h1
 = 
	`fmix64
(h1);

332 
h2
 = 
	`fmix64
(h2);

334 
h1
 +
h2
;

335 
h2
 +
h1
;

337 ((
uöt64_t
*)
out
)[0] = 
h1
;

338 ((
uöt64_t
*)
out
)[1] = 
h2
;

339 
	}
}

357 
	$MurmurHash3_x64_128_doubÀ
 (c⁄° *
key
,

358 c⁄° 
Àn
,

359 c⁄° 
uöt32_t
 
£edA
,

360 c⁄° 
uöt32_t
 
£edB
,

361 *
out
)

363 c⁄° 
uöt8_t
 * 
d©a
 = (c⁄° uöt8_t*)
key
;

364 c⁄° 
nblocks
 = 
Àn
 / 16;

366 
uöt64_t
 
hA1
 = 
£edA
;

367 
uöt64_t
 
hA2
 = 
£edA
;

368 
uöt64_t
 
hB1
 = 
£edB
;

369 
uöt64_t
 
hB2
 = 
£edB
;

371 
uöt64_t
 
c1
 = 
	`BIG_CONSTANT
(0x87c37b91114253d5);

372 
uöt64_t
 
c2
 = 
	`BIG_CONSTANT
(0x4cf5ad432745937f);

377 
	`¥e„tchR™ge
(
key
, 
PREFETCH_ADVANCE
, 
Ál£
);

379 c⁄° 
uöt64_t
 * 
blocks
 = (c⁄° uöt64_à*)(
d©a
);

381 
i
 = 0; i < 
nblocks
; i++)

383 
uöt64_t
 
k1
 = 
	`gëblock64
(
blocks
,
i
*2+0);

384 
uöt64_t
 
k2
 = 
	`gëblock64
(
blocks
,
i
*2+1);

386 
	`¥e„tchAddªss
(
PREFETCH_ADVANCE
 + (c⁄° *Ë&
blocks
[
i
*2+0],

387 
Ál£
);

389 
k1
 *
c1
; k1 = 
	`ROTL64
(k1,31); k1 *
c2
; 
hA1
 ^k1; 
hB1
 ^= k1;

391 
hA1
 = 
	`ROTL64
(hA1,27); hA1 +
hA2
; hA1 = hA1*5+0x52dce729;

392 
hB1
 = 
	`ROTL64
(hB1,27); hB1 +
hB2
; hB1 = hB1*5+0x52dce729;

394 
k2
 *
c2
; k2 = 
	`ROTL64
(k2,33); k2 *
c1
; 
hA2
 ^k2; 
hB2
 ^= k2;

396 
hA2
 = 
	`ROTL64
(hA2,31); hA2 +
hA1
; hA2 = hA2*5+0x38495ab5;

397 
hB2
 = 
	`ROTL64
(hB2,31); hB2 +
hB1
; hB2 = hB2*5+0x38495ab5;

402 c⁄° 
uöt8_t
 * 
èû
 = (c⁄° uöt8_t*)(
d©a
 + 
nblocks
*16);

404 
uöt64_t
 
k1
 = 0;

405 
uöt64_t
 
k2
 = 0;

407 
Àn
 & 15)

409 15: 
k2
 ^((
uöt64_t
)
èû
[14]) << 48;

410 14: 
k2
 ^((
uöt64_t
)
èû
[13]) << 40;

411 13: 
k2
 ^((
uöt64_t
)
èû
[12]) << 32;

412 12: 
k2
 ^((
uöt64_t
)
èû
[11]) << 24;

413 11: 
k2
 ^((
uöt64_t
)
èû
[10]) << 16;

414 10: 
k2
 ^((
uöt64_t
)
èû
[ 9]) << 8;

415 9: 
k2
 ^((
uöt64_t
)
èû
[ 8]) << 0;

416 
k2
 *
c2
; k2 = 
	`ROTL64
(k2,33); k2 *
c1
; 
hA2
 ^k2; 
hB2
 ^= k2;

418 8: 
k1
 ^((
uöt64_t
)
èû
[ 7]) << 56;

419 7: 
k1
 ^((
uöt64_t
)
èû
[ 6]) << 48;

420 6: 
k1
 ^((
uöt64_t
)
èû
[ 5]) << 40;

421 5: 
k1
 ^((
uöt64_t
)
èû
[ 4]) << 32;

422 4: 
k1
 ^((
uöt64_t
)
èû
[ 3]) << 24;

423 3: 
k1
 ^((
uöt64_t
)
èû
[ 2]) << 16;

424 2: 
k1
 ^((
uöt64_t
)
èû
[ 1]) << 8;

425 1: 
k1
 ^((
uöt64_t
)
èû
[ 0]) << 0;

426 
k1
 *
c1
; k1 = 
	`ROTL64
(k1,31); k1 *
c2
; 
hA1
 ^k1; 
hB1
 ^= k1;

433 
hA1
 ^
Àn
; 
hA2
 ^=Üen;

434 
hB1
 ^
Àn
; 
hB2
 ^=Üen;

436 
hA1
 +
hA2
;

437 
hA2
 +
hA1
;

438 
hB1
 +
hB2
;

439 
hB2
 +
hB1
;

441 
hA1
 = 
	`fmix64
(hA1);

442 
hA2
 = 
	`fmix64
(hA2);

443 
hB1
 = 
	`fmix64
(hB1);

444 
hB2
 = 
	`fmix64
(hB2);

446 
hA1
 +
hA2
;

447 
hA2
 +
hA1
;

448 
hB1
 +
hB2
;

449 
hB2
 +
hB1
;

451 ((
uöt64_t
*)
out
)[0] = 
hA1
;

452 ((
uöt64_t
*)
out
)[1] = 
hA2
;

453 ((
uöt64_t
*)
out
)[2] = 
hB1
;

454 ((
uöt64_t
*)
out
)[3] = 
hB2
;

455 
	}
}

	@uds/murmur/MurmurHash3.h

5 #i‚de‡
_MURMURHASH3_H_


6 
	#_MURMURHASH3_H_


	)

13 #ifde‡
__KERNEL__


14 
	~<löux/ty≥s.h
>

19 #i‡
deföed
(
_MSC_VER
)

21 
	tuöt8_t
;

22 
	tuöt32_t
;

23 
	t__öt64
 
	tuöt64_t
;

29 
	~<°döt.h
>

36 
MurmurHash3_x86_32
 ( c⁄° * 
key
, 
Àn
, 
uöt32_t
 
£ed
, * 
out
 );

38 
MurmurHash3_x86_128
 ( c⁄° * 
key
, 
Àn
, 
uöt32_t
 
£ed
, * 
out
 );

40 
MurmurHash3_x64_128
 ( c⁄° * 
key
, 
Àn
, 
uöt32_t
 
£ed
, * 
out
 );

42 
MurmurHash3_x64_128_doubÀ
 (c⁄° * 
key
,

43 
Àn
,

44 
uöt32_t
 
£ed1
,

45 
uöt32_t
 
£ed2
,

46 * 
out
 );

	@uds/namespaceHash.h

22 #i‚de‡
NAMESPACE_HASH_H


23 
	#NAMESPACE_HASH_H


	)

25 
	~"compûî.h
"

26 
	~"„©uªDefs.h
"

27 
	~"uds.h
"

29 #i‡
NAMESPACES


33 
	s«me•a˚Hash
 {

34 
	mhash
[
UDS_CHUNK_NAME_SIZE
];

35 } 
	tName•a˚Hash
;

44 
INLINE
 
	$x‹Name•a˚
(
UdsChunkName
 *
«me
,

45 c⁄° 
Name•a˚Hash
 *
«me•a˚Hash
)

47 
uöt64_t
 *
chunk
 = (uöt64_à*Ë
«me
->name;

48 c⁄° 
uöt64_t
 *
•a˚
 = (c⁄° uöt64_à*Ë
«me•a˚Hash
->
hash
;

49 íum { 
SIZE
 = 
UDS_CHUNK_NAME_SIZE
 / (
uöt64_t
) };

50 
i
 = 0; i < 
SIZE
; i++) {

51 
chunk
[
i
] ^
•a˚
[i];

53 
	}
}

	@uds/nonce.c

22 
	~"n⁄˚.h
"

24 
	~"murmur/MurmurHash3.h
"

25 
	~"numîic.h
"

26 
	~"øndom.h
"

27 
	~"timeUtûs.h
"

30 
uöt64_t
 
	$hashStuff
(
uöt64_t
 
°¨t
, c⁄° *
d©a
, 
size_t
 
Àn
)

33 
HASH_SIZE
 = 32,

36 
byã
 
hashBuf„r
[
HASH_SIZE
];

38 
uöt32_t
 
£ed0
 = 
°¨t
 ^ (start >> 27);

39 
uöt32_t
 
£ed1
 = (
°¨t
 << 5) ^ ~(start >> 37);

41 
	`MurmurHash3_x64_128_doubÀ
(
d©a
, 
Àn
, 
£ed0
, 
£ed1
, 
hashBuf„r
);

42  *(
uöt64_t
 *)(
hashBuf„r
 + 4);

43 
	}
}

46 *
	$memput
(*
buf
, *
íd
, c⁄° *
d©a
, 
size_t
 
Àn
)

48 
byã
 *
bp
 = 
buf
;

49 
byã
 *
be
 = 
íd
;

51 
size_t
 
chunk
 = 
	`möSizeT
(
Àn
, 
be
 - 
bp
);

52 
	`mem˝y
(
bp
, 
d©a
, 
chunk
);

53  
bp
 + 
chunk
;

54 
	}
}

57 
size_t
 
	$¸óãUniqueN⁄˚D©a
(
byã
 *
buf„r
, 
size_t
 
Àngth
)

59 
AbsTime
 
now
 = 
	`cuºítTime
(
CT_REALTIME
);

61 
byã
 *
be
 = 
buf„r
 + 
Àngth
;

62 
byã
 *
bp
 = 
	`memput
(
buf„r
, 
be
, &
now
, (now));

64 
uöt32_t
 
ønd
 = 
	`øndomInR™ge
(1, (1<<30) - 1);

66 
bp
 = 
	`memput
(bp, 
be
, &
ønd
, (rand));

68 
bp
 < 
be
) {

69 
size_t
 
n
 = 
	`möSizeT
(
be
 - 
bp
, b∞- 
buf„r
);

70 
	`mem˝y
(
bp
, 
buf„r
, 
n
);

71 
bp
 +
n
;

74  
bp
 - 
buf„r
;

75 
	}
}

78 
uöt64_t
 
	$gíî©eMa°îN⁄˚
(c⁄° *
d©a
, 
size_t
 
Àn
)

80  
	`hashStuff
(0xa1b1e0fc, 
d©a
, 
Àn
);

81 
	}
}

84 
uöt64_t
 
	$gíî©eSec⁄d¨yN⁄˚
(
uöt64_t
 
n⁄˚
,

85 c⁄° *
d©a
,

86 
size_t
 
Àn
)

88  
	`hashStuff
(
n⁄˚
 + 1, 
d©a
, 
Àn
);

89 
	}
}

	@uds/nonce.h

22 #i‚de‡
NONCE_H


23 
	#NONCE_H


	)

25 
	~"ty≥Defs.h
"

36 
size_t
 
¸óãUniqueN⁄˚D©a
(
byã
 *
buf„r
, size_à
Àngth
);

46 
uöt64_t
 
gíî©eMa°îN⁄˚
(c⁄° *
d©a
, 
size_t
 
Àn
);

60 
uöt64_t
 
gíî©eSec⁄d¨yN⁄˚
(uöt64_à
n⁄˚
,

61 c⁄° *
d©a
,

62 
size_t
 
Àn
);

	@uds/notificationDefs.h

22 #i‚de‡
LINUX_KERNEL_NOTIFICATION_DEFS_H


23 
	#LINUX_KERNEL_NOTIFICATION_DEFS_H


	)

25 
	~"uds.h
"

26 
	~"uds-block.h
"

33 
nŸifyBlockC⁄ãxtClo£d
(
UdsBlockC⁄ãxt
 
c⁄ãxt
);

41 
nŸifyBlockC⁄ãxtO≥√d
(
UdsIndexSessi⁄
 
£ssi⁄
,

42 
UdsBlockC⁄ãxt
 
c⁄ãxt
);

49 
nŸifyIndexClo£d
(
UdsIndexSessi⁄
 
£ssi⁄
);

57 
nŸifyIndexO≥√d
(
UdsIndexSessi⁄
 
£ssi⁄
, c⁄° *
«me
);

	@uds/numeric.c

22 
	~"numîic.h
"

23 
	~"≥rmas£π.h
"

25 
	#STATIC_ASSERT_ALIGNOF
(
ty≥
, 
ex≥˘edAlignmít
) \

26 
	`STATIC_ASSERT
(
	`__Æignof__
(
ty≥
Ë=(
ex≥˘edAlignmít
))

	)

29 
uöt64_t
 
	$gª©e°Comm⁄Divis‹
(
uöt64_t
 
a
, uöt64_à
b
)

31 c⁄° 
uöt64_t
 
thªshﬁd
 = (1 << 13);

32 i‡((
a
 < 
thªshﬁd
Ë&& (
b
 <Åhreshold)) {

34 
a
 !
b
) {

35 i‡(
a
 > 
b
) {

36 
a
 =á - 
b
;

38 
b
 = b - 
a
;

43 
b
 != 0) {

44 
uöt64_t
 
t
 = 
b
;

45 
b
 = 
a
 % 
t
;

46 
a
 = 
t
;

49  
a
;

50 
	}
}

53 
uöt64_t
 
	$Àa°Comm⁄Mu…ùÀ
(
uöt64_t
 
a
, uöt64_à
b
)

55  
a
 / 
	`gª©e°Comm⁄Divis‹
◊, 
b
) * b;

56 
	}
}

59 
boﬁ
 
	$mu…ùlyWouldOvîÊow
(
uöt64_t
 
a
, uöt64_à
b
)

61  
b
 !0 && 
a
 > 
UINT64_MAX
 / b;

62 
	}
}

65 
	$numîicCompûeTimeAs£πi⁄s
()

67 
	`STATIC_ASSERT_SIZEOF
(
uöt64_t
, 8);

68 
	`STATIC_ASSERT_SIZEOF
(
uöt32_t
, 4);

69 
	`STATIC_ASSERT_SIZEOF
(
uöt16_t
, 2);

71 
	`STATIC_ASSERT_SIZEOF
(
	`UNALIGNED_WRAPPER
(
uöt64_t
), 8);

72 
	`STATIC_ASSERT_SIZEOF
(
	`UNALIGNED_WRAPPER
(
uöt32_t
), 4);

73 
	`STATIC_ASSERT_SIZEOF
(
	`UNALIGNED_WRAPPER
(
uöt16_t
), 2);

75 
	`STATIC_ASSERT_ALIGNOF
(
	`UNALIGNED_WRAPPER
(
uöt64_t
), 1);

76 
	`STATIC_ASSERT_ALIGNOF
(
	`UNALIGNED_WRAPPER
(
uöt32_t
), 1);

77 
	`STATIC_ASSERT_ALIGNOF
(
	`UNALIGNED_WRAPPER
(
uöt16_t
), 1);

78 
	}
}

	@uds/numeric.h

22 #i‚de‡
NUMERIC_H


23 
	#NUMERIC_H
 1

	)

25 #ifde‡
__˝lu•lus


29 
	~"compûî.h
"

30 
	~"numîicDefs.h
"

31 
	~"ty≥Defs.h
"

33 #i‚de‡
BYTE_ORDER


34 #îr‹ 
BYTE_ORDER
 
nŸ
 
£t


36 #i‚de‡
BIG_ENDIAN


37 #îr‹ 
BIG_ENDIAN
 
nŸ
 
£t


39 #i‚de‡
LITTLE_ENDIAN


40 #îr‹ 
LITTLE_ENDIAN
 
nŸ
 
£t


42 #i‡(
BYTE_ORDER
 =
LITTLE_ENDIAN
Ë&& (BYTE_ORDER =
BIG_ENDIAN
)

56 
	#UNALIGNED_WRAPPER
(
TYPE
) \

57 
u«lig√d_wøp_
##
TYPE


	)

58 
	#UNALIGNED_WRAPPER_DEF
(
TYPE
) \

59 
	`__©åibuã__
((
	t∑cked
, 
	tmay_Æüs
)Ë{ 
TYPE
 
vÆue
; } \

60 
	tUNALIGNED_WRAPPER
(
	tTYPE
)

	)

61 
	tUNALIGNED_WRAPPER_DEF
(
	tuöt64_t
);

62 
UNALIGNED_WRAPPER_DEF
(
uöt32_t
);

63 
UNALIGNED_WRAPPER_DEF
(
uöt16_t
);

65 
	#GET_UNALIGNED
(
TYPE
,
ADDR
) \

66 (((c⁄° 
	`UNALIGNED_WRAPPER
(
TYPE
Ë*)(
ADDR
))->
vÆue
)

	)

67 
	#PUT_UNALIGNED
(
TYPE
,
ADDR
,
VALUE
) \

68 (((
	`UNALIGNED_WRAPPER
(
TYPE
Ë*)(
ADDR
))->
vÆue
 = (
VALUE
))

	)

78 
__©åibuã__
((
w¨n_unu£d_ªsu…
))

79 
INLINE
 
möI¡
(
a
, 
b
)

81  ((
a
 < 
b
) ?á : b);

92 
__©åibuã__
((
w¨n_unu£d_ªsu…
))

93 
INLINE
 
maxI¡
(
a
, 
b
)

95  ((
a
 > 
b
) ?á : b);

106 
__©åibuã__
((
w¨n_unu£d_ªsu…
))

107 
INLINE
 
size_t
 
möSizeT
(size_à
a
, size_à
b
)

109  ((
a
 < 
b
) ?á : b);

120 
__©åibuã__
((
w¨n_unu£d_ªsu…
))

121 
INLINE
 
size_t
 
maxSizeT
(size_à
a
, size_à
b
)

123  ((
a
 > 
b
) ?á : b);

134 
__©åibuã__
((
w¨n_unu£d_ªsu…
))

135 
INLINE
 
uöt64_t
 
möUI¡64
(uöt64_à
a
, uöt64_à
b
)

137  ((
a
 < 
b
) ?á : b);

148 
uöt64_t
 
gª©e°Comm⁄Divis‹
(uöt64_à
a
, uöt64_à
b
);

158 
uöt64_t
 
Àa°Comm⁄Mu…ùÀ
(uöt64_à
a
, uöt64_à
b
);

163 
boﬁ
 
mu…ùlyWouldOvîÊow
(
uöt64_t
 
a
, uöt64_à
b
);

173 
__©åibuã__
((
w¨n_unu£d_ªsu…
))

174 
INLINE
 
uöt64_t
 
gëUI¡64BE
(c⁄° 
byã
* 
d©a
)

176 
uöt64_t
 
num
 = 
GET_UNALIGNED
(uöt64_t, 
d©a
);

177 #i‡
BYTE_ORDER
 =
LITTLE_ENDIAN


178 
num
 = 
__buûtö_bsw≠64
(num);

180  
num
;

191 
INLINE
 
decodeUI¡64BE
(c⁄° 
byã
 *
buf„r
,

192 
size_t
 *
off£t
,

193 
uöt64_t
 *
decoded
)

195 *
decoded
 = 
gëUI¡64BE
(
buf„r
 + *
off£t
);

196 *
off£t
 +(
uöt64_t
);

206 
INLINE
 
°‹eUI¡64BE
(
byã
* 
d©a
, 
uöt64_t
 
num
)

208 #i‡
BYTE_ORDER
 =
LITTLE_ENDIAN


209 
num
 = 
__buûtö_bsw≠64
(num);

211 
PUT_UNALIGNED
(
uöt64_t
, 
d©a
, 
num
);

223 
INLINE
 
ícodeUI¡64BE
(
byã
 *
d©a
,

224 
size_t
 *
off£t
,

225 
uöt64_t
 
toEncode
)

227 
°‹eUI¡64BE
(
d©a
 + *
off£t
, 
toEncode
);

228 *
off£t
 +(
uöt64_t
);

239 
__©åibuã__
((
w¨n_unu£d_ªsu…
))

240 
INLINE
 
uöt32_t
 
gëUI¡32BE
(c⁄° 
byã
* 
d©a
)

242 
uöt32_t
 
num
 = 
GET_UNALIGNED
(uöt32_t, 
d©a
);

243 #i‡
BYTE_ORDER
 =
LITTLE_ENDIAN


244 
num
 = 
__buûtö_bsw≠32
(num);

246  
num
;

257 
INLINE
 
decodeUI¡32BE
(c⁄° 
byã
 *
buf„r
,

258 
size_t
 *
off£t
,

259 
uöt32_t
 *
decoded
)

261 *
decoded
 = 
gëUI¡32BE
(
buf„r
 + *
off£t
);

262 *
off£t
 +(
uöt32_t
);

272 
INLINE
 
°‹eUI¡32BE
(
byã
* 
d©a
, 
uöt32_t
 
num
)

274 #i‡
BYTE_ORDER
 =
LITTLE_ENDIAN


275 
num
 = 
__buûtö_bsw≠32
(num);

277 
PUT_UNALIGNED
(
uöt32_t
, 
d©a
, 
num
);

289 
INLINE
 
ícodeUI¡32BE
(
byã
 *
d©a
,

290 
size_t
 *
off£t
,

291 
uöt32_t
 
toEncode
)

293 
°‹eUI¡32BE
(
d©a
 + *
off£t
, 
toEncode
);

294 *
off£t
 +(
uöt32_t
);

305 
__©åibuã__
((
w¨n_unu£d_ªsu…
))

306 
INLINE
 
uöt16_t
 
gëUI¡16BE
(c⁄° 
byã
* 
d©a
)

308 
uöt16_t
 
num
 = 
GET_UNALIGNED
(uöt16_t, 
d©a
);

309 #i‡
BYTE_ORDER
 =
LITTLE_ENDIAN


310 
num
 = 
bsw≠_16
(num);

312  
num
;

324 
INLINE
 
decodeUI¡16BE
(c⁄° 
byã
 *
buf„r
,

325 
size_t
 *
off£t
,

326 
uöt16_t
 *
decoded
)

328 *
decoded
 = 
gëUI¡16BE
(
buf„r
 + *
off£t
);

329 *
off£t
 +(
uöt16_t
);

339 
INLINE
 
°‹eUI¡16BE
(
byã
* 
d©a
, 
uöt16_t
 
num
)

341 #i‡
BYTE_ORDER
 =
LITTLE_ENDIAN


342 
num
 = 
bsw≠_16
(num);

344 
PUT_UNALIGNED
(
uöt16_t
, 
d©a
, 
num
);

356 
INLINE
 
ícodeUI¡16BE
(
byã
 *
d©a
,

357 
size_t
 *
off£t
,

358 
uöt16_t
 
toEncode
)

360 
°‹eUI¡16BE
(
d©a
 + *
off£t
, 
toEncode
);

361 *
off£t
 +(
uöt16_t
);

372 
__©åibuã__
((
w¨n_unu£d_ªsu…
))

373 
INLINE
 
uöt64_t
 
gëUI¡64LE
(c⁄° 
byã
* 
d©a
)

375 
uöt64_t
 
num
 = 
GET_UNALIGNED
(uöt64_t, 
d©a
);

376 #i‡
BYTE_ORDER
 !
LITTLE_ENDIAN


377 
num
 = 
__buûtö_bsw≠64
(num);

379  
num
;

389 
INLINE
 
°‹eUI¡64LE
(
byã
* 
d©a
, 
uöt64_t
 
num
)

391 #i‡
BYTE_ORDER
 !
LITTLE_ENDIAN


392 
num
 = 
__buûtö_bsw≠64
(num);

394 
PUT_UNALIGNED
(
uöt64_t
, 
d©a
, 
num
);

405 
__©åibuã__
((
w¨n_unu£d_ªsu…
))

406 
INLINE
 
uöt32_t
 
gëUI¡32LE
(c⁄° 
byã
* 
d©a
)

408 
uöt32_t
 
num
 = 
GET_UNALIGNED
(uöt32_t, 
d©a
);

409 #i‡
BYTE_ORDER
 !
LITTLE_ENDIAN


410 
num
 = 
__buûtö_bsw≠32
(num);

412  
num
;

422 
INLINE
 
°‹eUI¡32LE
(
byã
* 
d©a
, 
uöt32_t
 
num
)

424 #i‡
BYTE_ORDER
 !
LITTLE_ENDIAN


425 
num
 = 
__buûtö_bsw≠32
(num);

427 
PUT_UNALIGNED
(
uöt32_t
, 
d©a
, 
num
);

438 
__©åibuã__
((
w¨n_unu£d_ªsu…
))

439 
INLINE
 
uöt16_t
 
gëUI¡16LE
(c⁄° 
byã
* 
d©a
)

441 
uöt16_t
 
num
 = 
GET_UNALIGNED
(uöt16_t, 
d©a
);

442 #i‡
BYTE_ORDER
 !
LITTLE_ENDIAN


443 
num
 = 
bsw≠_16
(num);

445  
num
;

455 
INLINE
 
°‹eUI¡16LE
(
byã
* 
d©a
, 
uöt16_t
 
num
)

457 #i‡
BYTE_ORDER
 !
LITTLE_ENDIAN


458 
num
 = 
bsw≠_16
(num);

460 
PUT_UNALIGNED
(
uöt16_t
, 
d©a
, 
num
);

468 
numîicCompûeTimeAs£πi⁄s
();

470 #ifde‡
__˝lu•lus


	@uds/numericDefs.h

22 #i‚de‡
LINUX_KERNEL_NUMERIC_DEFS_H


23 
	#LINUX_KERNEL_NUMERIC_DEFS_H
 1

	)

27 
	#BIG_ENDIAN
 4321

	)

28 
	#LITTLE_ENDIAN
 1234

	)

29 
	#BYTE_ORDER
 
LITTLE_ENDIAN


	)

31 
	#bsw≠_16
(
x
) \

32 (
__exãnsi⁄__
 \

33 ({ 
__v
, 
__x
 = (Ë(
x
); \

34 
	`__asm__
 ("rorw $8, %w0" \

35 : "Ù" (
__v
) \

36 : "0" (
__x
) \

38 
__v
; }))

	)

	@uds/opaqueTypes.h

22 #i‚de‡
OPAQUE_TYPES_H


23 
	#OPAQUE_TYPES_H


	)

30 
aùC⁄ãxt
 
	tAIPC⁄ãxt
;

31 
grid
 
	tGrid
;

32 
ödexRouãr
 
	tIndexRouãr
;

33 
ödexRouãrSètCou¡îs
 
	tIndexRouãrSètCou¡îs
;

34 
ödexSessi⁄
 
	tIndexSessi⁄
;

35 
£rvîC⁄√˘i⁄
 
	tSîvîC⁄√˘i⁄
;

36 
ªque°
 
	tReque°
;

37 
ªque°Limô
 
	tReque°Limô
;

38 
ªque°Queue
 
	tReque°Queue
;

	@uds/openChapter.c

22 
	~"›íCh≠ãr.h
"

24 
	~"compûî.h
"

25 
	~"loggî.h
"

26 
	~"mem‹yAŒoc.h
"

28 
ªadO≥nCh≠ãrs
(
Comp⁄ítP‹èl
 *
p‹èl
);

29 
wrôeO≥nCh≠ãrs
(
IndexComp⁄ít
 *
comp⁄ít
,

30 
Buf„ªdWrôî
 *
wrôî
,

31 
z⁄e
);

33 c⁄° 
IndexComp⁄ítInfo
 
	gOPEN_CHAPTER_INFO
 = {

34 .
köd
 = 
RL_KIND_OPEN_CHAPTER
,

35 .
	g«me
 = "open chapter",

36 .
	gfûeName
 = "open_chapter",

37 .
	gßveO∆y
 = 
åue
,

38 .
	gch≠ãrSync
 = 
Ál£
,

39 .
	gmu…iZ⁄e
 = 
Ál£
,

40 .
	glﬂdî
 = 
ªadO≥nCh≠ãrs
,

41 .
	gßvî
 = 
wrôeO≥nCh≠ãrs
,

42 .
	gö¸emíèl
 = 
NULL
,

45 c⁄° 
byã
 
	gOPEN_CHAPTER_MAGIC
[] = "ALBOC";

46 c⁄° 
byã
 
	gOPEN_CHAPTER_VERSION
[] = "02.00";

47 c⁄° 
byã
 
	gOPEN_CHAPTER_VERSION_1_2
[] = "01.02";

50 
	mOPEN_CHAPTER_MAGIC_LENGTH
 = (
OPEN_CHAPTER_MAGIC
) - 1,

51 
	mOPEN_CHAPTER_VERSION_LENGTH
 = (
OPEN_CHAPTER_VERSION
) - 1

55 
	$fûlDñèCh≠ãrIndex
(
O≥nCh≠ãrZ⁄e
 **
ch≠ãrZ⁄es
,

56 
z⁄eCou¡
,

57 
O≥nCh≠ãrIndex
 *
ödex
,

58 
UdsChunkRec‹d
 *
cﬁœãdRec‹ds
)

63 
O≥nCh≠ãrZ⁄e
 *
fûlCh≠ãrZ⁄e
 = 
NULL
;

64 
UdsChunkRec‹d
 *
fûlRec‹d
 = 
NULL
;

65 
z⁄e
 = 0; z⁄ê< 
z⁄eCou¡
; ++zone) {

66 
fûlCh≠ãrZ⁄e
 = 
ch≠ãrZ⁄es
[
z⁄e
];

67 i‡(
fûlCh≠ãrZ⁄e
->
size
 =fûlCh≠ãrZ⁄e->
ˇ∑côy
) {

68 
fûlRec‹d
 = &
fûlCh≠ãrZ⁄e
->
ªc‹ds
[fûlCh≠ãrZ⁄e->
size
];

72 
ªsu…
 = 
	`ASSERT
((
fûlRec‹d
 !
NULL
),

74 i‡(
ªsu…
 !
UDS_SUCCESS
) {

75  
ªsu…
;

77 
ªsu…
 = 
	`ASSERT
(!
fûlCh≠ãrZ⁄e
->
¶Ÿs
[fûlCh≠ãrZ⁄e->
size
].
ªc‹dDñëed
,

79 i‡(
ªsu…
 !
UDS_SUCCESS
) {

80  
ªsu…
;

83 c⁄° 
Geomëry
 *
geomëry
 = 
ödex
->geometry;

84 
∑gesPîCh≠ãr
 = 
geomëry
->
ªc‹dPagesPîCh≠ãr
;

85 
ªc‹dsPîPage
 = 
geomëry
->recordsPerPage;

86 
ovîÊowCou¡
 = 0;

87 
ªc‹dsAdded
 = 0;

88 
z⁄e
 = 0;

90 
∑ge
 = 0;Öagê< 
∑gesPîCh≠ãr
;Öage++) {

91 
i
 = 0;

92 
i
 < 
ªc‹dsPîPage
;

93 
i
++, 
ªc‹dsAdded
++, 
z⁄e
 = (z⁄ê+ 1Ë% 
z⁄eCou¡
) {

96 
ªc‹dNumbî
 = 1 + (
ªc‹dsAdded
 / 
z⁄eCou¡
);

100 i‡(
ªc‹dNumbî
 > 
ch≠ãrZ⁄es
[
z⁄e
]->
size


101 || 
ch≠ãrZ⁄es
[
z⁄e
]->
¶Ÿs
[
ªc‹dNumbî
].
ªc‹dDñëed
) {

102 
cﬁœãdRec‹ds
[1 + 
ªc‹dsAdded
] = *
fûlRec‹d
;

106 
UdsChunkRec‹d
 *
√xtRec‹d
 = &
ch≠ãrZ⁄es
[
z⁄e
]->
ªc‹ds
[
ªc‹dNumbî
];

107 
cﬁœãdRec‹ds
[1 + 
ªc‹dsAdded
] = *
√xtRec‹d
;

109 
ªsu…
 = 
	`putO≥nCh≠ãrIndexRec‹d
(
ödex
, &
√xtRec‹d
->
«me
, 
∑ge
);

110 
ªsu…
) {

111 
UDS_SUCCESS
:

113 
UDS_OVERFLOW
:

114 
ovîÊowCou¡
++;

117 
	`logEº‹WôhSåögEº‹
(
ªsu…
, "failedÅo build open chapter index");

118  
ªsu…
;

122 i‡(
ovîÊowCou¡
 > 0) {

123 
	`logW¨nög
("FaûedÅÿadd %dÉ¡rõ†tÿch≠ã∏ödex", 
ovîÊowCou¡
);

125  
UDS_SUCCESS
;

126 
	}
}

129 
	$˛o£O≥nCh≠ãr
(
O≥nCh≠ãrZ⁄e
 **
ch≠ãrZ⁄es
,

130 
z⁄eCou¡
,

131 
Vﬁume
 *
vﬁume
,

132 
O≥nCh≠ãrIndex
 *
ch≠ãrIndex
,

133 
UdsChunkRec‹d
 *
cﬁœãdRec‹ds
,

134 
uöt64_t
 
vútuÆCh≠ãrNumbî
)

137 
	`em±yO≥nCh≠ãrIndex
(
ch≠ãrIndex
, 
vútuÆCh≠ãrNumbî
);

141 
ªsu…
 = 
	`fûlDñèCh≠ãrIndex
(
ch≠ãrZ⁄es
, 
z⁄eCou¡
, 
ch≠ãrIndex
,

142 
cﬁœãdRec‹ds
);

143 i‡(
ªsu…
 !
UDS_SUCCESS
) {

144  
ªsu…
;

149  
	`wrôeCh≠ãr
(
vﬁume
, 
ch≠ãrIndex
, 
cﬁœãdRec‹ds
);

150 
	}
}

153 
	$ßveO≥nCh≠ãrs
(
Index
 *
ödex
, 
Buf„ªdWrôî
 *
wrôî
)

155 
ªsu…
 = 
	`wrôeToBuf„ªdWrôî
(
wrôî
, 
OPEN_CHAPTER_MAGIC
,

156 
OPEN_CHAPTER_MAGIC_LENGTH
);

157 i‡(
ªsu…
 !
UDS_SUCCESS
) {

158  
ªsu…
;

161 
ªsu…
 = 
	`wrôeToBuf„ªdWrôî
(
wrôî
, 
OPEN_CHAPTER_VERSION
,

162 
OPEN_CHAPTER_VERSION_LENGTH
);

163 i‡(
ªsu…
 !
UDS_SUCCESS
) {

164  
ªsu…
;

167 
uöt32_t
 
tŸÆRec‹ds
 = 0;

168 
i
 = 0; i < 
ödex
->
z⁄eCou¡
; i++) {

169 
tŸÆRec‹ds
 +
	`›íCh≠ãrSize
(
ödex
->
z⁄es
[
i
]->
›íCh≠ãr
);

172 
ªsu…
 = 
	`wrôeToBuf„ªdWrôî
(
wrôî
, &
tŸÆRec‹ds
, (totalRecords));

173 i‡(
ªsu…
 !
UDS_SUCCESS
) {

174  
ªsu…
;

178 
uöt32_t
 
ªc‹dsAdded
 = 0;

179 
ªc‹dIndex
 = 1;

180 
ªc‹dsAdded
 < 
tŸÆRec‹ds
) {

181 
i
 = 0; i < 
ödex
->
z⁄eCou¡
; i++) {

182 i‡(
ªc‹dIndex
 > 
ödex
->
z⁄es
[
i
]->
›íCh≠ãr
->
size
) {

185 i‡(
ödex
->
z⁄es
[
i
]->
›íCh≠ãr
->
¶Ÿs
[
ªc‹dIndex
].
ªc‹dDñëed
) {

188 
UdsChunkRec‹d
 *
ªc‹d


189 &
ödex
->
z⁄es
[
i
]->
›íCh≠ãr
->
ªc‹ds
[
ªc‹dIndex
];

190 
ªsu…
 = 
	`wrôeToBuf„ªdWrôî
(
wrôî
, 
ªc‹d
, (
UdsChunkRec‹d
));

191 i‡(
ªsu…
 !
UDS_SUCCESS
) {

192  
ªsu…
;

194 
ªc‹dsAdded
++;

196 
ªc‹dIndex
++;

199  
	`ÊushBuf„ªdWrôî
(
wrôî
);

200 
	}
}

203 
uöt64_t
 
	$compuãSavedO≥nCh≠ãrSize
(
Geomëry
 *
geomëry
)

205  
OPEN_CHAPTER_MAGIC_LENGTH
 + 
OPEN_CHAPTER_VERSION_LENGTH
 +

206 (
uöt32_t
Ë+ 
geomëry
->
ªc‹dsPîCh≠ãr
 * (
UdsChunkRec‹d
);

207 
	}
}

210 
	$wrôeO≥nCh≠ãrs
(
IndexComp⁄ít
 *
comp⁄ít
,

211 
Buf„ªdWrôî
 *
wrôî
,

212 
z⁄e
)

214 
ªsu…
 = 
	`ASSERT
((
z⁄e
 == 0), "open chapter writeÇot zoned");

215 i‡(
ªsu…
 !
UDS_SUCCESS
) {

216  
ªsu…
;

219 
Index
 *
ödex
 = 
	`ödexComp⁄ítD©a
(
comp⁄ít
);

220  
	`ßveO≥nCh≠ãrs
(
ödex
, 
wrôî
);

221 
	}
}

235 
	$ªadVîsi⁄
(
Buf„ªdRódî
 *
ªadî
, c⁄° 
byã
 **
vîsi⁄
)

237 
byã
 
buf„r
[
OPEN_CHAPTER_VERSION_LENGTH
];

238 
ªsu…
 = 
	`ªadFromBuf„ªdRódî
(
ªadî
, 
buf„r
, (buffer));

239 i‡(
ªsu…
 !
UDS_SUCCESS
) {

240  
ªsu…
;

242 i‡(
	`memcmp
(
OPEN_CHAPTER_VERSION
, 
buf„r
, (buffer)) == 0) {

243 *
vîsi⁄
 = 
OPEN_CHAPTER_VERSION
;

244  
UDS_SUCCESS
;

246 i‡(
	`memcmp
(
OPEN_CHAPTER_VERSION_1_2
, 
buf„r
, (buffer)) == 0) {

247 *
vîsi⁄
 = 
OPEN_CHAPTER_VERSION_1_2
;

248  
UDS_SUCCESS
;

251  
	`logEº‹WôhSåögEº‹
(
UDS_CORRUPT_COMPONENT
,

253 (Ë(
buf„r
), buffer);

254 
	}
}

257 
	$lﬂdVîsi⁄12
(
Index
 *
ödex
, 
Buf„ªdRódî
 *
ªadî
)

260 
O≥nCh≠ãrZ⁄e
 *
›íCh≠ãr
 = 
ödex
->
z⁄es
[0]->openChapter;

264 
uöt32_t
 
size
;

265 
ªsu…
 = 
	`ªadFromBuf„ªdRódî
(
ªadî
, &
size
, (size));

266 i‡(
ªsu…
 !
UDS_SUCCESS
) {

267  
ªsu…
;

270 i‡(
size
 >
›íCh≠ãr
->
ˇ∑côy
) {

271  
	`logEº‹WôhSåögEº‹
(
UDS_CORRUPT_COMPONENT
,

272 "InvÆid o≥¿ch≠ã∏size: %u", 
size
);

274 
›íCh≠ãr
->
size
 = (
size_t
) size;

278 
ªc‹dByãs
 = (
size
 * (
UdsChunkRec‹d
));

279  
	`ªadFromBuf„ªdRódî
(
ªadî
, &
›íCh≠ãr
->
ªc‹ds
[1], 
ªc‹dByãs
);

280 
	}
}

283 
	$lﬂdVîsi⁄20
(
Index
 *
ödex
, 
Buf„ªdRódî
 *
ªadî
)

285 
uöt32_t
 
numRec‹ds
;

286 
ªsu…
 = 
	`ªadFromBuf„ªdRódî
(
ªadî
, &
numRec‹ds
, (numRecords));

287 i‡(
ªsu…
 !
UDS_SUCCESS
) {

288  
ªsu…
;

292 
boﬁ
 
fuŒFœgs
[
ödex
->
z⁄eCou¡
];

293 
	`mem£t
(
fuŒFœgs
, 0, (
ödex
->
z⁄eCou¡
 * (
boﬁ
)));

296 
UdsChunkRec‹d
 
ªc‹d
;

297 
uöt32_t
 
ªc‹ds
 = 0;Ñec‹d†< 
numRec‹ds
;Ñecords++) {

298 
ªsu…
 = 
	`ªadFromBuf„ªdRódî
(
ªadî
, &
ªc‹d
, (
UdsChunkRec‹d
));

299 i‡(
ªsu…
 !
UDS_SUCCESS
) {

300  
ªsu…
;

303 
z⁄e
 = 0;

304 i‡(
ödex
->
z⁄eCou¡
 > 1) {

306 
z⁄e
 = 
	`gëMa°îIndexZ⁄e
(
ödex
->
ma°îIndex
, &
ªc‹d
.
«me
);

310 i‡(!
fuŒFœgs
[
z⁄e
]) {

311 
ªmaöög
;

312 
ªsu…
 = 
	`putO≥nCh≠ãr
(
ödex
->
z⁄es
[
z⁄e
]->
›íCh≠ãr
,

313 &
ªc‹d
.
«me
, &ªc‹d.
d©a
, &
ªmaöög
);

314 
fuŒFœgs
[
z⁄e
] = (
ªmaöög
 <= 1);

315 i‡(
ªsu…
 !
UDS_SUCCESS
) {

316  
ªsu…
;

321  
UDS_SUCCESS
;

322 
	}
}

325 
	$lﬂdO≥nCh≠ãrs
(
Index
 *
ödex
, 
Buf„ªdRódî
 *
ªadî
)

328 
ªsu…
 =

329 
	`vîifyBuf„ªdD©a
(
ªadî
, 
OPEN_CHAPTER_MAGIC
, 
OPEN_CHAPTER_MAGIC_LENGTH
);

330 i‡(
ªsu…
 !
UDS_SUCCESS
) {

331  
ªsu…
;

335 c⁄° 
byã
 *
vîsi⁄
 = 
NULL
;

336 
ªsu…
 = 
	`ªadVîsi⁄
(
ªadî
, &
vîsi⁄
);

337 i‡(
ªsu…
 !
UDS_SUCCESS
) {

338  
ªsu…
;

341 i‡(
vîsi⁄
 =
OPEN_CHAPTER_VERSION_1_2
) {

342  
	`lﬂdVîsi⁄12
(
ödex
, 
ªadî
);

345  
	`lﬂdVîsi⁄20
(
ödex
, 
ªadî
);

346 
	}
}

349 
	$ªadO≥nCh≠ãrs
(
Comp⁄ítP‹èl
 *
p‹èl
)

351 
Index
 *
ödex
 = 
	`comp⁄ítD©aF‹P‹èl
(
p‹èl
);

353 
Buf„ªdRódî
 *
ªadî
;

354 
ªsu…
 = 
	`gëBuf„ªdRódî
(
p‹èl
, 0, &
ªadî
);

355 i‡(
ªsu…
 !
UDS_SUCCESS
) {

356  
ªsu…
;

358  
	`lﬂdO≥nCh≠ãrs
(
ödex
, 
ªadî
);

359 
	}
}

	@uds/openChapter.h

22 #i‚de‡
OPENCHAPTER_H


23 
	#OPENCHAPTER_H
 1

	)

25 
	~"comm⁄.h
"

26 
	~"geomëry.h
"

27 
	~"ödex.h
"

28 
	~"ödexComp⁄ít.h
"

30 c⁄° 
IndexComp⁄ítInfo
 
OPEN_CHAPTER_INFO
;

61 
	$˛o£O≥nCh≠ãr
(
O≥nCh≠ãrZ⁄e
 **
ch≠ãrZ⁄es
,

62 
z⁄eCou¡
,

63 
Vﬁume
 *
vﬁume
,

64 
O≥nCh≠ãrIndex
 *
ch≠ãrIndex
,

65 
UdsChunkRec‹d
 *
cﬁœãdRec‹ds
,

66 
uöt64_t
 
vútuÆCh≠ãrNumbî
)

67 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

77 
	$ßveO≥nCh≠ãrs
(
Index
 *
ödex
, 
Buf„ªdWrôî
 *
wrôî
)

78 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

88 
	$lﬂdO≥nCh≠ãrs
(
Index
 *
ödex
, 
Buf„ªdRódî
 *
ªadî
)

89 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

99 
uöt64_t
 
	`compuãSavedO≥nCh≠ãrSize
(
Geomëry
 *
geomëry
);

	@uds/openChapterZone.c

22 
	~"›íCh≠ãrZ⁄e.h
"

24 
	~"compûî.h
"

25 
	~"hashUtûs.h
"

26 
	~"loggî.h
"

27 
	~"mem‹yAŒoc.h
"

28 
	~"≥rmas£π.h
"

31 
INLINE
 
size_t
 
	$ªc‹dsSize
(c⁄° 
O≥nCh≠ãrZ⁄e
 *
›íCh≠ãr
)

33  ((
UdsChunkRec‹d
Ë* (1 + 
›íCh≠ãr
->
ˇ∑côy
));

34 
	}
}

37 
INLINE
 
size_t
 
	$¶ŸsSize
(
size_t
 
¶ŸCou¡
)

39  ((
SlŸ
Ë* 
¶ŸCou¡
);

40 
	}
}

51 
INLINE
 
size_t
 
	$√xtPowîOfTwo
(
size_t
 
vÆ
)

53 i‡(
vÆ
 == 0) {

56  (1 << 
	`compuãBôs
(
vÆ
 - 1));

57 
	}
}

60 
	$makeO≥nCh≠ãr
(c⁄° 
Geomëry
 *
geomëry
,

61 
z⁄eCou¡
,

62 
O≥nCh≠ãrZ⁄e
 **
›íCh≠ãrPå
)

64 
ªsu…
 = 
	`ASSERT
(
z⁄eCou¡
 > 0, "zone count must be > 0");

65 i‡(
ªsu…
 !
UDS_SUCCESS
) {

66  
ªsu…
;

68 
ªsu…
 = 
	`ASSERT_WITH_ERROR_CODE
(
geomëry
->
›íCh≠ãrLﬂdR©io
 > 1,

69 
UDS_BAD_STATE
,

71 i‡(
ªsu…
 !
UDS_SUCCESS
) {

72  
ªsu…
;

74 
ªsu…
 = 
	`ASSERT_WITH_ERROR_CODE
((
geomëry
->
ªc‹dsPîCh≠ãr


75 <
OPEN_CHAPTER_MAX_RECORD_NUMBER
),

76 
UDS_BAD_STATE
,

78 
geomëry
->
ªc‹dsPîCh≠ãr
);

79 i‡(
ªsu…
 !
UDS_SUCCESS
) {

80  
ªsu…
;

83 i‡(
geomëry
->
ªc‹dsPîCh≠ãr
 < 
z⁄eCou¡
) {

84  
	`logUƒecovîabÀ
(

85 
UDS_INVALID_ARGUMENT
,

87 
z⁄eCou¡
, 
geomëry
->
ªc‹dsPîCh≠ãr
);

89 
size_t
 
ˇ∑côy
 = 
geomëry
->
ªc‹dsPîCh≠ãr
 / 
z⁄eCou¡
;

94 
size_t
 
¶ŸCou¡
 = 
	`√xtPowîOfTwo
(
ˇ∑côy
 * 
geomëry
->
›íCh≠ãrLﬂdR©io
);

95 
O≥nCh≠ãrZ⁄e
 *
›íCh≠ãr
;

96 
ªsu…
 = 
	`ALLOCATE_EXTENDED
(
O≥nCh≠ãrZ⁄e
, 
¶ŸCou¡
, 
SlŸ
,

97 "›í ch≠ãr", &
›íCh≠ãr
);

98 i‡(
ªsu…
 !
UDS_SUCCESS
) {

99  
ªsu…
;

101 
›íCh≠ãr
->
¶ŸCou¡
 = slotCount;

102 
›íCh≠ãr
->
ˇ∑côy
 = capacity;

103 
ªsu…
 = 
	`ÆloˇãCacheAlig√d
(
	`ªc‹dsSize
(
›íCh≠ãr
), "recordÖages",

104 &
›íCh≠ãr
->
ªc‹ds
);

105 i‡(
ªsu…
 !
UDS_SUCCESS
) {

106 
	`‰ìO≥nCh≠ãr
(
›íCh≠ãr
);

107  
ªsu…
;

110 *
›íCh≠ãrPå
 = 
›íCh≠ãr
;

111  
UDS_SUCCESS
;

112 
	}
}

115 
size_t
 
	$›íCh≠ãrSize
(c⁄° 
O≥nCh≠ãrZ⁄e
 *
›íCh≠ãr
)

117  
›íCh≠ãr
->
size
 - o≥nCh≠ãr->
dñëed
;

118 
	}
}

121 
	$ª£tO≥nCh≠ãr
(
O≥nCh≠ãrZ⁄e
 *
›íCh≠ãr
)

123 
›íCh≠ãr
->
size
 = 0;

124 
›íCh≠ãr
->
dñëed
 = 0;

126 
	`mem£t
(
›íCh≠ãr
->
ªc‹ds
, 0, 
	`ªc‹dsSize
(openChapter));

127 
	`mem£t
(
›íCh≠ãr
->
¶Ÿs
, 0, 
	`¶ŸsSize
(›íCh≠ãr->
¶ŸCou¡
));

128 
	}
}

131 
UdsChunkRec‹d
 *
	$¥obeCh≠ãrSlŸs
(
O≥nCh≠ãrZ⁄e
 *
›íCh≠ãr
,

132 c⁄° 
UdsChunkName
 *
«me
,

133 *
¶ŸPå
,

134 *
ªc‹dNumbîPå
)

136 
¶Ÿs
 = 
›íCh≠ãr
->
¶ŸCou¡
;

137 
¥obe
 = 
	`«meToHashSlŸ
(
«me
, 
¶Ÿs
);

138 
fú°SlŸ
 = 0;

140 
UdsChunkRec‹d
 *
ªc‹d
;

141 
¥obeSlŸ
;

142 
ªc‹dNumbî
;

144 
¥obeAâem±s
 = 1; ; ++probeAttempts) {

145 
¥obeSlŸ
 = 
fú°SlŸ
 + 
¥obe
;

146 
ªc‹dNumbî
 = 
›íCh≠ãr
->
¶Ÿs
[
¥obeSlŸ
].recordNumber;

150 i‡(
ªc‹dNumbî
 == 0) {

151 
ªc‹d
 = 
NULL
;

157 
ªc‹d
 = &
›íCh≠ãr
->
ªc‹ds
[
ªc‹dNumbî
];

158 i‡((
	`memcmp
(&
ªc‹d
->
«me
,Çame, 
UDS_CHUNK_NAME_SIZE
) == 0)

159 && !
›íCh≠ãr
->
¶Ÿs
[
ªc‹dNumbî
].
ªc‹dDñëed
) {

165 
¥obe
 +
¥obeAâem±s
;

166 i‡(
¥obe
 >
¶Ÿs
) {

167 
¥obe
 =Örobê% 
¶Ÿs
;

173 i‡(
¶ŸPå
 !
NULL
) {

174 *
¶ŸPå
 = 
¥obeSlŸ
;

176 i‡(
ªc‹dNumbîPå
 !
NULL
) {

177 *
ªc‹dNumbîPå
 = 
ªc‹dNumbî
;

180  
ªc‹d
;

181 
	}
}

184 
	$£¨chO≥nCh≠ãr
(
O≥nCh≠ãrZ⁄e
 *
›íCh≠ãr
,

185 c⁄° 
UdsChunkName
 *
«me
,

186 
UdsChunkD©a
 *
mëad©a
,

187 
boﬁ
 *
found
)

189 
UdsChunkRec‹d
 *
ªc‹d
 = 
	`¥obeCh≠ãrSlŸs
(
›íCh≠ãr
, 
«me
, 
NULL
, NULL);

191 i‡(
ªc‹d
 =
NULL
) {

192 *
found
 = 
Ál£
;

194 *
found
 = 
åue
;

195 i‡(
mëad©a
 !
NULL
) {

196 *
mëad©a
 = 
ªc‹d
->
d©a
;

199 
	}
}

202 
	$putO≥nCh≠ãr
(
O≥nCh≠ãrZ⁄e
 *
›íCh≠ãr
,

203 c⁄° 
UdsChunkName
 *
«me
,

204 c⁄° 
UdsChunkD©a
 *
mëad©a
,

205 *
ªmaöög
)

207 
¶Ÿ
;

208 
UdsChunkRec‹d
 *
ªc‹d
 = 
	`¥obeCh≠ãrSlŸs
(
›íCh≠ãr
, 
«me
, &
¶Ÿ
, 
NULL
);

210 i‡(
ªc‹d
 !
NULL
) {

211 
ªc‹d
->
d©a
 = *
mëad©a
;

212 *
ªmaöög
 = 
›íCh≠ãr
->
ˇ∑côy
 - o≥nCh≠ãr->
size
;

213  
UDS_SUCCESS
;

216 
ªc‹dNumbî
 = ++
›íCh≠ãr
->
size
;

217 i‡(
›íCh≠ãr
->
size
 > o≥nCh≠ãr->
ˇ∑côy
) {

218  
	`logUƒecovîabÀ
(

219 
UDS_BAD_STATE
, "chapter size: %u isÜargerÅhan geometryállows: %u",

220 
›íCh≠ãr
->
size
, o≥nCh≠ãr->
ˇ∑côy
);

223 
›íCh≠ãr
->
¶Ÿs
[
¶Ÿ
].
ªc‹dNumbî
 =ÑecordNumber;

224 
ªc‹d
 = &
›íCh≠ãr
->
ªc‹ds
[
ªc‹dNumbî
];

225 
ªc‹d
->
«me
 = *name;

226 
ªc‹d
->
d©a
 = *
mëad©a
;

228 *
ªmaöög
 = 
›íCh≠ãr
->
ˇ∑côy
 - o≥nCh≠ãr->
size
;

229  
UDS_SUCCESS
;

230 
	}
}

233 
	$ªmoveFromO≥nCh≠ãr
(
O≥nCh≠ãrZ⁄e
 *
›íCh≠ãr
,

234 c⁄° 
UdsChunkName
 *
«me
,

235 
boﬁ
 *
ªmoved
)

237 
ªc‹dNumbî
;

238 
UdsChunkRec‹d
 *
ªc‹d


239 
	`¥obeCh≠ãrSlŸs
(
›íCh≠ãr
, 
«me
, 
NULL
, &
ªc‹dNumbî
);

241 i‡(
ªc‹d
 =
NULL
) {

242 *
ªmoved
 = 
Ál£
;

248 
›íCh≠ãr
->
¶Ÿs
[
ªc‹dNumbî
].
ªc‹dDñëed
 = 
åue
;

249 
›íCh≠ãr
->
dñëed
 += 1;

250 *
ªmoved
 = 
åue
;

251 
	}
}

254 
	$‰ìO≥nCh≠ãr
(
O≥nCh≠ãrZ⁄e
 *
›íCh≠ãr
)

256 i‡(
›íCh≠ãr
 !
NULL
) {

257 
	`FREE
(
›íCh≠ãr
->
ªc‹ds
);

258 
	`FREE
(
›íCh≠ãr
);

260 
	}
}

	@uds/openChapterZone.h

22 #i‚de‡
OPEN_CHAPTER_ZONE_H


23 
	#OPEN_CHAPTER_ZONE_H
 1

	)

25 
	~"comm⁄.h
"

26 
	~"geomëry.h
"

27 
	~"ty≥Defs.h
"

60 
	mOPEN_CHAPTER_RECORD_NUMBER_BITS
 = 23,

61 
	mOPEN_CHAPTER_MAX_RECORD_NUMBER
 = (1 << 
OPEN_CHAPTER_RECORD_NUMBER_BITS
) - 1

66 
	mªc‹dNumbî
 : 
OPEN_CHAPTER_RECORD_NUMBER_BITS
;

68 
boﬁ
 
	mªc‹dDñëed
 : 1;

69 } 
	t__©åibuã__
((
	t∑cked
)Ë
	tSlŸ
;

71 
	s›íCh≠ãrZ⁄e
 {

73 
	mˇ∑côy
;

75 
	msize
;

77 
	mdñëed
;

79 
UdsChunkRec‹d
 *
	mªc‹ds
;

81 
	m¶ŸCou¡
;

83 
SlŸ
 
	m¶Ÿs
[];

84 } 
	tO≥nCh≠ãrZ⁄e
;

95 
	$makeO≥nCh≠ãr
(c⁄° 
Geomëry
 *
geomëry
,

96 
z⁄eCou¡
,

97 
O≥nCh≠ãrZ⁄e
 **
›íCh≠ãrPå
)

98 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

106 
size_t
 
	$›íCh≠ãrSize
(c⁄° 
O≥nCh≠ãrZ⁄e
 *
›íCh≠ãr
)

107 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

114 
	`ª£tO≥nCh≠ãr
(
O≥nCh≠ãrZ⁄e
 *
›íCh≠ãr
);

126 
	`£¨chO≥nCh≠ãr
(
O≥nCh≠ãrZ⁄e
 *
›íCh≠ãr
,

127 c⁄° 
UdsChunkName
 *
«me
,

128 
UdsChunkD©a
 *
mëad©a
,

129 
boﬁ
 *
found
);

142 
	$putO≥nCh≠ãr
(
O≥nCh≠ãrZ⁄e
 *
›íCh≠ãr
,

143 c⁄° 
UdsChunkName
 *
«me
,

144 c⁄° 
UdsChunkD©a
 *
mëad©a
,

145 *
ªmaöög
)

146 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

156 
	`ªmoveFromO≥nCh≠ãr
(
O≥nCh≠ãrZ⁄e
 *
›íCh≠ãr
,

157 c⁄° 
UdsChunkName
 *
«me
,

158 
boﬁ
 *
ªmoved
);

165 
	`‰ìO≥nCh≠ãr
(
O≥nCh≠ãrZ⁄e
 *
›íCh≠ãr
);

	@uds/pageCache.c

22 
	~"∑geCache.h
"

24 
	~"ˇcheCou¡îs.h
"

25 
	~"ch≠ãrIndex.h
"

26 
	~"compûî.h
"

27 
	~"îr‹s.h
"

28 
	~"geomëry.h
"

29 
	~"hashUtûs.h
"

30 
	~"ödexC⁄fig.h
"

31 
	~"loggî.h
"

32 
	~"mem‹yAŒoc.h
"

33 
	~"≥rmas£π.h
"

34 
	~"ªc‹dPage.h
"

35 
	~"°rögUtûs.h
"

36 
	~"thªads.h
"

37 
	~"utû/©omic.h
"

38 
	~"z⁄e.h
"

41 
	$as£πPageInCache
(
PageCache
 *
ˇche
, 
CachedPage
 *
∑ge
)

43 
ªsu…
 = 
	`ASSERT
((
∑ge
->
physiˇlPage
 < 
ˇche
->
numIndexE¡rõs
),

45 
∑ge
->
physiˇlPage
, 
ˇche
->
numIndexE¡rõs
);

46 i‡(
ªsu…
 !
UDS_SUCCESS
) {

47  
ªsu…
;

50 
uöt16_t
 
∑geIndex
 = 
ˇche
->
ödex
[
∑ge
->
physiˇlPage
];

51  
	`ASSERT
((
∑geIndex
 < 
ˇche
->
numCacheE¡rõs
)

52 && (&
ˇche
->ˇche[
∑geIndex
] =
∑ge
),

54 
	}
}

69 
	$˛órPage
(
PageCache
 *
ˇche
, 
CachedPage
 *
∑ge
)

71 
∑ge
->
physiˇlPage
 = 
ˇche
->
numIndexE¡rõs
;

73 
∑ge
->
búth
 = 0;

74 
∑ge
->
œ°U£d
 = 0;

75 
	}
}

88 
__©åibuã__
((
w¨n_unu£d_ªsu…
))

89 
	$gëPageNoSèts
(
PageCache
 *
ˇche
,

90 
physiˇlPage
,

91 *
queueIndex
,

92 
CachedPage
 **
∑gePå
)

94 
ªsu…
 = 
	`ASSERT
((
physiˇlPage
 < 
ˇche
->
numIndexE¡rõs
),

95 "physiˇ»∑gê%u i†övÆid", 
physiˇlPage
);

96 i‡(
ªsu…
 !
UDS_SUCCESS
) {

97  
ªsu…
;

100 
uöt16_t
 
ödexVÆue
 = 
ˇche
->
ödex
[
physiˇlPage
];

101 
boﬁ
 
queued
 = (
ödexVÆue
 & 
VOLUME_CACHE_QUEUED_FLAG
) != 0;

102 
uöt16_t
 
ödex
 = 
ödexVÆue
 & ~
VOLUME_CACHE_QUEUED_FLAG
;

104 *
∑gePå
 = ((!
queued
 && (
ödex
 < 
ˇche
->
numCacheE¡rõs
))

105 ? &
ˇche
->ˇche[
ödex
]

106 : 
NULL
);

107 i‡(
queueIndex
 !
NULL
) {

108 *
queueIndex
 = 
queued
 ? 
ödex
 : -1;

110  
UDS_SUCCESS
;

111 
	}
}

122 
__©åibuã__
((
w¨n_unu£d_ªsu…
))

123 
	$öôülizePage
(
PageCache
 *
ˇche
,

124 
ôem
,

125 
CachedPage
 **
∑gePå
)

127 
CachedPage
 *
∑ge
 = &
ˇche
->ˇche[
ôem
];

128 i‡(
∑ge
 =
NULL
) {

129 *
∑gePå
 = 
NULL
;

130  
UDS_SUCCESS
;

133 
∑ge
->
d©a
 = 
ˇche
->d©®+ (
ôem
 * cache->
geomëry
->
byãsPîPage
);

135 
	`˛órPage
(
ˇche
, 
∑ge
);

137 *
∑gePå
 = 
∑ge
;

138  
UDS_SUCCESS
;

139 
	}
}

150 
	$övÆid©ePageInCache
(
PageCache
 *
ˇche
,

151 
CachedPage
 *
∑ge
,

152 
InvÆid©i⁄Rós⁄
 
ªas⁄
)

154 i‡(
∑ge
 =
NULL
) {

155  
UDS_SUCCESS
;

158 i‡(
∑ge
->
physiˇlPage
 !
ˇche
->
numIndexE¡rõs
) {

159 
ªas⁄
) {

160 
INVALIDATION_EVICT
:

161 
ˇche
->
cou¡îs
.
evi˘i⁄s
++;

163 
INVALIDATION_EXPIRE
:

164 
ˇche
->
cou¡îs
.
expú©i⁄s
++;

170 i‡(
ªas⁄
 !
INVALIDATION_ERROR
) {

171 
ªsu…
 = 
	`as£πPageInCache
(
ˇche
, 
∑ge
);

172 i‡(
ªsu…
 !
UDS_SUCCESS
) {

173  
ªsu…
;

177 
ˇche
->
ödex
[
∑ge
->
physiˇlPage
] = cache->
numCacheE¡rõs
;

180 
	`˛órPage
(
ˇche
, 
∑ge
);

182  
UDS_SUCCESS
;

183 
	}
}

193 
__©åibuã__
((
w¨n_unu£d_ªsu…
))

194 
	$födAndInvÆid©ePage
(
PageCache
 *
ˇche
,

195 
physiˇlPage
)

197 
CachedPage
 *
∑ge
;

198 
ªsu…
 = 
	`gëPageNoSèts
(
ˇche
, 
physiˇlPage
, 
NULL
, &
∑ge
);

199 i‡(
ªsu…
 !
UDS_SUCCESS
) {

200  
ªsu…
;

207  
	`övÆid©ePageInCache
(
ˇche
, 
∑ge
, 
INVALIDATION_INIT_SHUTDOWN
);

208 
	}
}

211 
	$födInvÆid©eAndMakeLó°Re˚¡
(
PageCache
 *
ˇche
,

212 
physiˇlPage
,

213 
QueuedRód
 *
ªadQueue
,

214 
InvÆid©i⁄Rós⁄
 
ªas⁄
,

215 
boﬁ
 
mu°Föd
)

217 i‡(
ˇche
 =
NULL
) {

218  
UDS_SUCCESS
;

221 
CachedPage
 *
∑ge
;

222 
queuedIndex
 = -1;

223 
ªsu…


224 
	`gëPageNoSèts
(
ˇche
, 
physiˇlPage
,

225 ((
ªadQueue
 !
NULL
Ë? &
queuedIndex
 : NULL), &
∑ge
);

226 i‡(
ªsu…
 !
UDS_SUCCESS
) {

227  
ªsu…
;

230 i‡(
∑ge
 =
NULL
) {

231 
ªsu…
 = 
	`ASSERT
(!
mu°Föd
, "foundÖage");

232 i‡(
ªsu…
 !
UDS_SUCCESS
) {

233  
ªsu…
;

236 i‡(
queuedIndex
 > -1) {

237 
	`logDebug
("settingÖendingÑeadÅo invalid");

238 
ªadQueue
[
queuedIndex
].
övÆid
 = 
åue
;

240  
UDS_SUCCESS
;

244 
ªsu…
 = 
	`övÆid©ePageInCache
(
ˇche
, 
∑ge
, 
ªas⁄
);

245 i‡(
ªsu…
 !
UDS_SUCCESS
) {

246  
ªsu…
;

251 
∑ge
->
œ°U£d
 = 0;

253  
UDS_SUCCESS
;

254 
	}
}

257 
__©åibuã__
((
w¨n_unu£d_ªsu…
))

258 
	$öôülizePageCache
(
PageCache
 *
ˇche
,

259 c⁄° 
Geomëry
 *
geomëry
,

260 
ch≠ãrsInCache
,

261 
ªadQueueMaxSize
,

262 
z⁄eCou¡
)

264 
ˇche
->
geomëry
 = geometry;

265 
ˇche
->
numIndexE¡rõs
 = 
geomëry
->
∑gesPîVﬁume
 + 1;

266 
ˇche
->
numCacheE¡rõs
 = 
ch≠ãrsInCache
 * 
geomëry
->
ªc‹dPagesPîCh≠ãr
;

267 
ˇche
->
ªadQueueMaxSize
 =ÑeadQueueMaxSize;

268 
ˇche
->
z⁄eCou¡
 = zoneCount;

270 
ªsu…
 = 
	`ALLOCATE
(
ªadQueueMaxSize
, 
QueuedRód
,

271 "vﬁumêªad queue", &
ˇche
->
ªadQueue
);

272 i‡(
ªsu…
 !
UDS_SUCCESS
) {

273  
ªsu…
;

276 
ªsu…
 = 
	`ALLOCATE
(
ˇche
->
z⁄eCou¡
, vﬁ©ûê
InvÆid©eCou¡î
,

278 &
ˇche
->
£¨chPídögCou¡îs
);

279 i‡(
ªsu…
 !
UDS_SUCCESS
) {

280  
ªsu…
;

283 
ªsu…
 = 
	`ASSERT
((
ˇche
->
numCacheE¡rõs
 <
VOLUME_CACHE_MAX_ENTRIES
),

285 
ˇche
->
numCacheE¡rõs
, 
VOLUME_CACHE_MAX_ENTRIES
);

286 i‡(
ªsu…
 !
UDS_SUCCESS
) {

287  
ªsu…
;

290 
ªsu…
 = 
	`ALLOCATE
(
ˇche
->
numIndexE¡rõs
, vﬁ©ûê
uöt16_t
,

291 "∑gêˇchêödex", &
ˇche
->
ödex
);

292 i‡(
ªsu…
 !
UDS_SUCCESS
) {

293  
ªsu…
;

297 
i
 = 0; i < 
ˇche
->
numIndexE¡rõs
; i++) {

298 
ˇche
->
ödex
[
i
] = cache->
numCacheE¡rõs
;

301 
ªsu…
 = 
	`ALLOCATE
(
ˇche
->
numCacheE¡rõs
, 
CachedPage
,

302 "∑gêˇchêˇche", &
ˇche
->cache);

303 i‡(
ªsu…
 !
UDS_SUCCESS
) {

304  
ªsu…
;

307 
d©aSize
 = 
geomëry
->
byãsPîPage
 * 
ˇche
->
numCacheE¡rõs
;

308 
ªsu…
 = 
	`ALLOCATE_IO_ALIGNED
(
d©aSize
, 
byã
, "ˇchê∑gêd©a", &
ˇche
->
d©a
);

309 i‡(
ªsu…
 !
UDS_SUCCESS
) {

310  
ªsu…
;

313 
i
 = 0; i < 
ˇche
->
numCacheE¡rõs
; i++) {

314 
CachedPage
 *
∑ge
;

315 
ªsu…
 = 
	`öôülizePage
(
ˇche
, 
i
, &
∑ge
);

316 i‡(
ªsu…
 !
UDS_SUCCESS
) {

317  
ªsu…
;

321  
UDS_SUCCESS
;

322 
	}
}

325 
	$makePageCache
(c⁄° 
Geomëry
 *
geomëry
,

326 
ch≠ãrsInCache
,

327 
ªadQueueMaxSize
,

328 
z⁄eCou¡
,

329 
PageCache
 **
ˇchePå
)

331 i‡(
ch≠ãrsInCache
 < 1) {

332  
	`logW¨nögWôhSåögEº‹
(
UDS_BAD_STATE
,

336 i‡(
ªadQueueMaxSize
 <= 0) {

337  
	`logW¨nögWôhSåögEº‹
(
UDS_INVALID_ARGUMENT
,

341 i‡(
z⁄eCou¡
 < 1) {

342  
	`logW¨nögWôhSåögEº‹
(
UDS_INVALID_ARGUMENT
,

346 
PageCache
 *
ˇche
;

347 
ªsu…
 = 
	`ALLOCATE
(1, 
PageCache
, "vﬁumêˇche", &
ˇche
);

348 i‡(
ªsu…
 !
UDS_SUCCESS
) {

349  
ªsu…
;

352 
ªsu…
 = 
	`öôülizePageCache
(
ˇche
, 
geomëry
, 
ch≠ãrsInCache
,

353 
ªadQueueMaxSize
, 
z⁄eCou¡
);

354 i‡(
ªsu…
 !
UDS_SUCCESS
) {

355 
	`‰ìPageCache
(
ˇche
);

356  
ªsu…
;

359 *
ˇchePå
 = 
ˇche
;

360  
UDS_SUCCESS
;

361 
	}
}

364 
	$‰ìPageCache
(
PageCache
 *
ˇche
)

366 i‡(
ˇche
 =
NULL
) {

370 
	`‰ìVﬁ©ûe
(
ˇche
->
ödex
);

371 
	`FREE
(
ˇche
->
d©a
);

372 
	`FREE
(
ˇche
->cache);

374 
	`‰ìVﬁ©ûe
(
ˇche
->
£¨chPídögCou¡îs
);

375 
	`FREE
(
ˇche
->
ªadQueue
);

376 
	`FREE
(
ˇche
);

377 
	}
}

380 
	$övÆid©ePageCache
(
PageCache
 *
ˇche
)

382 i‡(
ˇche
 =
NULL
) {

383  
UDS_SUCCESS
;

387 
i
 = 0; i < 
ˇche
->
numIndexE¡rõs
; i++) {

388 
ªsu…
 = 
	`födAndInvÆid©ePage
(
ˇche
, 
i
);

389 i‡(
ªsu…
 !
UDS_SUCCESS
) {

390  
ªsu…
;

394  
UDS_SUCCESS
;

395 
	}
}

398 
	$övÆid©ePageCacheF‹Ch≠ãr
(
PageCache
 *
ˇche
,

399 
ch≠ãr
,

400 
∑gesPîCh≠ãr
,

401 
InvÆid©i⁄Rós⁄
 
ªas⁄
)

403 i‡((
ˇche
 =
NULL
) || (cache->cache == NULL)) {

404  
UDS_SUCCESS
;

407 
ªsu…
;

408 
i
 = 0; i < 
∑gesPîCh≠ãr
; i++) {

409 
physiˇlPage
 = 1 + (
∑gesPîCh≠ãr
 * 
ch≠ãr
Ë+ 
i
;

410 
ªsu…
 = 
	`födInvÆid©eAndMakeLó°Re˚¡
(
ˇche
, 
physiˇlPage
,

411 
ˇche
->
ªadQueue
,

412 
ªas⁄
, 
Ál£
);

413 i‡(
ªsu…
 !
UDS_SUCCESS
) {

414  
ªsu…
;

418  
UDS_SUCCESS
;

419 
	}
}

422 
	$makePageMo°Re˚¡
(
PageCache
 *
ˇche
, 
CachedPage
 *
∑ge
)

424 i‡(
ˇche
 =
NULL
) {

428 
ˇche
->
˛ock
 += 1;

429 
∑ge
->
œ°U£d
 = 
ˇche
->
˛ock
;

430 
	}
}

441 
__©åibuã__
((
w¨n_unu£d_ªsu…
))

442 
	$gëLó°Re˚¡Page
(
PageCache
 *
ˇche
, 
CachedPage
 **
∑gePå
)

444 
boﬁ
 
foundOlde°
 = 
Ál£
;

445 
uöt16_t
 
ﬁde°Index
 = 0;

446 
i
 = 0; i < 
ˇche
->
numCacheE¡rõs
; i++) {

447 i‡(!
ˇche
->ˇche[
i
].
ªadPídög
 &&

448 (!
foundOlde°


449 || 
ˇche
->ˇche[
i
].
œ°U£d
 <ˇche->ˇche[
ﬁde°Index
].lastUsed)) {

450 
foundOlde°
 = 
åue
;

451 
ﬁde°Index
 = 
i
;

457 
ªsu…
 = 
	`ASSERT
(
foundOlde°
, "oldestÖage isÇot NULL");

458 i‡(
ªsu…
 !
UDS_SUCCESS
) {

459  
ªsu…
;

462 *
∑gePå
 = &
ˇche
->ˇche[
ﬁde°Index
];

463  
UDS_SUCCESS
;

464 
	}
}

467 
	$gëPageFromCache
(
PageCache
 *
ˇche
,

468 
physiˇlPage
,

469 
¥obeTy≥
,

470 
CachedPage
 **
∑gePå
)

472 i‡(
ˇche
 =
NULL
) {

473  
	`logW¨nögWôhSåögEº‹
(
UDS_BAD_STATE
,

478 
CachedPage
 *
∑ge
;

479 
queueIndex
 = -1;

480 
ªsu…
 = 
	`gëPageNoSèts
(
ˇche
, 
physiˇlPage
, &
queueIndex
, &
∑ge
);

481 i‡(
ªsu…
 !
UDS_SUCCESS
) {

482  
ªsu…
;

485 
CacheResu…Köd
 
ˇcheResu…
 = ((
∑ge
 !
NULL
)

486 ? 
CACHE_RESULT_HIT


487 : ((
queueIndex
 != -1)

488 ? 
CACHE_RESULT_QUEUED


489 : 
CACHE_RESULT_MISS
));

490 
	`addToCacheCou¡î
(&
ˇche
->
cou¡îs
, 
¥obeTy≥
, 
ˇcheResu…
, 1);

492 i‡(
∑gePå
 !
NULL
) {

493 *
∑gePå
 = 
∑ge
;

495  
UDS_SUCCESS
;

496 
	}
}

499 
	$íqueueRód
(
PageCache
 *
ˇche
, 
Reque°
 *
ªque°
, 
physiˇlPage
)

501 
uöt16_t
 
fú°
 = 
ˇche
->
ªadQueueFú°
;

502 
uöt16_t
 
œ°
 = 
ˇche
->
ªadQueueLa°
;

503 
uöt16_t
 
√xt
 = (
œ°
 + 1Ë% 
ˇche
->
ªadQueueMaxSize
;

504 
uöt16_t
 
ªadQueuePos
;

506 i‡((
ˇche
->
ödex
[
physiˇlPage
] & 
VOLUME_CACHE_QUEUED_FLAG
) == 0) {

508 i‡(
√xt
 =
fú°
) {

510  
UDS_SUCCESS
;

513 
ˇche
->
ªadQueue
[
œ°
].
physiˇlPage
 =ÖhysicalPage;

514 
ˇche
->
ªadQueue
[
œ°
].
övÆid
 = 
Ál£
;

517 
ªadQueuePos
 = 
œ°
;

518 
ˇche
->
ödex
[
physiˇlPage
] = 
ªadQueuePos
 | 
VOLUME_CACHE_QUEUED_FLAG
;

519 
	`STAILQ_INIT
(&
ˇche
->
ªadQueue
[
ªadQueuePos
].
queueHód
);

521 
ˇche
->
ªadQueueLa°
 = 
√xt
;

524 
ªadQueuePos
 = 
ˇche
->
ödex
[
physiˇlPage
] & ~
VOLUME_CACHE_QUEUED_FLAG
;

527 
ªsu…
 = 
	`ASSERT
((
ªadQueuePos
 < 
ˇche
->
ªadQueueMaxSize
),

529 i‡(
ªsu…
 !
UDS_SUCCESS
) {

530  
ªsu…
;

533 
	`STAILQ_INSERT_TAIL
(&
ˇche
->
ªadQueue
[
ªadQueuePos
].
queueHód
, 
ªque°
, 
lök
);

534  
UDS_QUEUED
;

535 
	}
}

538 
boﬁ
 
	$ª£rveRódQueueE¡ry
(
PageCache
 *
ˇche
,

539 *
queuePos
,

540 
UdsQueueHód
 *
queuedReque°s
,

541 *
physiˇlPage
,

542 
boﬁ
 *
övÆid
)

544 
uöt16_t
 
œ°Ród
 = 
ˇche
->
ªadQueueLa°Ród
;

547 i‡(
œ°Ród
 =
ˇche
->
ªadQueueLa°
) {

548  
Ál£
;

551 
∑geNo
 = 
ˇche
->
ªadQueue
[
œ°Ród
].
physiˇlPage
;

552 
boﬁ
 
isInvÆid
 = 
ˇche
->
ªadQueue
[
œ°Ród
].
övÆid
;

554 
uöt16_t
 
ödexVÆue
 = 
ˇche
->
ödex
[
∑geNo
];

555 
boﬁ
 
queued
 = (
ödexVÆue
 & 
VOLUME_CACHE_QUEUED_FLAG
) != 0;

558 i‡(
isInvÆid
 && 
queued
) {

560 
ˇche
->
ödex
[
∑geNo
] = cache->
numCacheE¡rõs
;

565 i‡(!
queued
) {

566 
isInvÆid
 = 
åue
;

569 
ˇche
->
ªadQueue
[
œ°Ród
].
ª£rved
 = 
åue
;

571 *
queuePos
 = 
œ°Ród
;

572 *
queuedReque°s
 = 
ˇche
->
ªadQueue
[
œ°Ród
].
queueHód
;

573 *
physiˇlPage
 = 
∑geNo
;

574 *
övÆid
 = 
isInvÆid
;

575 
ˇche
->
ªadQueueLa°Ród
 = (
œ°Ród
 + 1Ë% cache->
ªadQueueMaxSize
;

577  
åue
;

578 
	}
}

581 
	$ªÀa£RódQueueE¡ry
(
PageCache
 *
ˇche
, 
queuePos
)

583 
ˇche
->
ªadQueue
[
queuePos
].
ª£rved
 = 
Ál£
;

585 
uöt16_t
 
œ°Ród
 = 
ˇche
->
ªadQueueLa°Ród
;

588 (
ˇche
->
ªadQueueFú°
 !
œ°Ród
)

589 && (!
ˇche
->
ªadQueue
[ˇche->
ªadQueueFú°
].
ª£rved
)) {

590 
ˇche
->
ªadQueueFú°
 =

591 (
ˇche
->
ªadQueueFú°
 + 1Ë% cache->
ªadQueueMaxSize
;

593 
	}
}

596 
	$£À˘Vi˘imInCache
(
PageCache
 *
ˇche
,

597 
CachedPage
 **
∑gePå
)

599 i‡(
ˇche
 =
NULL
) {

600  
	`logW¨nögWôhSåögEº‹
(
UDS_BAD_STATE
,

604 
CachedPage
 *
∑ge
;

605 
ªsu…
 = 
	`gëLó°Re˚¡Page
(
ˇche
, &
∑ge
);

606 i‡(
ªsu…
 !
UDS_SUCCESS
) {

607  
ªsu…
;

610 
ªsu…
 = 
	`ASSERT
((
∑ge
 !
NULL
), "leastÑecentÖage wasÇot NULL");

611 i‡(
ªsu…
 !
UDS_SUCCESS
) {

612  
ªsu…
;

617 i‡(
∑ge
->
physiˇlPage
 !
ˇche
->
numIndexE¡rõs
) {

618 
ˇche
->
cou¡îs
.
evi˘i⁄s
++;

619 
ˇche
->
ödex
[
∑ge
->
physiˇlPage
] = cache->
numCacheE¡rõs
;

622 
∑ge
->
ªadPídög
 = 
åue
;

624 *
∑gePå
 = 
∑ge
;

626  
UDS_SUCCESS
;

627 
	}
}

630 
	$putPageInCache
(
PageCache
 *
ˇche
,

631 
physiˇlPage
,

632 
CachedPage
 *
∑ge
)

634 i‡(
ˇche
 =
NULL
) {

635  
	`logW¨nögWôhSåögEº‹
(
UDS_BAD_STATE
,

639 
ˇche
->
˛ock
 += 1;

641 
ªsu…
 = 
	`ASSERT
((
∑ge
 !
NULL
), "pageÅo installÉxists");

642 i‡(
ªsu…
 !
UDS_SUCCESS
) {

643  
ªsu…
;

646 
ªsu…
 = 
	`ASSERT
((
∑ge
->
ªadPídög
),

648 i‡(
ªsu…
 !
UDS_SUCCESS
) {

649  
ªsu…
;

652 
	`˛órPage
(
ˇche
, 
∑ge
);

654 
∑ge
->
physiˇlPage
 =ÖhysicalPage;

655 
∑ge
->
búth
 = 
ˇche
->
˛ock
;

658 
uöt16_t
 
vÆue
 = 
∑ge
 - 
ˇche
->cache;

659 
ªsu…
 = 
	`ASSERT
((
vÆue
 < 
ˇche
->
numCacheE¡rõs
), "cache index is valid");

660 i‡(
ªsu…
 !
UDS_SUCCESS
) {

661  
ªsu…
;

664 
	`makePageMo°Re˚¡
(
ˇche
, 
∑ge
);

666 
∑ge
->
ªadPídög
 = 
Ál£
;

670 
	`°‹eFí˚
();

673 
ˇche
->
ödex
[
physiˇlPage
] = 
vÆue
;

675  
UDS_SUCCESS
;

676 
	}
}

679 
	$ˇn˚lPageInCache
(
PageCache
 *
ˇche
,

680 
physiˇlPage
,

681 
CachedPage
 *
∑ge
)

683 i‡(
ˇche
 =
NULL
) {

684 
	`logW¨nög
("cannot cancelÖage in NULL cache");

688 
ªsu…
 = 
	`ASSERT
((
∑ge
 !
NULL
), "pageÅo installÉxists");

689 i‡(
ªsu…
 !
UDS_SUCCESS
) {

693 
ªsu…
 = 
	`ASSERT
((
∑ge
->
ªadPídög
),

695 i‡(
ªsu…
 !
UDS_SUCCESS
) {

699 
	`˛órPage
(
ˇche
, 
∑ge
);

701 
∑ge
->
ªadPídög
 = 
Ál£
;

705 
	`°‹eFí˚
();

708 
ˇche
->
ödex
[
physiˇlPage
] = cache->
numCacheE¡rõs
;

709 
	}
}

712 
INLINE
 
boﬁ
 
	$°ûlSórchög
(
PageCache
 *
ˇche
,

713 
physiˇlPage
,

714 
z⁄eNumbî
,

715 
ﬁdVÆue
)

717  ((
ˇche
->
£¨chPídögCou¡îs
[
z⁄eNumbî
].
cou¡î
 =
ﬁdVÆue
)

718 && (
ˇche
->
£¨chPídögCou¡îs
[
z⁄eNumbî
].
∑ge
 =
physiˇlPage
));

719 
	}
}

722 
	$waôF‹PídögSórches
(
PageCache
 *
ˇche
, 
physiˇlPage
)

724 
uöt32_t
 *
öôülCou¡îVÆues
;

726 
ªsu…
 = 
	`ALLOCATE
(
ˇche
->
z⁄eCou¡
, 
uöt32_t
,

728 &
öôülCou¡îVÆues
);

729 i‡(
ªsu…
 !
UDS_SUCCESS
) {

730  
UDS_SUCCESS
;

733 
i
 = 0; i < 
ˇche
->
z⁄eCou¡
; i++) {

734 
öôülCou¡îVÆues
[
i
] = 
ˇche
->
£¨chPídögCou¡îs
[i].
cou¡î
;

737 
i
 = 0; i < 
ˇche
->
z⁄eCou¡
; i++) {

738 i‡(
	`£¨chPídög
(
öôülCou¡îVÆues
[
i
])) {

739 
	`°ûlSórchög
(
ˇche
, 
physiˇlPage
, 
i
, 
öôülCou¡îVÆues
[i])) {

740 
	`yõldScheduÀr
();

744 
	`FREE
(
öôülCou¡îVÆues
);

745  
UDS_SUCCESS
;

746 
	}
}

749 
size_t
 
	$gëPageCacheSize
(
PageCache
 *
ˇche
)

751 i‡(
ˇche
 =
NULL
) {

754 
size_t
 
∑geSize
 = ((
ˇche
->
geomëry
->
byãsPîPage
 +

755 (
Ch≠ãrIndexPage
)) *

756 
ˇche
->
numCacheE¡rõs
);

758  
∑geSize
;

759 
	}
}

762 
	$gëPageCacheCou¡îs
(
PageCache
 *
ˇche
, 
CacheCou¡îs
 *
cou¡îs
)

764 *
cou¡îs
 = 
ˇche
->counters;

765 
	}
}

	@uds/pageCache.h

22 #i‚de‡
PAGE_CACHE_H_


23 
	#PAGE_CACHE_H_


	)

25 
	~"ˇcheCou¡îs.h
"

26 
	~"ch≠ãrIndex.h
"

27 
	~"comm⁄.h
"

28 
	~"compûî.h
"

29 
	~"ödexC⁄fig.h
"

30 
	~"›aqueTy≥s.h
"

31 
	~"≥rmas£π.h
"

32 
	~"ªque°.h
"

34 
STAILQ_HEAD
(
udsQueueHód
, 
ªque°
);

35 
udsQueueHód
 
	tUdsQueueHód
;

37 
	sˇchedPage
 {

39 
boﬁ
 
	mªadPídög
;

41 
	mphysiˇlPage
;

43 
uöt64_t
 
	mbúth
;

45 
uöt64_t
 
	mœ°U£d
;

47 
byã
 *
	md©a
;

49 
Ch≠ãrIndexPage
 
	mödexPage
;

50 } 
	tCachedPage
;

53 
	mVOLUME_CACHE_MAX_ENTRIES
 = (
UINT16_MAX
 >> 1),

54 
	mVOLUME_CACHE_QUEUED_FLAG
 = (1 << 15),

55 
	mVOLUME_CACHE_DEFAULT_MAX_QUEUED_READS
 = 4096

58 
	squeuedRód
 {

60 
boﬁ
 
	mövÆid
;

62 
boﬁ
 
	mª£rved
;

64 
	mphysiˇlPage
;

66 
UdsQueueHód
 
	mqueueHód
;

67 } 
	tQueuedRód
;

72 
	eövÆid©i⁄Rós⁄
 {

73 
	mINVALIDATION_EVICT
,

74 
	mINVALIDATION_EXPIRE
,

75 
	mINVALIDATION_ERROR
,

76 
	mINVALIDATION_INIT_SHUTDOWN


77 } 
	tInvÆid©i⁄Rós⁄
;

79 
__©åibuã__
((
	tÆig√d
(
	tCACHE_LINE_BYTES
))Ë
	tövÆid©eCou¡î
 {

80 
uöt32_t
 
cou¡î
;

81 
∑ge
;

82 
	}
} 
	tInvÆid©eCou¡î
;

84 
	s∑geCache
 {

86 
	mnumIndexE¡rõs
;

88 
uöt16_t
 
	mnumCacheE¡rõs
;

93 vﬁ©ûê
uöt16_t
 *
	mödex
;

95 
CachedPage
 *
	mˇche
;

97 
byã
 *
	md©a
;

99 
CacheCou¡îs
 
	mcou¡îs
;

102 
QueuedRód
 *
	mªadQueue
;

124 
uöt16_t
 
	mªadQueueFú°
;

125 
uöt16_t
 
	mªadQueueLa°Ród
;

126 
uöt16_t
 
	mªadQueueLa°
;

128 
	mªadQueueMaxSize
;

132 vﬁ©ûê
InvÆid©eCou¡î
 *
	m£¨chPídögCou¡îs
;

133 
	mz⁄eCou¡
;

135 
uöt64_t
 
	m˛ock
;

137 c⁄° 
Geomëry
 *
	mgeomëry
;

138 } 
	tPageCache
;

151 
	$makePageCache
(c⁄° 
Geomëry
 *
geomëry
,

152 
ch≠ãrsInCache
,

153 
ªadQueueMaxSize
,

154 
z⁄eCou¡
,

155 
PageCache
 **
ˇchePå
)

156 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

163 
	`‰ìPageCache
(
PageCache
 *
ˇche
);

172 
	$övÆid©ePageCache
(
PageCache
 *
ˇche
)

173 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

185 
	$övÆid©ePageCacheF‹Ch≠ãr
(
PageCache
 *
ˇche
,

186 
ch≠ãr
,

187 
∑gesPîCh≠ãr
,

188 
InvÆid©i⁄Rós⁄
 
ªas⁄
)

189 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

198 
	`övÆid©ePageInCache
(
PageCache
 *
ˇche
,

199 
CachedPage
 *
∑ge
,

200 
InvÆid©i⁄Rós⁄
 
ªas⁄
);

215 
	`födInvÆid©eAndMakeLó°Re˚¡
(
PageCache
 *
ˇche
,

216 
physiˇlPage
,

217 
QueuedRód
 *
ªadQueue
,

218 
InvÆid©i⁄Rós⁄
 
ªas⁄
,

219 
boﬁ
 
mu°Föd
);

229 
	`makePageMo°Re˚¡
(
PageCache
 *
ˇche
, 
CachedPage
 *
∑gePå
);

240 
	$as£πPageInCache
(
PageCache
 *
ˇche
, 
CachedPage
 *
∑ge
)

241 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

254 
	$gëPageFromCache
(
PageCache
 *
ˇche
,

255 
physiˇlPage
,

256 
¥obeTy≥
,

257 
CachedPage
 **
∑gePå
)

258 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

271 
	$íqueueRód
(
PageCache
 *
ˇche
, 
Reque°
 *
ªque°
, 
physiˇlPage
)

272 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

286 
boﬁ
 
	`ª£rveRódQueueE¡ry
(
PageCache
 *
ˇche
,

287 *
queuePos
,

288 
UdsQueueHód
 *
queuedReque°s
,

289 *
physiˇlPage
,

290 
boﬁ
 *
övÆid
);

301 
	`ªÀa£RódQueueE¡ry
(
PageCache
 *
ˇche
,

302 
queuePos
);

311 
INLINE
 
boﬁ
 
	$ªadQueueIsEm±y
(
PageCache
 *
ˇche
)

313  (
ˇche
->
ªadQueueFú°
 =ˇche->
ªadQueueLa°
);

314 
	}
}

323 
INLINE
 
boﬁ
 
	$ªadQueueIsFuŒ
(
PageCache
 *
ˇche
)

325  (
ˇche
->
ªadQueueFú°
 ==

326 (
ˇche
->
ªadQueueLa°
 + 1Ë% cache->
ªadQueueMaxSize
);

327 
	}
}

340 
	$£À˘Vi˘imInCache
(
PageCache
 *
ˇche
,

341 
CachedPage
 **
∑gePå
)

342 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

357 
	$putPageInCache
(
PageCache
 *
ˇche
,

358 
physiˇlPage
,

359 
CachedPage
 *
∑ge
)

360 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

376 
	`ˇn˚lPageInCache
(
PageCache
 *
ˇche
,

377 
physiˇlPage
,

378 
CachedPage
 *
∑ge
);

387 
size_t
 
	$gëPageCacheSize
(
PageCache
 *
ˇche
)

388 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

396 
	`gëPageCacheCou¡îs
(
PageCache
 *
ˇche
, 
CacheCou¡îs
 *
cou¡îs
);

405 
INLINE
 
boﬁ
 
	$£¨chPídög
(
cou¡îVÆue
)

407  
cou¡îVÆue
 % 2 == 1;

408 
	}
}

418 
INLINE
 
boﬁ
 
	$isSórchPídög
(
PageCache
 *
ˇche
,

419 
z⁄eNumbî
)

421  
	`£¨chPídög
(
ˇche
->
£¨chPídögCou¡îs
[
z⁄eNumbî
].
cou¡î
);

422 
	}
}

432 
	#ASSERT_SEARCH_IS_PENDING
(
ˇche
, 
z⁄eNumbî
) \

433 
	`ASSERT_LOG_ONLY
(
	`isSórchPídög
((
ˇche
), (
z⁄eNumbî
)), \

435 (
z⁄eNumbî
))

	)

447 
INLINE
 
	$begöPídögSórch
(
PageCache
 *
ˇche
,

448 
physiˇlPage
,

449 
z⁄eNumbî
)

451 
ˇche
->
£¨chPídögCou¡îs
[
z⁄eNumbî
].
∑ge
 = 
physiˇlPage
;

452 
ˇche
->
£¨chPídögCou¡îs
[
z⁄eNumbî
].
cou¡î
++;

453 
	`ASSERT_SEARCH_IS_PENDING
(
ˇche
, 
z⁄eNumbî
);

454 
	}
}

466 
INLINE
 
	$ídPídögSórch
(
PageCache
 *
ˇche
,

467 
z⁄eNumbî
)

469 
	`ASSERT_SEARCH_IS_PENDING
(
ˇche
, 
z⁄eNumbî
);

470 
ˇche
->
£¨chPídögCou¡îs
[
z⁄eNumbî
].
cou¡î
++;

471 
	}
}

481 
	$waôF‹PídögSórches
(
PageCache
 *
ˇche
, 
physiˇlPage
)

482 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

	@uds/parameter.c

22 
	~"∑ømëî.h
"

24 
	~"comm⁄.h
"

25 
	~"mem‹yAŒoc.h
"

26 
	~"°rögUtûs.h
"

27 
	~"thªadOn˚.h
"

28 
	~"ty≥Defs.h
"

29 
	~"uds.h
"

31 c⁄° 
UdsP¨amëîVÆue
 
	gUDS_PARAM_TRUE
 = {

32 .
ty≥
 = 
UDS_PARAM_TYPE_BOOL
,

33 .
	gvÆue
.
	gu_boﬁ
 = 
åue
,

36 c⁄° 
UdsP¨amëîVÆue
 
	gUDS_PARAM_FALSE
 = {

37 .
ty≥
 = 
UDS_PARAM_TYPE_BOOL
,

38 .
	gvÆue
.
	gu_boﬁ
 = 
Ál£
,

41 c⁄° * c⁄° 
	gUDS_PARALLEL_FACTOR
 = "UDS_PARALLEL_FACTOR";

42 c⁄° * c⁄° 
	gUDS_TIME_REQUEST_TURNAROUND
 = "UDS_TIME_REQUEST_TURNAROUND";

43 c⁄° * c⁄° 
	gUDS_VOLUME_READ_THREADS
 = "UDS_VOLUME_READ_THREADS";

45 c⁄° * c⁄° 
	gUDS_PARAMETER_TEST_PARAM
 = "UDS_PARAMETER_TEST_PARAM";

47 
deföeP¨amëîTe°P¨am
(
P¨amëîDeföôi⁄
 *);

49 c⁄° 
	s∑ømDef
 {

50 c⁄° * c⁄° *
	m«me
;

51 (*
	mfunc
)(
P¨amëîDeföôi⁄
 *
	mpd
);

52 } 
	gdeföôi⁄s
[] = {

53 { &
UDS_PARALLEL_FACTOR
, 
deföeP¨ÆÀlFa˘‹
 },

54 { &
UDS_TIME_REQUEST_TURNAROUND
, 
deföeTimeReque°Tu∫¨ound
 },

55 { &
UDS_VOLUME_READ_THREADS
, 
deföeVﬁumeRódThªads
 },

56 { &
UDS_PARAMETER_TEST_PARAM
, 
deföeP¨amëîTe°P¨am
 },

59 
On˚Sèã
 
	g∑ømOn˚
 = 
ONCE_STATE_INITIALIZER
;

65 
size_t
 
	mcou¡
;

66 
P¨amëîDeföôi⁄
 
	m∑øms
[
COUNT_OF
(
deföôi⁄s
)];

67 } 
	g∑ømTabÀ
;

70 
boﬁ
 
	$ö°ÆlP¨amDef
(c⁄° 
∑ømDef
 *
pdef
)

72 i‡(
∑ømTabÀ
.
cou¡
 >
	`COUNT_OF
(
deföôi⁄s
)) {

73  
Ál£
;

75 
P¨amëîDeföôi⁄
 *
pd
 = 
∑ømTabÀ
.
∑øms
 +Ö¨amTabÀ.
cou¡
;

76 
	`mem£t
(
pd
, 0, (*pd));

77 
pd
->
«me
 = *
pdef
->name;

78 
ªsu…
 = 
pdef
->
	`func
(
pd
);

79 i‡((
ªsu…
 =
UDS_SUCCESS
) &&

80 (
pd
->
cuºítVÆue
.
ty≥
 !
UDS_PARAM_TYPE_UNSPECIFIED
)) {

81 i‡(
pd
->
ª£t
 =
NULL
) {

82 
pd
->
ª£t
 = 
pdef
->
func
;

84 ++
∑ømTabÀ
.
cou¡
;

85  
åue
;

87  
Ál£
;

88 
	}
}

91 
	$öôP¨amëîs
()

94 
	`mem£t
(&
∑ømTabÀ
, 0, (paramTable));

95 
i
 = 0; i < 
	`COUNT_OF
(
deföôi⁄s
); ++i) {

96 
	`ö°ÆlP¨amDef
(&
deföôi⁄s
[
i
]);

98 
	}
}

101 
	$ˇŒInô
()

103  
	`≥rf‹mOn˚
(&
∑ømOn˚
, 
öôP¨amëîs
);

104 
	}
}

107 
	$udsSëP¨amëî
(c⁄° *
«me
, 
UdsP¨amëîVÆue
 
vÆue
)

109 
ªsu…
 = 
	`ˇŒInô
();

110 i‡(
ªsu…
 !
UDS_SUCCESS
) {

111  
ªsu…
;

113 
ªsu…
 = 
UDS_UNKNOWN_PARAMETER
;

114 
P¨amëîDeföôi⁄
 *
pd
 = 
∑ømTabÀ
.
∑øms
;

115 
pd
 < 
∑ømTabÀ
.
∑øms
 +Ö¨amTabÀ.
cou¡
;

116 ++
pd
)

118 i‡(
«me
 =
pd
->«mê|| 
	`°rcmp
(name,Öd->name) == 0) {

119 i‡(
pd
->
vÆid©e
 !
NULL
) {

120 
ªsu…
 = 
pd
->
	`vÆid©e
(&
vÆue
,Öd->
vÆid©i⁄D©a
, &pd->
cuºítVÆue
);

121 } i‡(
pd
->
cuºítVÆue
.
ty≥
 !
vÆue
.type) {

122 
ªsu…
 = 
UDS_BAD_PARAMETER_TYPE
;

124 
pd
->
cuºítVÆue
 = 
vÆue
;

125 
ªsu…
 = 
UDS_SUCCESS
;

127 i‡((
ªsu…
 =
UDS_SUCCESS
Ë&& (
pd
->
upd©e
 !
NULL
)) {

128 
pd
->
	`upd©e
(&pd->
cuºítVÆue
);

133  
ªsu…
;

134 
	}
}

137 
	$udsGëP¨amëî
(c⁄° *
«me
, 
UdsP¨amëîVÆue
 *
vÆue
)

139 
ªsu…
 = 
	`ˇŒInô
();

140 i‡(
ªsu…
 !
UDS_SUCCESS
) {

141  
ªsu…
;

143 
ªsu…
 = 
UDS_UNKNOWN_PARAMETER
;

144 
P¨amëîDeföôi⁄
 *
pd
 = 
∑ømTabÀ
.
∑øms
;

145 
pd
 < 
∑ømTabÀ
.
∑øms
 +Ö¨amTabÀ.
cou¡
;

146 ++
pd
)

148 i‡(
«me
 =
pd
->«mê|| 
	`°rcmp
(name,Öd->name) == 0) {

149 i‡(
vÆue
 !
NULL
) {

150 *
vÆue
 = 
pd
->
cuºítVÆue
;

152 
ªsu…
 = 
UDS_SUCCESS
;

156  
ªsu…
;

157 
	}
}

160 
	$udsIãøãP¨amëî
(
ödex
,

161 c⁄° **
«me
,

162 
UdsP¨amëîVÆue
 *
vÆue
)

164 
ªsu…
 = 
	`ˇŒInô
();

165 i‡(
ªsu…
 !
UDS_SUCCESS
) {

166  
ªsu…
;

168 
ªsu…
 = 
UDS_UNKNOWN_PARAMETER
;

169 i‡(
ödex
 < 
∑ømTabÀ
.
cou¡
) {

170 
P¨amëîDeföôi⁄
 *
pd
 = &
∑ømTabÀ
.
∑øms
[
ödex
];

171 i‡(
«me
 !
NULL
) {

172 *
«me
 = 
pd
->name;

174 i‡(
vÆue
 !
NULL
) {

175 *
vÆue
 = 
pd
->
cuºítVÆue
;

177 
ªsu…
 = 
UDS_SUCCESS
;

179  
ªsu…
;

180 
	}
}

183 
	$udsRe£tP¨amëî
(c⁄° *
«me
)

185 
ªsu…
 = 
	`ˇŒInô
();

186 i‡(
ªsu…
 !
UDS_SUCCESS
) {

187  
ªsu…
;

189 
ªsu…
 = 
UDS_UNKNOWN_PARAMETER
;

190 
P¨amëîDeföôi⁄
 *
pd
 = 
∑ømTabÀ
.
∑øms
;

191 
pd
 < 
∑ømTabÀ
.
∑øms
 +Ö¨amTabÀ.
cou¡
;

192 ++
pd
)

194 i‡(
«me
 =
pd
->«mê|| 
	`°rcmp
(name,Öd->name) == 0) {

195 
P¨amëîDeföôi⁄
 
c›y
 = *
pd
;

196 
ªsu…
 = 
c›y
.
	`ª£t
(&copy);

197 i‡(
ªsu…
 =
UDS_SUCCESS
) {

198 *
pd
 = 
c›y
;

199 i‡(
pd
->
upd©e
 !
NULL
) {

200 
pd
->
	`upd©e
(&pd->
cuºítVÆue
);

202 } i‡(
ªsu…
 =
UDS_UNKNOWN_PARAMETER
) {

204 &
pd
[1] < 
∑ømTabÀ
.
∑øms
 +Ö¨amTabÀ.
cou¡
) {

205 *
pd
 =Öd[1];

206 ++
pd
;

208 --
∑ømTabÀ
.
cou¡
;

209 
ªsu…
 = 
UDS_SUCCESS
;

214 i‡(
ªsu…
 =
UDS_UNKNOWN_PARAMETER
) {

215 
i
 = 0; i < 
	`COUNT_OF
(
deföôi⁄s
); ++i) {

216 i‡(
	`°rcmp
(
«me
, *
deföôi⁄s
[
i
].name) == 0) {

217 i‡(
	`ö°ÆlP¨amDef
(&
deföôi⁄s
[
i
])) {

218 
ªsu…
 = 
UDS_SUCCESS
;

224  
ªsu…
;

225 
	}
}

228 
UdsP¨amëîVÆue
 
	$udsUnsig√dVÆue
(
numbî
)

230 
UdsP¨amëîVÆue
 
vÆue
 = {

231 .
ty≥
 = 
UDS_PARAM_TYPE_UNSIGNED_INT
,

232 .
vÆue
.
u_uöt
 = 
numbî
,

234  
vÆue
;

235 
	}
}

238 
UdsP¨amëîVÆue
 
	$udsSåögVÆue
(c⁄° *
°rög
)

240 
UdsP¨amëîVÆue
 
vÆue
 = {

241 .
ty≥
 = 
UDS_PARAM_TYPE_STRING
,

242 .
vÆue
.
u_°rög
 = 
°rög
,

244  
vÆue
;

245 
	}
}

248 
UdsP¨amëîVÆue
 
	$udsBoﬁónVÆue
(
boﬁ
 
boﬁón
)

250  
boﬁón
 ? 
UDS_PARAM_TRUE
 : 
UDS_PARAM_FALSE
;

251 
	}
}

254 
vÆid©eBoﬁón
(c⁄° 
UdsP¨amëîVÆue
 *
öput
,

255 c⁄° *
vÆidD©a
 
__©åibuã__
((
unu£d
)),

256 
UdsP¨amëîVÆue
 *
ouçut
)

258 i‡(
	göput
->
	gty≥
 =
UDS_PARAM_TYPE_BOOL
) {

259 
ouçut
->
ty≥
 = 
UDS_PARAM_TYPE_BOOL
;

260 
	gouçut
->
	gvÆue
.
	gu_boﬁ
 = 
öput
->
vÆue
.
u_boﬁ
;

261  
	gUDS_SUCCESS
;

262 } i‡(
	göput
->
	gty≥
 =
UDS_PARAM_TYPE_STRING
) {

263 i‡(
°rˇ£cmp
(
öput
->
vÆue
.
u_°rög
, "true") == 0 ||

264 
°rˇ£cmp
(
öput
->
vÆue
.
u_°rög
, "yes") == 0) {

265 
ouçut
->
ty≥
 = 
UDS_PARAM_TYPE_UNSIGNED_INT
;

266 
	gouçut
->
	gvÆue
.
	gu_boﬁ
 = 
åue
;

267  
	gUDS_SUCCESS
;

268 } i‡(
°rˇ£cmp
(
öput
->
vÆue
.
u_°rög
, "false") == 0 ||

269 
°rˇ£cmp
(
öput
->
vÆue
.
u_°rög
, "no") == 0) {

270 
ouçut
->
ty≥
 = 
UDS_PARAM_TYPE_UNSIGNED_INT
;

271 
	gouçut
->
	gvÆue
.
	gu_boﬁ
 = 
Ál£
;

272  
	gUDS_SUCCESS
;

275  
	gUDS_BAD_PARAMETER_TYPE
;

277  
	gUDS_PARAMETER_INVALID
;

281 
	$vÆid©eNumîicR™ge
(c⁄° 
UdsP¨amëîVÆue
 *
öput
,

282 c⁄° *
vÆidD©a
,

283 
UdsP¨amëîVÆue
 *
ouçut
)

285 c⁄° 
NumîicVÆid©i⁄D©a
 *
ønge
 = 
vÆidD©a
;

287 i‡(
öput
->
ty≥
 =
UDS_PARAM_TYPE_UNSIGNED_INT
) {

288 i‡(
ønge
->
möVÆue
 <
öput
->
vÆue
.
u_uöt
 &&

289 
öput
->
vÆue
.
u_uöt
 <
ønge
->
maxVÆue
) {

290 *
ouçut
 = *
öput
;

291  
UDS_SUCCESS
;

293 } i‡(
öput
->
ty≥
 =
UDS_PARAM_TYPE_STRING
) {

294 
n
 = 0;

295 
ªsu…
 = 
	`°rögToUnsig√dL⁄g
(
öput
->
vÆue
.
u_°rög
, &
n
);

296 i‡((
ªsu…
 =
UDS_SUCCESS
)

297 && (
ønge
->
möVÆue
 <
n
Ë&& (¿<ønge->
maxVÆue
)) {

298 
ouçut
->
ty≥
 = 
UDS_PARAM_TYPE_UNSIGNED_INT
;

299 
ouçut
->
vÆue
.
u_uöt
 = 
n
;

300  
UDS_SUCCESS
;

303  
UDS_BAD_PARAMETER_TYPE
;

305  
UDS_PARAMETER_INVALID
;

306 
	}
}

312 (*
ã°P¨amDefFunc
)(
P¨amëîDeföôi⁄
 *Ë
NULL
;

315 
	$deföeP¨amëîTe°P¨am
(
P¨amëîDeföôi⁄
 *
pd
)

317 i‡(
ã°P¨amDefFunc
) {

318  
	`ã°P¨amDefFunc
(
pd
);

320  
UDS_UNKNOWN_PARAMETER
;

321 
	}
}

324 
£tTe°P¨amëîDeföôi⁄Func
((*
func
)(
P¨amëîDeföôi⁄
 *))

326 
ã°P¨amDefFunc
 = 
func
;

327  
	`udsRe£tP¨amëî
(
UDS_PARAMETER_TEST_PARAM
);

328 
	}
}

	@uds/parameter.h

22 #i‚de‡
PARAMETER_H


23 
	#PARAMETER_H


	)

25 
	~"ty≥Defs.h
"

26 
	~"uds-∑øm.h
"

59 
∑ømëîDeföôi⁄
 
	tP¨amëîDeföôi⁄
;

61 
	tVÆid©i⁄Func
(c⁄° 
	tUdsP¨amëîVÆue
 *
	töput
,

62 c⁄° *
	tvÆid©i⁄D©a
,

63 
	tUdsP¨amëîVÆue
 *
	touçut
);

65 
	s∑ømëîDeföôi⁄
 {

66 c⁄° *
	m«me
;

67 
UdsP¨amëîVÆue
 
	mcuºítVÆue
;

68 c⁄° *
	mvÆid©i⁄D©a
;

69 
VÆid©i⁄Func
 *
	mvÆid©e
;

70 (*
	mª£t
)(
	mP¨amëîDeföôi⁄
 *);

71 (*
	mupd©e
)(c⁄° 
	mUdsP¨amëîVÆue
 *);

74 c⁄° * c⁄° 
UDS_PARALLEL_FACTOR
;

75 c⁄° * c⁄° 
UDS_TIME_REQUEST_TURNAROUND
;

76 c⁄° * c⁄° 
UDS_VOLUME_READ_THREADS
;

77 c⁄° * c⁄° 
UDS_PARAMETER_TEST_PARAM
;

98 
deföeP¨ÆÀlFa˘‹
(
P¨amëîDeföôi⁄
 *
pd
);

99 
deföeTimeReque°Tu∫¨ound
(
P¨amëîDeföôi⁄
 *
pd
);

100 
deföeVﬁumeRódThªads
(
P¨amëîDeföôi⁄
 *
pd
);

101 
£tTe°P¨amëîDeföôi⁄Func
((*
func
)(
P¨amëîDeföôi⁄
 *))

102 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

113 
	$vÆid©eBoﬁón
(c⁄° 
UdsP¨amëîVÆue
 *
öput
,

114 c⁄° *
vÆidD©a
,

115 
UdsP¨amëîVÆue
 *
ouçut
)

116 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

121 
	snumîicVÆid©i⁄D©a
 {

122 
möVÆue
;

123 
maxVÆue
;

124 } 
	tNumîicVÆid©i⁄D©a
;

136 
	$vÆid©eNumîicR™ge
(c⁄° 
UdsP¨amëîVÆue
 *
öput
,

137 c⁄° *
vÆidD©a
,

138 
UdsP¨amëîVÆue
 *
ouçut
)

139 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

	@uds/permassert.c

22 
	~"≥rmas£π.h
"

23 
	~"≥rmas£πI¡î«ls.h
"

25 
	~"îr‹s.h
"

28 
	$as£πi⁄Faûed
(c⁄° *
ex¥essi⁄Såög
,

29 
code
,

30 c⁄° *
fûeName
,

31 
löeNumbî
,

32 c⁄° *
f‹m©
,

35 
va_li°
 
¨gs
;

36 
	`va_°¨t
(
¨gs
, 
f‹m©
);

37 
	`h™dÀAs£πi⁄Faûuª
(
ex¥essi⁄Såög
, 
fûeName
, 
löeNumbî
, 
f‹m©
, 
¨gs
);

38 
	`va_íd
(
¨gs
);

40  
code
;

41 
	}
}

44 
	$as£πi⁄FaûedLogO∆y
(c⁄° *
ex¥essi⁄Såög
,

45 c⁄° *
fûeName
,

46 
löeNumbî
,

47 c⁄° *
f‹m©
,

50 
va_li°
 
¨gs
;

51 
	`va_°¨t
(
¨gs
, 
f‹m©
);

52 
	`h™dÀAs£πi⁄Faûuª
(
ex¥essi⁄Såög
, 
fûeName
, 
löeNumbî
, 
f‹m©
, 
¨gs
);

53 
	`va_íd
(
¨gs
);

55  
UDS_ASSERTION_FAILED
;

56 
	}
}

	@uds/permassert.h

22 #i‚de‡
PERMASSERT_H


23 
	#PERMASSERT_H


	)

25 
	~"compûî.h
"

26 
	~"îr‹s.h
"

27 
	~"uds-îr‹.h
"

29 
	#STRINGIFY
(
X
Ë#X

	)

30 
	#STRINGIFY_VALUE
(
X
Ë
	`STRINGIFY
(X)

	)

46 
__©åibuã__
((
w¨n_unu£d_ªsu…
))

47 
INLINE
 
	$mu°U£
(
vÆue
)

49  
vÆue
;

50 
	}
}

67 
	#ASSERT_WITH_ERROR_CODE
(
ex¥
, 
code
, ...) \

68 
	`mu°U£
(
	`__buûtö_ex≥˘
(!!(
ex¥
), 1) \

69 ? 
UDS_SUCCESS
 \

70 : 
	`as£πi⁄Faûed
(
	`STRINGIFY
(
ex¥
), 
code
, 
__FILE__
, 
__LINE__
, \

71 
__VA_ARGS__
))

	)

86 
	#ASSERT
(
ex¥
, ...) \

87 
	`ASSERT_WITH_ERROR_CODE
(
ex¥
, 
UDS_ASSERTION_FAILED
, 
__VA_ARGS__
)

	)

99 
	#ASSERT_LOG_ONLY
(
ex¥
, ...) \

100 (
	`__buûtö_ex≥˘
(!!(
ex¥
), 1) \

101 ? 
UDS_SUCCESS
 \

102 : 
	`as£πi⁄FaûedLogO∆y
(
	`STRINGIFY
(
ex¥
), 
__FILE__
, 
__LINE__
, 
__VA_ARGS__
))

	)

107 
	#ASSERT_FALSE
(...) \

108 
	`ASSERT
(
Ál£
, 
__VA_ARGS__
)

	)

110 
	#STATIC_ASSERT
(
ex¥
) \

114 
ex¥
: \

119 } 0)

	)

121 
	#STATIC_ASSERT_SIZEOF
(
ty≥
, 
ex≥˘edSize
) \

122 
	`STATIC_ASSERT
((
ty≥
Ë=(
ex≥˘edSize
))

	)

132 
boﬁ
 
£tExôOnAs£πi⁄Faûuª
(boﬁ 
shouldExô
);

148 
	$as£πi⁄Faûed
(c⁄° *
ex¥essi⁄Såög
,

149 
îr‹Code
,

150 c⁄° *
fûeName
,

151 
löeNumbî
,

152 c⁄° *
f‹m©
,

154 
	`__©åibuã__
((
	`f‹m©
(
¥ötf
, 5, 6), 
w¨n_unu£d_ªsu…
));

171 
	$as£πi⁄FaûedLogO∆y
(c⁄° *
ex¥essi⁄Såög
,

172 c⁄° *
fûeName
,

173 
löeNumbî
,

174 c⁄° *
f‹m©
,

176 
	`__©åibuã__
((
	`f‹m©
(
¥ötf
, 4, 5)));

	@uds/permassertInternals.h

22 #i‚de‡
PERMASSERT_INTERNALS_H


23 
	#PERMASSERT_INTERNALS_H


	)

25 
	~<°d¨g.h
>

27 #ifde‡
__˝lu•lus


31 
h™dÀAs£πi⁄Faûuª
(c⁄° *
ex¥essi⁄Såög
,

32 c⁄° *
fûeName
,

33 
löeNumbî
,

34 c⁄° *
f‹m©
,

35 
va_li°
 
¨gs
)

36 
__©åibuã__
((
f‹m©
(
¥ötf
, 4, 0)));

38 #ifde‡
__˝lu•lus


	@uds/permassertLinuxKernel.c

22 
	~"loggî.h
"

23 
	~"≥rmas£π.h
"

24 
	~"≥rmas£πI¡î«ls.h
"

27 
__©åibuã__
((
	$f‹m©
(
¥ötf
, 4, 0)))

28 
	$h™dÀAs£πi⁄Faûuª
(c⁄° *
ex¥essi⁄Såög
,

29 c⁄° *
fûeName
,

30 
löeNumbî
,

31 c⁄° *
f‹m©
,

32 
va_li°
 
¨gs
)

34 
	`logEmbeddedMesßge
(
LOG_ERR
, "as£πi⁄ \"", 
f‹m©
, 
¨gs
,

36 
ex¥essi⁄Såög
, 
fûeName
, 
löeNumbî
);

37 
	`logBackåa˚
(
LOG_ERR
);

38 
	}
}

	@uds/queue.h

58 #i‚def 
COMMON_QUEUE_H


59 
	#COMMON_QUEUE_H


	)

110 
	#LIST__HEAD
(
«me
, 
ty≥
) \

111 
	s«me
 { \

112 
ty≥
 *
lh_fú°
; \

113 }

	)

115 
	#LIST_HEAD_INITIALIZER
(
hód
) \

116 { 
NULL
 }

	)

118 
	#LIST_ENTRY
(
ty≥
) \

120 
ty≥
 *
À_√xt
; \

121 
ty≥
 **
À_¥ev
; \

122 }

	)

127 
	#LIST_INIT
(
hód
) do { \

128 (
hód
)->
lh_fú°
 = 
NULL
; \

129 }  0)

	)

131 
	#LIST_INSERT_AFTER
(
li°ñm
, 
ñm
, 
fõld
) do { \

132 i‡(((
ñm
)->
fõld
.
À_√xt
 = (
li°ñm
)->fõld.À_√xtË!
NULL
) \

133 (
li°ñm
)->
fõld
.
À_√xt
->fõld.
À_¥ev
 = \

134 &(
ñm
)->
fõld
.
À_√xt
; \

135 (
li°ñm
)->
fõld
.
À_√xt
 = (
ñm
); \

136 (
ñm
)->
fõld
.
À_¥ev
 = &(
li°ñm
)->fõld.
À_√xt
; \

137 }  0)

	)

139 
	#LIST_INSERT_BEFORE
(
li°ñm
, 
ñm
, 
fõld
) do { \

140 (
ñm
)->
fõld
.
À_¥ev
 = (
li°ñm
)->field.le_prev; \

141 (
ñm
)->
fõld
.
À_√xt
 = (
li°ñm
); \

142 *(
li°ñm
)->
fõld
.
À_¥ev
 = (
ñm
); \

143 (
li°ñm
)->
fõld
.
À_¥ev
 = &(
ñm
)->fõld.
À_√xt
; \

144 }  0)

	)

146 
	#LIST_INSERT_HEAD
(
hód
, 
ñm
, 
fõld
) do { \

147 i‡(((
ñm
)->
fõld
.
À_√xt
 = (
hód
)->
lh_fú°
Ë!
NULL
) \

148 (
hód
)->
lh_fú°
->
fõld
.
À_¥ev
 = &(
ñm
)->fõld.
À_√xt
;\

149 (
hód
)->
lh_fú°
 = (
ñm
); \

150 (
ñm
)->
fõld
.
À_¥ev
 = &(
hód
)->
lh_fú°
; \

151 }  0)

	)

153 
	#LIST_REMOVE
(
ñm
, 
fõld
) do { \

154 i‡((
ñm
)->
fõld
.
À_√xt
 !
NULL
) \

155 (
ñm
)->
fõld
.
À_√xt
->fõld.
À_¥ev
 = \

156 (
ñm
)->
fõld
.
À_¥ev
; \

157 *(
ñm
)->
fõld
.
À_¥ev
 = (ñm)->fõld.
À_√xt
; \

158 }  0)

	)

160 
	#LIST_FOREACH
(
v¨
, 
hód
, 
fõld
) \

161 (
v¨
Ë((
hód
)->
lh_fú°
); \

162 (
v¨
); \

163 (
v¨
Ë((v¨)->
fõld
.
À_√xt
))

	)

168 
	#LIST_EMPTY
(
hód
Ë((hód)->
lh_fú°
 =
NULL
)

	)

169 
	#LIST_FIRST
(
hód
Ë((hód)->
lh_fú°
)

	)

170 
	#LIST_NEXT
(
ñm
, 
fõld
Ë(”lm)->fõld.
À_√xt
)

	)

176 
	#SLIST_HEAD
(
«me
, 
ty≥
) \

177 
	s«me
 { \

178 
ty≥
 *
¶h_fú°
; \

179 }

	)

181 
	#SLIST_HEAD_INITIALIZER
(
hód
) \

182 { 
NULL
 }

	)

184 
	#SLIST_ENTRY
(
ty≥
) \

186 
ty≥
 *
¶e_√xt
; \

187 }

	)

192 
	#SLIST_INIT
(
hód
) do { \

193 (
hód
)->
¶h_fú°
 = 
NULL
; \

194 }  0)

	)

196 
	#SLIST_INSERT_AFTER
(
¶i°ñm
, 
ñm
, 
fõld
) do { \

197 (
ñm
)->
fõld
.
¶e_√xt
 = (
¶i°ñm
)->field.sle_next; \

198 (
¶i°ñm
)->
fõld
.
¶e_√xt
 = (
ñm
); \

199 }  0)

	)

201 
	#SLIST_INSERT_HEAD
(
hód
, 
ñm
, 
fõld
) do { \

202 (
ñm
)->
fõld
.
¶e_√xt
 = (
hód
)->
¶h_fú°
; \

203 (
hód
)->
¶h_fú°
 = (
ñm
); \

204 }  0)

	)

206 
	#SLIST_REMOVE_HEAD
(
hód
, 
fõld
) do { \

207 (
hód
)->
¶h_fú°
 = (hód)->¶h_fú°->
fõld
.
¶e_√xt
; \

208 }  0)

	)

210 
	#SLIST_REMOVE
(
hód
, 
ñm
, 
ty≥
, 
fõld
) do { \

211 i‡((
hód
)->
¶h_fú°
 =(
ñm
)) { \

212 
	`SLIST_REMOVE_HEAD
((
hód
), 
fõld
); \

215 
ty≥
 *
cuªlm
 = (
hód
)->
¶h_fú°
; \

216 
cuªlm
->
fõld
.
¶e_√xt
 !(
ñm
)) \

217 
cuªlm
 = cuªlm->
fõld
.
¶e_√xt
; \

218 
cuªlm
->
fõld
.
¶e_√xt
 = \

219 
cuªlm
->
fõld
.
¶e_√xt
->field.sle_next; \

221 }  0)

	)

223 
	#SLIST_FOREACH
(
v¨
, 
hód
, 
fõld
) \

224 (
v¨
Ë(
hód
)->
¶h_fú°
; (v¨); (v¨Ë(v¨)->
fõld
.
¶e_√xt
)

	)

229 
	#SLIST_EMPTY
(
hód
Ë((hód)->
¶h_fú°
 =
NULL
)

	)

230 
	#SLIST_FIRST
(
hód
Ë((hód)->
¶h_fú°
)

	)

231 
	#SLIST_NEXT
(
ñm
, 
fõld
Ë(”lm)->fõld.
¶e_√xt
)

	)

237 
	#STAILQ_HEAD
(
«me
, 
ty≥
) \

238 
	s«me
 { \

239 
ty≥
 *
°qh_fú°
; \

240 
ty≥
 **
°qh_œ°
; \

241 }

	)

243 
	#STAILQ_HEAD_INITIALIZER
(
hód
) \

244 { 
NULL
, &(
hód
).
°qh_fú°
 }

	)

246 
	#STAILQ_ENTRY
(
ty≥
) \

248 
ty≥
 *
°qe_√xt
; \

249 }

	)

254 
	#STAILQ_INIT
(
hód
) do { \

255 (
hód
)->
°qh_fú°
 = 
NULL
; \

256 (
hód
)->
°qh_œ°
 = &(hód)->
°qh_fú°
; \

257 }  0)

	)

259 
	#STAILQ_INSERT_HEAD
(
hód
, 
ñm
, 
fõld
) do { \

260 i‡(((
ñm
)->
fõld
.
°qe_√xt
 = (
hód
)->
°qh_fú°
Ë=
NULL
) \

261 (
hód
)->
°qh_œ°
 = &(
ñm
)->
fõld
.
°qe_√xt
; \

262 (
hód
)->
°qh_fú°
 = (
ñm
); \

263 }  0)

	)

265 
	#STAILQ_INSERT_TAIL
(
hód
, 
ñm
, 
fõld
) do { \

266 (
ñm
)->
fõld
.
°qe_√xt
 = 
NULL
; \

267 *(
hód
)->
°qh_œ°
 = (
ñm
); \

268 (
hód
)->
°qh_œ°
 = &(
ñm
)->
fõld
.
°qe_√xt
; \

269 }  0)

	)

271 
	#STAILQ_INSERT_AFTER
(
hód
, 
li°ñm
, 
ñm
, 
fõld
) do { \

272 i‡(((
ñm
)->
fõld
.
°qe_√xt
 = (
li°ñm
)->fõld.°qe_√xtË=
NULL
)\

273 (
hód
)->
°qh_œ°
 = &(
ñm
)->
fõld
.
°qe_√xt
; \

274 (
li°ñm
)->
fõld
.
°qe_√xt
 = (
ñm
); \

275 }  0)

	)

277 
	#STAILQ_REMOVE_HEAD
(
hód
, 
fõld
) do { \

278 i‡(((
hód
)->
°qh_fú°
 = (hód)->°qh_fú°->
fõld
.
°qe_√xt
Ë=
NULL
) \

279 (
hód
)->
°qh_œ°
 = &(hód)->
°qh_fú°
; \

280 }  0)

	)

282 
	#STAILQ_REMOVE
(
hód
, 
ñm
, 
ty≥
, 
fõld
) do { \

283 i‡((
hód
)->
°qh_fú°
 =(
ñm
)) { \

284 
	`STAILQ_REMOVE_HEAD
((
hód
), 
fõld
); \

286 
ty≥
 *
cuªlm
 = (
hód
)->
°qh_fú°
; \

287 
cuªlm
->
fõld
.
°qe_√xt
 !(
ñm
)) \

288 
cuªlm
 = cuªlm->
fõld
.
°qe_√xt
; \

289 i‡((
cuªlm
->
fõld
.
°qe_√xt
 = \

290 
cuªlm
->
fõld
.
°qe_√xt
->fõld.°qe_√xtË=
NULL
) \

291 (
hód
)->
°qh_œ°
 = &(
cuªlm
)->
fõld
.
°qe_√xt
; \

293 }  0)

	)

295 
	#STAILQ_FOREACH
(
v¨
, 
hód
, 
fõld
) \

296 (
v¨
Ë((
hód
)->
°qh_fú°
); \

297 (
v¨
); \

298 (
v¨
Ë((v¨)->
fõld
.
°qe_√xt
))

	)

300 
	#STAILQ_CONCAT
(
hód1
, 
hód2
) do { \

301 i‡(!
	`STAILQ_EMPTY
((
hód2
))) { \

302 *(
hód1
)->
°qh_œ°
 = (
hód2
)->
°qh_fú°
; \

303 (
hód1
)->
°qh_œ°
 = (
hód2
)->stqh_last; \

304 
	`STAILQ_INIT
((
hód2
)); \

306 }  0)

	)

311 
	#STAILQ_EMPTY
(
hód
Ë((hód)->
°qh_fú°
 =
NULL
)

	)

312 
	#STAILQ_FIRST
(
hód
Ë((hód)->
°qh_fú°
)

	)

313 
	#STAILQ_NEXT
(
ñm
, 
fõld
Ë(”lm)->fõld.
°qe_√xt
)

	)

319 
	#SIMPLEQ_HEAD
(
«me
, 
ty≥
) \

320 
	s«me
 { \

321 
ty≥
 *
sqh_fú°
; \

322 
ty≥
 **
sqh_œ°
; \

323 }

	)

325 
	#SIMPLEQ_HEAD_INITIALIZER
(
hód
) \

326 { 
NULL
, &(
hód
).
sqh_fú°
 }

	)

328 
	#SIMPLEQ_ENTRY
(
ty≥
) \

330 
ty≥
 *
sqe_√xt
; \

331 }

	)

336 
	#SIMPLEQ_INIT
(
hód
) do { \

337 (
hód
)->
sqh_fú°
 = 
NULL
; \

338 (
hód
)->
sqh_œ°
 = &(hód)->
sqh_fú°
; \

339 }  0)

	)

341 
	#SIMPLEQ_INSERT_HEAD
(
hód
, 
ñm
, 
fõld
) do { \

342 i‡(((
ñm
)->
fõld
.
sqe_√xt
 = (
hód
)->
sqh_fú°
Ë=
NULL
) \

343 (
hód
)->
sqh_œ°
 = &(
ñm
)->
fõld
.
sqe_√xt
; \

344 (
hód
)->
sqh_fú°
 = (
ñm
); \

345 }  0)

	)

347 
	#SIMPLEQ_INSERT_TAIL
(
hód
, 
ñm
, 
fõld
) do { \

348 (
ñm
)->
fõld
.
sqe_√xt
 = 
NULL
; \

349 *(
hód
)->
sqh_œ°
 = (
ñm
); \

350 (
hód
)->
sqh_œ°
 = &(
ñm
)->
fõld
.
sqe_√xt
; \

351 }  0)

	)

353 
	#SIMPLEQ_INSERT_AFTER
(
hód
, 
li°ñm
, 
ñm
, 
fõld
) do { \

354 i‡(((
ñm
)->
fõld
.
sqe_√xt
 = (
li°ñm
)->fõld.sqe_√xtË=
NULL
)\

355 (
hód
)->
sqh_œ°
 = &(
ñm
)->
fõld
.
sqe_√xt
; \

356 (
li°ñm
)->
fõld
.
sqe_√xt
 = (
ñm
); \

357 }  0)

	)

359 
	#SIMPLEQ_REMOVE_HEAD
(
hód
, 
fõld
) do { \

360 i‡(((
hód
)->
sqh_fú°
 = (hód)->sqh_fú°->
fõld
.
sqe_√xt
Ë=
NULL
) \

361 (
hód
)->
sqh_œ°
 = &(hód)->
sqh_fú°
; \

362 }  0)

	)

364 
	#SIMPLEQ_REMOVE
(
hód
, 
ñm
, 
ty≥
, 
fõld
) do { \

365 i‡((
hód
)->
sqh_fú°
 =(
ñm
)) { \

366 
	`SIMPLEQ_REMOVE_HEAD
((
hód
), 
fõld
); \

368 
ty≥
 *
cuªlm
 = (
hód
)->
sqh_fú°
; \

369 
cuªlm
->
fõld
.
sqe_√xt
 !(
ñm
)) \

370 
cuªlm
 = cuªlm->
fõld
.
sqe_√xt
; \

371 i‡((
cuªlm
->
fõld
.
sqe_√xt
 = \

372 
cuªlm
->
fõld
.
sqe_√xt
->fõld.sqe_√xtË=
NULL
) \

373 (
hód
)->
sqh_œ°
 = &(
cuªlm
)->
fõld
.
sqe_√xt
; \

375 }  0)

	)

377 
	#SIMPLEQ_FOREACH
(
v¨
, 
hód
, 
fõld
) \

378 (
v¨
Ë((
hód
)->
sqh_fú°
); \

379 (
v¨
); \

380 (
v¨
Ë((v¨)->
fõld
.
sqe_√xt
))

	)

385 
	#SIMPLEQ_EMPTY
(
hód
Ë((hód)->
sqh_fú°
 =
NULL
)

	)

386 
	#SIMPLEQ_FIRST
(
hód
Ë((hód)->
sqh_fú°
)

	)

387 
	#SIMPLEQ_NEXT
(
ñm
, 
fõld
Ë(”lm)->fõld.
sqe_√xt
)

	)

393 
	#_TAILQ_HEAD
(
«me
, 
ty≥
, 
quÆ
) \

394 
	s«me
 { \

395 
quÆ
 
ty≥
 *
tqh_fú°
; \

396 
quÆ
 
ty≥
 *quÆ *
tqh_œ°
; \

397 }

	)

398 
	#TAILQ_HEAD
(
«me
, 
ty≥
Ë
	`_TAILQ_HEAD
“ame, ty≥,)

	)

400 
	#TAILQ_HEAD_INITIALIZER
(
hód
) \

401 { 
NULL
, &(
hód
).
tqh_fú°
 }

	)

403 
	#_TAILQ_ENTRY
(
ty≥
, 
quÆ
) \

405 
quÆ
 
ty≥
 *
tqe_√xt
; \

406 
quÆ
 
ty≥
 *quÆ *
tqe_¥ev
; \

407 }

	)

408 
	#TAILQ_ENTRY
(
ty≥
Ë
	`_TAILQ_ENTRY
(ty≥,)

	)

413 
	#TAILQ_INIT
(
hód
) do { \

414 (
hód
)->
tqh_fú°
 = 
NULL
; \

415 (
hód
)->
tqh_œ°
 = &(hód)->
tqh_fú°
; \

416 }  0)

	)

418 
	#TAILQ_INSERT_HEAD
(
hód
, 
ñm
, 
fõld
) do { \

419 i‡(((
ñm
)->
fõld
.
tqe_√xt
 = (
hód
)->
tqh_fú°
Ë!
NULL
) \

420 (
hód
)->
tqh_fú°
->
fõld
.
tqe_¥ev
 = \

421 &(
ñm
)->
fõld
.
tqe_√xt
; \

423 (
hód
)->
tqh_œ°
 = &(
ñm
)->
fõld
.
tqe_√xt
; \

424 (
hód
)->
tqh_fú°
 = (
ñm
); \

425 (
ñm
)->
fõld
.
tqe_¥ev
 = &(
hód
)->
tqh_fú°
; \

426 }  0)

	)

428 
	#TAILQ_INSERT_TAIL
(
hód
, 
ñm
, 
fõld
) do { \

429 (
ñm
)->
fõld
.
tqe_√xt
 = 
NULL
; \

430 (
ñm
)->
fõld
.
tqe_¥ev
 = (
hód
)->
tqh_œ°
; \

431 *(
hód
)->
tqh_œ°
 = (
ñm
); \

432 (
hód
)->
tqh_œ°
 = &(
ñm
)->
fõld
.
tqe_√xt
; \

433 }  0)

	)

435 
	#TAILQ_INSERT_AFTER
(
hód
, 
li°ñm
, 
ñm
, 
fõld
) do { \

436 i‡(((
ñm
)->
fõld
.
tqe_√xt
 = (
li°ñm
)->fõld.tqe_√xtË!
NULL
)\

437 (
ñm
)->
fõld
.
tqe_√xt
->fõld.
tqe_¥ev
 = \

438 &(
ñm
)->
fõld
.
tqe_√xt
; \

440 (
hód
)->
tqh_œ°
 = &(
ñm
)->
fõld
.
tqe_√xt
; \

441 (
li°ñm
)->
fõld
.
tqe_√xt
 = (
ñm
); \

442 (
ñm
)->
fõld
.
tqe_¥ev
 = &(
li°ñm
)->fõld.
tqe_√xt
; \

443 }  0)

	)

445 
	#TAILQ_INSERT_BEFORE
(
li°ñm
, 
ñm
, 
fõld
) do { \

446 (
ñm
)->
fõld
.
tqe_¥ev
 = (
li°ñm
)->field.tqe_prev; \

447 (
ñm
)->
fõld
.
tqe_√xt
 = (
li°ñm
); \

448 *(
li°ñm
)->
fõld
.
tqe_¥ev
 = (
ñm
); \

449 (
li°ñm
)->
fõld
.
tqe_¥ev
 = &(
ñm
)->fõld.
tqe_√xt
; \

450 }  0)

	)

452 
	#TAILQ_REMOVE
(
hód
, 
ñm
, 
fõld
) do { \

453 i‡(((
ñm
)->
fõld
.
tqe_√xt
Ë!
NULL
) \

454 (
ñm
)->
fõld
.
tqe_√xt
->fõld.
tqe_¥ev
 = \

455 (
ñm
)->
fõld
.
tqe_¥ev
; \

457 (
hód
)->
tqh_œ°
 = (
ñm
)->
fõld
.
tqe_¥ev
; \

458 *(
ñm
)->
fõld
.
tqe_¥ev
 = (ñm)->fõld.
tqe_√xt
; \

459 }  0)

	)

461 
	#TAILQ_FOREACH
(
v¨
, 
hód
, 
fõld
) \

462 (
v¨
Ë((
hód
)->
tqh_fú°
); \

463 (
v¨
); \

464 (
v¨
Ë((v¨)->
fõld
.
tqe_√xt
))

	)

466 
	#TAILQ_FOREACH_REVERSE
(
v¨
, 
hód
, 
hód«me
, 
fõld
) \

467 (
v¨
Ë(*(((
hód«me
 *)((
hód
)->
tqh_œ°
))->tqh_last)); \

468 (
v¨
); \

469 (
v¨
Ë(*(((
hód«me
 *)((v¨)->
fõld
.
tqe_¥ev
))->
tqh_œ°
)))

	)

471 
	#TAILQ_CONCAT
(
hód1
, 
hód2
, 
fõld
) do { \

472 i‡(!
	`TAILQ_EMPTY
(
hód2
)) { \

473 *(
hód1
)->
tqh_œ°
 = (
hód2
)->
tqh_fú°
; \

474 (
hód2
)->
tqh_fú°
->
fõld
.
tqe_¥ev
 = (
hód1
)->
tqh_œ°
; \

475 (
hód1
)->
tqh_œ°
 = (
hód2
)->tqh_last; \

476 
	`TAILQ_INIT
((
hód2
)); \

478 }  0)

	)

483 
	#TAILQ_EMPTY
(
hód
Ë((hód)->
tqh_fú°
 =
NULL
)

	)

484 
	#TAILQ_FIRST
(
hód
Ë((hód)->
tqh_fú°
)

	)

485 
	#TAILQ_NEXT
(
ñm
, 
fõld
Ë(”lm)->fõld.
tqe_√xt
)

	)

487 
	#TAILQ_LAST
(
hód
, 
hód«me
) \

488 (*(((
hód«me
 *)((
hód
)->
tqh_œ°
))->tqh_œ°))

	)

489 
	#TAILQ_PREV
(
ñm
, 
hód«me
, 
fõld
) \

490 (*(((
hód«me
 *)((
ñm
)->
fõld
.
tqe_¥ev
))->
tqh_œ°
))

	)

496 
	#CIRCLEQ_HEAD
(
«me
, 
ty≥
) \

497 
	s«me
 { \

498 
ty≥
 *
cqh_fú°
; \

499 
ty≥
 *
cqh_œ°
; \

500 }

	)

502 
	#CIRCLEQ_HEAD_INITIALIZER
(
hód
) \

503 { (*)&
hód
, (*)&hód }

	)

505 
	#CIRCLEQ_ENTRY
(
ty≥
) \

507 
ty≥
 *
cqe_√xt
; \

508 
ty≥
 *
cqe_¥ev
; \

509 }

	)

514 
	#CIRCLEQ_INIT
(
hód
) do { \

515 (
hód
)->
cqh_fú°
 = (*)(head); \

516 (
hód
)->
cqh_œ°
 = (*)(head); \

517 }  0)

	)

519 
	#CIRCLEQ_INSERT_AFTER
(
hód
, 
li°ñm
, 
ñm
, 
fõld
) do { \

520 (
ñm
)->
fõld
.
cqe_√xt
 = (
li°ñm
)->field.cqe_next; \

521 (
ñm
)->
fõld
.
cqe_¥ev
 = (
li°ñm
); \

522 i‡((
li°ñm
)->
fõld
.
cqe_√xt
 =(*)(
hód
)) \

523 (
hód
)->
cqh_œ°
 = (
ñm
); \

525 (
li°ñm
)->
fõld
.
cqe_√xt
->fõld.
cqe_¥ev
 = (
ñm
); \

526 (
li°ñm
)->
fõld
.
cqe_√xt
 = (
ñm
); \

527 }  0)

	)

529 
	#CIRCLEQ_INSERT_BEFORE
(
hód
, 
li°ñm
, 
ñm
, 
fõld
) do { \

530 (
ñm
)->
fõld
.
cqe_√xt
 = (
li°ñm
); \

531 (
ñm
)->
fõld
.
cqe_¥ev
 = (
li°ñm
)->field.cqe_prev; \

532 i‡((
li°ñm
)->
fõld
.
cqe_¥ev
 =(*)(
hód
)) \

533 (
hód
)->
cqh_fú°
 = (
ñm
); \

535 (
li°ñm
)->
fõld
.
cqe_¥ev
->fõld.
cqe_√xt
 = (
ñm
); \

536 (
li°ñm
)->
fõld
.
cqe_¥ev
 = (
ñm
); \

537 }  0)

	)

539 
	#CIRCLEQ_INSERT_HEAD
(
hód
, 
ñm
, 
fõld
) do { \

540 (
ñm
)->
fõld
.
cqe_√xt
 = (
hód
)->
cqh_fú°
; \

541 (
ñm
)->
fõld
.
cqe_¥ev
 = (*)(
hód
); \

542 i‡((
hód
)->
cqh_œ°
 == (*)(head)) \

543 (
hód
)->
cqh_œ°
 = (
ñm
); \

545 (
hód
)->
cqh_fú°
->
fõld
.
cqe_¥ev
 = (
ñm
); \

546 (
hód
)->
cqh_fú°
 = (
ñm
); \

547 }  0)

	)

549 
	#CIRCLEQ_INSERT_TAIL
(
hód
, 
ñm
, 
fõld
) do { \

550 (
ñm
)->
fõld
.
cqe_√xt
 = (*)(
hód
); \

551 (
ñm
)->
fõld
.
cqe_¥ev
 = (
hód
)->
cqh_œ°
; \

552 i‡((
hód
)->
cqh_fú°
 == (*)(head)) \

553 (
hód
)->
cqh_fú°
 = (
ñm
); \

555 (
hód
)->
cqh_œ°
->
fõld
.
cqe_√xt
 = (
ñm
); \

556 (
hód
)->
cqh_œ°
 = (
ñm
); \

557 }  0)

	)

559 
	#CIRCLEQ_REMOVE
(
hód
, 
ñm
, 
fõld
) do { \

560 i‡((
ñm
)->
fõld
.
cqe_√xt
 =(*)(
hód
)) \

561 (
hód
)->
cqh_œ°
 = (
ñm
)->
fõld
.
cqe_¥ev
; \

563 (
ñm
)->
fõld
.
cqe_√xt
->fõld.
cqe_¥ev
 = \

564 (
ñm
)->
fõld
.
cqe_¥ev
; \

565 i‡((
ñm
)->
fõld
.
cqe_¥ev
 =(*)(
hód
)) \

566 (
hód
)->
cqh_fú°
 = (
ñm
)->
fõld
.
cqe_√xt
; \

568 (
ñm
)->
fõld
.
cqe_¥ev
->fõld.
cqe_√xt
 = \

569 (
ñm
)->
fõld
.
cqe_√xt
; \

570 }  0)

	)

572 
	#CIRCLEQ_FOREACH
(
v¨
, 
hód
, 
fõld
) \

573 (
v¨
Ë((
hód
)->
cqh_fú°
); \

574 (
v¨
Ë!(c⁄° *)(
hód
); \

575 (
v¨
Ë((v¨)->
fõld
.
cqe_√xt
))

	)

577 
	#CIRCLEQ_FOREACH_REVERSE
(
v¨
, 
hód
, 
fõld
) \

578 (
v¨
Ë((
hód
)->
cqh_œ°
); \

579 (
v¨
Ë!(c⁄° *)(
hód
); \

580 (
v¨
Ë((v¨)->
fõld
.
cqe_¥ev
))

	)

585 
	#CIRCLEQ_EMPTY
(
hód
Ë((hód)->
cqh_fú°
 =(*)(hód))

	)

586 
	#CIRCLEQ_FIRST
(
hód
Ë((hód)->
cqh_fú°
)

	)

587 
	#CIRCLEQ_LAST
(
hód
Ë((hód)->
cqh_œ°
)

	)

588 
	#CIRCLEQ_NEXT
(
ñm
, 
fõld
Ë(”lm)->fõld.
cqe_√xt
)

	)

589 
	#CIRCLEQ_PREV
(
ñm
, 
fõld
Ë(”lm)->fõld.
cqe_¥ev
)

	)

591 
	#CIRCLEQ_LOOP_NEXT
(
hód
, 
ñm
, 
fõld
) \

592 (((
ñm
)->
fõld
.
cqe_√xt
 =(*)(
hód
)) \

593 ? ((
hód
)->
cqh_fú°
) \

594 : (
ñm
->
fõld
.
cqe_√xt
))

	)

595 
	#CIRCLEQ_LOOP_PREV
(
hód
, 
ñm
, 
fõld
) \

596 (((
ñm
)->
fõld
.
cqe_¥ev
 =(*)(
hód
)) \

597 ? ((
hód
)->
cqh_œ°
) \

598 : (
ñm
->
fõld
.
cqe_¥ev
))

	)

	@uds/random.c

22 
	~"øndom.h
"

24 
	~"≥rmas£π.h
"

27 
	$øndomInR™ge
(
lo
, 
hi
)

29  
lo
 + 
	`øndom
(Ë% (
hi
 -Üo + 1);

30 
	}
}

33 
	$øndomCompûeTimeAs£πi⁄s
()

35 
	`STATIC_ASSERT
((((
uöt64_t
Ë
RAND_MAX
 + 1) & RAND_MAX) == 0);

36 
	}
}

	@uds/random.h

22 #i‚de‡
RANDOM_H


23 
	#RANDOM_H


	)

25 
	~"comm⁄.h
"

26 
	~"compûî.h
"

27 
	~"øndomDefs.h
"

28 
	~"ty≥Defs.h
"

36 
INLINE
 
	$¸óãR™domBlockName
(
UdsChunkName
 *
«me
)

38 
	`fûlR™domly
(
«me
->«me, 
UDS_CHUNK_NAME_SIZE
);

39 
	}
}

46 
INLINE
 
	$¸óãR™domMëad©a
(
UdsChunkD©a
 *
d©a
)

48 
	`fûlR™domly
(
d©a
->d©a, 
UDS_MAX_BLOCK_DATA_SIZE
);

49 
	}
}

59 
øndomInR™ge
(
lo
, 
hi
);

65 
øndomCompûeTimeAs£πi⁄s
();

	@uds/randomDefs.h

22 #i‚de‡
LINUX_KERNEL_RANDOM_DEFS_H


23 
	#LINUX_KERNEL_RANDOM_DEFS_H
 1

	)

25 
	#RAND_MAX
 2147483647

	)

33 
fûlR™domly
(*
±r
, 
size_t
 
Àn
);

40 
INLINE
 
	$øndom
()

42 
vÆue
;

43 
	`fûlR™domly
(&
vÆue
, (value));

44  
vÆue
 & 
RAND_MAX
;

45 
	}
}

	@uds/randomLinuxKernel.c

22 
	~<löux/øndom.h
>

24 
	~"hashUtûs.h
"

25 
	~"øndom.h
"

28 
	$fûlR™domly
(*
±r
, 
size_t
 
Àn
)

36 i‡(
Àn
 > (
UdsChunkName
)) {

37 
UdsChunkName
 *
«mePå
 = 
±r
;

38 
cou¡î
;

39 
ö¸emít
 = 1;

40 
	`gë_øndom_byãs
(&
cou¡î
, (counter));

42 *
«mePå
 = 
	`murmurHashChunkName
(&
cou¡î
, (counter), 0);

43 
cou¡î
 +
ö¸emít
;

44 
ö¸emít
++;

45 
«mePå
++;

46 
Àn
 -(
UdsChunkName
);

47 } 
Àn
 >(
UdsChunkName
));

48 
±r
 = 
«mePå
;

50 i‡(
Àn
 > 0) {

51 
	`gë_øndom_byãs
(
±r
, 
Àn
);

53 
	}
}

	@uds/readOnlyVolume.c

22 
	~"ªadO∆yVﬁume.h
"

24 
	~"vﬁumeI¡î«ls.h
"

25 
	~"z⁄e.h
"

28 
	$makeRódO∆yVﬁume
(c⁄° 
C⁄figuøti⁄
 *
c⁄fig
,

29 
IndexLayout
 *
œyout
,

30 
ödexId
,

31 
Vﬁume
 **
√wVﬁume
)

33  
	`ÆloˇãVﬁume
(
c⁄fig
, 
œyout
, 
ödexId
,

34 
VOLUME_CACHE_DEFAULT_MAX_QUEUED_READS
,

35 1, 
READ_ONLY_VOLUME
, 
√wVﬁume
);

36 
	}
}

39 
	$‰ìRódO∆yVﬁume
(
Vﬁume
 *
vﬁume
)

41 
	`ªÀa£Vﬁume
(
vﬁume
);

42 
	}
}

45 
	$gëRódO∆yPage
(
Vﬁume
 *
vﬁume
,

46 
ch≠ãr
,

47 
∑geNumbî
)

49 
physiˇlPage
 = 
	`m≠ToPhysiˇlPage
(
vﬁume
->
geomëry
, 
ch≠ãr
, 
∑geNumbî
);

50 
ªsu…
 = 
	`ªadPageToBuf„r
(
vﬁume
, 
physiˇlPage
, vﬁume->
s¸©chPage
);

51 i‡(
ªsu…
 !
UDS_SUCCESS
) {

52  
ªsu…
;

54  
UDS_SUCCESS
;

55 
	}
}

	@uds/readOnlyVolume.h

22 #i‚de‡
READ_ONLY_VOLUME_H


23 
	#READ_ONLY_VOLUME_H


	)

25 
	~"vﬁume.h
"

36 
	$makeRódO∆yVﬁume
(c⁄° 
C⁄figuøti⁄
 *
c⁄fig
,

37 
IndexLayout
 *
œyout
,

38 
ödexId
,

39 
Vﬁume
 **
√wVﬁume
)

40 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

47 
	`‰ìRódO∆yVﬁume
(
Vﬁume
 *
vﬁume
);

58 
	$gëRódO∆yPage
(
Vﬁume
 *
vﬁume
,

59 
ch≠ãr
,

60 
∑geNumbî
)

61 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

	@uds/recordPage.c

22 
	~"ªc‹dPage.h
"

24 
	~"≥rmas£π.h
"

27 
	$ícodeTªe
(
byã
 
ªc‹dPage
[],

28 c⁄° 
UdsChunkRec‹d
 *
s‹ãdPoöãrs
[],

29 
√xtRec‹d
,

30 
node
,

31 
nodeCou¡
)

33 i‡(
node
 < 
nodeCou¡
) {

34 
chûd
 = (2 * 
node
) + 1;

35 
√xtRec‹d
 = 
	`ícodeTªe
(
ªc‹dPage
, 
s‹ãdPoöãrs
,ÇextRecord,

36 
chûd
, 
nodeCou¡
);

40 
	`mem˝y
(&
ªc‹dPage
[
node
 * 
BYTES_PER_RECORD
],

41 
s‹ãdPoöãrs
[
√xtRec‹d
],

42 
BYTES_PER_RECORD
);

43 ++
√xtRec‹d
;

45 
√xtRec‹d
 = 
	`ícodeTªe
(
ªc‹dPage
, 
s‹ãdPoöãrs
,ÇextRecord,

46 
chûd
 + 1, 
nodeCou¡
);

48  
√xtRec‹d
;

49 
	}
}

52 
	$ícodeRec‹dPage
(c⁄° 
Vﬁume
 *
vﬁume
, c⁄° 
UdsChunkRec‹d
 
ªc‹ds
[])

54 
ªc‹dsPîPage
 = 
vﬁume
->
geomëry
->recordsPerPage;

55 c⁄° 
UdsChunkRec‹d
 **
ªc‹dPoöãrs
 = 
vﬁume
->recordPointers;

59 
i
 = 0; i < 
ªc‹dsPîPage
; i++) {

60 
ªc‹dPoöãrs
[
i
] = &
ªc‹ds
[i];

63 
	`STATIC_ASSERT
(
	`off£tof
(
UdsChunkRec‹d
, 
«me
) == 0);

64 
ªsu…
 = 
	`ødixS‹t
(
vﬁume
->
ødixS‹ãr
, (c⁄° 
byã
 **Ë
ªc‹dPoöãrs
,

65 
ªc‹dsPîPage
, 
UDS_CHUNK_NAME_SIZE
);

66 i‡(
ªsu…
 !
UDS_SUCCESS
) {

67  
ªsu…
;

72 
	`ícodeTªe
(
vﬁume
->
s¸©chPage
, 
ªc‹dPoöãrs
, 0, 0, 
ªc‹dsPîPage
);

73  
UDS_SUCCESS
;

74 
	}
}

77 
boﬁ
 
	$£¨chRec‹dPage
(c⁄° 
byã
 
ªc‹dPage
[],

78 c⁄° 
UdsChunkName
 *
«me
,

79 c⁄° 
Geomëry
 *
geomëry
,

80 
UdsChunkD©a
 *
mëad©a
)

83 c⁄° 
UdsChunkRec‹d
 *
ªc‹ds
 = (c⁄° UdsChunkRec‹d *Ë
ªc‹dPage
;

87 
node
 = 0;

88 
node
 < 
geomëry
->
ªc‹dsPîPage
) {

89 c⁄° 
UdsChunkRec‹d
 *
ªc‹d
 = &
ªc‹ds
[
node
];

90 
ªsu…
 = 
	`memcmp
(
«me
, &
ªc‹d
->«me, 
UDS_CHUNK_NAME_SIZE
);

91 i‡(
ªsu…
 == 0) {

92 i‡(
mëad©a
 !
NULL
) {

93 *
mëad©a
 = 
ªc‹d
->
d©a
;

95  
åue
;

98 
node
 = ((2 *ÇodeË+ ((
ªsu…
 < 0) ? 1 : 2));

100  
Ál£
;

101 
	}
}

	@uds/recordPage.h

22 #i‚de‡
RECORDPAGE_H


23 
	#RECORDPAGE_H
 1

	)

25 
	~"comm⁄.h
"

26 
	~"vﬁume.h
"

37 
ícodeRec‹dPage
(c⁄° 
Vﬁume
 *
vﬁume
, c⁄° 
UdsChunkRec‹d
 
ªc‹ds
[]);

50 
boﬁ
 
£¨chRec‹dPage
(c⁄° 
byã
 
ªc‹dPage
[],

51 c⁄° 
UdsChunkName
 *
«me
,

52 c⁄° 
Geomëry
 *
geomëry
,

53 
UdsChunkD©a
 *
mëad©a
);

	@uds/regionIdentifiers.h

22 #i‚de‡
REGION_IDENTIFIERS_H


23 
	#REGION_IDENTIFIERS_H


	)

26 
	mRH_TYPE_FREE
 = 0,

27 
	mRH_TYPE_SUPER
 = 1,

28 
	mRH_TYPE_SAVE
 = 2,

29 
	mRH_TYPE_CHECKPOINT
 = 3,

30 
	mRH_TYPE_UNSAVED
 = 4,

32 
	mRL_KIND_SCRATCH
 = 0,

33 
	mRL_KIND_HEADER
 = 1,

34 
	mRL_KIND_CONFIG
 = 100,

35 
	mRL_KIND_INDEX
 = 101,

36 
	mRL_KIND_SEAL
 = 102,

37 
	mRL_KIND_VOLUME
 = 201,

38 
	mRL_KIND_SAVE
 = 202,

39 
	mRL_KIND_INDEX_PAGE_MAP
 = 301,

40 
	mRL_KIND_MASTER_INDEX
 = 302,

41 
	mRL_KIND_OPEN_CHAPTER
 = 303,

42 
	mRL_KIND_INDEX_STATE
 = 401,

44 
	mRL_SOLE_INSTANCE
 = 65535,

47 
	tRegi⁄Ty≥
;

48 
	tRegi⁄Köd
;

	@uds/regionIndexComponent.c

22 
	~"ªgi⁄IndexComp⁄ítI¡î«l.h
"

24 
	~"loggî.h
"

25 
	~"mem‹yAŒoc.h
"

26 
	~"ªgi⁄IndexSèãI¡î«l.h
"

27 
	~"sögÀFûeLayoutI¡î«ls.h
"

29 c⁄° 
IndexComp⁄ítOps
 *
gëRegi⁄IndexComp⁄ítOps
();

32 
	$makeRegi⁄IndexComp⁄ít
(
Regi⁄IndexSèã
 *
ris
,

33 c⁄° 
IndexComp⁄ítInfo
 *
öfo
,

34 
z⁄eCou¡
,

35 *
d©a
,

36 *
c⁄ãxt
,

37 
IndexComp⁄ít
 **
comp⁄ítPå
)

39 
Regi⁄IndexComp⁄ít
 *
ric
 = 
NULL
;

40 
ªsu…
 = 
	`ALLOCATE
(1, 
Regi⁄IndexComp⁄ít
, "region index component",

41 &
ric
);

42 i‡(
ªsu…
 !
UDS_SUCCESS
) {

43  
ªsu…
;

46 
ªsu…
 = 
	`öôIndexComp⁄ít
(&
ric
->
comm⁄
, 
öfo
, 
z⁄eCou¡
, 
d©a
, 
c⁄ãxt
,

47 
	`gëRegi⁄IndexComp⁄ítOps
());

48 i‡(
ªsu…
 !
UDS_SUCCESS
) {

49 
	`FREE
(
ric
);

50  
ªsu…
;

53 
ric
->
ris
 =Ñis;

55 *
comp⁄ítPå
 = &
ric
->
comm⁄
;

56  
UDS_SUCCESS
;

57 
	}
}

60 
	$ric_‰ìIndexComp⁄ít
(
IndexComp⁄ít
 *
comp⁄ít
)

62 i‡(
comp⁄ít
 =
NULL
) {

66 
Regi⁄IndexComp⁄ít
 *
ric
 = 
	`asRegi⁄IndexComp⁄ít
(
comp⁄ít
);

67 
	`de°royIndexComp⁄ít
(
comp⁄ít
);

68 
	`FREE
(
ric
);

69 
	}
}

72 
	$ric_›íWrôeRegi⁄
(
WrôeZ⁄e
 *
wrôeZ⁄e
)

74 
Regi⁄IndexComp⁄ít
 *
ric
 = 
	`asRegi⁄IndexComp⁄ít
(
wrôeZ⁄e
->
comp⁄ít
);

76  
	`›íRegi⁄SèãRegi⁄
(
ric
->
ris
,

77 
IO_WRITE
,

78 
ric
->
comm⁄
.
öfo
->
köd
,

79 
wrôeZ⁄e
->
z⁄e
,

80 &
wrôeZ⁄e
->
ªgi⁄
);

81 
	}
}

84 
ric_˛ónupWrôeFaûuª
(
IndexComp⁄ít
 *
comp⁄ít


85 
__©åibuã__
((
unu£d
)))

88  
	gUDS_SUCCESS
;

92 
	$ric_‰ìWrôeZ⁄es
(
IndexComp⁄ít
 *
comp⁄ít
)

94 
	`‰ìWrôeZ⁄esHñ≥r
(
comp⁄ít
, 
NULL
);

95 
	}
}

98 
	$makeRegi⁄WrôeZ⁄e
(
Regi⁄IndexComp⁄ít
 *
ric
,

99 
z⁄e
,

100 
WrôeZ⁄e
 **
z⁄ePå
)

102 
WrôeZ⁄e
 *
wz
 = 
NULL
;

103 
ªsu…
 = 
	`ALLOCATE
(1, 
WrôeZ⁄e
, "∂aö wrôêz⁄e", &
wz
);

104 i‡(
ªsu…
 !
UDS_SUCCESS
) {

105  
ªsu…
;

108 *
wz
 = (
WrôeZ⁄e
) {

109 .
comp⁄ít
 = &
ric
->
comm⁄
,

110 .
pha£
 = 
IWC_IDLE
,

111 .
ªgi⁄
 = 
NULL
,

112 .
z⁄e
 = zone,

115 *
z⁄ePå
 = 
wz
;

116  
UDS_SUCCESS
;

117 
	}
}

120 
	$ric_p›uœãWrôeZ⁄es
(
IndexComp⁄ít
 *
comp⁄ít
)

122 
Regi⁄IndexComp⁄ít
 *
ric
 = 
	`asRegi⁄IndexComp⁄ít
(
comp⁄ít
);

124 
z
 = 0; z < 
comp⁄ít
->
numZ⁄es
; ++z) {

125 
ªsu…
 = 
	`makeRegi⁄WrôeZ⁄e
(
ric
, 
z
, &
comp⁄ít
->
wrôeZ⁄es
[z]);

126 i‡(
ªsu…
 !
UDS_SUCCESS
) {

127  
ªsu…
;

130  
UDS_SUCCESS
;

131 
	}
}

134 
ric_¥ï¨eZ⁄es
(
IndexComp⁄ít
 *
comp⁄ít
 
__©åibuã__
((
unu£d
)),

135 
numZ⁄es
 
__©åibuã__
((
unu£d
)))

138  
	gUDS_SUCCESS
;

142 
	$ric_‰ìRódP‹èl
(
RódP‹èl
 *
p‹èl
)

144 
	`de°royRódP‹èl
(
p‹èl
);

145 
	`FREE
(
p‹èl
);

146 
	}
}

149 
	$ric_¸óãRódP‹èl
(
IndexComp⁄ít
 *
comp⁄ít
,

150 
RódP‹èl
 **
p‹èlPå
)

152 
Regi⁄IndexComp⁄ít
 *
ric
 = 
	`asRegi⁄IndexComp⁄ít
(
comp⁄ít
);

154 
RódP‹èl
 *
p‹èl
;

155 
ªsu…
 = 
	`ALLOCATE
(1, 
RódP‹èl
, "region index componentÑeadÖortal",

156 &
p‹èl
);

157 i‡(
ªsu…
 !
UDS_SUCCESS
) {

158  
ªsu…
;

161 
ªsu…
 = 
	`öôRódP‹èl
(
p‹èl
, 
comp⁄ít
, 
ric
->
ris
->
lﬂdZ⁄es
);

162 i‡(
ªsu…
 !
UDS_SUCCESS
) {

163 
	`FREE
(
p‹èl
);

166 
z
 = 0; z < 
p‹èl
->
z⁄es
; ++z) {

167 
ªsu…
 = 
	`›íRegi⁄SèãRegi⁄
(
ric
->
ris
, 
IO_READ
, 
comp⁄ít
->
öfo
->
köd
, 
z
,

168 &
p‹èl
->
ªgi⁄s
[
z
]);

169 i‡(
ªsu…
 !
UDS_SUCCESS
) {

170 
z
 > 0) {

171 
	`˛o£IORegi⁄
(&
p‹èl
->
ªgi⁄s
[--
z
]);

173 
	`ric_‰ìRódP‹èl
(
p‹èl
);

174  
ªsu…
;

178 *
p‹èlPå
 = 
p‹èl
;

179  
UDS_SUCCESS
;

180 
	}
}

183 
	$ric_disˇrdIndexComp⁄ít
(
IndexComp⁄ít
 *
comp⁄ít
)

185 
Regi⁄IndexComp⁄ít
 *
ric
 = 
	`asRegi⁄IndexComp⁄ít
(
comp⁄ít
);

187 
numZ⁄es
 = 0;

188 
ßveSlŸ
 = 0;

189 
ªsu…
 = 
	`födL©e°IndexSaveSlŸ
(
ric
->
ris
->
sÊ
,Ñic->ris->
°©e
.
id
,

190 &
numZ⁄es
, &
ßveSlŸ
);

191 i‡(
ªsu…
 !
UDS_SUCCESS
) {

192  
ªsu…
;

195 
ﬁdSaveSlŸ
 = 
ric
->
ris
->
ßveSlŸ
;

196 
ric
->
ris
->
ßveSlŸ
 = saveSlot;

198 
z
 = 0; z < 
numZ⁄es
; ++z) {

199 
IORegi⁄
 *
ªgi⁄
;

200 
ªsu…
 = 
	`›íRegi⁄SèãRegi⁄
(
ric
->
ris
, 
IO_WRITE
, 
comp⁄ít
->
öfo
->
köd
,

201 
z
, &
ªgi⁄
);

202 i‡(
ªsu…
 !
UDS_SUCCESS
) {

205 
ªsu…
 = 
	`˛órRegi⁄
(
ªgi⁄
);

206 
	`˛o£IORegi⁄
(&
ªgi⁄
);

207 i‡(
ªsu…
 !
UDS_SUCCESS
) {

212 
ric
->
ris
->
ßveSlŸ
 = 
ﬁdSaveSlŸ
;

214  
ªsu…
;

215 
	}
}

219 c⁄° 
IndexComp⁄ítOps
 
	gªgi⁄IndexComp⁄ítOps
 = {

220 .
‰ìMe
 = 
ric_‰ìIndexComp⁄ít
,

221 .
	g›íWrôeRegi⁄
 = 
ric_›íWrôeRegi⁄
,

222 .
	g˛ónupWrôe
 = 
ric_˛ónupWrôeFaûuª
,

223 .
	gp›uœãZ⁄es
 = 
ric_p›uœãWrôeZ⁄es
,

224 .
	g‰ìZ⁄es
 = 
ric_‰ìWrôeZ⁄es
,

225 .
	g¥ï¨eZ⁄es
 = 
ric_¥ï¨eZ⁄es
,

226 .
	g¸óãRódP‹èl
 = 
ric_¸óãRódP‹èl
,

227 .
	g‰ìRódP‹èl
 = 
ric_‰ìRódP‹èl
,

228 .
	gdisˇrd
 = 
ric_disˇrdIndexComp⁄ít
,

231 c⁄° 
IndexComp⁄ítOps
 *
	$gëRegi⁄IndexComp⁄ítOps
()

233  &
ªgi⁄IndexComp⁄ítOps
;

234 
	}
}

	@uds/regionIndexComponent.h

22 #i‚de‡
REGION_INDEX_COMPONENT_H


23 
	#REGION_INDEX_COMPONENT_H


	)

25 
	~"ödexComp⁄ít.h
"

26 
	~"ªgi⁄IndexSèã.h
"

41 
	$makeRegi⁄IndexComp⁄ít
(
Regi⁄IndexSèã
 *
ris
,

42 c⁄° 
IndexComp⁄ítInfo
 *
öfo
,

43 
z⁄eCou¡
,

44 *
d©a
,

45 *
c⁄ãxt
,

46 
IndexComp⁄ít
 **
comp⁄ítPå
)

47 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

	@uds/regionIndexComponentInternal.h

22 #i‚de‡
REGION_INDEX_COMPONENT_INTERNAL_H


23 
	#REGION_INDEX_COMPONENT_INTERNAL_H


	)

25 
	~"ªgi⁄IndexComp⁄ít.h
"

26 
	~"ödexComp⁄ítI¡î«l.h
"

28 
	~"compûî.h
"

29 
	~"≥rmas£π.h
"

31 
	sªgi⁄IndexComp⁄ít
 {

32 
IndexComp⁄ít
 
	mcomm⁄
;

33 
Regi⁄IndexSèã
 *
	mris
;

34 } 
	tRegi⁄IndexComp⁄ít
;

37 
INLINE
 
Regi⁄IndexComp⁄ít
 *
	$asRegi⁄IndexComp⁄ít
(
IndexComp⁄ít
 *
comp
)

39  
	`c⁄èöî_of
(
comp
, 
Regi⁄IndexComp⁄ít
, 
comm⁄
);

40 
	}
}

	@uds/regionIndexState.c

22 
	~"ªgi⁄IndexSèãI¡î«l.h
"

24 
	~"buf„ªdIORegi⁄.h
"

25 
	~"loggî.h
"

26 
	~"mem‹yAŒoc.h
"

27 
	~"ªgi⁄IndexComp⁄ít.h
"

28 
	~"sögÀFûeLayoutI¡î«ls.h
"

29 
	~"ty≥Defs.h
"

31 c⁄° 
IndexSèãOps
 *
gëRegi⁄IndexSèãOps
();

34 
	$makeRegi⁄IndexSèã
(
SögÀFûeLayout
 *
sÊ
,

35 
ödexId
,

36 
z⁄eCou¡
,

37 
Àngth
,

38 
IndexSèã
 **
°©ePå
)

40 
Regi⁄IndexSèã
 *
ris
 = 
NULL
;

41 
ªsu…
 = 
	`ALLOCATE
(1, 
Regi⁄IndexSèã
, "ªgi⁄ index sèã", &
ris
);

42 i‡(
ªsu…
 !
UDS_SUCCESS
) {

43  
ªsu…
;

46 
ªsu…
 = 
	`öôIndexSèã
(&
ris
->
°©e
, 
ödexId
, 
z⁄eCou¡
, 
Àngth
,

47 
	`gëRegi⁄IndexSèãOps
());

48 i‡(
ªsu…
 !
UDS_SUCCESS
) {

49 
	`FREE
(
ris
);

50  
ªsu…
;

53 
ris
->
sÊ
 = sfl;

54 
ris
->
lﬂdZ⁄es
 = 0;

55 
ris
->
lﬂdSlŸ
 = 
UINT_MAX
;

56 
ris
->
ßveSlŸ
 = 
UINT_MAX
;

58 *
°©ePå
 = &
ris
->
°©e
;

59  
UDS_SUCCESS
;

60 
	}
}

63 
	$ris_‰ìMe
(
IndexSèã
 *
°©e
)

65 i‡(
°©e
 =
NULL
) {

68 
Regi⁄IndexSèã
 *
ris
 = 
	`asRegi⁄IndexSèã
(
°©e
);

69 
	`de°royIndexSèã
(&
ris
->
°©e
);

70 
	`FREE
(
ris
);

71 
	}
}

74 
	$ris_addComp⁄ít
(
IndexSèã
 *
°©e
,

75 c⁄° 
IndexComp⁄ítInfo
 *
öfo
,

76 *
d©a
,

77 *
c⁄ãxt
)

79 
Regi⁄IndexSèã
 *
ris
 = 
	`asRegi⁄IndexSèã
(
°©e
);

81 
IndexComp⁄ít
 *
comp⁄ít
 = 
NULL
;

82 
ªsu…
 = 
	`makeRegi⁄IndexComp⁄ít
(
ris
, 
öfo
, 
°©e
->
z⁄eCou¡
,

83 
d©a
, 
c⁄ãxt
, &
comp⁄ít
);

84 i‡(
ªsu…
 !
UDS_SUCCESS
) {

85  
	`logEº‹WôhSåögEº‹
(
ªsu…
,

89 
ªsu…
 = 
	`addComp⁄ítToIndexSèã
(&
ris
->
°©e
, 
comp⁄ít
);

90 i‡(
ªsu…
 !
UDS_SUCCESS
) {

91 
	`‰ìIndexComp⁄ít
(&
comp⁄ít
);

92  
ªsu…
;

94  
UDS_SUCCESS
;

95 
	}
}

98 
	$ris_lﬂdSèã
(
IndexSèã
 *
°©e
, 
boﬁ
 *
ª∂ayPå
)

100 
Regi⁄IndexSèã
 *
ris
 = 
	`asRegi⁄IndexSèã
(
°©e
);

102 
ªsu…
 = 
	`födL©e°IndexSaveSlŸ
(
ris
->
sÊ
, 
°©e
->
id
, &ris->
lﬂdZ⁄es
,

103 &
ris
->
lﬂdSlŸ
);

104 i‡(
ªsu…
 !
UDS_SUCCESS
) {

105  
ªsu…
;

108 
ªsu…
 = 
	`gíîicLﬂdIndexSèã
(
°©e
, 
ª∂ayPå
);

109 
ris
->
lﬂdZ⁄es
 = 0;

110 
ris
->
lﬂdSlŸ
 = 
UINT_MAX
;

111  
ªsu…
;

112 
	}
}

115 
	$ris_¥ï¨eSave
(
IndexSèã
 *
°©e
, 
IndexSaveTy≥
 
ßveTy≥
)

117 
Regi⁄IndexSèã
 *
ris
 = 
	`asRegi⁄IndexSèã
(
°©e
);

119 
ªsu…
 = 
	`£tupSögÀFûeIndexSaveSlŸ
(
ris
->
sÊ
, 
°©e
->
id
,

120 
°©e
->
z⁄eCou¡
, 
ßveTy≥
,

121 &
ris
->
ßveSlŸ
);

122 i‡(
ªsu…
 !
UDS_SUCCESS
) {

123  
	`logEº‹WôhSåögEº‹
(
ªsu…
,

125 
	`ödexSaveTy≥Name
(
ßveTy≥
),

126 
__func__
);

129  
UDS_SUCCESS
;

130 
	}
}

133 
	$ris_commôSave
(
IndexSèã
 *
°©e
)

135 
Regi⁄IndexSèã
 *
ris
 = 
	`asRegi⁄IndexSèã
(
°©e
);

137 
ªsu…
 = 
	`commôSögÀFûeIndexSave
(
ris
->
sÊ
, 
°©e
->
id
,Ñis->
ßveSlŸ
);

138 i‡(
ªsu…
 !
UDS_SUCCESS
) {

139  
	`logEº‹WôhSåögEº‹
(
ªsu…
,

141 
__func__
);

144 
ris
->
ßveSlŸ
 = 
UINT_MAX
;

145  
UDS_SUCCESS
;

146 
	}
}

149 
	$ris_˛ónupSave
(
IndexSèã
 *
°©e
)

151 
Regi⁄IndexSèã
 *
ris
 = 
	`asRegi⁄IndexSèã
(
°©e
);

153 
ªsu…
 = 
	`ˇn˚lSögÀFûeIndexSave
(
ris
->
sÊ
, 
°©e
->
id
,Ñis->
ßveSlŸ
);

154 
ris
->
ßveSlŸ
 = 
UINT_MAX
;

155 i‡(
ªsu…
 !
UDS_SUCCESS
) {

156  
	`logEº‹WôhSåögEº‹
(
ªsu…
,

158 
__func__
);

160  
UDS_SUCCESS
;

161 
	}
}

164 
ris_wrôeSögÀComp⁄ít
(
IndexSèã
 *
°©e


165 
__©åibuã__
((
unu£d
)),

166 
IndexComp⁄ít
 *
comp⁄ít


167 
__©åibuã__
((
unu£d
)))

169  
	gUDS_UNSUPPORTED
;

173 
	$ris_disˇrdSaves
(
IndexSèã
 *
°©e
, 
DisˇrdTy≥
 
dt
)

175 
Regi⁄IndexSèã
 *
ris
 = 
	`asRegi⁄IndexSèã
(
°©e
);

177 
ªsu…
 = 
	`disˇrdSögÀFûeIndexSaves
(
ris
->
sÊ
, 
°©e
->
id
,

178 
dt
 =
DT_DISCARD_ALL
);

179 
ris
->
ßveSlŸ
 = 
UINT_MAX
;

180 i‡(
ªsu…
 !
UDS_SUCCESS
) {

181  
	`logEº‹WôhSåögEº‹
(
ªsu…
,

182 "%s: c™nŸ de°roy %s", 
__func__
,

183 ((
dt
 =
DT_DISCARD_ALL
)

187  
UDS_SUCCESS
;

188 
	}
}

192 c⁄° 
IndexSèãOps
 
	gªgi⁄IndexSèãOps
 = {

193 .
‰ìFunc
 = 
ris_‰ìMe
,

194 .
	gaddComp⁄ít
 = 
ris_addComp⁄ít
,

195 .
	glﬂdSèã
 = 
ris_lﬂdSèã
,

196 .
	gßveSèã
 = 
gíîicSaveIndexSèã
,

197 .
	g¥ï¨eSave
 = 
ris_¥ï¨eSave
,

198 .
	gcommôSave
 = 
ris_commôSave
,

199 .
	g˛ónupSave
 = 
ris_˛ónupSave
,

200 .
	gwrôeCheckpoöt
 = 
gíîicWrôeIndexSèãCheckpoöt
,

201 .
	gwrôeSögÀComp⁄ít
 = 
ris_wrôeSögÀComp⁄ít
,

202 .
	gdisˇrdSaves
 = 
ris_disˇrdSaves
,

205 c⁄° 
IndexSèãOps
 *
	$gëRegi⁄IndexSèãOps
()

207  &
ªgi⁄IndexSèãOps
;

208 
	}
}

211 
	$›íRegi⁄SèãRegi⁄
(
Regi⁄IndexSèã
 *
ris
,

212 
IOAc˚ssMode
 
mode
,

213 
Regi⁄Köd
 
köd
,

214 
z⁄e
,

215 
IORegi⁄
 **
ªgi⁄På
)

217 
¶Ÿ
;

218 c⁄° *
›î©i⁄
;

220 i‡(
mode
 =
IO_READ
) {

221 
¶Ÿ
 = 
ris
->
lﬂdSlŸ
;

222 
›î©i⁄
 = "load";

223 } i‡(
mode
 =
IO_WRITE
) {

224 
¶Ÿ
 = 
ris
->
ßveSlŸ
;

225 
›î©i⁄
 = "save";

227  
	`logEº‹WôhSåögEº‹
(
UDS_INVALID_ARGUMENT
,

229 
__func__
);

232 
ªsu…
 = 
	`ASSERT
((
¶Ÿ
 < 
ris
->
sÊ
->
su≥r
.
maxSaves
),

233 "%†nŸ sèπed", 
›î©i⁄
);

234 i‡(
ªsu…
 !
UDS_SUCCESS
) {

235  
ªsu…
;

238 
SubIndexLayout
 *
sû
 = &
ris
->
sÊ
->
ödexes
[ris->
°©e
.
id
];

239 
IndexSaveLayout
 *
i¶
 = &
sû
->
ßves
[
¶Ÿ
];

241 
LayoutRegi⁄
 *
Ã
 = 
NULL
;

242 
köd
) {

243 
RL_KIND_INDEX_PAGE_MAP
:

244 
Ã
 = &
i¶
->
ödexPageM≠
;

247 
RL_KIND_OPEN_CHAPTER
:

248 i‡(
i¶
->
›íCh≠ãr
 =
NULL
) {

249  
	`logEº‹WôhSåögEº‹
(
UDS_UNEXPECTED_RESULT
,

251 
__func__
, 
›î©i⁄
);

253 
Ã
 = 
i¶
->
›íCh≠ãr
;

256 
RL_KIND_MASTER_INDEX
:

257 i‡(
i¶
->
ma°îIndexZ⁄es
 =
NULL
 || 
z⁄e
 >i¶->
numZ⁄es
) {

258  
	`logEº‹WôhSåögEº‹
(
UDS_UNEXPECTED_RESULT
,

260 
__func__
, 
›î©i⁄
, 
z⁄e
);

262 
Ã
 = &
i¶
->
ma°îIndexZ⁄es
[
z⁄e
];

265 
RL_KIND_INDEX_STATE
:

266 i‡(
i¶
->
ödexSèãBuf„r
 =
NULL
) {

267  
	`logEº‹WôhSåögEº‹
(
UDS_UNEXPECTED_RESULT
,

269 
__func__
, 
›î©i⁄
);

271  
	`makeBuf„ªdRegi⁄
(
i¶
->
ödexSèãBuf„r
, 0, 
ªgi⁄På
);

275  
	`logEº‹WôhSåögEº‹
(
UDS_INVALID_ARGUMENT
,

277 
__func__
, 
köd
);

280  
	`gëSögÀFûeLayoutRegi⁄
(
ris
->
sÊ
, 
Ã
, 
mode
, 
ªgi⁄På
);

281 
	}
}

	@uds/regionIndexState.h

22 #i‚de‡
REGION_INDEX_STATE_H


23 
	#REGION_INDEX_STATE_H


	)

25 
	~"ödexSèãI¡î«ls.h
"

26 
	~"≥rmas£π.h
"

27 
	~"sögÀFûeLayout.h
"

29 
	sªgi⁄IndexSèã
 {

30 
IndexSèã
 
	m°©e
;

31 
SögÀFûeLayout
 *
	msÊ
;

32 
	mlﬂdZ⁄es
;

33 
	mlﬂdSlŸ
;

34 
	mßveSlŸ
;

35 } 
	tRegi⁄IndexSèã
;

47 
	$makeRegi⁄IndexSèã
(
SögÀFûeLayout
 *
sÊ
,

48 
ödexId
,

49 
z⁄eCou¡
,

50 
Àngth
,

51 
IndexSèã
 **
°©ePå
)

52 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

55 
INLINE
 
Regi⁄IndexSèã
 *
	$asRegi⁄IndexSèã
(
IndexSèã
 *
°©e
)

57  
	`c⁄èöî_of
(
°©e
, 
Regi⁄IndexSèã
, state);

58 
	}
}

	@uds/regionIndexStateInternal.h

22 #i‚de‡
REGION_INDEX_STATE_INTERNAL_H


23 
	#REGION_INDEX_STATE_INTERNAL_H


	)

25 
	~"ªgi⁄IndexSèã.h
"

39 
	$›íRegi⁄SèãRegi⁄
(
Regi⁄IndexSèã
 *
ris
,

40 
IOAc˚ssMode
 
mode
,

41 
Regi⁄Köd
 
köd
,

42 
z⁄e
,

43 
IORegi⁄
 **
ªgi⁄På
)

44 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

	@uds/request.c

22 
	~"ªque°.h
"

24 
	~"„©uªDefs.h
"

25 
	~"grid.h
"

26 
	~"ödexSessi⁄.h
"

27 
	~"isCÆlbackThªadDefs.h
"

28 
	~"loggî.h
"

29 
	~"mem‹yAŒoc.h
"

30 
	~"∑ømëî.h
"

31 
	~"≥rmas£π.h
"

32 
	~"ªque°Limô.h
"

33 
	~"udsSèã.h
"

38 
	ssynchr⁄ousCÆlback
 {

39 
Muãx
 
	mmuãx
;

40 
C⁄dV¨
 
	mc⁄dôi⁄
;

41 
boﬁ
 
	mcom∂ëe
;

45 #i‡
HISTOGRAMS


46 
	~"hi°ogøm.h
"

48 
Hi°ogøm
 *
	gtu∫¨oundTimeHi°ogøm
 = 
NULL
;

49 c⁄° *
	gtu∫¨oundTimeHi°ogømName
 = 
NULL
;

51 
	$föishTu∫¨oundHi°ogøm
()

53 
	`∂ŸHi°ogøm
(
tu∫¨oundTimeHi°ogømName
, 
tu∫¨oundTimeHi°ogøm
);

54 
	`‰ìHi°ogøm
(&
tu∫¨oundTimeHi°ogøm
);

55 
	}
}

57 
	$doTu∫¨oundHi°ogøm
(c⁄° *
«me
)

59 
ªsu…
 = 
	`udsSëP¨amëî
(
UDS_TIME_REQUEST_TURNAROUND
, 
UDS_PARAM_TRUE
);

60 i‡(
ªsu…
 !
UDS_SUCCESS
) {

61 
	`logEº‹WôhSåögEº‹
(
ªsu…
, "cannot set %sÅoÅrue",

62 
UDS_TIME_REQUEST_TURNAROUND
);

65 
tu∫¨oundTimeHi°ogømName
 = 
«me
;

66 
tu∫¨oundTimeHi°ogøm
 = 
	`makeLog¨ôhmicHi°ogøm
("Turnaround Time", 7);

67 
	`©exô
(
föishTu∫¨oundHi°ogøm
);

68 
	}
}

76 
	$awakíSynchr⁄ousReque°
(
Synchr⁄ousCÆlback
 *
synchr⁄ous
)

79 
	`lockMuãx
(&
synchr⁄ous
->
muãx
);

80 
synchr⁄ous
->
com∂ëe
 = 
åue
;

83 
	`brﬂdˇ°C⁄d
(&
synchr⁄ous
->
c⁄dôi⁄
);

84 
	`u∆ockMuãx
(&
synchr⁄ous
->
muãx
);

85 
	}
}

90 
	$öôülizeSynchr⁄ousReque°
(
Synchr⁄ousCÆlback
 *
synchr⁄ous
)

92 
ªsu…
 = 
	`öôC⁄d
(&
synchr⁄ous
->
c⁄dôi⁄
);

93 i‡(
ªsu…
 !
UDS_SUCCESS
) {

94  
ªsu…
;

96 
ªsu…
 = 
	`öôMuãx
(&
synchr⁄ous
->
muãx
);

97 i‡(
ªsu…
 !
UDS_SUCCESS
) {

98  
ªsu…
;

100 
synchr⁄ous
->
com∂ëe
 = 
Ál£
;

101  
UDS_SUCCESS
;

102 
	}
}

108 
	$awaôSynchr⁄ousReque°
(
Synchr⁄ousCÆlback
 *
synchr⁄ous
)

110 
	`lockMuãx
(&
synchr⁄ous
->
muãx
);

111 !
synchr⁄ous
->
com∂ëe
) {

112 
	`waôC⁄d
(&
synchr⁄ous
->
c⁄dôi⁄
, &synchr⁄ous->
muãx
);

114 
	`u∆ockMuãx
(&
synchr⁄ous
->
muãx
);

117 
	`de°royC⁄d
(&
synchr⁄ous
->
c⁄dôi⁄
);

118 
	`de°royMuãx
(&
synchr⁄ous
->
muãx
);

119 
	}
}

122 
	$œunchAŒoˇãdClõ¡Reque°
(
Reque°
 *
ªque°
)

124 
ªsu…
 = 
	`gëBa£C⁄ãxt
(
ªque°
->
blockC⁄ãxt
.
id
, 
BLOCK_CONTEXT
,

125 &
ªque°
->
c⁄ãxt
);

126 i‡(
ªsu…
 !
UDS_SUCCESS
) {

127  
	`ßnsUƒecovîabÀ
(
ªsu…
);

131 
AbsTime
 
öôTime
 = 
ABSTIME_EPOCH
;

132 i‡(
ªque°
->
c⁄ãxt
->
timeReque°Tu∫¨ound
) {

133 
öôTime
 = 
	`cuºítTime
(
CT_MONOTONIC
);

136 
ªque°
->
a˘i⁄
 = (
Reque°A˘i⁄
Ëªque°->
ty≥
;

137 
ªque°
->
‰omCÆlback
 = 
åue
;

138 
ªque°
->
öôTime
 = initTime;

139 
ªque°
->
isC⁄åﬁMesßge
 = 
Ál£
;

140 
ªque°
->
unb©ched
 = 
Ál£
;

142 #i‡
NAMESPACES


143 
	`x‹Name•a˚
(&
ªque°
->
hash
, &ªque°->
c⁄ãxt
->
«me•a˚Hash
);

145 
ªque°
->
rouãr
 = 
	`£À˘GridRouãr
‘eque°->
c⁄ãxt
->
ödexSessi⁄
->
grid
,

146 &
ªque°
->
hash
);

148 
	`íqueueReque°
(
ªque°
, 
STAGE_TRIAGE
);

149  
UDS_SUCCESS
;

150 
	}
}

153 
	$¸óãReque°
(
c⁄ãxtId
,

154 
C⁄ãxtTy≥
 
c⁄ãxtTy≥
,

155 
Reque°
 **
ªque°På
)

157 i‡(
ªque°På
 =
NULL
) {

158 
	`logW¨nögWôhSåögEº‹
(
UDS_INVALID_ARGUMENT
,

160  
UDS_INVALID_ARGUMENT
;

163 
UdsC⁄ãxt
 *
c⁄ãxt
;

164 
ªsu…
 = 
	`gëBa£C⁄ãxt
(
c⁄ãxtId
, 
c⁄ãxtTy≥
, &
c⁄ãxt
);

165 i‡(
ªsu…
 !
UDS_SUCCESS
) {

166  
	`ßnsUƒecovîabÀ
(
ªsu…
);

170 
AbsTime
 
öôTime
 = 
ABSTIME_EPOCH
;

171 i‡(
c⁄ãxt
->
timeReque°Tu∫¨ound
) {

172 
öôTime
 = 
	`cuºítTime
(
CT_MONOTONIC
);

177 
boﬁ
 
⁄CÆlbackThªad
 = 
	`isCÆlbackThªad
();

178 i‡(!
⁄CÆlbackThªad
) {

179 
	`b‹rowReque°Pîmô
(
c⁄ãxt
->
ªque°Limô
);

184 
boﬁ
 
unb©ched
 = (
	`gëReque°PîmôLimô
(
c⁄ãxt
->
ªque°Limô
) == 1);

186 
Reque°
 *
ªque°
;

187 
ªsu…
 = 
	`ALLOCATE
(1, 
Reque°
, "ªque°", &
ªque°
);

188 i‡(
ªsu…
 !
UDS_SUCCESS
) {

189  
	`h™dÀEº‹AndRñó£Ba£C⁄ãxt
(
c⁄ãxt
, 
ªsu…
);

193 
ªque°
->
c⁄ãxt
 = context;

194 
ªque°
->
‰omCÆlback
 = 
⁄CÆlbackThªad
;

195 
ªque°
->
öôTime
 = initTime;

196 
ªque°
->
upd©e
 = 
Ál£
;

197 
ªque°
->
isC⁄åﬁMesßge
 = 
Ál£
;

198 
ªque°
->
unb©ched
 = unbatched;

199 *
ªque°På
 = 
ªque°
;

200  
UDS_SUCCESS
;

201 
	}
}

204 
	$œunchClõ¡Reque°
(
c⁄ãxtId
,

205 
C⁄ãxtTy≥
 
c⁄ãxtTy≥
,

206 
UdsCÆlbackTy≥
 
ˇŒbackTy≥
,

207 
boﬁ
 
upd©e
,

208 c⁄° 
UdsChunkName
 *
chunkName
,

209 
UdsCookõ
 
cookõ
,

210 *
mëad©a
,

211 
size_t
 
d©aLígth
,

212 c⁄° *
d©a
)

214 
Reque°
 *
ªque°
;

215 
ªsu…
 = 
	`¸óãReque°
(
c⁄ãxtId
, 
c⁄ãxtTy≥
, &
ªque°
);

216 i‡(
ªsu…
 !
UDS_SUCCESS
) {

217  
ªsu…
;

220 
ªque°
->
upd©e
 = update;

221 
ªque°
->
cookõ
 = cookie;

222 
ªque°
->
ty≥
 = 
ˇŒbackTy≥
;

223 
ªque°
->
d©aLígth
 = dataLength;

224 
ªque°
->
a˘i⁄
 = (
Reque°A˘i⁄
Ë
ˇŒbackTy≥
;

226 
Reque°Sège
 
öôülSège
 = 
STAGE_TRIAGE
;

227 i‡(
chunkName
 !
NULL
) {

228 
	`£tReque°Hash
(
ªque°
, 
chunkName
);

229 } i‡(
d©a
 !
NULL
) {

230 
öôülSège
 = 
STAGE_HASH
;

231 i‡(
d©aLígth
 > 0) {

232 
ªsu…
 = 
	`memdup
(
d©a
, 
d©aLígth
, "ªque° d©a", &
ªque°
->data);

235 
ªsu…
 = 
	`ASSERT_FALSE
("requestÇeeds chunkÇame or chunk data");

237 i‡(
ªsu…
 !
UDS_SUCCESS
) {

238 
	`‰ìReque°
(
ªque°
);

239  
ªsu…
;

242 i‡(
mëad©a
 !
NULL
) {

243 (*
ªque°
->
c⁄ãxt
->
mëad©aEncodî
)(
mëad©a
,Ñequest);

246 
	`íqueueReque°
(
ªque°
, 
öôülSège
);

247  
UDS_SUCCESS
;

248 
	}
}

250 #i‡
GRID


252 
	$œunchAIPC⁄åﬁMesßge
(
AIPC⁄ãxt
 *
£rvîC⁄ãxt
,

253 *
c⁄åﬁD©a
,

254 
Reque°A˘i⁄
 
c⁄åﬁA˘i⁄
,

255 
Reque°Sège
 
öôülSège
,

256 
IndexRouãr
 *
rouãr
,

257 
Reque°
 **
ªque°På
)

259 
Reque°
 *
ªque°
;

260 
ªsu…
 = 
	`ALLOCATE
(1, 
Reque°
, 
__func__
, &
ªque°
);

261 i‡(
ªsu…
 !
UDS_SUCCESS
) {

262 
	`FREE
(
£rvîC⁄ãxt
);

263  
ªsu…
;

266 
ªque°
->
£rvîC⁄ãxt
 = serverContext;

267 
ªque°
->
rouãr
 =Ñouter;

268 
ªque°
->
isC⁄åﬁMesßge
 = 
åue
;

269 
ªque°
->
unb©ched
 = 
åue
;

270 
ªque°
->
a˘i⁄
 = 
c⁄åﬁA˘i⁄
;

271 
ªque°
->
c⁄åﬁD©a
 = controlData;

274 i‡(
ªque°På
 =
NULL
) {

275 
	`íqueueReque°
(
ªque°
, 
öôülSège
);

276  
UDS_SUCCESS
;

280 
Synchr⁄ousCÆlback
 
synchr⁄ous
;

281 
ªsu…
 = 
	`öôülizeSynchr⁄ousReque°
(&
synchr⁄ous
);

282 i‡(
ªsu…
 !
UDS_SUCCESS
) {

283 
	`FREE
(
ªque°
);

284 
	`FREE
(
£rvîC⁄ãxt
);

285  
ªsu…
;

287 
ªque°
->
synchr⁄ous
 = &synchronous;

289 
	`íqueueReque°
(
ªque°
, 
öôülSège
);

290 
	`awaôSynchr⁄ousReque°
(
ªque°
->
synchr⁄ous
);

291 
ªque°
->
synchr⁄ous
 = 
NULL
;

293 *
ªque°På
 = 
ªque°
;

294  
ªsu…
;

295 
	}
}

299 
	$œunchClõ¡C⁄åﬁMesßge
(
UdsC⁄ãxt
 *
c⁄ãxt
,

300 *
c⁄åﬁD©a
,

301 
Reque°A˘i⁄
 
c⁄åﬁA˘i⁄
,

302 
Reque°Sège
 
öôülSège
,

303 
Reque°
 **
ªque°På
)

305 
Reque°
 *
ªque°
;

306 
ªsu…
 = 
	`ALLOCATE
(1, 
Reque°
, 
__func__
, &
ªque°
);

307 i‡(
ªsu…
 !
UDS_SUCCESS
) {

308  
ªsu…
;

311 
ªque°
->
c⁄ãxt
 = context;

312 
ªque°
->
isC⁄åﬁMesßge
 = 
åue
;

313 
ªque°
->
unb©ched
 = 
åue
;

314 
ªque°
->
a˘i⁄
 = 
c⁄åﬁA˘i⁄
;

315 
ªque°
->
c⁄åﬁD©a
 = controlData;

318 i‡(
ªque°På
 =
NULL
) {

319 
	`íqueueReque°
(
ªque°
, 
öôülSège
);

320  
UDS_SUCCESS
;

324 
Synchr⁄ousCÆlback
 
synchr⁄ous
;

325 
ªsu…
 = 
	`öôülizeSynchr⁄ousReque°
(&
synchr⁄ous
);

326 i‡(
ªsu…
 !
UDS_SUCCESS
) {

327 
	`FREE
(
ªque°
);

328  
ªsu…
;

330 
ªque°
->
synchr⁄ous
 = &synchronous;

332 
	`íqueueReque°
(
ªque°
, 
öôülSège
);

333 
	`awaôSynchr⁄ousReque°
(
ªque°
->
synchr⁄ous
);

334 
ªque°
->
synchr⁄ous
 = 
NULL
;

336 *
ªque°På
 = 
ªque°
;

337  
ªsu…
;

338 
	}
}

341 
	$œunchZ⁄eC⁄åﬁMesßge
(
Reque°A˘i⁄
 
a˘i⁄
,

342 
Z⁄eMesßge
 
mesßge
,

343 
z⁄e
,

344 
IndexRouãr
 *
rouãr
)

346 
Reque°
 *
ªque°
;

347 
ªsu…
 = 
	`ALLOCATE
(1, 
Reque°
, 
__func__
, &
ªque°
);

348 i‡(
ªsu…
 !
UDS_SUCCESS
) {

349  
ªsu…
;

352 
ªque°
->
rouãr
 =Ñouter;

353 
ªque°
->
isC⁄åﬁMesßge
 = 
åue
;

354 
ªque°
->
unb©ched
 = 
åue
;

355 
ªque°
->
a˘i⁄
 =áction;

356 
ªque°
->
z⁄eNumbî
 = 
z⁄e
;

357 
ªque°
->
z⁄eMesßge
 = 
mesßge
;

359 
	`íqueueReque°
(
ªque°
, 
STAGE_INDEX
);

360  
UDS_SUCCESS
;

361 
	}
}

364 
	$‰ìReque°
(
Reque°
 *
ªque°
)

366 i‡(
ªque°
 =
NULL
) {

371 
UdsC⁄ãxt
 *
c⁄ãxt
 = 
ªque°
->context;

372 
boﬁ
 
hﬁdsPîmô
 = (!
ªque°
->
‰omCÆlback
 && !ªque°->
isC⁄åﬁMesßge
);

374 
	`FREE
(
ªque°
->
£rvîC⁄ãxt
);

378 
	`FREE
(
ªque°
->
d©a
);

379 
	`FREE
(
ªque°
);

380 
ªque°
 = 
NULL
;

382 i‡(
c⁄ãxt
 =
NULL
) {

388 i‡(
hﬁdsPîmô
) {

389 
	`ªtu∫Reque°Pîmôs
(
c⁄ãxt
->
ªque°Limô
, 1);

394 
	`ªÀa£Ba£C⁄ãxt
(
c⁄ãxt
);

395 
	}
}

398 
	$£tReque°Hash
(
Reque°
 *
ªque°
, c⁄° 
UdsChunkName
 *
«me
)

400 i‡(
«me
 =
NULL
) {

404 
ªque°
->
hash
 = *
«me
;

405 #i‡
NAMESPACES


406 
	`x‹Name•a˚
(&
ªque°
->
hash
, &ªque°->
c⁄ãxt
->
«me•a˚Hash
);

410 
ªque°
->
rouãr
 = 
	`£À˘GridRouãr
‘eque°->
c⁄ãxt
->
ödexSessi⁄
->
grid
,

411 &
ªque°
->
hash
);

412 
	}
}

419 
öt64_t
 
	$gëTu∫¨oundTime
(
Reque°
 *
ªque°
)

421 i‡(!
ªque°
->
c⁄ãxt
->
timeReque°Tu∫¨ound
) {

425 
AbsTime
 
föishTime
 = 
	`cuºítTime
(
CT_MONOTONIC
);

443  
	`ªlTimeToMi¸o£c⁄ds
(
	`timeDif„ªn˚
(
föishTime
, 
ªque°
->
öôTime
));

444 
	}
}

447 
Reque°Queue
 *
	$gëNextSègeQueue
(
Reque°
 *
ªque°
,

448 
Reque°Sège
 
√xtSège
)

450 i‡(
√xtSège
 =
STAGE_HASH
) {

453  
	`gëNextHashQueue
(
ªque°
);

456 i‡(
√xtSège
 =
STAGE_CALLBACK
) {

457  
	`gëCÆlbackQueue
();

462  
ªque°
->
rouãr
->
mëhods
->
	`£À˘Queue
(request->router,Ñequest,

463 
√xtSège
);

464 
	}
}

467 
	$h™dÀReque°Eº‹s
(
Reque°
 *
ªque°
)

473 i‡(
ªque°
->
synchr⁄ous
 !
NULL
) {

474 
	`awakíSynchr⁄ousReque°
(
ªque°
->
synchr⁄ous
);

476 
	`‰ìReque°
(
ªque°
);

478 
	}
}

481 
	$íqueueReque°
(
Reque°
 *
ªque°
, 
Reque°Sège
 
√xtSège
)

483 
Reque°Queue
 *
√xtQueue
 = 
	`gëNextSègeQueue
(
ªque°
, 
√xtSège
);

484 i‡(
√xtQueue
 =
NULL
) {

485 
	`h™dÀReque°Eº‹s
(
ªque°
);

489 
	`ªque°QueueEnqueue
(
√xtQueue
, 
ªque°
);

490 
	}
}

496 
Reque°Re°¨ãr
 
	gªque°Re°¨ãr
 = 
NULL
;

499 
	$ª°¨tReque°
(
Reque°
 *
ªque°
)

501 
ªque°
->
ªqueued
 = 
åue
;

502 i‡(
ªque°Re°¨ãr
 =
NULL
) {

503 
	`íqueueReque°
(
ªque°
, 
STAGE_INDEX
);

505 
	`ªque°Re°¨ãr
(
ªque°
);

507 
	}
}

510 
	$£tReque°Re°¨ãr
(
Reque°Re°¨ãr
 
ª°¨ãr
)

512 
ªque°Re°¨ãr
 = 
ª°¨ãr
;

513 
	}
}

516 
	$upd©eReque°C⁄ãxtSèts
(
Reque°
 *
ªque°
)

518 
öt64_t
 
tu∫¨ound
 = 
	`gëTu∫¨oundTime
(
ªque°
);

523 
UdsC⁄ãxt
 *
c⁄ãxt
 = 
ªque°
->context;

524 
SètCou¡îs
 *
cou¡îs
 = &
c⁄ãxt
->
°©s
.counters;

531 
cou¡îs
->
ªque°Tu∫¨oundTime
 +
tu∫¨ound
;

532 i‡(
tu∫¨ound
 > 
cou¡îs
->
maximumTu∫¨oundTime
) {

533 
cou¡îs
->
maximumTu∫¨oundTime
 = 
tu∫¨ound
;

535 #i‡
HISTOGRAMS


536 i‡(
tu∫¨oundTimeHi°ogøm
 !
NULL
) {

537 
	`íãrHi°ogømSam∂e
(
tu∫¨oundTimeHi°ogøm
, 
tu∫¨ound
);

541 
cou¡îs
->
ªque°s
++;

542 
boﬁ
 
found
 = (
ªque°
->
loˇti⁄
 !
LOC_UNAVAILABLE
);

544 
ªque°
->
a˘i⁄
) {

545 
REQUEST_INDEX
:

546 i‡(
found
) {

547 
cou¡îs
->
po°sFound
++;

549 i‡(
ªque°
->
loˇti⁄
 =
LOC_IN_OPEN_CHAPTER
) {

550 
cou¡îs
->
po°sFoundO≥nCh≠ãr
++;

551 } i‡(
ªque°
->
loˇti⁄
 =
LOC_IN_DENSE
) {

552 
cou¡îs
->
po°sFoundDí£
++;

553 } i‡(
ªque°
->
loˇti⁄
 =
LOC_IN_SPARSE
) {

554 
cou¡îs
->
po°sFoundS∑r£
++;

557 i‡(
ªque°
->
d©aLígth
 > 0) {

558 
cou¡îs
->
byãsFound
 +
ªque°
->
d©aLígth
;

559 
cou¡îs
->
po°sFoundD©a
++;

562 
cou¡îs
->
po°sNŸFound
++;

563 i‡(
ªque°
->
d©aLígth
 > 0) {

564 
cou¡îs
->
byãsNŸFound
 +
ªque°
->
d©aLígth
;

565 
cou¡îs
->
po°sNŸFoundD©a
++;

570 
REQUEST_UPDATE
:

571 i‡(
found
) {

572 
cou¡îs
->
upd©esFound
++;

574 
cou¡îs
->
upd©esNŸFound
++;

578 
REQUEST_DELETE
:

579 i‡(
found
) {

580 
cou¡îs
->
dñëi⁄sFound
++;

582 
cou¡îs
->
dñëi⁄sNŸFound
++;

586 
REQUEST_QUERY
:

587 i‡(
found
) {

588 
cou¡îs
->
quîõsFound
++;

590 
cou¡îs
->
quîõsNŸFound
++;

595 
ªque°
->
°©us
 = 
	`ASSERT
(
Ál£
, "unknownÇextáction inÑequest: %d",

596 
ªque°
->
a˘i⁄
);

598 
	}
}

601 
	$íãrCÆlbackSège
(
Reque°
 *
ªque°
)

603 i‡(!
ªque°
->
isC⁄åﬁMesßge
) {

605 
	`ASSERT_LOG_ONLY
(
ªque°
->
synchr⁄ous
 =
NULL
, "asynchronousÑequest");

607 i‡(
ªque°
->
°©us
 !
UDS_SUCCESS
) {

608 
ªque°
->
°©us
 = 
	`h™dÀEº‹
‘eque°->
c⁄ãxt
,Ñequest->status);

612 
	`íqueueReque°
(
ªque°
, 
STAGE_CALLBACK
);

613 } i‡(
ªque°
->
synchr⁄ous
 !
NULL
) {

619 
	`awakíSynchr⁄ousReque°
(
ªque°
->
synchr⁄ous
);

626 
	`‰ìReque°
(
ªque°
);

628 
	}
}

	@uds/request.h

22 #i‚de‡
REQUEST_H


23 
	#REQUEST_H


	)

25 
	~"ˇcheCou¡îs.h
"

26 
	~"comm⁄.h
"

27 
	~"compûî.h
"

28 
	~"c⁄ãxt.h
"

29 
	~"queue.h
"

30 
	~"timeUtûs.h
"

31 
	~"uds.h
"

32 
	~"utû/fu¬ñQueue.h
"

40 
	mREQUEST_INDEX
 = 
UDS_POST
,

41 
	mREQUEST_UPDATE
 = 
UDS_UPDATE
,

42 
	mREQUEST_DELETE
 = 
UDS_DELETE
,

43 
	mREQUEST_QUERY
 = 
UDS_QUERY
,

45 
	mREQUEST_CONTROL
,

49 
	mREQUEST_SPARSE_CACHE_BARRIER
,

54 
	mREQUEST_ANNOUNCE_CHAPTER_CLOSED
,

58 
	mREQUEST_OPEN
,

59 
	mREQUEST_CLOSE
,

60 
	mREQUEST_GET_CONFIG
,

61 
	mREQUEST_GET_STATS
,

62 
	mREQUEST_GET_SERVER_STATUS
,

63 
	mREQUEST_WRITE
,

64 
	mREQUEST_FINISH
,

68 
	mREQUEST_COLLECT_CONTEXT_STATS
,

71 
	mREQUEST_RESET_CONTEXT_STATS


72 } 
	tReque°A˘i⁄
;

79 
	mLOC_UNAVAILABLE
,

81 
	mLOC_IN_OPEN_CHAPTER
,

83 
	mLOC_IN_DENSE
,

85 
	mLOC_IN_SPARSE


86 } 
	tIndexRegi⁄
;

93 
	mSTAGE_HASH
,

94 
	mSTAGE_TRIAGE
,

95 
	mSTAGE_INDEX
,

96 
	mSTAGE_CALLBACK
,

97 } 
	tReque°Sège
;

103 
	sb¨rõrMesßgeD©a
 {

105 
uöt64_t
 
	mvútuÆCh≠ãr
;

106 } 
	tB¨rõrMesßgeD©a
;

112 
	sch≠ãrClo£dMesßgeD©a
 {

114 
uöt64_t
 
	mvútuÆCh≠ãr
;

115 } 
	tCh≠ãrClo£dMesßgeD©a
;

121 
	uz⁄eMesßgeD©a
 {

122 
B¨rõrMesßgeD©a
 
	mb¨rõr
;

123 
Ch≠ãrClo£dMesßgeD©a
 
	mch≠ãrClo£d
;

124 } 
	tZ⁄eMesßgeD©a
;

126 
	sz⁄eMesßge
 {

128 
ödex
 *
	mödex
;

130 
Z⁄eMesßgeD©a
 
	md©a
;

131 } 
	tZ⁄eMesßge
;

137 
synchr⁄ousCÆlback
 
	tSynchr⁄ousCÆlback
;

142 
	sªque°
 {

147 
UdsChunkName
 
	mhash
;

148 
UdsChunkD©a
 
	mﬁdMëad©a
;

149 
UdsChunkD©a
 
	m√wMëad©a
;

150 
UdsChunkCÆlback
 *
	mˇŒback
;

151 
UdsBlockC⁄ãxt
 
	mblockC⁄ãxt
;

152 
UdsCÆlbackTy≥
 
	mty≥
;

153 
	m°©us
;

154 
boﬁ
 
	mfound
;

155 
boﬁ
 
	mupd©e
;

160 
Fu¬ñQueueE¡ry
 
	mªque°QueueLök
;

161 
STAILQ_ENTRY
(
ªque°
Ë
	mlök
;

162 
AIPC⁄ãxt
 *
	m£rvîC⁄ãxt
;

163 
UdsC⁄ãxt
 *
	mc⁄ãxt
;

164 
IndexRouãr
 *
	mrouãr
;

167 *
	mc⁄åﬁD©a
;

168 
Z⁄eMesßge
 
	mz⁄eMesßge
;

169 
boﬁ
 
	misC⁄åﬁMesßge
;

171 
boﬁ
 
	m‰omCÆlback
;

172 
boﬁ
 
	munb©ched
;

173 
boﬁ
 
	mªqueued
;

174 
Reque°A˘i⁄
 
	ma˘i⁄
;

175 
	mz⁄eNumbî
;

176 
UdsCookõ
 
	mcookõ
;

177 *
	md©a
;

178 
size_t
 
	md©aLígth
;

179 
IndexRegi⁄
 
	mloˇti⁄
;

181 
boﬁ
 
	m¶Loˇti⁄Known
;

182 
IndexRegi⁄
 
	m¶Loˇti⁄
;

184 
Synchr⁄ousCÆlback
 *
	msynchr⁄ous
;

185 
AbsTime
 
	möôTime
;

188 (*
	tReque°Re°¨ãr
)(
	tReque°
 *);

199 
	$¸óãReque°
(
c⁄ãxtId
,

200 
C⁄ãxtTy≥
 
c⁄ãxtTy≥
,

201 
Reque°
 **
ªque°På
)

202 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

222 
	$œunchClõ¡Reque°
(
c⁄ãxtId
,

223 
C⁄ãxtTy≥
 
c⁄ãxtTy≥
,

224 
UdsCÆlbackTy≥
 
ˇŒbackTy≥
,

225 
boﬁ
 
upd©e
,

226 c⁄° 
UdsChunkName
 *
chunkName
,

227 
UdsCookõ
 
cookõ
,

228 *
mëad©a
,

229 
size_t
 
d©aLígth
,

230 c⁄° *
d©a
)

231 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

241 
	$œunchAŒoˇãdClõ¡Reque°
(
Reque°
 *
ªque°
)

242 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

262 
	$œunchAIPC⁄åﬁMesßge
(
AIPC⁄ãxt
 *
£rvîC⁄ãxt
,

263 *
c⁄åﬁD©a
,

264 
Reque°A˘i⁄
 
c⁄åﬁA˘i⁄
,

265 
Reque°Sège
 
öôülSège
,

266 
IndexRouãr
 *
rouãr
,

267 
Reque°
 **
ªque°På
)

268 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

287 
	$œunchClõ¡C⁄åﬁMesßge
(
UdsC⁄ãxt
 *
c⁄ãxt
,

288 *
c⁄åﬁD©a
,

289 
Reque°A˘i⁄
 
c⁄åﬁA˘i⁄
,

290 
Reque°Sège
 
öôülSège
,

291 
Reque°
 **
ªque°På
)

292 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

305 
	$œunchZ⁄eC⁄åﬁMesßge
(
Reque°A˘i⁄
 
a˘i⁄
,

306 
Z⁄eMesßge
 
mesßge
,

307 
z⁄e
,

308 
IndexRouãr
 *
rouãr
)

309 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

316 
	`‰ìReque°
(
Reque°
 *
ªque°
);

325 
	`£tReque°Hash
(
Reque°
 *
ªque°
, c⁄° 
UdsChunkName
 *
«me
);

335 
	`íqueueReque°
(
Reque°
 *
ªque°
, 
Reque°Sège
 
√xtSège
);

342 
	`ª°¨tReque°
(
Reque°
 *
ªque°
);

351 
	`£tReque°Re°¨ãr
(
Reque°Re°¨ãr
 
ª°¨ãr
);

361 
	`íãrCÆlbackSège
(
Reque°
 *
ªque°
);

369 
	`upd©eReque°C⁄ãxtSèts
(
Reque°
 *
ªque°
);

379 
INLINE
 
CacheProbeTy≥
 
	$ˇcheProbeTy≥
(
Reque°
 *
ªque°
,

380 
boﬁ
 
isIndexPage
)

382 i‡((
ªque°
 !
NULL
Ë&&Ñeque°->
ªqueued
) {

383  
isIndexPage
 ? 
CACHE_PROBE_INDEX_RETRY
 : 
CACHE_PROBE_RECORD_RETRY
;

385  
isIndexPage
 ? 
CACHE_PROBE_INDEX_FIRST
 : 
CACHE_PROBE_RECORD_FIRST
;

387 
	}
}

	@uds/requestLimit.c

22 
	~"ªque°Limô.h
"

24 
	~"compûî.h
"

25 
	~"˝u.h
"

26 
	~"mem‹yAŒoc.h
"

27 
	~"thªads.h
"

28 
	~"uds.h
"

29 
	~"utû/©omic.h
"

77 
	sªque°Limô
 {

81 
Atomic32
 
	mªadyPûe
;

86 
Atomic32
 
ªtu∫edPûe
 
__©åibuã__
((
Æig√d
(
CACHE_LINE_BYTES
)));

89 
Atomic32
 
	mswìpThªshﬁd
;

94 
Muãx
 
swìpLock
 
__©åibuã__
((
Æig√d
(
CACHE_LINE_BYTES
)));

97 
C⁄dV¨
 
	mswìpC⁄dôi⁄
;

102 
uöt32_t
 
tŸÆPîmôs
 
__©åibuã__
((
Æig√d
(
CACHE_LINE_BYTES
)));

105 
Muãx
 
	mtŸÆPîmôsLock
;

113 
	mSWEEP_THRESHOLD_DIVISOR
 = 4,

115 
	mMAXIMUM_SWEEP_THRESHOLD
 = 32

125 
	$£tSwìpThªshﬁd
(
Reque°Limô
 *
limô
, 
uöt32_t
 
≥rmôs
)

127 
uöt32_t
 
thªshﬁd
 = (
≥rmôs
 / 
SWEEP_THRESHOLD_DIVISOR
);

128 i‡(
thªshﬁd
 < 1) {

129 
thªshﬁd
 = 1;

130 } i‡(
thªshﬁd
 > 
MAXIMUM_SWEEP_THRESHOLD
) {

131 
thªshﬁd
 = 
MAXIMUM_SWEEP_THRESHOLD
;

136 
	`©omicSt‹e32
(&
limô
->
swìpThªshﬁd
, 
thªshﬁd
);

140 
	`brﬂdˇ°C⁄d
(&
limô
->
swìpC⁄dôi⁄
);

141 
	}
}

144 
	$makeReque°Limô
(
uöt32_t
 
≥rmôs
, 
Reque°Limô
 **
limôPå
)

148 
Reque°Limô
 *
limô
;

149 
ªsu…
 = 
	`ALLOCATE
(1, 
Reque°Limô
, "ªque°Limô", &
limô
);

150 i‡(
ªsu…
 !
UDS_SUCCESS
) {

151  
ªsu…
;

154 
limô
->
tŸÆPîmôs
 = 
≥rmôs
;

157 
	`ªœxedSt‹e32
(&
limô
->
ªadyPûe
, 
≥rmôs
);

158 
	`ªœxedSt‹e32
(&
limô
->
ªtu∫edPûe
, 0);

160 
	`öôMuãx
(&
limô
->
tŸÆPîmôsLock
);

161 
	`öôMuãx
(&
limô
->
swìpLock
);

162 
	`öôC⁄d
(&
limô
->
swìpC⁄dôi⁄
);

165 
	`£tSwìpThªshﬁd
(
limô
, 
≥rmôs
);

167 *
limôPå
 = 
limô
;

168  
UDS_SUCCESS
;

169 
	}
}

172 
	$‰ìReque°Limô
(
Reque°Limô
 *
limô
)

174 i‡(
limô
 =
NULL
) {

179 
	`£tReque°PîmôLimô
(
limô
, 0);

181 
	`de°royMuãx
(&
limô
->
tŸÆPîmôsLock
);

182 
	`de°royMuãx
(&
limô
->
swìpLock
);

183 
	`de°royC⁄d
(&
limô
->
swìpC⁄dôi⁄
);

184 
	`FREE
(
limô
);

185 
	}
}

188 
uöt32_t
 
	$gëReque°PîmôLimô
(
Reque°Limô
 *
limô
)

192  
limô
->
tŸÆPîmôs
;

193 
	}
}

196 
	$£tReque°PîmôLimô
(
Reque°Limô
 *
limô
, 
uöt32_t
 
≥rmôs
)

204 
	`lockMuãx
(&
limô
->
tŸÆPîmôsLock
);

208 
	`£tSwìpThªshﬁd
(
limô
, 
≥rmôs
);

212 i‡(
limô
->
tŸÆPîmôs
 < 
≥rmôs
) {

213 
	`ªtu∫Reque°Pîmôs
(
limô
, 
≥rmôs
 -Üimô->
tŸÆPîmôs
);

214 
limô
->
tŸÆPîmôs
 = 
≥rmôs
;

219 
limô
->
tŸÆPîmôs
 > 
≥rmôs
) {

220 
	`b‹rowReque°Pîmô
(
limô
);

221 
limô
->
tŸÆPîmôs
 -= 1;

224 
	`u∆ockMuãx
(&
limô
->
tŸÆPîmôsLock
);

225 
	}
}

236 
boﬁ
 
	$b‹rowFromRódyPûe
(
Reque°Limô
 *
limô
)

241 
uöt32_t
 
ªady
 = 
	`ªœxedLﬂd32
(&
limô
->
ªadyPûe
);

242 i‡(
ªady
 == 0) {

244  
Ál£
;

246 i‡(
	`com∑ªAndSw≠32
(&
limô
->
ªadyPûe
, 
ªady
,Ñeady - 1)) {

248  
åue
;

252 
	}
}

264 
boﬁ
 
	$swìpPîmôs
(
Reque°Limô
 *
limô
)

266 
öt32_t
 
ªtu∫ed
 = 
	`ªœxedLﬂd32
(&
limô
->
ªtu∫edPûe
);

267 i‡(
ªtu∫ed
 == 0) {

269  
Ál£
;

281 
	`©omicAdd32
(&
limô
->
ªtu∫edPûe
, -
ªtu∫ed
);

282 i‡(
ªtu∫ed
 > 1) {

284 
	`©omicAdd32
(&
limô
->
ªadyPûe
, 
ªtu∫ed
 - 1);

286  
åue
;

287 
	}
}

290 
	$b‹rowReque°Pîmô
(
Reque°Limô
 *
limô
)

293 i‡(
	`b‹rowFromRódyPûe
(
limô
)) {

299 
	`lockMuãx
(&
limô
->
swìpLock
);

303 !
	`b‹rowFromRódyPûe
(
limô
Ë&& !
	`swìpPîmôs
(limit)) {

304 
	`waôC⁄d
(&
limô
->
swìpC⁄dôi⁄
, &limô->
swìpLock
);

306 
	`u∆ockMuãx
(&
limô
->
swìpLock
);

307 
	}
}

310 
	$ªtu∫Reque°Pîmôs
(
Reque°Limô
 *
limô
, 
uöt32_t
 
≥rmôs
)

314 
uöt32_t
 
√wPûe
 = 
	`©omicAdd32
(&
limô
->
ªtu∫edPûe
, 
≥rmôs
);

318 
uöt32_t
 
thªshﬁd
 = 
	`ªœxedLﬂd32
(&
limô
->
swìpThªshﬁd
);

319 i‡(
	`u∆ikñy
(
√wPûe
 >
thªshﬁd
Ë&& (“ewPûê- 
≥rmôs
) <Åhreshold)) {

320 
	`lockMuãx
(&
limô
->
swìpLock
);

327 
	`brﬂdˇ°C⁄d
(&
limô
->
swìpC⁄dôi⁄
);

328 
	`u∆ockMuãx
(&
limô
->
swìpLock
);

330 
	}
}

	@uds/requestLimit.h

22 #i‚de‡
REQUEST_LIMIT_H


23 
	#REQUEST_LIMIT_H


	)

25 
	~"›aqueTy≥s.h
"

26 
	~"ty≥Defs.h
"

66 
	$makeReque°Limô
(
uöt32_t
 
≥rmôs
, 
Reque°Limô
 **
limôPå
)

67 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

75 
	`‰ìReque°Limô
(
Reque°Limô
 *
limô
);

84 
uöt32_t
 
	`gëReque°PîmôLimô
(
Reque°Limô
 *
limô
);

96 
	`£tReque°PîmôLimô
(
Reque°Limô
 *
limô
, 
uöt32_t
 
≥rmôs
);

110 
	`b‹rowReque°Pîmô
(
Reque°Limô
 *
limô
);

126 
	`ªtu∫Reque°Pîmôs
(
Reque°Limô
 *
limô
, 
uöt32_t
 
≥rmôs
);

	@uds/requestQueue.c

22 
	~"ªque°Queue.h
"

24 
	~"loggî.h
"

25 
	~"≥rmas£π.h
"

26 
	~"ªque°.h
"

27 
	~"mem‹yAŒoc.h
"

28 
	~"thªads.h
"

29 
	~"timeUtûs.h
"

30 
	~"utû/©omic.h
"

31 
	~"utû/evítCou¡.h
"

32 
	~"utû/fu¬ñQueue.h
"

33 
	~"utû/°©i°ic.h
"

62 
	mONE_NANOSECOND
 = 1,

63 
	mONE_MICROSECOND
 = 1000 * 
ONE_NANOSECOND
,

64 
	mONE_MILLISECOND
 = 1000 * 
ONE_MICROSECOND
,

65 
	mONE_SECOND
 = 1000 * 
ONE_MILLISECOND
,

68 
	mDEFAULT_WAIT_TIME
 = 10 * 
ONE_MICROSECOND
,

71 
	mMINIMUM_WAIT_TIME
 = 
DEFAULT_WAIT_TIME
 / 2,

74 
	mMAXIMUM_WAIT_TIME
 = 
ONE_MILLISECOND


82 
	mMINIMUM_BATCH
 = 32,

83 
	mMAXIMUM_BATCH
 = 64

86 
	sªque°Queue
 {

87 c⁄° *
	m«me
;

88 
Reque°QueuePro˚ss‹
 *
	m¥o˚ssO√
;

90 
Fu¬ñQueue
 *
	mmaöQueue
;

91 
Fu¬ñQueue
 *
	mªåyQueue
;

92 
EvítCou¡
 *
	mw‹kEvít
;

94 
Thªad
 
	mthªad
;

95 
boﬁ
 
	m°¨ãd
;

97 vﬁ©ûê
boﬁ
 
	mÆive
;

100 
Atomic32
 
	md‹m™t
;

106 
uöt64_t
 
cuºítB©ch
 
__©åibuã__
((
Æig√d
(
CACHE_LINE_BYTES
)));

109 
uöt64_t
 
	mwaôN™o£c⁄ds
;

112 
RñTime
 
	mwakeRñTime
;

115 
Sèti°ic
 
	mb©chLígths
;

118 
Sèti°ic
 
	mwaôTimes
;

126 
	$ªque°QueueLogSèti°ics
(c⁄° 
Reque°Queue
 *
queue
)

128 *
b©chSåög
;

129 
ªsu…
 = 
	`f‹m©Sèti°ic
(&
queue
->
b©chLígths
, &
b©chSåög
);

130 i‡(
ªsu…
 !
UDS_SUCCESS
) {

131 
	`logEº‹WôhSåögEº‹
(
ªsu…
, "FailedÅo format batch stats");

134 
	`logInfo
("queuê'%s' b©chÜígths: %s", 
queue
->
«me
, 
b©chSåög
);

135 
	`FREE
(
b©chSåög
);

137 *
waôSåög
;

138 
ªsu…
 = 
	`f‹m©Sèti°ic
(&
queue
->
waôTimes
, &
waôSåög
);

139 i‡(
ªsu…
 !
UDS_SUCCESS
) {

140 
	`logEº‹WôhSåögEº‹
(
ªsu…
, "FailedÅo format wait stats");

143 
	`logInfo
("queuê'%s' waô mi¸o£c⁄ds: %s", 
queue
->
«me
, 
waôSåög
);

144 
	`FREE
(
waôSåög
);

145 
	}
}

153 
	$adju°WaôTime
(
Reque°Queue
 *
queue
)

156 
uöt64_t
 
dñè
 = 
queue
->
waôN™o£c⁄ds
 / 4;

158 i‡(
queue
->
cuºítB©ch
 < 
MINIMUM_BATCH
) {

160 
queue
->
waôN™o£c⁄ds
 +
dñè
;

161 } i‡(
queue
->
cuºítB©ch
 > 
MAXIMUM_BATCH
) {

163 
queue
->
waôN™o£c⁄ds
 -
dñè
;

166 
	`ßm∂eSèti°ic
(&
queue
->
b©chLígths
, queue->
cuºítB©ch
);

167 
	}
}

179 
RñTime
 *
	$gëWakeTime
(
Reque°Queue
 *
queue
)

181 i‡(
queue
->
waôN™o£c⁄ds
 >
MAXIMUM_WAIT_TIME
) {

182 i‡(
	`ªœxedLﬂd32
(&
queue
->
d‹m™t
)) {

185 
queue
->
waôN™o£c⁄ds
 = 
DEFAULT_WAIT_TIME
;

186  
NULL
;

190 
queue
->
waôN™o£c⁄ds
 = 
MAXIMUM_WAIT_TIME
;

191 
	`©omicSt‹e32
(&
queue
->
d‹m™t
, 
åue
);

192 } i‡(
queue
->
waôN™o£c⁄ds
 < 
MINIMUM_WAIT_TIME
) {

195 
queue
->
waôN™o£c⁄ds
 = 
MINIMUM_WAIT_TIME
;

198 
	`ßm∂eSèti°ic
(&
queue
->
waôTimes
, queue->
waôN™o£c⁄ds
 / 1000);

200 
RñTime
 *
wake
 = &
queue
->
wakeRñTime
;

201 *
wake
 = 
	`«no£c⁄dsToRñTime
(
queue
->
waôN™o£c⁄ds
);

202  
wake
;

203 
	}
}

206 
Reque°
 *
	$ªmoveHód
(
Fu¬ñQueue
 *
queue
)

208 
Fu¬ñQueueE¡ry
 *
íåy
 = 
	`fu¬ñQueuePﬁl
(
queue
);

209 i‡(
íåy
 =
NULL
) {

210  
NULL
;

212  
	`c⁄èöî_of
(
íåy
, 
Reque°
, 
ªque°QueueLök
);

213 
	}
}

223 
Reque°
 *
	$pﬁlQueues
(
Reque°Queue
 *
queue
)

225 
Reque°
 *
ªque°
 = 
	`ªmoveHód
(
queue
->
ªåyQueue
);

226 i‡(
ªque°
 =
NULL
) {

227 
ªque°
 = 
	`ªmoveHód
(
queue
->
maöQueue
);

229  
ªque°
;

230 
	}
}

241 
Reque°
 *
	$dequeueReque°
(
Reque°Queue
 *
queue
)

245 
queue
->
cuºítB©ch
 += 1;

248 
Reque°
 *
ªque°
 = 
	`pﬁlQueues
(
queue
);

249 i‡(
ªque°
 !
NULL
) {

250  
ªque°
;

255 
EvítTokí
 
waôTokí
 = 
	`evítCou¡Pª∑ª
(
queue
->
w‹kEvít
);

259 
ªque°
 = 
	`pﬁlQueues
(
queue
);

260 i‡(
ªque°
 !
NULL
) {

261 
	`evítCou¡C™˚l
(
queue
->
w‹kEvít
, 
waôTokí
);

262  
ªque°
;

267 i‡(!
queue
->
Æive
) {

268 
	`evítCou¡C™˚l
(
queue
->
w‹kEvít
, 
waôTokí
);

269  
NULL
;

274 
	`adju°WaôTime
(
queue
);

278 
RñTime
 *
wakeTime
 = 
	`gëWakeTime
(
queue
);

279 
	`evítCou¡Waô
(
queue
->
w‹kEvít
, 
waôTokí
, 
wakeTime
);

281 i‡(
wakeTime
 =
NULL
) {

284 
	`ªœxedSt‹e32
(&
queue
->
d‹m™t
, 
Ál£
);

287 
queue
->
waôN™o£c⁄ds
 = 
DEFAULT_WAIT_TIME
;

291 
queue
->
cuºítB©ch
 = 0;

293 
	}
}

296 
	$ªque°QueueW‹kî
(*
¨g
)

298 
Reque°Queue
 *
queue
 = (Reque°Queuê*Ë
¨g
;

299 
	`logDebug
("%†queuê°¨tög", 
queue
->
«me
);

300 
Reque°
 *
ªque°
;

301 (
ªque°
 = 
	`dequeueReque°
(
queue
)Ë!
NULL
) {

302 
queue
->
	`¥o˚ssO√
(
ªque°
);

304 
	`logDebug
("%†queuêd⁄e", 
queue
->
«me
);

305 
	}
}

308 
	$öôülizeQueue
(
Reque°Queue
 *
queue
,

309 c⁄° *
queueName
,

310 
Reque°QueuePro˚ss‹
 *
¥o˚ssO√
)

312 
queue
->
«me
 = 
queueName
;

313 
queue
->
¥o˚ssO√
 =ÖrocessOne;

314 
queue
->
Æive
 = 
åue
;

315 
queue
->
cuºítB©ch
 = 0;

316 
queue
->
waôN™o£c⁄ds
 = 
DEFAULT_WAIT_TIME
;

318 
	`ª£tSèti°ic
(&
queue
->
b©chLígths
);

319 
	`ª£tSèti°ic
(&
queue
->
waôTimes
);

321 
ªsu…
 = 
	`makeFu¬ñQueue
(&
queue
->
maöQueue
);

322 i‡(
ªsu…
 !
UDS_SUCCESS
) {

323  
ªsu…
;

326 
ªsu…
 = 
	`makeFu¬ñQueue
(&
queue
->
ªåyQueue
);

327 i‡(
ªsu…
 !
UDS_SUCCESS
) {

328  
ªsu…
;

331 
ªsu…
 = 
	`makeEvítCou¡
(&
queue
->
w‹kEvít
);

332 i‡(
ªsu…
 !
UDS_SUCCESS
) {

333  
ªsu…
;

336 
ªsu…
 = 
	`¸óãThªad
(
ªque°QueueW‹kî
, 
queue
, 
queueName
, 0,

337 &
queue
->
thªad
);

338 i‡(
ªsu…
 !
UDS_SUCCESS
) {

339  
ªsu…
;

342 
queue
->
°¨ãd
 = 
åue
;

343  
UDS_SUCCESS
;

344 
	}
}

347 
	$makeReque°Queue
(c⁄° *
queueName
,

348 
Reque°QueuePro˚ss‹
 *
¥o˚ssO√
,

349 
Reque°Queue
 **
queuePå
)

351 
Reque°Queue
 *
queue
;

352 
ªsu…
 = 
	`ALLOCATE
(1, 
ªque°Queue
, "ªque° queue", &
queue
);

353 i‡(
ªsu…
 !
UDS_SUCCESS
) {

354  
ªsu…
;

357 
ªsu…
 = 
	`öôülizeQueue
(
queue
, 
queueName
, 
¥o˚ssO√
);

358 i‡(
ªsu…
 !
UDS_SUCCESS
) {

359 
	`ªque°QueueFöish
(
queue
);

360  
ªsu…
;

363 *
queuePå
 = 
queue
;

364  
UDS_SUCCESS
;

365 
	}
}

368 
	$ªque°QueueEnqueue
(
Reque°Queue
 *
queue
, 
Reque°
 *
ªque°
)

370 
boﬁ
 
unb©ched
 = 
ªque°
->unbatched;

371 
	`fu¬ñQueuePut
(
ªque°
->
ªqueued
 ? 
queue
->
ªåyQueue
 : queue->
maöQueue
,

372 &
ªque°
->
ªque°QueueLök
);

379 i‡(
	`ªœxedLﬂd32
(&
queue
->
d‹m™t
Ë|| 
unb©ched
) {

380 
	`evítCou¡Brﬂdˇ°
(
queue
->
w‹kEvít
);

382 
	}
}

385 
	$ªque°QueueFöish
(
Reque°Queue
 *
queue
)

387 i‡(
queue
 =
NULL
) {

392 
queue
->
Æive
 = 
Ál£
;

394 i‡(
queue
->
°¨ãd
) {

396 
	`evítCou¡Brﬂdˇ°
(
queue
->
w‹kEvít
);

400 
ªsu…
 = 
	`joöThªads
(
queue
->
thªad
);

401 i‡(
ªsu…
 != 0) {

402 
	`logEº‹WôhSåögEº‹
(
ªsu…
, "FailedÅo join workerÅhread");

406 
	`ªque°QueueLogSèti°ics
(
queue
);

408 
	`‰ìEvítCou¡
(
queue
->
w‹kEvít
);

409 
	`‰ìFu¬ñQueue
(
queue
->
maöQueue
);

410 
	`‰ìFu¬ñQueue
(
queue
->
ªåyQueue
);

411 
	`FREE
(
queue
);

412 
	}
}

	@uds/requestQueue.h

22 #i‚de‡
REQUEST_QUEUE_H


23 
	#REQUEST_QUEUE_H


	)

25 
	~"›aqueTy≥s.h
"

26 
	~"ty≥Defs.h
"

29 
	tReque°QueuePro˚ss‹
(
	tReque°
 *);

41 
	$makeReque°Queue
(c⁄° *
queueName
,

42 
Reque°QueuePro˚ss‹
 *
¥o˚ssO√
,

43 
Reque°Queue
 **
queuePå
)

44 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

54 
	`ªque°QueueEnqueue
(
Reque°Queue
 *
queue
, 
Reque°
 *
ªque°
);

61 
	`ªque°QueueFöish
(
Reque°Queue
 *
queue
);

	@uds/resourceDefs.h

22 #i‚de‡
LINUX_KERNEL_RESOURCE_DEFS_H


23 
	#LINUX_KERNEL_RESOURCE_DEFS_H
 1

	)

25 
	~"compûî.h
"

26 
	~"îr‹s.h
"

27 
	~"timeUtûs.h
"

29 
	tResour˚Ußge
;

30 
thªadSèti°ics
 
	tThªadSèti°ics
;

37 
‰ìThªadSèti°ics
(
ThªadSèti°ics
 *
ts
);

46 
INLINE
 
gëResour˚Ußge
(
Resour˚Ußge
 *
ru
 
__©åibuã__
((
unu£d
)))

48  
	gUDS_SUCCESS
;

56 
ThªadSèti°ics
 *
gëThªadSèti°ics
();

78 
INLINE
 
¥ötResour˚Ußge
(
Resour˚Ußge
 *
¥ev


79 
__©åibuã__
((
unu£d
)),

80 
Resour˚Ußge
 *
cur


81 
__©åibuã__
((
unu£d
)),

82 
RñTime
 
ñ≠£d
 
__©åibuã__
((
unu£d
)))

103 
¥ötThªadSèti°ics
(
ThªadSèti°ics
 *
¥ev
, ThªadSèti°ic†*
cur
);

108 
INLINE
 
	$¥ötVmStuff
()

110 
	}
}

	@uds/resourceUsageLinuxKernel.c

22 
	~<löux/sched.h
>

23 
	~<löux/vîsi⁄.h
>

25 #i‡
LINUX_VERSION_CODE
 >
KERNEL_VERSION
(4,11,0)

26 
	~<löux/sched/sig«l.h
>

29 
	~<löux/èsk_io_accou¡ög_›s.h
>

31 
	~"loggî.h
"

32 
	~"mem‹yAŒoc.h
"

33 
	~"ªsour˚Defs.h
"

34 
	~"thªads.h
"

40 
	sthªadSèti°ics
 {

41 
	mcomm
[
TASK_COMM_LEN
];

42 
	m˝utime
;

43 
	möblock
;

44 
	moutblock
;

45 
pid_t
 
	mid
;

46 
ThªadSèti°ics
 *
	m√xt
;

50 
	$addThªadSèti°ics
(
ThªadSèti°ics
 **
tsLi°
,

51 c⁄° 
ThªadSèti°ics
 *
tsNew
)

54 
ThªadSèti°ics
 *
ts
;

55 i‡(
	`ALLOCATE
(1, 
ThªadSèti°ics
, 
__func__
, &
ts
Ë=
UDS_SUCCESS
) {

56 *
ts
 = *
tsNew
;

58 (*
tsLi°
 !
NULL
Ë&& (
ts
->
id
 > (*tsList)->id)) {

59 
tsLi°
 = &(*tsLi°)->
√xt
;

61 
ts
->
√xt
 = *
tsLi°
;

62 *
tsLi°
 = 
ts
;

64 
	}
}

67 
	$addO√Thªad
(*
¨g
, 
èsk_°ru˘
 *
èsk
)

69 
ThªadSèti°ics
 
ts
;

70 
	`°∫˝y
(
ts
.
comm
, 
èsk
->comm, 
TASK_COMM_LEN
);

71 
ts
.
˝utime
 = 
èsk
->
£
.
sum_exec_ru¡ime
;

72 
ts
.
id
 = 
èsk
->
pid
;

73 
ts
.
öblock
 = 
	`èsk_io_gë_öblock
(
èsk
Ë+Åask->
sig«l
->inblock;

74 
ts
.
outblock
 = 
	`èsk_io_gë_oublock
(
èsk
Ë+Åask->
sig«l
->
oublock
;

75 
	`addThªadSèti°ics
(
¨g
, &
ts
);

76 
	}
}

79 
	$‰ìThªadSèti°ics
(
ThªadSèti°ics
 *
ts
)

81 
ts
 !
NULL
) {

82 
ThªadSèti°ics
 *
tsNext
 = 
ts
->
√xt
;

83 
	`FREE
(
ts
);

84 
ts
 = 
tsNext
;

86 
	}
}

89 
ThªadSèti°ics
 *
	$gëThªadSèti°ics
()

91 
ThªadSèti°ics
 *
tsLi°
 = 
NULL
;

92 
	`≠∂yToThªads
(
addO√Thªad
, &
tsLi°
);

93  
tsLi°
;

94 
	}
}

97 
	$¥ötThªadSèti°ics
(
ThªadSèti°ics
 *
¥ev
, ThªadSèti°ic†*
cur
)

99 c⁄° 
MILLION
 = 1000 * 1000;

100 c⁄° 
BILLION
 = 1000 * 1000 * 1000;

101 
	`logInfo
("Thread CPUTime Inblock Outblock Note");

102 
	`logInfo
("================ ========== ======= ======== ====");

103 (
¥ev
 !
NULL
Ë&& (
cur
 != NULL)) {

104 i‡((
cur
 =
NULL
Ë|| (
¥ev
->
id
 < cur->id)) {

105 
	`logInfo
(" %-45†g⁄e", 
¥ev
->
comm
);

106 
¥ev
 =Öªv->
√xt
;

107 } i‡((
¥ev
 =
NULL
Ë|| (¥ev->
id
 > 
cur
->id)) {

108 
	`logInfo
("%-16.16†%3lu.%06lu %7lu %8luÇew", 
cur
->
comm
,

109 
cur
->
˝utime
 / 
BILLION
, cur->˝utimê/ 1000 % 
MILLION
,

110 
cur
->
öblock
, cur->
outblock
);

111 
cur
 = cur->
√xt
;

113 
	`logInfo
("%-16.16†%3lu.%06lu %7lu %8lu", 
cur
->
comm
,

114 (
cur
->
˝utime
 - 
¥ev
->˝utimeË/ 
BILLION
,

115 (
cur
->
˝utime
 - 
¥ev
->˝utimeË/ 1000 % 
MILLION
,

116 
cur
->
öblock
 - 
¥ev
->öblock, cur->
outblock
 -Örev->outblock);

117 
¥ev
 =Öªv->
√xt
;

118 
cur
 = cur->
√xt
;

121 
	}
}

	@uds/searchList.c

22 
	~"£¨chLi°.h
"

24 
	~"îr‹s.h
"

25 
	~"loggî.h
"

26 
	~"mem‹yAŒoc.h
"

29 
	$makeSórchLi°
(
ˇ∑côy
,

30 
SórchLi°
 **
li°På
)

32 i‡(
ˇ∑côy
 == 0) {

33  
	`logEº‹WôhSåögEº‹
(
UDS_INVALID_ARGUMENT
,

36 i‡(
ˇ∑côy
 > 
UINT8_MAX
) {

37  
	`logEº‹WôhSåögEº‹
(
UDS_INVALID_ARGUMENT
,

41 
byãs
 = ((
SórchLi°
Ë+ (
ˇ∑côy
 * (
uöt8_t
)));

42 
SórchLi°
 *
li°
;

43 
ªsu…
 = 
	`ÆloˇãCacheAlig√d
(
byãs
, "£¨chÜi°", &
li°
);

44 i‡(
ªsu…
 !
UDS_SUCCESS
) {

45  
ªsu…
;

48 
li°
->
ˇ∑côy
 = capacity;

49 
li°
->
fú°DódE¡ry
 = 0;

53 
uöt8_t
 
i
 = 0; i < 
ˇ∑côy
; i++) {

54 
li°
->
íåõs
[
i
] = i;

57 *
li°På
 = 
li°
;

58  
UDS_SUCCESS
;

59 
	}
}

62 
	$‰ìSórchLi°
(
SórchLi°
 **
li°På
)

64 
	`FREE
(*
li°På
);

65 *
li°På
 = 
NULL
;

66 
	}
}

69 
	$purgeSórchLi°
(
SórchLi°
 *
£¨chLi°
,

70 c⁄° 
CachedCh≠ãrIndex
 
ch≠ãrs
[])

72 i‡(
£¨chLi°
->
fú°DódE¡ry
 == 0) {

79 
uöt8_t
 
Æive
[
£¨chLi°
->
fú°DódE¡ry
];

80 
uöt8_t
 
skù≥d
[
£¨chLi°
->
fú°DódE¡ry
];

81 
uöt8_t
 
dód
[
£¨chLi°
->
fú°DódE¡ry
];

82 
√xtAlive
 = 0;

83 
√xtSkù≥d
 = 0;

84 
√xtDód
 = 0;

86 
i
 = 0; i < 
£¨chLi°
->
fú°DódE¡ry
; i++) {

87 
uöt8_t
 
íåy
 = 
£¨chLi°
->
íåõs
[
i
];

88 c⁄° 
CachedCh≠ãrIndex
 *
ch≠ãr
 = &
ch≠ãrs
[
íåy
];

89 i‡(
ch≠ãr
->
övÆid
 || (ch≠ãr->
vútuÆCh≠ãr
 =
UINT64_MAX
)) {

90 
dód
[
√xtDód
++] = 
íåy
;

91 } i‡(
ch≠ãr
->
skùSórch
) {

92 
skù≥d
[
√xtSkù≥d
++] = 
íåy
;

94 
Æive
[
√xtAlive
++] = 
íåy
;

100 
size
 = 0;

101 
	`mem˝y
(&
£¨chLi°
->
íåõs
[
size
], 
Æive
, 
√xtAlive
);

102 
size
 +
√xtAlive
;

104 
	`mem˝y
(&
£¨chLi°
->
íåõs
[
size
], 
skù≥d
, 
√xtSkù≥d
);

105 
size
 +
√xtSkù≥d
;

107 
	`mem˝y
(&
£¨chLi°
->
íåõs
[
size
], 
dód
, 
√xtDód
);

109 
£¨chLi°
->
fú°DódE¡ry
 = 
size
;

110 
	}
}

	@uds/searchList.h

22 #i‚de‡
SEARCH_LIST_H


23 
	#SEARCH_LIST_H


	)

25 
	~"ˇchedCh≠ãrIndex.h
"

26 
	~"compûî.h
"

27 
	~"°rögUtûs.h
"

28 
	~"ty≥Defs.h
"

47 
	s£¨chLi°
 {

49 
uöt8_t
 
	mˇ∑côy
;

52 
uöt8_t
 
	mfú°DódE¡ry
;

55 
uöt8_t
 
	míåõs
[];

56 } 
	tSórchLi°
;

65 
SórchLi°
 *
	mli°
;

68 
	m√xtE¡ry
;

71 
CachedCh≠ãrIndex
 *
	mch≠ãrs
;

72 } 
	tSórchLi°Iãøt‹
;

84 
	$makeSórchLi°
(
ˇ∑côy
,

85 
SórchLi°
 **
li°På
)

86 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

93 
	`‰ìSórchLi°
(
SórchLi°
 **
li°På
);

101 
INLINE
 
	$c›ySórchLi°
(c⁄° 
SórchLi°
 *
sour˚
,

102 
SórchLi°
 *
èrgë
)

104 *
èrgë
 = *
sour˚
;

105 
	`mem˝y
(
èrgë
->
íåõs
, 
sour˚
->íåõs, sour˚->
ˇ∑côy
);

106 
	}
}

116 
INLINE
 
SórchLi°Iãøt‹


117 
	$ôî©eSórchLi°
(
SórchLi°
 *
li°
, 
CachedCh≠ãrIndex
 
ch≠ãrs
[])

119 
SórchLi°Iãøt‹
 
ôî©‹
 = {

120 .
li°
 =Üist,

121 .
√xtE¡ry
 = 0,

122 .
ch≠ãrs
 = chapters,

124  
ôî©‹
;

125 
	}
}

134 
INLINE
 
boﬁ
 
	$hasNextCh≠ãr
(c⁄° 
SórchLi°Iãøt‹
 *
ôî©‹
)

136  (
ôî©‹
->
√xtE¡ry
 < iãøt‹->
li°
->
fú°DódE¡ry
);

137 
	}
}

148 
INLINE
 
CachedCh≠ãrIndex
 *
	$gëNextCh≠ãr
(
SórchLi°Iãøt‹
 *
ôî©‹
)

150  &
ôî©‹
->
ch≠ãrs
[ôî©‹->
li°
->
íåõs
[ôî©‹->
√xtE¡ry
++]];

151 
	}
}

170 
INLINE
 
uöt8_t
 
	$rŸ©eSórchLi°
(
SórchLi°
 *
£¨chLi°
,

171 
uöt8_t
 
¥efixLígth
)

174 
uöt8_t
 
mo°Re˚¡
 = 
£¨chLi°
->
íåõs
[
¥efixLígth
 - 1];

176 i‡(
¥efixLígth
 > 1) {

179 
	`memmove
(&
£¨chLi°
->
íåõs
[1],

180 &
£¨chLi°
->
íåõs
[0],

181 
¥efixLígth
 - 1);

185 
£¨chLi°
->
íåõs
[0] = 
mo°Re˚¡
;

190 i‡(
£¨chLi°
->
fú°DódE¡ry
 < 
¥efixLígth
) {

191 
£¨chLi°
->
fú°DódE¡ry
 += 1;

194  
mo°Re˚¡
;

195 
	}
}

211 
purgeSórchLi°
(
SórchLi°
 *
£¨chLi°
,

212 c⁄° 
CachedCh≠ãrIndex
 
ch≠ãrs
[]);

	@uds/session.c

22 
	~"£ssi⁄.h
"

24 
	~"comm⁄.h
"

25 
	~"mem‹yAŒoc.h
"

26 
	~"thªads.h
"

27 
	~"ty≥Defs.h
"

30 
	mGROUP_READY
 = 1,

31 
	mGROUP_SHUTDOWN
 = 2

32 } 
	tSessi⁄GroupSèã
;

34 c⁄° 
	gSESSION_ID_MAX
 = 
UINT_MAX
;

36 
LIST__HEAD
(
£ssi⁄Li°Hód
, 
£ssi⁄
);

37 
£ssi⁄Li°Hód
 
	tSessi⁄Li°Hód
;

39 
	s£ssi⁄Group
 {

40 
Muãx
 
	mmuãx
;

41 
C⁄dV¨
 
	mªÀa£C⁄d
;

42 
	mªfCou¡
;

43 
Sessi⁄GroupSèã
 
	m°©e
;

44 
Sessi⁄Li°Hód
 
	mhód
;

45 
Sessi⁄ID
 
	m√xtSessi⁄ID
;

46 
Sessi⁄Fªe
 
	m‰ì
;

47 
	mnŸFoundResu…
;

51 
	$checkSessi⁄GroupLocked
(
Sessi⁄Group
 *
group
)

53 
group
->
°©e
) {

54 
GROUP_SHUTDOWN
:

55  
UDS_SHUTTINGDOWN
;

57  
UDS_SUCCESS
;

59 
	}
}

62 
	$acquúeSessi⁄
(
Sessi⁄
 *
£ssi⁄
)

64 
	`lockMuãx
(&
£ssi⁄
->
muãx
);

65 
£ssi⁄
->
ªfCou¡
++;

66 
	`u∆ockMuãx
(&
£ssi⁄
->
muãx
);

67 
	}
}

70 
Sessi⁄
 *
	$£¨chLi°
(
Sessi⁄Group
 *
group
, 
Sessi⁄ID
 
id
)

72 
Sessi⁄
 *
£ssi⁄
;

73 
	`LIST_FOREACH
(
£ssi⁄
, &
group
->
hód
, 
löks
) {

74 i‡(
£ssi⁄
->
id
 == id) {

75  
£ssi⁄
;

78  
NULL
;

79 
	}
}

82 
	$gëSessi⁄
(
Sessi⁄Group
 *
group
, 
Sessi⁄ID
 
id
,

83 
Sessi⁄
 **
£ssi⁄På
)

85 
	`lockMuãx
(&
group
->
muãx
);

86 
ªsu…
 = 
	`checkSessi⁄GroupLocked
(
group
);

87 i‡(
ªsu…
 !
UDS_SUCCESS
) {

88 
	`u∆ockMuãx
(&
group
->
muãx
);

89  
ªsu…
;

92 
Sessi⁄
 *
£ssi⁄
 = 
	`£¨chLi°
(
group
, 
id
);

93 i‡(
£ssi⁄
 !
NULL
) {

94 
	`acquúeSessi⁄
(
£ssi⁄
);

95 *
£ssi⁄På
 = 
£ssi⁄
;

96 
ªsu…
 = 
UDS_SUCCESS
;

98 
ªsu…
 = 
group
->
nŸFoundResu…
;

101 
	`u∆ockMuãx
(&
group
->
muãx
);

102  
ªsu…
;

103 
	}
}

106 
ölöe
 
Sessi⁄C⁄ã¡s
 
	$gëSessi⁄C⁄ã¡s
(
Sessi⁄
 *
£ssi⁄
)

108  
£ssi⁄
->
c⁄ã¡s
;

109 
	}
}

112 
	$ªÀa£Sessi⁄
(
Sessi⁄
 *
£ssi⁄
)

114 
	`lockMuãx
(&
£ssi⁄
->
muãx
);

115 
£ssi⁄
->
ªfCou¡
--;

116 
	`brﬂdˇ°C⁄d
(&
£ssi⁄
->
ªÀa£C⁄d
);

117 
	`u∆ockMuãx
(&
£ssi⁄
->
muãx
);

118 
	}
}

121 
Sessi⁄ID
 
	$öôülizeSessi⁄
(
Sessi⁄Group
 *
group
, 
Sessi⁄
 *
£ssi⁄
,

122 
Sessi⁄C⁄ã¡s
 
c⁄ã¡s
)

124 
Sessi⁄ID
 
id
;

126 
	`lockMuãx
(&
group
->
muãx
);

127 
id
 = 
group
->
√xtSessi⁄ID
;

128 
group
->
√xtSessi⁄ID
 = ((group->√xtSessi⁄ID =
SESSION_ID_MAX
) ?

129 
SESSION_ID_INIT
 : 
group
->
√xtSessi⁄ID
 + 1);

131 
	`öôMuãx
(&
£ssi⁄
->
muãx
);

132 
	`öôC⁄d
(&
£ssi⁄
->
ªÀa£C⁄d
);

133 
£ssi⁄
->
ªfCou¡
 = 1;

134 
£ssi⁄
->
c⁄ã¡s
 = contents;

135 
£ssi⁄
->
id
 = id;

136 
	`LIST_INSERT_HEAD
(&
group
->
hód
, 
£ssi⁄
, 
löks
);

137 
	`u∆ockMuãx
(&
group
->
muãx
);

139  
id
;

140 
	}
}

143 
	$‹ph™Sessi⁄Locked
(
Sessi⁄
 *
£ssi⁄
)

145 i‡(
£ssi⁄
->
id
 !
SESSION_ID_NONE
) {

146 
	`LIST_REMOVE
(
£ssi⁄
, 
löks
);

147 
£ssi⁄
->
id
 = 
SESSION_ID_NONE
;

149 
	}
}

152 
	$waôF‹IdÀSessi⁄
(
Sessi⁄
 *
£ssi⁄
)

154 
	`lockMuãx
(&
£ssi⁄
->
muãx
);

155 
£ssi⁄
->
idÀWaôîs
 += 1;

156 
£ssi⁄
->
ªfCou¡
 > sessi⁄->
idÀWaôîs
) {

157 
	`waôC⁄d
(&
£ssi⁄
->
ªÀa£C⁄d
, &£ssi⁄->
muãx
);

159 
£ssi⁄
->
idÀWaôîs
 -= 1;

160 
	`u∆ockMuãx
(&
£ssi⁄
->
muãx
);

161 
	}
}

164 
	$waôF‹Sessi⁄ToSt›
(
Sessi⁄
 *
£ssi⁄
)

166 
	`lockMuãx
(&
£ssi⁄
->
muãx
);

168 
£ssi⁄
->
idÀWaôîs
 += 1;

171 
£ssi⁄
->
ªfCou¡
 > 1) {

172 
	`waôC⁄d
(&
£ssi⁄
->
ªÀa£C⁄d
, &£ssi⁄->
muãx
);

175 
£ssi⁄
->
idÀWaôîs
 -= 1;

176 
	`u∆ockMuãx
(&
£ssi⁄
->
muãx
);

177 
	}
}

180 
	$föishSessi⁄
(
Sessi⁄Group
 *
group
, 
Sessi⁄
 *
£ssi⁄
)

182 
	`lockMuãx
(&
group
->
muãx
);

183 
	`‹ph™Sessi⁄Locked
(
£ssi⁄
);

184 
	`u∆ockMuãx
(&
group
->
muãx
);

185 
	`waôF‹Sessi⁄ToSt›
(
£ssi⁄
);

186 
	`de°royC⁄d
(&
£ssi⁄
->
ªÀa£C⁄d
);

187 
	`de°royMuãx
(&
£ssi⁄
->
muãx
);

188 
	}
}

191 
	$makeSessi⁄Group
(
nŸFoundResu…
, 
Sessi⁄Fªe
 
‰ì
,

192 
Sessi⁄Group
 **
groupPå
)

194 
Sessi⁄Group
 *
group
;

195 
ªsu…
 = 
	`ALLOCATE
(1, 
Sessi⁄Group
, "£ssi⁄ group", &
group
);

196 i‡(
ªsu…
 !
UDS_SUCCESS
) {

197  
ªsu…
;

200 
	`öôMuãx
(&
group
->
muãx
);

201 
	`öôC⁄d
(&
group
->
ªÀa£C⁄d
);

202 
	`LIST_INIT
(&
group
->
hód
);

203 
group
->
√xtSessi⁄ID
 = 
SESSION_ID_INIT
;

204 
group
->
ªfCou¡
 = 1;

205 
group
->
°©e
 = 
GROUP_READY
;

206 
group
->
‰ì
 = free;

207 
group
->
nŸFoundResu…
 =ÇotFoundResult;

209 *
groupPå
 = 
group
;

210  
UDS_SUCCESS
;

211 
	}
}

214 
	$acquúeSessi⁄Group
(
Sessi⁄Group
 *
group
)

216 
	`lockMuãx
(&
group
->
muãx
);

217 
ªsu…
 = 
	`checkSessi⁄GroupLocked
(
group
);

218 i‡(
ªsu…
 =
UDS_SUCCESS
) {

219 
group
->
ªfCou¡
++;

221 
	`u∆ockMuãx
(&
group
->
muãx
);

222  
ªsu…
;

223 
	}
}

226 
	$ªÀa£Sessi⁄Group
(
Sessi⁄Group
 *
group
)

228 
	`lockMuãx
(&
group
->
muãx
);

229 
group
->
ªfCou¡
--;

230 
	`brﬂdˇ°C⁄d
(&
group
->
ªÀa£C⁄d
);

231 
	`u∆ockMuãx
(&
group
->
muãx
);

232 
	}
}

235 
	$cou¡Sessi⁄s
(
Sessi⁄Group
 *
group
)

237 
£ssi⁄Cou¡
 = 0;

238 
Sessi⁄
 *
£ssi⁄
 = 
NULL
;

239 
	`lockMuãx
(&
group
->
muãx
);

240 
	`LIST_FOREACH
(
£ssi⁄
, &
group
->
hód
, 
löks
) {

241 
£ssi⁄Cou¡
++;

243 
	`u∆ockMuãx
(&
group
->
muãx
);

244  
£ssi⁄Cou¡
;

245 
	}
}

248 
	$shutdownSessi⁄Group
(
Sessi⁄Group
 *
group
)

250 
Sessi⁄
 *
£ssi⁄
;

251 
Sessi⁄Li°Hód
 
ãmpHód
;

252 
Sessi⁄Fªe
 
‰ìFunc
;

253 
	`LIST_INIT
(&
ãmpHód
);

255 
	`lockMuãx
(&
group
->
muãx
);

256 
group
->
°©e
 = 
GROUP_SHUTDOWN
;

257 
group
->
ªfCou¡
 > 1) {

258 
	`waôC⁄d
(&
group
->
ªÀa£C⁄d
, &group->
muãx
);

261 
‰ìFunc
 = 
group
->
‰ì
;

262 !
	`LIST_EMPTY
(&
group
->
hód
)) {

263 
£ssi⁄
 = 
	`LIST_FIRST
(&
group
->
hód
);

264 
	`acquúeSessi⁄
(
£ssi⁄
);

265 
	`‹ph™Sessi⁄Locked
(
£ssi⁄
);

266 
	`LIST_INSERT_HEAD
(&
ãmpHód
, 
£ssi⁄
, 
löks
);

268 
	`u∆ockMuãx
(&
group
->
muãx
);

270 !
	`LIST_EMPTY
(&
ãmpHód
)) {

271 
£ssi⁄
 = 
	`LIST_FIRST
(&
ãmpHód
);

272 
	`waôF‹Sessi⁄ToSt›
(
£ssi⁄
);

273 
	`LIST_REMOVE
(
£ssi⁄
, 
löks
);

274 
	`de°royC⁄d
(&
£ssi⁄
->
ªÀa£C⁄d
);

275 
	`de°royMuãx
(&
£ssi⁄
->
muãx
);

276 i‡(
‰ìFunc
 !
NULL
) {

277 
	`‰ìFunc
(
£ssi⁄
->
c⁄ã¡s
);

281 
	`de°royC⁄d
(&
group
->
ªÀa£C⁄d
);

282 
	`de°royMuãx
(&
group
->
muãx
);

283 
	`FREE
(
group
);

284 
	}
}

	@uds/session.h

35 #i‚de‡
SESSION_H


36 
	#SESSION_H


	)

38 
	~"queue.h
"

39 
	~"thªads.h
"

40 
	~"ty≥Defs.h
"

42 
	tSessi⁄ID
;

45 
	mSESSION_ID_NONE
 = 0,

46 
	mSESSION_ID_INIT
 = 1

49 * 
	tSessi⁄C⁄ã¡s
;

50 (*
	tSessi⁄Fªe
)(
	tSessi⁄C⁄ã¡s
 
	tc⁄ã¡s
);

52 
	s£ssi⁄
 {

53 
	`LIST_ENTRY
(
£ssi⁄
Ë
löks
;

55 
Muãx
 
muãx
;

56 
C⁄dV¨
 
ªÀa£C⁄d
;

57 
ªfCou¡
;

58 
idÀWaôîs
;

60 
Sessi⁄C⁄ã¡s
 
c⁄ã¡s
;

61 
Sessi⁄ID
 
id
;

62 } 
	tSessi⁄
;

64 
£ssi⁄Group
 
	tSessi⁄Group
;

78 
	$gëSessi⁄
(
Sessi⁄Group
 *
group
, 
Sessi⁄ID
 
id
, 
Sessi⁄
 **
£ssi⁄På
)

79 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

88 
Sessi⁄C⁄ã¡s
 
	$gëSessi⁄C⁄ã¡s
(
Sessi⁄
 *
£ssi⁄
)

89 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

97 
	`ªÀa£Sessi⁄
(
Sessi⁄
 *
£ssi⁄
);

105 
	`waôF‹IdÀSessi⁄
(
Sessi⁄
 *
£ssi⁄
);

119 
Sessi⁄ID
 
	$öôülizeSessi⁄
(
Sessi⁄Group
 *
group
, 
Sessi⁄
 *
£ssi⁄
,

120 
Sessi⁄C⁄ã¡s
 
c⁄ã¡s
)

121 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

130 
	$acquúeSessi⁄Group
(
Sessi⁄Group
 *
group
)

131 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

138 
	`ªÀa£Sessi⁄Group
(
Sessi⁄Group
 *
group
);

149 
	`föishSessi⁄
(
Sessi⁄Group
 *
group
, 
Sessi⁄
 *
£ssi⁄
);

161 
	$makeSessi⁄Group
(
nŸFoundResu…
, 
Sessi⁄Fªe
 
‰ì
,

162 
Sessi⁄Group
 **
groupPå
)

163 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

172 
	`cou¡Sessi⁄s
(
Sessi⁄Group
 *
group
);

180 
	`shutdownSessi⁄Group
(
Sessi⁄Group
 *
group
);

	@uds/sha224-256-private.h

3 #i‚de‡
_SHA_PRIVATE__H


4 
	#_SHA_PRIVATE__H


	)

12 #i‚de‡
USE_MODIFIED_MACROS


13 
	#SHA_Ch
(
x
,
y
,
z
Ë(((xË& (y)Ë^ ((~(x)Ë& (z)))

	)

14 
	#SHA_Maj
(
x
,
y
,
z
Ë(((xË& (y)Ë^ ((xË& (z)Ë^ ((yË& (z)))

	)

20 
	#SHA_Ch
(
x
, 
y
, 
z
Ë(((xË& ((yË^ (z))Ë^ (z))

	)

21 
	#SHA_Maj
(
x
, 
y
, 
z
Ë(((xË& ((yË| (z))Ë| ((yË& (z)))

	)

25 
	#SHA_P¨ôy
(
x
, 
y
, 
z
Ë((xË^ (yË^ (z))

	)

	@uds/sha224-256.c

43 
	~"sha224-256.h
"

44 
	~"sha224-256-¥iv©e.h
"

47 
	#SHA256_SHR
(
bôs
,
w‹d
Ë((w‹dË>> (bôs))

	)

48 
	#SHA256_ROTL
(
bôs
,
w‹d
) \

49 (((
w‹d
Ë<< (
bôs
)Ë| ((w‹dË>> (32-(bôs))))

	)

50 
	#SHA256_ROTR
(
bôs
,
w‹d
) \

51 (((
w‹d
Ë>> (
bôs
)Ë| ((w‹dË<< (32-(bôs))))

	)

54 
	#SHA256_SIGMA0
(
w‹d
) \

55 (
	`SHA256_ROTR
–2,
w‹d
Ë^ SHA256_ROTR(13,w‹dË^ SHA256_ROTR(22,w‹d))

	)

56 
	#SHA256_SIGMA1
(
w‹d
) \

57 (
	`SHA256_ROTR
–6,
w‹d
Ë^ SHA256_ROTR(11,w‹dË^ SHA256_ROTR(25,w‹d))

	)

58 
	#SHA256_sigma0
(
w‹d
) \

59 (
	`SHA256_ROTR
–7,
w‹d
Ë^ SHA256_ROTR(18,w‹dË^ 
	`SHA256_SHR
–3,w‹d))

	)

60 
	#SHA256_sigma1
(
w‹d
) \

61 (
	`SHA256_ROTR
(17,
w‹d
Ë^ SHA256_ROTR(19,w‹dË^ 
	`SHA256_SHR
(10,w‹d))

	)

67 
uöt32_t
 
	gaddTemp
;

68 
	#SHA224_256AddLígth
(
c⁄ãxt
, 
Àngth
) \

69 (
addTemp
 = (
c⁄ãxt
)->
Lígth_Low
, (c⁄ãxt)->
C‹ru±ed
 = \

70 (((
c⁄ãxt
)->
Lígth_Low
 +(
Àngth
)Ë< 
addTemp
) && \

71 (++(
c⁄ãxt
)->
Lígth_High
 =0Ë? 
shaI≈utTooL⁄g
 : \

72 (
c⁄ãxt
)->
C‹ru±ed
 )

	)

75 
SHA224_256Re£t
(
SHA256C⁄ãxt
 *
c⁄ãxt
, 
uöt32_t
 *
H0
);

76 
SHA224_256Pro˚ssMesßgeBlock
(
SHA256C⁄ãxt
 *
c⁄ãxt
);

77 
SHA224_256FöÆize
(
SHA256C⁄ãxt
 *
c⁄ãxt
,

78 
uöt8_t
 
Pad_Byã
);

79 
SHA224_256PadMesßge
(
SHA256C⁄ãxt
 *
c⁄ãxt
,

80 
uöt8_t
 
Pad_Byã
);

81 
SHA224_256Resu…N
(
SHA256C⁄ãxt
 *
c⁄ãxt
,

82 
uöt8_t
 
Mesßge_Dige°
[ ], 
HashSize
);

85 
uöt32_t
 
	gSHA224_H0
[
SHA256HashSize
/4] = {

91 
uöt32_t
 
	gSHA256_H0
[
SHA256HashSize
/4] = {

110 
	$SHA224Re£t
(
SHA224C⁄ãxt
 *
c⁄ãxt
)

112  
	`SHA224_256Re£t
(
c⁄ãxt
, 
SHA224_H0
);

113 
	}
}

135 
	$SHA224I≈ut
(
SHA224C⁄ãxt
 *
c⁄ãxt
, c⁄° 
uöt8_t
 *
mesßge_¨øy
,

136 
Àngth
)

138  
	`SHA256I≈ut
(
c⁄ãxt
, 
mesßge_¨øy
, 
Àngth
);

139 
	}
}

160 
	$SHA224FöÆBôs
(
SHA224C⁄ãxt
 *
c⁄ãxt
,

161 
uöt8_t
 
mesßge_bôs
, 
Àngth
)

163  
	`SHA256FöÆBôs
(
c⁄ãxt
, 
mesßge_bôs
, 
Àngth
);

164 
	}
}

185 
	$SHA224Resu…
(
SHA224C⁄ãxt
 *
c⁄ãxt
,

186 
uöt8_t
 
Mesßge_Dige°
[
SHA224HashSize
])

188  
	`SHA224_256Resu…N
(
c⁄ãxt
, 
Mesßge_Dige°
, 
SHA224HashSize
);

189 
	}
}

205 
	$SHA256Re£t
(
SHA256C⁄ãxt
 *
c⁄ãxt
)

207  
	`SHA224_256Re£t
(
c⁄ãxt
, 
SHA256_H0
);

208 
	}
}

229 
	$SHA256I≈ut
(
SHA256C⁄ãxt
 *
c⁄ãxt
, c⁄° 
uöt8_t
 *
mesßge_¨øy
,

230 
Àngth
)

232 i‡(!
c⁄ãxt
Ë 
shaNuŒ
;

233 i‡(!
Àngth
Ë 
shaSuc˚ss
;

234 i‡(!
mesßge_¨øy
Ë 
shaNuŒ
;

235 i‡(
c⁄ãxt
->
Compuãd
Ë c⁄ãxt->
C‹ru±ed
 = 
shaSèãEº‹
;

236 i‡(
c⁄ãxt
->
C‹ru±ed
)  context->Corrupted;

238 
Àngth
--) {

239 
c⁄ãxt
->
Mesßge_Block
[c⁄ãxt->
Mesßge_Block_Index
++] =

240 *
mesßge_¨øy
;

242 i‡((
	`SHA224_256AddLígth
(
c⁄ãxt
, 8Ë=
shaSuc˚ss
) &&

243 (
c⁄ãxt
->
Mesßge_Block_Index
 =
SHA256_Mesßge_Block_Size
))

244 
	`SHA224_256Pro˚ssMesßgeBlock
(
c⁄ãxt
);

246 
mesßge_¨øy
++;

249  
c⁄ãxt
->
C‹ru±ed
;

251 
	}
}

272 
	$SHA256FöÆBôs
(
SHA256C⁄ãxt
 *
c⁄ãxt
,

273 
uöt8_t
 
mesßge_bôs
, 
Àngth
)

275 
uöt8_t
 
masks
[8] = {

281 
uöt8_t
 
m¨kbô
[8] = {

288 i‡(!
c⁄ãxt
Ë 
shaNuŒ
;

289 i‡(!
Àngth
Ë 
shaSuc˚ss
;

290 i‡(
c⁄ãxt
->
C‹ru±ed
)  context->Corrupted;

291 i‡(
c⁄ãxt
->
Compuãd
Ë c⁄ãxt->
C‹ru±ed
 = 
shaSèãEº‹
;

292 i‡(
Àngth
 >8Ë 
c⁄ãxt
->
C‹ru±ed
 = 
shaBadP¨am
;

294 
	`SHA224_256AddLígth
(
c⁄ãxt
, 
Àngth
);

295 
	`SHA224_256FöÆize
(
c⁄ãxt
, (
uöt8_t
)

296 ((
mesßge_bôs
 & 
masks
[
Àngth
]Ë| 
m¨kbô
[length]));

298  
c⁄ãxt
->
C‹ru±ed
;

299 
	}
}

320 
	$SHA256Resu…
(
SHA256C⁄ãxt
 *
c⁄ãxt
,

321 
uöt8_t
 
Mesßge_Dige°
[
SHA256HashSize
])

323  
	`SHA224_256Resu…N
(
c⁄ãxt
, 
Mesßge_Dige°
, 
SHA256HashSize
);

324 
	}
}

342 
	$SHA224_256Re£t
(
SHA256C⁄ãxt
 *
c⁄ãxt
, 
uöt32_t
 *
H0
)

344 i‡(!
c⁄ãxt
Ë 
shaNuŒ
;

346 
c⁄ãxt
->
Lígth_High
 = c⁄ãxt->
Lígth_Low
 = 0;

347 
c⁄ãxt
->
Mesßge_Block_Index
 = 0;

349 
c⁄ãxt
->
I¡îmedüã_Hash
[0] = 
H0
[0];

350 
c⁄ãxt
->
I¡îmedüã_Hash
[1] = 
H0
[1];

351 
c⁄ãxt
->
I¡îmedüã_Hash
[2] = 
H0
[2];

352 
c⁄ãxt
->
I¡îmedüã_Hash
[3] = 
H0
[3];

353 
c⁄ãxt
->
I¡îmedüã_Hash
[4] = 
H0
[4];

354 
c⁄ãxt
->
I¡îmedüã_Hash
[5] = 
H0
[5];

355 
c⁄ãxt
->
I¡îmedüã_Hash
[6] = 
H0
[6];

356 
c⁄ãxt
->
I¡îmedüã_Hash
[7] = 
H0
[7];

358 
c⁄ãxt
->
Compuãd
 = 0;

359 
c⁄ãxt
->
C‹ru±ed
 = 
shaSuc˚ss
;

361  
shaSuc˚ss
;

362 
	}
}

383 
	$SHA224_256Pro˚ssMesßgeBlock
(
SHA256C⁄ãxt
 *
c⁄ãxt
)

386 c⁄° 
uöt32_t
 
K
[64] = {

401 
t
, 
t4
;

402 
uöt32_t
 
ãmp1
, 
ãmp2
;

403 
uöt32_t
 
W
[64];

404 
uöt32_t
 
A
, 
B
, 
C
, 
D
, 
E
, 
F
, 
G
, 
H
;

409 
t
 = 
t4
 = 0;Å < 16;Å++,Å4 += 4)

410 
W
[
t
] = (((
uöt32_t
)
c⁄ãxt
->
Mesßge_Block
[
t4
]) << 24) |

411 (((
uöt32_t
)
c⁄ãxt
->
Mesßge_Block
[
t4
 + 1]) << 16) |

412 (((
uöt32_t
)
c⁄ãxt
->
Mesßge_Block
[
t4
 + 2]) << 8) |

413 (((
uöt32_t
)
c⁄ãxt
->
Mesßge_Block
[
t4
 + 3]));

415 
t
 = 16;Å < 64;Å++)

416 
W
[
t
] = 
	`SHA256_sigma1
(W[t-2]) + W[t-7] +

417 
	`SHA256_sigma0
(
W
[
t
-15]) + W[t-16];

419 
A
 = 
c⁄ãxt
->
I¡îmedüã_Hash
[0];

420 
B
 = 
c⁄ãxt
->
I¡îmedüã_Hash
[1];

421 
C
 = 
c⁄ãxt
->
I¡îmedüã_Hash
[2];

422 
D
 = 
c⁄ãxt
->
I¡îmedüã_Hash
[3];

423 
E
 = 
c⁄ãxt
->
I¡îmedüã_Hash
[4];

424 
F
 = 
c⁄ãxt
->
I¡îmedüã_Hash
[5];

425 
G
 = 
c⁄ãxt
->
I¡îmedüã_Hash
[6];

426 
H
 = 
c⁄ãxt
->
I¡îmedüã_Hash
[7];

428 
t
 = 0;Å < 64;Å++) {

429 
ãmp1
 = 
H
 + 
	`SHA256_SIGMA1
(
E
Ë+ 
	`SHA_Ch
(E,
F
,
G
Ë+ 
K
[
t
] + 
W
[t];

430 
ãmp2
 = 
	`SHA256_SIGMA0
(
A
Ë+ 
	`SHA_Maj
(A,
B
,
C
);

431 
H
 = 
G
;

432 
G
 = 
F
;

433 
F
 = 
E
;

434 
E
 = 
D
 + 
ãmp1
;

435 
D
 = 
C
;

436 
C
 = 
B
;

437 
B
 = 
A
;

438 
A
 = 
ãmp1
 + 
ãmp2
;

441 
c⁄ãxt
->
I¡îmedüã_Hash
[0] +
A
;

442 
c⁄ãxt
->
I¡îmedüã_Hash
[1] +
B
;

443 
c⁄ãxt
->
I¡îmedüã_Hash
[2] +
C
;

444 
c⁄ãxt
->
I¡îmedüã_Hash
[3] +
D
;

445 
c⁄ãxt
->
I¡îmedüã_Hash
[4] +
E
;

446 
c⁄ãxt
->
I¡îmedüã_Hash
[5] +
F
;

447 
c⁄ãxt
->
I¡îmedüã_Hash
[6] +
G
;

448 
c⁄ãxt
->
I¡îmedüã_Hash
[7] +
H
;

450 
c⁄ãxt
->
Mesßge_Block_Index
 = 0;

451 
	}
}

471 
	$SHA224_256FöÆize
(
SHA256C⁄ãxt
 *
c⁄ãxt
,

472 
uöt8_t
 
Pad_Byã
)

474 
i
;

475 
	`SHA224_256PadMesßge
(
c⁄ãxt
, 
Pad_Byã
);

477 
i
 = 0; i < 
SHA256_Mesßge_Block_Size
; ++i)

478 
c⁄ãxt
->
Mesßge_Block
[
i
] = 0;

479 
c⁄ãxt
->
Lígth_High
 = 0;

480 
c⁄ãxt
->
Lígth_Low
 = 0;

481 
c⁄ãxt
->
Compuãd
 = 1;

482 
	}
}

508 
	$SHA224_256PadMesßge
(
SHA256C⁄ãxt
 *
c⁄ãxt
,

509 
uöt8_t
 
Pad_Byã
)

517 i‡(
c⁄ãxt
->
Mesßge_Block_Index
 >(
SHA256_Mesßge_Block_Size
-8)) {

518 
c⁄ãxt
->
Mesßge_Block
[c⁄ãxt->
Mesßge_Block_Index
++] = 
Pad_Byã
;

519 
c⁄ãxt
->
Mesßge_Block_Index
 < 
SHA256_Mesßge_Block_Size
)

520 
c⁄ãxt
->
Mesßge_Block
[c⁄ãxt->
Mesßge_Block_Index
++] = 0;

521 
	`SHA224_256Pro˚ssMesßgeBlock
(
c⁄ãxt
);

523 
c⁄ãxt
->
Mesßge_Block
[c⁄ãxt->
Mesßge_Block_Index
++] = 
Pad_Byã
;

525 
c⁄ãxt
->
Mesßge_Block_Index
 < (
SHA256_Mesßge_Block_Size
-8))

526 
c⁄ãxt
->
Mesßge_Block
[c⁄ãxt->
Mesßge_Block_Index
++] = 0;

531 
c⁄ãxt
->
Mesßge_Block
[56] = (
uöt8_t
)(c⁄ãxt->
Lígth_High
 >> 24);

532 
c⁄ãxt
->
Mesßge_Block
[57] = (
uöt8_t
)(c⁄ãxt->
Lígth_High
 >> 16);

533 
c⁄ãxt
->
Mesßge_Block
[58] = (
uöt8_t
)(c⁄ãxt->
Lígth_High
 >> 8);

534 
c⁄ãxt
->
Mesßge_Block
[59] = (
uöt8_t
)(c⁄ãxt->
Lígth_High
);

535 
c⁄ãxt
->
Mesßge_Block
[60] = (
uöt8_t
)(c⁄ãxt->
Lígth_Low
 >> 24);

536 
c⁄ãxt
->
Mesßge_Block
[61] = (
uöt8_t
)(c⁄ãxt->
Lígth_Low
 >> 16);

537 
c⁄ãxt
->
Mesßge_Block
[62] = (
uöt8_t
)(c⁄ãxt->
Lígth_Low
 >> 8);

538 
c⁄ãxt
->
Mesßge_Block
[63] = (
uöt8_t
)(c⁄ãxt->
Lígth_Low
);

540 
	`SHA224_256Pro˚ssMesßgeBlock
(
c⁄ãxt
);

541 
	}
}

564 
	$SHA224_256Resu…N
(
SHA256C⁄ãxt
 *
c⁄ãxt
,

565 
uöt8_t
 
Mesßge_Dige°
[ ], 
HashSize
)

567 
i
;

569 i‡(!
c⁄ãxt
Ë 
shaNuŒ
;

570 i‡(!
Mesßge_Dige°
Ë 
shaNuŒ
;

571 i‡(
c⁄ãxt
->
C‹ru±ed
)  context->Corrupted;

573 i‡(!
c⁄ãxt
->
Compuãd
)

574 
	`SHA224_256FöÆize
(
c⁄ãxt
, 0x80);

576 
i
 = 0; i < 
HashSize
; ++i)

577 
Mesßge_Dige°
[
i
] = (
uöt8_t
)

578 (
c⁄ãxt
->
I¡îmedüã_Hash
[
i
>>2] >> 8 * ( 3 - ( i & 0x03 ) ));

580  
shaSuc˚ss
;

581 
	}
}

583 
	~"sha256.h
"

585 
	$sha256
(c⁄° *
d©a
,

586 
size_t
 
Àn
,

587 
ªt_hash
[
SHA256_HASH_LEN
])

589 
SHA256C⁄ãxt
 
c⁄ãxt
;

590 
	`SHA256Re£t
(&
c⁄ãxt
);

591 
	`SHA256I≈ut
(&
c⁄ãxt
, 
d©a
, 
Àn
);

592 
	`SHA256Resu…
(&
c⁄ãxt
, 
ªt_hash
);

593 
	}
}

	@uds/sha224-256.h

39 #i‚de‡
_SHA_H_


40 
	#_SHA_H_


	)

73 
	~"ty≥Defs.h
"

74 
öt16_t
 
	töt_Àa°16_t
;

75 
öt32_t
 
	töt_Àa°32_t
;

89 #i‚de‡
_SHA_íum_


90 
	#_SHA_íum_


	)

95 
	mshaSuc˚ss
 = 0,

96 
	mshaNuŒ
,

97 
	mshaI≈utTooL⁄g
,

98 
	mshaSèãEº‹
,

99 
	mshaBadP¨am


108 
	mSHA1_Mesßge_Block_Size
 = 64, 
	mSHA224_Mesßge_Block_Size
 = 64,

109 
	mSHA256_Mesßge_Block_Size
 = 64, 
	mSHA384_Mesßge_Block_Size
 = 128,

110 
	mSHA512_Mesßge_Block_Size
 = 128,

111 
	mUSHA_Max_Mesßge_Block_Size
 = 
SHA512_Mesßge_Block_Size
,

113 
	mSHA1HashSize
 = 20, 
	mSHA224HashSize
 = 28, 
	mSHA256HashSize
 = 32,

114 
	mSHA384HashSize
 = 48, 
	mSHA512HashSize
 = 64,

115 
	mUSHAMaxHashSize
 = 
SHA512HashSize
,

117 
	mSHA1HashSizeBôs
 = 160, 
	mSHA224HashSizeBôs
 = 224,

118 
	mSHA256HashSizeBôs
 = 256, 
	mSHA384HashSizeBôs
 = 384,

119 
	mSHA512HashSizeBôs
 = 512, 
	mUSHAMaxHashSizeBôs
 = 
SHA512HashSizeBôs


125 
	eSHAvîsi⁄
 {

126 
	mSHA1
, 
	mSHA224
, 
	mSHA256
, 
	mSHA384
, 
	mSHA512


127 } 
	tSHAvîsi⁄
;

133 
	sSHA1C⁄ãxt
 {

134 
uöt32_t
 
	mI¡îmedüã_Hash
[
SHA1HashSize
/4];

136 
uöt32_t
 
	mLígth_High
;

137 
uöt32_t
 
	mLígth_Low
;

139 
öt_Àa°16_t
 
	mMesßge_Block_Index
;

141 
uöt8_t
 
	mMesßge_Block
[
SHA1_Mesßge_Block_Size
];

143 
	mCompuãd
;

144 
	mC‹ru±ed
;

145 } 
	tSHA1C⁄ãxt
;

151 
	sSHA256C⁄ãxt
 {

152 
uöt32_t
 
	mI¡îmedüã_Hash
[
SHA256HashSize
/4];

154 
uöt32_t
 
	mLígth_High
;

155 
uöt32_t
 
	mLígth_Low
;

157 
öt_Àa°16_t
 
	mMesßge_Block_Index
;

159 
uöt8_t
 
	mMesßge_Block
[
SHA256_Mesßge_Block_Size
];

161 
	mCompuãd
;

162 
	mC‹ru±ed
;

163 } 
	tSHA256C⁄ãxt
;

169 
	sSHA512C⁄ãxt
 {

170 #ifde‡
USE_32BIT_ONLY


171 
uöt32_t
 
	mI¡îmedüã_Hash
[
SHA512HashSize
/4];

172 
uöt32_t
 
	mLígth
[4];

174 
uöt64_t
 
	mI¡îmedüã_Hash
[
SHA512HashSize
/8];

175 
uöt64_t
 
	mLígth_High
, 
	mLígth_Low
;

178 
öt_Àa°16_t
 
	mMesßge_Block_Index
;

180 
uöt8_t
 
	mMesßge_Block
[
SHA512_Mesßge_Block_Size
];

182 
	mCompuãd
;

183 
	mC‹ru±ed
;

184 } 
	tSHA512C⁄ãxt
;

190 
SHA256C⁄ãxt
 
	tSHA224C⁄ãxt
;

196 
SHA512C⁄ãxt
 
	tSHA384C⁄ãxt
;

202 
	sUSHAC⁄ãxt
 {

203 
	mwhichSha
;

205 
SHA1C⁄ãxt
 
	msha1C⁄ãxt
;

206 
SHA224C⁄ãxt
 
	msha224C⁄ãxt
; 
SHA256C⁄ãxt
 
	msha256C⁄ãxt
;

207 
SHA384C⁄ãxt
 
	msha384C⁄ãxt
; 
SHA512C⁄ãxt
 
	msha512C⁄ãxt
;

208 } 
	m˘x
;

209 } 
	tUSHAC⁄ãxt
;

215 
	sHMACC⁄ãxt
 {

216 
	mwhichSha
;

217 
	mhashSize
;

218 
	mblockSize
;

219 
USHAC⁄ãxt
 
	mshaC⁄ãxt
;

220 
	mk_›ad
[
USHA_Max_Mesßge_Block_Size
];

222 
	mCompuãd
;

223 
	mC‹ru±ed
;

225 } 
	tHMACC⁄ãxt
;

231 
	sHKDFC⁄ãxt
 {

232 
	mwhichSha
;

233 
HMACC⁄ãxt
 
	mhmacC⁄ãxt
;

234 
	mhashSize
;

235 
	m¥k
[
USHAMaxHashSize
];

237 
	mCompuãd
;

238 
	mC‹ru±ed
;

239 } 
	tHKDFC⁄ãxt
;

246 
SHA1Re£t
(
SHA1C⁄ãxt
 *);

247 
SHA1I≈ut
(
SHA1C⁄ãxt
 *, c⁄° 
uöt8_t
 *
byãs
,

248 
byãcou¡
);

249 
SHA1FöÆBôs
(
SHA1C⁄ãxt
 *, 
uöt8_t
 
bôs
,

250 
bô_cou¡
);

251 
SHA1Resu…
(
SHA1C⁄ãxt
 *,

252 
uöt8_t
 
Mesßge_Dige°
[
SHA1HashSize
]);

255 
SHA224Re£t
(
SHA224C⁄ãxt
 *);

256 
SHA224I≈ut
(
SHA224C⁄ãxt
 *, c⁄° 
uöt8_t
 *
byãs
,

257 
byãcou¡
);

258 
SHA224FöÆBôs
(
SHA224C⁄ãxt
 *, 
uöt8_t
 
bôs
,

259 
bô_cou¡
);

260 
SHA224Resu…
(
SHA224C⁄ãxt
 *,

261 
uöt8_t
 
Mesßge_Dige°
[
SHA224HashSize
]);

264 
SHA256Re£t
(
SHA256C⁄ãxt
 *);

265 
SHA256I≈ut
(
SHA256C⁄ãxt
 *, c⁄° 
uöt8_t
 *
byãs
,

266 
byãcou¡
);

267 
SHA256FöÆBôs
(
SHA256C⁄ãxt
 *, 
uöt8_t
 
bôs
,

268 
bô_cou¡
);

269 
SHA256Resu…
(
SHA256C⁄ãxt
 *,

270 
uöt8_t
 
Mesßge_Dige°
[
SHA256HashSize
]);

273 
SHA384Re£t
(
SHA384C⁄ãxt
 *);

274 
SHA384I≈ut
(
SHA384C⁄ãxt
 *, c⁄° 
uöt8_t
 *
byãs
,

275 
byãcou¡
);

276 
SHA384FöÆBôs
(
SHA384C⁄ãxt
 *, 
uöt8_t
 
bôs
,

277 
bô_cou¡
);

278 
SHA384Resu…
(
SHA384C⁄ãxt
 *,

279 
uöt8_t
 
Mesßge_Dige°
[
SHA384HashSize
]);

282 
SHA512Re£t
(
SHA512C⁄ãxt
 *);

283 
SHA512I≈ut
(
SHA512C⁄ãxt
 *, c⁄° 
uöt8_t
 *
byãs
,

284 
byãcou¡
);

285 
SHA512FöÆBôs
(
SHA512C⁄ãxt
 *, 
uöt8_t
 
bôs
,

286 
bô_cou¡
);

287 
SHA512Resu…
(
SHA512C⁄ãxt
 *,

288 
uöt8_t
 
Mesßge_Dige°
[
SHA512HashSize
]);

291 
USHARe£t
(
USHAC⁄ãxt
 *
c⁄ãxt
, 
SHAvîsi⁄
 
whichSha
);

292 
USHAI≈ut
(
USHAC⁄ãxt
 *
c⁄ãxt
,

293 c⁄° 
uöt8_t
 *
byãs
, 
byãcou¡
);

294 
USHAFöÆBôs
(
USHAC⁄ãxt
 *
c⁄ãxt
,

295 
uöt8_t
 
bôs
, 
bô_cou¡
);

296 
USHAResu…
(
USHAC⁄ãxt
 *
c⁄ãxt
,

297 
uöt8_t
 
Mesßge_Dige°
[
USHAMaxHashSize
]);

298 
USHABlockSize
(
SHAvîsi⁄
 
whichSha
);

299 
USHAHashSize
(
SHAvîsi⁄
 
whichSha
);

300 
USHAHashSizeBôs
(
SHAvîsi⁄
 
whichSha
);

301 c⁄° *
USHAHashName
(
SHAvîsi⁄
 
whichSha
);

308 
hmac
(
SHAvîsi⁄
 
whichSha
,

309 c⁄° *
ãxt
,

310 
ãxt_Àn
,

311 c⁄° *
key
,

312 
key_Àn
,

313 
uöt8_t
 
dige°
[
USHAMaxHashSize
]);

320 
hmacRe£t
(
HMACC⁄ãxt
 *
c⁄ãxt
, 
SHAvîsi⁄
 
whichSha
,

321 c⁄° *
key
, 
key_Àn
);

322 
hmacI≈ut
(
HMACC⁄ãxt
 *
c⁄ãxt
, c⁄° *
ãxt
,

323 
ãxt_Àn
);

324 
hmacFöÆBôs
(
HMACC⁄ãxt
 *
c⁄ãxt
, 
uöt8_t
 
bôs
,

325 
bô_cou¡
);

326 
hmacResu…
(
HMACC⁄ãxt
 *
c⁄ãxt
,

327 
uöt8_t
 
dige°
[
USHAMaxHashSize
]);

333 
hkdf
(
SHAvîsi⁄
 
whichSha
, c⁄° *
ß…
,

334 
ß…_Àn
, c⁄° *
ikm
, 
ikm_Àn
,

335 c⁄° *
öfo
, 
öfo_Àn
,

336 
uöt8_t
 
okm
[ ], 
okm_Àn
);

337 
hkdfExåa˘
(
SHAvîsi⁄
 
whichSha
, c⁄° *
ß…
,

338 
ß…_Àn
, c⁄° *
ikm
,

339 
ikm_Àn
, 
uöt8_t
 
¥k
[
USHAMaxHashSize
]);

340 
hkdfEx∑nd
(
SHAvîsi⁄
 
whichSha
, c⁄° 
uöt8_t
 
¥k
[ ],

341 
¥k_Àn
, c⁄° *
öfo
,

342 
öfo_Àn
, 
uöt8_t
 
okm
[ ], 
okm_Àn
);

349 
hkdfRe£t
(
HKDFC⁄ãxt
 *
c⁄ãxt
, 
SHAvîsi⁄
 
whichSha
,

350 c⁄° *
ß…
, 
ß…_Àn
);

351 
hkdfI≈ut
(
HKDFC⁄ãxt
 *
c⁄ãxt
, c⁄° *
ikm
,

352 
ikm_Àn
);

353 
hkdfFöÆBôs
(
HKDFC⁄ãxt
 *
c⁄ãxt
, 
uöt8_t
 
ikm_bôs
,

354 
ikm_bô_cou¡
);

355 
hkdfResu…
(
HKDFC⁄ãxt
 *
c⁄ãxt
,

356 
uöt8_t
 
¥k
[
USHAMaxHashSize
],

357 c⁄° *
öfo
, 
öfo_Àn
,

358 
uöt8_t
 
okm
[
USHAMaxHashSize
], 
okm_Àn
);

	@uds/sha256.h

22 #i‚de‡
SHA256_H


23 
	#SHA256_H


	)

25 
	~<°ddef.h
>

27 #ifde‡
__˝lu•lus


31 íum { 
SHA256_HASH_LEN
 = 32 };

33 
sha256
(c⁄° *
d©a
, 
size_t
 
Àn
, 
ªt_hash
[
SHA256_HASH_LEN
]);

35 #ifde‡
__˝lu•lus


	@uds/singleFileLayout.c

22 
	~"sögÀFûeLayoutI¡î«ls.h
"

24 
	~<°d¨g.h
>

26 
	~"ac˚ssMode.h
"

27 
	~"blockIORegi⁄.h
"

28 
	~"buf„ªdRódîI¡î«ls.h
"

29 
	~"buf„ªdWrôîI¡î«ls.h
"

30 
	~"compûî.h
"

31 
	~"c⁄fig.h
"

32 
	~"ödexC⁄fig.h
"

33 
	~"ödexPageM≠.h
"

34 
	~"œyoutRegi⁄.h
"

35 
	~"loggî.h
"

36 
	~"mem‹yAŒoc.h
"

37 
	~"n⁄˚.h
"

38 
	~"›íCh≠ãr.h
"

39 
	~"ªgi⁄Idítifõrs.h
"

40 
	~"ªgi⁄IndexSèã.h
"

41 
	~"timeUtûs.h
"

42 
	~"z⁄e.h
"

44 c⁄° 
IndexLayoutOps
 *
gëSögÀFûeIndexLayoutOps
();

47 
	mDEFAULT_BLOCK_SIZE
 = 4096,

48 
	mINDEX_STATE_BUFFER_SIZE
 = 512,

49 
	mMAX_SAVES
 = 5,

52 c⁄° 
byã
 
	gSINGLE_FILE_MAGIC_1
[32] = "*ALBIREO*SINGLE*FILE*LAYOUT*001*";

54 
	mSINGLE_FILE_MAGIC_1_LENGTH
 = (
SINGLE_FILE_MAGIC_1
),

58 
INLINE
 
uöt64_t
 
	$blockCou¡
(
uöt64_t
 
byãs
, 
uöt32_t
 
blockSize
)

60 
uöt64_t
 
blocks
 = 
byãs
 / 
blockSize
;

61 i‡(
byãs
 % 
blockSize
 > 0) {

62 ++
blocks
;

64  
blocks
;

65 
	}
}

68 
__©åibuã__
((
w¨n_unu£d_ªsu…
))

69 
	$compuãSizes
(
SaveLayoutSizes
 *
¶s
,

70 c⁄° 
UdsC⁄figuøti⁄
 
c⁄fig
,

71 
size_t
 
blockSize
,

72 
numCheckpoöts
)

74 i‡(
c⁄fig
->
byãsPîPage
 % 
blockSize
 != 0) {

75  
	`logEº‹WôhSåögEº‹
(
UDS_INCORRECT_ALIGNMENT
,

79 
C⁄figuøti⁄
 *
cfg
 = 
NULL
;

80 
ªsu…
 = 
	`makeC⁄figuøti⁄
(
c⁄fig
, &
cfg
);

81 i‡(
ªsu…
 !
UDS_SUCCESS
) {

82  
	`logEº‹WôhSåögEº‹
(
ªsu…
, "cannot computeÜayout size");

85 
	`mem£t
(
¶s
, 0, (*sls));

89 
¶s
->
geomëry
 = *
cfg
->geometry;

90 
¶s
->
c⁄fig
 = *
cfg
;

91 
¶s
->
c⁄fig
.
geomëry
 = &sls->geometry;

93 
	`‰ìC⁄figuøti⁄
(
cfg
);

95 
¶s
->
numSaves
 = 2 + 
numCheckpoöts
;

96 
¶s
->
blockSize
 = blockSize;

97 
¶s
->
vﬁumeBlocks
 = sls->
geomëry
.
byãsPîVﬁume
 / 
blockSize
;

99 
ªsu…
 = 
	`compuãMa°îIndexSaveBlocks
(&
¶s
->
c⁄fig
, 
blockSize
,

100 &
¶s
->
ma°îIndexBlocks
);

101 i‡(
ªsu…
 !
UDS_SUCCESS
) {

102  
	`logEº‹WôhSåögEº‹
(
ªsu…
, "cannot compute index save size");

105 
¶s
->
∑geM≠Blocks
 =

106 
	`blockCou¡
(
	`compuãIndexPageM≠SaveSize
(&
¶s
->
geomëry
), 
blockSize
);

107 
¶s
->
›íCh≠ãrBlocks
 =

108 
	`blockCou¡
(
	`compuãSavedO≥nCh≠ãrSize
(&
¶s
->
geomëry
), 
blockSize
);

109 
¶s
->
ßveBlocks
 = 1 + (¶s->
ma°îIndexBlocks
 +

110 
¶s
->
∑geM≠Blocks
 + sls->
›íCh≠ãrBlocks
);

111 
¶s
->
subIndexBlocks
 = sls->
vﬁumeBlocks
 + (¶s->
numSaves
 * sls->
ßveBlocks
);

112 
¶s
->
tŸÆBlocks
 = 3 + sls->
subIndexBlocks
;

114  
UDS_SUCCESS
;

115 
	}
}

118 
	$ªcompuãSizes
(
SaveLayoutSizes
 *
¶s
, 
uöt64_t
 
√wSize
)

120 
uöt64_t
 
exåaBlocks
 = 
√wSize
 - 
¶s
->
tŸÆBlocks
;

122 
uöt64_t
 
exåaIndexBlocks
 = 
exåaBlocks
;

124 
n
 = 0;

125 
i
 = 
¶s
->
numSaves
; i < 
MAX_SAVES
; ++i) {

126 i‡(
exåaIndexBlocks
 < 
¶s
->
ßveBlocks
) {

129 ++
n
;

132 
¶s
->
numSaves
 +
n
;

133 
uöt64_t
 
exåaPîSubIndex
 = 
n
 * 
¶s
->
ßveBlocks
;

134 
¶s
->
subIndexBlocks
 +
n
;

135 
¶s
->
tŸÆBlocks
 +
exåaPîSubIndex
;

136 
	}
}

139 
	$udsCompuãIndexSize
(c⁄° 
UdsC⁄figuøti⁄
 
c⁄fig
,

140 
numCheckpoöts
,

141 
uöt64_t
 *
ödexSize
)

143 
SaveLayoutSizes
 
sizes
;

144 
ªsu…
 = 
	`compuãSizes
(&
sizes
, 
c⁄fig
, 
DEFAULT_BLOCK_SIZE
,

145 
numCheckpoöts
);

146 i‡(
ªsu…
 !
UDS_SUCCESS
) {

147  
ªsu…
;

150 i‡(
ödexSize
 !
NULL
) {

151 *
ödexSize
 = 
sizes
.
tŸÆBlocks
 * sizes.
blockSize
;

153  
UDS_SUCCESS
;

154 
	}
}

157 
	$£tSögÀFûeLayoutClo£Regi⁄OnFªe
(
IndexLayout
 *
œyout
,

158 
boﬁ
 
˛o£Regi⁄
)

160 
SögÀFûeLayout
 *
sÊ
 = 
	`asSögÀFûeLayout
(
œyout
);

161 
sÊ
->
˛o£
 = 
˛o£Regi⁄
;

162 
	}
}

165 
__©åibuã__
((
w¨n_unu£d_ªsu…
))

166 
	$vÆid©eOff£tAndBlockSize
(
IORegi⁄
 *
ªgi⁄
,

167 
uöt64_t
 
off£t
,

168 
size_t
 *
blockSizePå
)

170 
size_t
 
blockSize
 = 0;

171 
ªsu…
 = 
	`gëRegi⁄BlockSize
(
ªgi⁄
, &
blockSize
);

172 i‡(
ªsu…
 !
UDS_SUCCESS
) {

173  
	`logEº‹WôhSåögEº‹
(
ªsu…
,

177 i‡(
blockSize
 < 
DEFAULT_BLOCK_SIZE
) {

178 i‡(
DEFAULT_BLOCK_SIZE
 % 
blockSize
 != 0) {

179  
	`logEº‹WôhSåögEº‹
(
UDS_INCORRECT_ALIGNMENT
,

182 
blockSize
, 
DEFAULT_BLOCK_SIZE
);

184 
blockSize
 = 
DEFAULT_BLOCK_SIZE
;

185 } i‡(
blockSize
 > 
DEFAULT_BLOCK_SIZE
) {

186 i‡(
blockSize
 % 
DEFAULT_BLOCK_SIZE
 != 0) {

187  
	`logEº‹WôhSåögEº‹
(
UDS_INCORRECT_ALIGNMENT
,

190 
blockSize
, 
DEFAULT_BLOCK_SIZE
);

194 i‡(
off£t
 % 
blockSize
 != 0) {

195  
	`logEº‹WôhSåögEº‹
(
UDS_INCORRECT_ALIGNMENT
,

196 "off£à%" 
PRIu64


198 
off£t
, 
blockSize
);

201 *
blockSizePå
 = 
blockSize
;

202  
UDS_SUCCESS
;

203 
	}
}

206 
__©åibuã__
((
w¨n_unu£d_ªsu…
))

207 
	$lﬂdRegi⁄TabÀ
(
Buf„ªdRódî
 *
ªadî
, 
Regi⁄TabÀ
 **
èbÀPå
)

209 
Regi⁄Hódî
 
hódî
;

210 
ªsu…
 = 
	`ªadFromBuf„ªdRódî
(
ªadî
, &
hódî
, (header));

211 i‡(
ªsu…
 !
UDS_SUCCESS
) {

212  
	`logEº‹WôhSåögEº‹
(
ªsu…
, "cannotÑeadÑegionÅable header");

215 i‡(
hódî
.
magic
 !
REGION_MAGIC
) {

216  
	`logEº‹WôhSåögEº‹
(
UDS_CORRUPT_COMPONENT
,

220 i‡(
hódî
.
vîsi⁄
 != 1) {

221  
	`logEº‹WôhSåögEº‹
(
UDS_UNSUPPORTED_VERSION
,

222 "unknow¿ªgi⁄ÅabÀ vîsi⁄ %" 
PRIu16
,

223 
hódî
.
vîsi⁄
);

226 
Regi⁄TabÀ
 *
èbÀ
;

227 
ªsu…
 = 
	`ALLOCATE_EXTENDED
(
Regi⁄TabÀ
, 
hódî
.
numRegi⁄s
, 
LayoutRegi⁄
,

228 "sögÀ fûêœyouàªgi⁄ÅabÀ", &
èbÀ
);

229 i‡(
ªsu…
 !
UDS_SUCCESS
) {

230  
ªsu…
;

233 
èbÀ
->
hódî
 = header;

234 
ªsu…
 = 
	`ªadFromBuf„ªdRódî
(
ªadî
, 
èbÀ
->
ªgi⁄s
,

235 
hódî
.
numRegi⁄s
 * (
LayoutRegi⁄
));

236 i‡(
ªsu…
 !
UDS_SUCCESS
) {

237 
	`FREE
(
èbÀ
);

238  
	`logEº‹WôhSåögEº‹
(
UDS_CORRUPT_COMPONENT
,

242 *
èbÀPå
 = 
èbÀ
;

243  
UDS_SUCCESS
;

244 
	}
}

247 
__©åibuã__
((
w¨n_unu£d_ªsu…
))

248 
	$ªadSu≥rBlockD©a
(
Buf„ªdRódî
 *
ªadî
,

249 
Su≥rBlockD©a
 *
su≥r
,

250 
size_t
 
ßvedSize
)

252 i‡(
ßvedSize
 !(
Su≥rBlockD©a
)) {

253  
	`logEº‹WôhSåögEº‹
(
UDS_CORRUPT_COMPONENT
,

255 
ßvedSize
);

258 i‡((
su≥r
->
magicLabñ
Ë!
SINGLE_FILE_MAGIC_1_LENGTH
) {

259  
	`logEº‹WôhSåögEº‹
(
UDS_CORRUPT_COMPONENT
,

263 
ªsu…
 = 
	`ªadFromBuf„ªdRódî
(
ªadî
, 
su≥r
, 
ßvedSize
);

264 i‡(
ªsu…
 !
UDS_SUCCESS
) {

265  
	`logEº‹WôhSåögEº‹
(
ªsu…
, "cannotÑead super block data");

268 i‡(
	`memcmp
(
su≥r
->
magicLabñ
, 
SINGLE_FILE_MAGIC_1
,

269 
SINGLE_FILE_MAGIC_1_LENGTH
) != 0) {

270  
	`logEº‹WôhSåögEº‹
(
UDS_CORRUPT_COMPONENT
,

274 i‡(
su≥r
->
vîsi⁄
 != 1) {

275  
	`logEº‹WôhSåögEº‹
(
UDS_UNSUPPORTED_VERSION
,

277 
PRIu32
,

278 
su≥r
->
vîsi⁄
);

281 i‡(
	`gíî©eMa°îN⁄˚
(
su≥r
->
n⁄˚Info
, (super->nonceInfo)) !=

282 
su≥r
->
n⁄˚
)

284  
	`logEº‹WôhSåögEº‹
(
UDS_CORRUPT_COMPONENT
,

288  
UDS_SUCCESS
;

289 
	}
}

292 
__©åibuã__
((
w¨n_unu£d_ªsu…
))

293 
	$ÆloˇãSögÀFûeP¨ts
(
SögÀFûeLayout
 *
sÊ
,

294 
Su≥rBlockD©a
 *
su≥r
)

296 
ªsu…
 = 
	`ALLOCATE
(
su≥r
->
numIndexes
, 
SubIndexLayout
,

297 "SFL sub-ödexÜayouts", &
sÊ
->
ödexes
);

298 i‡(
ªsu…
 !
UDS_SUCCESS
) {

299  
ªsu…
;

302 
i
 = 0 ; i < 
su≥r
->
numIndexes
; ++i) {

303 
ªsu…
 = 
	`ALLOCATE
(
su≥r
->
maxSaves
, 
IndexSaveLayout
,

304 "SFL index savêœyout", &
sÊ
->
ödexes
[
i
].
ßves
);

305 i‡(
ªsu…
 !
UDS_SUCCESS
) {

306 
i
-- > 0) {

307 
	`FREE
(
sÊ
->
ödexes
[
i
].
ßves
);

309 
	`FREE
(
sÊ
->
ödexes
);

310  
ªsu…
;

314  
UDS_SUCCESS
;

315 
	}
}

318 
__©åibuã__
((
w¨n_unu£d_ªsu…
))

319 
	$lﬂdSu≥rBlock
(
SögÀFûeLayout
 *
sÊ
,

320 
size_t
 
blockSize
,

321 
uöt64_t
 
fú°Block
,

322 
IORegi⁄
 *
ªgi⁄
,

323 
Buf„ªdRódî
 *
ªadî
)

325 
Regi⁄TabÀ
 *
èbÀ
;

326 
ªsu…
 = 
	`lﬂdRegi⁄TabÀ
(
ªadî
, &
èbÀ
);

327 i‡(
ªsu…
 !
UDS_SUCCESS
) {

328  
	`logEº‹WôhSåögEº‹
(
ªsu…
, "cannotÑead superblock header");

331 i‡(
èbÀ
->
hódî
.
ty≥
 !
RH_TYPE_SUPER
) {

332 
	`FREE
(
èbÀ
);

333  
	`logEº‹WôhSåögEº‹
(
UDS_CORRUPT_COMPONENT
,

337 
Su≥rBlockD©a
 
su≥rBlockD©a
;

338 
ªsu…
 = 
	`ªadSu≥rBlockD©a
(
ªadî
, &
su≥rBlockD©a
, 
èbÀ
->
hódî
.
∑ylﬂd
);

339 i‡(
ªsu…
 !
UDS_SUCCESS
) {

340 
	`FREE
(
èbÀ
);

341  
	`logEº‹WôhSåögEº‹
(
ªsu…
, "unknown superblock format");

344 i‡(
su≥rBlockD©a
.
blockSize
 != blockSize) {

345 
	`FREE
(
èbÀ
);

346  
	`logEº‹WôhSåögEº‹
(
UDS_WRONG_INDEX_CONFIG
,

347 "su≥rblock saved blockSizê%" 
PRIu32


349 
su≥rBlockD©a
.
blockSize
, blockSize);

352 
ªsu…
 = 
	`ÆloˇãSögÀFûeP¨ts
(
sÊ
, &
su≥rBlockD©a
);

353 i‡(
ªsu…
 !
UDS_SUCCESS
) {

354 
	`FREE
(
sÊ
);

355  
ªsu…
;

358 
ªsu…
 = 
	`ªc⁄°ôuãSögÀFûeLayout
(
sÊ
, 
ªgi⁄
, &
su≥rBlockD©a
,

359 
èbÀ
, 
fú°Block
,

360 
	`gëSögÀFûeIndexLayoutOps
());

361 
	`FREE
(
èbÀ
);

362  
ªsu…
;

363 
	}
}

366 
__©åibuã__
((
w¨n_unu£d_ªsu…
))

367 
	$ªadIndexSaveD©a
(
Buf„ªdRódî
 *
ªadî
,

368 
IndexSaveD©a
 *
ßveD©a
,

369 
size_t
 
ßvedSize
,

370 
Buf„r
 **
buf„rPå
)

372 
ªsu…
 = 
UDS_SUCCESS
;

373 i‡(
ßvedSize
 == 0) {

374 
	`mem£t
(
ßveD©a
, 0, (*saveData));

376 i‡(
ßvedSize
 < (
IndexSaveD©a
)) {

377  
	`logEº‹WôhSåögEº‹
(
UDS_CORRUPT_COMPONENT
,

379 
ßvedSize
);

382 
ªsu…
 = 
	`ªadFromBuf„ªdRódî
(
ªadî
, 
ßveD©a
, (*saveData));

383 i‡(
ªsu…
 !
UDS_SUCCESS
) {

384  
	`logEº‹WôhSåögEº‹
(
ªsu…
, "cannotÑead index save data");

386 
ßvedSize
 -(
IndexSaveD©a
);

388 i‡(
ßveD©a
->
vîsi⁄
 > 1) {

389  
	`logEº‹WôhSåögEº‹
(
UDS_UNSUPPORTED_VERSION
,

391 
PRIu32
,

392 
ßveD©a
->
vîsi⁄
);

395 i‡(
ßvedSize
 > 
INDEX_STATE_BUFFER_SIZE
) {

396  
	`logEº‹WôhSåögEº‹
(
UDS_CORRUPT_COMPONENT
,

398 
ßvedSize
);

402 
Buf„r
 *
buf„r
 = 
NULL
;

404 i‡(
ßveD©a
->
vîsi⁄
 != 0) {

405 
ªsu…
 = 
	`makeBuf„r
(
INDEX_STATE_BUFFER_SIZE
, &
buf„r
);

406 i‡(
ªsu…
 !
UDS_SUCCESS
) {

407  
ªsu…
;

410 i‡(
ßvedSize
 > 0) {

411 
ªsu…
 = 
	`ªadFromBuf„ªdRódî
(
ªadî
, 
	`gëBuf„rC⁄ã¡s
(
buf„r
),

412 
ßvedSize
);

413 i‡(
ªsu…
 !
UDS_SUCCESS
) {

414 
	`‰ìBuf„r
(&
buf„r
);

415  
ªsu…
;

417 
ªsu…
 = 
	`ª£tBuf„rEnd
(
buf„r
, 
ßvedSize
);

418 i‡(
ªsu…
 !
UDS_SUCCESS
) {

419 
	`‰ìBuf„r
(&
buf„r
);

420  
ªsu…
;

425 *
buf„rPå
 = 
buf„r
;

426  
UDS_SUCCESS
;

427 
	}
}

432 
LayoutRegi⁄
 *
	m√xtRegi⁄
;

433 
LayoutRegi⁄
 *
	mœ°Regi⁄
;

434 
uöt64_t
 
	m√xtBlock
;

435 
	mªsu…
;

436 } 
	tRegi⁄Iãøt‹
;

439 
__©åibuã__
((
	$f‹m©
(
¥ötf
, 2, 3)))

440 
	$ôîEº‹
(
Regi⁄Iãøt‹
 *
ôî
, c⁄° *
fmt
, ...)

442 
va_li°
 
¨gs
;

443 
	`va_°¨t
(
¨gs
, 
fmt
);

444 
r
 = 
	`vLogWôhSåögEº‹
(
LOG_ERR
, 
UDS_UNEXPECTED_RESULT
, 
fmt
, 
¨gs
);

445 
	`va_íd
(
¨gs
);

446 i‡(
ôî
->
ªsu…
 =
UDS_SUCCESS
) {

447 
ôî
->
ªsu…
 = 
r
;

449 
	}
}

465 
boﬁ
 
	$ex≥˘Layout
(
boﬁ
 
ex≥˘
,

466 
LayoutRegi⁄
 *
Ã
,

467 
Regi⁄Iãøt‹
 *
ôî
,

468 
uöt64_t
 
numBlocks
,

469 
Regi⁄Köd
 
köd
,

470 
ö°™˚
)

472 i‡(
ôî
->
ªsu…
 !
UDS_SUCCESS
) {

473  
Ál£
;

476 i‡(
ôî
->
√xtRegi⁄
 =ôî->
œ°Regi⁄
) {

477 i‡(
ex≥˘
) {

478 
	`ôîEº‹
(
ôî
, "ran out ofÜayoutÑegions inÑegionÅable");

480  
Ál£
;

483 i‡(
ôî
->
√xtRegi⁄
->
°¨tBlock
 !ôî->
√xtBlock
) {

484 
	`ôîEº‹
(
ôî
, "layoutÑegionÇotátÉxpected offset");

485  
Ál£
;

488 i‡(
ôî
->
√xtRegi⁄
->
köd
 != kind) {

489 i‡(
ex≥˘
) {

490 
	`ôîEº‹
(
ôî
, "layoutÑegion has incorrect kind");

492  
Ál£
;

495 i‡(
ôî
->
√xtRegi⁄
->
ö°™˚
 != instance) {

496 
	`ôîEº‹
(
ôî
, "layoutÑegion has incorrect instance");

497  
Ál£
;

500 i‡(
numBlocks
 > 0 && 
ôî
->
√xtRegi⁄
->numBlocks !=ÇumBlocks) {

501 
	`ôîEº‹
(
ôî
, "layoutÑegion size is incorrect");

502  
Ál£
;

505 i‡(
Ã
 !
NULL
) {

506 *
Ã
 = *
ôî
->
√xtRegi⁄
;

509 
ôî
->
√xtBlock
 +ôî->
√xtRegi⁄
->
numBlocks
;

510 
ôî
->
√xtRegi⁄
++;

511  
åue
;

512 
	}
}

515 
	$£tupLayout
(
LayoutRegi⁄
 *
Ã
,

516 
uöt64_t
 *
√xtAddrPå
,

517 
uöt64_t
 
ªgi⁄Size
,

518 
köd
,

519 
ö°™˚
)

521 *
Ã
 = (
LayoutRegi⁄
) {

522 .
°¨tBlock
 = *
√xtAddrPå
,

523 .
numBlocks
 = 
ªgi⁄Size
,

524 .
checksum
 = 0,

525 .
köd
 = kind,

526 .
ö°™˚
 = instance,

528 *
√xtAddrPå
 +
ªgi⁄Size
;

529 
	}
}

532 
	$p›uœãIndexSaveLayout
(
IndexSaveLayout
 *
i¶
,

533 
Su≥rBlockD©a
 *
su≥r
,

534 
numZ⁄es
,

535 
IndexSaveTy≥
 
ßveTy≥
)

537 
uöt64_t
 
√xtBlock
 = 
i¶
->
ödexSave
.
°¨tBlock
;

539 
	`£tupLayout
(&
i¶
->
hódî
, &
√xtBlock
, 1, 
RL_KIND_HEADER
, 
RL_SOLE_INSTANCE
);

540 
	`£tupLayout
(&
i¶
->
ödexPageM≠
, &
√xtBlock
, 
su≥r
->
∑geM≠Blocks
,

541 
RL_KIND_INDEX_PAGE_MAP
, 
RL_SOLE_INSTANCE
);

543 
uöt64_t
 
blocksAvaû
 = (
i¶
->
ödexSave
.
numBlocks
 -

544 (
√xtBlock
 - 
i¶
->
ödexSave
.
°¨tBlock
) -

545 
su≥r
->
›íCh≠ãrBlocks
);

547 i‡(
numZ⁄es
 > 0) {

548 
uöt64_t
 
miBlockCou¡
 = 
blocksAvaû
 / 
numZ⁄es
;

550 
z
 = 0; z < 
numZ⁄es
; ++z) {

551 
LayoutRegi⁄
 *
miz
 = &
i¶
->
ma°îIndexZ⁄es
[
z
];

552 
	`£tupLayout
(
miz
, &
√xtBlock
, 
miBlockCou¡
, 
RL_KIND_MASTER_INDEX
, 
z
);

555 i‡(
ßveTy≥
 =
IS_SAVE
 && 
i¶
->
›íCh≠ãr
 !
NULL
) {

556 
	`£tupLayout
(
i¶
->
›íCh≠ãr
, &
√xtBlock
, 
su≥r
->
›íCh≠ãrBlocks
,

557 
RL_KIND_OPEN_CHAPTER
, 
RL_SOLE_INSTANCE
);

559 
	`£tupLayout
(&
i¶
->
‰ìS∑˚
, &
√xtBlock
,

560 (
i¶
->
ödexSave
.
numBlocks
 -

561 (
√xtBlock
 - 
i¶
->
ödexSave
.
°¨tBlock
)),

562 
RL_KIND_SCRATCH
, 
RL_SOLE_INSTANCE
);

563 
	}
}

566 
__©åibuã__
((
w¨n_unu£d_ªsu…
))

567 
	$ªc⁄°ru˘IndexSave
(
IndexSaveLayout
 *
i¶
,

568 
IndexSaveD©a
 *
ßveD©a
,

569 
Su≥rBlockD©a
 *
su≥r
,

570 
Regi⁄TabÀ
 *
èbÀ
)

572 
i¶
->
numZ⁄es
 = 0;

573 
i¶
->
ßveD©a
 = *saveData;

574 
i¶
->
ªad
 = 
Ál£
;

575 
i¶
->
wrôãn
 = 
Ál£
;

577 i‡(
èbÀ
->
hódî
.
ty≥
 =
RH_TYPE_SAVE
) {

578 
i¶
->
ßveTy≥
 = 
IS_SAVE
;

579 } i‡(
èbÀ
->
hódî
.
ty≥
 =
RH_TYPE_CHECKPOINT
) {

580 
i¶
->
ßveTy≥
 = 
IS_CHECKPOINT
;

582 
i¶
->
ßveTy≥
 = 
NO_SAVE
;

585 i‡((
èbÀ
->
hódî
.
numRegi⁄s
 == 0) ||

586 ((
èbÀ
->
hódî
.
numRegi⁄s
 == 1) &&

587 (
èbÀ
->
ªgi⁄s
[0].
köd
 =
RL_KIND_SCRATCH
)))

589 
	`p›uœãIndexSaveLayout
(
i¶
, 
su≥r
, 0, 
NO_SAVE
);

590  
UDS_SUCCESS
;

593 
Regi⁄Iãøt‹
 
ôî
 = {

594 .
√xtRegi⁄
 = 
èbÀ
->
ªgi⁄s
,

595 .
œ°Regi⁄
 = 
èbÀ
->
ªgi⁄s
 +ÅabÀ->
hódî
.
numRegi⁄s
,

596 .
√xtBlock
 = 
i¶
->
ödexSave
.
°¨tBlock
,

597 .
ªsu…
 = 
UDS_SUCCESS
,

600 
	`ex≥˘Layout
(
åue
, &
i¶
->
hódî
, &
ôî
, 1, 
RL_KIND_HEADER
, 
RL_SOLE_INSTANCE
);

601 
	`ex≥˘Layout
(
åue
, &
i¶
->
ödexPageM≠
, &
ôî
, 0,

602 
RL_KIND_INDEX_PAGE_MAP
, 
RL_SOLE_INSTANCE
);

603 
n
 = 0;

604 
Regi⁄Iãøt‹
 
tmpIãr
 = 
ôî
;

605 
	`ex≥˘Layout
(
Ál£
, 
NULL
, &
tmpIãr
, 0, 
RL_KIND_MASTER_INDEX
, 
n
);

606 ++
n
)

608 
i¶
->
numZ⁄es
 = 
n
;

610 
ªsu…
 = 
UDS_SUCCESS
;

612 i‡(
i¶
->
numZ⁄es
 > 0) {

613 
ªsu…
 = 
	`ALLOCATE
(
n
, 
LayoutRegi⁄
, "master indexÜayoutÑegions",

614 &
i¶
->
ma°îIndexZ⁄es
);

615 i‡(
ªsu…
 !
UDS_SUCCESS
) {

616  
ªsu…
;

620 i‡(
i¶
->
ßveTy≥
 =
IS_SAVE
) {

621 
ªsu…
 = 
	`ALLOCATE
(1, 
LayoutRegi⁄
, "open chapterÜayoutÑegion",

622 &
i¶
->
›íCh≠ãr
);

623 i‡(
ªsu…
 !
UDS_SUCCESS
) {

624 
	`FREE
(
i¶
->
ma°îIndexZ⁄es
);

625  
ªsu…
;

629 
z
 = 0; z < 
i¶
->
numZ⁄es
; ++z) {

630 
	`ex≥˘Layout
(
åue
, &
i¶
->
ma°îIndexZ⁄es
[
z
], &
ôî
, 0,

631 
RL_KIND_MASTER_INDEX
, 
z
);

633 i‡(
i¶
->
ßveTy≥
 =
IS_SAVE
) {

634 
	`ex≥˘Layout
(
åue
, 
i¶
->
›íCh≠ãr
, &
ôî
, 0,

635 
RL_KIND_OPEN_CHAPTER
, 
RL_SOLE_INSTANCE
);

637 i‡(!
	`ex≥˘Layout
(
Ál£
, &
i¶
->
‰ìS∑˚
, &
ôî
, 0,

638 
RL_KIND_SCRATCH
, 
RL_SOLE_INSTANCE
))

640 
i¶
->
‰ìS∑˚
 = (
LayoutRegi⁄
) {

641 .
°¨tBlock
 = 
ôî
.
√xtBlock
,

642 .
numBlocks
 = (
i¶
->
ödexSave
.
°¨tBlock
 +

643 
i¶
->
ödexSave
.
numBlocks
Ë- 
ôî
.
√xtBlock
,

644 .
checksum
 = 0,

645 .
köd
 = 
RL_KIND_SCRATCH
,

646 .
ö°™˚
 = 
RL_SOLE_INSTANCE
,

648 
ôî
.
√xtBlock
 = 
i¶
->
‰ìS∑˚
.
°¨tBlock
 + i¶->‰ìS∑˚.
numBlocks
;

651 i‡(
ôî
.
ªsu…
 !
UDS_SUCCESS
) {

652  
ôî
.
ªsu…
;

654 i‡(
ôî
.
√xtRegi⁄
 !ôî.
œ°Regi⁄
) {

655  
	`logEº‹WôhSåögEº‹
(
UDS_UNEXPECTED_RESULT
,

657 
ôî
.
œ°Regi⁄
 - iãr.
√xtRegi⁄
);

659 i‡(
ôî
.
√xtBlock
 !
i¶
->
ödexSave
.
°¨tBlock
 + i¶->ödexSave.
numBlocks
) {

660  
	`logEº‹WôhSåögEº‹
(
UDS_UNEXPECTED_RESULT
,

664  
UDS_SUCCESS
;

665 
	}
}

668 
__©åibuã__
((
w¨n_unu£d_ªsu…
))

669 
	$lﬂdIndexSave
(
IndexSaveLayout
 *
i¶
,

670 
Su≥rBlockD©a
 *
su≥r
,

671 
Buf„ªdRódî
 *
ªadî
,

672 
ödexId
,

673 
ßveId
)

675 
Regi⁄TabÀ
 *
èbÀ
;

676 
ªsu…
 = 
	`lﬂdRegi⁄TabÀ
(
ªadî
, &
èbÀ
);

677 i‡(
ªsu…
 !
UDS_SUCCESS
) {

678  
	`logEº‹WôhSåögEº‹
(
ªsu…
,

680 
ödexId
, 
ßveId
);

683 i‡(
èbÀ
->
hódî
.
ªgi⁄Blocks
 !
i¶
->
ödexSave
.
numBlocks
) {

684 
	`FREE
(
èbÀ
);

685  
	`logEº‹WôhSåögEº‹
(
UDS_CORRUPT_COMPONENT
,

687 "ªgi⁄ block cou¡ %" 
PRIu64
,

688 
ödexId
, 
ßveId
,

689 
èbÀ
->
hódî
.
ªgi⁄Blocks
);

692 i‡(
èbÀ
->
hódî
.
ty≥
 !
RH_TYPE_SAVE
 &&

693 
èbÀ
->
hódî
.
ty≥
 !
RH_TYPE_CHECKPOINT
 &&

694 
èbÀ
->
hódî
.
ty≥
 !
RH_TYPE_UNSAVED
)

696 
	`FREE
(
èbÀ
);

697  
	`logEº‹WôhSåögEº‹
(
UDS_CORRUPT_COMPONENT
,

699 
PRIu16
, 
ödexId
, 
ßveId
,

700 
èbÀ
->
hódî
.
ty≥
);

703 
IndexSaveD©a
 
ödexSaveD©a
;

704 
ªsu…
 = 
	`ªadIndexSaveD©a
(
ªadî
, &
ödexSaveD©a
, 
èbÀ
->
hódî
.
∑ylﬂd
,

705 &
i¶
->
ödexSèãBuf„r
);

706 i‡(
ªsu…
 !
UDS_SUCCESS
) {

707 
	`FREE
(
èbÀ
);

708  
	`logEº‹WôhSåögEº‹
(
ªsu…
,

710 
ödexId
, 
ßveId
);

713 
ªsu…
 = 
	`ªc⁄°ru˘IndexSave
(
i¶
, &
ödexSaveD©a
, 
su≥r
, 
èbÀ
);

715 
	`FREE
(
èbÀ
);

717 i‡(
ªsu…
 !
UDS_SUCCESS
) {

718 
	`‰ìBuf„r
(&
i¶
->
ödexSèãBuf„r
);

719  
	`logEº‹WôhSåögEº‹
(
ªsu…
,

721 
ödexId
, 
ßveId
);

723 
i¶
->
ªad
 = 
åue
;

724  
UDS_SUCCESS
;

725 
	}
}

728 
__©åibuã__
((
w¨n_unu£d_ªsu…
))

729 
	$lﬂdSubIndexRegi⁄s
(
SögÀFûeLayout
 *
sÊ
)

731 
i
 = 0; i < 
sÊ
->
su≥r
.
numIndexes
; ++i) {

732 
SubIndexLayout
 *
sû
 = &
sÊ
->
ödexes
[
i
];

733 
j
 = 0; j < 
sÊ
->
su≥r
.
maxSaves
; ++j) {

734 
IndexSaveLayout
 *
i¶
 = &
sû
->
ßves
[
j
];

736 
Buf„ªdRódî
 *
ªadî
;

737 
ªsu…
 = 
	`gëSögÀFûeLayoutRódî
(
sÊ
, &
i¶
->
ödexSave
, &
ªadî
);

738 i‡(
ªsu…
 !
UDS_SUCCESS
) {

739  
	`logEº‹WôhSåögEº‹
(
ªsu…
, "cannot getÑeader for "

740 "ödex %u savê%u", 
i
, 
j
);

743 
ªsu…
 = 
	`lﬂdIndexSave
(
i¶
, &
sÊ
->
su≥r
, 
ªadî
, 
i
, 
j
);

745 
	`‰ìBuf„ªdRódî
(
ªadî
);

747 i‡(
ªsu…
 !
UDS_SUCCESS
) {

748  
ªsu…
;

753  
UDS_SUCCESS
;

754 
	}
}

757 
	$lﬂdSögÀFûeLayout
(
IORegi⁄
 *
ªgi⁄
,

758 
uöt64_t
 
off£t
,

759 
IndexLayout
 **
œyoutPå
)

761 
size_t
 
blockSize
 = 0;

762 
ªsu…
 = 
	`vÆid©eOff£tAndBlockSize
(
ªgi⁄
, 
off£t
, &
blockSize
);

763 i‡(
ªsu…
 !
UDS_SUCCESS
) {

764  
ªsu…
;

767 
IORegi⁄
 *
su≥rBlockRegi⁄
;

768 
ªsu…
 = 
	`›íBlockRegi⁄
(
ªgi⁄
, 
IO_READ
, 
off£t
, off£à+ 
blockSize
,

769 &
su≥rBlockRegi⁄
);

770 i‡(
ªsu…
 !
UDS_SUCCESS
) {

771  
	`logEº‹WôhSåögEº‹
(
ªsu…
, "unableÅoÑead superblock");

774 
Buf„ªdRódî
 *
ªadî
;

775 
ªsu…
 = 
	`makeBuf„ªdRódî
(
su≥rBlockRegi⁄
, &
ªadî
);

776 i‡(
ªsu…
 !
UDS_SUCCESS
) {

777 
	`˛o£IORegi⁄
(&
su≥rBlockRegi⁄
);

778  
ªsu…
;

781 
SögÀFûeLayout
 *
sÊ
 = 
NULL
;

782 
ªsu…
 = 
	`ÆloˇãSögÀFûeLayout
(&
sÊ
);

783 i‡(
ªsu…
 !
UDS_SUCCESS
) {

784 
	`‰ìBuf„ªdRódî
(
ªadî
);

785 
	`˛o£IORegi⁄
(&
su≥rBlockRegi⁄
);

786  
ªsu…
;

789 
ªsu…
 = 
	`lﬂdSu≥rBlock
(
sÊ
, 
blockSize
, 
off£t
 / blockSize, 
ªgi⁄
, 
ªadî
);

791 
	`‰ìBuf„ªdRódî
(
ªadî
);

792 
	`˛o£IORegi⁄
(&
su≥rBlockRegi⁄
);

794 i‡(
ªsu…
 !
UDS_SUCCESS
) {

795 
	`FREE
(
sÊ
);

796  
ªsu…
;

799 
ªsu…
 = 
	`lﬂdSubIndexRegi⁄s
(
sÊ
);

800 i‡(
ªsu…
 !
UDS_SUCCESS
) {

801 
	`FREE
(
sÊ
);

802  
ªsu…
;

805 
sÊ
->
lﬂded
 = 
åue
;

806 *
œyoutPå
 = &
sÊ
->
comm⁄
;

807  
ªsu…
;

808 
	}
}

811 
	$ÆloˇãSögÀFûeLayout
(
SögÀFûeLayout
 **
sÊPå
)

813 
SögÀFûeLayout
 *
sÊ
 = 
NULL
;

814 
ªsu…
 = 
	`ALLOCATE
(1, 
SögÀFûeLayout
, "sögÀ fûêœyout", &
sÊ
);

815 i‡(
ªsu…
 !
UDS_SUCCESS
) {

816  
ªsu…
;

819 *
sÊPå
 = 
sÊ
;

820  
UDS_SUCCESS
;

821 
	}
}

824 
	$gíî©eSu≥rBlockD©a
(
size_t
 
blockSize
,

825 
numIndexes
,

826 
maxSaves
,

827 
uöt64_t
 
›íCh≠ãrBlocks
,

828 
uöt64_t
 
∑geM≠Blocks
,

829 
Su≥rBlockD©a
 *
su≥r
)

831 
	`mem£t
(
su≥r
, 0, (*super));

832 
	`mem˝y
(
su≥r
->
magicLabñ
, 
SINGLE_FILE_MAGIC_1
, 
SINGLE_FILE_MAGIC_1_LENGTH
);

833 
	`¸óãUniqueN⁄˚D©a
(
su≥r
->
n⁄˚Info
, (super->nonceInfo));

835 
su≥r
->
n⁄˚
 = 
	`gíî©eMa°îN⁄˚
(su≥r->
n⁄˚Info
,

836 (
su≥r
->
n⁄˚Info
));

837 
su≥r
->
vîsi⁄
 = 1;

838 
su≥r
->
blockSize
 = blockSize;

839 
su≥r
->
numIndexes
 =ÇumIndexes;

840 
su≥r
->
maxSaves
 = maxSaves;

841 
su≥r
->
›íCh≠ãrBlocks
 = openChapterBlocks;

842 
su≥r
->
∑geM≠Blocks
 =ÖageMapBlocks;

843 
	}
}

846 
__©åibuã__
((
w¨n_unu£d_ªsu…
))

847 
	$ª£tIndexSaveLayout
(
IndexSaveLayout
 *
i¶
,

848 
uöt64_t
 *
√xtBlockPå
,

849 
uöt64_t
 
ßveBlocks
,

850 
uöt64_t
 
∑geM≠Blocks
,

851 
ö°™˚
)

853 
uöt64_t
 
°¨tBlock
 = *
√xtBlockPå
;

855 i‡(
i¶
->
ma°îIndexZ⁄es
) {

856 
	`FREE
(
i¶
->
ma°îIndexZ⁄es
);

858 i‡(
i¶
->
›íCh≠ãr
) {

859 
	`FREE
(
i¶
->
›íCh≠ãr
);

861 i‡(
i¶
->
ödexSèãBuf„r
) {

862 
	`‰ìBuf„r
(&
i¶
->
ödexSèãBuf„r
);

864 
	`mem£t
(
i¶
, 0, (*isl));

865 
i¶
->
ßveTy≥
 = 
NO_SAVE
;

866 
	`£tupLayout
(&
i¶
->
ödexSave
, &
°¨tBlock
, 
ßveBlocks
, 
RL_KIND_SAVE
,

867 
ö°™˚
);

868 
	`£tupLayout
(&
i¶
->
hódî
, 
√xtBlockPå
, 1, 
RL_KIND_HEADER
,

869 
RL_SOLE_INSTANCE
);

870 
	`£tupLayout
(&
i¶
->
ödexPageM≠
, 
√xtBlockPå
, 
∑geM≠Blocks
,

871 
RL_KIND_INDEX_PAGE_MAP
, 
RL_SOLE_INSTANCE
);

872 
uöt64_t
 
ªmaöög
 = 
°¨tBlock
 - *
√xtBlockPå
;

873 
	`£tupLayout
(&
i¶
->
‰ìS∑˚
, 
√xtBlockPå
, 
ªmaöög
, 
RL_KIND_SCRATCH
,

874 
RL_SOLE_INSTANCE
);

877  
UDS_SUCCESS
;

878 
	}
}

881 
	$deföeSubIndexN⁄˚
(
SubIndexLayout
 *
sû
,

882 
uöt64_t
 
ma°îN⁄˚
,

883 
ödexId
)

885 
	ssubIndexN⁄˚D©a
 {

886 
uöt64_t
 
off£t
;

887 
uöt16_t
 
ödexId
;

888 } 
n⁄˚D©a
;

889 
	`mem£t
(&
n⁄˚D©a
, 0, (nonceData));

891 
n⁄˚D©a
.
off£t
 = 
sû
->
subIndex
.
°¨tBlock
;

892 
n⁄˚D©a
.
ödexId
 = indexId;

894 
sû
->
n⁄˚
 = 
	`gíî©eSec⁄d¨yN⁄˚
(
ma°îN⁄˚
, &
n⁄˚D©a
,

895 (
n⁄˚D©a
));

896 i‡(
sû
->
n⁄˚
 == 0) {

897 
sû
->
n⁄˚
 = 
	`gíî©eSec⁄d¨yN⁄˚
(~
ma°îN⁄˚
 + 1, &
n⁄˚D©a
,

898 (
n⁄˚D©a
));

900 
	}
}

903 
__©åibuã__
((
w¨n_unu£d_ªsu…
))

904 
	$£tupSubIndex
(
SubIndexLayout
 *
sû
,

905 
uöt64_t
 *
√xtBlockPå
,

906 
SaveLayoutSizes
 *
¶s
,

907 
ö°™˚
,

908 
uöt64_t
 
ma°îN⁄˚
)

910 
uöt64_t
 
°¨tBlock
 = *
√xtBlockPå
;

912 
	`£tupLayout
(&
sû
->
subIndex
, &
°¨tBlock
, 
¶s
->
subIndexBlocks
,

913 
RL_KIND_INDEX
, 
ö°™˚
);

914 
	`£tupLayout
(&
sû
->
vﬁume
, 
√xtBlockPå
, 
¶s
->
vﬁumeBlocks
,

915 
RL_KIND_VOLUME
, 
RL_SOLE_INSTANCE
);

916 
i
 = 0; i < 
¶s
->
numSaves
; ++i) {

917 
ªsu…
 = 
	`ª£tIndexSaveLayout
(&
sû
->
ßves
[
i
], 
√xtBlockPå
,

918 
¶s
->
ßveBlocks
, sls->
∑geM≠Blocks
, 
i
);

919 i‡(
ªsu…
 !
UDS_SUCCESS
) {

920  
ªsu…
;

924 i‡(
°¨tBlock
 !*
√xtBlockPå
) {

925  
	`logEº‹WôhSåögEº‹
(
UDS_UNEXPECTED_RESULT
,

929 
	`deföeSubIndexN⁄˚
(
sû
, 
ma°îN⁄˚
, 
ö°™˚
);

930  
UDS_SUCCESS
;

931 
	}
}

934 
	$öôSögÀFûeLayout
(
SögÀFûeLayout
 *
sÊ
,

935 
IORegi⁄
 *
ªgi⁄
,

936 
uöt64_t
 
off£t
,

937 
uöt64_t
 
size
,

938 
SaveLayoutSizes
 *
¶s
,

939 c⁄° 
IndexLayoutOps
 *
›s
)

941 
sÊ
->
ªgi⁄
 =Ñegion;

942 
sÊ
->
tŸÆBlocks
 = 
¶s
->totalBlocks;

943 
sÊ
->
˛o£
 = 
åue
;

945 i‡(
size
 < 
¶s
->
tŸÆBlocks
 * sls->
blockSize
) {

946  
	`logEº‹WôhSåögEº‹
(
UDS_INSUFFICIENT_INDEX_SPACE
,

950 
off_t
 
limô
 = 0;

951 
ªsu…
 = 
	`gëRegi⁄Limô
(
sÊ
->
ªgi⁄
, &
limô
);

952 i‡(
ªsu…
 !
UDS_SUCCESS
) {

953  
ªsu…
;

955 i‡(
limô
 < (
off_t
Ë
size
) {

956  
	`logEº‹WôhSåögEº‹
(
UDS_INSUFFICIENT_INDEX_SPACE
,

960 
	`gíî©eSu≥rBlockD©a
(
¶s
->
blockSize
, 1,

961 
¶s
->
numSaves
, sls->
›íCh≠ãrBlocks
,

962 
¶s
->
∑geM≠Blocks
, &
sÊ
->
su≥r
);

964 
ªsu…
 = 
	`ÆloˇãSögÀFûeP¨ts
(
sÊ
, &sÊ->
su≥r
);

965 i‡(
ªsu…
 !
UDS_SUCCESS
) {

966  
ªsu…
;

969 
uöt64_t
 
√xtBlock
 = 
off£t
 / 
¶s
->
blockSize
;

971 
	`£tupLayout
(&
sÊ
->
hódî
, &
√xtBlock
, 1, 
RL_KIND_HEADER
, 
RL_SOLE_INSTANCE
);

972 
	`£tupLayout
(&
sÊ
->
c⁄fig
, &
√xtBlock
, 1, 
RL_KIND_CONFIG
, 
RL_SOLE_INSTANCE
);

973 
i
 = 0; i < 
sÊ
->
su≥r
.
numIndexes
; ++i) {

974 
ªsu…
 = 
	`£tupSubIndex
(&
sÊ
->
ödexes
[
i
], &
√xtBlock
, 
¶s
, i,

975 
sÊ
->
su≥r
.
n⁄˚
);

976 i‡(
ªsu…
 !
UDS_SUCCESS
) {

977 
	`de°roySögÀFûeLayout
(
sÊ
);

978  
ªsu…
;

981 
	`£tupLayout
(&
sÊ
->
£Æ
, &
√xtBlock
, 1, 
RL_KIND_SEAL
, 
RL_SOLE_INSTANCE
);

982 i‡(
√xtBlock
 * 
¶s
->
blockSize
 > 
off£t
 + 
size
) {

983  
	`logEº‹WôhSåögEº‹
(
UDS_UNEXPECTED_RESULT
,

987 
sÊ
->
comm⁄
 = (
IndexLayout
) {

988 .
›s
 = ops,

990  
UDS_SUCCESS
;

991 
	}
}

994 
	$ex≥˘SubIndex
(
SubIndexLayout
 *
sû
,

995 
Regi⁄Iãøt‹
 *
ôî
,

996 
Su≥rBlockD©a
 *
su≥r
,

997 
ö°™˚
)

999 i‡(
ôî
->
ªsu…
 !
UDS_SUCCESS
) {

1003 
uöt64_t
 
°¨tBlock
 = 
ôî
->
√xtBlock
;

1005 
	`ex≥˘Layout
(
åue
, &
sû
->
subIndex
, 
ôî
, 0, 
RL_KIND_INDEX
, 
ö°™˚
);

1007 
uöt64_t
 
ídBlock
 = 
ôî
->
√xtBlock
;

1008 
ôî
->
√xtBlock
 = 
°¨tBlock
;

1010 
	`ex≥˘Layout
(
åue
, &
sû
->
vﬁume
, 
ôî
, 0, 
RL_KIND_VOLUME
, 
RL_SOLE_INSTANCE
);

1012 
i
 = 0; i < 
su≥r
->
maxSaves
; ++i) {

1013 
IndexSaveLayout
 *
i¶
 = &
sû
->
ßves
[
i
];

1014 
	`ex≥˘Layout
(
åue
, &
i¶
->
ödexSave
, 
ôî
, 0, 
RL_KIND_SAVE
, 
i
);

1017 i‡(
ôî
->
√xtBlock
 !
ídBlock
) {

1018 
	`ôîEº‹
(
ôî
, "sub indexÑegion doesÇot spanáll saves");

1021 
	`deföeSubIndexN⁄˚
(
sû
, 
su≥r
->
n⁄˚
, 
ö°™˚
);

1022 
	}
}

1025 
	$ªc⁄°ôuãSögÀFûeLayout
(
SögÀFûeLayout
 *
sÊ
,

1026 
IORegi⁄
 *
ªgi⁄
,

1027 
Su≥rBlockD©a
 *
su≥r
,

1028 
Regi⁄TabÀ
 *
èbÀ
,

1029 
uöt64_t
 
fú°Block
,

1030 c⁄° 
IndexLayoutOps
 *
›s
)

1032 
sÊ
->
ªgi⁄
 =Ñegion;

1033 
sÊ
->
su≥r
 = *super;

1034 
sÊ
->
tŸÆBlocks
 = 
èbÀ
->
hódî
.
ªgi⁄Blocks
;

1035 
sÊ
->
˛o£
 = 
åue
;

1037 
Regi⁄Iãøt‹
 
ôî
 = {

1038 .
√xtRegi⁄
 = 
èbÀ
->
ªgi⁄s
,

1039 .
œ°Regi⁄
 = 
èbÀ
->
ªgi⁄s
 +ÅabÀ->
hódî
.
numRegi⁄s
,

1040 .
√xtBlock
 = 
fú°Block
,

1041 .
ªsu…
 = 
UDS_SUCCESS


1044 
	`ex≥˘Layout
(
åue
, &
sÊ
->
hódî
, &
ôî
, 1, 
RL_KIND_HEADER
, 
RL_SOLE_INSTANCE
);

1045 
	`ex≥˘Layout
(
åue
, &
sÊ
->
c⁄fig
, &
ôî
, 1, 
RL_KIND_CONFIG
, 
RL_SOLE_INSTANCE
);

1046 
i
 = 0; i < 
sÊ
->
su≥r
.
numIndexes
; ++i) {

1047 
	`ex≥˘SubIndex
(&
sÊ
->
ödexes
[
i
], &
ôî
, &sÊ->
su≥r
, i);

1049 
	`ex≥˘Layout
(
åue
, &
sÊ
->
£Æ
, &
ôî
, 1, 
RL_KIND_SEAL
, 
RL_SOLE_INSTANCE
);

1051 i‡(
ôî
.
ªsu…
 !
UDS_SUCCESS
) {

1052  
ôî
.
ªsu…
;

1055 i‡(
ôî
.
√xtBlock
 !
fú°Block
 + 
sÊ
->
tŸÆBlocks
) {

1056  
	`logEº‹WôhSåögEº‹
(
UDS_UNEXPECTED_RESULT
,

1060 
sÊ
->
comm⁄
 = (
IndexLayout
) {

1061 .
›s
 = ops,

1063  
UDS_SUCCESS
;

1064 
	}
}

1067 
	$de°roySögÀFûeLayout
(
SögÀFûeLayout
 *
sÊ
)

1069 i‡(
sÊ
 =
NULL
) {

1072 
i
 = 0; i < 
sÊ
->
su≥r
.
numIndexes
; ++i) {

1073 
SubIndexLayout
 *
sû
 = &
sÊ
->
ödexes
[
i
];

1074 
j
 = 0; j < 
sÊ
->
su≥r
.
maxSaves
; ++j) {

1075 
IndexSaveLayout
 *
i¶
 = &
sû
->
ßves
[
j
];

1076 
	`FREE
(
i¶
->
ma°îIndexZ⁄es
);

1077 
	`FREE
(
i¶
->
›íCh≠ãr
);

1078 
	`‰ìBuf„r
(&
i¶
->
ödexSèãBuf„r
);

1080 
	`FREE
(
sû
->
ßves
);

1082 
	`FREE
(
sÊ
->
ödexes
);

1083 i‡(
sÊ
->
˛o£
) {

1084 
	`˛o£IORegi⁄
(&
sÊ
->
ªgi⁄
);

1085 
sÊ
->
˛o£
 = 
Ál£
;

1087 
	}
}

1090 
	$wrôeIndexSaveLayout
(
SögÀFûeLayout
 *
sÊ
,

1091 
IndexSaveLayout
 *
i¶
)

1092 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

1095 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
))

1096 
	$ßveSubIndexRegi⁄s
(
SögÀFûeLayout
 *
sÊ
)

1098 
i
 = 0; i < 
sÊ
->
su≥r
.
numIndexes
; ++i) {

1099 
SubIndexLayout
 *
sû
 = &
sÊ
->
ödexes
[
i
];

1101 
j
 = 0; j < 
sÊ
->
su≥r
.
maxSaves
; ++j) {

1102 
IndexSaveLayout
 *
i¶
 = &
sû
->
ßves
[
j
];

1104 
ªsu…
 = 
	`wrôeIndexSaveLayout
(
sÊ
, 
i¶
);

1105 i‡(
ªsu…
 !
UDS_SUCCESS
) {

1106  
	`logEº‹WôhSåögEº‹
(
ªsu…
,

1108 "ßvê%uÜayout", 
i
, 
j
);

1114  
UDS_SUCCESS
;

1115 
	}
}

1118 
__©åibuã__
((
w¨n_unu£d_ªsu…
))

1119 
	$makeSögÀFûeRegi⁄TabÀ
(
SögÀFûeLayout
 *
sÊ
,

1120 *
numRegi⁄sPå
,

1121 
Regi⁄TabÀ
 **
èbÀPå
)

1123 
numRegi⁄s
 =

1126 
sÊ
->
su≥r
.
numIndexes
 * (

1129 
sÊ
->
su≥r
.
maxSaves
) +

1132 
Regi⁄TabÀ
 *
èbÀ
;

1133 
ªsu…
 = 
	`ALLOCATE_EXTENDED
(
Regi⁄TabÀ
, 
numRegi⁄s
, 
LayoutRegi⁄
,

1134 "œyouàªgi⁄ÅabÀ f‹ SFL", &
èbÀ
);

1135 i‡(
ªsu…
 !
UDS_SUCCESS
) {

1136  
ªsu…
;

1139 
LayoutRegi⁄
 *
Ã
 = &
èbÀ
->
ªgi⁄s
[0];

1140 *
Ã
++ = 
sÊ
->
hódî
;

1141 *
Ã
++ = 
sÊ
->
c⁄fig
;

1142 
i
 = 0; i < 
sÊ
->
su≥r
.
numIndexes
; ++i) {

1143 
SubIndexLayout
 *
sû
 = &
sÊ
->
ödexes
[
i
];

1144 *
Ã
++ = 
sû
->
subIndex
;

1145 *
Ã
++ = 
sû
->
vﬁume
;

1146 
j
 = 0; j < 
sÊ
->
su≥r
.
maxSaves
; ++j) {

1147 *
Ã
++ = 
sû
->
ßves
[
j
].
ödexSave
;

1150 *
Ã
++ = 
sÊ
->
£Æ
;

1152 
ªsu…
 = 
	`ASSERT
((
Ã
 =&
èbÀ
->
ªgi⁄s
[
numRegi⁄s
]),

1154 i‡(
ªsu…
 !
UDS_SUCCESS
) {

1155  
ªsu…
;

1158 *
numRegi⁄sPå
 = 
numRegi⁄s
;

1159 *
èbÀPå
 = 
èbÀ
;

1160  
UDS_SUCCESS
;

1161 
	}
}

1164 
__©åibuã__
((
w¨n_unu£d_ªsu…
))

1165 
	$wrôeSögÀFûeHódî
(
SögÀFûeLayout
 *
sÊ
,

1166 
Regi⁄TabÀ
 *
èbÀ
,

1167 
numRegi⁄s
,

1168 
Buf„ªdWrôî
 *
wrôî
)

1170 
èbÀ
->
hódî
 = (
Regi⁄Hódî
) {

1171 .
magic
 = 
REGION_MAGIC
,

1172 .
ªgi⁄Blocks
 = 
sÊ
->
tŸÆBlocks
,

1173 .
ty≥
 = 
RH_TYPE_SUPER
,

1174 .
vîsi⁄
 = 1,

1175 .
numRegi⁄s
 =ÇumRegions,

1176 .
∑ylﬂd
 = (
sÊ
->
su≥r
),

1179 
size_t
 
èbÀSize
 = (
Regi⁄TabÀ
Ë+ 
numRegi⁄s
 * (
LayoutRegi⁄
);

1180 
ªsu…
 = 
	`wrôeToBuf„ªdWrôî
(
wrôî
, 
èbÀ
, 
èbÀSize
);

1181 i‡(
ªsu…
 !
UDS_SUCCESS
) {

1182  
ªsu…
;

1185 
ªsu…
 = 
	`wrôeToBuf„ªdWrôî
(
wrôî
, &
sÊ
->
su≥r
, (sfl->super));

1186 i‡(
ªsu…
 !
UDS_SUCCESS
) {

1187  
ªsu…
;

1190  
	`ÊushBuf„ªdWrôî
(
wrôî
);

1191 
	}
}

1194 
__©åibuã__
((
w¨n_unu£d_ªsu…
))

1195 
	$ßveSögÀFûeC⁄figuøti⁄
(
SögÀFûeLayout
 *
sÊ
)

1197 
ªsu…
 = 
	`ßveSubIndexRegi⁄s
(
sÊ
);

1198 i‡(
ªsu…
 !
UDS_SUCCESS
) {

1199  
ªsu…
;

1202 
Regi⁄TabÀ
 *
èbÀ
;

1203 
numRegi⁄s
;

1204 
ªsu…
 = 
	`makeSögÀFûeRegi⁄TabÀ
(
sÊ
, &
numRegi⁄s
, &
èbÀ
);

1205 i‡(
ªsu…
 !
UDS_SUCCESS
) {

1206  
ªsu…
;

1209 
Buf„ªdWrôî
 *
wrôî
 = 
NULL
;

1210 
ªsu…
 = 
	`gëSögÀFûeLayoutWrôî
(
sÊ
, &sÊ->
hódî
, &
wrôî
);

1211 i‡(
ªsu…
 !
UDS_SUCCESS
) {

1212 
	`FREE
(
èbÀ
);

1213  
ªsu…
;

1216 
ªsu…
 = 
	`wrôeSögÀFûeHódî
(
sÊ
, 
èbÀ
, 
numRegi⁄s
, 
wrôî
);

1217 
	`FREE
(
èbÀ
);

1218 
	`‰ìBuf„ªdWrôî
(
wrôî
);

1220 
sÊ
->
ßved
 = 
åue
;

1221  
ªsu…
;

1222 
	}
}

1225 
	$sÊ_‰ìMe
(
IndexLayout
 *
œyout
)

1227 i‡(
œyout
) {

1228 
SögÀFûeLayout
 *
sÊ
 = 
	`asSögÀFûeLayout
(
œyout
);

1229 
	`de°roySögÀFûeLayout
(
sÊ
);

1230 
	`FREE
(
sÊ
);

1232 
	}
}

1236 c⁄° 
byã
 
	gINDEX_SEAL_MAGIC
[] = "ALBIREO_INDEX_SEAL_";

1237 c⁄° 
	gINDEX_SEAL_VERSION_FORMAT
[] = "%02u";

1238 c⁄° 
byã
 
	gINDEX_SEAL_CURRENT
[] = "ALBIREO_INDEX_SEAL_01";

1241 
	mINDEX_SEAL_MAGIC_LENGTH
 = (
INDEX_SEAL_MAGIC
) - 1,

1242 
	mINDEX_SEAL_VERSION_LENGTH
 = 2,

1243 
	mINDEX_SEAL_HEADER_LENGTH
 =

1244 
INDEX_SEAL_MAGIC_LENGTH
 + 
INDEX_SEAL_VERSION_LENGTH
,

1246 c⁄° 
byã
 
	gINDEX_SEAL_V1
 = 1;

1248 
	södexSólD©a
 {

1249 
byã
 
	mhódî
[
INDEX_SEAL_HEADER_LENGTH
];

1250 
AbsTime
 
	mtime°amp
;

1251 
uöt64_t
 
	mhash
;

1252 } 
	tIndexSólD©a
;

1255 
	$sÊ_wrôeSól
(
IndexLayout
 *
œyout
)

1257 
SögÀFûeLayout
 *
sÊ
 = 
	`asSögÀFûeLayout
(
œyout
);

1259 
Buf„ªdWrôî
 *
wrôî
 = 
NULL
;

1260 
ªsu…
 = 
	`gëSögÀFûeLayoutWrôî
(
sÊ
, &sÊ->
£Æ
, &
wrôî
);

1261 i‡(
ªsu…
 !
UDS_SUCCESS
) {

1262  
ªsu…
;

1265 
IndexSólD©a
 
d©a
 = (IndexSealData) {

1266 .
time°amp
 = 
	`cuºítTime
(
CT_REALTIME
),

1267 .
hash
 = 0,

1269 
	`mem˝y
(
d©a
.
hódî
, 
INDEX_SEAL_CURRENT
, 
INDEX_SEAL_HEADER_LENGTH
);

1270 
d©a
.
hash
 = 
	`gíî©eSec⁄d¨yN⁄˚
(
sÊ
->
su≥r
.
n⁄˚
, &data, (data));

1272 
ªsu…
 = 
	`wrôeToBuf„ªdWrôî
(
wrôî
, &
d©a
, (data));

1273 i‡(
ªsu…
 !
UDS_SUCCESS
) {

1274 
	`‰ìBuf„ªdWrôî
(
wrôî
);

1275  
	`logEº‹WôhSåögEº‹
(
ªsu…
, "failedÅo write safety seal");

1278 
ªsu…
 = 
	`ÊushBuf„ªdWrôî
(
wrôî
);

1279 i‡(
ªsu…
 !
UDS_SUCCESS
) {

1280 
	`‰ìBuf„ªdWrôî
(
wrôî
);

1281  
	`logEº‹WôhSåögEº‹
(
ªsu…
, "failedÅo flush safety seal");

1284 
	`‰ìBuf„ªdWrôî
(
wrôî
);

1285  
UDS_SUCCESS
;

1286 
	}
}

1289 
	$sÊ_ªmoveSól
(
IndexLayout
 *
œyout
)

1291 
SögÀFûeLayout
 *
sÊ
 = 
	`asSögÀFûeLayout
(
œyout
);

1293 
Buf„ªdWrôî
 *
wrôî
 = 
NULL
;

1294 
ªsu…
 = 
	`gëSögÀFûeLayoutWrôî
(
sÊ
, &sÊ->
£Æ
, &
wrôî
);

1295 i‡(
ªsu…
 !
UDS_SUCCESS
) {

1296  
ªsu…
;

1299 
IndexSólD©a
 
d©a
;

1300 
	`mem£t
(&
d©a
, '*', (data));

1302 
ªsu…
 = 
	`wrôeToBuf„ªdWrôî
(
wrôî
, &
d©a
, (data));

1303 i‡(
ªsu…
 !
UDS_SUCCESS
) {

1304 
	`‰ìBuf„ªdWrôî
(
wrôî
);

1305  
	`logEº‹WôhSåögEº‹
(
ªsu…
, "failedÅo overwrite safety seal");

1308 
ªsu…
 = 
	`ÊushBuf„ªdWrôî
(
wrôî
);

1309 i‡(
ªsu…
 !
UDS_SUCCESS
) {

1310 
	`‰ìBuf„ªdWrôî
(
wrôî
);

1311  
	`logEº‹WôhSåögEº‹
(
ªsu…
, "failedÅo flush safety seal");

1314 
	`‰ìBuf„ªdWrôî
(
wrôî
);

1315  
UDS_SUCCESS
;

1316 
	}
}

1319 
	$sÊ_checkIndexExi°s
(
IndexLayout
 *
œyout
, 
boﬁ
 *
exi°s
)

1321 
SögÀFûeLayout
 *
sÊ
 = 
	`asSögÀFûeLayout
(
œyout
);

1323 i‡(
exi°s
 !
NULL
) {

1324 *
exi°s
 = (
sÊ
->
lﬂded
 || sÊ->
ßved
);

1326  
UDS_SUCCESS
;

1327 
	}
}

1330 
	$sÊ_checkSóÀd
(
IndexLayout
 *
œyout
, 
boﬁ
 *
£Æed
)

1332 
SögÀFûeLayout
 *
sÊ
 = 
	`asSögÀFûeLayout
(
œyout
);

1334 
Buf„ªdRódî
 *
ªadî
 = 
NULL
;

1335 
ªsu…
 = 
	`gëSögÀFûeLayoutRódî
(
sÊ
, &sÊ->
£Æ
, &
ªadî
);

1336 i‡(
ªsu…
 !
UDS_SUCCESS
) {

1337  
ªsu…
;

1340 
IndexSólD©a
 
d©a
;

1341 
	`mem£t
(&
d©a
, 0, (data));

1343 
boﬁ
 
isSóÀd
 = 
Ál£
;

1345 
ªsu…
 = 
	`ªadFromBuf„ªdRódî
(
ªadî
, &
d©a
, (data));

1346 i‡((
ªsu…
 =
UDS_SUCCESS
)

1347 && (
	`memcmp
(&
d©a
.
hódî
, 
INDEX_SEAL_CURRENT
, 
INDEX_SEAL_HEADER_LENGTH
)

1349 
uöt64_t
 
hash
 = 
d©a
.hash;

1350 
d©a
.
hash
 = 0;

1351 
isSóÀd
 = (
hash
 =
	`gíî©eSec⁄d¨yN⁄˚
(
sÊ
->
su≥r
.
n⁄˚
, &
d©a
,

1352 (
d©a
)));

1355 
	`‰ìBuf„ªdRódî
(
ªadî
);

1357 i‡(
£Æed
 !
NULL
) {

1358 *
£Æed
 = 
isSóÀd
;

1360  
UDS_SUCCESS
;

1361 
	}
}

1364 
	$sÊ_wrôeC⁄fig
(
IndexLayout
 *
œyout
, 
UdsC⁄figuøti⁄
 
c⁄fig
)

1366 
SögÀFûeLayout
 *
sÊ
 = 
	`asSögÀFûeLayout
(
œyout
);

1368 
Buf„ªdWrôî
 *
wrôî
 = 
NULL
;

1369 
ªsu…
 = 
	`gëSögÀFûeLayoutWrôî
(
sÊ
, &sÊ->
c⁄fig
, &
wrôî
);

1370 i‡(
ªsu…
 !
UDS_SUCCESS
) {

1371  
	`logEº‹WôhSåögEº‹
(
ªsu…
, "failedÅo open configÑegion");

1374 
ªsu…
 = 
	`wrôeC⁄figC⁄ã¡s
(
wrôî
, 
c⁄fig
);

1375 i‡(
ªsu…
 !
UDS_SUCCESS
) {

1376 
	`‰ìBuf„ªdWrôî
(
wrôî
);

1377  
	`logEº‹WôhSåögEº‹
(
ªsu…
, "failedÅo write configÑegion");

1379 
ªsu…
 = 
	`ÊushBuf„ªdWrôî
(
wrôî
);

1380 i‡(
ªsu…
 !
UDS_SUCCESS
) {

1381 
	`‰ìBuf„ªdWrôî
(
wrôî
);

1382  
	`logEº‹WôhSåögEº‹
(
ªsu…
, "cannot flush config writer");

1384 
	`‰ìBuf„ªdWrôî
(
wrôî
);

1385  
UDS_SUCCESS
;

1386 
	}
}

1389 
	$sÊ_ªadC⁄fig
(
IndexLayout
 *
œyout
, 
UdsC⁄figuøti⁄
 
c⁄fig
)

1391 
SögÀFûeLayout
 *
sÊ
 = 
	`asSögÀFûeLayout
(
œyout
);

1393 
Buf„ªdRódî
 *
ªadî
 = 
NULL
;

1394 
ªsu…
 = 
	`gëSögÀFûeLayoutRódî
(
sÊ
, &sÊ->
c⁄fig
, &
ªadî
);

1395 i‡(
ªsu…
 !
UDS_SUCCESS
) {

1396  
	`logEº‹WôhSåögEº‹
(
ªsu…
, "failedÅo open configÑeader");

1399 
ªsu…
 = 
	`ªadC⁄figC⁄ã¡s
(
ªadî
, 
c⁄fig
);

1400 i‡(
ªsu…
 !
UDS_SUCCESS
) {

1401 
	`‰ìBuf„ªdRódî
(
ªadî
);

1402  
	`logEº‹WôhSåögEº‹
(
ªsu…
, "failedÅoÑead configÑegion");

1404 
	`‰ìBuf„ªdRódî
(
ªadî
);

1405  
UDS_SUCCESS
;

1406 
	}
}

1409 
	$sÊ_›íVﬁumeRegi⁄
(
IndexLayout
 *
œyout
,

1410 
ödexId
,

1411 
IOAc˚ssMode
 
ac˚ss
,

1412 
IORegi⁄
 **
ªgi⁄På
)

1414 
SögÀFûeLayout
 *
sÊ
 = 
	`asSögÀFûeLayout
(
œyout
);

1416 i‡(
ödexId
 >
sÊ
->
su≥r
.
numIndexes
) {

1417  
	`logEº‹WôhSåögEº‹
(
UDS_INVALID_ARGUMENT
,

1419 
ödexId
, 
sÊ
->
su≥r
.
numIndexes
);

1422 
SubIndexLayout
 *
sû
 = &
sÊ
->
ödexes
[
ödexId
];

1424 
ªsu…
 = 
	`gëSögÀFûeLayoutRegi⁄
(
sÊ
, &
sû
->
vﬁume
, 
ac˚ss
, 
ªgi⁄På
);

1425 i‡(
ªsu…
 !
UDS_SUCCESS
) {

1426  
	`logEº‹WôhSåögEº‹
(
ªsu…
,

1428 
ödexId
);

1431  
UDS_SUCCESS
;

1432 
	}
}

1435 
	$sÊ_makeIndexSèã
(
IndexLayout
 *
œyout
,

1436 
ödexId
,

1437 
numZ⁄es
,

1438 
maxComp⁄íts
,

1439 
IndexSèã
 **
°©ePå
)

1441 
SögÀFûeLayout
 *
sÊ
 = 
	`asSögÀFûeLayout
(
œyout
);

1443  
	`makeRegi⁄IndexSèã
(
sÊ
, 
ödexId
, 
numZ⁄es
, 
maxComp⁄íts
, 
°©ePå
);

1444 
	}
}

1447 
	$sÊ_gëVﬁumeN⁄˚
(
IndexLayout
 *
œyout
,

1448 
ödexId
,

1449 
uöt64_t
 *
n⁄˚
)

1451 
SögÀFûeLayout
 *
sÊ
 = 
	`asSögÀFûeLayout
(
œyout
);

1453 i‡(
ödexId
 >
sÊ
->
su≥r
.
numIndexes
) {

1454  
	`logEº‹WôhSåögEº‹
(
UDS_INVALID_ARGUMENT
,

1456 
ödexId
, 
sÊ
->
su≥r
.
numIndexes
);

1459 *
n⁄˚
 = 
sÊ
->
ödexes
[
ödexId
].nonce;

1460  
UDS_SUCCESS
;

1461 
	}
}

1464 c⁄° *
sÊ_«me
(
IndexLayout
 *
œyout
 
__©åibuã__
((
unu£d
)))

1471 c⁄° 
IndexLayoutOps
 
	gsögÀFûeIndexLayoutOps
 = {

1472 .
‰ìFunc
 = 
sÊ_‰ìMe
,

1473 .
	gwrôeSól
 = 
sÊ_wrôeSól
,

1474 .
	gªmoveSól
 = 
sÊ_ªmoveSól
,

1475 .
	gcheckIndexExi°s
 = 
sÊ_checkIndexExi°s
,

1476 .
	gcheckSóÀd
 = 
sÊ_checkSóÀd
,

1477 .
	gwrôeC⁄fig
 = 
sÊ_wrôeC⁄fig
,

1478 .
	gªadC⁄fig
 = 
sÊ_ªadC⁄fig
,

1479 .
	g›íVﬁumeRegi⁄
 = 
sÊ_›íVﬁumeRegi⁄
,

1480 .
	gmakeIndexSèã
 = 
sÊ_makeIndexSèã
,

1481 .
	ggëVﬁumeN⁄˚
 = 
sÊ_gëVﬁumeN⁄˚
,

1482 .
	g«me
 = 
sÊ_«me
,

1485 c⁄° 
IndexLayoutOps
 *
	$gëSögÀFûeIndexLayoutOps
()

1487  &
sögÀFûeIndexLayoutOps
;

1488 
	}
}

1491 
	$gëSögÀFûeLayoutRegi⁄
(
SögÀFûeLayout
 *
sÊ
,

1492 
LayoutRegi⁄
 *
Ã
,

1493 
IOAc˚ssMode
 
ac˚ss
,

1494 
IORegi⁄
 **
ªgi⁄På
)

1496 
ªsu…
 = 
	`ASSERT
((
Ã
->
köd
 !
RL_KIND_SCRATCH
Ë&& (Ã->
numBlocks
 > 0),

1498 i‡(
ªsu…
 !
UDS_SUCCESS
) {

1499  
ªsu…
;

1502 
off_t
 
°¨t
 = 
Ã
->
°¨tBlock
 * 
sÊ
->
su≥r
.
blockSize
;

1503 
off_t
 
íd
 = 
°¨t
 + 
Ã
->
numBlocks
 * 
sÊ
->
su≥r
.
blockSize
;

1505  
	`›íBlockRegi⁄
(
sÊ
->
ªgi⁄
, 
ac˚ss
, 
°¨t
, 
íd
, 
ªgi⁄På
);

1506 
	}
}

1509 
	$gëSögÀFûeLayoutWrôî
(
SögÀFûeLayout
 *
sÊ
,

1510 
LayoutRegi⁄
 *
Ã
,

1511 
Buf„ªdWrôî
 **
wrôîPå
)

1513 
IORegi⁄
 *
ªgi⁄
 = 
NULL
;

1514 
ªsu…
 = 
	`gëSögÀFûeLayoutRegi⁄
(
sÊ
, 
Ã
, 
IO_WRITE
, &
ªgi⁄
);

1515 i‡(
ªsu…
 !
UDS_SUCCESS
) {

1516  
ªsu…
;

1519 
ªsu…
 = 
	`makeBuf„ªdWrôî
(
ªgi⁄
, 0, 
wrôîPå
);

1520 i‡(
ªsu…
 !
UDS_SUCCESS
) {

1521 
	`˛o£IORegi⁄
(&
ªgi⁄
);

1522  
ªsu…
;

1525 (*
wrôîPå
)->
bw_˛o£
 = 
åue
;

1526  
UDS_SUCCESS
;

1527 
	}
}

1530 
	$gëSögÀFûeLayoutRódî
(
SögÀFûeLayout
 *
sÊ
,

1531 
LayoutRegi⁄
 *
Ã
,

1532 
Buf„ªdRódî
 **
ªadîPå
)

1535 
IORegi⁄
 *
ªgi⁄
 = 
NULL
;

1536 
ªsu…
 = 
	`gëSögÀFûeLayoutRegi⁄
(
sÊ
, 
Ã
, 
IO_READ
, &
ªgi⁄
);

1537 i‡(
ªsu…
 !
UDS_SUCCESS
) {

1538  
ªsu…
;

1541 
ªsu…
 = 
	`makeBuf„ªdRódî
(
ªgi⁄
, 
ªadîPå
);

1542 i‡(
ªsu…
 !
UDS_SUCCESS
) {

1543 
	`˛o£IORegi⁄
(&
ªgi⁄
);

1544  
ªsu…
;

1547 (*
ªadîPå
)->
˛o£
 = 
åue
;

1548  
UDS_SUCCESS
;

1549 
	}
}

1552 
uöt64_t
 
	$gíî©eIndexSaveN⁄˚
(
uöt64_t
 
vﬁumeN⁄˚
,

1553 
IndexSaveLayout
 *
i¶
)

1555 
	sSaveN⁄˚D©a
 {

1556 
IndexSaveD©a
 
d©a
;

1557 
uöt64_t
 
off£t
;

1558 } 
n⁄˚D©a
;

1559 
	`mem£t
(&
n⁄˚D©a
, 0, (nonceData));

1560 
n⁄˚D©a
.
d©a
 = 
i¶
->
ßveD©a
;

1561 
n⁄˚D©a
.
d©a
.
n⁄˚
 = 0;

1562 
n⁄˚D©a
.
off£t
 = 
i¶
->
ödexSave
.
°¨tBlock
;

1564  
	`gíî©eSec⁄d¨yN⁄˚
(
vﬁumeN⁄˚
, &
n⁄˚D©a
, (nonceData));

1565 
	}
}

1568 
	$vÆid©eIndexSaveLayout
(
IndexSaveLayout
 *
i¶
,

1569 
uöt64_t
 
vﬁumeN⁄˚
,

1570 
uöt64_t
 *
ßveTimePå
)

1572 i‡(
i¶
->
ßveTy≥
 =
NO_SAVE
 || i¶->
numZ⁄es
 == 0 ||

1573 
i¶
->
ßveD©a
.
time°amp
 == 0)

1575  
UDS_BAD_STATE
;

1577 i‡(
i¶
->
ßveD©a
.
n⁄˚
 !
	`gíî©eIndexSaveN⁄˚
(
vﬁumeN⁄˚
, isl)) {

1578  
UDS_BAD_STATE
;

1580 i‡(
ßveTimePå
 !
NULL
) {

1581 *
ßveTimePå
 = 
i¶
->
ßveD©a
.
time°amp
;

1583  
UDS_SUCCESS
;

1584 
	}
}

1587 
__©åibuã__
((
w¨n_unu£d_ªsu…
))

1588 
	$£À˘Olde°IndexSaveLayout
(
SubIndexLayout
 *
sû
,

1589 
maxSaves
,

1590 
IndexSaveLayout
 **
i¶På
)

1592 
IndexSaveLayout
 *
ﬁde°
 = 
NULL
;

1593 
uöt64_t
 
ﬁde°Time
 = 0;

1596 
IndexSaveLayout
 *
i¶
 = 
sû
->
ßves
; i¶ < sû->ßve†+ 
maxSaves
; ++isl) {

1597 
uöt64_t
 
ßveTime
 = 0;

1598 
ªsu…
 = 
	`vÆid©eIndexSaveLayout
(
i¶
, 
sû
->
n⁄˚
, &
ßveTime
);

1599 i‡(
ªsu…
 !
UDS_SUCCESS
) {

1600 
ßveTime
 = 0;

1602 i‡(
ﬁde°
 =
NULL
 || 
ßveTime
 < 
ﬁde°Time
) {

1603 
ﬁde°
 = 
i¶
;

1604 
ﬁde°Time
 = 
ßveTime
;

1608 
ªsu…
 = 
	`ASSERT
((
ﬁde°
 !
NULL
), "no oldest or free save slot");

1609 i‡(
ªsu…
 !
UDS_SUCCESS
) {

1610  
ªsu…
;

1612 *
i¶På
 = 
ﬁde°
;

1613  
UDS_SUCCESS
;

1614 
	}
}

1617 
__©åibuã__
((
w¨n_unu£d_ªsu…
))

1618 
	$£À˘L©e°IndexSaveLayout
(
SubIndexLayout
 *
sû
,

1619 
maxSaves
,

1620 
IndexSaveLayout
 **
i¶På
)

1622 
IndexSaveLayout
 *
œã°
 = 
NULL
;

1623 
uöt64_t
 
œã°Time
 = 0;

1626 
IndexSaveLayout
 *
i¶
 = 
sû
->
ßves
; i¶ < sû->ßve†+ 
maxSaves
; ++isl) {

1627 
uöt64_t
 
ßveTime
 = 0;

1628 
ªsu…
 = 
	`vÆid©eIndexSaveLayout
(
i¶
, 
sû
->
n⁄˚
, &
ßveTime
);

1629 i‡(
ªsu…
 !
UDS_SUCCESS
) {

1632 i‡(
ßveTime
 > 
œã°Time
) {

1633 
œã°
 = 
i¶
;

1634 
œã°Time
 = 
ßveTime
;

1638 i‡(
œã°
 =
NULL
) {

1639  
UDS_INDEX_NOT_SAVED_CLEANLY
;

1641 *
i¶På
 = 
œã°
;

1642  
UDS_SUCCESS
;

1643 
	}
}

1646 
uöt64_t
 
	$gëTimeMS
(
AbsTime
 
time
)

1648 
time_t
 
t
 = 
	`asTimeT
(
time
);

1649 
RñTime
 
r
 = 
	`timeDif„ªn˚
(
time
, 
	`‰omTimeT
(
t
));

1650  (
uöt64_t
Ë
t
 * 1000 + 
	`ªlTimeToMûli£c⁄ds
(
r
);

1651 
	}
}

1654 
__©åibuã__
((
w¨n_unu£d_ªsu…
))

1655 
	$ö°™tüãIndexSaveLayout
(
IndexSaveLayout
 *
i¶
,

1656 
Su≥rBlockD©a
 *
su≥r
,

1657 
uöt64_t
 
vﬁumeN⁄˚
,

1658 
numZ⁄es
,

1659 
IndexSaveTy≥
 
ßveTy≥
)

1661 
ªsu…
 = 
UDS_SUCCESS
;

1662 i‡(
i¶
->
›íCh≠ãr
 && 
ßveTy≥
 =
IS_CHECKPOINT
) {

1663 
	`FREE
(
i¶
->
›íCh≠ãr
);

1664 
i¶
->
›íCh≠ãr
 = 
NULL
;

1665 } i‡(
i¶
->
›íCh≠ãr
 =
NULL
 && 
ßveTy≥
 =
IS_SAVE
) {

1666 
ªsu…
 = 
	`ALLOCATE
(1, 
LayoutRegi⁄
, "open chapterÜayout",

1667 &
i¶
->
›íCh≠ãr
);

1668 i‡(
ªsu…
 !
UDS_SUCCESS
) {

1669  
ªsu…
;

1672 i‡(
numZ⁄es
 !
i¶
->numZones) {

1673 i‡(
i¶
->
ma°îIndexZ⁄es
 !
NULL
) {

1674 
	`FREE
(
i¶
->
ma°îIndexZ⁄es
);

1676 
ªsu…
 = 
	`ALLOCATE
(
numZ⁄es
, 
LayoutRegi⁄
, "master index zoneÜayouts",

1677 &
i¶
->
ma°îIndexZ⁄es
);

1678 i‡(
ªsu…
 !
UDS_SUCCESS
) {

1679  
ªsu…
;

1681 
i¶
->
numZ⁄es
 =ÇumZones;

1684 
	`p›uœãIndexSaveLayout
(
i¶
, 
su≥r
, 
numZ⁄es
, 
ßveTy≥
);

1686 
ªsu…
 = 
	`makeBuf„r
(
INDEX_STATE_BUFFER_SIZE
, &
i¶
->
ödexSèãBuf„r
);

1687 i‡(
ªsu…
 !
UDS_SUCCESS
) {

1688  
ªsu…
;

1691 
i¶
->
ªad
 = i¶->
wrôãn
 = 
Ál£
;

1692 
i¶
->
ßveTy≥
 = saveType;

1693 
	`mem£t
(&
i¶
->
ßveD©a
, 0, (isl->saveData));

1694 
i¶
->
ßveD©a
.
time°amp
 = 
	`gëTimeMS
(
	`cuºítTime
(
CT_REALTIME
));

1695 
i¶
->
ßveD©a
.
vîsi⁄
 = 1;

1697 
i¶
->
ßveD©a
.
n⁄˚
 = 
	`gíî©eIndexSaveN⁄˚
(
vﬁumeN⁄˚
, isl);

1699  
UDS_SUCCESS
;

1700 
	}
}

1703 
__©åibuã__
((
w¨n_unu£d_ªsu…
))

1704 
	$övÆid©eOldSave
(
SögÀFûeLayout
 *
sÊ
, 
IndexSaveLayout
 *
i¶
)

1706 
uöt64_t
 
°¨tBlock
 = 
i¶
->
ödexSave
.startBlock;

1707 
uöt64_t
 
ßveBlocks
 = 
i¶
->
ödexSave
.
numBlocks
;

1708 
ßve
 = 
i¶
->
ödexSave
.
ö°™˚
;

1710 
ªsu…
 = 
	`ª£tIndexSaveLayout
(
i¶
, &
°¨tBlock
, 
ßveBlocks
,

1711 
sÊ
->
su≥r
.
∑geM≠Blocks
, 
ßve
);

1712 i‡(
ªsu…
 !
UDS_SUCCESS
) {

1713  
ªsu…
;

1716  
	`wrôeIndexSaveLayout
(
sÊ
, 
i¶
);

1717 
	}
}

1720 
	$£tupSögÀFûeIndexSaveSlŸ
(
SögÀFûeLayout
 *
sÊ
,

1721 
ödexId
,

1722 
numZ⁄es
,

1723 
IndexSaveTy≥
 
ßveTy≥
,

1724 *
ßveSlŸPå
)

1726 
SubIndexLayout
 *
sû
 = &
sÊ
->
ödexes
[
ödexId
];

1728 
IndexSaveLayout
 *
i¶
 = 
NULL
;

1729 
ªsu…
 = 
	`£À˘Olde°IndexSaveLayout
(
sû
, 
sÊ
->
su≥r
.
maxSaves
, &
i¶
);

1730 i‡(
ªsu…
 !
UDS_SUCCESS
) {

1731  
ªsu…
;

1734 
ªsu…
 = 
	`övÆid©eOldSave
(
sÊ
, 
i¶
);

1735 i‡(
ªsu…
 !
UDS_SUCCESS
) {

1736  
ªsu…
;

1739 
ªsu…
 = 
	`ö°™tüãIndexSaveLayout
(
i¶
, &
sÊ
->
su≥r
, 
sû
->
n⁄˚
, 
numZ⁄es
,

1740 
ßveTy≥
);

1741 i‡(
ªsu…
 !
UDS_SUCCESS
) {

1742  
ªsu…
;

1745 *
ßveSlŸPå
 = 
i¶
 - 
sû
->
ßves
;

1746  
UDS_SUCCESS
;

1747 
	}
}

1750 
	$födL©e°IndexSaveSlŸ
(
SögÀFûeLayout
 *
sÊ
,

1751 
ödexId
,

1752 *
numZ⁄esPå
,

1753 *
¶ŸPå
)

1755 
SubIndexLayout
 *
sû
 = &
sÊ
->
ödexes
[
ödexId
];

1757 
IndexSaveLayout
 *
i¶
 = 
NULL
;

1758 
ªsu…
 = 
	`£À˘L©e°IndexSaveLayout
(
sû
, 
sÊ
->
su≥r
.
maxSaves
, &
i¶
);

1759 i‡(
ªsu…
 !
UDS_SUCCESS
) {

1760  
ªsu…
;

1763 i‡(
numZ⁄esPå
 !
NULL
) {

1764 *
numZ⁄esPå
 = 
i¶
->
numZ⁄es
;

1766 i‡(
¶ŸPå
 !
NULL
) {

1767 *
¶ŸPå
 = 
i¶
 - 
sû
->
ßves
;

1769  
UDS_SUCCESS
;

1770 
	}
}

1773 
__©åibuã__
((
w¨n_unu£d_ªsu…
))

1774 
	$makeIndexSaveRegi⁄TabÀ
(
IndexSaveLayout
 *
i¶
,

1775 *
numRegi⁄sPå
,

1776 
Regi⁄TabÀ
 **
èbÀPå
)

1778 
numRegi⁄s
 =

1781 
i¶
->
numZ⁄es
 +

1782 (
boﬁ
Ë
i¶
->
›íCh≠ãr
;

1784 i‡(
i¶
->
‰ìS∑˚
.
numBlocks
 > 0) {

1785 
numRegi⁄s
++;

1788 
Regi⁄TabÀ
 *
èbÀ
;

1789 
ªsu…
 = 
	`ALLOCATE_EXTENDED
(
Regi⁄TabÀ
, 
numRegi⁄s
, 
LayoutRegi⁄
,

1790 "œyouàªgi⁄ÅabÀ f‹ ISL", &
èbÀ
);

1791 i‡(
ªsu…
 !
UDS_SUCCESS
) {

1792  
ªsu…
;

1795 
LayoutRegi⁄
 *
Ã
 = &
èbÀ
->
ªgi⁄s
[0];

1796 *
Ã
++ = 
i¶
->
hódî
;

1797 *
Ã
++ = 
i¶
->
ödexPageM≠
;

1798 
z
 = 0; z < 
i¶
->
numZ⁄es
; ++z) {

1799 *
Ã
++ = 
i¶
->
ma°îIndexZ⁄es
[
z
];

1801 i‡(
i¶
->
›íCh≠ãr
) {

1802 *
Ã
++ = *
i¶
->
›íCh≠ãr
;

1804 i‡(
i¶
->
‰ìS∑˚
.
numBlocks
 > 0) {

1805 *
Ã
++ = 
i¶
->
‰ìS∑˚
;

1808 
ªsu…
 = 
	`ASSERT
((
Ã
 =&
èbÀ
->
ªgi⁄s
[
numRegi⁄s
]),

1810 i‡(
ªsu…
 !
UDS_SUCCESS
) {

1811  
ªsu…
;

1814 *
numRegi⁄sPå
 = 
numRegi⁄s
;

1815 *
èbÀPå
 = 
èbÀ
;

1816  
UDS_SUCCESS
;

1817 
	}
}

1820 
	$ªgi⁄Ty≥F‹SaveTy≥
(
IndexSaveTy≥
 
ßveTy≥
)

1822 
ßveTy≥
) {

1823 
IS_SAVE
:

1824  
RH_TYPE_SAVE
;

1826 
IS_CHECKPOINT
:

1827  
RH_TYPE_CHECKPOINT
;

1833  
RH_TYPE_UNSAVED
;

1834 
	}
}

1837 
__©åibuã__
((
w¨n_unu£d_ªsu…
))

1838 
	$wrôeIndexSaveHódî
(
IndexSaveLayout
 *
i¶
,

1839 
Regi⁄TabÀ
 *
èbÀ
,

1840 
numRegi⁄s
,

1841 
Buf„ªdWrôî
 *
wrôî
)

1843 
size_t
 
∑ylﬂd
 = (
i¶
->
ßveD©a
);

1844 i‡(
i¶
->
ödexSèãBuf„r
 !
NULL
) {

1845 
∑ylﬂd
 +
	`c⁄ã¡Lígth
(
i¶
->
ödexSèãBuf„r
);

1848 
èbÀ
->
hódî
 = (
Regi⁄Hódî
) {

1849 .
magic
 = 
REGION_MAGIC
,

1850 .
ªgi⁄Blocks
 = 
i¶
->
ödexSave
.
numBlocks
,

1851 .
ty≥
 = 
	`ªgi⁄Ty≥F‹SaveTy≥
(
i¶
->
ßveTy≥
),

1852 .
vîsi⁄
 = 1,

1853 .
numRegi⁄s
 =ÇumRegions,

1854 .
∑ylﬂd
 =Öayload,

1857 
size_t
 
èbÀSize
 = (
Regi⁄TabÀ
Ë+ 
numRegi⁄s
 * (
LayoutRegi⁄
);

1858 
ªsu…
 = 
	`wrôeToBuf„ªdWrôî
(
wrôî
, 
èbÀ
, 
èbÀSize
);

1859 i‡(
ªsu…
 !
UDS_SUCCESS
) {

1860  
ªsu…
;

1863 
ªsu…
 = 
	`wrôeToBuf„ªdWrôî
(
wrôî
, &
i¶
->
ßveD©a
, (isl->saveData));

1864 i‡(
ªsu…
 !
UDS_SUCCESS
) {

1865  
ªsu…
;

1868 i‡(
i¶
->
ödexSèãBuf„r
 !
NULL
) {

1869 
ªsu…
 = 
	`wrôeToBuf„ªdWrôî
(
wrôî
,

1870 
	`gëBuf„rC⁄ã¡s
(
i¶
->
ödexSèãBuf„r
),

1871 
	`c⁄ã¡Lígth
(
i¶
->
ödexSèãBuf„r
));

1872 i‡(
ªsu…
 !
UDS_SUCCESS
) {

1873  
ªsu…
;

1877  
	`ÊushBuf„ªdWrôî
(
wrôî
);

1878 
	}
}

1881 
	$wrôeIndexSaveLayout
(
SögÀFûeLayout
 *
sÊ
,

1882 
IndexSaveLayout
 *
i¶
)

1884 
numRegi⁄s
;

1885 
Regi⁄TabÀ
 *
èbÀ
;

1886 
ªsu…
 = 
	`makeIndexSaveRegi⁄TabÀ
(
i¶
, &
numRegi⁄s
, &
èbÀ
);

1887 i‡(
ªsu…
 !
UDS_SUCCESS
) {

1888  
ªsu…
;

1891 
Buf„ªdWrôî
 *
wrôî
 = 
NULL
;

1892 
ªsu…
 = 
	`gëSögÀFûeLayoutWrôî
(
sÊ
, &
i¶
->
hódî
, &
wrôî
);

1893 i‡(
ªsu…
 !
UDS_SUCCESS
) {

1894 
	`FREE
(
èbÀ
);

1895  
ªsu…
;

1898 
ªsu…
 = 
	`wrôeIndexSaveHódî
(
i¶
, 
èbÀ
, 
numRegi⁄s
, 
wrôî
);

1899 
	`FREE
(
èbÀ
);

1900 
	`‰ìBuf„ªdWrôî
(
wrôî
);

1902 
i¶
->
wrôãn
 = 
åue
;

1903  
ªsu…
;

1904 
	}
}

1907 
	$commôSögÀFûeIndexSave
(
SögÀFûeLayout
 *
sÊ
,

1908 
ödexId
,

1909 
ßveSlŸ
)

1911 
ªsu…
 = 
	`ASSERT
((
ßveSlŸ
 < 
sÊ
->
su≥r
.
maxSaves
),

1913 i‡(
ªsu…
 !
UDS_SUCCESS
) {

1914  
ªsu…
;

1917 
IndexSaveLayout
 *
i¶
 = &
sÊ
->
ödexes
[
ödexId
].
ßves
[
ßveSlŸ
];

1919 i‡(
	`buf„rU£d
(
i¶
->
ödexSèãBuf„r
) == 0) {

1920  
	`logEº‹WôhSåögEº‹
(
UDS_UNEXPECTED_RESULT
,

1922 
__func__
);

1925  
	`wrôeIndexSaveLayout
(
sÊ
, 
i¶
);

1926 
	}
}

1930 
	$mutû©eIndexSaveInfo
(
IndexSaveLayout
 *
i¶
)

1932 
	`mem£t
(&
i¶
->
ßveD©a
, 0, (isl->saveData));

1933 
i¶
->
ªad
 = i¶->
wrôãn
 = 0;

1934 
i¶
->
ßveTy≥
 = 
NO_SAVE
;

1935 
i¶
->
numZ⁄es
 = 0;

1936 
	`‰ìBuf„r
(&
i¶
->
ödexSèãBuf„r
);

1937 
	}
}

1940 
	$ˇn˚lSögÀFûeIndexSave
(
SögÀFûeLayout
 *
sÊ
,

1941 
ödexId
,

1942 
ßveSlŸ
)

1944 
ªsu…
 = 
	`ASSERT
((
ßveSlŸ
 < 
sÊ
->
su≥r
.
maxSaves
),

1946 i‡(
ªsu…
 !
UDS_SUCCESS
) {

1947  
ªsu…
;

1950 
	`mutû©eIndexSaveInfo
(&
sÊ
->
ödexes
[
ödexId
].
ßves
[
ßveSlŸ
]);

1952  
UDS_SUCCESS
;

1953 
	}
}

1956 
	$disˇrdSögÀFûeIndexSaves
(
SögÀFûeLayout
 *
sÊ
,

1957 
ödexId
,

1958 
boﬁ
 
Æl
)

1960 
ªsu…
 = 
	`ASSERT
((
ödexId
 < 
sÊ
->
su≥r
.
numIndexes
),

1962 i‡(
ªsu…
 !
UDS_SUCCESS
) {

1963  
ªsu…
;

1966 
SubIndexLayout
 *
sû
 = &
sÊ
->
ödexes
[
ödexId
];

1968 i‡(
Æl
) {

1969 
i
 = 0; i < 
sÊ
->
su≥r
.
maxSaves
; ++i) {

1970 
IndexSaveLayout
 *
i¶
 = &
sû
->
ßves
[
i
];

1971 
ªsu…
 = 
	`fú°Eº‹
‘esu…, 
	`övÆid©eOldSave
(
sÊ
, 
i¶
));

1974 
IndexSaveLayout
 *
i¶
;

1975 
ªsu…
 = 
	`£À˘L©e°IndexSaveLayout
(
sû
, 
sÊ
->
su≥r
.
maxSaves
, &
i¶
);

1976 i‡(
ªsu…
 =
UDS_SUCCESS
) {

1977 
ªsu…
 = 
	`övÆid©eOldSave
(
sÊ
, 
i¶
);

1981  
ªsu…
;

1982 
	}
}

1985 
	$¸óãSögÀFûeLayout
(
IORegi⁄
 *
ªgi⁄
,

1986 
uöt64_t
 
off£t
,

1987 
uöt64_t
 
size
,

1988 c⁄° 
UdsC⁄figuøti⁄
 
c⁄fig
,

1989 
IndexLayout
 **
œyoutPå
)

1991 
size_t
 
blockSize
 = 0;

1992 
ªsu…
 = 
	`vÆid©eOff£tAndBlockSize
(
ªgi⁄
, 
off£t
, &
blockSize
);

1993 i‡(
ªsu…
 !
UDS_SUCCESS
) {

1994  
ªsu…
;

1997 
SaveLayoutSizes
 
sizes
;

1998 
ªsu…
 = 
	`compuãSizes
(&
sizes
, 
c⁄fig
, 
blockSize
, 0);

1999 i‡(
ªsu…
 !
UDS_SUCCESS
) {

2000  
ªsu…
;

2003 i‡(
size
 < 
sizes
.
tŸÆBlocks
 * sizes.
blockSize
) {

2004  
	`logEº‹WôhSåögEº‹
(
UDS_INSUFFICIENT_INDEX_SPACE
,

2005 "œyouàªquúe†©Üó° %" 
PRIu64
 " bytes",

2006 
sizes
.
tŸÆBlocks
 * sizes.
blockSize
);

2009 i‡(
size
 % 
sizes
.
blockSize
 != 0) {

2010  
	`logEº‹WôhSåögEº‹
(
UDS_INCORRECT_ALIGNMENT
,

2011 "œyouàsizê%" 
PRIu64


2013 
size
, 
sizes
.
blockSize
);

2016 i‡(
size
 > 
sizes
.
tŸÆBlocks
 * sizes.
blockSize
) {

2017 
	`ªcompuãSizes
(&
sizes
, 
size
 / sizes.
blockSize
);

2020 
SögÀFûeLayout
 *
sÊ
 = 
NULL
;

2021 
ªsu…
 = 
	`ÆloˇãSögÀFûeLayout
(&
sÊ
);

2022 i‡(
ªsu…
 !
UDS_SUCCESS
) {

2023  
ªsu…
;

2026 
ªsu…
 = 
	`öôSögÀFûeLayout
(
sÊ
, 
ªgi⁄
, 
off£t
, 
size
, &
sizes
,

2027 
	`gëSögÀFûeIndexLayoutOps
());

2028 i‡(
ªsu…
 !
UDS_SUCCESS
) {

2029 
	`FREE
(
sÊ
);

2030  
ªsu…
;

2033 
ªsu…
 = 
	`ßveSögÀFûeC⁄figuøti⁄
(
sÊ
);

2034 i‡(
ªsu…
 !
UDS_SUCCESS
) {

2035 
sÊ
->
˛o£
 = 
Ál£
;

2036 
	`de°roySögÀFûeLayout
(
sÊ
);

2037 
	`FREE
(
sÊ
);

2038  
ªsu…
;

2041 *
œyoutPå
 = &
sÊ
->
comm⁄
;

2042  
UDS_SUCCESS
;

2043 
	}
}

	@uds/singleFileLayout.h

22 #i‚de‡
SINGLE_FILE_LAYOUT_H


23 
	#SINGLE_FILE_LAYOUT_H


	)

25 
	~"ödexLayout.h
"

34 
sögÀFûeLayout
 
	tSögÀFûeLayout
;

61 
	$¸óãSögÀFûeLayout
(
IORegi⁄
 *
ªgi⁄
,

62 
uöt64_t
 
off£t
,

63 
uöt64_t
 
size
,

64 c⁄° 
UdsC⁄figuøti⁄
 
c⁄fig
,

65 
IndexLayout
 **
œyoutPå
)

66 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

80 
	$lﬂdSögÀFûeLayout
(
IORegi⁄
 *
ªgi⁄
,

81 
uöt64_t
 
off£t
,

82 
IndexLayout
 **
œyoutPå
)

83 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

94 
	`£tSögÀFûeLayoutClo£Regi⁄OnFªe
(
IndexLayout
 *
œyout
,

95 
boﬁ
 
˛o£Regi⁄
);

	@uds/singleFileLayoutInternals.h

22 #i‚de‡
SINGLE_FILE_LAYOUT_INTERNALS_H


23 
	#SINGLE_FILE_LAYOUT_INTERNALS_H


	)

25 
	~"sögÀFûeLayout.h
"

27 
	~"buf„r.h
"

28 
	~"compûî.h
"

29 
	~"ödexC⁄fig.h
"

30 
	~"œyoutRegi⁄.h
"

31 
	~"≥rmas£π.h
"

32 
	~"timeUtûs.h
"

84 
	södexSaveD©a_v1
 {

85 
uöt64_t
 
	mtime°amp
;

86 
uöt64_t
 
	mn⁄˚
;

87 
uöt32_t
 
	mvîsi⁄
;

88 
uöt32_t
 
	munu£d__
;

89 } 
	tIndexSaveD©a
;

91 
	södexSaveLayout
 {

92 
LayoutRegi⁄
 
	mödexSave
;

93 
LayoutRegi⁄
 
	mhódî
;

94 
	mnumZ⁄es
;

95 
LayoutRegi⁄
 
	mödexPageM≠
;

96 
LayoutRegi⁄
 
	m‰ìS∑˚
;

97 
LayoutRegi⁄
 *
	mma°îIndexZ⁄es
;

98 
LayoutRegi⁄
 *
	m›íCh≠ãr
;

99 
IndexSaveTy≥
 
	mßveTy≥
;

100 
IndexSaveD©a
 
	mßveD©a
;

101 
Buf„r
 *
	mödexSèãBuf„r
;

102 
boﬁ
 
	mªad
;

103 
boﬁ
 
	mwrôãn
;

104 } 
	tIndexSaveLayout
;

106 
	ssubIndexLayout
 {

107 
LayoutRegi⁄
 
	msubIndex
;

108 
uöt64_t
 
	mn⁄˚
;

109 
LayoutRegi⁄
 
	mvﬁume
;

110 
IndexSaveLayout
 *
	mßves
;

111 } 
	tSubIndexLayout
;

113 
	ssu≥rBlockD©a_v1
 {

114 
byã
 
	mmagicLabñ
[32];

115 
byã
 
	mn⁄˚Info
[32];

116 
uöt64_t
 
	mn⁄˚
;

117 
uöt32_t
 
	mvîsi⁄
;

118 
uöt32_t
 
	mblockSize
;

119 
uöt16_t
 
	mnumIndexes
;

120 
uöt16_t
 
	mmaxSaves
;

121 
uöt64_t
 
	m›íCh≠ãrBlocks
;

122 
uöt64_t
 
	m∑geM≠Blocks
;

123 } 
	tSu≥rBlockD©a
;

125 
	ssögÀFûeLayout
 {

126 
IndexLayout
 
	mcomm⁄
;

127 
IORegi⁄
 *
	mªgi⁄
;

128 
Su≥rBlockD©a
 
	msu≥r
;

129 
LayoutRegi⁄
 
	mhódî
;

130 
LayoutRegi⁄
 
	mc⁄fig
;

131 
SubIndexLayout
 *
	mödexes
;

132 
LayoutRegi⁄
 
	m£Æ
;

133 
boﬁ
 
	mlﬂded
;

134 
boﬁ
 
	mßved
;

135 
boﬁ
 
	m˛o£
;

136 
uöt64_t
 
	mtŸÆBlocks
;

149 
	sßveLayoutSizes
 {

150 
C⁄figuøti⁄
 
	mc⁄fig
;

151 
Geomëry
 
	mgeomëry
;

152 
	mnumSaves
;

153 
size_t
 
	mblockSize
;

154 
uöt64_t
 
	mvﬁumeBlocks
;

155 
uöt64_t
 
	mma°îIndexBlocks
;

156 
uöt64_t
 
	m∑geM≠Blocks
;

157 
uöt64_t
 
	m›íCh≠ãrBlocks
;

158 
uöt64_t
 
	mßveBlocks
;

159 
uöt64_t
 
	msubIndexBlocks
;

160 
uöt64_t
 
	mtŸÆBlocks
;

161 } 
	tSaveLayoutSizes
;

164 
	$ÆloˇãSögÀFûeLayout
(
SögÀFûeLayout
 **
sÊPå
)

165 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

184 
	$öôSögÀFûeLayout
(
SögÀFûeLayout
 *
sÊ
,

185 
IORegi⁄
 *
ªgi⁄
,

186 
uöt64_t
 
off£t
,

187 
uöt64_t
 
size
,

188 
SaveLayoutSizes
 *
¶s
,

189 c⁄° 
IndexLayoutOps
 *
›s
)

190 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

206 
	$ªc⁄°ôuãSögÀFûeLayout
(
SögÀFûeLayout
 *
sÊ
,

207 
IORegi⁄
 *
ªgi⁄
,

208 
Su≥rBlockD©a
 *
su≥r
,

209 
Regi⁄TabÀ
 *
èbÀ
,

210 
uöt64_t
 
fú°Block
,

211 c⁄° 
IndexLayoutOps
 *
›s
)

212 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

215 
	`de°roySögÀFûeLayout
(
SögÀFûeLayout
 *
sÊ
);

218 
INLINE
 
SögÀFûeLayout
 *
	$asSögÀFûeLayout
(
IndexLayout
 *
œyout
)

220  
	`c⁄èöî_of
(
œyout
, 
SögÀFûeLayout
, 
comm⁄
);

221 
	}
}

224 
	$gëSögÀFûeLayoutRegi⁄
(
SögÀFûeLayout
 *
sÊ
,

225 
LayoutRegi⁄
 *
Ã
,

226 
IOAc˚ssMode
 
ac˚ss
,

227 
IORegi⁄
 **
ªgi⁄På
)

228 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

231 
	$gëSögÀFûeLayoutRódî
(
SögÀFûeLayout
 *
sÊ
,

232 
LayoutRegi⁄
 *
Ã
,

233 
Buf„ªdRódî
 **
ªadîPå
)

234 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

237 
	$gëSögÀFûeLayoutWrôî
(
SögÀFûeLayout
 *
sÊ
,

238 
LayoutRegi⁄
 *
Ã
,

239 
Buf„ªdWrôî
 **
wrôîPå
)

240 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

253 
	$födL©e°IndexSaveSlŸ
(
SögÀFûeLayout
 *
sÊ
,

254 
ödexId
,

255 *
numZ⁄esPå
,

256 *
¶ŸPå
)

257 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

273 
	$£tupSögÀFûeIndexSaveSlŸ
(
SögÀFûeLayout
 *
sÊ
,

274 
ödexId
,

275 
numZ⁄es
,

276 
IndexSaveTy≥
 
ßveTy≥
,

277 *
ßveSlŸPå
)

278 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

281 
	$commôSögÀFûeIndexSave
(
SögÀFûeLayout
 *
sÊ
,

282 
ödexId
,

283 
ßveSlŸ
)

284 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

287 
	$ˇn˚lSögÀFûeIndexSave
(
SögÀFûeLayout
 *
sÊ
,

288 
ödexId
,

289 
ßveSlŸ
)

290 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

293 
	$disˇrdSögÀFûeIndexSaves
(
SögÀFûeLayout
 *
sÊ
,

294 
ödexId
,

295 
boﬁ
 
Æl
)

296 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

299 
	$vÆid©eIndexSaveLayout
(
IndexSaveLayout
 *
i¶
,

300 
uöt64_t
 
vﬁumeN⁄˚
,

301 
uöt64_t
 *
ßveTimePå
)

302 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

	@uds/sparseCache.c

109 
	~"•¨£Cache.h
"

111 
	~"ˇchedCh≠ãrIndex.h
"

112 
	~"ch≠ãrIndex.h
"

113 
	~"comm⁄.h
"

114 
	~"ödex.h
"

115 
	~"loggî.h
"

116 
	~"mem‹yAŒoc.h
"

117 
	~"≥rmas£π.h
"

118 
	~"£¨chLi°.h
"

119 
	~"thªads.h
"

120 
	~"utû/°©i°ic.h
"

121 
	~"z⁄e.h
"

125 
	mSKIP_SEARCH_THRESHOLD
 = 20000,

128 
	mZONE_ZERO
 = 0

137 
__©åibuã__
((
	tÆig√d
(
	tCACHE_LINE_BYTES
))Ë
	t•¨£CacheCou¡îs
 {

139 
uöt64_t
 
ch≠ãrHôs
;

142 
uöt64_t
 
ch≠ãrMis£s
;

145 
uöt64_t
 
£¨chHôs
;

148 
uöt64_t
 
£¨chMis£s
;

151 
uöt64_t
 
övÆid©i⁄s
;

154 
uöt64_t
 
evi˘i⁄s
;

155 
	}
} 
	tS∑r£CacheCou¡îs
;

163 
__©åibuã__
((
	$Æig√d
(
CACHE_LINE_BYTES
))Ë
•¨£CacheSèti°ics
 {

165 
Sèti°ic
 
£¨chHôsPîCh≠ãr
;

168 
Sèti°ic
 
£¨chMis£sPîCh≠ãr
;

171 
Sèti°ic
 
ch≠ãrsSórchedPîHô
;

174 
Sèti°ic
 
ch≠ãrsSórchedPîMiss
;

175 
	}
};

176 
•¨£CacheSèti°ics
 
	tS∑r£CacheSèti°ics
;

181 
	s•¨£Cache
 {

183 
	mˇ∑côy
;

186 
	mz⁄eCou¡
;

189 c⁄° 
Geomëry
 *
	mgeomëry
;

192 
	mskùSórchThªshﬁd
;

195 
SórchLi°
 *
	m£¨chLi°s
[
MAX_ZONES
];

198 
B¨rõr
 
	mbegöCacheUpd©e
;

199 
B¨rõr
 
	mídCacheUpd©e
;

202 
S∑r£CacheCou¡îs
 
	mcou¡îs
;

205 
S∑r£CacheSèti°ics
 
	m°©i°ics
;

208 
CachedCh≠ãrIndex
 
	mch≠ãrs
[];

221 
__©åibuã__
((
w¨n_unu£d_ªsu…
))

222 
	$öôülizeS∑r£Cache
(
S∑r£Cache
 *
ˇche
,

223 c⁄° 
Geomëry
 *
geomëry
,

224 
ˇ∑côy
,

225 
z⁄eCou¡
)

227 
ˇche
->
geomëry
 = geometry;

228 
ˇche
->
ˇ∑côy
 = capacity;

229 
ˇche
->
z⁄eCou¡
 = zoneCount;

233 
ˇche
->
skùSórchThªshﬁd
 = (
SKIP_SEARCH_THRESHOLD
 / 
z⁄eCou¡
);

235 
ªsu…
 = 
	`öôülizeB¨rõr
(&
ˇche
->
begöCacheUpd©e
, 
z⁄eCou¡
);

236 i‡(
ªsu…
 !
UDS_SUCCESS
) {

237  
ªsu…
;

239 
ªsu…
 = 
	`öôülizeB¨rõr
(&
ˇche
->
ídCacheUpd©e
, 
z⁄eCou¡
);

240 i‡(
ªsu…
 !
UDS_SUCCESS
) {

241  
ªsu…
;

243 
i
 = 0; i < 
ˇ∑côy
; i++) {

244 
ªsu…
 = 
	`öôülizeCachedCh≠ãrIndex
(&
ˇche
->
ch≠ãrs
[
i
], 
geomëry
);

245 i‡(
ªsu…
 !
UDS_SUCCESS
) {

246  
ªsu…
;

251 
i
 = 0; i < 
z⁄eCou¡
; i++) {

252 
ªsu…
 = 
	`makeSórchLi°
(
ˇ∑côy
, &
ˇche
->
£¨chLi°s
[
i
]);

253 i‡(
ªsu…
 !
UDS_SUCCESS
) {

254  
ªsu…
;

258 
	`ª£tSèti°ic
(&
ˇche
->
°©i°ics
.
£¨chHôsPîCh≠ãr
);

259 
	`ª£tSèti°ic
(&
ˇche
->
°©i°ics
.
£¨chMis£sPîCh≠ãr
);

260 
	`ª£tSèti°ic
(&
ˇche
->
°©i°ics
.
ch≠ãrsSórchedPîHô
);

261 
	`ª£tSèti°ic
(&
ˇche
->
°©i°ics
.
ch≠ãrsSórchedPîMiss
);

263  
UDS_SUCCESS
;

264 
	}
}

267 
	$makeS∑r£Cache
(c⁄° 
Geomëry
 *
geomëry
,

268 
ˇ∑côy
,

269 
z⁄eCou¡
,

270 
S∑r£Cache
 **
ˇchePå
)

272 
byãs


273 ((
S∑r£Cache
Ë+ (
ˇ∑côy
 * (
CachedCh≠ãrIndex
)));

275 
S∑r£Cache
 *
ˇche
;

276 
ªsu…
 = 
	`ÆloˇãCacheAlig√d
(
byãs
, "•¨£ cache", &
ˇche
);

277 i‡(
ªsu…
 !
UDS_SUCCESS
) {

278  
ªsu…
;

281 
ªsu…
 = 
	`öôülizeS∑r£Cache
(
ˇche
, 
geomëry
, 
ˇ∑côy
, 
z⁄eCou¡
);

282 i‡(
ªsu…
 !
UDS_SUCCESS
) {

283 
	`‰ìS∑r£Cache
(
ˇche
);

284  
ªsu…
;

287 *
ˇchePå
 = 
ˇche
;

288  
UDS_SUCCESS
;

289 
	}
}

292 
size_t
 
	$gëS∑r£CacheMem‹ySize
(c⁄° 
S∑r£Cache
 *
ˇche
)

295 
size_t
 
∑geSize
 = ((
Ch≠ãrIndexPage
Ë+ 
ˇche
->
geomëry
->
byãsPîPage
);

296 
size_t
 
ch≠ãrSize
 = (
∑geSize
 * 
ˇche
->
geomëry
->
ödexPagesPîCh≠ãr
);

297  (
ˇche
->
ˇ∑côy
 * 
ch≠ãrSize
);

298 
	}
}

307 
	$sc‹eCh≠ãrHô
(
S∑r£Cache
 *
ˇche
,

308 
CachedCh≠ãrIndex
 *
ch≠ãr
)

310 
ˇche
->
cou¡îs
.
ch≠ãrHôs
 += 1;

311 
	`£tSkùSórch
(
ch≠ãr
, 
Ál£
);

312 
	}
}

319 
	$sc‹eCh≠ãrMiss
(
S∑r£Cache
 *
ˇche
)

321 
ˇche
->
cou¡îs
.
ch≠ãrMis£s
 += 1;

322 
	}
}

331 
	$sc‹eEvi˘i⁄
(
S∑r£Cache
 *
ˇche
,

332 
CachedCh≠ãrIndex
 *
ch≠ãr
)

334 i‡(
ch≠ãr
->
vútuÆCh≠ãr
 =
UINT64_MAX
) {

337 i‡(!
ch≠ãr
->
övÆid
) {

338 
ˇche
->
cou¡îs
.
evi˘i⁄s
 += 1;

345 
	`ßm∂eSèti°ic
(&
ˇche
->
°©i°ics
.
£¨chHôsPîCh≠ãr
,

346 
ch≠ãr
->
cou¡îs
.
£¨chHôs
);

347 
	`ßm∂eSèti°ic
(&
ˇche
->
°©i°ics
.
£¨chMis£sPîCh≠ãr
,

348 
ch≠ãr
->
cou¡îs
.
£¨chMis£s
);

349 
	}
}

358 
	$sc‹eSórchHô
(
S∑r£Cache
 *
ˇche
,

359 
CachedCh≠ãrIndex
 *
ch≠ãr
)

361 
ˇche
->
cou¡îs
.
£¨chHôs
 += 1;

362 
ch≠ãr
->
cou¡îs
.
£¨chHôs
 += 1;

363 
ch≠ãr
->
cou¡îs
.
c⁄£cutiveMis£s
 = 0;

364 
	`£tSkùSórch
(
ch≠ãr
, 
Ál£
);

365 
	}
}

375 
	$sc‹eSórchMiss
(
S∑r£Cache
 *
ˇche
,

376 
CachedCh≠ãrIndex
 *
ch≠ãr
)

378 
ˇche
->
cou¡îs
.
£¨chMis£s
 += 1;

379 
ch≠ãr
->
cou¡îs
.
£¨chMis£s
 += 1;

380 
ch≠ãr
->
cou¡îs
.
c⁄£cutiveMis£s
 += 1;

381 i‡(
ch≠ãr
->
cou¡îs
.
c⁄£cutiveMis£s
 > 
ˇche
->
skùSórchThªshﬁd
) {

382 
	`£tSkùSórch
(
ch≠ãr
, 
åue
);

384 
	}
}

387 
	$‰ìS∑r£Cache
(
S∑r£Cache
 *
ˇche
)

389 i‡(
ˇche
 =
NULL
) {

393 
i
 = 0; i < 
ˇche
->
z⁄eCou¡
; i++) {

394 
	`‰ìSórchLi°
(&
ˇche
->
£¨chLi°s
[
i
]);

397 
i
 = 0; i < 
ˇche
->
ˇ∑côy
; i++) {

398 
CachedCh≠ãrIndex
 *
ch≠ãr
 = &
ˇche
->
ch≠ãrs
[
i
];

400 
	`sc‹eEvi˘i⁄
(
ˇche
, 
ch≠ãr
);

401 
	`de°royCachedCh≠ãrIndex
(
ch≠ãr
);

404 
	`logSèti°ic
(&
ˇche
->
°©i°ics
.
£¨chHôsPîCh≠ãr
,

406 
	`logSèti°ic
(&
ˇche
->
°©i°ics
.
£¨chMis£sPîCh≠ãr
,

408 
	`logSèti°ic
(&
ˇche
->
°©i°ics
.
ch≠ãrsSórchedPîHô
,

410 
	`logSèti°ic
(&
ˇche
->
°©i°ics
.
ch≠ãrsSórchedPîMiss
,

413 
	`de°royB¨rõr
(&
ˇche
->
begöCacheUpd©e
);

414 
	`de°royB¨rõr
(&
ˇche
->
ídCacheUpd©e
);

415 
	`FREE
(
ˇche
);

416 
	}
}

419 
CacheCou¡îs
 
	$gëS∑r£CacheCou¡îs
(c⁄° 
S∑r£Cache
 *
ˇche
)

421 
CacheCou¡îs
 
cou¡îs
 = {

422 .
•¨£Ch≠ãrs
 = {

423 .
hôs
 = 
ˇche
->
cou¡îs
.
ch≠ãrHôs
,

424 .
mis£s
 = 
ˇche
->
cou¡îs
.
ch≠ãrMis£s
,

426 .
•¨£Sórches
 = {

427 .
hôs
 = 
ˇche
->
cou¡îs
.
£¨chHôs
,

428 .
mis£s
 = 
ˇche
->
cou¡îs
.
£¨chMis£s
,

430 .
evi˘i⁄s
 = 
ˇche
->
cou¡îs
.evictions,

431 .
expú©i⁄s
 = 
ˇche
->
cou¡îs
.
övÆid©i⁄s
,

433  
cou¡îs
;

434 
	}
}

437 
boﬁ
 
	$•¨£CacheC⁄èös
(
S∑r£Cache
 *
ˇche
,

438 
uöt64_t
 
vútuÆCh≠ãr
,

439 
z⁄eNumbî
)

451 
SórchLi°Iãøt‹
 
ôî©‹


452 
	`ôî©eSórchLi°
(
ˇche
->
£¨chLi°s
[
z⁄eNumbî
], cache->
ch≠ãrs
);

453 
	`hasNextCh≠ãr
(&
ôî©‹
)) {

454 
CachedCh≠ãrIndex
 *
ch≠ãr
 = 
	`gëNextCh≠ãr
(&
ôî©‹
);

455 i‡(
vútuÆCh≠ãr
 =
ch≠ãr
->virtualChapter) {

456 i‡(
z⁄eNumbî
 =
ZONE_ZERO
) {

457 
	`sc‹eCh≠ãrHô
(
ˇche
, 
ch≠ãr
);

461 
	`rŸ©eSórchLi°
(
ôî©‹
.
li°
, iãøt‹.
√xtE¡ry
);

462  
åue
;

467 i‡(
z⁄eNumbî
 =
ZONE_ZERO
) {

468 
	`sc‹eCh≠ãrMiss
(
ˇche
);

470  
Ál£
;

471 
	}
}

474 
	$upd©eS∑r£Cache
(
S∑r£Cache
 *
ˇche
,

475 
uöt64_t
 
vútuÆCh≠ãr
,

476 c⁄° 
Index
 *
ödex
,

477 
z⁄eNumbî
)

481 i‡(
	`•¨£CacheC⁄èös
(
ˇche
, 
vútuÆCh≠ãr
, 
z⁄eNumbî
)) {

482  
UDS_SUCCESS
;

487 
	`íãrB¨rõr
(&
ˇche
->
begöCacheUpd©e
, 
NULL
);

497 
ªsu…
 = 
UDS_SUCCESS
;

498 i‡(
z⁄eNumbî
 =
ZONE_ZERO
) {

500 
SórchLi°
 *
z⁄eZîoLi°
 = 
ˇche
->
£¨chLi°s
[
ZONE_ZERO
];

501 
	`purgeSórchLi°
(
z⁄eZîoLi°
, 
ˇche
->
ch≠ãrs
);

505 i‡(
vútuÆCh≠ãr
 >
ödex
->
ﬁde°VútuÆCh≠ãr
) {

508 
CachedCh≠ãrIndex
 *
vi˘im


509 &
ˇche
->
ch≠ãrs
[
	`rŸ©eSórchLi°
(
z⁄eZîoLi°
, cache->
ˇ∑côy
)];

513 
	`sc‹eEvi˘i⁄
(
ˇche
, 
vi˘im
);

516 
ªsu…
 = 
	`ˇcheCh≠ãrIndex
(
vi˘im
, 
vútuÆCh≠ãr
, 
ödex
->
vﬁume
);

521 
z⁄e
 = 1; z⁄ê< 
ˇche
->
z⁄eCou¡
; zone++) {

522 
	`c›ySórchLi°
(
z⁄eZîoLi°
, 
ˇche
->
£¨chLi°s
[
z⁄e
]);

529 
	`íãrB¨rõr
(&
ˇche
->
ídCacheUpd©e
, 
NULL
);

530  
ªsu…
;

531 
	}
}

534 
	$övÆid©eCachedCh≠ãr
(
S∑r£Cache
 *
ˇche
,

535 
CachedCh≠ãrIndex
 *
ch≠ãr
)

538 i‡((
ch≠ãr
->
vútuÆCh≠ãr
 =
UINT64_MAX
Ë|| ch≠ãr->
övÆid
) {

544 
ch≠ãr
->
övÆid
 = 
åue
;

548 
ˇche
->
cou¡îs
.
övÆid©i⁄s
 += 1;

552 
	}
}

555 
	$övÆid©eS∑r£Cache
(
S∑r£Cache
 *
ˇche
)

557 i‡(
ˇche
 =
NULL
) {

560 
i
 = 0; i < 
ˇche
->
ˇ∑côy
; i++) {

561 
	`övÆid©eCachedCh≠ãr
(
ˇche
, &ˇche->
ch≠ãrs
[
i
]);

563 
	}
}

566 
	$övÆid©eS∑r£CacheCh≠ãr
(
S∑r£Cache
 *
ˇche
,

567 
uöt64_t
 
vútuÆCh≠ãr
)

569 i‡(
ˇche
 =
NULL
) {

572 
i
 = 0; i < 
ˇche
->
ˇ∑côy
; i++) {

573 
CachedCh≠ãrIndex
 *
ch≠ãr
 = &
ˇche
->
ch≠ãrs
[
i
];

574 i‡(
vútuÆCh≠ãr
 =
ch≠ãr
->virtualChapter) {

575 
	`övÆid©eCachedCh≠ãr
(
ˇche
, 
ch≠ãr
);

579 
	}
}

582 
	$£¨chS∑r£Cache
(
S∑r£Cache
 *
ˇche
,

583 c⁄° 
IndexPageM≠
 *
ödexPageM≠
,

584 c⁄° 
UdsChunkName
 *
«me
,

585 
z⁄eNumbî
,

586 
uöt64_t
 *
vútuÆCh≠ãrPå
,

587 *
ªc‹dPagePå
)

590 
boﬁ
 
£¨chAŒ
 = (*
vútuÆCh≠ãrPå
 =
UINT64_MAX
);

591 
ch≠ãrsSórched
 = 0;

595 
SórchLi°Iãøt‹
 
ôî©‹


596 
	`ôî©eSórchLi°
(
ˇche
->
£¨chLi°s
[
z⁄eNumbî
], cache->
ch≠ãrs
);

597 
	`hasNextCh≠ãr
(&
ôî©‹
)) {

598 
CachedCh≠ãrIndex
 *
ch≠ãr
 = 
	`gëNextCh≠ãr
(&
ôî©‹
);

601 i‡(
	`shouldSkùCh≠ãrIndex
(
ch≠ãr
, *
vútuÆCh≠ãrPå
)) {

605 
ªsu…
 = 
	`£¨chCachedCh≠ãrIndex
(
ch≠ãr
, 
ˇche
->
geomëry
,

606 
ödexPageM≠
, 
«me
, 
ªc‹dPagePå
);

607 i‡(
ªsu…
 !
UDS_SUCCESS
) {

608  
ªsu…
;

610 
ch≠ãrsSórched
 += 1;

613 i‡(*
ªc‹dPagePå
 !
NO_CHAPTER_INDEX_ENTRY
) {

614 i‡(
z⁄eNumbî
 =
ZONE_ZERO
) {

615 
	`ßm∂eSèti°ic
(&
ˇche
->
°©i°ics
.
ch≠ãrsSórchedPîHô
,

616 
ch≠ãrsSórched
);

617 
	`sc‹eSórchHô
(
ˇche
, 
ch≠ãr
);

621 
	`rŸ©eSórchLi°
(
ôî©‹
.
li°
, iãøt‹.
√xtE¡ry
);

626 *
vútuÆCh≠ãrPå
 = 
ch≠ãr
->
vútuÆCh≠ãr
;

627  
UDS_SUCCESS
;

630 i‡(
z⁄eNumbî
 =
ZONE_ZERO
) {

631 
	`sc‹eSórchMiss
(
ˇche
, 
ch≠ãr
);

634 i‡(!
£¨chAŒ
) {

643 i‡((
z⁄eNumbî
 =
ZONE_ZERO
Ë&& (
ch≠ãrsSórched
 > 0)) {

644 
	`ßm∂eSèti°ic
(&
ˇche
->
°©i°ics
.
ch≠ãrsSórchedPîMiss
,

645 
ch≠ãrsSórched
);

649 *
ªc‹dPagePå
 = 
NO_CHAPTER_INDEX_ENTRY
;

650  
UDS_SUCCESS
;

651 
	}
}

	@uds/sparseCache.h

22 #i‚de‡
SPARSE_CACHE_H


23 
	#SPARSE_CACHE_H


	)

25 
	~"ˇcheCou¡îs.h
"

26 
	~"geomëry.h
"

27 
	~"ödexPageM≠.h
"

28 
	~"ty≥Defs.h
"

42 
•¨£Cache
 
	tS∑r£Cache
;

45 
	gödex
;

57 
	$makeS∑r£Cache
(c⁄° 
Geomëry
 *
geomëry
,

58 
ˇ∑côy
,

59 
z⁄eCou¡
,

60 
S∑r£Cache
 **
ˇchePå
)

61 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

68 
	`‰ìS∑r£Cache
(
S∑r£Cache
 *
ˇche
);

75 
size_t
 
	`gëS∑r£CacheMem‹ySize
(c⁄° 
S∑r£Cache
 *
ˇche
);

84 
CacheCou¡îs
 
	`gëS∑r£CacheCou¡îs
(c⁄° 
S∑r£Cache
 *
ˇche
);

96 
boﬁ
 
	`•¨£CacheC⁄èös
(
S∑r£Cache
 *
ˇche
,

97 
uöt64_t
 
vútuÆCh≠ãr
,

98 
z⁄eNumbî
);

115 
	$upd©eS∑r£Cache
(
S∑r£Cache
 *
ˇche
,

116 
uöt64_t
 
vútuÆCh≠ãr
,

117 c⁄° 
ödex
 *index,

118 
z⁄eNumbî
)

119 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

129 
	`övÆid©eS∑r£Cache
(
S∑r£Cache
 *
ˇche
);

140 
	`övÆid©eS∑r£CacheCh≠ãr
(
S∑r£Cache
 *
ˇche
,

141 
uöt64_t
 
vútuÆCh≠ãr
);

162 
	$£¨chS∑r£Cache
(
S∑r£Cache
 *
ˇche
,

163 c⁄° 
IndexPageM≠
 *
ödexPageM≠
,

164 c⁄° 
UdsChunkName
 *
«me
,

165 
z⁄eNumbî
,

166 
uöt64_t
 *
vútuÆCh≠ãrPå
,

167 *
ªc‹dPagePå
)

168 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

	@uds/stringDefs.h

22 #i‚de‡
LINUX_KERNEL_STRING_DEFS_H


23 
	#LINUX_KERNEL_STRING_DEFS_H


	)

25 
	~<löux/kî√l.h
>

26 
	~<löux/°rög.h
>

	@uds/stringLinuxKernel.c

22 
	~<löux/mm.h
>

24 
	~"îr‹s.h
"

25 
	~"loggî.h
"

26 
	~"°rögUtûs.h
"

29 
	$°rögToSig√dL⁄g
(c⁄° *
≈å
, *
num
)

31 *
≈å
 == ' ') {

32 
≈å
++;

34  
	`k°πﬁ
(
≈å
, 10, 
num
Ë? 
UDS_INVALID_ARGUMENT
 : 
UDS_SUCCESS
;

35 
	}
}

38 
	$°rögToUnsig√dL⁄g
(c⁄° *
≈å
, *
num
)

40 *
≈å
 == ' ') {

41 
≈å
++;

43 i‡(*
≈å
 == '+') {

44 
≈å
++;

46  
	`k°πoul
(
≈å
, 10, 
num
Ë? 
UDS_INVALID_ARGUMENT
 : 
UDS_SUCCESS
;

47 
	}
}

50 *
	$√xtTokí
(*
°r
, c⁄° *
dñims
, **
°©e
)

52 *
•
 = 
°r
 ? så : *
°©e
;

53 *
•
 && 
	`°rchr
(
dñims
, *sp)) {

54 ++
•
;

56 i‡(!*
•
) {

57  
NULL
;

59 *
ï
 = 
•
;

60 *
ï
 && !
	`°rchr
(
dñims
, *ep)) {

61 ++
ï
;

63 i‡(*
ï
) {

64 *
ï
++ = '\0';

66 *
°©e
 = 
ï
;

67  
•
;

68 
	}
}

71 
	$∑r£Uöt64
(c⁄° *
°r
, 
uöt64_t
 *
num
)

73 
vÆue
 = *
num
;

74 
ªsu…
 = 
	`°rögToUnsig√dL⁄g
(
°r
, &
vÆue
);

75 *
num
 = 
vÆue
;

76  
ªsu…
;

77 
	}
}

	@uds/stringUtils.c

22 
	~"°rögUtûs.h
"

24 
	~"îr‹s.h
"

25 
	~"loggî.h
"

26 
	~"mem‹yAŒoc.h
"

27 
	~"≥rmas£π.h
"

28 
	~"uds.h
"

31 
	$ÆlocS¥ötf
(c⁄° *
wh©
, **
°Ω
, c⁄° *
fmt
, ...)

33 i‡(
°Ω
 =
NULL
) {

34  
UDS_INVALID_ARGUMENT
;

36 
va_li°
 
¨gs
;

37 
	`va_°¨t
(
¨gs
, 
fmt
);

38 
ªsu…
 = 
	`doPœtf‹mVa•rötf
(
°Ω
, 
fmt
, 
¨gs
);

39 
	`va_íd
(
¨gs
);

40 i‡((
ªsu…
 !
UDS_SUCCESS
Ë&& (
wh©
 !
NULL
)) {

41 
	`logEº‹
("ˇ¬ŸáŒoˇã %s", 
wh©
);

43  
ªsu…
;

44 
	}
}

47 
	$wøpV¢¥ötf
(c⁄° *
wh©
, *
buf
, 
size_t
 
bufSize
,

48 
îr‹
, c⁄° *
fmt
, 
va_li°
 
≠
, 
size_t
 *
√eded
)

50 i‡(
buf
 =
NULL
) {

51 
nobuf
[1];

52 
buf
 = 
nobuf
;

53 
bufSize
 = 0;

55 
n
 = 
	`v¢¥ötf
(
buf
, 
bufSize
, 
fmt
, 
≠
);

56 i‡(
n
 < 0) {

57  
	`logEº‹WôhSåögEº‹
(
UDS_UNEXPECTED_RESULT
,

58 "%s: v¢¥öt‡Áûed", 
wh©
);

60 i‡(
√eded
) {

61 *
√eded
 = 
n
;

63 i‡(((
size_t
Ë
n
 >
bufSize
Ë&& (
buf
 !
NULL
Ë&& (
îr‹
 !
UDS_SUCCESS
)) {

64  
	`logEº‹WôhSåögEº‹
(
îr‹
, "%s: såögÅoÿl⁄g", 
wh©
);

66  
UDS_SUCCESS
;

67 
	}
}

70 
	$fixedS¥ötf
(c⁄° *
wh©
,

71 *
buf
,

72 
size_t
 
bufSize
,

73 
îr‹
,

74 c⁄° *
fmt
,

77 i‡(
buf
 =
NULL
) {

78  
UDS_INVALID_ARGUMENT
;

80 
va_li°
 
¨gs
;

81 
	`va_°¨t
(
¨gs
, 
fmt
);

82 
ªsu…
 = 
	`wøpV¢¥ötf
(
wh©
, 
buf
, 
bufSize
, 
îr‹
, 
fmt
, 
¨gs
, 
NULL
);

83 
	`va_íd
(
¨gs
);

84  
ªsu…
;

85 
	}
}

88 *
	$vAµídToBuf„r
(*
buf„r
, *
bufEnd
, c⁄° *
fmt
, 
va_li°
 
¨gs
)

90 
size_t
 
n
 = 
	`v¢¥ötf
(
buf„r
, 
bufEnd
 - buf„r, 
fmt
, 
¨gs
);

91 i‡(
n
 >(
size_t
Ë(
bufEnd
 - 
buf„r
)) {

92 
buf„r
 = 
bufEnd
;

94 
buf„r
 +
n
;

96  
buf„r
;

97 
	}
}

100 *
	$≠≥ndToBuf„r
(*
buf„r
, *
bufEnd
, c⁄° *
fmt
, ...)

102 
va_li°
 
≠
;

104 
	`va_°¨t
(
≠
, 
fmt
);

105 *
pos
 = 
	`vAµídToBuf„r
(
buf„r
, 
bufEnd
, 
fmt
, 
≠
);

106 
	`va_íd
(
≠
);

107  
pos
;

108 
	}
}

	@uds/stringUtils.h

22 #i‚de‡
STRING_UTILS_H


23 
	#STRING_UTILS_H


	)

25 
	~<°d¨g.h
>

27 
	~"compûî.h
"

28 
	~"°rögDefs.h
"

29 
	~"ty≥Defs.h
"

38 
INLINE
 c⁄° *
	$boﬁToSåög
(
boﬁ
 
vÆue
)

40  (
vÆue
 ? "true" : "false");

41 
	}
}

53 
	$ÆlocS¥ötf
(c⁄° *
wh©
, **
°Ω
, c⁄° *
fmt
, ...)

54 
	`__©åibuã__
((
	`f‹m©
(
¥ötf
, 3, 4), 
w¨n_unu£d_ªsu…
));

68 
	$fixedS¥ötf
(c⁄° *
wh©
, *
buf
, 
size_t
 
bufSize
,

69 
îr‹
, c⁄° *
fmt
, ...)

70 
	`__©åibuã__
((
	`f‹m©
(
¥ötf
, 5, 6), 
w¨n_unu£d_ªsu…
));

93 
	$wøpV¢¥ötf
(c⁄° *
wh©
, *
buf
, 
size_t
 
bufSize
,

94 
îr‹
, c⁄° *
fmt
, 
va_li°
 
≠
, 
size_t
 *
√eded
)

95 
	`__©åibuã__
((
	`f‹m©
(
¥ötf
, 5, 0), 
w¨n_unu£d_ªsu…
));

108 *
	$≠≥ndToBuf„r
(*
buf„r
, *
bufEnd
, c⁄° *
fmt
, ...)

109 
	`__©åibuã__
((
	`f‹m©
(
¥ötf
, 3, 4)));

123 *
	$vAµídToBuf„r
(*
buf„r
, *
bufEnd
, c⁄° *
fmt
, 
va_li°
 
¨gs
)

124 
	`__©åibuã__
((
	`f‹m©
(
¥ötf
, 3, 0)));

137 *
	`√xtTokí
(*
°r
, c⁄° *
dñims
, **
°©ePå
);

148 
	$∑r£Uöt64
(c⁄° *
°r
, 
uöt64_t
 *
num
)

149 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

159 
	$°rögToSig√dL⁄g
(c⁄° *
≈å
, *
num
)

160 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

170 
	$°rögToUnsig√dL⁄g
(c⁄° *
≈å
, *
num
)

171 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

	@uds/sysfs.c

22 
	~"sysfs.h
"

24 
	~<löux/kobje˘.h
>

25 
	~<löux/moduÀ.h
>

27 
	~"loggî.h
"

28 
	~"mem‹yAŒoc.h
"

29 
	~"nŸifiˇti⁄Defs.h
"

30 
	~"°rögUtûs.h
"

31 
	~"uds.h
"

32 
	~"uds-∑øm.h
"

35 
kobje˘
 
	mkobj
;

36 
kobje˘
 
	mc⁄figuøti⁄Kobj
;

37 
kobje˘
 
	mödexKobj
;

38 
kobje˘
 
	m∑ømëîKobj
;

41 
•ölock_t
 
	mlock
;

42 
c⁄figuøti⁄Obje˘
 *
	mc⁄figuøti⁄Hód
;

43 
ödexObje˘
 *
	mödexHód
;

44 
£ssi⁄Name
 *
	m£ssi⁄Hód
;

46 
boﬁ
 
	mÊag
;

47 
boﬁ
 
	mc⁄figuøti⁄Fœg
;

48 
boﬁ
 
	mödexFœg
;

49 
boﬁ
 
	m∑ømëîFœg
;

50 
boﬁ
 
	mshutdownFœg
;

51 } 
	gobje˘RoŸ
;

53 
ssize_t
 
√wIndexSessi⁄
(
UdsIndexSessi⁄
 
£ssi⁄
, c⁄° *
«me
);

56 *
	$buf„rToSåög
(c⁄° *
buf
, 
size_t
 
Àngth
)

58 *
°rög
;

59 i‡(
	`ALLOCATE
(
Àngth
 + 1, , 
__func__
, &
°rög
Ë!
UDS_SUCCESS
) {

60  
NULL
;

62 
	`mem˝y
(
°rög
, 
buf
, 
Àngth
);

63 
°rög
[
Àngth
] = '\0';

64 i‡(
°rög
[
Àngth
 - 1] == '\n') {

65 
°rög
[
Àngth
 - 1] = '\0';

67  
°rög
;

68 
	}
}

75 
	s£ssi⁄Name
 {

76 
UdsIndexSessi⁄
 
	mödexSessi⁄
;

77 c⁄° *
	m«me
;

78 
£ssi⁄Name
 *
	m√xt
;

79 } 
	tSessi⁄Name
;

82 
Sessi⁄Name
 **
	$födSessi⁄Name
(
UdsIndexSessi⁄
 
£ssi⁄
)

84 
Sessi⁄Name
 *
¢
, **
p¢
;

85 
p¢
 = &
obje˘RoŸ
.
£ssi⁄Hód
; (
¢
 = *p¢Ë!
NULL
;Ö¢ = &¢->
√xt
) {

86 i‡(
¢
->
ödexSessi⁄
.
id
 =
£ssi⁄
.id) {

87  
p¢
;

90  
NULL
;

91 
	}
}

94 
	$nŸifyIndexClo£d
(
UdsIndexSessi⁄
 
£ssi⁄
)

96 
Sessi⁄Name
 *
¢
 = 
NULL
;

97 
	`•ö_lock_úq
(&
obje˘RoŸ
.
lock
);

98 
Sessi⁄Name
 **
p¢
 = 
	`födSessi⁄Name
(
£ssi⁄
);

99 i‡(
p¢
 !
NULL
) {

100 
¢
 = *
p¢
;

101 *
p¢
 = 
¢
->
√xt
;

103 
	`•ö_u∆ock_úq
(&
obje˘RoŸ
.
lock
);

104 i‡(
¢
 !
NULL
) {

105 
	`‰ìC⁄°
(
¢
->
«me
);

106 
	`FREE
(
¢
);

108 
	}
}

111 
	$nŸifyIndexO≥√d
(
UdsIndexSessi⁄
 
£ssi⁄
, c⁄° *
«me
)

113 *
«meC›y
;

114 i‡(
	`du∂iˇãSåög
(
«me
, 
__func__
, &
«meC›y
Ë!
UDS_SUCCESS
) {

117 
Sessi⁄Name
 *
¢
;

118 i‡(
	`ALLOCATE
(1, 
Sessi⁄Name
, 
__func__
, &
¢
Ë!
UDS_SUCCESS
) {

119 
	`FREE
(
«meC›y
);

122 
¢
->
ödexSessi⁄
 = 
£ssi⁄
;

123 
¢
->
«me
 = 
«meC›y
;

124 
	`•ö_lock_úq
(&
obje˘RoŸ
.
lock
);

125 
¢
->
√xt
 = 
obje˘RoŸ
.
£ssi⁄Hód
;

126 
obje˘RoŸ
.
£ssi⁄Hód
 = 
¢
;

127 
	`•ö_u∆ock_úq
(&
obje˘RoŸ
.
lock
);

128 
	}
}

136 
	$em±yRñó£
(
kobje˘
 *
kobj
)

139 
	}
}

142 
ssize_t
 
	$em±yShow
(
kobje˘
 *
kobj
,

143 
©åibuã
 *
©å
,

144 *
buf
)

147 
	}
}

150 
ssize_t
 
	$em±ySt‹e
(
kobje˘
 *
kobj
,

151 
©åibuã
 *
©å
,

152 c⁄° *
buf
,

153 
size_t
 
Àngth
)

155  
Àngth
;

156 
	}
}

158 
sysfs_›s
 
	gem±yOps
 = {

159 .
show
 = 
em±yShow
,

160 .
	g°‹e
 = 
em±ySt‹e
,

163 
©åibuã
 *
	gem±yAârs
[] = {

164 
NULL
,

167 
kobj_ty≥
 
	gem±yObje˘Ty≥
 = {

168 .
ªÀa£
 = 
em±yRñó£
,

169 .
	gsysfs_›s
 = &
em±yOps
,

170 .
	gdeÁu…_©ås
 = 
em±yAârs
,

196 
	sc⁄figuøti⁄Obje˘
 {

197 
kobje˘
 
	mkobj
;

198 
UdsC⁄figuøti⁄
 
	mu£rC⁄fig
;

199 
c⁄figuøti⁄Obje˘
 *
	m√xt
;

200 } 
	tC⁄figuøti⁄Obje˘
;

203 
©åibuã
 
	m©å
;

204 
ssize_t
 (*
showStuff
)(
	mUdsC⁄figuøti⁄
, *);

205 (*
	mshowUöt
)(
	mUdsC⁄figuøti⁄
);

206 
ssize_t
 (*
°‹eStuff
)(
	mC⁄figuøti⁄Obje˘
 *, const *);

207 
ssize_t
 (*
°‹eUöt
)(
	mUdsC⁄figuøti⁄
, );

208 } 
	tC⁄figuøti⁄Aâribuã
;

211 
	$c⁄figuøti⁄Rñó£
(
kobje˘
 *
kobj
)

213 
C⁄figuøti⁄Obje˘
 *
co
 = 
	`c⁄èöî_of
(
kobj
, ConfigurationObject, kobj);

214 
	`udsFªeC⁄figuøti⁄
(
co
->
u£rC⁄fig
);

215 
	`FREE
(
co
);

216 
	}
}

219 
ssize_t
 
	$c⁄figuøti⁄Show
(
kobje˘
 *
kobj
,

220 
©åibuã
 *
©å
,

221 *
buf
)

223 
C⁄figuøti⁄Aâribuã
 *
ˇ
 = 
	`c⁄èöî_of
(
©å
, ConfigurationAttribute,áttr);

224 
C⁄figuøti⁄Obje˘
 *
co
 = 
	`c⁄èöî_of
(
kobj
, ConfigurationObject, kobj);

225 i‡(
ˇ
->
showStuff
 !
NULL
) {

226  
ˇ
->
	`showStuff
(
co
->
u£rC⁄fig
, 
buf
);

227 } i‡(
ˇ
->
showUöt
 !
NULL
) {

228  
	`•rötf
(
buf
, "%u\n", 
ˇ
->
	`showUöt
(
co
->
u£rC⁄fig
));

230  -
EINVAL
;

232 
	}
}

235 
	$c⁄figuøti⁄ShowC‰eq
(
UdsC⁄figuøti⁄
 
u£rC⁄fig
)

237  
	`udsC⁄figuøti⁄GëCheckpoötFªquícy
(
u£rC⁄fig
) ? 1 : 0;

238 
	}
}

241 
ssize_t
 
	$c⁄figuøti⁄ShowMem
(
UdsC⁄figuøti⁄
 
u£rC⁄fig
, *
buf
)

243 
mem
 = 
	`udsC⁄figuøti⁄GëMem‹y
(
u£rC⁄fig
);

244 i‡(
mem
 =
UDS_MEMORY_CONFIG_256MB
) {

245  
	`•rötf
(
buf
, "0.25\n");

246 } i‡(
mem
 =
UDS_MEMORY_CONFIG_512MB
) {

247  
	`•rötf
(
buf
, "0.5\n");

248 } i‡(
mem
 =
UDS_MEMORY_CONFIG_768MB
) {

249  
	`•rötf
(
buf
, "0.75\n");

251  
	`•rötf
(
buf
, "%u\n", 
mem
);

253 
	}
}

256 
ssize_t
 
	$c⁄figuøti⁄ShowSize
(
UdsC⁄figuøti⁄
 
u£rC⁄fig
, *
buf
)

258 
uöt64_t
 
size
;

259 
ªsu…
 = 
	`udsCompuãIndexSize
(
u£rC⁄fig
, 0, &
size
);

260 i‡(
ªsu…
 !
UDS_SUCCESS
) {

261 
	`logEº‹WôhSåögEº‹
(
ªsu…
, "error sizing index configuration");

262  
ªsu…
 < 
UDS_ERROR_CODE_BASE
 ? -ªsu… : -
EINVAL
;

264  
	`•rötf
(
buf
, "%" 
PRIu64
 "\n", 
size
);

265 
	}
}

268 
	$c⁄figuøti⁄ShowS∑r£
(
UdsC⁄figuøti⁄
 
u£rC⁄fig
)

270  
	`udsC⁄figuøti⁄GëS∑r£
(
u£rC⁄fig
) ? 1 : 0;

271 
	}
}

274 
ssize_t
 
	$c⁄figuøti⁄St‹e
(
kobje˘
 *
kobj
,

275 
©åibuã
 *
©å
,

276 c⁄° *
buf
,

277 
size_t
 
Àngth
)

279 
C⁄figuøti⁄Aâribuã
 *
ˇ
 = 
	`c⁄èöî_of
(
©å
, ConfigurationAttribute,áttr);

280 
C⁄figuøti⁄Obje˘
 *
co
 = 
	`c⁄èöî_of
(
kobj
, ConfigurationObject, kobj);

281 c⁄° *
°rög
 = 
	`buf„rToSåög
(
buf
, 
Àngth
);

282 i‡(
°rög
 =
NULL
) {

283  -
ENOMEM
;

285 
ssize_t
 
ªsu…
 = -
EINVAL
;

286 i‡(
ˇ
->
°‹eStuff
 !
NULL
) {

287 
ªsu…
 = 
ˇ
->
	`°‹eStuff
(
co
, 
°rög
);

288 } i‡(
ˇ
->
°‹eUöt
 !
NULL
) {

289 
numbî
;

290 i‡(
	`°rögToUnsig√dL⁄g
(
°rög
, &
numbî
Ë!
UDS_SUCCESS
) {

291 
ªsu…
 = -
EINVAL
;

292 } i‡(
numbî
 != ()Çumber) {

293 
ªsu…
 = -
EINVAL
;

295 
ªsu…
 = 
ˇ
->
	`°‹eUöt
(
co
->
u£rC⁄fig
, (Ë
numbî
);

298 
	`‰ìC⁄°
(
°rög
);

299  
ªsu…
 =0 ? 
Àngth
 :Ñesult;

300 
	}
}

303 
ssize_t
 
	$c⁄figuøti⁄Cª©eIndex
(
C⁄figuøti⁄Obje˘
 *
co
,

304 c⁄° *
°rög
)

306 
UdsIndexSessi⁄
 
£ssi⁄
;

307 
ªsu…
 = 
	`udsCª©eLoˇlIndex
(
°rög
, 
co
->
u£rC⁄fig
, &
£ssi⁄
);

308 i‡(
ªsu…
 !
UDS_SUCCESS
) {

309 
	`logEº‹WôhSåögEº‹
(
ªsu…
, "îr‹ cª©ög index \"%s\"", 
°rög
);

310  
ªsu…
 < 
UDS_ERROR_CODE_BASE
 ? -ªsu… : -
EINVAL
;

312  
	`√wIndexSessi⁄
(
£ssi⁄
, 
°rög
);

313 
	}
}

316 
ssize_t
 
	$c⁄figuøti⁄St‹eC‰eq
(
UdsC⁄figuøti⁄
 
u£rC⁄fig
,

317 
numbî
)

319 
ªsu…
 = 
	`udsC⁄figuøti⁄SëCheckpoötFªquícy
(
u£rC⁄fig
, 
numbî
);

320 i‡(
ªsu…
 !
UDS_SUCCESS
) {

321 
	`logEº‹WôhSåögEº‹
(
ªsu…
, "error setting checkpoint frequencyÅo %u",

322 
numbî
);

323  
ªsu…
 < 
UDS_ERROR_CODE_BASE
 ? -ªsu… : -
EINVAL
;

326 
	}
}

329 
ssize_t
 
	$c⁄figuøti⁄St‹eMem
(
C⁄figuøti⁄Obje˘
 *
co
,

330 c⁄° *
°rög
)

332 
UdsMem‹yC⁄figSize
 
mem
;

333 i‡(
	`°rcmp
(
°rög
, "0.25") == 0) {

334 
mem
 = 
UDS_MEMORY_CONFIG_256MB
;

335 } i‡(
	`°rcmp
(
°rög
, "0.5") == 0) {

336 
mem
 = 
UDS_MEMORY_CONFIG_512MB
;

337 } i‡(
	`°rcmp
(
°rög
, "0.75") == 0) {

338 
mem
 = 
UDS_MEMORY_CONFIG_768MB
;

340 
numbî
;

341 i‡(
	`°rögToUnsig√dL⁄g
(
°rög
, &
numbî
Ë!
UDS_SUCCESS
) {

342  -
EINVAL
;

344 
mem
 = 
numbî
;

345 i‡(
mem
 !
numbî
) {

346  -
EINVAL
;

349 
UdsC⁄figuøti⁄
 
ﬁdC⁄fig
 = 
co
->
u£rC⁄fig
;

350 
ªsu…
 = 
	`udsInôülizeC⁄figuøti⁄
(&
co
->
u£rC⁄fig
, 
mem
);

351 i‡(
ªsu…
 !
UDS_SUCCESS
) {

352 
	`logEº‹WôhSåögEº‹
(
ªsu…
, "error setting configuration sizeÅo %s",

353 
°rög
);

354  
ªsu…
 < 
UDS_ERROR_CODE_BASE
 ? -ªsu… : -
EINVAL
;

356 
	`udsFªeC⁄figuøti⁄
(
ﬁdC⁄fig
);

358 
	}
}

361 
ssize_t
 
	$c⁄figuøti⁄St‹eS∑r£
(
UdsC⁄figuøti⁄
 
u£rC⁄fig
,

362 
numbî
)

364 
	`udsC⁄figuøti⁄SëS∑r£
(
u£rC⁄fig
, 
numbî
 != 0);

366 
	}
}

370 
C⁄figuøti⁄Aâribuã
 
	gc‰eqAâr
 = {

371 .
©å
 = { .
«me
 = "checkpoöt_‰equícy", .
	gmode
 = 0666 },

372 .
	gshowUöt
 = 
c⁄figuøti⁄ShowC‰eq
,

373 .
	g°‹eUöt
 = 
c⁄figuøti⁄St‹eC‰eq
,

376 
C⁄figuøti⁄Aâribuã
 
	g¸óãIndexAâr
 = {

377 .
©å
 = { .
«me
 = "¸óã_ödex", .
	gmode
 = 0222 },

378 .
	g°‹eStuff
 = 
c⁄figuøti⁄Cª©eIndex
,

381 
C⁄figuøti⁄Aâribuã
 
	gmemAâr
 = {

382 .
©å
 = { .
«me
 = "mem", .
	gmode
 = 0666 },

383 .
	gshowStuff
 = 
c⁄figuøti⁄ShowMem
,

384 .
	g°‹eStuff
 = 
c⁄figuøti⁄St‹eMem
,

387 
C⁄figuøti⁄Aâribuã
 
	gsizeAâr
 = {

388 .
©å
 = { .
«me
 = "size", .
	gmode
 = 0444 },

389 .
	gshowStuff
 = 
c⁄figuøti⁄ShowSize
,

392 
C⁄figuøti⁄Aâribuã
 
	g•¨£Aâr
 = {

393 .
©å
 = { .
«me
 = "•¨£", .
	gmode
 = 0666 },

394 .
	gshowUöt
 = 
c⁄figuøti⁄ShowS∑r£
,

395 .
	g°‹eUöt
 = 
c⁄figuøti⁄St‹eS∑r£
,

398 
©åibuã
 *
	gc⁄figuøti⁄Aârs
[] = {

399 &
c‰eqAâr
.
©å
,

400 &
¸óãIndexAâr
.
©å
,

401 &
memAâr
.
©å
,

402 &
sizeAâr
.
©å
,

403 &
•¨£Aâr
.
©å
,

404 
NULL
,

407 
sysfs_›s
 
	gc⁄figuøti⁄Ops
 = {

408 .
show
 = 
c⁄figuøti⁄Show
,

409 .
	g°‹e
 = 
c⁄figuøti⁄St‹e
,

412 
kobj_ty≥
 
	gc⁄figuøti⁄Obje˘Ty≥
 = {

413 .
ªÀa£
 = 
c⁄figuøti⁄Rñó£
,

414 .
	gsysfs_›s
 = &
c⁄figuøti⁄Ops
,

415 .
	gdeÁu…_©ås
 = 
c⁄figuøti⁄Aârs
,

433 
C⁄figuøti⁄Aâribuã
 
	gc‰eqRoAâr
 = {

434 .
©å
 = { .
«me
 = "checkpoöt_‰equícy", .
	gmode
 = 0444 },

435 .
	gshowUöt
 = 
c⁄figuøti⁄ShowC‰eq
,

438 
C⁄figuøti⁄Aâribuã
 
	gmemRoAâr
 = {

439 .
©å
 = { .
«me
 = "mem", .
	gmode
 = 0444 },

440 .
	gshowStuff
 = 
c⁄figuøti⁄ShowMem
,

443 
C⁄figuøti⁄Aâribuã
 
	gsizeRoAâr
 = {

444 .
©å
 = { .
«me
 = "size", .
	gmode
 = 0444 },

445 .
	gshowStuff
 = 
c⁄figuøti⁄ShowSize
,

448 
C⁄figuøti⁄Aâribuã
 
	g•¨£RoAâr
 = {

449 .
©å
 = { .
«me
 = "•¨£", .
	gmode
 = 0444 },

450 .
	gshowUöt
 = 
c⁄figuøti⁄ShowS∑r£
,

453 
©åibuã
 *
	gc⁄figuøti⁄RoAârs
[] = {

454 &
c‰eqRoAâr
.
©å
,

455 &
memRoAâr
.
©å
,

456 &
sizeRoAâr
.
©å
,

457 &
•¨£RoAâr
.
©å
,

458 
NULL
,

461 
kobj_ty≥
 
	gc⁄figuøti⁄RoObje˘Ty≥
 = {

462 .
ªÀa£
 = 
c⁄figuøti⁄Rñó£
,

463 .
	gsysfs_›s
 = &
c⁄figuøti⁄Ops
,

464 .
	gdeÁu…_©ås
 = 
c⁄figuøti⁄RoAârs
,

526 
	södexObje˘
 {

527 
kobje˘
 
	mkobj
;

528 
kobje˘
 *
	mc⁄figuøti⁄Kobj
;

529 
UdsIndexSessi⁄
 
	mödexSessi⁄
;

530 
UdsBlockC⁄ãxt
 
	mblockC⁄ãxt
;

531 
boﬁ
 
	m›íedBySysfs
;

532 c⁄° *
	m«me
;

533 
ödexObje˘
 *
	m√xt
;

534 } 
	tIndexObje˘
;

537 
©åibuã
 
	m©å
;

538 
uöt64_t
 (*
showC⁄ãxtSèt
)(
	mUdsC⁄ãxtSèts
 *);

539 
uöt64_t
 (*
showIndexSèt
)(
	mUdsIndexSèts
 *);

540 c⁄° *(*
	mshowSåög
)(
	mIndexObje˘
 *);

541 (*
	mshowUöt
)(
	mIndexObje˘
 *);

542 
ssize_t
 (*
°‹eAny
)(
	mIndexObje˘
 *);

543 } 
	tIndexAâribuã
;

546 
	$ödexRñó£
(
kobje˘
 *
kobj
)

548 
IndexObje˘
 *
io
 = 
	`c⁄èöî_of
(
kobj
, IndexObject, kobj);

549 
	`‰ìC⁄°
(
io
->
«me
);

550 
	`FREE
(
io
);

551 
	}
}

554 
ssize_t
 
	$ödexShow
(
kobje˘
 *
kobj
,

555 
©åibuã
 *
©å
,

556 *
buf
)

558 
IndexAâribuã
 *
ü
 = 
	`c⁄èöî_of
(
©å
, IndexAttribute,áttr);

559 
IndexObje˘
 *
io
 = 
	`c⁄èöî_of
(
kobj
, IndexObject, kobj);

560 i‡(
ü
->
showC⁄ãxtSèt
 !
NULL
) {

561 
UdsC⁄ãxtSèts
 
°©s
;

562 
ªsu…
 = 
	`udsGëBlockC⁄ãxtSèts
(
io
->
blockC⁄ãxt
, &
°©s
);

563 i‡(
ªsu…
 !
UDS_SUCCESS
) {

564 
	`logEº‹WôhSåögEº‹
(
ªsu…
,

566 
io
->
«me
);

567  
ªsu…
 < 
UDS_ERROR_CODE_BASE
 ? -ªsu… : -
EINVAL
;

569  
	`•rötf
(
buf
, "%" 
PRIu64
 "\n", 
ü
->
	`showC⁄ãxtSèt
(&
°©s
));

570 } i‡(
ü
->
showIndexSèt
 !
NULL
) {

571 
UdsIndexSèts
 
°©s
;

572 
ªsu…
 = 
	`udsGëBlockC⁄ãxtIndexSèts
(
io
->
blockC⁄ãxt
, &
°©s
);

573 i‡(
ªsu…
 !
UDS_SUCCESS
) {

574 
	`logEº‹WôhSåögEº‹
(
ªsu…
, "error getting index stats for %s",

575 
io
->
«me
);

576  
ªsu…
 < 
UDS_ERROR_CODE_BASE
 ? -ªsu… : -
EINVAL
;

578  
	`•rötf
(
buf
, "%" 
PRIu64
 "\n", 
ü
->
	`showIndexSèt
(&
°©s
));

579 } i‡(
ü
->
showSåög
 !
NULL
) {

580  
	`•rötf
(
buf
, "%s\n", 
ü
->
	`showSåög
(
io
));

581 } i‡(
ü
->
showUöt
 !
NULL
) {

582  
	`•rötf
(
buf
, "%u\n", 
ü
->
	`showUöt
(
io
));

584  -
EINVAL
;

586 
	}
}

589 
uöt64_t
 
	$ödexShowCheckpoöts
(
UdsIndexSèts
 *
ödexSèts
)

591  
ödexSèts
->
checkpoöts
;

592 
	}
}

595 
uöt64_t
 
	$ödexShowCﬁlisi⁄s
(
UdsIndexSèts
 *
ödexSèts
)

597  
ödexSèts
->
cﬁlisi⁄s
;

598 
	}
}

601 
	$ödexShowC⁄ãxt
(
IndexObje˘
 *
io
)

603  
io
->
blockC⁄ãxt
.
id
;

604 
	}
}

607 
uöt64_t
 
	$ödexShowDñëi⁄sFound
(
UdsC⁄ãxtSèts
 *
c⁄ãxtSèts
)

609  
c⁄ãxtSèts
->
dñëi⁄sFound
;

610 
	}
}

613 
uöt64_t
 
	$ödexShowDñëi⁄sNŸFound
(
UdsC⁄ãxtSèts
 *
c⁄ãxtSèts
)

615  
c⁄ãxtSèts
->
dñëi⁄sNŸFound
;

616 
	}
}

619 
uöt64_t
 
	$ödexShowDiskU£d
(
UdsIndexSèts
 *
ödexSèts
)

621  
ödexSèts
->
diskU£d
;

622 
	}
}

625 
uöt64_t
 
	$ödexShowE¡rõsDisˇrded
(
UdsIndexSèts
 *
ödexSèts
)

627  
ödexSèts
->
íåõsDisˇrded
;

628 
	}
}

631 
uöt64_t
 
	$ödexShowE¡rõsIndexed
(
UdsIndexSèts
 *
ödexSèts
)

633  
ödexSèts
->
íåõsIndexed
;

634 
	}
}

637 
uöt64_t
 
	$ödexShowMem‹yU£d
(
UdsIndexSèts
 *
ödexSèts
)

639  
ödexSèts
->
mem‹yU£d
;

640 
	}
}

643 c⁄° *
	$ödexShowName
(
IndexObje˘
 *
io
)

645  
io
->
«me
;

646 
	}
}

649 
uöt64_t
 
	$ödexShowPo°sFound
(
UdsC⁄ãxtSèts
 *
c⁄ãxtSèts
)

651  
c⁄ãxtSèts
->
po°sFound
;

652 
	}
}

655 
uöt64_t
 
	$ödexShowPo°sNŸFound
(
UdsC⁄ãxtSèts
 *
c⁄ãxtSèts
)

657  
c⁄ãxtSèts
->
po°sNŸFound
;

658 
	}
}

661 
uöt64_t
 
	$ödexShowQuîõsFound
(
UdsC⁄ãxtSèts
 *
c⁄ãxtSèts
)

663  
c⁄ãxtSèts
->
quîõsFound
;

664 
	}
}

667 
uöt64_t
 
	$ödexShowQuîõsNŸFound
(
UdsC⁄ãxtSèts
 *
c⁄ãxtSèts
)

669  
c⁄ãxtSèts
->
quîõsNŸFound
;

670 
	}
}

673 
uöt64_t
 
	$ödexShowUpd©esFound
(
UdsC⁄ãxtSèts
 *
c⁄ãxtSèts
)

675  
c⁄ãxtSèts
->
upd©esFound
;

676 
	}
}

679 
uöt64_t
 
	$ödexShowUpd©esNŸFound
(
UdsC⁄ãxtSèts
 *
c⁄ãxtSèts
)

681  
c⁄ãxtSèts
->
upd©esNŸFound
;

682 
	}
}

685 
ssize_t
 
	$ödexSt‹e
(
kobje˘
 *
kobj
,

686 
©åibuã
 *
©å
,

687 c⁄° *
buf
,

688 
size_t
 
Àngth
)

690 
IndexAâribuã
 *
ü
 = 
	`c⁄èöî_of
(
©å
, IndexAttribute,áttr);

691 
IndexObje˘
 *
io
 = 
	`c⁄èöî_of
(
kobj
, IndexObject, kobj);

692 
ssize_t
 
ªsu…
 = -
EINVAL
;

693 i‡(
ü
->
°‹eAny
 !
NULL
) {

694 
ªsu…
 = 
ü
->
	`°‹eAny
(
io
);

696  
ªsu…
 =0 ? 
Àngth
 :Ñesult;

697 
	}
}

700 
ssize_t
 
	$ödexSt‹eFûl
(
IndexObje˘
 *
io
)

702 
cou¡
 = 128;

703 
£ed
 = 
	`__buûtö_bsw≠64
(
jiffõs
);

705 
UdsIndexSèts
 
°©s
;

706 
ªsu…
 = 
	`udsGëBlockC⁄ãxtIndexSèts
(
io
->
blockC⁄ãxt
, &
°©s
);

707 i‡(
ªsu…
 !
UDS_SUCCESS
) {

708 
	`logEº‹WôhSåögEº‹
(
ªsu…
, "error getting index stats for %s",

709 
io
->
«me
);

710  -
EIO
;

712 i‡(
°©s
.
íåõsDisˇrded
 > 0) {

714 
ªsu…
 = 
	`udsFlushBlockC⁄ãxt
(
io
->
blockC⁄ãxt
);

715 i‡(
ªsu…
 !
UDS_SUCCESS
) {

716 
	`logEº‹WôhSåögEº‹
(
ªsu…
, "îr‹ flushög %s", 
io
->
«me
);

717  -
EIO
;

721 
i
 = 0; i < 
cou¡
; i++) {

722 
UdsChunkName
 
«me
 = 
	`udsCÆcuœãMurmur3ChunkName
(&
£ed
, (seed));

723 
£ed
 += 1;

724 
ªsu…
 = 
	`udsPo°BlockName
(
io
->
blockC⁄ãxt
, 
NULL
, &
«me
, &name);

725 i‡(
ªsu…
 !
UDS_SUCCESS
) {

726 
	`logEº‹WôhSåögEº‹
(
ªsu…
, "îr‹Öo°ögÅÿ%s", 
io
->
«me
);

727  -
EIO
;

730 
cou¡
 = 1024;

732 
	}
}

736 
IndexAâribuã
 
	gcheckpoötsAâr
 = {

737 .
©å
 = { .
«me
 = "checkpoöts", .
	gmode
 = 0444 },

738 .
	gshowIndexSèt
 = 
ödexShowCheckpoöts
,

741 
IndexAâribuã
 
	gcﬁlisi⁄sAâr
 = {

742 .
©å
 = { .
«me
 = "cﬁlisi⁄s", .
	gmode
 = 0444 },

743 .
	gshowIndexSèt
 = 
ödexShowCﬁlisi⁄s
,

746 
IndexAâribuã
 
	gc⁄ãxtAâr
 = {

747 .
©å
 = { .
«me
 = "c⁄ãxt", .
	gmode
 = 0444 },

748 .
	gshowUöt
 = 
ödexShowC⁄ãxt
,

751 
IndexAâribuã
 
	gdñëi⁄sFoundAâr
 = {

752 .
©å
 = { .
«me
 = "dñëi⁄s_found", .
	gmode
 = 0444 },

753 .
	gshowC⁄ãxtSèt
 = 
ödexShowDñëi⁄sFound
,

756 
IndexAâribuã
 
	gdñëi⁄sNŸFoundAâr
 = {

757 .
©å
 = { .
«me
 = "dñëi⁄s_nŸ_found", .
	gmode
 = 0444 },

758 .
	gshowC⁄ãxtSèt
 = 
ödexShowDñëi⁄sNŸFound
,

761 
IndexAâribuã
 
	gdiskU£dAâr
 = {

762 .
©å
 = { .
«me
 = "disk_u£d", .
	gmode
 = 0444 },

763 .
	gshowIndexSèt
 = 
ödexShowDiskU£d
,

766 
IndexAâribuã
 
	gíåõsDisˇrdedAâr
 = {

767 .
©å
 = { .
«me
 = "íåõs_disˇrded", .
	gmode
 = 0444 },

768 .
	gshowIndexSèt
 = 
ödexShowE¡rõsDisˇrded
,

771 
IndexAâribuã
 
	gfûlAâr
 = {

772 .
©å
 = { .
«me
 = "fûl", .
	gmode
 = 0222 },

773 .
	g°‹eAny
 = 
ödexSt‹eFûl
,

776 
IndexAâribuã
 
	gíåõsIndexedAâr
 = {

777 .
©å
 = { .
«me
 = "íåõs_ödexed", .
	gmode
 = 0444 },

778 .
	gshowIndexSèt
 = 
ödexShowE¡rõsIndexed
,

781 
IndexAâribuã
 
	gmem‹yU£dAâr
 = {

782 .
©å
 = { .
«me
 = "mem‹y_u£d", .
	gmode
 = 0444 },

783 .
	gshowIndexSèt
 = 
ödexShowMem‹yU£d
,

786 
IndexAâribuã
 
	g«meAâr
 = {

787 .
©å
 = { .
«me
 = "«me", .
	gmode
 = 0444 },

788 .
	gshowSåög
 = 
ödexShowName
,

791 
IndexAâribuã
 
	gpo°sFoundAâr
 = {

792 .
©å
 = { .
«me
 = "po°s_found", .
	gmode
 = 0444 },

793 .
	gshowC⁄ãxtSèt
 = 
ödexShowPo°sFound
,

796 
IndexAâribuã
 
	gpo°sNŸFoundAâr
 = {

797 .
©å
 = { .
«me
 = "po°s_nŸ_found", .
	gmode
 = 0444 },

798 .
	gshowC⁄ãxtSèt
 = 
ödexShowPo°sNŸFound
,

801 
IndexAâribuã
 
	gquîõsFoundAâr
 = {

802 .
©å
 = { .
«me
 = "quîõs_found", .
	gmode
 = 0444 },

803 .
	gshowC⁄ãxtSèt
 = 
ödexShowQuîõsFound
,

806 
IndexAâribuã
 
	gquîõsNŸFoundAâr
 = {

807 .
©å
 = { .
«me
 = "quîõs_nŸ_found", .
	gmode
 = 0444 },

808 .
	gshowC⁄ãxtSèt
 = 
ödexShowQuîõsNŸFound
,

811 
IndexAâribuã
 
	gupd©esFoundAâr
 = {

812 .
©å
 = { .
«me
 = "upd©es_found", .
	gmode
 = 0444 },

813 .
	gshowC⁄ãxtSèt
 = 
ödexShowUpd©esFound
,

816 
IndexAâribuã
 
	gupd©esNŸFoundAâr
 = {

817 .
©å
 = { .
«me
 = "upd©es_nŸ_found", .
	gmode
 = 0444 },

818 .
	gshowC⁄ãxtSèt
 = 
ödexShowUpd©esNŸFound
,

821 
©åibuã
 *
	gödexAârs
[] = {

822 &
checkpoötsAâr
.
©å
,

823 &
cﬁlisi⁄sAâr
.
©å
,

824 &
c⁄ãxtAâr
.
©å
,

825 &
dñëi⁄sFoundAâr
.
©å
,

826 &
dñëi⁄sNŸFoundAâr
.
©å
,

827 &
diskU£dAâr
.
©å
,

828 &
íåõsDisˇrdedAâr
.
©å
,

829 &
íåõsIndexedAâr
.
©å
,

830 &
fûlAâr
.
©å
,

831 &
mem‹yU£dAâr
.
©å
,

832 &
«meAâr
.
©å
,

833 &
po°sFoundAâr
.
©å
,

834 &
po°sNŸFoundAâr
.
©å
,

835 &
quîõsFoundAâr
.
©å
,

836 &
quîõsNŸFoundAâr
.
©å
,

837 &
upd©esFoundAâr
.
©å
,

838 &
upd©esNŸFoundAâr
.
©å
,

839 
NULL
,

842 
sysfs_›s
 
	gödexOps
 = {

843 .
show
 = 
ödexShow
,

844 .
	g°‹e
 = 
ödexSt‹e
,

847 
kobj_ty≥
 
	gödexObje˘Ty≥
 = {

848 .
ªÀa£
 = 
ödexRñó£
,

849 .
	gsysfs_›s
 = &
ödexOps
,

850 .
	gdeÁu…_©ås
 = 
ödexAârs
,

864 
©åibuã
 
	m©å
;

865 c⁄° *
	m«me
;

866 c⁄° *(*
	mshowSåög
)();

867 (*
	m°‹eSåög
)(const *);

868 } 
	tP¨amëîAâribuã
;

871 
ssize_t
 
	$∑ømëîShow
(
kobje˘
 *
kobj
,

872 
©åibuã
 *
©å
,

873 *
buf
)

875 
P¨amëîAâribuã
 *
∑
 = 
	`c⁄èöî_of
(
©å
, ParameterAttribute,áttr);

876 i‡(
∑
->
showSåög
 !
NULL
) {

877  
	`•rötf
(
buf
, "%s\n", 
∑
->
	`showSåög
());

879 
UdsP¨amëîVÆue
 
vÆue
;

880 
ªsu…
 = 
	`udsGëP¨amëî
(
∑
->
«me
, &
vÆue
);

881 i‡(
ªsu…
 !
UDS_SUCCESS
) {

882 
	`logEº‹WôhSåögEº‹
(
ªsu…
, "îr‹ gëtögÖ¨amëî %s", 
∑
->
«me
);

883  
ªsu…
 < 
UDS_ERROR_CODE_BASE
 ? -ªsu… : -
EINVAL
;

885 
vÆue
.
ty≥
) {

886 
UDS_PARAM_TYPE_BOOL
:

887  
	`•rötf
(
buf
, "%s\n", 
vÆue
.vÆue.
u_boﬁ
 ? "true" : "false");

888 
UDS_PARAM_TYPE_UNSIGNED_INT
:

889  
	`•rötf
(
buf
, "%u\n", 
vÆue
.vÆue.
u_uöt
);

890 
UDS_PARAM_TYPE_STRING
:

891  
	`•rötf
(
buf
, "%s\n", 
vÆue
.vÆue.
u_°rög
);

893  -
EINVAL
;

896 
	}
}

899 
ssize_t
 
	$∑ømëîSt‹e
(
kobje˘
 *
kobj
,

900 
©åibuã
 *
©å
,

901 c⁄° *
buf
,

902 
size_t
 
Àngth
)

904 
P¨amëîAâribuã
 *
∑
 = 
	`c⁄èöî_of
(
©å
, ParameterAttribute,áttr);

905 *
°rög
 = 
	`buf„rToSåög
(
buf
, 
Àngth
);

906 i‡(
°rög
 =
NULL
) {

907  -
ENOMEM
;

909 
ªsu…
 = 
UDS_SUCCESS
;

910 i‡(
∑
->
°‹eSåög
 !
NULL
) {

911 
∑
->
	`°‹eSåög
(
°rög
);

913 
UdsP¨amëîVÆue
 
∑ømëî
 = {

914 .
ty≥
 = 
UDS_PARAM_TYPE_STRING
,

915 .
vÆue
 = { .
u_°rög
 = 
°rög
 },

917 
ªsu…
 = 
	`udsSëP¨amëî
(
∑
->
«me
, 
∑ømëî
);

918 i‡(
ªsu…
 !
UDS_SUCCESS
) {

919 
	`logEº‹WôhSåögEº‹
(
ªsu…
, "error settingÖarameter %sÅo %s",

920 
∑
->
«me
, 
°rög
);

922 
ªsu…
 =Ñesu… < 
UDS_ERROR_CODE_BASE
 ? -ªsu… : -
EINVAL
;

924 
	`FREE
(
°rög
);

925  
ªsu…
 =
UDS_SUCCESS
 ? 
Àngth
 :Ñesult;

926 
	}
}

930 c⁄° *
	$∑ømëîShowLogLevñ
()

932  
	`¥i‹ôyToSåög
(
	`gëLogLevñ
());

933 
	}
}

937 
	$∑ømëîSt‹eLogLevñ
(c⁄° *
°rög
)

939 
	`£tLogLevñ
(
	`°rögToPri‹ôy
(
°rög
));

940 
	}
}

944 
P¨amëîAâribuã
 
	glogLevñAâr
 = {

945 .
©å
 = { .
«me
 = "log_Àvñ", .
	gmode
 = 0666 },

946 .
	gshowSåög
 = 
∑ømëîShowLogLevñ
,

947 .
	g°‹eSåög
 = 
∑ømëîSt‹eLogLevñ
,

950 
P¨amëîAâribuã
 
	g∑øŒñFa˘‹Aâr
 = {

951 .
©å
 = { .
«me
 = "∑øŒñ_Á˘‹", .
	gmode
 = 0666 },

952 .
	g«me
 = "UDS_PARALLEL_FACTOR",

955 
P¨amëîAâribuã
 
	gtimeReque°Tu∫¨oundAâr
 = {

956 .
©å
 = { .
«me
 = "time_ªque°_tu∫¨ound", .
	gmode
 = 0666 },

957 .
	g«me
 = "UDS_TIME_REQUEST_TURNAROUND",

960 
P¨amëîAâribuã
 
	gvﬁumeRódThªadsAâr
 = {

961 .
©å
 = { .
«me
 = "vﬁume_ªad_thªads", .
	gmode
 = 0666 },

962 .
	g«me
 = "UDS_VOLUME_READ_THREADS",

965 
©åibuã
 *
	g∑ømëîAârs
[] = {

966 &
logLevñAâr
.
©å
,

967 &
∑øŒñFa˘‹Aâr
.
©å
,

968 &
timeReque°Tu∫¨oundAâr
.
©å
,

969 &
vﬁumeRódThªadsAâr
.
©å
,

970 
NULL
,

973 
sysfs_›s
 
	g∑ømëîOps
 = {

974 .
show
 = 
∑ømëîShow
,

975 .
	g°‹e
 = 
∑ømëîSt‹e
,

978 
kobj_ty≥
 
	g∑ømëîObje˘Ty≥
 = {

979 .
ªÀa£
 = 
em±yRñó£
,

980 .
	gsysfs_›s
 = &
∑ømëîOps
,

981 .
	gdeÁu…_©ås
 = 
∑ømëîAârs
,

1013 
©åibuã
 
	m©å
;

1014 (*
	m°‹e
)(c⁄° *
	m°rög
);

1015 } 
	tT›Aâribuã
;

1018 
ssize_t
 
	$t›St‹e
(
kobje˘
 *
kobj
,

1019 
©åibuã
 *
©å
,

1020 c⁄° *
buf
,

1021 
size_t
 
Àngth
)

1023 
T›Aâribuã
 *
t›Aâribuã
 = 
	`c⁄èöî_of
(
©å
, TopAttribute,áttr);

1024 c⁄° *
°rög
 = 
	`buf„rToSåög
(
buf
, 
Àngth
);

1025 i‡(
°rög
 =
NULL
) {

1026  -
ENOMEM
;

1028 
ªsu…
 = 
t›Aâribuã
->
	`°‹e
(
°rög
);

1029 
	`‰ìC⁄°
(
°rög
);

1030  
ªsu…
 =0 ? 
Àngth
 :Ñesult;

1031 
	}
}

1034 
	$t›Clo£Index
(c⁄° *
°rög
)

1036 
IndexObje˘
 *
io
, **
pio
;

1037 
	`•ö_lock_úq
(&
obje˘RoŸ
.
lock
);

1038 
pio
 = &
obje˘RoŸ
.
ödexHód
; (
io
 = *pioË!
NULL
;Öiÿ&io->
√xt
) {

1039 i‡(
io
->
›íedBySysfs
 && ((
	`°rcmp
(io->
«me
, 
°rög
) == 0)

1040 || (
	`°rcmp
(
io
->
kobj
.
«me
, 
°rög
) == 0))) {

1044 
	`•ö_u∆ock_úq
(&
obje˘RoŸ
.
lock
);

1045 i‡(
io
 !
NULL
) {

1046 
ªsu…
 = 
	`udsClo£BlockC⁄ãxt
(
io
->
blockC⁄ãxt
);

1047 i‡(
ªsu…
 !
UDS_SUCCESS
) {

1048 
	`logEº‹WôhSåögEº‹
(
ªsu…
,

1050 
io
->
«me
);

1051  
ªsu…
 < 
UDS_ERROR_CODE_BASE
 ? -ªsu… : -
EINVAL
;

1053 
ªsu…
 = 
	`udsClo£IndexSessi⁄
(
io
->
ödexSessi⁄
);

1054 i‡(
ªsu…
 !
UDS_SUCCESS
) {

1055 
	`logEº‹WôhSåögEº‹
(
ªsu…
,

1057 
io
->
«me
);

1058  
ªsu…
 < 
UDS_ERROR_CODE_BASE
 ? -ªsu… : -
EINVAL
;

1062  -
EINVAL
;

1064 
	}
}

1067 
	$t›Cª©eC⁄fig
(c⁄° *
«me
)

1069 
C⁄figuøti⁄Obje˘
 *
co
;

1070 i‡(
	`ALLOCATE
(1, 
C⁄figuøti⁄Obje˘
, 
__func__
, &
co
Ë!
UDS_SUCCESS
) {

1071  -
ENOMEM
;

1073 
ªsu…
 = 
	`udsInôülizeC⁄figuøti⁄
(&
co
->
u£rC⁄fig
,

1074 
UDS_MEMORY_CONFIG_256MB
);

1075 i‡(
ªsu…
 !
UDS_SUCCESS
) {

1076 
	`logEº‹WôhSåögEº‹
(
ªsu…
, "error initializing configuration");

1077 
	`FREE
(
co
);

1078  
ªsu…
 < 
UDS_ERROR_CODE_BASE
 ? -ªsu… : -
EINVAL
;

1080 
	`kobje˘_öô
(&
co
->
kobj
, &
c⁄figuøti⁄Obje˘Ty≥
);

1081 
ªsu…
 = 
	`kobje˘_add
(&
co
->
kobj
, &
obje˘RoŸ
.
c⁄figuøti⁄Kobj
, "%s", 
«me
);

1082 i‡(
ªsu…
 == 0) {

1083 
	`•ö_lock_úq
(&
obje˘RoŸ
.
lock
);

1084 i‡(
obje˘RoŸ
.
shutdownFœg
) {

1086 
	`kobje˘_put
(&
co
->
kobj
);

1087 
ªsu…
 = -
EINVAL
;

1089 
co
->
√xt
 = 
obje˘RoŸ
.
c⁄figuøti⁄Hód
;

1090 
obje˘RoŸ
.
c⁄figuøti⁄Hód
 = 
co
;

1092 
	`•ö_u∆ock_úq
(&
obje˘RoŸ
.
lock
);

1094 
	`c⁄figuøti⁄Rñó£
(&
co
->
kobj
);

1096  
ªsu…
;

1097 
	}
}

1100 
	$t›DñëeC⁄fig
(c⁄° *
«me
)

1102 
C⁄figuøti⁄Obje˘
 *
co
, **
pco
;

1103 
	`•ö_lock_úq
(&
obje˘RoŸ
.
lock
);

1104 
pco
 = &
obje˘RoŸ
.
c⁄figuøti⁄Hód
;

1105 (
co
 = *
pco
Ë!
NULL
;

1106 
pco
 = &
co
->
√xt
) {

1107 i‡(
	`°rcmp
(
co
->
kobj
.
«me
,Çame) == 0) {

1108 *
pco
 = 
co
->
√xt
;

1109 
	`•ö_u∆ock_úq
(&
obje˘RoŸ
.
lock
);

1110 
	`kobje˘_put
(&
co
->
kobj
);

1114 
	`•ö_u∆ock_úq
(&
obje˘RoŸ
.
lock
);

1115  -
EINVAL
;

1116 
	}
}

1119 
	$t›LﬂdIndex
(c⁄° *
°rög
)

1121 
UdsIndexSessi⁄
 
£ssi⁄
;

1122 
ªsu…
 = 
	`udsLﬂdLoˇlIndex
(
°rög
, &
£ssi⁄
);

1123 i‡(
ªsu…
 !
UDS_SUCCESS
) {

1124 
	`logEº‹WôhSåögEº‹
(
ªsu…
, "îr‹Üﬂdög index \"%s\"", 
°rög
);

1125  
ªsu…
 < 
UDS_ERROR_CODE_BASE
 ? -ªsu… : -
EINVAL
;

1127  
	`√wIndexSessi⁄
(
£ssi⁄
, 
°rög
);

1128 
	}
}

1131 
	$t›RebuûdIndex
(c⁄° *
°rög
)

1133 
UdsIndexSessi⁄
 
£ssi⁄
;

1134 
ªsu…
 = 
	`udsRebuûdLoˇlIndex
(
°rög
, &
£ssi⁄
);

1135 i‡(
ªsu…
 !
UDS_SUCCESS
) {

1136 
	`logEº‹WôhSåögEº‹
(
ªsu…
, "îr‹Ñebuûdög index \"%s\"", 
°rög
);

1137  
ªsu…
 < 
UDS_ERROR_CODE_BASE
 ? -ªsu… : -
EINVAL
;

1139  
	`√wIndexSessi⁄
(
£ssi⁄
, 
°rög
);

1140 
	}
}

1144 
T›Aâribuã
 
	g˛o£IndexAâr
 = {

1145 .
©å
 = { .
«me
 = "˛o£_ödex", .
	gmode
 = 0222 },

1146 .
	g°‹e
 = 
t›Clo£Index
,

1149 
T›Aâribuã
 
	g¸óãC⁄figAâr
 = {

1150 .
©å
 = { .
«me
 = "¸óã_c⁄fig", .
	gmode
 = 0222 },

1151 .
	g°‹e
 = 
t›Cª©eC⁄fig
,

1154 
T›Aâribuã
 
	gdñëeC⁄figAâr
 = {

1155 .
©å
 = { .
«me
 = "dñëe_c⁄fig", .
	gmode
 = 0222 },

1156 .
	g°‹e
 = 
t›DñëeC⁄fig
,

1159 
T›Aâribuã
 
	glﬂdIndexAâr
 = {

1160 .
©å
 = { .
«me
 = "lﬂd_ödex", .
	gmode
 = 0222 },

1161 .
	g°‹e
 = 
t›LﬂdIndex
,

1164 
T›Aâribuã
 
	gªbuûdIndexAâr
 = {

1165 .
©å
 = { .
«me
 = "ªbuûd_ödex", .
	gmode
 = 0222 },

1166 .
	g°‹e
 = 
t›RebuûdIndex
,

1169 
©åibuã
 *
	gt›Aârs
[] = {

1170 &
˛o£IndexAâr
.
©å
,

1171 &
¸óãC⁄figAâr
.
©å
,

1172 &
dñëeC⁄figAâr
.
©å
,

1173 &
lﬂdIndexAâr
.
©å
,

1174 &
ªbuûdIndexAâr
.
©å
,

1175 
NULL
,

1178 
sysfs_›s
 
	gt›Ops
 = {

1179 .
show
 = 
em±yShow
,

1180 .
	g°‹e
 = 
t›St‹e
,

1183 
kobj_ty≥
 
	gt›Obje˘Ty≥
 = {

1184 .
ªÀa£
 = 
em±yRñó£
,

1185 .
	gsysfs_›s
 = &
t›Ops
,

1186 .
	gdeÁu…_©ås
 = 
t›Aârs
,

1190 
ssize_t
 
	$√wIndexSessi⁄
(
UdsIndexSessi⁄
 
£ssi⁄
, c⁄° *
«me
)

1192 
UdsBlockC⁄ãxt
 
c⁄ãxt
;

1193 
ªsu…
 = 
	`udsO≥nBlockC⁄ãxt
(
£ssi⁄
, 
UDS_MAX_BLOCK_DATA_SIZE
, &
c⁄ãxt
);

1194 i‡(
ªsu…
 !
UDS_SUCCESS
) {

1195 
	`logEº‹WôhSåögEº‹
(
ªsu…
,

1197 
«me
);

1198 
ªsu…
 = 
	`udsClo£IndexSessi⁄
(
£ssi⁄
);

1199 i‡(
ªsu…
 !
UDS_SUCCESS
) {

1200 
	`logEº‹WôhSåögEº‹
(
ªsu…
,

1202 
«me
);

1204  
ªsu…
 < 
UDS_ERROR_CODE_BASE
 ? -ªsu… : -
EINVAL
;

1206 
IndexObje˘
 *
io
;

1207 
	`•ö_lock_úq
(&
obje˘RoŸ
.
lock
);

1208 
io
 = 
obje˘RoŸ
.
ödexHód
; iÿ!
NULL
; iÿio->
√xt
) {

1209 i‡(
io
->
blockC⁄ãxt
.
id
 =
c⁄ãxt
.id) {

1210 
io
->
›íedBySysfs
 = 
åue
;

1214 
	`•ö_u∆ock_úq
(&
obje˘RoŸ
.
lock
);

1216 
	}
}

1219 
	$nŸifyBlockC⁄ãxtClo£d
(
UdsBlockC⁄ãxt
 
c⁄ãxt
)

1221 
IndexObje˘
 *
io
, **
pio
;

1222 
	`•ö_lock_úq
(&
obje˘RoŸ
.
lock
);

1223 
pio
 = &
obje˘RoŸ
.
ödexHód
; (
io
 = *pioË!
NULL
;Öiÿ&io->
√xt
) {

1224 i‡(
io
->
blockC⁄ãxt
.
id
 =
c⁄ãxt
.id) {

1225 *
pio
 = 
io
->
√xt
;

1229 
	`•ö_u∆ock_úq
(&
obje˘RoŸ
.
lock
);

1230 i‡(
io
 !
NULL
) {

1231 
	`kobje˘_put
(
io
->
c⁄figuøti⁄Kobj
);

1232 
	`kobje˘_put
(&
io
->
kobj
);

1234 
	}
}

1237 
	$nŸifyBlockC⁄ãxtO≥√d
(
UdsIndexSessi⁄
 
£ssi⁄
, 
UdsBlockC⁄ãxt
 
c⁄ãxt
)

1239 
	`•ö_lock_úq
(&
obje˘RoŸ
.
lock
);

1240 
Sessi⁄Name
 *
¢
 = *
	`födSessi⁄Name
(
£ssi⁄
);

1241 c⁄° *
«mePå
 = 
¢
 !
NULL
 ? sn->
«me
 : "unknownÇame";

1242 
	`•ö_u∆ock_úq
(&
obje˘RoŸ
.
lock
);

1243 *
«me
;

1244 i‡(
	`du∂iˇãSåög
(
«mePå
, 
__func__
, &
«me
Ë!
UDS_SUCCESS
) {

1247 
IndexObje˘
 *
io
;

1248 i‡(
	`ALLOCATE
(1, 
IndexObje˘
, 
__func__
, &
io
Ë!
UDS_SUCCESS
) {

1249 
	`FREE
(
«me
);

1252 
io
->
ödexSessi⁄
 = 
£ssi⁄
;

1253 
io
->
blockC⁄ãxt
 = 
c⁄ãxt
;

1254 
io
->
«me
 =Çame;

1255 
C⁄figuøti⁄Obje˘
 *
co
;

1256 i‡(
	`ALLOCATE
(1, 
C⁄figuøti⁄Obje˘
, 
__func__
, &
co
Ë!
UDS_SUCCESS
) {

1257 
	`ödexRñó£
(&
io
->
kobj
);

1260 
io
->
c⁄figuøti⁄Kobj
 = &
co
->
kobj
;

1261 
ªsu…
 = 
	`udsGëBlockC⁄ãxtC⁄figuøti⁄
(
c⁄ãxt
, &
co
->
u£rC⁄fig
);

1262 i‡(
ªsu…
 !
UDS_SUCCESS
) {

1263 
	`logEº‹WôhSåögEº‹
(
ªsu…
, "error getting index \"%s\" configuration",

1264 
«me
);

1265 
	`FREE
(
co
);

1266 
	`ödexRñó£
(&
io
->
kobj
);

1269 
	`kobje˘_öô
(&
io
->
kobj
, &
ödexObje˘Ty≥
);

1270 
ªsu…
 = 
	`kobje˘_add
(&
io
->
kobj
, &
obje˘RoŸ
.
ödexKobj
, "%u", 
c⁄ãxt
.
id
);

1271 i‡(
ªsu…
 != 0) {

1272 
	`c⁄figuøti⁄Rñó£
(&
co
->
kobj
);

1273 
	`ödexRñó£
(&
io
->
kobj
);

1276 
	`kobje˘_öô
(&
co
->
kobj
, &
c⁄figuøti⁄RoObje˘Ty≥
);

1277 
ªsu…
 = 
	`kobje˘_add
(&
co
->
kobj
, &
io
->kobj, "configuration");

1278 i‡(
ªsu…
 != 0) {

1279 
	`c⁄figuøti⁄Rñó£
(&
co
->
kobj
);

1280 
	`kobje˘_put
(&
io
->
kobj
);

1283 
	`•ö_lock_úq
(&
obje˘RoŸ
.
lock
);

1284 
io
->
√xt
 = 
obje˘RoŸ
.
ödexHód
;

1285 
obje˘RoŸ
.
ödexHód
 = 
io
;

1286 
	`•ö_u∆ock_úq
(&
obje˘RoŸ
.
lock
);

1287 
	}
}

1290 
	$öôSysfs
()

1292 
	`mem£t
(&
obje˘RoŸ
, 0, (objectRoot));

1293 
	`•ö_lock_öô
(&
obje˘RoŸ
.
lock
);

1294 
	`kobje˘_öô
(&
obje˘RoŸ
.
kobj
, &
t›Obje˘Ty≥
);

1295 
	`kobje˘_öô
(&
obje˘RoŸ
.
c⁄figuøti⁄Kobj
, &
em±yObje˘Ty≥
);

1296 
	`kobje˘_öô
(&
obje˘RoŸ
.
ödexKobj
, &
em±yObje˘Ty≥
);

1297 
	`kobje˘_öô
(&
obje˘RoŸ
.
∑ømëîKobj
, &
∑ømëîObje˘Ty≥
);

1298 
ªsu…
 = 
	`kobje˘_add
(&
obje˘RoŸ
.
kobj
, 
NULL
, 
THIS_MODULE
->
«me
);

1299 i‡(
ªsu…
 == 0) {

1300 
obje˘RoŸ
.
Êag
 = 
åue
;

1301 
ªsu…
 = 
	`kobje˘_add
(&
obje˘RoŸ
.
c⁄figuøti⁄Kobj
, &obje˘RoŸ.
kobj
,

1304 i‡(
ªsu…
 == 0) {

1305 
obje˘RoŸ
.
c⁄figuøti⁄Fœg
 = 
åue
;

1306 
ªsu…
 = 
	`kobje˘_add
(&
obje˘RoŸ
.
ödexKobj
, &obje˘RoŸ.
kobj
, "index");

1308 i‡(
ªsu…
 == 0) {

1309 
obje˘RoŸ
.
ödexFœg
 = 
åue
;

1310 
ªsu…
 = 
	`kobje˘_add
(&
obje˘RoŸ
.
∑ømëîKobj
, &obje˘RoŸ.
kobj
,

1313 i‡(
ªsu…
 == 0) {

1314 
obje˘RoŸ
.
∑ømëîFœg
 = 
åue
;

1316 i‡(
ªsu…
 != 0) {

1317 
	`putSysfs
();

1319  
ªsu…
;

1320 
	}
}

1323 
	$putSysfs
()

1326 
	`•ö_lock_úq
(&
obje˘RoŸ
.
lock
);

1327 
obje˘RoŸ
.
shutdownFœg
 = 
åue
;

1329 
obje˘RoŸ
.
c⁄figuøti⁄Hód
 !
NULL
) {

1330 
C⁄figuøti⁄Obje˘
 *
co
 = 
obje˘RoŸ
.
c⁄figuøti⁄Hód
;

1331 
obje˘RoŸ
.
c⁄figuøti⁄Hód
 = 
co
->
√xt
;

1332 
	`•ö_u∆ock_úq
(&
obje˘RoŸ
.
lock
);

1333 
	`kobje˘_put
(&
co
->
kobj
);

1334 
	`•ö_lock_úq
(&
obje˘RoŸ
.
lock
);

1337 
obje˘RoŸ
.
ödexHód
 !
NULL
) {

1338 
IndexObje˘
 *
io
 = 
obje˘RoŸ
.
ödexHód
;

1339 
obje˘RoŸ
.
ödexHód
 = 
io
->
√xt
;

1340 
io
->
√xt
 = 
NULL
;

1341 
	`•ö_u∆ock_úq
(&
obje˘RoŸ
.
lock
);

1342 
	`kobje˘_put
(
io
->
c⁄figuøti⁄Kobj
);

1343 
	`kobje˘_put
(&
io
->
kobj
);

1344 
	`•ö_lock_úq
(&
obje˘RoŸ
.
lock
);

1346 
	`•ö_u∆ock_úq
(&
obje˘RoŸ
.
lock
);

1348 i‡(
obje˘RoŸ
.
c⁄figuøti⁄Fœg
) {

1349 
	`kobje˘_put
(&
obje˘RoŸ
.
c⁄figuøti⁄Kobj
);

1351 i‡(
obje˘RoŸ
.
ödexFœg
) {

1352 
	`kobje˘_put
(&
obje˘RoŸ
.
ödexKobj
);

1354 i‡(
obje˘RoŸ
.
∑ømëîFœg
) {

1355 
	`kobje˘_put
(&
obje˘RoŸ
.
∑ømëîKobj
);

1357 i‡(
obje˘RoŸ
.
Êag
) {

1358 
	`kobje˘_put
(&
obje˘RoŸ
.
kobj
);

1360 
	}
}

	@uds/sysfs.h

22 #i‚de‡
SYSFS_H


23 
	#SYSFS_H


	)

31 
öôSysfs
();

37 
putSysfs
();

	@uds/threadCondVar.h

22 #i‚de‡
THREAD_COND_VAR_H


23 
	#THREAD_COND_VAR_H


	)

25 
	~"thªadDefs.h
"

26 
	~"timeUtûs.h
"

28 #ifde‡
__˝lu•lus


39 
öôC⁄d
(
C⁄dV¨
 *
c⁄d
);

48 
sig«lC⁄d
(
C⁄dV¨
 *
c⁄d
);

57 
brﬂdˇ°C⁄d
(
C⁄dV¨
 *
c⁄d
);

67 
waôC⁄d
(
C⁄dV¨
 *
c⁄d
, 
Muãx
 *
muãx
);

78 
timedWaôC⁄d
(
C⁄dV¨
 *
c⁄d
, 
Muãx
 *
muãx
, c⁄° 
AbsTime
 *
dódlöe
);

87 
de°royC⁄d
(
C⁄dV¨
 *
c⁄d
);

89 #ifde‡
__˝lu•lus


	@uds/threadCondVarLinuxKernel.c

22 
	~"thªadC⁄dV¨.h
"

23 
	~"thªadMuãx.h
"

24 
	~"timeUtûs.h
"

25 
	~"uds-îr‹.h
"

28 
	$öôC⁄d
(
C⁄dV¨
 *
cv
)

30 
cv
->
evítCou¡
 = 
NULL
;

31  
	`makeEvítCou¡
(&
cv
->
evítCou¡
);

32 
	}
}

35 
	$sig«lC⁄d
(
C⁄dV¨
 *
cv
)

37 
	`evítCou¡Brﬂdˇ°
(
cv
->
evítCou¡
);

38  
UDS_SUCCESS
;

39 
	}
}

42 
	$brﬂdˇ°C⁄d
(
C⁄dV¨
 *
cv
)

44 
	`evítCou¡Brﬂdˇ°
(
cv
->
evítCou¡
);

45  
UDS_SUCCESS
;

46 
	}
}

49 
	$waôC⁄d
(
C⁄dV¨
 *
cv
, 
Muãx
 *
muãx
)

51 
	`timedWaôC⁄d
(
cv
, 
muãx
, 
NULL
);

52  
UDS_SUCCESS
;

53 
	}
}

56 
	$timedWaôC⁄d
(
C⁄dV¨
 *
cv
, 
Muãx
 *
muãx
, c⁄° 
AbsTime
 *
dódlöe
)

58 
RñTime
 *
timeout
 = 
NULL
;

59 
RñTime
 
timeoutVÆue
;

60 i‡(
dódlöe
 !
NULL
) {

61 
timeoutVÆue
 = 
	`timeDif„ªn˚
(*
dódlöe
, 
	`cuºítTime
(
CT_REALTIME
));

62 
timeout
 = &
timeoutVÆue
;

64 
EvítTokí
 
tokí
 = 
	`evítCou¡Pª∑ª
(
cv
->
evítCou¡
);

65 
	`u∆ockMuãx
(
muãx
);

66 
boﬁ
 
h≠≥√d
 = 
	`evítCou¡Waô
(
cv
->
evítCou¡
, 
tokí
, 
timeout
);

67 
	`lockMuãx
(
muãx
);

68  
h≠≥√d
 ? 
UDS_SUCCESS
 : 
ETIMEDOUT
;

69 
	}
}

72 
	$de°royC⁄d
(
C⁄dV¨
 *
cv
)

74 
	`‰ìEvítCou¡
(
cv
->
evítCou¡
);

75 
cv
->
evítCou¡
 = 
NULL
;

76  
UDS_SUCCESS
;

77 
	}
}

	@uds/threadDefs.h

22 #i‚de‡
LINUX_KERNEL_THREAD_DEFS_H


23 
	#LINUX_KERNEL_THREAD_DEFS_H


	)

25 
	~<löux/muãx.h
>

26 
	~<löux/£m≠h‹e.h
>

28 
	~"utû/evítCou¡.h
"

30 
kî√lThªad
 *
	tThªad
;

31 
pid_t
 
	tThªadId
;

33 °ru˘ { 
EvítCou¡
 *
	mevítCou¡
; } 
	tC⁄dV¨
;

34 °ru˘ { 
muãx
 *
	mpmut
; } 
	tMuãx
;

35 °ru˘ { 
hr_£m≠h‹e
 *
	mp£m
; } 
	tSem≠h‹e
;

38 
Sem≠h‹e
 
	mmuãx
;

39 
Sem≠h‹e
 
	mwaô
;

40 
	m¨rived
;

41 
	mthªadCou¡
;

42 } 
	tB¨rõr
;

51 
≠∂yToThªads
(
≠∂yFunc
(*, 
èsk_°ru˘
 *),

52 *
¨gumít
);

58 
exôThªad
();

	@uds/threadMutex.h

22 #i‚de‡
THREAD_MUTEX_H


23 
	#THREAD_MUTEX_H


	)

25 
	~"thªadDefs.h
"

27 #ifde‡
__˝lu•lus


42 
öôülizeMuãx
(
Muãx
 *
muãx
, 
boﬁ
 
as£πOnEº‹
);

52 
öôMuãx
(
Muãx
 *
muãx
);

61 
de°royMuãx
(
Muãx
 *
muãx
);

68 
lockMuãx
(
Muãx
 *
muãx
);

75 
u∆ockMuãx
(
Muãx
 *
muãx
);

77 #ifde‡
__˝lu•lus


	@uds/threadMutexLinuxKernel.c

22 
	~<löux/kthªad.h
>

24 
	~"îr‹s.h
"

25 
	~"mem‹yAŒoc.h
"

26 
	~"thªadMuãx.h
"

29 
	$öôülizeMuãx
(
Muãx
 *
muãx
, 
boﬁ
 
as£πOnEº‹
)

31 
ªsu…
 = 
	`ALLOCATE
(1, 
muãx
, 
__func__
, &muãx->
pmut
);

32 i‡(
ªsu…
 =
UDS_SUCCESS
) {

33 
	`muãx_öô
(
muãx
->
pmut
);

34 } i‡(
as£πOnEº‹
) {

35 
ªsu…
 = 
	`ASSERT_WITH_ERROR_CODE
(‘esu… =
UDS_SUCCESS
),Ñesult,

36 "muãx: 0x%p", (*Ë
muãx
);

38  
ªsu…
;

39 
	}
}

42 
	$öôMuãx
(
Muãx
 *
muãx
)

44  
	`öôülizeMuãx
(
muãx
, 
Ál£
);

45 
	}
}

48 
	$de°royMuãx
(
Muãx
 *
muãx
)

50 
	`FREE
(
muãx
->
pmut
);

51 
muãx
->
pmut
 = 
NULL
;

52  
UDS_SUCCESS
;

53 
	}
}

56 
	$lockMuãx
(
Muãx
 *
muãx
)

58 
	`muãx_lock
(
muãx
->
pmut
);

59 
	}
}

62 
	$u∆ockMuãx
(
Muãx
 *
muãx
)

64 
	`muãx_u∆ock
(
muãx
->
pmut
);

65 
	}
}

	@uds/threadOnce.c

22 
	~"îr‹s.h
"

23 
	~"thªads.h
"

26 
	mONCE_NOT_DONE
 = 0,

27 
	mONCE_IN_PROGRESS
 = 1,

28 
	mONCE_COMPLETE
 = 2,

32 
≥rf‹mOn˚
(
On˚Sèã
 *
⁄˚
, (*
fun˘i⁄
)())

35 
	`©omicLﬂd32
(
⁄˚
)) {

36 
ONCE_NOT_DONE
:

37 i‡(
	`com∑ªAndSw≠32
(
⁄˚
, 
ONCE_NOT_DONE
, 
ONCE_IN_PROGRESS
)) {

38 
	`fun˘i⁄
();

39 
	`©omicSt‹e32
(
⁄˚
, 
ONCE_COMPLETE
);

40  
UDS_SUCCESS
;

43 
ONCE_IN_PROGRESS
:

44 
	`yõldScheduÀr
();

46 
ONCE_COMPLETE
:

47  
UDS_SUCCESS
;

49  
UDS_BAD_STATE
;

52 
	}
}

	@uds/threadOnce.h

22 #i‚de‡
THREAD_ONCE_H


23 
	#THREAD_ONCE_H


	)

25 
	~"utû/©omic.h
"

27 
	#ONCE_STATE_INITIALIZER
 
	`ATOMIC_INITIALIZER
(0)

	)

29 
Atomic32
 
	tOn˚Sèã
;

46 
≥rf‹mOn˚
(
On˚Sèã
 *
⁄˚Sèã
, (*
öôFun˘i⁄
) ());

	@uds/threadRegistry.c

22 
	~"thªadRegi°ry.h
"

24 
	~<löux/gÂ.h
>

25 
	~<löux/¶ab.h
>

27 
	~"≥rmas£π.h
"

36 
	$ªgi°îThªad
(
ThªadRegi°ry
 *
ªgi°ry
,

37 
Regi°îedThªad
 *
√wThªad
,

38 c⁄° *
poöãr
)

40 
	`INIT_LIST_HEAD
(&
√wThªad
->
löks
);

41 
√wThªad
->
poöãr
 =Öointer;

42 
√wThªad
->
èsk
 = 
cuºít
;

44 
boﬁ
 
foundIt
 = 
Ál£
;

45 
Regi°îedThªad
 *
thªad
;

46 
	`wrôe_lock
(&
ªgi°ry
->
lock
);

47 
	`li°_f‹_óch_íåy
(
thªad
, &
ªgi°ry
->
löks
,Üinks) {

48 i‡(
thªad
->
èsk
 =
cuºít
) {

51 
	`li°_dñ_öô
(&
thªad
->
löks
);

52 
foundIt
 = 
åue
;

56 
	`li°_add_èû
(&
√wThªad
->
löks
, &
ªgi°ry
->links);

57 
	`wrôe_u∆ock
(&
ªgi°ry
->
lock
);

58 
	`ASSERT_LOG_ONLY
(!
foundIt
, "newÅhreadÇotálready inÑegistry");

59 
	}
}

62 
	$uƒegi°îThªad
(
ThªadRegi°ry
 *
ªgi°ry
)

64 
boﬁ
 
foundIt
 = 
Ál£
;

65 
Regi°îedThªad
 *
thªad
;

66 
	`wrôe_lock
(&
ªgi°ry
->
lock
);

67 
	`li°_f‹_óch_íåy
(
thªad
, &
ªgi°ry
->
löks
,Üinks) {

68 i‡(
thªad
->
èsk
 =
cuºít
) {

69 
	`li°_dñ_öô
(&
thªad
->
löks
);

70 
foundIt
 = 
åue
;

74 
	`wrôe_u∆ock
(&
ªgi°ry
->
lock
);

75 
	`ASSERT_LOG_ONLY
(
foundIt
, "thread found inÑegistry");

76 
	}
}

79 
	$öôülizeThªadRegi°ry
(
ThªadRegi°ry
 *
ªgi°ry
)

81 
	`INIT_LIST_HEAD
(&
ªgi°ry
->
löks
);

82 
	`rwlock_öô
(&
ªgi°ry
->
lock
);

83 
	}
}

86 c⁄° *
	$lookupThªad
(
ThªadRegi°ry
 *
ªgi°ry
)

88 c⁄° *
ªsu…
 = 
NULL
;

89 
	`ªad_lock
(&
ªgi°ry
->
lock
);

90 
Regi°îedThªad
 *
thªad
;

91 
	`li°_f‹_óch_íåy
(
thªad
, &
ªgi°ry
->
löks
,Üinks) {

92 i‡(
thªad
->
èsk
 =
cuºít
) {

93 
ªsu…
 = 
thªad
->
poöãr
;

97 
	`ªad_u∆ock
(&
ªgi°ry
->
lock
);

98  
ªsu…
;

99 
	}
}

	@uds/threadRegistry.h

22 #i‚de‡
THREAD_REGISTRY_H


23 
	#THREAD_REGISTRY_H
 1

	)

25 
	~<löux/li°.h
>

26 
	~<löux/•ölock.h
>

33 
	sthªadRegi°ry
 {

34 
li°_hód
 
	mlöks
;

35 
rwlock_t
 
	mlock
;

36 } 
	tThªadRegi°ry
;

38 
	sªgi°îedThªad
 {

39 
li°_hód
 
	mlöks
;

40 c⁄° *
	mpoöãr
;

41 
èsk_°ru˘
 *
	mèsk
;

42 } 
	tRegi°îedThªad
;

51 
öôülizeThªadRegi°ry
(
ThªadRegi°ry
 *
ªgi°ry
);

62 
ªgi°îThªad
(
ThªadRegi°ry
 *
ªgi°ry
,

63 
Regi°îedThªad
 *
√wThªad
,

64 c⁄° *
poöãr
);

73 
uƒegi°îThªad
(
ThªadRegi°ry
 *
ªgi°ry
);

84 c⁄° *
lookupThªad
(
ThªadRegi°ry
 *
ªgi°ry
);

	@uds/threadSemaphore.h

22 #i‚de‡
THREAD_SEMAPHORE_H


23 
	#THREAD_SEMAPHORE_H


	)

25 
	~"thªadDefs.h
"

26 
	~"timeUtûs.h
"

28 #ifde‡
__˝lu•lus


41 
öôülizeSem≠h‹e
(
Sem≠h‹e
 *
£m≠h‹e
,

42 
vÆue
,

43 c⁄° *
c⁄ãxt
)

44 
__©åibuã__
((
w¨n_unu£d_ªsu…
));

54 
de°roySem≠h‹e
(
Sem≠h‹e
 *
£m≠h‹e
, c⁄° *
c⁄ãxt
);

62 
acquúeSem≠h‹e
(
Sem≠h‹e
 *
£m≠h‹e
, c⁄° *
c⁄ãxt
);

79 
boﬁ
 
©ãm±Sem≠h‹e
(
Sem≠h‹e
 *
£m≠h‹e
,

80 
RñTime
 
timeout
,

81 c⁄° *
c⁄ãxt
)

82 
__©åibuã__
((
w¨n_unu£d_ªsu…
));

90 
ªÀa£Sem≠h‹e
(
Sem≠h‹e
 *
£m≠h‹e
, c⁄° *
c⁄ãxt
);

92 #ifde‡
__˝lu•lus


	@uds/threadSemaphoreLinuxKernel.c

22 
	~<löux/hπimî.h
>

23 
	~<löux/sched.h
>

24 
	~<löux/vîsi⁄.h
>

26 
	~"îr‹s.h
"

27 
	~"mem‹yAŒoc.h
"

28 
	~"thªadSem≠h‹e.h
"

30 #i‡
LINUX_VERSION_CODE
 > 
KERNEL_VERSION
(2,6,32)

31 
	#RAW_SPIN_LOCK_INIT
 
øw_•ö_lock_öô


	)

32 
	#RAW_SPIN_LOCK_IRQ
 
øw_•ö_lock_úq


	)

33 
	#RAW_SPIN_LOCK_IRQSAVE
 
øw_•ö_lock_úqßve


	)

34 
	#RAW_SPIN_UNLOCK_IRQ
 
øw_•ö_u∆ock_úq


	)

35 
	#RAW_SPIN_UNLOCK_IRQRESTORE
 
øw_•ö_u∆ock_úqª°‹e


	)

36 
	#RAW_SPINLOCK_T
 
øw_•ölock_t


	)

38 
	#RAW_SPIN_LOCK_INIT
 
•ö_lock_öô


	)

39 
	#RAW_SPIN_LOCK_IRQ
 
•ö_lock_úq


	)

40 
	#RAW_SPIN_LOCK_IRQSAVE
 
•ö_lock_úqßve


	)

41 
	#RAW_SPIN_UNLOCK_IRQ
 
•ö_u∆ock_úq


	)

42 
	#RAW_SPIN_UNLOCK_IRQRESTORE
 
•ö_u∆ock_úqª°‹e


	)

43 
	#RAW_SPINLOCK_T
 
•ölock_t


	)

46 
	shr_£m≠h‹e
 {

47 
RAW_SPINLOCK_T
 
	mlock
;

48 
	mcou¡
;

49 
li°_hód
 
	mwaôLi°
;

52 
	s£m≠h‹e_waôî
 {

53 
li°_hód
 
	mli°
;

54 
èsk_°ru˘
 *
	mèsk
;

55 
boﬁ
 
	mup
;

59 
	$öôülizeSem≠h‹e
(
Sem≠h‹e
 *
£m≠h‹e
,

60 
vÆue
,

61 c⁄° *
c⁄ãxt
)

63 
hr_£m≠h‹e
 *
£m
;

64 
ªsu…
 = 
	`ALLOCATE
(1, 
hr_£m≠h‹e
, 
c⁄ãxt
, &
£m
);

65 i‡(
ªsu…
 =
UDS_SUCCESS
) {

66 
£m
->
cou¡
 = 
vÆue
;

67 
	`RAW_SPIN_LOCK_INIT
(&
£m
->
lock
);

68 
	`INIT_LIST_HEAD
(&
£m
->
waôLi°
);

69 
£m≠h‹e
->
p£m
 = 
£m
;

71  
ªsu…
;

72 
	}
}

75 
de°roySem≠h‹e
(
Sem≠h‹e
 *
£m≠h‹e
,

76 c⁄° *
c⁄ãxt
 
__©åibuã__
((
unu£d
)))

78 
FREE
(
£m≠h‹e
->
p£m
);

79 
	g£m≠h‹e
->
	gp£m
 = 
NULL
;

80  
	gUDS_SUCCESS
;

84 
acquúeSem≠h‹e
(
Sem≠h‹e
 *
£m≠h‹e
,

85 c⁄° *
c⁄ãxt
 
__©åibuã__
((
unu£d
)))

87 
hr_£m≠h‹e
 *
	g£m
 = 
£m≠h‹e
->
p£m
;

88 
	gÊags
;

89 
RAW_SPIN_LOCK_IRQSAVE
(&
£m
->
lock
, 
Êags
);

90 i‡(
likñy
(
£m
->
cou¡
 > 0)) {

91 
	g£m
->
	gcou¡
--;

93 
èsk_°ru˘
 *
	gèsk
 = 
cuºít
;

94 
£m≠h‹e_waôî
 
	gwaôî
;

95 
	gwaôî
.
	gèsk
 = 
èsk
;

96 
	gwaôî
.
	gup
 = 
Ál£
;

97 
li°_add_èû
(&
waôî
.
li°
, &
£m
->
waôLi°
);

98 !
	gwaôî
.
	gup
) {

99 #i‡
LINUX_VERSION_CODE
 >
KERNEL_VERSION
(4,11,0)

100 
__£t_cuºít_°©e
(
TASK_INTERRUPTIBLE
);

102 
__£t_èsk_°©e
(
èsk
, 
TASK_INTERRUPTIBLE
);

104 
RAW_SPIN_UNLOCK_IRQ
(&
£m
->
lock
);

105 
scheduÀ_timeout
(
MAX_SCHEDULE_TIMEOUT
);

106 
RAW_SPIN_LOCK_IRQ
(&
£m
->
lock
);

109 
RAW_SPIN_UNLOCK_IRQRESTORE
(&
£m
->
lock
, 
Êags
);

113 
boﬁ
 
©ãm±Sem≠h‹e
(
Sem≠h‹e
 *
£m≠h‹e
,

114 
RñTime
 
timeout
,

115 c⁄° *
c⁄ãxt
 
__©åibuã__
((
unu£d
)))

117 
hr_£m≠h‹e
 *
	g£m
 = 
£m≠h‹e
->
p£m
;

118 
	ghrTimeout
 = 
ªlTimeToN™o£c⁄ds
(
timeout
);

119 
boﬁ
 
	gvÆue
 = 
åue
;

120 
	gÊags
;

121 
RAW_SPIN_LOCK_IRQSAVE
(&
£m
->
lock
, 
Êags
);

122 i‡(
likñy
(
£m
->
cou¡
 > 0)) {

123 
	g£m
->
	gcou¡
--;

124 } i‡(
	ghrTimeout
 <= 0) {

125 
vÆue
 = 
Ál£
;

127 
èsk_°ru˘
 *
	gèsk
 = 
cuºít
;

128 
£m≠h‹e_waôî
 
	gwaôî
;

129 
	gwaôî
.
	gèsk
 = 
èsk
;

130 
	gwaôî
.
	gup
 = 
Ál£
;

131 
li°_add_èû
(&
waôî
.
li°
, &
£m
->
waôLi°
);

132 
ktime_t
 
	gktime
 = 
ktime_£t
(0, 
hrTimeout
);

133 #i‡
LINUX_VERSION_CODE
 >
KERNEL_VERSION
(4,11,0)

134 
__£t_cuºít_°©e
(
TASK_INTERRUPTIBLE
);

136 
__£t_èsk_°©e
(
èsk
, 
TASK_UNINTERRUPTIBLE
);

138 
RAW_SPIN_UNLOCK_IRQ
(&
£m
->
lock
);

139 
scheduÀ_hπimeout
(&
ktime
, 
HRTIMER_MODE_REL
);

140 
RAW_SPIN_LOCK_IRQ
(&
£m
->
lock
);

141 
	gvÆue
 = 
waôî
.
up
;

142 i‡(!
	gvÆue
) {

143 
li°_dñ
(&
waôî
.
li°
);

146 
RAW_SPIN_UNLOCK_IRQRESTORE
(&
£m
->
lock
, 
Êags
);

147  
	gvÆue
;

151 
ªÀa£Sem≠h‹e
(
Sem≠h‹e
 *
£m≠h‹e
,

152 c⁄° *
c⁄ãxt
 
__©åibuã__
((
unu£d
)))

154 
hr_£m≠h‹e
 *
	g£m
 = 
£m≠h‹e
->
p£m
;

155 
	gÊags
;

156 
RAW_SPIN_LOCK_IRQSAVE
(&
£m
->
lock
, 
Êags
);

157 i‡(
likñy
(
li°_em±y
(&
£m
->
waôLi°
))) {

158 
	g£m
->
	gcou¡
++;

160 
£m≠h‹e_waôî
 *
	gwaôî


161 
li°_fú°_íåy
(&
£m
->
waôLi°
, 
£m≠h‹e_waôî
, 
li°
);

162 
li°_dñ
(&
waôî
->
li°
);

163 
	gwaôî
->
	gup
 = 
åue
;

164 
wake_up_¥o˚ss
(
waôî
->
èsk
);

166 
RAW_SPIN_UNLOCK_IRQRESTORE
(&
£m
->
lock
, 
Êags
);

	@uds/threads.h

22 #i‚de‡
THREADS_H


23 
	#THREADS_H


	)

25 
	~"thªadC⁄dV¨.h
"

26 
	~"thªadDefs.h
"

27 
	~"thªadMuãx.h
"

28 
	~"thªadOn˚.h
"

29 
	~"thªadSem≠h‹e.h
"

31 #ifde‡
__˝lu•lus


46 
¸óãThªad
((*
thªadFunc
)(*),

47 *
thªadD©a
,

48 c⁄° *
«me
,

49 
size_t
 
°ackLimô
,

50 
Thªad
 *
√wThªad
)

51 
__©åibuã__
((
w¨n_unu£d_ªsu…
));

61 
gëNumC‹es
();

68 
ThªadId
 
gëThªadId
(Ë
__©åibuã__
((
w¨n_unu£d_ªsu…
));

78 
joöThªads
(
Thªad
 
th
);

89 
öôülizeB¨rõr
(
B¨rõr
 *
b¨rõr
, 
thªadCou¡
)

90 
__©åibuã__
((
w¨n_unu£d_ªsu…
));

99 
de°royB¨rõr
(
B¨rõr
 *
b¨rõr
);

112 
íãrB¨rõr
(
B¨rõr
 *
b¨rõr
, 
boﬁ
 *
wö√r
);

119 
yõldScheduÀr
();

121 #ifde‡
__˝lu•lus


	@uds/threadsLinuxKernel.c

22 
	~<löux/kthªad.h
>

23 
	~<löux/sched.h
>

24 
	~<löux/vîsi⁄.h
>

26 #i‡
LINUX_VERSION_CODE
 >
KERNEL_VERSION
(4,11,0)

27 
	~<löux/com∂ëi⁄.h
>

30 
	~"mem‹yAŒoc.h
"

31 
	~"queue.h
"

32 
	~"thªads.h
"

33 
	~"uds-îr‹.h
"

35 
LIST__HEAD
(
kî√lThªadLi°Hód
, 
kî√lThªad
);

36 
kî√lThªadLi°Hód
 
	gkî√lThªadLi°
;

37 
muãx
 
	gkî√lThªadMuãx
;

38 
On˚Sèã
 
	gkî√lThªadOn˚
;

40 
	skî√lThªad
 {

41 (*
	mthªadFunc
)(*);

42 *
	mthªadD©a
;

43 
LIST_ENTRY
(
kî√lThªad
Ë
	mthªadLöks
;

44 
èsk_°ru˘
 *
	mthªadTask
;

45 
com∂ëi⁄
 
	mthªadD⁄e
;

46 } 
	tKî√lThªad
;

49 
	$kî√lThªadInô
()

51 
	`muãx_öô
(&
kî√lThªadMuãx
);

52 
	}
}

55 
	$thªadSèπî
(*
¨g
)

57 
Kî√lThªad
 *
kt
 = 
¨g
;

58 
kt
->
thªadTask
 = 
cuºít
;

59 
	`≥rf‹mOn˚
(&
kî√lThªadOn˚
, 
kî√lThªadInô
);

60 
	`muãx_lock
(&
kî√lThªadMuãx
);

61 
	`LIST_INSERT_HEAD
(&
kî√lThªadLi°
, 
kt
, 
thªadLöks
);

62 
	`muãx_u∆ock
(&
kî√lThªadMuãx
);

63 
Regi°îedThªad
 
ÆloˇtögThªad
;

64 
	`ªgi°îAŒoˇtögThªad
(&
ÆloˇtögThªad
, 
NULL
);

65 
kt
->
	`thªadFunc
(kt->
thªadD©a
);

66 
	`uƒegi°îAŒoˇtögThªad
();

67 
	`com∂ëe
(&
kt
->
thªadD⁄e
);

69 
	}
}

72 
¸óãThªad
((*
thªadFunc
)(*),

73 *
thªadD©a
,

74 c⁄° *
«me
,

75 
size_t
 
°ackLimô
 
	`__©åibuã__
((
unu£d
)),

76 
Thªad
 *
√wThªad
)

78 
Kî√lThªad
 *
kt
;

79 
ªsu…
 = 
	`ALLOCATE
(1, 
Kî√lThªad
, 
__func__
, &
kt
);

80 i‡(
ªsu…
 !
UDS_SUCCESS
) {

81  
ªsu…
;

83 
kt
->
thªadFunc
 =ÅhreadFunc;

84 
kt
->
thªadD©a
 =ÅhreadData;

85 
	`öô_com∂ëi⁄
(&
kt
->
thªadD⁄e
);

86 
èsk_°ru˘
 *
thªad
 = 
	`kthªad_run
(
thªadSèπî
, 
kt
, "%s", 
«me
);

87 i‡(
	`IS_ERR
(
thªad
)) {

88 
	`FREE
(
kt
);

89  
UDS_ENOTHREADS
;

91 *
√wThªad
 = 
kt
;

92  
UDS_SUCCESS
;

93 
	}
}

95 
	$joöThªads
(
Thªad
 
kt
)

97 
	`waô_f‹_com∂ëi⁄_öãºu±ibÀ
(&
kt
->
thªadD⁄e
) != 0) {

99 
	`muãx_lock
(&
kî√lThªadMuãx
);

100 
	`LIST_REMOVE
(
kt
, 
thªadLöks
);

101 
	`muãx_u∆ock
(&
kî√lThªadMuãx
);

102 
	`FREE
(
kt
);

103  
UDS_SUCCESS
;

104 
	}
}

107 
≠∂yToThªads
(
≠∂yFunc
(*, 
èsk_°ru˘
 *),

108 *
¨gumít
)

110 
Kî√lThªad
 *
	gkt
;

111 
≥rf‹mOn˚
(&
kî√lThªadOn˚
, 
kî√lThªadInô
);

112 
muãx_lock
(&
kî√lThªadMuãx
);

113 
LIST_FOREACH
(
kt
, &
kî√lThªadLi°
, 
thªadLöks
) {

114 
≠∂yFunc
(
¨gumít
, 
kt
->
thªadTask
);

116 
muãx_u∆ock
(&
kî√lThªadMuãx
);

120 
	$exôThªad
()

122 
Kî√lThªad
 *
kt
;

123 
com∂ëi⁄
 *com∂ëi⁄ = 
NULL
;

124 
	`≥rf‹mOn˚
(&
kî√lThªadOn˚
, 
kî√lThªadInô
);

125 
	`muãx_lock
(&
kî√lThªadMuãx
);

126 
	`LIST_FOREACH
(
kt
, &
kî√lThªadLi°
, 
thªadLöks
) {

127 i‡(
kt
->
thªadTask
 =
cuºít
) {

128 
com∂ëi⁄
 = &
kt
->
thªadD⁄e
;

132 
	`muãx_u∆ock
(&
kî√lThªadMuãx
);

133 
	`uƒegi°îAŒoˇtögThªad
();

134 
	`com∂ëe_™d_exô
(
com∂ëi⁄
, 1);

135 
	}
}

138 
ThªadId
 
	$gëThªadId
()

140  
cuºít
->
pid
;

141 
	}
}

144 
	$gëNumC‹es
()

146  
	`num_⁄löe_˝us
();

147 
	}
}

150 
	$öôülizeB¨rõr
(
B¨rõr
 *
b¨rõr
, 
thªadCou¡
)

152 
b¨rõr
->
¨rived
 = 0;

153 
b¨rõr
->
thªadCou¡
 =ÅhreadCount;

154 
ªsu…
 = 
	`öôülizeSem≠h‹e
(&
b¨rõr
->
muãx
, 1, 
__func__
);

155 i‡(
ªsu…
 !
UDS_SUCCESS
) {

156  
ªsu…
;

158  
	`öôülizeSem≠h‹e
(&
b¨rõr
->
waô
, 0, 
__func__
);

159 
	}
}

162 
	$de°royB¨rõr
(
B¨rõr
 *
b¨rõr
)

164 
ªsu…
 = 
	`de°roySem≠h‹e
(&
b¨rõr
->
muãx
, 
__func__
);

165 i‡(
ªsu…
 !
UDS_SUCCESS
) {

166  
ªsu…
;

168  
	`de°roySem≠h‹e
(&
b¨rõr
->
waô
, 
__func__
);

169 
	}
}

172 
	$íãrB¨rõr
(
B¨rõr
 *
b¨rõr
, 
boﬁ
 *
wö√r
)

174 
	`acquúeSem≠h‹e
(&
b¨rõr
->
muãx
, 
__func__
);

175 
boﬁ
 
œ°Thªad
 = ++
b¨rõr
->
¨rived
 =b¨rõr->
thªadCou¡
;

176 i‡(
œ°Thªad
) {

178 
i
 = 1; i < 
b¨rõr
->
thªadCou¡
; i++) {

179 
	`ªÀa£Sem≠h‹e
(&
b¨rõr
->
waô
, 
__func__
);

182 
b¨rõr
->
¨rived
 = 0;

183 
	`ªÀa£Sem≠h‹e
(&
b¨rõr
->
muãx
, 
__func__
);

186 
	`ªÀa£Sem≠h‹e
(&
b¨rõr
->
muãx
, 
__func__
);

187 
	`acquúeSem≠h‹e
(&
b¨rõr
->
waô
, 
__func__
);

189 i‡(
wö√r
 !
NULL
) {

190 *
wö√r
 = 
œ°Thªad
;

192  
UDS_SUCCESS
;

193 
	}
}

196 
	$yõldScheduÀr
()

198 
	`yõld
();

199  
UDS_SUCCESS
;

200 
	}
}

	@uds/timeDefs.h

22 #i‚de‡
LINUX_KERNEL_TIME_DEFS_H


23 
	#LINUX_KERNEL_TIME_DEFS_H


	)

25 
	~<löux/time.h
>

27 
	e˛ockTy≥
 {

28 
	mCT_REALTIME
 = 
CLOCK_REALTIME
,

29 
	mCT_MONOTONIC
 = 
CLOCK_MONOTONIC


30 } 
	tClockTy≥
;

32 
öt64_t
 
	tAbsTime
;

34 
INLINE
 
time_t
 
	$asTimeT
(
AbsTime
 
time
)

37  
time
 / 1000000000;

38 
	}
}

40 
INLINE
 
AbsTime
 
	$‰omTimeT
(
time_t
 
time
)

42  
time
 * 1000000000;

43 
	}
}

45 
	#ABSTIME_EPOCH
 0

	)

	@uds/timeUtils.c

22 
	~"°rögUtûs.h
"

23 
	~"timeUtûs.h
"

26 
uöt64_t
 
	$nowU£c
()

28 c⁄° 
AbsTime
 
ïoch
 = 
ABSTIME_EPOCH
;

29  
	`ªlTimeToMi¸o£c⁄ds
(
	`timeDif„ªn˚
(
	`cuºítTime
(
CT_REALTIME
),

30 
ïoch
));

31 
	}
}

34 
	$ªlTimeToSåög
(**
°Ω
, 
RñTime
 
ª…ime
, 
cou¡î
)

38 
RñTime
 
π
 = 
ª…ime
;

39 i‡(
cou¡î
 > 0) {

40 
π
 /
cou¡î
;

43 c⁄° *
sign
, *
unôs
;

44 
vÆue
;

45 i‡(
π
 < 0) {

48 
sign
 = "-";

49 
π
 = -rt;

51 
sign
 = "";

53 i‡(
π
 > 
	`£c⁄dsToRñTime
(1)) {

55 
unôs
 = "seconds";

56 
vÆue
 = 
	`ªlTimeToMûli£c⁄ds
(
π
);

57 } i‡(
π
 > 
	`mûli£c⁄dsToRñTime
(1)) {

59 
unôs
 = "milliseconds";

60 
vÆue
 = 
	`ªlTimeToMi¸o£c⁄ds
(
π
);

63 
unôs
 = "microseconds";

64 
vÆue
 = 
	`ªlTimeToN™o£c⁄ds
(
π
);

67  
	`ÆlocS¥ötf
(
__func__
, 
°Ω
, "%s%ld.%03ld %s",

68 
sign
, 
vÆue
 / 1000, vÆuê% 1000, 
unôs
);

69 
	}
}

	@uds/timeUtils.h

22 #i‚de‡
TIME_UTILS_H


23 
	#TIME_UTILS_H


	)

25 
	~"compûî.h
"

26 
	~"ty≥Defs.h
"

30 
öt64_t
 
	tRñTime
;

33 
	~"timeDefs.h
"

44 
boﬁ
 
isVÆidTime
(
AbsTime
 
time
);

54 
AbsTime
 
cuºítTime
(
ClockTy≥
 
˛ock
);

65 
AbsTime
 
futuªTime
(
ClockTy≥
 
˛ock
, 
RñTime
 
ª…ime
);

79 
AbsTime
 
dñèTime
(AbsTimê
time
, 
RñTime
 
ª…ime
);

89 
RñTime
 
timeDif„ªn˚
(
AbsTime
 
a
, AbsTimê
b
);

103 
	$ªlTimeToSåög
(**
°Ω
, 
RñTime
 
ª…ime
, 
cou¡î
)

104 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

111 
	`¶ìpF‹
(
RñTime
 
ª…ime
);

127 
	$timeInISOF‹m©
(
AbsTime
 
time
,

128 *
buf
,

129 
size_t
 
bufSize
,

130 
sub£c⁄ds
)

131 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

140 
INLINE
 
RñTime
 
	$£c⁄dsToRñTime
(
öt64_t
 
£c⁄ds
)

142  (
RñTime
Ë
£c⁄ds
 * (1000 * 1000 * 1000);

143 
	}
}

152 
INLINE
 
RñTime
 
	$mûli£c⁄dsToRñTime
(
öt64_t
 
mûli£c⁄ds
)

154  (
RñTime
Ë
mûli£c⁄ds
 * (1000 * 1000);

155 
	}
}

164 
INLINE
 
RñTime
 
	$mi¸o£c⁄dsToRñTime
(
öt64_t
 
mi¸o£c⁄ds
)

166  (
RñTime
Ë
mi¸o£c⁄ds
 * 1000;

167 
	}
}

176 
INLINE
 
RñTime
 
	$«no£c⁄dsToRñTime
(
öt64_t
 
«no£c⁄ds
)

178  (
RñTime
Ë
«no£c⁄ds
;

179 
	}
}

188 
INLINE
 
öt64_t
 
	$ªlTimeToMûli£c⁄ds
(
RñTime
 
ª…ime
)

190  
ª…ime
 / (1000 * 1000);

191 
	}
}

200 
INLINE
 
öt64_t
 
	$ªlTimeToMi¸o£c⁄ds
(
RñTime
 
ª…ime
)

202  
ª…ime
 / 1000;

203 
	}
}

212 
INLINE
 
öt64_t
 
	$ªlTimeToN™o£c⁄ds
(
RñTime
 
ª…ime
)

214  
ª…ime
;

215 
	}
}

225 
uöt64_t
 
	$nowU£c
(Ë
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

	@uds/timeUtilsLinuxKernel.c

22 
	~<löux/dñay.h
>

23 
	~<löux/ktime.h
>

25 
	~"îr‹s.h
"

26 
	~"°rögUtûs.h
"

27 
	~"timeUtûs.h
"

30 
AbsTime
 
cuºítTime
(
ClockTy≥
 
˛ock
 
__©åibuã__
((
unu£d
)))

32 
time•ec
 
	gnow
;

33 
gën°imeofday
(&
now
);

34  1000000000u»* 
	gnow
.
	gtv_£c
 +Çow.
	gtv_n£c
;

38 
AbsTime
 
	$futuªTime
(
ClockTy≥
 
˛ock
, 
RñTime
 
ª…ime
)

40  
	`dñèTime
(
	`cuºítTime
(
˛ock
), 
ª…ime
);

41 
	}
}

44 
AbsTime
 
	$dñèTime
(
AbsTime
 
time
, 
RñTime
 
ª…ime
)

46  
time
 + 
ª…ime
;

47 
	}
}

50 
RñTime
 
	$timeDif„ªn˚
(
AbsTime
 
a
, AbsTimê
b
)

52  
a
 - 
b
;

53 
	}
}

56 
	$¶ìpF‹
(
RñTime
 
ª…ime
)

58 
π
 = 1 + 
	`ªlTimeToMi¸o£c⁄ds
(
ª…ime
);

59 
	`u¶ìp_ønge
(
π
,Ñt);

60 
	}
}

63 
	$roundToSub£c⁄ds
(
n£c
, 
sub£c⁄ds
)

65 
exp
 = (
sub£c⁄ds
 > 9) ? 0 : 9 - subseconds;

66 
div
 = 1;

67 
exp
 > 0) {

68 
div
 *= 10;

69 --
exp
;

71  
n£c
 / 
div
;

72 
	}
}

75 
	$timeInISOF‹m©
(
AbsTime
 
time
,

76 *
buf
,

77 
size_t
 
bufSize
,

78 
sub£c⁄ds
)

80 *
bp
 = 
buf
;

81 *
be
 = 
buf
 + 
bufSize
;

82 
£c⁄ds
 = 
	`asTimeT
(
time
);

83 i‡(
sub£c⁄ds
) {

84 
bp
 = 
	`≠≥ndToBuf„r
(bp, 
be
, "[%ld.%0*ld]", 
£c⁄ds
, 
sub£c⁄ds
,

85 
	`roundToSub£c⁄ds
(
time
, 
sub£c⁄ds
));

87 
bp
 = 
	`≠≥ndToBuf„r
(bp, 
be
, "[%ld]", 
£c⁄ds
);

89  (
bp
 < 
be
Ë? 
UDS_SUCCESS
 : 
UDS_BUFFER_ERROR
;

90 
	}
}

	@uds/typeDefs.h

22 #i‚de‡
LINUX_KERNEL_TYPE_DEFS_H


23 
	#LINUX_KERNEL_TYPE_DEFS_H


	)

31 
	~<löux/kî√l.h
>

32 
	~<löux/ty≥s.h
>

33 
	~<°ddef.h
>

35 
	#CHAR_BIT
 8

	)

37 
	#INT64_MAX
 (9223372036854775807L)

	)

38 
	#UCHAR_MAX
 (()~0ul)

	)

39 
	#UINT8_MAX
 ((
uöt8_t
)~0ul)

	)

40 
	#UINT16_MAX
 ((
uöt16_t
)~0ul)

	)

41 
	#UINT64_MAX
 ((
uöt64_t
)~0ul)

	)

44 #i‚de‡
SIZE_MAX


45 
	#SIZE_MAX
 ((
size_t
)~0ul)

	)

48 
	#PRId64
 "Œd"

	)

49 
	#PRIu16
 "u"

	)

50 
	#PRIu32
 "u"

	)

51 
	#PRIu64
 "Œu"

	)

53 
	tuötmax_t
;

54 
	#PRIuMAX
 "lu"

	)

56 
	tbyã
;

	@uds/uds-block.h

26 #i‚de‡
UDS_BLOCK_H


27 
	#UDS_BLOCK_H


	)

29 #ifde‡
__˝lu•lus


33 
	~"uds.h
"

38 
UDS_MAX_BLOCK_DATA_SIZE
 = 
UDS_MAX_METADATA_SIZE


44 
	sudsBlockC⁄ãxt
 {

46 
id
;

47 } 
	tUdsBlockC⁄ãxt
;

52 
	sudsChunkD©a
 {

53 
d©a
[
UDS_MAX_BLOCK_DATA_SIZE
];

67 *
	tUdsBlockAddªss
;

107 (*
UdsDedu≥BlockCÆlback
)

108 (
	tUdsBlockC⁄ãxt
 
	tc⁄ãxt
,

109 
	tUdsCÆlbackTy≥
 
	tty≥
,

110 
	t°©us
,

111 
	tUdsCookõ
 
	tcookõ
,

112 
	tUdsBlockAddªss
 
	tdu∂iˇãAddªss
,

113 
	tUdsBlockAddªss
 
	tˇn⁄iˇlAddªss
,

114 
	tUdsChunkName
 *
	tblockName
,

115 
	tsize_t
 
	tblockLígth
,

116 *
	tˇŒbackArgumít
);

144 
UDS_ATTR_WARN_UNUSED_RESULT


145 
udsO≥nBlockC⁄ãxt
(
UdsIndexSessi⁄
 
£ssi⁄
,

146 
mëad©aSize
,

147 
UdsBlockC⁄ãxt
 *
c⁄ãxt
);

159 
UDS_ATTR_WARN_UNUSED_RESULT


160 
udsClo£BlockC⁄ãxt
(
UdsBlockC⁄ãxt
 
c⁄ãxt
);

169 
UDS_ATTR_WARN_UNUSED_RESULT


170 
udsFlushBlockC⁄ãxt
(
UdsBlockC⁄ãxt
 
c⁄ãxt
);

189 
UDS_ATTR_WARN_UNUSED_RESULT


190 
udsRegi°îDedu≥BlockCÆlback
(
UdsBlockC⁄ãxt
 
c⁄ãxt
,

191 
UdsDedu≥BlockCÆlback
 
cb
,

192 *
ˇŒbackArgumít
);

207 
UDS_ATTR_WARN_UNUSED_RESULT


208 
udsSëBlockC⁄ãxtReque°QueueLimô
(
UdsBlockC⁄ãxt
 
c⁄ãxt
,

209 
maxReque°s
);

223 
UDS_ATTR_WARN_UNUSED_RESULT


224 
udsSëBlockC⁄ãxtHashAlg‹ôhm
(
UdsBlockC⁄ãxt
 
c⁄ãxt
,

225 
UdsHashAlg‹ôhm
 
Æg‹ôhm
);

256 
UDS_ATTR_WARN_UNUSED_RESULT


257 
udsPo°Block
(
UdsBlockC⁄ãxt
 
c⁄ãxt
,

258 
UdsCookõ
 
cookõ
,

259 
UdsBlockAddªss
 
blockAddªss
,

260 
size_t
 
d©aLígth
,

261 c⁄° *
d©a
);

286 
UDS_ATTR_WARN_UNUSED_RESULT


287 
udsPo°BlockName
(
UdsBlockC⁄ãxt
 
c⁄ãxt
,

288 
UdsCookõ
 
cookõ
,

289 
UdsBlockAddªss
 
blockAddªss
,

290 c⁄° 
UdsChunkName
 *
chunkName
);

316 
UDS_ATTR_WARN_UNUSED_RESULT


317 
udsQuîyBlockName
(
UdsBlockC⁄ãxt
 
c⁄ãxt
,

318 
UdsCookõ
 
cookõ
,

319 
UdsBlockAddªss
 
blockAddªss
,

320 c⁄° 
UdsChunkName
 *
blockName
,

321 
boﬁ
 
upd©e
);

349 
UDS_ATTR_WARN_UNUSED_RESULT


350 
udsCheckBlock
(
UdsBlockC⁄ãxt
 
c⁄ãxt
,

351 
UdsCookõ
 
cookõ
,

352 
UdsBlockAddªss
 
blockAddªss
,

353 
size_t
 
d©aLígth
,

354 c⁄° *
d©a
,

355 
boﬁ
 
upd©e
);

377 
UDS_ATTR_WARN_UNUSED_RESULT


378 
udsUpd©eBlockM≠pög
(
UdsBlockC⁄ãxt
 
c⁄ãxt
,

379 
UdsCookõ
 
cookõ
,

380 c⁄° 
UdsChunkName
 *
blockName
,

381 
UdsBlockAddªss
 
blockAddªss
);

401 
UDS_ATTR_WARN_UNUSED_RESULT


402 
udsDñëeBlockM≠pög
(
UdsBlockC⁄ãxt
 
c⁄ãxt
,

403 
UdsCookõ
 
cookõ
,

404 c⁄° 
UdsChunkName
 *
blockName
);

406 
udsReque°
 
	tUdsReque°
;

416 
	tUdsChunkCÆlback
(
	tUdsReque°
 *
	tªque°
);

423 
	sudsReque°
 {

429 
UdsChunkName
 
chunkName
;

435 
udsChunkD©a
 
ﬁdMëad©a
;

442 
udsChunkD©a
 
√wMëad©a
;

448 
UdsChunkCÆlback
 *
ˇŒback
;

454 
UdsBlockC⁄ãxt
 
c⁄ãxt
;

461 
UdsCÆlbackTy≥
 
ty≥
;

466 
°©us
;

471 
boﬁ
 
found
;

477 
boﬁ
 
upd©e
;

478 
¥iv©e
[25];

523 
UDS_ATTR_WARN_UNUSED_RESULT


524 
udsSèπChunkO≥øti⁄
(
UdsReque°
 *
ªque°
);

538 
UDS_ATTR_WARN_UNUSED_RESULT


539 
udsGëBlockC⁄ãxtC⁄figuøti⁄
(
UdsBlockC⁄ãxt
 
c⁄ãxt
,

540 
UdsC⁄figuøti⁄
 *
c⁄f
);

550 
UDS_ATTR_WARN_UNUSED_RESULT


551 
udsGëBlockC⁄ãxtIndexSèts
(
UdsBlockC⁄ãxt
 
c⁄ãxt
,

552 
UdsIndexSèts
 *
°©s
);

562 
UDS_ATTR_WARN_UNUSED_RESULT


563 
udsGëBlockC⁄ãxtSèts
(
UdsBlockC⁄ãxt
 
c⁄ãxt
,

564 
UdsC⁄ãxtSèts
 *
°©s
);

573 
UDS_ATTR_WARN_UNUSED_RESULT


574 
udsRe£tBlockC⁄ãxtSèts
(
UdsBlockC⁄ãxt
 
c⁄ãxt
);

578 #ifde‡
__˝lu•lus


	@uds/uds-error.h

26 #i‚de‡
UDS_ERROR_H


27 
	#UDS_ERROR_H


	)

33 
	eudsSètusCodes
 {

35 
	mUDS_SUCCESS
 = 0,

38 
	mUDS_ERROR_CODE_BASE
 = 1024,

40 
	mUDS_UNINITIALIZED
 = 
UDS_ERROR_CODE_BASE
 + 0,

42 
	mUDS_SHUTTINGDOWN
 = 
UDS_ERROR_CODE_BASE
 + 1,

44 
	mUDS_EMODULE_LOAD
 = 
UDS_ERROR_CODE_BASE
 + 2,

46 
	mUDS_ENOTHREADS
 = 
UDS_ERROR_CODE_BASE
 + 3,

48 
	mUDS_NOCONTEXT
 = 
UDS_ERROR_CODE_BASE
 + 4,

50 
	mUDS_DISABLED
 = 
UDS_ERROR_CODE_BASE
 + 5,

52 
	mUDS_CORRUPT_COMPONENT
 = 
UDS_ERROR_CODE_BASE
 + 6,

53 
	mUDS_CORRUPT_FILE
 = 
UDS_CORRUPT_COMPONENT
,

55 
	mUDS_UNKNOWN_ERROR
 = 
UDS_ERROR_CODE_BASE
 + 7,

57 
	mUDS_GRID_NO_SERVERS
 = 
UDS_ERROR_CODE_BASE
 + 8,

59 
	mUDS_GRID_CONFIG_INCONSISTENT
 = 
UDS_ERROR_CODE_BASE
 + 9,

61 
	mUDS_UNSUPPORTED_VERSION
 = 
UDS_ERROR_CODE_BASE
 + 10,

63 
	mUDS_NO_INDEXSESSION
 = 
UDS_ERROR_CODE_BASE
 + 11,

65 
	mUDS_CORRUPT_DATA
 = 
UDS_ERROR_CODE_BASE
 + 12,

67 
	mUDS_SHORT_READ
 = 
UDS_ERROR_CODE_BASE
 + 13,

69 
	mUDS_AI_ERROR
 = 
UDS_ERROR_CODE_BASE
 + 14,

71 
	mUDS_RESOURCE_LIMIT_EXCEEDED
 = 
UDS_ERROR_CODE_BASE
 + 15,

73 
	mUDS_WRONG_CONTEXT_TYPE
 = 
UDS_ERROR_CODE_BASE
 + 16,

75 
	mUDS_BLOCK_ADDRESS_REQUIRED
 = 
UDS_ERROR_CODE_BASE
 + 17,

77 
	mUDS_CHUNK_DATA_REQUIRED
 = 
UDS_ERROR_CODE_BASE
 + 18,

79 
	mUDS_CHUNK_NAME_REQUIRED
 = 
UDS_ERROR_CODE_BASE
 + 19,

81 
	mUDS_CONF_PTR_REQUIRED
 = 
UDS_ERROR_CODE_BASE
 + 20,

83 
	mUDS_INDEX_STATS_PTR_REQUIRED
 = 
UDS_ERROR_CODE_BASE
 + 21,

85 
	mUDS_CONTEXT_STATS_PTR_REQUIRED
 = 
UDS_ERROR_CODE_BASE
 + 22,

87 
	mUDS_CONTEXT_PTR_REQUIRED
 = 
UDS_ERROR_CODE_BASE
 + 23,

89 
	mUDS_FILEID_REQUIRED
 = 
UDS_ERROR_CODE_BASE
 + 24,

91 
	mUDS_STREAM_REQUIRED
 = 
UDS_ERROR_CODE_BASE
 + 25,

93 
	mUDS_STREAMID_REQUIRED
 = 
UDS_ERROR_CODE_BASE
 + 26,

95 
	mUDS_STREAM_PTR_REQUIRED
 = 
UDS_ERROR_CODE_BASE
 + 27,

97 
	mUDS_INVALID_MEMORY_SIZE
 = 
UDS_ERROR_CODE_BASE
 + 28,

99 
	mUDS_INVALID_METADATA_SIZE
 = 
UDS_ERROR_CODE_BASE
 + 29,

101 
	mUDS_INDEX_NAME_REQUIRED
 = 
UDS_ERROR_CODE_BASE
 + 30,

103 
	mUDS_CONF_REQUIRED
 = 
UDS_ERROR_CODE_BASE
 + 31,

105 
	mUDS_BAD_FILE_DESCRIPTOR
 = 
UDS_ERROR_CODE_BASE
 + 32,

107 
	mUDS_INDEX_EXISTS
 = 
UDS_ERROR_CODE_BASE
 + 33,

109 
	mUDS_REQUESTS_OUT_OF_RANGE
 = 
UDS_ERROR_CODE_BASE
 + 34,

111 
	mUDS_BAD_NAMESPACE
 = 
UDS_ERROR_CODE_BASE
 + 35,

113 
	mUDS_MIGRATOR_MISMATCH
 = 
UDS_ERROR_CODE_BASE
 + 36,

115 
	mUDS_NO_INDEX
 = 
UDS_ERROR_CODE_BASE
 + 37,

117 
	mUDS_BAD_CHECKPOINT_FREQUENCY
 = 
UDS_ERROR_CODE_BASE
 + 38,

119 
	mUDS_WRONG_INDEX_CONFIG
 = 
UDS_ERROR_CODE_BASE
 + 39,

121 
	mUDS_INDEX_PATH_NOT_DIR
 = 
UDS_ERROR_CODE_BASE
 + 40,

123 
	mUDS_ALREADY_OPEN
 = 
UDS_ERROR_CODE_BASE
 + 41,

125 
	mUDS_CALLBACK_ALREADY_REGISTERED
 = 
UDS_ERROR_CODE_BASE
 + 42,

127 
	mUDS_INDEX_PATH_TOO_LONG
 = 
UDS_ERROR_CODE_BASE
 + 43,

129 
	mUDS_END_OF_FILE
 = 
UDS_ERROR_CODE_BASE
 + 44,

131 
	mUDS_INDEX_NOT_SAVED_CLEANLY
 = 
UDS_ERROR_CODE_BASE
 + 45,

133 
	mUDS_LOCAL_ONLY
 = 
UDS_ERROR_CODE_BASE
 + 46,

135 
	mUDS_INSUFFICIENT_INDEX_SPACE
 = 
UDS_ERROR_CODE_BASE
 + 47,

137 
	mUDS_BAD_INDEX_ALIGNMENT
 = 
UDS_ERROR_CODE_BASE
 + 48,

139 
	mUDS_UNSUPPORTED
 = 
UDS_ERROR_CODE_BASE
 + 49,

141 
	mUDS_UNKNOWN_PARAMETER
 = 
UDS_ERROR_CODE_BASE
 + 50,

143 
	mUDS_BAD_PARAMETER_TYPE
 = 
UDS_ERROR_CODE_BASE
 + 51,

145 
	mUDS_PARAMETER_INVALID
 = 
UDS_ERROR_CODE_BASE
 + 52,

147 
	mUDS_CALLBACK_REQUIRED
 = 
UDS_ERROR_CODE_BASE
 + 53,

149 
	mUDS_INVALID_OPERATION_TYPE
 = 
UDS_ERROR_CODE_BASE
 + 54,

151 
	mUDS_ERROR_CODE_LAST
,

153 
	mUDS_ERROR_CODE_BLOCK_END
 = 
UDS_ERROR_CODE_BASE
 + 1024

	@uds/uds-param.h

27 #i‚de‡
UDS_PARAM_H


28 
	#UDS_PARAM_H


	)

30 #ifde‡
__˝lu•lus


34 
	~"uds-∂©f‹m.h
"

55 
	eudsP¨amëîTy≥
 {

56 
UDS_PARAM_TYPE_UNSPECIFIED
,

57 
UDS_PARAM_TYPE_BOOL
,

58 
UDS_PARAM_TYPE_UNSIGNED_INT
,

59 
UDS_PARAM_TYPE_STRING
,

60 } 
	tUdsP¨amëîTy≥
;

66 
boﬁ
 
u_boﬁ
;

67 
u_uöt
;

68 c⁄° *
u_°rög
;

69 } 
	tUdsVÆueUni⁄
;

74 
	sudsP¨amëîVÆue
 {

75 
UdsP¨amëîTy≥
 
ty≥
;

76 
UdsVÆueUni⁄
 
vÆue
;

77 } 
	tUdsP¨amëîVÆue
;

82 c⁄° 
UdsP¨amëîVÆue
 
UDS_PARAM_TRUE
;

83 c⁄° 
UdsP¨amëîVÆue
 
UDS_PARAM_FALSE
;

135 
udsSëP¨amëî
(c⁄° *
«me
, 
UdsP¨amëîVÆue
 
vÆue
)

136 
__©åibuã__
((
w¨n_unu£d_ªsu…
));

149 
udsGëP¨amëî
(c⁄° *
«me
, 
UdsP¨amëîVÆue
 *
vÆue
)

150 
__©åibuã__
((
w¨n_unu£d_ªsu…
));

163 
udsRe£tP¨amëî
(c⁄° *
«me
)

164 
__©åibuã__
((
w¨n_unu£d_ªsu…
));

195 
udsIãøãP¨amëî
(
ödex
,

196 c⁄° **
«me
,

197 
UdsP¨amëîVÆue
 *
vÆue
)

198 
__©åibuã__
((
w¨n_unu£d_ªsu…
));

207 
UdsP¨amëîVÆue
 
udsUnsig√dVÆue
(
numbî
);

216 
UdsP¨amëîVÆue
 
udsSåögVÆue
(c⁄° *
°rög
);

225 
UdsP¨amëîVÆue
 
udsBoﬁónVÆue
(
boﬁ
 
boﬁón
);

227 #ifde‡
__˝lu•lus


	@uds/uds-platform.h

26 #i‚de‡
UDS_PLATFORM_H


27 
	#UDS_PLATFORM_H


	)

30 
	~<löux/ty≥s.h
>

	@uds/uds.h

31 #i‚de‡
UDS_H


32 
	#UDS_H


	)

34 #ifde‡
__˝lu•lus


38 
	~"uds-∂©f‹m.h
"

40 #ifde‡
UDS_DISABLE_ATTR_WARN_UNUSED_RESULT


41 
	#UDS_ATTR_WARN_UNUSED_RESULT


	)

43 
	#UDS_ATTR_WARN_UNUSED_RESULT
 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
))

	)

56 
UDS_POST
,

64 
UDS_UPDATE
,

69 
UDS_DELETE
,

76 
UDS_QUERY


78 } 
	tUdsCÆlbackTy≥
;

82 
	#UDS_CHUNK_NAME_SIZE
 16

	)

85 
UDS_MAX_METADATA_SIZE
 = 16

93 
	tUdsMem‹yC⁄figSize
;

95 c⁄° 
UdsMem‹yC⁄figSize
 
UDS_MEMORY_CONFIG_256MB
;

96 c⁄° 
UdsMem‹yC⁄figSize
 
UDS_MEMORY_CONFIG_512MB
;

97 c⁄° 
UdsMem‹yC⁄figSize
 
UDS_MEMORY_CONFIG_768MB
;

102 c⁄° 
UdsMem‹yC⁄figSize
 
UDS_MEMORY_CONFIG_MAX
;

106 
	sudsChunkName
 {

108 
	g«me
[
UDS_CHUNK_NAME_SIZE
];

109 } 
	tUdsChunkName
;

114 
	sudsIndexSessi⁄
 {

116 
	gid
;

117 } 
	tUdsIndexSessi⁄
;

123 *
	tUdsCookõ
;

128 
udsC⁄figuøti⁄
 *
	tUdsC⁄figuøti⁄
;

136 
	sudsIndexSèts
 {

138 
uöt64_t
 
	gíåõsIndexed
;

140 
uöt64_t
 
	gmem‹yU£d
;

142 
uöt64_t
 
	gdiskU£d
;

144 
uöt64_t
 
	gcﬁlisi⁄s
;

146 
uöt64_t
 
	gíåõsDisˇrded
;

148 
uöt64_t
 
	gcheckpoöts
;

149 } 
	tUdsIndexSèts
;

158 
	sudsC⁄ãxtSèts
 {

160 
time_t
 
	gª£tTime
;

162 
time_t
 
	gcuºítTime
;

167 
uöt64_t
 
	gpo°sFound
;

172 
uöt64_t
 
	gpo°sNŸFound
;

179 
uöt64_t
 
	göMem‹yPo°sFound
;

185 
uöt64_t
 
	gdí£Po°sFound
;

191 
uöt64_t
 
	g•¨£Po°sFound
;

197 
uöt64_t
 
	gbyãsFound
;

202 
uöt64_t
 
	gbyãsNŸFound
;

207 
uöt32_t
 
	gavgChunkFound
;

212 
uöt32_t
 
	gavgChunkNŸFound
;

218 
uöt64_t
 
	gupd©esFound
;

224 
uöt64_t
 
	gupd©esNŸFound
;

230 
uöt64_t
 
	gdñëi⁄sFound
;

236 
uöt64_t
 
	gdñëi⁄sNŸFound
;

242 
uöt64_t
 
	gquîõsFound
;

248 
uöt64_t
 
	gquîõsNŸFound
;

254 
uöt64_t
 
	gªque°s
;

256 
	gªque°QueueLimô
;

261 
uöt64_t
 
	gªque°Tu∫¨oundTime
;

266 
uöt64_t
 
	gmaximumTu∫¨oundTime
;

267 } 
	tUdsC⁄ãxtSèts
;

274 
	gUDS_HASH_ALG_SHA256
,

276 
	gUDS_HASH_ALG_MURMUR3


277 } 
	tUdsHashAlg‹ôhm
;

288 
UDS_ATTR_WARN_UNUSED_RESULT


289 
UdsChunkName
 
udsCÆcuœãSHA256ChunkName
(c⁄° *
d©a
, 
size_t
 
size
);

300 
UDS_ATTR_WARN_UNUSED_RESULT


301 
UdsChunkName
 
udsCÆcuœãMurmur3ChunkName
(c⁄° *
d©a
, 
size_t
 
size
);

312 
UDS_ATTR_WARN_UNUSED_RESULT


313 
boﬁ
 
udsEquÆChunkName
(c⁄° 
UdsChunkName
 *
«me0
,

314 c⁄° 
UdsChunkName
 *
«me1
);

324 
UDS_ATTR_WARN_UNUSED_RESULT


325 
udsInôülizeC⁄figuøti⁄
(
UdsC⁄figuøti⁄
 *
c⁄f
,

326 
UdsMem‹yC⁄figSize
 
memGB
);

337 
udsC⁄figuøti⁄SëS∑r£
(
UdsC⁄figuøti⁄
 
c⁄f
, 
boﬁ
 
•¨£
);

347 
UDS_ATTR_WARN_UNUSED_RESULT


348 
boﬁ
 
udsC⁄figuøti⁄GëS∑r£
(
UdsC⁄figuøti⁄
 
c⁄f
);

360 
UDS_ATTR_WARN_UNUSED_RESULT


361 
udsC⁄figuøti⁄SëCheckpoötFªquícy
(
UdsC⁄figuøti⁄
 
c⁄f
,

362 
checkpoötFªquícy
);

372 
UDS_ATTR_WARN_UNUSED_RESULT


373 
udsC⁄figuøti⁄GëCheckpoötFªquícy
(
UdsC⁄figuøti⁄
 
c⁄f
);

382 
UDS_ATTR_WARN_UNUSED_RESULT


383 
UdsMem‹yC⁄figSize
 
udsC⁄figuøti⁄GëMem‹y
(
UdsC⁄figuøti⁄
 
c⁄f
);

392 
UDS_ATTR_WARN_UNUSED_RESULT


393 
udsC⁄figuøti⁄GëCh≠ãrsPîVﬁume
(
UdsC⁄figuøti⁄
 
c⁄f
);

400 
udsFªeC⁄figuøti⁄
(
UdsC⁄figuøti⁄
 
c⁄f
);

415 
UDS_ATTR_WARN_UNUSED_RESULT


416 
udsCompuãIndexSize
(c⁄° 
UdsC⁄figuøti⁄
 
c⁄fig
,

417 
numCheckpoöts
,

418 
uöt64_t
 *
ödexSize
);

425 
UDS_ATTR_WARN_UNUSED_RESULT


426 c⁄° *
udsGëVîsi⁄
();

466 
UDS_ATTR_WARN_UNUSED_RESULT


467 
udsCª©eLoˇlIndex
(c⁄° *
«me
,

468 
UdsC⁄figuøti⁄
 
c⁄f
,

469 
UdsIndexSessi⁄
 *
£ssi⁄
);

488 
UDS_ATTR_WARN_UNUSED_RESULT


489 
udsLﬂdLoˇlIndex
(c⁄° *
«me
, 
UdsIndexSessi⁄
 *
£ssi⁄
);

508 
UDS_ATTR_WARN_UNUSED_RESULT


509 
udsRebuûdLoˇlIndex
(c⁄° *
«me
, 
UdsIndexSessi⁄
 *
£ssi⁄
);

514 
udsGridC⁄fig
 *
	tUdsGridC⁄fig
;

523 
UDS_ATTR_WARN_UNUSED_RESULT


524 
udsInôülizeGridC⁄fig
(
UdsGridC⁄fig
 *
gridC⁄fig
);

531 
udsFªeGridC⁄fig
(
UdsGridC⁄fig
 
gridC⁄fig
);

543 
UDS_ATTR_WARN_UNUSED_RESULT


544 
udsAddGridSîvî
(
UdsGridC⁄fig
 
gridC⁄fig
,

545 c⁄° *
ho°
,

546 c⁄° *
p‹t
);

567 
UDS_ATTR_WARN_UNUSED_RESULT


568 
udsClo£IndexSessi⁄
(
UdsIndexSessi⁄
 
£ssi⁄
);

575 
	gUDS_STATUS_UNKNOWN
 = 0,

577 
	gUDS_STATUS_STARTING
,

579 
	gUDS_STATUS_ONLINE
,

581 
	gUDS_STATUS_STOPPING
,

583 
	gUDS_STATUS_OFFLINE


584 } 
	tUdsGridSîvîSètus
;

596 
UDS_ATTR_WARN_UNUSED_RESULT


597 c⁄° *
udsSåögEº‹
(
î∫um
, *
buf
, 
size_t
 
buÊí
);

605 
udsShutdown
();

611 
	gUDS_STRING_ERROR_BUFSIZE
 = 128

614 #ifde‡
__˝lu•lus


	@uds/uds.mod.c

1 
	~<löux/moduÀ.h
>

2 
	~<löux/vîmagic.h
>

3 
	~<löux/compûî.h
>

5 
MODULE_INFO
(
vîmagic
, 
VERMAGIC_STRING
);

6 
MODULE_INFO
(
«me
, 
KBUILD_MODNAME
);

8 
__visibÀ
 
moduÀ
 
__this_moduÀ


9 
__©åibuã__
((
£˘i⁄
(".gnu.linkonce.this_module"))) = {

10 .
«me
 = 
KBUILD_MODNAME
,

11 .
	göô
 = 
öô_moduÀ
,

12 #ifde‡
CONFIG_MODULE_UNLOAD


13 .
	gexô
 = 
˛ónup_moduÀ
,

15 .
	g¨ch
 = 
MODULE_ARCH_INIT
,

18 c⁄° 
	g__moduÀ_dïíds
[]

19 
__u£d


20 
__©åibuã__
((
£˘i⁄
(".modinfo"))) =

24 
MODULE_INFO
(
§cvîsi⁄
, "A15D4A071E784FCCE075A73");

	@uds/udsMain.c

22 
	~"uds.h
"

24 
	~"c⁄fig.h
"

25 
	~"„©uªDefs.h
"

26 
	~"geomëry.h
"

27 
	~"grid.h
"

28 
	~"ödexLayout.h
"

29 
	~"ödexSessi⁄.h
"

30 
	~"loggî.h
"

31 
	~"mem‹yAŒoc.h
"

32 
	~"nŸifiˇti⁄Defs.h
"

33 
	~"udsSèã.h
"

35 c⁄° 
UdsMem‹yC⁄figSize
 
	gUDS_MEMORY_CONFIG_MAX
 = 1024;

36 c⁄° 
UdsMem‹yC⁄figSize
 
	gUDS_MEMORY_CONFIG_256MB
 = (UdsMemoryConfigSize) -256;

37 c⁄° 
UdsMem‹yC⁄figSize
 
	gUDS_MEMORY_CONFIG_512MB
 = (UdsMemoryConfigSize) -512;

38 c⁄° 
UdsMem‹yC⁄figSize
 
	gUDS_MEMORY_CONFIG_768MB
 = (UdsMemoryConfigSize) -768;

47 
	$udsInôülizeC⁄figuøti⁄
(
UdsC⁄figuøti⁄
 *
u£rC⁄fig
,

48 
UdsMem‹yC⁄figSize
 
memGB
)

50 i‡(
u£rC⁄fig
 =
NULL
) {

51  
	`logEº‹WôhSåögEº‹
(
UDS_CONF_PTR_REQUIRED
,

66 
ch≠ãrsPîVﬁume
, 
ªc‹dPagesPîCh≠ãr
, 
checkpoötFªquícy
;

67 i‡(
memGB
 =
UDS_MEMORY_CONFIG_256MB
) {

68 
ch≠ãrsPîVﬁume
 = 
DEFAULT_CHAPTERS_PER_VOLUME
;

69 
ªc‹dPagesPîCh≠ãr
 = 
SMALL_RECORD_PAGES_PER_CHAPTER
;

70 
checkpoötFªquícy
 = 
DEFAULT_CHECKPOINT_FREQUENCY
;

71 } i‡(
memGB
 =
UDS_MEMORY_CONFIG_512MB
) {

72 
ch≠ãrsPîVﬁume
 = 
DEFAULT_CHAPTERS_PER_VOLUME
;

73 
ªc‹dPagesPîCh≠ãr
 = 2 * 
SMALL_RECORD_PAGES_PER_CHAPTER
;

74 
checkpoötFªquícy
 = 
DEFAULT_CHECKPOINT_FREQUENCY
;

75 } i‡(
memGB
 =
UDS_MEMORY_CONFIG_768MB
) {

76 
ch≠ãrsPîVﬁume
 = 
DEFAULT_CHAPTERS_PER_VOLUME
;

77 
ªc‹dPagesPîCh≠ãr
 = 3 * 
SMALL_RECORD_PAGES_PER_CHAPTER
;

78 
checkpoötFªquícy
 = 
DEFAULT_CHECKPOINT_FREQUENCY
;

79 } i‡(
memGB
 == 1) {

80 
ch≠ãrsPîVﬁume
 = 
DEFAULT_CHAPTERS_PER_VOLUME
;

81 
ªc‹dPagesPîCh≠ãr
 = 
DEFAULT_RECORD_PAGES_PER_CHAPTER
;

82 
checkpoötFªquícy
 = 
DEFAULT_CHECKPOINT_FREQUENCY
;

83 } i‡((
memGB
 > 1Ë&& (memGB <
UDS_MEMORY_CONFIG_MAX
)) {

84 
ch≠ãrsPîVﬁume
 = 
memGB
 * 
DEFAULT_CHAPTERS_PER_VOLUME
;

85 
ªc‹dPagesPîCh≠ãr
 = 
DEFAULT_RECORD_PAGES_PER_CHAPTER
;

86 
checkpoötFªquícy
 = 
memGB
 * 
DEFAULT_CHECKPOINT_FREQUENCY
;

88  
UDS_INVALID_MEMORY_SIZE
;

91 
ªsu…
 = 
	`ALLOCATE
(1, 
udsC⁄figuøti⁄
,

92 "udsC⁄figuøti⁄", 
u£rC⁄fig
);

93 i‡(
ªsu…
 !
UDS_SUCCESS
) {

94  
ªsu…
;

97 (*
u£rC⁄fig
)->
ªc‹dPagesPîCh≠ãr
 =ÑecordPagesPerChapter;

98 (*
u£rC⁄fig
)->
ch≠ãrsPîVﬁume
 = chaptersPerVolume;

99 (*
u£rC⁄fig
)->
•¨£Ch≠ãrsPîVﬁume
 = 
DEFAULT_SPARSE_CHAPTERS_PER_VOLUME
;

100 (*
u£rC⁄fig
)->
ˇcheCh≠ãrs
 = 
DEFAULT_CACHE_CHAPTERS
;

101 (*
u£rC⁄fig
)->
checkpoötFªquícy
 = checkpointFrequency;

102 (*
u£rC⁄fig
)->
ma°îIndexMónDñè
 = 
DEFAULT_MASTER_INDEX_MEAN_DELTA
;

103 (*
u£rC⁄fig
)->
byãsPîPage
 = 
DEFAULT_BYTES_PER_PAGE
;

104 (*
u£rC⁄fig
)->
•¨£Sam∂eR©e
 = 
DEFAULT_SPARSE_SAMPLE_RATE
;

105  
UDS_SUCCESS
;

106 
	}
}

109 
	$udsC⁄figuøti⁄SëS∑r£
(
UdsC⁄figuøti⁄
 
u£rC⁄fig
, 
boﬁ
 
•¨£
)

111 
boﬁ
 
¥evS∑r£
 = (
u£rC⁄fig
->
•¨£Ch≠ãrsPîVﬁume
 != 0);

112 i‡(
•¨£
 =
¥evS∑r£
) {

117 
¥evCh≠ãrsPîVﬁume
 = 
u£rC⁄fig
->
ch≠ãrsPîVﬁume
;

118 i‡(
•¨£
) {

120 
u£rC⁄fig
->
ch≠ãrsPîVﬁume
 = 10 * 
¥evCh≠ãrsPîVﬁume
;

121 
u£rC⁄fig
->
•¨£Ch≠ãrsPîVﬁume
 = 9 * 
¥evCh≠ãrsPîVﬁume


122 + 
¥evCh≠ãrsPîVﬁume
 / 2;

123 
u£rC⁄fig
->
•¨£Sam∂eR©e
 = 32;

125 
u£rC⁄fig
->
ch≠ãrsPîVﬁume
 = 
¥evCh≠ãrsPîVﬁume
 / 10;

126 
u£rC⁄fig
->
•¨£Ch≠ãrsPîVﬁume
 = 0;

127 
u£rC⁄fig
->
•¨£Sam∂eR©e
 = 0;

129 
	}
}

132 
boﬁ
 
	$udsC⁄figuøti⁄GëS∑r£
(
UdsC⁄figuøti⁄
 
u£rC⁄fig
)

134  
u£rC⁄fig
->
•¨£Ch≠ãrsPîVﬁume
 > 0;

135 
	}
}

138 
	$udsC⁄figuøti⁄SëCheckpoötFªquícy
(

139 
UdsC⁄figuøti⁄
 
u£rC⁄fig
,

140 
checkpoötFªquícy
)

142 i‡(
checkpoötFªquícy
 > 
u£rC⁄fig
->
ch≠ãrsPîVﬁume
) {

143  
UDS_BAD_CHECKPOINT_FREQUENCY
;

145 
u£rC⁄fig
->
checkpoötFªquícy
 = checkpointFrequency;

146  
UDS_SUCCESS
;

147 
	}
}

150 
	$udsC⁄figuøti⁄GëCheckpoötFªquícy
(

151 
UdsC⁄figuøti⁄
 
u£rC⁄fig
)

153  
u£rC⁄fig
->
checkpoötFªquícy
;

154 
	}
}

157 
	$udsC⁄figuøti⁄GëMem‹y
(
UdsC⁄figuøti⁄
 
u£rC⁄fig
)

160 
CHAPTERS
 = 
DEFAULT_CHAPTERS_PER_VOLUME
,

161 
SMALL_PAGES
 = 
CHAPTERS
 * 
SMALL_RECORD_PAGES_PER_CHAPTER
,

162 
LARGE_PAGES
 = 
CHAPTERS
 * 
DEFAULT_RECORD_PAGES_PER_CHAPTER


164 
∑ges
 = (
u£rC⁄fig
->
ch≠ãrsPîVﬁume


165 * 
u£rC⁄fig
->
ªc‹dPagesPîCh≠ãr
);

166 i‡(
u£rC⁄fig
->
•¨£Ch≠ãrsPîVﬁume
 != 0) {

167 
∑ges
 /= 10;

169 
∑ges
) {

170 
SMALL_PAGES
:  
UDS_MEMORY_CONFIG_256MB
;

171 2 * 
SMALL_PAGES
:  
UDS_MEMORY_CONFIG_512MB
;

172 3 * 
SMALL_PAGES
:  
UDS_MEMORY_CONFIG_768MB
;

173 :  
∑ges
 / 
LARGE_PAGES
;

175 
	}
}

179 
	$udsC⁄figuøti⁄GëCh≠ãrsPîVﬁume
(
UdsC⁄figuøti⁄
 
u£rC⁄fig
)

181  
u£rC⁄fig
->
ch≠ãrsPîVﬁume
;

182 
	}
}

185 
	$udsFªeC⁄figuøti⁄
(
UdsC⁄figuøti⁄
 
u£rC⁄fig
)

187 
	`FREE
(
u£rC⁄fig
);

188 
	}
}

191 
	$öôülizeIndexSessi⁄
(
IndexSessi⁄
 *
ödexSessi⁄
,

192 
UdsGridC⁄fig
 
gridC⁄fig
,

193 
LﬂdTy≥
 
lﬂdTy≥
,

194 
UdsC⁄figuøti⁄
 
u£rC⁄fig
)

196 
ªsu…
;

197 i‡(
gridC⁄fig
->
numLoˇti⁄s
 == 0) {

198  
	`logEº‹WôhSåögEº‹
(
UDS_GRID_NO_SERVERS
,

202 
	`logGridC⁄fig
(
gridC⁄fig
, "Initializing index session");

203 
	`logLﬂdTy≥
(
lﬂdTy≥
);

205 i‡(
lﬂdTy≥
 =
LOAD_ATTACH
) {

206 #i‡
GRID


207 
ªsu…
 = 
	`makeRemŸeGrid
(
gridC⁄fig
, 
íãrCÆlbackSège
,

208 &
ödexSessi⁄
->
grid
);

210 
ªsu…
 = 
UDS_UNSUPPORTED
;

213 
IndexLayout
 *
œyout
;

214 
ªsu…
 = 
	`makeIndexLayout
(
gridC⁄fig
->
loˇti⁄s
[0].
dúe˘‹y
,

215 
lﬂdTy≥
 =
LOAD_CREATE
, 
u£rC⁄fig
, &
œyout
);

216 i‡(
ªsu…
 =
UDS_SUCCESS
) {

217 
ªsu…
 = 
	`makeLoˇlGrid
(
œyout
, 
lﬂdTy≥
, 
u£rC⁄fig
, 
íãrCÆlbackSège
,

218 &
ödexSessi⁄
->
grid
);

219 i‡(
ªsu…
 =
UDS_SUCCESS
) {

221 
ªsu…
 = 
	`ªmoveSa„tySól
(
œyout
);

224 
	`‰ìIndexLayout
(&
œyout
);

229 i‡(
ªsu…
 !
UDS_SUCCESS
) {

230 
	`logEº‹WôhSåögEº‹
(
ªsu…
, "FailedÅo initialize grid");

231  
ªsu…
;

234 
	`£tIndexSessi⁄Sèã
(
ödexSessi⁄
, 
IS_READY
);

235  
UDS_SUCCESS
;

236 
	}
}

239 
	$makeIndexSessi⁄
(
UdsGridC⁄fig
 
gridC⁄fig
,

240 
LﬂdTy≥
 
lﬂdTy≥
,

241 
UdsC⁄figuøti⁄
 
u£rC⁄fig
,

242 *
ödexSessi⁄ID
)

244 i‡(
ödexSessi⁄ID
 =
NULL
) {

245  
UDS_NO_INDEXSESSION
;

247 
	`udsInôülize
();

249 
	`lockGlobÆSèãMuãx
();

250 
ªsu…
 = 
	`checkLibøryRu¬ög
();

251 i‡(
ªsu…
 !
UDS_SUCCESS
) {

252 
	`u∆ockGlobÆSèãMuãx
();

253  
ªsu…
;

258 
Sessi⁄Group
 *
ödexSessi⁄Group
 = 
	`gëIndexSessi⁄Group
();

259 
ªsu…
 = 
	`acquúeSessi⁄Group
(
ödexSessi⁄Group
);

260 i‡(
ªsu…
 !
UDS_SUCCESS
) {

261 
	`u∆ockGlobÆSèãMuãx
();

262  
ªsu…
;

265 
IndexSessi⁄
 *
ödexSessi⁄
 = 
NULL
;

266 
ªsu…
 = 
	`makeEm±yIndexSessi⁄
(&
ödexSessi⁄
);

267 i‡(
ªsu…
 !
UDS_SUCCESS
) {

268 
	`ªÀa£Sessi⁄Group
(
ödexSessi⁄Group
);

269 
	`u∆ockGlobÆSèãMuãx
();

270  
ªsu…
;

273 
Sessi⁄ID
 
id
 = 
	`öôülizeSessi⁄
(
ödexSessi⁄Group
,

274 &
ödexSessi⁄
->
£ssi⁄
,

275 (
Sessi⁄C⁄ã¡s
Ë
ödexSessi⁄
);

279 
	`u∆ockGlobÆSèãMuãx
();

281 
ªsu…
 = 
	`öôülizeIndexSessi⁄
(
ödexSessi⁄
,

282 
gridC⁄fig
,

283 
lﬂdTy≥
,

284 
u£rC⁄fig
);

286 
	`lockGlobÆSèãMuãx
();

287 i‡(
ªsu…
 !
UDS_SUCCESS
) {

288 
	`föishSessi⁄
(
ödexSessi⁄Group
, &
ödexSessi⁄
->
£ssi⁄
);

289 
	`ßveAndFªeIndexSessi⁄
(
ödexSessi⁄
);

290 
	`ªÀa£Sessi⁄Group
(
ödexSessi⁄Group
);

291 
	`u∆ockGlobÆSèãMuãx
();

292  
	`h™dÀEº‹
(
NULL
, 
ªsu…
);

294 *
ödexSessi⁄ID
 = 
id
;

295 
	`logNŸi˚
("Cª©ed index sessi⁄ (%u)", 
id
);

296 
	`ªÀa£IndexSessi⁄
(
ödexSessi⁄
);

297 
	`ªÀa£Sessi⁄Group
(
ödexSessi⁄Group
);

298 
	`u∆ockGlobÆSèãMuãx
();

299  
UDS_SUCCESS
;

300 
	}
}

318 
	$makeLoˇlIndex
(c⁄° *
«me
,

319 
LﬂdTy≥
 
lﬂdTy≥
,

320 
UdsC⁄figuøti⁄
 
u£rC⁄fig
,

321 
UdsIndexSessi⁄
 *
£ssi⁄
)

323 i‡(
«me
 =
NULL
) {

324  
UDS_INDEX_NAME_REQUIRED
;

326 i‡(
£ssi⁄
 =
NULL
) {

327  
UDS_NO_INDEXSESSION
;

330 
UdsGridC⁄fig
 
gridC⁄fig
;

331 
ªsu…
 = 
	`udsInôülizeGridC⁄fig
(&
gridC⁄fig
);

332 i‡(
ªsu…
 !
UDS_SUCCESS
) {

333 
	`udsFªeGridC⁄fig
(
gridC⁄fig
);

334  
ªsu…
;

337 
ªsu…
 = 
	`addGridSîvî
(
gridC⁄fig
, 
NULL
, NULL, 
«me
);

338 i‡(
ªsu…
 !
UDS_SUCCESS
) {

339 
	`udsFªeGridC⁄fig
(
gridC⁄fig
);

340  
ªsu…
;

343 
ªsu…
 = 
	`makeIndexSessi⁄
(
gridC⁄fig
, 
lﬂdTy≥
, 
u£rC⁄fig
, &
£ssi⁄
->
id
);

344 
	`udsFªeGridC⁄fig
(
gridC⁄fig
);

345 i‡(
ªsu…
 =
UDS_SUCCESS
) {

346 
	`nŸifyIndexO≥√d
(*
£ssi⁄
, 
«me
);

348  
ªsu…
;

349 
	}
}

352 
	$udsCª©eLoˇlIndex
(c⁄° *
«me
,

353 
UdsC⁄figuøti⁄
 
u£rC⁄fig
,

354 
UdsIndexSessi⁄
 *
£ssi⁄
)

356 i‡(
u£rC⁄fig
 =
NULL
) {

357  
	`logEº‹WôhSåögEº‹
(
UDS_CONF_REQUIRED
,

360  
	`makeLoˇlIndex
(
«me
, 
LOAD_CREATE
, 
u£rC⁄fig
, 
£ssi⁄
);

361 
	}
}

364 
	$udsLﬂdLoˇlIndex
(c⁄° *
«me
,

365 
UdsIndexSessi⁄
 *
£ssi⁄
)

367  
	`makeLoˇlIndex
(
«me
, 
LOAD_LOAD
, 
NULL
, 
£ssi⁄
);

368 
	}
}

371 
	$udsRebuûdLoˇlIndex
(c⁄° *
«me
,

372 
UdsIndexSessi⁄
 *
£ssi⁄
)

374  
	`makeLoˇlIndex
(
«me
, 
LOAD_REBUILD
, 
NULL
, 
£ssi⁄
);

375 
	}
}

377 #i‡
GRID


379 
	$udsAâachGridIndex
(
UdsGridC⁄fig
 
gridC⁄fig
, 
UdsIndexSessi⁄
 *
£ssi⁄
)

381 i‡(
£ssi⁄
 =
NULL
) {

382  
UDS_NO_INDEXSESSION
;

384  
	`makeIndexSessi⁄
(
gridC⁄fig
, 
LOAD_ATTACH
, 
NULL
, &
£ssi⁄
->
id
);

385 
	}
}

389 c⁄° *
	$udsGëVîsi⁄
()

391 #ifde‡
UDS_VERSION


392  
UDS_VERSION
;

396 
	}
}

399 c⁄° *
	$udsSåögEº‹
(
î∫um
, *
buf
, 
size_t
 
buÊí
)

401 i‡(
buf
 =
NULL
) {

402  
NULL
;

405  
	`°rögEº‹
(
î∫um
, 
buf
, 
buÊí
);

406 
	}
}

	@uds/udsModule.c

22 
	~<löux/moduÀ.h
>

24 
	~"buf„r.h
"

25 
	~"loggî.h
"

26 
	~"mem‹yAŒoc.h
"

27 
	~"sysfs.h
"

28 
	~"timeUtûs.h
"

29 
	~"uds.h
"

30 
	~"uds-block.h
"

31 
	~"uds-∑øm.h
"

34 
__öô
 
	$dedu≥Inô
()

36 
	`mem‹yInô
();

37 
	`logInfo
("%†°¨tög", 
THIS_MODULE
->
«me
);

38 
	`öôSysfs
();

40 
	}
}

43 
__exô
 
	$dedu≥Exô
()

45 
	`udsShutdown
();

46 
	`putSysfs
();

47 
	`mem‹yExô
();

48 
	`logInfo
("%†exôög", 
THIS_MODULE
->
«me
);

49 
	}
}

52 
moduÀ_öô
(
dedu≥Inô
);

53 
moduÀ_exô
(
dedu≥Exô
);

55 
EXPORT_SYMBOL
(
UDS_MEMORY_CONFIG_256MB
);

56 
EXPORT_SYMBOL
(
UDS_MEMORY_CONFIG_512MB
);

57 
EXPORT_SYMBOL
(
UDS_MEMORY_CONFIG_768MB
);

58 
EXPORT_SYMBOL
(
UDS_MEMORY_CONFIG_MAX
);

59 
EXPORT_SYMBOL
(
udsCÆcuœãSHA256ChunkName
);

60 
EXPORT_SYMBOL
(
udsCÆcuœãMurmur3ChunkName
);

61 
EXPORT_SYMBOL
(
udsEquÆChunkName
);

62 
EXPORT_SYMBOL
(
udsInôülizeC⁄figuøti⁄
);

63 
EXPORT_SYMBOL
(
udsCompuãIndexSize
);

64 
EXPORT_SYMBOL
(
udsC⁄figuøti⁄SëS∑r£
);

65 
EXPORT_SYMBOL
(
udsC⁄figuøti⁄GëS∑r£
);

66 
EXPORT_SYMBOL
(
udsC⁄figuøti⁄SëCheckpoötFªquícy
);

67 
EXPORT_SYMBOL
(
udsC⁄figuøti⁄GëCheckpoötFªquícy
);

68 
EXPORT_SYMBOL
(
udsC⁄figuøti⁄GëMem‹y
);

69 
EXPORT_SYMBOL
(
udsC⁄figuøti⁄GëCh≠ãrsPîVﬁume
);

70 
EXPORT_SYMBOL
(
udsFªeC⁄figuøti⁄
);

71 
EXPORT_SYMBOL
(
udsGëVîsi⁄
);

72 
EXPORT_SYMBOL
(
udsCª©eLoˇlIndex
);

73 
EXPORT_SYMBOL
(
udsLﬂdLoˇlIndex
);

74 
EXPORT_SYMBOL
(
udsRebuûdLoˇlIndex
);

75 
EXPORT_SYMBOL
(
udsClo£IndexSessi⁄
);

76 
EXPORT_SYMBOL
(
udsSåögEº‹
);

78 
EXPORT_SYMBOL
(
udsO≥nBlockC⁄ãxt
);

79 
EXPORT_SYMBOL
(
udsClo£BlockC⁄ãxt
);

80 
EXPORT_SYMBOL
(
udsFlushBlockC⁄ãxt
);

81 
EXPORT_SYMBOL
(
udsRegi°îDedu≥BlockCÆlback
);

82 
EXPORT_SYMBOL
(
udsSëBlockC⁄ãxtReque°QueueLimô
);

83 
EXPORT_SYMBOL
(
udsSëBlockC⁄ãxtHashAlg‹ôhm
);

84 
EXPORT_SYMBOL
(
udsPo°Block
);

85 
EXPORT_SYMBOL
(
udsPo°BlockName
);

86 
EXPORT_SYMBOL
(
udsQuîyBlockName
);

87 
EXPORT_SYMBOL
(
udsCheckBlock
);

88 
EXPORT_SYMBOL
(
udsUpd©eBlockM≠pög
);

89 
EXPORT_SYMBOL
(
udsDñëeBlockM≠pög
);

90 
EXPORT_SYMBOL
(
udsSèπChunkO≥øti⁄
);

91 
EXPORT_SYMBOL
(
udsGëBlockC⁄ãxtC⁄figuøti⁄
);

92 
EXPORT_SYMBOL
(
udsGëBlockC⁄ãxtIndexSèts
);

93 
EXPORT_SYMBOL
(
udsGëBlockC⁄ãxtSèts
);

94 
EXPORT_SYMBOL
(
udsRe£tBlockC⁄ãxtSèts
);

96 
EXPORT_SYMBOL
(
UDS_PARAM_FALSE
);

97 
EXPORT_SYMBOL
(
UDS_PARAM_TRUE
);

98 
EXPORT_SYMBOL
(
udsGëP¨amëî
);

99 
EXPORT_SYMBOL
(
udsIãøãP¨amëî
);

100 
EXPORT_SYMBOL
(
udsRe£tP¨amëî
);

101 
EXPORT_SYMBOL
(
udsSëP¨amëî
);

102 
EXPORT_SYMBOL
(
udsSåögVÆue
);

103 
EXPORT_SYMBOL
(
udsUnsig√dVÆue
);

105 
EXPORT_SYMBOL_GPL
(
ÆloˇãMem‹y
);

106 
EXPORT_SYMBOL_GPL
(
as£πi⁄Faûed
);

107 
EXPORT_SYMBOL_GPL
(
as£πi⁄FaûedLogO∆y
);

108 
EXPORT_SYMBOL_GPL
(
com∑˘Buf„r
);

109 
EXPORT_SYMBOL_GPL
(
c⁄ã¡Lígth
);

110 
EXPORT_SYMBOL_GPL
(
c›yByãs
);

111 
EXPORT_SYMBOL_GPL
(
cuºítTime
);

112 
EXPORT_SYMBOL_GPL
(
du∂iˇãSåög
);

113 
EXPORT_SYMBOL_GPL
(
ísuªAvaûabÀS∑˚
);

114 
EXPORT_SYMBOL_GPL
(
fixedS¥ötf
);

115 
EXPORT_SYMBOL_GPL
(
‰ìBuf„r
);

116 
EXPORT_SYMBOL_GPL
(
‰ìMem‹y
);

117 
EXPORT_SYMBOL_GPL
(
gëByãsFromBuf„r
);

118 
EXPORT_SYMBOL_GPL
(
gëMem‹ySèts
);

119 
EXPORT_SYMBOL_GPL
(
makeBuf„r
);

120 
EXPORT_SYMBOL_GPL
(
nowU£c
);

121 
EXPORT_SYMBOL_GPL
(
putByãs
);

122 
EXPORT_SYMBOL_GPL
(
ªÆloˇãMem‹y
);

123 
EXPORT_SYMBOL_GPL
(
ªc‹dBioAŒoc
);

124 
EXPORT_SYMBOL_GPL
(
ªc‹dBioFªe
);

125 
EXPORT_SYMBOL_GPL
(
ªgi°îAŒoˇtögThªad
);

126 
EXPORT_SYMBOL_GPL
(
ªp‹tMem‹yUßge
);

127 
EXPORT_SYMBOL_GPL
(
ªwödBuf„r
);

128 
EXPORT_SYMBOL_GPL
(
skùF‹w¨d
);

129 
EXPORT_SYMBOL_GPL
(
uƒegi°îAŒoˇtögThªad
);

133 #ifde‡
UDS_TESTING


135 
	~"blockIORegi⁄.h
"

136 
	~"buf„ªdIORegi⁄.h
"

137 
	~"hashUtûs.h
"

138 
	~"ödexCheckpoöt.h
"

139 
	~"ödexI¡î«ls.h
"

140 
	~"loˇlIndexRouãr.h
"

141 
	~"›íCh≠ãr.h
"

142 
	~"∑ømëî.h
"

143 
	~"øndom.h
"

144 
	~"ªc‹dPage.h
"

145 
	~"ªque°Queue.h
"

146 
	~"ªsour˚Defs.h
"

147 
	~"£¨chLi°.h
"

148 
	~"sögÀFûeLayout.h
"

149 
	~"vﬁumeI¡î«ls.h
"

150 
	~"z⁄e.h
"

152 
EXPORT_SYMBOL_GPL
(
INDEX_PAGE_MAP_INFO
);

153 
EXPORT_SYMBOL_GPL
(
MASTER_INDEX_INFO
);

154 
EXPORT_SYMBOL_GPL
(
OPEN_CHAPTER_INFO
);

155 
EXPORT_SYMBOL_GPL
(
READ_ONLY_INDEX
);

156 
EXPORT_SYMBOL_GPL
(
UDS_PARALLEL_FACTOR
);

157 
EXPORT_SYMBOL_GPL
(
UDS_PARAMETER_TEST_PARAM
);

158 
EXPORT_SYMBOL_GPL
(
UDS_TIME_REQUEST_TURNAROUND
);

159 
EXPORT_SYMBOL_GPL
(
UDS_VOLUME_READ_THREADS
);

160 
EXPORT_SYMBOL_GPL
(
VOLUME_MAGIC_LENGTH
);

161 
EXPORT_SYMBOL_GPL
(
VOLUME_MAGIC_NUMBER
);

162 
EXPORT_SYMBOL_GPL
(
VOLUME_VERSION
);

163 
EXPORT_SYMBOL_GPL
(
VOLUME_VERSION_LENGTH
);

165 
EXPORT_SYMBOL_GPL
(
MurmurHash3_x64_128
);

166 
EXPORT_SYMBOL_GPL
(
MurmurHash3_x64_128_doubÀ
);

167 
EXPORT_SYMBOL_GPL
(
acquúeSem≠h‹e
);

168 
EXPORT_SYMBOL_GPL
(
ÆlocS¥ötf
);

169 
EXPORT_SYMBOL_GPL
(
ÆloˇãIndex
);

170 
EXPORT_SYMBOL_GPL
(
≠≥ndToBuf„r
);

171 
EXPORT_SYMBOL_GPL
(
as£πPageInCache
);

172 
EXPORT_SYMBOL_GPL
(
©ãm±Sem≠h‹e
);

173 
EXPORT_SYMBOL_GPL
(
avaûabÀS∑˚
);

174 
EXPORT_SYMBOL_GPL
(
brﬂdˇ°C⁄d
);

175 
EXPORT_SYMBOL_GPL
(
˛o£O≥nCh≠ãr
);

176 
EXPORT_SYMBOL_GPL
(
compuãBôs
);

177 
EXPORT_SYMBOL_GPL
(
compuãDñèIndexSaveByãs
);

178 
EXPORT_SYMBOL_GPL
(
compuãMa°îIndexSaveBlocks
);

179 
EXPORT_SYMBOL_GPL
(
cou¡Sessi⁄s
);

180 
EXPORT_SYMBOL_GPL
(
¸óãReque°
);

181 
EXPORT_SYMBOL_GPL
(
¸óãThªad
);

182 
EXPORT_SYMBOL_GPL
(
de°royB¨rõr
);

183 
EXPORT_SYMBOL_GPL
(
de°royC⁄d
);

184 
EXPORT_SYMBOL_GPL
(
de°royMuãx
);

185 
EXPORT_SYMBOL_GPL
(
de°roySem≠h‹e
);

186 
EXPORT_SYMBOL_GPL
(
disˇrdIndexSèãD©a
);

187 
EXPORT_SYMBOL_GPL
(
disˇrdLa°IndexSèãSave
);

188 
EXPORT_SYMBOL_GPL
(
di•©chIndexReque°
);

189 
EXPORT_SYMBOL_GPL
(
em±yO≥nCh≠ãrIndex
);

190 
EXPORT_SYMBOL_GPL
(
ícodeRec‹dPage
);

191 
EXPORT_SYMBOL_GPL
(
íqueuePageRód
);

192 
EXPORT_SYMBOL_GPL
(
íqueueRód
);

193 
EXPORT_SYMBOL_GPL
(
íãrB¨rõr
);

194 
EXPORT_SYMBOL_GPL
(
evítCou¡Brﬂdˇ°
);

195 
EXPORT_SYMBOL_GPL
(
evítCou¡C™˚l
);

196 
EXPORT_SYMBOL_GPL
(
evítCou¡Pª∑ª
);

197 
EXPORT_SYMBOL_GPL
(
evítCou¡Waô
);

198 
EXPORT_SYMBOL_GPL
(
exôThªad
);

199 
EXPORT_SYMBOL_GPL
(
exãndDñèMem‹y
);

200 
EXPORT_SYMBOL_GPL
(
fûlR™domly
);

201 
EXPORT_SYMBOL_GPL
(
födIndexComp⁄ít
);

202 
EXPORT_SYMBOL_GPL
(
födInvÆid©eAndMakeLó°Re˚¡
);

203 
EXPORT_SYMBOL_GPL
(
födVﬁumeCh≠ãrBound¨õsIm∂
);

204 
EXPORT_SYMBOL_GPL
(
föishCheckpoötög
);

205 
EXPORT_SYMBOL_GPL
(
föishPªviousCh≠ãr
);

206 
EXPORT_SYMBOL_GPL
(
föishSavögDñèIndex
);

207 
EXPORT_SYMBOL_GPL
(
föishSessi⁄
);

208 
EXPORT_SYMBOL_GPL
(
ÊushBuf„ªdWrôî
);

209 
EXPORT_SYMBOL_GPL
(
f‹m©Vﬁume
);

210 
EXPORT_SYMBOL_GPL
(
‰ìBuf„ªdRódî
);

211 
EXPORT_SYMBOL_GPL
(
‰ìBuf„ªdWrôî
);

212 
EXPORT_SYMBOL_GPL
(
‰ìC⁄figuøti⁄
);

213 
EXPORT_SYMBOL_GPL
(
‰ìEvítCou¡
);

214 
EXPORT_SYMBOL_GPL
(
‰ìFu¬ñQueue
);

215 
EXPORT_SYMBOL_GPL
(
‰ìGeomëry
);

216 
EXPORT_SYMBOL_GPL
(
‰ìIndex
);

217 
EXPORT_SYMBOL_GPL
(
‰ìIndexRouãr
);

218 
EXPORT_SYMBOL_GPL
(
‰ìO≥nCh≠ãr
);

219 
EXPORT_SYMBOL_GPL
(
‰ìO≥nCh≠ãrIndex
);

220 
EXPORT_SYMBOL_GPL
(
‰ìPageCache
);

221 
EXPORT_SYMBOL_GPL
(
‰ìRadixS‹ãr
);

222 
EXPORT_SYMBOL_GPL
(
‰ìReque°
);

223 
EXPORT_SYMBOL_GPL
(
‰ìSórchLi°
);

224 
EXPORT_SYMBOL_GPL
(
‰ìThªadSèti°ics
);

225 
EXPORT_SYMBOL_GPL
(
‰ìVﬁume
);

226 
EXPORT_SYMBOL_GPL
(
fu¬ñQueuePﬁl
);

227 
EXPORT_SYMBOL_GPL
(
futuªTime
);

228 
EXPORT_SYMBOL_GPL
(
gíî©eChunkName
);

229 
EXPORT_SYMBOL_GPL
(
gëBa£C⁄ãxt
);

230 
EXPORT_SYMBOL_GPL
(
gëBuf„rC⁄ã¡s
);

231 
EXPORT_SYMBOL_GPL
(
gëBuf„ªdRódîPosôi⁄
);

232 
EXPORT_SYMBOL_GPL
(
gëByãs
);

233 
EXPORT_SYMBOL_GPL
(
gëCh≠ãrIndexVútuÆCh≠ãrNumbî
);

234 
EXPORT_SYMBOL_GPL
(
gëDñèIndexDli°BôsU£d
);

235 
EXPORT_SYMBOL_GPL
(
gëDñèIndexE¡ry
);

236 
EXPORT_SYMBOL_GPL
(
gëDñèIndexHighe°Li°Numbî
);

237 
EXPORT_SYMBOL_GPL
(
gëDñèIndexLowe°Li°Numbî
);

238 
EXPORT_SYMBOL_GPL
(
gëDñèIndexSèts
);

239 
EXPORT_SYMBOL_GPL
(
gëMa°îIndexComböedSèts
);

240 
EXPORT_SYMBOL_GPL
(
gëNumC‹es
);

241 
EXPORT_SYMBOL_GPL
(
gëO≥nCh≠ãrIndexSize
);

242 
EXPORT_SYMBOL_GPL
(
gëPage
);

243 
EXPORT_SYMBOL_GPL
(
gëPageCacheCou¡îs
);

244 
EXPORT_SYMBOL_GPL
(
gëPageFromCache
);

245 
EXPORT_SYMBOL_GPL
(
gëPageLocked
);

246 
EXPORT_SYMBOL_GPL
(
gëPagePrŸe˘ed
);

247 
EXPORT_SYMBOL_GPL
(
gëSessi⁄
);

248 
EXPORT_SYMBOL_GPL
(
gëSessi⁄C⁄ã¡s
);

249 
EXPORT_SYMBOL_GPL
(
gëS∑r£CacheCou¡îs
);

250 
EXPORT_SYMBOL_GPL
(
gëThªadId
);

251 
EXPORT_SYMBOL_GPL
(
gëThªadSèti°ics
);

252 
EXPORT_SYMBOL_GPL
(
gëZ⁄eCou¡
);

253 
EXPORT_SYMBOL_GPL
(
hasS∑r£Ch≠ãrs
);

254 
EXPORT_SYMBOL_GPL
(
öôC⁄d
);

255 
EXPORT_SYMBOL_GPL
(
öôMuãx
);

256 
EXPORT_SYMBOL_GPL
(
öôülizeB¨rõr
);

257 
EXPORT_SYMBOL_GPL
(
öôülizeCh≠ãrIndexPage
);

258 
EXPORT_SYMBOL_GPL
(
öôülizeDñèIndex
);

259 
EXPORT_SYMBOL_GPL
(
öôülizeDñèMem‹y
);

260 
EXPORT_SYMBOL_GPL
(
öôülizeDñèMem‹yPage
);

261 
EXPORT_SYMBOL_GPL
(
öôülizeSem≠h‹e
);

262 
EXPORT_SYMBOL_GPL
(
öôülizeSessi⁄
);

263 
EXPORT_SYMBOL_GPL
(
övÆid©ePageCacheF‹Ch≠ãr
);

264 
EXPORT_SYMBOL_GPL
(
övÆid©eS∑r£Cache
);

265 
EXPORT_SYMBOL_GPL
(
isCh≠ãrS∑r£
);

266 
EXPORT_SYMBOL_GPL
(
isRe°‹ögDñèIndexD⁄e
);

267 
EXPORT_SYMBOL_GPL
(
joöThªads
);

268 
EXPORT_SYMBOL_GPL
(
lﬂdO≥nCh≠ãrs
);

269 
EXPORT_SYMBOL_GPL
(
lockMuãx
);

270 
EXPORT_SYMBOL_GPL
(
logDebug
);

271 
EXPORT_SYMBOL_GPL
(
logEº‹
);

272 
EXPORT_SYMBOL_GPL
(
logEº‹WôhSåögEº‹
);

273 
EXPORT_SYMBOL_GPL
(
logInfo
);

274 
EXPORT_SYMBOL_GPL
(
makeBuf„ªdRódî
);

275 
EXPORT_SYMBOL_GPL
(
makeBuf„ªdRegi⁄
);

276 
EXPORT_SYMBOL_GPL
(
makeBuf„ªdWrôî
);

277 
EXPORT_SYMBOL_GPL
(
makeC⁄figuøti⁄
);

278 
EXPORT_SYMBOL_GPL
(
makeEvítCou¡
);

279 
EXPORT_SYMBOL_GPL
(
makeFu¬ñQueue
);

280 
EXPORT_SYMBOL_GPL
(
makeGeomëry
);

281 
EXPORT_SYMBOL_GPL
(
makeIndex
);

282 
EXPORT_SYMBOL_GPL
(
makeIndexLayout
);

283 
EXPORT_SYMBOL_GPL
(
makeLoˇlIndexRouãr
);

284 
EXPORT_SYMBOL_GPL
(
makeMa°îIndex
);

285 
EXPORT_SYMBOL_GPL
(
makeO≥nCh≠ãr
);

286 
EXPORT_SYMBOL_GPL
(
makeO≥nCh≠ãrIndex
);

287 
EXPORT_SYMBOL_GPL
(
makePageCache
);

288 
EXPORT_SYMBOL_GPL
(
makePageMo°Re˚¡
);

289 
EXPORT_SYMBOL_GPL
(
makeRadixS‹ãr
);

290 
EXPORT_SYMBOL_GPL
(
makeReque°Queue
);

291 
EXPORT_SYMBOL_GPL
(
makeSórchLi°
);

292 
EXPORT_SYMBOL_GPL
(
makeSessi⁄Group
);

293 
EXPORT_SYMBOL_GPL
(
makeUƒecovîabÀ
);

294 
EXPORT_SYMBOL_GPL
(
makeVﬁume
);

295 
EXPORT_SYMBOL_GPL
(
m≠ToPhysiˇlPage
);

296 
EXPORT_SYMBOL_GPL
(
memdup
);

297 
EXPORT_SYMBOL_GPL
(
möMa°îIndexDñèLi°s
);

298 
EXPORT_SYMBOL_GPL
(
moveBôs
);

299 
EXPORT_SYMBOL_GPL
(
√xtDñèIndexE¡ry
);

300 
EXPORT_SYMBOL_GPL
(
√xtTokí
);

301 
EXPORT_SYMBOL_GPL
(
›íBlockRegi⁄
);

302 
EXPORT_SYMBOL_GPL
(
›íCh≠ãrSize
);

303 
EXPORT_SYMBOL_GPL
(
∑ckO≥nCh≠ãrIndexPage
);

304 
EXPORT_SYMBOL_GPL
(
¥ötThªadSèti°ics
);

305 
EXPORT_SYMBOL_GPL
(
purgeSórchLi°
);

306 
EXPORT_SYMBOL_GPL
(
putDñèIndexE¡ry
);

307 
EXPORT_SYMBOL_GPL
(
putMa°îIndexRec‹d
);

308 
EXPORT_SYMBOL_GPL
(
putO≥nCh≠ãr
);

309 
EXPORT_SYMBOL_GPL
(
putO≥nCh≠ãrIndexRec‹d
);

310 
EXPORT_SYMBOL_GPL
(
putPageInCache
);

311 
EXPORT_SYMBOL_GPL
(
ødixS‹t
);

312 
EXPORT_SYMBOL_GPL
(
øndomInR™ge
);

313 
EXPORT_SYMBOL_GPL
(
ªadBuf„ªdD©a
);

314 
EXPORT_SYMBOL_GPL
(
ªadFromBuf„ªdRódî
);

315 
EXPORT_SYMBOL_GPL
(
ªadSavedDñèLi°
);

316 
EXPORT_SYMBOL_GPL
(
ªgi°îEº‹Block
);

317 
EXPORT_SYMBOL_GPL
(
ªlTimeToSåög
);

318 
EXPORT_SYMBOL_GPL
(
ªÀa£Ba£C⁄ãxt
);

319 
EXPORT_SYMBOL_GPL
(
ªÀa£Sem≠h‹e
);

320 
EXPORT_SYMBOL_GPL
(
ªÀa£Sessi⁄
);

321 
EXPORT_SYMBOL_GPL
(
ªmoveDñèIndexE¡ry
);

322 
EXPORT_SYMBOL_GPL
(
ªmoveFromO≥nCh≠ãr
);

323 
EXPORT_SYMBOL_GPL
(
ªmoveMa°îIndexRec‹d
);

324 
EXPORT_SYMBOL_GPL
(
ªque°QueueEnqueue
);

325 
EXPORT_SYMBOL_GPL
(
ªque°QueueFöish
);

326 
EXPORT_SYMBOL_GPL
(
ª£tO≥nCh≠ãr
);

327 
EXPORT_SYMBOL_GPL
(
ª£tZ⁄eCou¡
);

328 
EXPORT_SYMBOL_GPL
(
ª°‹eDñèLi°ToDñèIndex
);

329 
EXPORT_SYMBOL_GPL
(
ª°‹eMa°îIndex
);

330 
EXPORT_SYMBOL_GPL
(
ßmeBôs
);

331 
EXPORT_SYMBOL_GPL
(
ßnsUƒecovîabÀ
);

332 
EXPORT_SYMBOL_GPL
(
ßveIndex
);

333 
EXPORT_SYMBOL_GPL
(
ßveO≥nCh≠ãrs
);

334 
EXPORT_SYMBOL_GPL
(
£¨chCh≠ãrIndexPage
);

335 
EXPORT_SYMBOL_GPL
(
£¨chO≥nCh≠ãr
);

336 
EXPORT_SYMBOL_GPL
(
£¨chRec‹dPage
);

337 
EXPORT_SYMBOL_GPL
(
£À˘Vi˘imInCache
);

338 
EXPORT_SYMBOL_GPL
(
£tBuf„ªdRódîPosôi⁄
);

339 
EXPORT_SYMBOL_GPL
(
£tByãs
);

340 
EXPORT_SYMBOL_GPL
(
£tDñèE¡ryVÆue
);

341 
EXPORT_SYMBOL_GPL
(
£tIndexCheckpoötFªquícy
);

342 
EXPORT_SYMBOL_GPL
(
£tMa°îIndexRec‹dCh≠ãr
);

343 
EXPORT_SYMBOL_GPL
(
£tReque°Re°¨ãr
);

344 
EXPORT_SYMBOL_GPL
(
£tTe°P¨amëîDeföôi⁄Func
);

345 
EXPORT_SYMBOL_GPL
(
£tZ⁄eCou¡
);

346 
EXPORT_SYMBOL_GPL
(
shutdownSessi⁄Group
);

347 
EXPORT_SYMBOL_GPL
(
sig«lC⁄d
);

348 
EXPORT_SYMBOL_GPL
(
¶ìpF‹
);

349 
EXPORT_SYMBOL_GPL
(
•a˚RemaöögInWrôeBuf„r
);

350 
EXPORT_SYMBOL_GPL
(
°¨tDñèIndexSórch
);

351 
EXPORT_SYMBOL_GPL
(
°¨tRe°‹ögDñèIndex
);

352 
EXPORT_SYMBOL_GPL
(
°¨tSavögDñèIndex
);

353 
EXPORT_SYMBOL_GPL
(
°›Ch≠ãrWrôî
);

354 
EXPORT_SYMBOL_GPL
(
°rögEº‹
);

355 
EXPORT_SYMBOL_GPL
(
°rögEº‹Name
);

356 
EXPORT_SYMBOL_GPL
(
timeDif„ªn˚
);

357 
EXPORT_SYMBOL_GPL
(
timedWaôC⁄d
);

358 
EXPORT_SYMBOL_GPL
(
udsShutdown
);

359 
EXPORT_SYMBOL_GPL
(
unöôülizeDñèIndex
);

360 
EXPORT_SYMBOL_GPL
(
unöôülizeDñèMem‹y
);

361 
EXPORT_SYMBOL_GPL
(
u∆ockMuãx
);

362 
EXPORT_SYMBOL_GPL
(
upd©eVﬁumeSize
);

363 
EXPORT_SYMBOL_GPL
(
vAµídToBuf„r
);

364 
EXPORT_SYMBOL_GPL
(
vLogMesßge
);

365 
EXPORT_SYMBOL_GPL
(
vÆid©eDñèIndex
);

366 
EXPORT_SYMBOL_GPL
(
vÆid©eDñèLi°s
);

367 
EXPORT_SYMBOL_GPL
(
vÆid©eNumîicR™ge
);

368 
EXPORT_SYMBOL_GPL
(
waôC⁄d
);

369 
EXPORT_SYMBOL_GPL
(
wasBuf„ªdWrôîU£d
);

370 
EXPORT_SYMBOL_GPL
(
wøpBuf„r
);

371 
EXPORT_SYMBOL_GPL
(
wøpV¢¥ötf
);

372 
EXPORT_SYMBOL_GPL
(
wrôeCh≠ãr
);

373 
EXPORT_SYMBOL_GPL
(
wrôeGu¨dDñèLi°
);

374 
EXPORT_SYMBOL_GPL
(
wrôeIndexPages
);

375 
EXPORT_SYMBOL_GPL
(
wrôeRec‹dPages
);

376 
EXPORT_SYMBOL_GPL
(
wrôeToBuf„ªdWrôî
);

377 
EXPORT_SYMBOL_GPL
(
yõldScheduÀr
);

378 
EXPORT_SYMBOL_GPL
(
zîoByãs
);

383 
MODULE_DESCRIPTION
("deduplicationÉngine");

384 
MODULE_AUTHOR
("Red Hat, Inc.");

385 
MODULE_LICENSE
("GPL");

386 
MODULE_VERSION
(
UDS_VERSION
);

	@uds/udsState.c

22 
	~"udsSèã.h
"

24 
	~"c⁄ãxt.h
"

25 
	~"îr‹s.h
"

26 
	~"„©uªDefs.h
"

27 
	~"ödexSessi⁄.h
"

28 
	~"ödexRouãr.h
"

29 
	~"isCÆlbackThªadDefs.h
"

30 
	~"loggî.h
"

31 
	~"mem‹yAŒoc.h
"

32 
	~"ªque°.h
"

38 
	mUDS_GS_UNINIT
 = 1,

39 
	mUDS_GS_RUNNING
 = 2,

40 
	mUDS_GS_SHUTTING_DOWN
 = 3

41 } 
	tUdsGSèã
;

44 
	mcookõ
[16];

45 
	mvîsi⁄
[16];

46 
Muãx
 
	mmuãx
;

47 
	mhashQueueCou¡
;

48 
Reque°Queue
 **
	mhashQueues
;

49 #i‡
GRID


50 
Reque°Queue
 *
	mªmŸeQueue
;

52 
Reque°Queue
 *
	mˇŒbackQueue
;

53 
Sessi⁄Group
 *
	mödexSessi⁄s
;

54 
Sessi⁄Group
 *
	mc⁄ãxts
;

55 
UdsGSèã
 
	mcuºítSèã
;

56 #i‡
DESTRUCTOR


57 
UdsShutdownHook
 *
	mshutdownHook
;

59 } 
	tUdsGlobÆSèã
;

61 
UdsGlobÆSèã
 
	gudsSèã
;

66 
	mSTATE_UNINITIALIZED
 = 0,

67 
	mSTATE_IN_TRANSIT
 = 1,

68 
	mSTATE_RUNNING
 = 2,

71 
Atomic32
 
	göôSèã
 = 
ATOMIC_INITIALIZER
(
STATE_UNINITIALIZED
);

74 
	$lockGlobÆSèãMuãx
()

76 
	`lockMuãx
(&
udsSèã
.
muãx
);

77 
	}
}

80 
	$u∆ockGlobÆSèãMuãx
()

82 
	`u∆ockMuãx
(&
udsSèã
.
muãx
);

83 
	}
}

86 
	$checkLibøryRu¬ög
()

88 
udsSèã
.
cuºítSèã
) {

89 
UDS_GS_RUNNING
:

90  
UDS_SUCCESS
;

92 
UDS_GS_SHUTTING_DOWN
:

93  
UDS_SHUTTINGDOWN
;

95 
UDS_GS_UNINIT
:

97  
UDS_UNINITIALIZED
;

99 
	}
}

102 
	$compuãHash
(
Reque°
 *
ªque°
)

105 i‡(
ªque°
->
isC⁄åﬁMesßge
) {

106 
	`íqueueReque°
(
ªque°
, 
STAGE_TRIAGE
);

110 
UdsChunkName
 
«me


111 
ªque°
->
c⁄ãxt
->
	`chunkNameGíî©‹
‘eque°->
d©a
,Ñeque°->
d©aLígth
);

112 
	`£tReque°Hash
(
ªque°
, &
«me
);

116 
	`FREE
(
ªque°
->
d©a
);

117 
ªque°
->
d©a
 = 
NULL
;

119 
	`íqueueReque°
(
ªque°
, 
STAGE_TRIAGE
);

120 
	}
}

123 
	$öôülizeHashQueues
()

127 
numC‹es
 = 
	`gëNumC‹es
();

128 
Reque°Queue
 **
hashQueues
;

129 
ªsu…
 = 
	`ALLOCATE
(
numC‹es
, 
Reque°Queue
 *, 
__func__
, &
hashQueues
);

130 i‡(
ªsu…
 !
UDS_SUCCESS
) {

131  
ªsu…
;

133 
i
 = 0; i < 
numC‹es
; i++) {

134 
ªsu…
 = 
	`makeReque°Queue
("hashW‹kî", &
compuãHash
, &
hashQueues
[
i
]);

135 i‡(
ªsu…
 !
UDS_SUCCESS
) {

136 
j
 = 0; j < 
i
; j++) {

137 
	`ªque°QueueFöish
(
hashQueues
[
i
]);

139 
	`FREE
(
hashQueues
);

140  
	`logEº‹WôhSåögEº‹
(
ªsu…
, "Cannot start hash workerÅhread");

143 
udsSèã
.
hashQueueCou¡
 = 
numC‹es
;

144 
udsSèã
.
hashQueues
 = hashQueues;

145  
UDS_SUCCESS
;

146 
	}
}

149 
Reque°Queue
 *
	$gëNextHashQueue
(
Reque°
 *
ªque°
)

153 i‡(
udsSèã
.
hashQueueCou¡
 == 0) {

154 i‡(
ªque°
->
a˘i⁄
 =
REQUEST_FINISH
) {

155  
ªque°
->
rouãr
->
mëhods
->
	`£À˘Queue
(request->router,Ñequest,

156 
STAGE_TRIAGE
);

158 
ªsu…
 = 
UDS_SUCCESS
;;

159 
	`lockMuãx
(&
udsSèã
.
muãx
);

160 i‡(
udsSèã
.
hashQueueCou¡
 == 0) {

161 
ªsu…
 = 
	`öôülizeHashQueues
();

163 
	`u∆ockMuãx
(&
udsSèã
.
muãx
);

164 i‡(
ªsu…
 !
UDS_SUCCESS
) {

165  
NULL
;

176 i‡((
udsSèã
.
hashQueueCou¡
 =1Ë|| (
ªque°
->
c⁄ãxt
 =
NULL
)) {

177  
udsSèã
.
hashQueues
[0];

181 
uöt32_t
 
rŸ‹
 = 
	`©omicAdd32
(&
ªque°
->
c⁄ãxt
->
hashQueueRŸ‹
, 1);

182  
udsSèã
.
hashQueues
[
rŸ‹
 % udsSèã.
hashQueueCou¡
];

183 
	}
}

186 
Reque°Queue
 *
	$gëCÆlbackQueue
()

188  
udsSèã
.
ˇŒbackQueue
;

189 
	}
}

191 #i‡
GRID


197 
	$ªmŸeIndexReque°Pro˚ss‹
(
Reque°
 *
ªque°
)

199 
ªque°
->
rouãr
->
mëhods
->
	`execuã
(request->router,Ñequest);

200 
	}
}

203 
	$öôülizeRemŸeQueue
()

205 
ªt
 = 
UDS_SUCCESS
;

206 i‡(
udsSèã
.
ªmŸeQueue
 =
NULL
) {

207 
	`lockMuãx
(&
udsSèã
.
muãx
);

208 i‡(
udsSèã
.
ªmŸeQueue
 =
NULL
) {

209 
ªt
 = 
	`makeReque°Queue
("ªmŸeIndexW‹kî", &
ªmŸeIndexReque°Pro˚ss‹
,

210 &
udsSèã
.
ªmŸeQueue
);

212 
	`u∆ockMuãx
(&
udsSèã
.
muãx
);

214  
ªt
;

215 
	}
}

218 
Reque°Queue
 *
	$gëRemŸeQueue
()

220  
udsSèã
.
ªmŸeQueue
;

221 
	}
}

224 
	$‰ìRemŸeQueue
()

226 
	`ªque°QueueFöish
(
udsSèã
.
ªmŸeQueue
);

227 
udsSèã
.
ªmŸeQueue
 = 
NULL
;

228 
	}
}

232 
Sessi⁄Group
 *
	$gëC⁄ãxtGroup
()

234 
	`udsInôülize
();

235  
udsSèã
.
c⁄ãxts
;

236 
	}
}

239 
Sessi⁄Group
 *
	$gëIndexSessi⁄Group
()

241 
	`udsInôülize
();

242  
udsSèã
.
ödexSessi⁄s
;

243 
	}
}

252 
	$h™dÀCÆlbacks
(
Reque°
 *
ªque°
)

254 i‡(
ªque°
->
isC⁄åﬁMesßge
) {

255 
ªque°
->
°©us
 = 
	`di•©chC⁄ãxtC⁄åﬁReque°
(request);

261 
	`íãrCÆlbackSège
(
ªque°
);

265 #i‡
NAMESPACES


266 
	`x‹Name•a˚
(&
ªque°
->
hash
, &ªque°->
c⁄ãxt
->
«me•a˚Hash
);

269 i‡(
ªque°
->
°©us
 =
UDS_SUCCESS
) {

272 
	`upd©eReque°C⁄ãxtSèts
(
ªque°
);

275 i‡(
ªque°
->
ˇŒback
 !
NULL
) {

278 
	`FREE
(
ªque°
->
£rvîC⁄ãxt
);

279 
ªque°
->
£rvîC⁄ãxt
 = 
NULL
;

280 
UdsC⁄ãxt
 *
c⁄ãxt
 = 
ªque°
->context;

281 
ªque°
->
found
 = (ªque°->
loˇti⁄
 !
LOC_UNAVAILABLE
);

282 
ªque°
->
	`ˇŒback
((
UdsReque°
 *)Ñequest);

283 
	`ªÀa£Ba£C⁄ãxt
(
c⁄ãxt
);

287 i‡(
ªque°
->
c⁄ãxt
->
hasCÆlback
) {

290 
	`£tCÆlbackThªad
(
ªque°
);

292 
ªque°
->
c⁄ãxt
->
	`ˇŒbackH™dÀr
(request);

294 
	`£tCÆlbackThªad
(
NULL
);

297 
	`‰ìReque°
(
ªque°
);

298 
	}
}

307 
	$f‹˚FªeC⁄ãxt
(
Sessi⁄C⁄ã¡s
 
c⁄ã¡s
)

309 
	`‰ìC⁄ãxt
((
UdsC⁄ãxt
 *Ë
c⁄ã¡s
);

310 
	}
}

313 
	$f‹˚FªeIndexSessi⁄
(
Sessi⁄C⁄ã¡s
 
c⁄ã¡s
)

315 
	`ßveAndFªeIndexSessi⁄
((
IndexSessi⁄
 *Ë
c⁄ã¡s
);

316 
	}
}

319 
	$udsInôülizeLocked
()

321 
ªsu…
 = 
	`makeReque°Queue
("ˇŒbackW‹kî", &
h™dÀCÆlbacks
,

322 &
udsSèã
.
ˇŒbackQueue
);

323 i‡(
ªsu…
 !
UDS_SUCCESS
) {

324  
ªsu…
;

328 
ªsu…
 = 
	`makeSessi⁄Group
(
UDS_NOCONTEXT
, 
f‹˚FªeC⁄ãxt
,

329 &
udsSèã
.
c⁄ãxts
);

330 i‡(
ªsu…
 !
UDS_SUCCESS
) {

331  
ªsu…
;

333 
ªsu…
 = 
	`makeSessi⁄Group
(
UDS_NO_INDEXSESSION
, 
f‹˚FªeIndexSessi⁄
,

334 &
udsSèã
.
ödexSessi⁄s
);

335 i‡(
ªsu…
 !
UDS_SUCCESS
) {

336  
ªsu…
;

339 
udsSèã
.
cuºítSèã
 = 
UDS_GS_RUNNING
;

340  
UDS_SUCCESS
;

341 
	}
}

344 
	$udsInôülizeOn˚
()

346 
	`ísuªSènd¨dEº‹Blocks
();

347 
	`›íLoggî
();

348 
	`¸óãCÆlbackThªad
();

350 
	`logNŸi˚
("UDS sèπög u∞(%s)", 
	`udsGëVîsi⁄
());

352 
	`mem£t
(&
udsSèã
, 0, (udsState));

353 
	`°∫˝y
(
udsSèã
.
cookõ
, "udsStateCookie", (udsState.cookie));

354 #ifde‡
UDS_VERSION


355 
	`°∫˝y
(
udsSèã
.
vîsi⁄
, 
UDS_VERSION
, (udsState.version));

357 
	`°∫˝y
(
udsSèã
.
vîsi⁄
, "internal", (udsState.version));

359 
udsSèã
.
cuºítSèã
 = 
UDS_GS_UNINIT
;

360 #i‡
DESTRUCTOR


361 
udsSèã
.
shutdownHook
 = 
udsShutdown
;

363 
	`öôülizeMuãx
(&
udsSèã
.
muãx
, 
åue
);

365 
	`lockMuãx
(&
udsSèã
.
muãx
);

366 
ªsu…
 = 
	`udsInôülizeLocked
();

367 
	`u∆ockMuãx
(&
udsSèã
.
muãx
);

368  
ªsu…
;

369 
	}
}

371 #i‡
DESTRUCTOR


373 
UdsShutdownHook
 *
	$udsSëShutdownHook
(
UdsShutdownHook
 *
shutdownHook
)

375 
	`udsInôülize
();

376 
UdsShutdownHook
 *
ﬁdUdsShutdownHook
 = 
udsSèã
.
shutdownHook
;

377 
udsSèã
.
shutdownHook
 = shutdownHook;

378  
ﬁdUdsShutdownHook
;

379 
	}
}

382 
__©åibuã__
((
de°ru˘‹
))

383 
	$udsShutdownDe°ru˘‹
()

385 i‡(
udsSèã
.
shutdownHook
 !
NULL
) {

386 (*
udsSèã
.
shutdownHook
)();

388 
	}
}

392 
	$udsShutdownOn˚
()

394 
	`lockMuãx
(&
udsSèã
.
muãx
);

396 
udsSèã
.
cuºítSèã
 = 
UDS_GS_SHUTTING_DOWN
;

400 i‡(
udsSèã
.
c⁄ãxts
 !
NULL
) {

401 
	`shutdownSessi⁄Group
(
udsSèã
.
c⁄ãxts
);

402 
udsSèã
.
c⁄ãxts
 = 
NULL
;

407 i‡(
udsSèã
.
ödexSessi⁄s
 !
NULL
) {

408 
	`shutdownSessi⁄Group
(
udsSèã
.
ödexSessi⁄s
);

409 
udsSèã
.
ödexSessi⁄s
 = 
NULL
;

413 i‡(
udsSèã
.
hashQueues
 !
NULL
) {

414 
i
 = 0; i < 
udsSèã
.
hashQueueCou¡
; i++) {

415 
	`ªque°QueueFöish
(
udsSèã
.
hashQueues
[
i
]);

417 
	`FREE
(
udsSèã
.
hashQueues
);

418 
udsSèã
.
hashQueues
 = 
NULL
;

419 
udsSèã
.
hashQueueCou¡
 = 0;

421 #i‡
GRID


422 
	`‰ìRemŸeQueue
();

424 
	`ªque°QueueFöish
(
udsSèã
.
ˇŒbackQueue
);

425 
udsSèã
.
ˇŒbackQueue
 = 
NULL
;

426 
	`u∆ockMuãx
(&
udsSèã
.
muãx
);

428 
	`logNŸi˚
("UDS shuâög dow¿(%s)", 
	`udsGëVîsi⁄
());

430 
	`de°royMuãx
(&
udsSèã
.
muãx
);

431 
	`˛o£Loggî
();

432 
	`dñëeCÆlbackThªad
();

433 
	}
}

436 
	$udsInôülize
()

439 
	`©omicLﬂd32
(&
öôSèã
)) {

440 
STATE_UNINITIALIZED
:

441 i‡(
	`com∑ªAndSw≠32
(&
öôSèã
, 
STATE_UNINITIALIZED
,

442 
STATE_IN_TRANSIT
)) {

443 i‡(
	`udsInôülizeOn˚
(Ë=
UDS_SUCCESS
) {

444 
	`©omicSt‹e32
(&
öôSèã
, 
STATE_RUNNING
);

447 
	`udsShutdownOn˚
();

448 
	`©omicSt‹e32
(&
öôSèã
, 
STATE_UNINITIALIZED
);

452 
STATE_IN_TRANSIT
:

453 
	`yõldScheduÀr
();

455 
STATE_RUNNING
:

460 
	}
}

463 
	$udsShutdown
()

466 
	`©omicLﬂd32
(&
öôSèã
)) {

467 
STATE_UNINITIALIZED
:

470 
STATE_IN_TRANSIT
:

471 
	`yõldScheduÀr
();

473 
STATE_RUNNING
:

474 i‡(
	`com∑ªAndSw≠32
(&
öôSèã
, 
STATE_RUNNING
,

475 
STATE_IN_TRANSIT
)) {

476 
	`udsShutdownOn˚
();

477 
	`©omicSt‹e32
(&
öôSèã
, 
STATE_UNINITIALIZED
);

483 
	}
}

	@uds/udsState.h

22 #i‚de‡
UDS_STATE_H


23 
	#UDS_STATE_H


	)

25 
	~"„©uªDefs.h
"

26 
	~"ªque°Queue.h
"

27 
	~"£ssi⁄.h
"

32 
udsInôülize
();

37 
lockGlobÆSèãMuãx
();

42 
u∆ockGlobÆSèãMuãx
();

49 
checkLibøryRu¬ög
();

56 c⁄° *
gëModuÀDú
();

63 
Reque°Queue
 *
	$gëNextHashQueue
(
Reque°
 *
ªque°
)

64 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

71 
Reque°Queue
 *
	$gëCÆlbackQueue
(Ë
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

73 #i‡
GRID


79 
	$öôülizeRemŸeQueue
(Ë
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

86 
Reque°Queue
 *
	$gëRemŸeQueue
(Ë
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

91 
	`‰ìRemŸeQueue
();

99 
Sessi⁄Group
 *
	`gëC⁄ãxtGroup
();

106 
Sessi⁄Group
 *
	`gëIndexSessi⁄Group
();

	@uds/util/atomic.h

22 #i‚de‡
ATOMIC_H


23 
	#ATOMIC_H


	)

25 
	~"compûî.h
"

26 
	~"ty≥Defs.h
"

28 
	#ATOMIC_INITIALIZER
(
vÆue
Ë{ (vÆueË}

	)

31 vﬁ©ûê
uöt32_t
 
	mvÆue
;

32 } 
	t__©åibuã__
((
	tÆig√d
(4))Ë
	tAtomic32
;

35 vﬁ©ûê
uöt64_t
 
vÆue
;

36 } 
	t__©åibuã__
((
	tÆig√d
(8))Ë
	tAtomic64
;

39 
Atomic32
 
vÆue
;

40 } 
	t__©åibuã__
((
	tÆig√d
(4))Ë
	tAtomicBoﬁ
;

49 
INLINE
 
	$lﬂdFí˚
()

51 
__asm__
 
	`__vﬁ©ûe__
("lfence" : : : "memory");

52 
	}
}

61 
INLINE
 
	$°‹eFí˚
()

63 
__asm__
 
	`__vﬁ©ûe__
("sfence" : : : "memory");

64 
	}
}

71 
INLINE
 
	$mem‹yFí˚
()

80 
__asm__
 
	`__vﬁ©ûe__
("mfence" : : : "memory");

81 
	}
}

90 
INLINE
 
	$gccFí˚
()

99 
__asm__
 
	`__vﬁ©ûe__
("" : : : "memory");

100 
	}
}

110 
INLINE
 
uöt32_t
 
	$©omicLﬂd32
(c⁄° 
Atomic32
 *
©om
)

112 
uöt32_t
 
vÆue
 = 
©om
->value;

113 
	`lﬂdFí˚
();

114  
vÆue
;

115 
	}
}

126 
INLINE
 
uöt64_t
 
	$©omicLﬂd64
(c⁄° 
Atomic64
 *
©om
)

128 
uöt64_t
 
vÆue
 = 
©om
->value;

129 
	`lﬂdFí˚
();

130  
vÆue
;

131 
	}
}

141 
INLINE
 
boﬁ
 
	$©omicLﬂdBoﬁ
(c⁄° 
AtomicBoﬁ
 *
©om
)

143  (
	`©omicLﬂd32
(&
©om
->
vÆue
) > 0);

144 
	}
}

154 
INLINE
 
	$©omicSt‹e32
(
Atomic32
 *
©om
, 
uöt32_t
 
√wVÆue
)

156 
	`°‹eFí˚
();

157 
©om
->
vÆue
 = 
√wVÆue
;

158 
	}
}

168 
INLINE
 
	$©omicSt‹e64
(
Atomic64
 *
©om
, 
uöt64_t
 
√wVÆue
)

170 
	`°‹eFí˚
();

171 
©om
->
vÆue
 = 
√wVÆue
;

172 
	}
}

182 
INLINE
 
	$©omicSt‹eBoﬁ
(
AtomicBoﬁ
 *
©om
, 
boﬁ
 
√wVÆue
)

184 
	`©omicSt‹e32
(&
©om
->
vÆue
, (
√wVÆue
 ? 1 : 0));

185 
	}
}

195 
INLINE
 
uöt32_t
 
	$©omicAdd32
(
Atomic32
 *
©om
, 
öt32_t
 
dñè
)

197 
	`gccFí˚
();

198 
uöt32_t
 
ªsu…
 = 
	`__sync_add_™d_„tch
(&
©om
->
vÆue
, 
dñè
);

199 
	`gccFí˚
();

200  
ªsu…
;

201 
	}
}

211 
INLINE
 
uöt64_t
 
	$©omicAdd64
(
Atomic64
 *
©om
, 
öt64_t
 
dñè
)

213 
	`gccFí˚
();

214 
uöt64_t
 
ªsu…
 = 
	`__sync_add_™d_„tch
(&
©om
->
vÆue
, 
dñè
);

215 
	`gccFí˚
();

216  
ªsu…
;

217 
	}
}

230 
INLINE
 
boﬁ
 
	$com∑ªAndSw≠32
(
Atomic32
 *
©om
,

231 
uöt32_t
 
ªquúedVÆue
,

232 
uöt32_t
 
√wVÆue
)

234 
	`gccFí˚
();

235 
boﬁ
 
ªsu…


236 
	`__sync_boﬁ_com∑ª_™d_sw≠
(&
©om
->
vÆue
, 
ªquúedVÆue
, 
√wVÆue
);

237 
	`gccFí˚
();

238  
ªsu…
;

239 
	}
}

252 
INLINE
 
boﬁ
 
	$com∑ªAndSw≠64
(
Atomic64
 *
©om
,

253 
uöt64_t
 
ªquúedVÆue
,

254 
uöt64_t
 
√wVÆue
)

256 
	`gccFí˚
();

257 
boﬁ
 
ªsu…


258 
	`__sync_boﬁ_com∑ª_™d_sw≠
(&
©om
->
vÆue
, 
ªquúedVÆue
, 
√wVÆue
);

259 
	`gccFí˚
();

260  
ªsu…
;

261 
	}
}

274 
INLINE
 
boﬁ
 
	$com∑ªAndSw≠Boﬁ
(
AtomicBoﬁ
 *
©om
,

275 
boﬁ
 
ªquúedVÆue
,

276 
boﬁ
 
√wVÆue
)

278  
	`com∑ªAndSw≠32
(&
©om
->
vÆue
, (
ªquúedVÆue
 ? 1 : 0),

279 (
√wVÆue
 ? 1 : 0));

280 
	}
}

290 
INLINE
 
uöt32_t
 
	$ªœxedLﬂd32
(c⁄° 
Atomic32
 *
©om
)

292  
©om
->
vÆue
;

293 
	}
}

303 
INLINE
 
uöt64_t
 
	$ªœxedLﬂd64
(c⁄° 
Atomic64
 *
©om
)

305  
©om
->
vÆue
;

306 
	}
}

316 
INLINE
 
boﬁ
 
	$ªœxedLﬂdBoﬁ
(c⁄° 
AtomicBoﬁ
 *
©om
)

318  (
	`ªœxedLﬂd32
(&
©om
->
vÆue
) > 0);

319 
	}
}

328 
INLINE
 
	$ªœxedSt‹e32
(
Atomic32
 *
©om
, 
uöt32_t
 
√wVÆue
)

330 
©om
->
vÆue
 = 
√wVÆue
;

331 
	}
}

340 
INLINE
 
	$ªœxedSt‹e64
(
Atomic64
 *
©om
, 
uöt64_t
 
√wVÆue
)

342 
©om
->
vÆue
 = 
√wVÆue
;

343 
	}
}

352 
INLINE
 
	$ªœxedSt‹eBoﬁ
(
AtomicBoﬁ
 *
©om
, 
boﬁ
 
√wVÆue
)

354 
	`ªœxedSt‹e32
(&
©om
->
vÆue
, (
√wVÆue
 ? 1 : 0));

355 
	}
}

366 
INLINE
 
uöt32_t
 
	$ªœxedAdd32
(
Atomic32
 *
©om
, 
öt32_t
 
dñè
)

368 
uöt32_t
 
√wVÆue
 = (
	`ªœxedLﬂd32
(
©om
Ë+ 
dñè
);

369 
	`ªœxedSt‹e32
(
©om
, 
√wVÆue
);

370  
√wVÆue
;

371 
	}
}

382 
INLINE
 
uöt64_t
 
	$ªœxedAdd64
(
Atomic64
 *
©om
, 
öt64_t
 
dñè
)

384 
uöt64_t
 
√wVÆue
 = (
	`ªœxedLﬂd64
(
©om
Ë+ 
dñè
);

385 
	`ªœxedSt‹e64
(
©om
, 
√wVÆue
);

386  
√wVÆue
;

387 
	}
}

	@uds/util/eventCount.c

92 
	~"evítCou¡.h
"

94 
	~"©omic.h
"

95 
	~"comm⁄.h
"

96 
	~"compûî.h
"

97 
	~"˝u.h
"

98 
	~"loggî.h
"

99 
	~"mem‹yAŒoc.h
"

100 
	~"thªads.h
"

103 
	mONE_WAITER
 = 1,

104 
	mONE_EVENT
 = (1 << 16),

105 
	mWAITERS_MASK
 = (
ONE_EVENT
 - 1),

106 
	mEVENTS_MASK
 = ~
WAITERS_MASK
,

109 
	mINSTRUMENTED
 = 
Ál£


112 
	sevítCou¡
 {

116 
Atomic64
 
	m°©e
;

119 
Sem≠h‹e
 
	m£m≠h‹e
;

122 
Atomic64
 
	msig«ls
;

123 
Atomic64
 
	mwakeups
;

124 
Atomic64
 
	mwaôs
;

125 
Atomic64
 
	m¶ìps
;

126 
Atomic64
 
	mtimeouts
;

129 } 
__©åibuã__
((
Æig√d
(
CACHE_LINE_BYTES
)));

138 
INLINE
 
	$ö°rumíãdAdd
(
Atomic64
 *
cou¡î
, 
öt64_t
 
dñè
)

140 i‡(
INSTRUMENTED
) {

141 
	`©omicAdd64
(
cou¡î
, 
dñè
);

143 
	}
}

150 
INLINE
 
boﬁ
 
	$ßmeEvít
(
EvítTokí
 
tokí1
, EvítTokí 
tokí2
)

152  ((
tokí1
 & 
EVENTS_MASK
Ë=(
tokí2
 & EVENTS_MASK));

153 
	}
}

156 
	$evítCou¡Brﬂdˇ°
(
EvítCou¡
 *
ec
)

158 
	`ö°rumíãdAdd
(&
ec
->
sig«ls
, 1);

160 
	`mem‹yFí˚
();

162 
waôîs
;

164 
uöt64_t
 
°©e
 = 
	`ªœxedLﬂd64
(&
ec
->state);

167 
waôîs
 = (
°©e
 & 
WAITERS_MASK
);

168 i‡(
waôîs
 == 0) {

178 
EvítTokí
 
√wSèã
 = ((
°©e
 & ~
WAITERS_MASK
Ë+ 
ONE_EVENT
);

179 i‡(
	`likñy
(
	`com∑ªAndSw≠64
(&
ec
->
°©e
, sèã, 
√wSèã
))) {

186 
	`ö°rumíãdAdd
(&
ec
->
wakeups
, 
waôîs
);

193 
waôîs
-- > 0) {

194 
	`ªÀa£Sem≠h‹e
(&
ec
->
£m≠h‹e
, 
__func__
);

196 
	}
}

209 
INLINE
 
boﬁ
 
	$Á°C™˚l
(
EvítCou¡
 *
ec
, 
EvítTokí
 
tokí
)

211 
EvítTokí
 
cuºítTokí
 = 
	`ªœxedLﬂd64
(&
ec
->
°©e
);

212 
	`ßmeEvít
(
cuºítTokí
, 
tokí
)) {

215 i‡(
	`com∑ªAndSw≠64
(&
ec
->
°©e
, 
cuºítTokí
, currentToken - 1)) {

216  
åue
;

218 
cuºítTokí
 = 
	`ªœxedLﬂd64
(&
ec
->
°©e
);

220  
Ál£
;

221 
	}
}

235 
boﬁ
 
	$c⁄sumeWaôTokí
(
EvítCou¡
 *
ec
, c⁄° 
RñTime
 *
timeout
)

238 i‡(
	`©ãm±Sem≠h‹e
(&
ec
->
£m≠h‹e
, 0, 
__func__
)) {

239  
åue
;

242 
	`ö°rumíãdAdd
(&
ec
->
¶ìps
, 1);

244 i‡(
timeout
 =
NULL
) {

245 
	`acquúeSem≠h‹e
(&
ec
->
£m≠h‹e
, 
__func__
);

246 } i‡(!
	`©ãm±Sem≠h‹e
(&
ec
->
£m≠h‹e
, *
timeout
, 
__func__
)) {

247 
	`ö°rumíãdAdd
(&
ec
->
timeouts
, 1);

248  
Ál£
;

250  
åue
;

251 
	}
}

254 
	$makeEvítCou¡
(
EvítCou¡
 **
ecPå
)

258 
EvítCou¡
 *
ec
 = 
NULL
;

259 
ªsu…
 = 
	`ÆloˇãCacheAlig√d
((
EvítCou¡
), "evíàcou¡", &
ec
);

260 i‡(
ªsu…
 !
UDS_SUCCESS
) {

261  
ªsu…
;

264 
	`ªœxedSt‹e64
(&
ec
->
°©e
, 0);

265 
ªsu…
 = 
	`öôülizeSem≠h‹e
(&
ec
->
£m≠h‹e
, 0, 
__func__
);

266 i‡(
ªsu…
 !
UDS_SUCCESS
) {

267 
	`FREE
(
ec
);

268  
ªsu…
;

271 *
ecPå
 = 
ec
;

272  
UDS_SUCCESS
;

273 
	}
}

276 
	$‰ìEvítCou¡
(
EvítCou¡
 *
ec
)

278 i‡(
ec
 =
NULL
) {

281 
	`de°roySem≠h‹e
(&
ec
->
£m≠h‹e
, 
__func__
);

282 
	`FREE
(
ec
);

283 
	}
}

286 
EvítTokí
 
	$evítCou¡Pª∑ª
(
EvítCou¡
 *
ec
)

288  
	`©omicAdd64
(&
ec
->
°©e
, 
ONE_WAITER
);

289 
	}
}

292 
	$evítCou¡C™˚l
(
EvítCou¡
 *
ec
, 
EvítTokí
 
tokí
)

295 i‡(
	`Á°C™˚l
(
ec
, 
tokí
)) {

296  
UDS_SUCCESS
;

300  
	`evítCou¡Waô
(
ec
, 
tokí
, 
NULL
);

301 
	}
}

304 
boﬁ
 
	$evítCou¡Waô
(
EvítCou¡
 *
ec
, 
EvítTokí
 
tokí
, c⁄° 
RñTime
 *
timeout
)

306 
	`ö°rumíãdAdd
(&
ec
->
waôs
, 1);

310 i‡(!
	`c⁄sumeWaôTokí
(
ec
, 
timeout
)) {

313 i‡(
	`Á°C™˚l
(
ec
, 
tokí
)) {

314  
Ál£
;

323 
timeout
 = 
NULL
;

330 i‡(!
	`ßmeEvít
(
tokí
, 
	`ªœxedLﬂd64
(&
ec
->
°©e
))) {

331  
åue
;

336 
	`ªÀa£Sem≠h‹e
(&
ec
->
£m≠h‹e
, 
__func__
);

339 
	`yõldScheduÀr
();

341 
	}
}

	@uds/util/eventCount.h

22 #i‚de‡
EVENT_COUNT_H


23 
	#EVENT_COUNT_H


	)

25 
	~"timeUtûs.h
"

26 
	~"ty≥Defs.h
"

64 
evítCou¡
 
	tEvítCou¡
;

66 
	tEvítTokí
;

73 
makeEvítCou¡
(
EvítCou¡
 **
ecPå
);

80 
‰ìEvítCou¡
(
EvítCou¡
 *
ec
);

87 
evítCou¡Brﬂdˇ°
(
EvítCou¡
 *
ec
);

98 
EvítTokí
 
	$evítCou¡Pª∑ª
(
EvítCou¡
 *
ec
)

99 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

109 
	`evítCou¡C™˚l
(
EvítCou¡
 *
ec
, 
EvítTokí
 
tokí
);

125 
boﬁ
 
	`evítCou¡Waô
(
EvítCou¡
 *
ec
, 
EvítTokí
 
tokí
, c⁄° 
RñTime
 *
timeout
);

	@uds/util/funnelQueue.c

22 
	~"fu¬ñQueue.h
"

24 
	~"mem‹yAŒoc.h
"

25 
	~"≥rmas£π.h
"

26 
	~"uds.h
"

29 
	$makeFu¬ñQueue
(
Fu¬ñQueue
 **
queuePå
)

38 
	`STATIC_ASSERT
(
__x86_64__
);

42 
Fu¬ñQueue
 *
queue
;

43 
ªsu…
 = 
	`ALLOCATE
(1, 
Fu¬ñQueue
, "fu¬ñ queue", &
queue
);

44 i‡(
ªsu…
 !
UDS_SUCCESS
) {

45  
ªsu…
;

50 
queue
->
°ub
.
√xt
 = 
NULL
;

51 
queue
->
√we°
 = &queue->
°ub
;

52 
queue
->
ﬁde°
 = &queue->
°ub
;

54 *
queuePå
 = 
queue
;

55  
UDS_SUCCESS
;

56 
	}
}

59 
	$‰ìFu¬ñQueue
(
Fu¬ñQueue
 *
queue
)

61 
	`FREE
(
queue
);

62 
	}
}

65 
Fu¬ñQueueE¡ry
 *
	$fu¬ñQueuePﬁl
(
Fu¬ñQueue
 *
queue
)

67 
Fu¬ñQueueE¡ry
 *
ﬁde°
 = 
queue
->oldest;

68 
Fu¬ñQueueE¡ry
 *
√xt
 = 
ﬁde°
->next;

70 i‡(
ﬁde°
 =&
queue
->
°ub
) {

73 i‡(
√xt
 =
NULL
) {

74  
NULL
;

78 
ﬁde°
 = 
√xt
;

79 
queue
->
ﬁde°
 = oldest;

80 
√xt
 = 
ﬁde°
->next;

85 i‡(
√xt
 =
NULL
) {

86 
Fu¬ñQueueE¡ry
 *
√we°
 = 
queue
->newest;

87 i‡(
ﬁde°
 !
√we°
) {

90  
NULL
;

95 
	`fu¬ñQueuePut
(
queue
, &queue->
°ub
);

98 
√xt
 = 
ﬁde°
->next;

99 i‡(
√xt
 =
NULL
) {

102  
NULL
;

112 
queue
->
ﬁde°
 = 
√xt
;

113 
ﬁde°
->
√xt
 = 
NULL
;

114  
ﬁde°
;

115 
	}
}

	@uds/util/funnelQueue.h

22 #i‚de‡
FUNNEL_QUEUE_H


23 
	#FUNNEL_QUEUE_H


	)

25 
	~"©omic.h
"

26 
	~"compûî.h
"

27 
	~"˝u.h
"

28 
	~"ty≥Defs.h
"

70 
	sfu¬ñQueueE¡ry
 {

72 
fu¬ñQueueE¡ry
 * vﬁ©ûê
	m√xt
;

73 } 
	tFu¬ñQueueE¡ry
;

80 
__©åibuã__
((
	tÆig√d
(
	tCACHE_LINE_BYTES
))Ë
	tfu¬ñQueue
 {

83 
Fu¬ñQueueE¡ry
 * vﬁ©ûê
√we°
;

86 
Fu¬ñQueueE¡ry
 *
ﬁde°
 
	`__©åibuã__
((
	`Æig√d
(
CACHE_LINE_BYTES
)));

89 
Fu¬ñQueueE¡ry
 
°ub
;

90 
	}
} 
	tFu¬ñQueue
;

99 
	$makeFu¬ñQueue
(
Fu¬ñQueue
 **
queuePå
)

100 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

111 
	`‰ìFu¬ñQueue
(
Fu¬ñQueue
 *
queue
);

125 
INLINE
 
	$fu¬ñQueuePut
(
Fu¬ñQueue
 *
queue
, 
Fu¬ñQueueE¡ry
 *
íåy
)

127 
íåy
->
√xt
 = 
NULL
;

128 
	`gccFí˚
();

129 
Fu¬ñQueueE¡ry
 *
¥evious
 = 
	`__sync_lock_ã°_™d_£t
(&
queue
->
√we°
, 
íåy
);

130 
	`gccFí˚
();

133 
¥evious
->
√xt
 = 
íåy
;

134 
	}
}

144 
Fu¬ñQueueE¡ry
 *
	$fu¬ñQueuePﬁl
(
Fu¬ñQueue
 *
queue
)

145 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

	@uds/util/pathBuffer.c

22 
	~"∑thBuf„r.h
"

24 
	~"îr‹s.h
"

25 
	~"loggî.h
"

26 
	~"mem‹yAŒoc.h
"

27 
	~"≥rmas£π.h
"

28 
	~"°rögUtûs.h
"

29 
	~"uds.h
"

31 c⁄° 
size_t
 
	gDEFAULT_PATH_BUFFER_SIZE
 = 128;

32 c⁄° 
size_t
 
	gPATH_BUFFER_QUANTUM
 = 64;

35 
	$zîoP©hBuf„r
(
P©hBuf„r
 *
pb
)

37 
pb
->
∑th
 = 
NULL
;

38 
pb
->
íd
 = 
NULL
;

39 
pb
->
size
 = 0;

40 
	}
}

43 
	$öôülizeP©hBuf„r
(
P©hBuf„r
 *
pb
, 
size_t
 
size
)

45 
ªsu…
 = 
	`ASSERT_WITH_ERROR_CODE
(
size
 > 0, 
UDS_INVALID_ARGUMENT
,

47 i‡(
ªsu…
 !
UDS_SUCCESS
) {

48  
ªsu…
;

50 
ªsu…
 = 
	`ALLOCATE
(
size
, , "∑th buf„r", &
pb
->
∑th
);

51 i‡(
ªsu…
 !
UDS_SUCCESS
) {

52  
ªsu…
;

54 
pb
->
size
 = size;

55 
pb
->
íd
 =Öb->
∑th
;

56 *
pb
->
íd
 = '\0';

58  
UDS_SUCCESS
;

59 
	}
}

62 
size_t
 
	$roundToNext
(
size_t
 
size
, size_à
qu™tum
)

64 
size_t
 
ãmp
 = 
size
 + 
qu™tum
 - 1;

65  
ãmp
 -Åem∞% 
qu™tum
;

66 
	}
}

69 
	$öôülizeP©hBuf„rC›y
(
P©hBuf„r
 *
pb
, c⁄° P©hBuf„∏*
Ÿhî
)

71 
size_t
 
Àn
 = 
	`∑thBuf„rLígth
(
Ÿhî
);

72 
size_t
 
size
 = 
	`roundToNext
(
Àn
 + 1, 
PATH_BUFFER_QUANTUM
);

74 
ªsu…
 = 
	`öôülizeP©hBuf„r
(
pb
, 
size
);

75 i‡(
ªsu…
 !
UDS_SUCCESS
) {

76  
ªsu…
;

79 
	`mem˝y
(
pb
->
∑th
, 
Ÿhî
->∑th, 
Àn
);

80 
pb
->
íd
 =Öb->
∑th
 + 
Àn
;

81 *
pb
->
íd
 = '\0';

83  
UDS_SUCCESS
;

84 
	}
}

87 
	$öôülizeP©hBuf„rS¥ötf
(
P©hBuf„r
 *
pb
, c⁄° *
fmt
, ...)

89 
va_li°
 
¨gs
;

91 
buf
[
DEFAULT_PATH_BUFFER_SIZE
];

93 
size_t
 
√eded
 = 0;

94 
	`va_°¨t
(
¨gs
, 
fmt
);

95 
ªsu…
 = 
	`wøpV¢¥ötf
("∑th buf„r", 
buf
, (buf), 
UDS_SUCCESS
,

96 
fmt
, 
¨gs
, &
√eded
);

97 
	`va_íd
(
¨gs
);

98 i‡(
ªsu…
 !
UDS_SUCCESS
) {

99  
ªsu…
;

102 
size_t
 
size
 = 
	`roundToNext
(
√eded
 + 1, 
PATH_BUFFER_QUANTUM
);

104 
ªsu…
 = 
	`öôülizeP©hBuf„r
(
pb
, 
size
);

105 i‡(
ªsu…
 !
UDS_SUCCESS
) {

106  
ªsu…
;

109 i‡(
√eded
 < (
buf
)) {

111 
	`mem˝y
(
pb
->
∑th
, 
buf
, 
√eded
);

112 
pb
->
íd
 =Öb->
∑th
 + 
√eded
;

113 *
pb
->
íd
 = '\0';

116 
	`va_°¨t
(
¨gs
, 
fmt
);

117 
ªsu…
 = 
	`wøpV¢¥ötf
("∑th buf„r", 
pb
->
∑th
,Öb->
size
, 
UDS_BAD_STATE
,

118 
fmt
, 
¨gs
, 
NULL
);

119 
	`va_íd
(
¨gs
);

120 i‡(
ªsu…
 !
UDS_SUCCESS
) {

121 
pb
->
íd
 =Öb->
∑th
;

122  
ªsu…
;

124 
pb
->
íd
 =Öb->
∑th
 + 
√eded
;

126  
UDS_SUCCESS
;

127 
	}
}

130 
	$growP©hBuf„rIfNìded
(
P©hBuf„r
 *
pb
, 
size_t
 
size
, 
boﬁ
 
exa˘ly
)

132 i‡(
size
 < 
pb
->size) {

133  
UDS_SUCCESS
;

135 i‡(!
exa˘ly
) {

136 
size
 = 
	`roundToNext
(size, 
PATH_BUFFER_QUANTUM
);

139 *
buf
 = 
NULL
;

140 
ªsu…
 = 
	`ªÆloˇãMem‹y
(
pb
->
∑th
,Öb->
size
, size, "∑th buf„r", &
buf
);

141 i‡(
ªsu…
 !
UDS_SUCCESS
) {

142  
ªsu…
;

145 
pb
->
íd
 = 
buf
 + (pb->íd -Öb->
∑th
);

146 
pb
->
∑th
 = 
buf
;

147 
pb
->
size
 = size;

149  
UDS_SUCCESS
;

150 
	}
}

153 
__©åibuã__
((
	$f‹m©
(
¥ötf
, 3, 0) ))

154 
	$∑thBuf„rS¥ötHñ≥r
(
P©hBuf„r
 *
pb
, 
size_t
 
off£t
,

155 c⁄° *
fmt
, 
va_li°
 
≠1
, va_li° 
≠2
,

156 
boﬁ
 
exa˘
)

158 
size_t
 
√eded
 = 0;

160 
ªsu…
 = 
	`wøpV¢¥ötf
("path buffer",

161 
pb
->
∑th
 + 
off£t
,

162 
pb
->
size
 - 
off£t
,

163 
UDS_SUCCESS
,

164 
fmt
, 
≠1
, &
√eded
);

165 i‡(
ªsu…
 !
UDS_SUCCESS
) {

166  
ªsu…
;

169 i‡(
√eded
 + 
off£t
 >
pb
->
size
) {

170 
ªsu…
 = 
	`growP©hBuf„rIfNìded
(
pb
, 
off£t
 + 
√eded
 + 1, 
exa˘
);

171 i‡(
ªsu…
 !
UDS_SUCCESS
) {

172  
ªsu…
;

176 
ªsu…
 = 
	`wøpV¢¥ötf
("path buffer",

177 
pb
->
∑th
 + 
off£t
,

178 
pb
->
size
 - 
off£t
,

179 
UDS_BAD_STATE
,

180 
fmt
, 
≠2
, 
NULL
);

181 i‡(
ªsu…
 !
UDS_SUCCESS
) {

182 
pb
->
íd
 =Öb->
∑th
;

183  
ªsu…
;

186 
pb
->
íd
 =Öb->
∑th
 + 
off£t
 + 
√eded
;

187  
UDS_SUCCESS
;

188 
	}
}

191 
	$öôülizeP©hBuf„rSizedS¥ötf
(
P©hBuf„r
 *
pb
, 
size_t
 
size
,

192 c⁄° *
fmt
, ...)

194 
ªsu…
 = 
	`öôülizeP©hBuf„r
(
pb
, 
size
);

195 i‡(
ªsu…
 !
UDS_SUCCESS
) {

196  
ªsu…
;

199 
va_li°
 
¨gs
;

200 
va_li°
 
¨gs2
;

201 
	`va_°¨t
(
¨gs
, 
fmt
);

202 
	`va_c›y
(
¨gs2
, 
¨gs
);

203 
ªsu…
 = 
	`∑thBuf„rS¥ötHñ≥r
(
pb
, 0, 
fmt
, 
¨gs
, 
¨gs2
, 
åue
);

204 
	`va_íd
(
¨gs
);

205 
	`va_íd
(
¨gs2
);

206  
ªsu…
;

207 
	}
}

210 
	$öôülizeP©hBuf„rExa˘Fô
(
P©hBuf„r
 *
pb
, *
d©a
, 
size_t
 
Àn
)

212 
ªsu…
 = 
	`öôülizeP©hBuf„r
(
pb
, 
Àn
 + 1);

213 i‡(
ªsu…
 !
UDS_SUCCESS
) {

214  
ªsu…
;

216 
	`mem˝y
(
pb
->
∑th
, 
d©a
, 
Àn
);

217 
pb
->
íd
 =Öb->
∑th
 + 
Àn
;

218 *
pb
->
íd
 = '\0';

219  
UDS_SUCCESS
;

220 
	}
}

223 
	$ªÀa£P©hBuf„r
(
P©hBuf„r
 *
pb
)

225 i‡(
pb
 !
NULL
) {

226 i‡(
pb
->
∑th
 !
NULL
) {

227 
	`FREE
(
pb
->
∑th
);

229 
	`zîoP©hBuf„r
(
pb
);

231 
	}
}

234 
boﬁ
 
	$∑thBuf„rHasP©h
(c⁄° 
P©hBuf„r
 *
pb
)

236  (
pb
->
∑th
 !
NULL
Ë&& (pb->
íd
 >Öb->path);

237 
	}
}

240 
size_t
 
	$∑thBuf„rLígth
(c⁄° 
P©hBuf„r
 *
pb
)

242  
pb
->
∑th
 =
NULL
 ? 0 :Öb->
íd
 -Öb->path;

243 
	}
}

246 
size_t
 
	$∑thBuf„rSize
(c⁄° 
P©hBuf„r
 *
pb
)

248  
pb
->
size
;

249 
	}
}

252 c⁄° *
	$∑thBuf„rP©h
(c⁄° 
P©hBuf„r
 *
pb
)

254  
pb
->
∑th
;

255 
	}
}

258 *
	$∑thBuf„rBuf„r
(c⁄° 
P©hBuf„r
 *
pb
)

260  
pb
->
∑th
;

261 
	}
}

264 
	$£tP©hBuf„rS¥ötf
(
P©hBuf„r
 *
pb
, *
fmt
, ...)

266 
va_li°
 
¨gs
;

267 
va_li°
 
¨gs2
;

268 
	`va_°¨t
(
¨gs
, 
fmt
);

269 
	`va_c›y
(
¨gs2
, 
¨gs
);

270 
ªsu…
 = 
	`∑thBuf„rS¥ötHñ≥r
(
pb
, 0, 
fmt
, 
¨gs
, 
¨gs2
, 
Ál£
);

271 
	`va_íd
(
¨gs
);

272 
	`va_íd
(
¨gs2
);

273  
ªsu…
;

274 
	}
}

277 
	$c›yP©hBuf„r
(
P©hBuf„r
 *
d°
, c⁄° P©hBuf„∏*
§c
)

279 
size_t
 
¶í
 = 
	`∑thBuf„rLígth
(
§c
);

280 i‡(
d°
->
size
 < 
¶í
 + 1) {

281 
ªsu…
 = 
	`growP©hBuf„rIfNìded
(
d°
, 
¶í
 + 1, 
Ál£
);

282 i‡(
ªsu…
 !
UDS_SUCCESS
) {

283  
ªsu…
;

287 
	`mem˝y
(
d°
->
∑th
, 
§c
->∑th, 
¶í
);

288 
d°
->
íd
 = d°->
∑th
 + 
¶í
;

289 *
d°
->
íd
 = '\0';

290  
UDS_SUCCESS
;

291 
	}
}

294 
	$åunˇãP©hBuf„r
(
P©hBuf„r
 *
pb
, 
size_t
 
Àn
)

296 i‡(
Àn
 <
	`∑thBuf„rLígth
(
pb
)) {

297 
pb
->
íd
 =Öb->
∑th
 + 
Àn
;

298 *
pb
->
íd
 = '\0';

299  
UDS_SUCCESS
;

301  
UDS_INVALID_ARGUMENT
;

302 
	}
}

305 
	$≠≥ndP©hBuf„r
(
P©hBuf„r
 *
d°
, c⁄° P©hBuf„∏*
§c
)

307 
size_t
 
dÀn
 = 
	`∑thBuf„rLígth
(
d°
);

308 
size_t
 
¶í
 = 
	`∑thBuf„rLígth
(
§c
);

309 i‡(
d°
->
size
 < 
dÀn
 + 
¶í
 + 1) {

310 
ªsu…
 = 
	`growP©hBuf„rIfNìded
(
d°
, 
dÀn
 + 
¶í
 + 1, 
Ál£
);

311 i‡(
ªsu…
 !
UDS_SUCCESS
) {

312  
ªsu…
;

316 
	`mem˝y
(
d°
->
∑th
 + 
dÀn
, 
§c
->∑th, 
¶í
);

317 
d°
->
íd
 = d°->
∑th
 + 
dÀn
 + 
¶í
;

318 *
d°
->
íd
 = '\0';

319  
UDS_SUCCESS
;

320 
	}
}

323 
	$≠≥ndP©hBuf„rS¥ötf
(
P©hBuf„r
 *
pb
, c⁄° *
fmt
, ...)

325 
va_li°
 
¨gs
;

326 
va_li°
 
¨gs2
;

327 
	`va_°¨t
(
¨gs
, 
fmt
);

328 
	`va_c›y
(
¨gs2
, 
¨gs
);

329 
ªsu…
 = 
	`∑thBuf„rS¥ötHñ≥r
(
pb
, 
	`∑thBuf„rLígth
(pb),

330 
fmt
, 
¨gs
, 
¨gs2
, 
Ál£
);

331 
	`va_íd
(
¨gs
);

332 
	`va_íd
(
¨gs2
);

333  
ªsu…
;

334 
	}
}

337 
	$£tP©hBuf„rSize
(
P©hBuf„r
 *
pb
, 
size_t
 
size
)

339 i‡(
size
 < 
	`∑thBuf„rLígth
(
pb
) + 1) {

340  
UDS_INVALID_ARGUMENT
;

343 *
buf
 = 
NULL
;

344 
ªsu…
 = 
	`ªÆloˇãMem‹y
(
pb
->
∑th
,Öb->
size
, size, "∑th buf„r", &
buf
);

345 i‡(
ªsu…
 !
UDS_SUCCESS
) {

346  
ªsu…
;

349 
pb
->
íd
 = 
buf
 + (pb->íd -Öb->
∑th
);

350 
pb
->
∑th
 = 
buf
;

351 
pb
->
size
 = size;

352  
UDS_SUCCESS
;

353 
	}
}

356 
	$£tP©hBuf„rSizeToFô
(
P©hBuf„r
 *
pb
)

358  
	`£tP©hBuf„rSize
(
pb
, 
	`∑thBuf„rLígth
(pb) + 1);

359 
	}
}

	@uds/util/pathBuffer.h

22 #i‚de‡
PATH_BUFFER_H


23 
	#PATH_BUFFER_H
 1

	)

25 
	~"ty≥Defs.h
"

32 
	s∑thBuf„r
 {

33 *
	m∑th
;

34 *
	míd
;

35 
size_t
 
	msize
;

36 } 
	tP©hBuf„r
;

43 
zîoP©hBuf„r
(
P©hBuf„r
 *
pb
);

53 
	$öôülizeP©hBuf„r
(
P©hBuf„r
 *
pb
, 
size_t
 
size
)

54 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

64 
	$öôülizeP©hBuf„rC›y
(
P©hBuf„r
 *
pb
, c⁄° P©hBuf„∏*
Ÿhî
)

65 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

75 
	$öôülizeP©hBuf„rS¥ötf
(
P©hBuf„r
 *
pb
, c⁄° *
fmt
, ...)

76 
	`__©åibuã__
((
	`f‹m©
(
¥ötf
, 2, 3), 
w¨n_unu£d_ªsu…
));

87 
	$öôülizeP©hBuf„rSizedS¥ötf
(
P©hBuf„r
 *
pb
, 
size_t
 
size
,

88 c⁄° *
fmt
, ...)

89 
	`__©åibuã__
((
	`f‹m©
(
¥ötf
, 3, 4), 
w¨n_unu£d_ªsu…
));

101 
	$öôülizeP©hBuf„rExa˘Fô
(
P©hBuf„r
 *
pb
, *
d©a
, 
size_t
 
Àn
)

102 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

109 
	`ªÀa£P©hBuf„r
(
P©hBuf„r
 *
pb
);

118 
boﬁ
 
	$∑thBuf„rHasP©h
(c⁄° 
P©hBuf„r
 *
pb
)

119 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

128 
size_t
 
	`∑thBuf„rLígth
(c⁄° 
P©hBuf„r
 *
pb
);

137 
size_t
 
	`∑thBuf„rSize
(c⁄° 
P©hBuf„r
 *
pb
);

146 c⁄° *
	`∑thBuf„rP©h
(c⁄° 
P©hBuf„r
 *
pb
);

155 *
	`∑thBuf„rBuf„r
(c⁄° 
P©hBuf„r
 *
pb
);

165 
	$£tP©hBuf„rS¥ötf
(
P©hBuf„r
 *
pb
, *
fmt
, ...)

166 
	`__©åibuã__
((
	`f‹m©
(
¥ötf
, 2, 3), 
w¨n_unu£d_ªsu…
));

174 
	$c›yP©hBuf„r
(
P©hBuf„r
 *
d°
, c⁄° P©hBuf„∏*
§c
)

175 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

186 
	$åunˇãP©hBuf„r
(
P©hBuf„r
 *
pb
, 
size_t
 
Àn
)

187 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

197 
	$≠≥ndP©hBuf„r
(
P©hBuf„r
 *
d°
, c⁄° P©hBuf„∏*
§c
)

198 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

208 
	$≠≥ndP©hBuf„rS¥ötf
(
P©hBuf„r
 *
pb
, c⁄° *
fmt
, ...)

209 
	`__©åibuã__
((
	`f‹m©
(
¥ötf
, 2, 3), 
w¨n_unu£d_ªsu…
));

218 
	$£tP©hBuf„rSizeToFô
(
P©hBuf„r
 *
pb
)

219 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

230 
	$£tP©hBuf„rSize
(
P©hBuf„r
 *
pb
, 
size_t
 
size
)

231 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

	@uds/util/radixSort.c

31 
	~"ødixS‹t.h
"

33 
	~"compûî.h
"

34 
	~"mem‹yAŒoc.h
"

35 
	~"°rögUtûs.h
"

36 
	~"ty≥Defs.h
"

37 
	~"uds.h
"

41 
	mINSERTION_SORT_THRESHOLD
 = 12

45 c⁄° 
	tuöt8_t
 * 
	tKey
;

53 
uöt16_t
 
	mu£d
;

54 
uöt16_t
 
	mfú°
;

55 
uöt16_t
 
	mœ°
;

56 
uöt32_t
 
	msize
[256];

57 } 
	tHi°ogøm
;

64 
Key
 *
	mfú°Key
;

65 
Key
 *
	mœ°Key
;

66 
uöt16_t
 
	moff£t
;

67 
uöt16_t
 
	mÀngth
;

68 } 
	tTask
;

70 
	sødixS‹ãr
 {

71 
	mcou¡
;

72 
Hi°ogøm
 
	mbös
;

73 
Key
 *
	mpûe
[256];

74 
Task
 *
	mídOfSèck
;

75 
Task
 
	misLi°
[256];

76 
Task
 
	m°ack
[];

87 
INLINE
 
	$com∑ª
(
Key
 
key1
, Key 
key2
, 
uöt16_t
 
off£t
, uöt16_à
Àngth
)

89  
	`memcmp
(&
key1
[
off£t
], &
key2
[off£t], 
Àngth
);

90 
	}
}

99 
INLINE
 
	$ö£πKey
(c⁄° 
Task
 
èsk
, 
Key
 *
√xt
)

102 
Key
 
uns‹ãd
 = *
√xt
;

105 (--
√xt
 >
èsk
.
fú°Key
)

106 && (
	`com∑ª
(
uns‹ãd
, 
√xt
[0], 
èsk
.
off£t
,Åask.
Àngth
) < 0)) {

107 
√xt
[1] =Çext[0];

110 
√xt
[1] = 
uns‹ãd
;

111 
	}
}

120 
INLINE
 
	$ö£πi⁄S‹t
(c⁄° 
Task
 
èsk
)

124 
Key
 *
√xt
 = 
èsk
.
fú°Key
 + 1;Çexà<èsk.
œ°Key
;Çext++) {

125 
	`ö£πKey
(
èsk
, 
√xt
);

127 
	}
}

132 
INLINE
 
	$pushTask
(
Task
 **
°ackPoöãr
,

133 
Key
 *
fú°Key
,

134 
uöt32_t
 
cou¡
,

135 
uöt16_t
 
off£t
,

136 
uöt16_t
 
Àngth
)

138 
Task
 *
èsk
 = (*
°ackPoöãr
)++;

139 
èsk
->
fú°Key
 = firstKey;

140 
èsk
->
œ°Key
 = &
fú°Key
[
cou¡
 - 1];

141 
èsk
->
off£t
 = offset;

142 
èsk
->
Àngth
 =Üength;

143 
	}
}

146 
INLINE
 
	$sw≠Keys
(
Key
 *
a
, Key *
b
)

148 
Key
 
c
 = *
a
;

149 *
a
 = *
b
;

150 *
b
 = 
c
;

151 
	}
}

161 
INLINE
 
	$mósuªBös
(c⁄° 
Task
 
èsk
, 
Hi°ogøm
 *
bös
)

164 
bös
->
fú°
 = 
UINT8_MAX
;

165 
bös
->
œ°
 = 0;

171 
Key
 *
keyPå
 = 
èsk
.
fú°Key
; keyPå <èsk.
œ°Key
; keyPtr++) {

173 
uöt8_t
 
bö
 = (*
keyPå
)[
èsk
.
off£t
];

174 
uöt32_t
 
size
 = ++
bös
->size[
bö
];

177 i‡(
size
 == 1) {

178 
bös
->
u£d
 += 1;

179 i‡(
bö
 < 
bös
->
fú°
) {

180 
bös
->
fú°
 = 
bö
;

182 i‡(
bö
 > 
bös
->
œ°
) {

183 
bös
->
œ°
 = 
bö
;

187 
	}
}

209 
INLINE
 
	$pushBös
(
Task
 **
°ack
,

210 
Task
 *
ídOfSèck
,

211 
Task
 **
li°
,

212 
Key
 *
pûe
[],

213 
Hi°ogøm
 *
bös
,

214 
Key
 *
fú°Key
,

215 
uöt16_t
 
off£t
,

216 
uöt16_t
 
Àngth
)

218 
Key
 *
pûeSèπ
 = 
fú°Key
;

219 
bö
 = 
bös
->
fú°
; ; bin++) {

220 
uöt32_t
 
size
 = 
bös
->size[
bö
];

222 i‡(
size
 == 0) {

226 i‡(
Àngth
 > 0) {

227 i‡(
size
 > 
INSERTION_SORT_THRESHOLD
) {

228 i‡(*
°ack
 >
ídOfSèck
) {

229  
UDS_BAD_STATE
;

231 
	`pushTask
(
°ack
, 
pûeSèπ
, 
size
, 
off£t
, 
Àngth
);

232 } i‡(
size
 > 1) {

233 
	`pushTask
(
li°
, 
pûeSèπ
, 
size
, 
off£t
, 
Àngth
);

236 
pûeSèπ
 +
size
;

237 
pûe
[
bö
] = 
pûeSèπ
;

238 i‡(--
bös
->
u£d
 == 0) {

242  
UDS_SUCCESS
;

243 
	}
}

246 
	$makeRadixS‹ãr
(
cou¡
, 
RadixS‹ãr
 **
s‹ãr
)

248 
°ackSize
 = 
cou¡
 / 
INSERTION_SORT_THRESHOLD
;

249 
RadixS‹ãr
 *
ødixS‹ãr
;

250 
ªsu…
 = 
	`ALLOCATE_EXTENDED
(
RadixS‹ãr
, 
°ackSize
, 
Task
, 
__func__
,

251 &
ødixS‹ãr
);

252 i‡(
ªsu…
 !
UDS_SUCCESS
) {

253  
ªsu…
;

255 
ødixS‹ãr
->
cou¡
 = count;

256 
ødixS‹ãr
->
ídOfSèck
 =ÑadixS‹ãr->
°ack
 + 
°ackSize
;

257 *
s‹ãr
 = 
ødixS‹ãr
;

258  
UDS_SUCCESS
;

259 
	}
}

262 
	$‰ìRadixS‹ãr
(
RadixS‹ãr
 *
s‹ãr
)

264 
	`FREE
(
s‹ãr
);

265 
	}
}

268 
	$ødixS‹t
(
RadixS‹ãr
 *
s‹ãr
,

269 c⁄° *
keys
[],

270 
cou¡
,

271 
Àngth
)

274 i‡((
cou¡
 =0Ë|| (
Àngth
 == 0)) {

275  
UDS_SUCCESS
;

279 
Task
 
°¨t
 = {

280 .
fú°Key
 = 
keys
,

281 .
œ°Key
 = &
keys
[
cou¡
 - 1],

282 .
off£t
 = 0,

283 .
Àngth
 =Üength,

286 i‡(
cou¡
 <
INSERTION_SORT_THRESHOLD
) {

287 
	`ö£πi⁄S‹t
(
°¨t
);

288  
UDS_SUCCESS
;

291 i‡(
cou¡
 > 
s‹ãr
->count) {

292  
UDS_INVALID_ARGUMENT
;

295 
Hi°ogøm
 *
bös
 = &
s‹ãr
->bins;

296 
Key
 **
pûe
 = 
s‹ãr
->pile;

297 
Task
 *
•
 = 
s‹ãr
->
°ack
;

305 *
•
 = 
°¨t
; s∞>
s‹ãr
->
°ack
; sp--) {

306 c⁄° 
Task
 
èsk
 = *
•
;

307 
	`mósuªBös
(
èsk
, 
bös
);

311 
Task
 *
Õ
 = 
s‹ãr
->
isLi°
;

312 
ªsu…
 = 
	`pushBös
(&
•
, 
s‹ãr
->
ídOfSèck
, &
Õ
, 
pûe
, 
bös
,

313 
èsk
.
fú°Key
,Åask.
off£t
 + 1,Åask.
Àngth
 - 1);

314 i‡(
ªsu…
 !
UDS_SUCCESS
) {

315 
	`mem£t
(
bös
, 0, (*bins));

316  
ªsu…
;

322 
Key
 *
íd
 = 
èsk
.
œ°Key
 - 
bös
->
size
[bös->
œ°
];

323 
bös
->
size
[bös->
œ°
] = 0;

325 
Key
 *
„n˚
 = 
èsk
.
fú°Key
; fí˚ <
íd
; ) {

326 
uöt8_t
 
bö
;

327 
Key
 
key
 = *
„n˚
;

330 --
pûe
[
bö
 = 
key
[
èsk
.
off£t
]] > 
„n˚
) {

331 
	`sw≠Keys
(
pûe
[
bö
], &
key
);

335 *
„n˚
 = 
key
;

336 
„n˚
 +
bös
->
size
[
bö
];

337 
bös
->
size
[
bö
] = 0;

343 --
Õ
 >
s‹ãr
->
isLi°
) {

344 
	`ö£πi⁄S‹t
(*
Õ
);

347  
UDS_SUCCESS
;

348 
	}
}

	@uds/util/radixSort.h

22 #i‚de‡
RADIX_SORT_H


23 
	#RADIX_SORT_H


	)

30 
ødixS‹ãr
 
	tRadixS‹ãr
;

41 
	$makeRadixS‹ãr
(
cou¡
, 
RadixS‹ãr
 **
s‹ãr
)

42 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

49 
	`‰ìRadixS‹ãr
(
RadixS‹ãr
 *
s‹ãr
);

64 
	$ødixS‹t
(
RadixS‹ãr
 *
s‹ãr
,

65 c⁄° *
keys
[],

66 
cou¡
,

67 
Àngth
)

68 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

	@uds/util/statistic.c

22 
	~"°©i°ic.h
"

24 
	~"loggî.h
"

25 
	~"mem‹yAŒoc.h
"

26 
	~"°rögUtûs.h
"

27 
	~"uds.h
"

30 
	$f‹m©Sèti°ic
(c⁄° 
Sèti°ic
 *
°©
, **
°rögPå
)

32 i‡(
°©
->
cou¡
 == 0) {

33  
	`ÆlocS¥ötf
(
__func__
, 
°rögPå
,

35 } i‡(
°©
->
cou¡
 == 1) {

36  
	`ÆlocS¥ötf
(
__func__
, 
°rögPå
, "⁄êßm∂ê%ld", 
°©
->
sum
);

38 #i‡
FLOATING_POINT


39  
	`ÆlocS¥ötf
(
__func__
, 
°rögPå
,

41 
°©
->
cou¡
, sèt->
mö
, sèt->
max
,

42 
	`gëSèti°icMón
(
°©
), 
	`gëSèti°icSigma
(°©, 
Ál£
));

44  
	`ÆlocS¥ötf
(
__func__
, 
°rögPå
,

46 
°©
->
cou¡
, sèt->
mö
, sèt->
max
, sèt->
sum
,

47 
°©
->
sumSqu¨es
);

50 
	}
}

53 
	$logSèti°ic
(c⁄° 
Sèti°ic
 *
°©
, c⁄° 
ˇ±i⁄
[])

55 i‡(
°©
->
cou¡
 > 0) {

56 *
°©Såög
;

57 
ªsu…
 = 
	`f‹m©Sèti°ic
(
°©
, &
°©Såög
);

58 i‡(
ªsu…
 !
UDS_SUCCESS
) {

59 
	`logEº‹WôhSåögEº‹
(
ªsu…
, "FaûedÅÿf‹m© %s", 
ˇ±i⁄
);

62 
	`logInfo
("%s: %s", 
ˇ±i⁄
, 
°©Såög
);

63 
	`FREE
(
°©Såög
);

65 
	}
}

	@uds/util/statistic.h

22 #i‚de‡
STATISTIC_H


23 
	#STATISTIC_H


	)

25 
	~"compûî.h
"

26 
	~"„©uªDefs.h
"

27 
	~"ty≥Defs.h
"

29 #i‡
FLOATING_POINT


30 
	~<m©h.h
>

39 
	mcou¡
;

42 
	msum
;

45 
	msumSqu¨es
;

48 
	mmö
;

51 
	mmax
;

52 } 
	tSèti°ic
;

54 
	#STATISTIC_INITIALIZER
 { 0, 0.0, 0.0, 
LONG_MAX
, 
LONG_MIN
 }

	)

61 
INLINE
 
	$ª£tSèti°ic
(
Sèti°ic
 *
°©
)

63 
Sèti°ic
 
ª£t
 = 
STATISTIC_INITIALIZER
;

64 *
°©
 = 
ª£t
;

65 
	}
}

73 
INLINE
 
	$ßm∂eSèti°ic
(
Sèti°ic
 *
°©
, 
ßm∂e
)

75 
°©
->
cou¡
 += 1;

76 
°©
->
sum
 +
ßm∂e
;

77 
°©
->
sumSqu¨es
 +
ßm∂e
 * sample;

79 i‡(
ßm∂e
 < 
°©
->
mö
) {

80 
°©
->
mö
 = 
ßm∂e
;

82 i‡(
ßm∂e
 > 
°©
->
max
) {

83 
°©
->
max
 = 
ßm∂e
;

85 
	}
}

87 #i‡
FLOATING_POINT


96 
INLINE
 
	$gëSèti°icMón
(c⁄° 
Sèti°ic
 *
°©
)

98  ((Ë
°©
->
sum
 / sèt->
cou¡
);

99 
	}
}

113 
INLINE
 
	$gëSèti°icSigma
(c⁄° 
Sèti°ic
 *
°©
, 
boﬁ
 
e°im©e
)

123 
sum
 = 
°©
->sum;

124  
	`sqπ
((
°©
->
sumSqu¨es
 - ((
sum
 * sumË/ sèt->
cou¡
))

125 / (
e°im©e
 ? (
°©
->
cou¡
 - 1) : stat->count));

126 
	}
}

138 
	$f‹m©Sèti°ic
(c⁄° 
Sèti°ic
 *
°©
, **
°rögPå
)

139 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

147 
	`logSèti°ic
(c⁄° 
Sèti°ic
 *
°©
, c⁄° 
ˇ±i⁄
[]);

	@uds/volume.c

22 
	~"vﬁume.h
"

24 
	~"ˇcheCou¡îs.h
"

25 
	~"ch≠ãrIndex.h
"

26 
	~"compûî.h
"

27 
	~"îr‹s.h
"

28 
	~"„©uªDefs.h
"

29 
	~"geomëry.h
"

30 
	~"hashUtûs.h
"

31 
	~"ödexC⁄fig.h
"

32 
	~"loggî.h
"

33 
	~"mem‹yAŒoc.h
"

34 
	~"∑ømëî.h
"

35 
	~"≥rmas£π.h
"

36 
	~"ªc‹dPage.h
"

37 
	~"ªque°.h
"

38 
	~"•¨£Cache.h
"

39 
	~"°rögUtûs.h
"

40 
	~"thªads.h
"

41 
	~"utû/©omic.h
"

42 
	~"vﬁumeI¡î«ls.h
"

45 
	mMAX_BAD_CHAPTERS
 = 100,

46 
	mVOLUME_READ_THREADS
 = 2,

47 
	mREADER_STACK_SIZE
 = 1 * 
MEGABYTE


50 c⁄° 
NumîicVÆid©i⁄D©a
 
	gvÆidR™ge
 = {

51 .
möVÆue
 = 1,

52 .
	gmaxVÆue
 = 
MAX_VOLUME_READ_THREADS
,

56 
UdsP¨amëîVÆue
 
	$gëDeÁu…RódThªads
()

58 
UdsP¨amëîVÆue
 
vÆue
;

59 #i‡
ENVIRONMENT


60 *
ív
 = 
	`gëív
(
UDS_VOLUME_READ_THREADS
);

61 i‡(
ív
 !
NULL
) {

62 
UdsP¨amëîVÆue
 
tmp
 = {

63 .
ty≥
 = 
UDS_PARAM_TYPE_STRING
,

64 .
vÆue
.
u_°rög
 = 
ív
,

66 i‡(
	`vÆid©eNumîicR™ge
(&
tmp
, &
vÆidR™ge
, &
vÆue
Ë=
UDS_SUCCESS
) {

67  
vÆue
;

71 
vÆue
.
ty≥
 = 
UDS_PARAM_TYPE_UNSIGNED_INT
;

72 
vÆue
.vÆue.
u_uöt
 = 
VOLUME_READ_THREADS
;

73  
vÆue
;

74 
	}
}

77 
	$deföeVﬁumeRódThªads
(
P¨amëîDeföôi⁄
 *
pd
)

79 
pd
->
vÆid©e
 = 
vÆid©eNumîicR™ge
;

80 
pd
->
vÆid©i⁄D©a
 = &
vÆidR™ge
;

81 
pd
->
cuºítVÆue
 = 
	`gëDeÁu…RódThªads
();

82 
pd
->
upd©e
 = 
NULL
;

83  
UDS_SUCCESS
;

84 
	}
}

87 
	$f‹m©Vﬁume
(
IORegi⁄
 *
ªgi⁄
, c⁄° 
Geomëry
 *
geomëry
)

90 
byã
 *
hódîPage
;

91 
ªsu…
 =

92 
	`ALLOCATE_IO_ALIGNED
(
geomëry
->
byãsPîPage
, 
byã
, "headerÖage",

93 &
hódîPage
);

94 i‡(
ªsu…
 !
UDS_SUCCESS
) {

95  
ªsu…
;

98 
vﬁumeF‹m©Lígth
 = 
	`ícodeVﬁumeF‹m©
(
hódîPage
, 
geomëry
);

99 i‡(
vﬁumeF‹m©Lígth
 > 
geomëry
->
byãsPîPage
) {

100 
	`FREE
(
hódîPage
);

101 
	`logW¨nög
("Volume format header isÅooÜarge");

102  
EINVAL
;

106 
ªsu…
 = 
	`wrôeToRegi⁄
(
ªgi⁄
, 0, 
hódîPage
, 
geomëry
->
byãsPîPage
,

107 
geomëry
->
byãsPîPage
);

108 
	`FREE
(
hódîPage
);

109 i‡(
ªsu…
 !
UDS_SUCCESS
) {

110  
ªsu…
;

113  
	`syncRegi⁄C⁄ã¡s
(
ªgi⁄
);

114 
	}
}

117 
	$makeVﬁume
(c⁄° 
C⁄figuøti⁄
 *
c⁄fig
,

118 
IndexLayout
 *
œyout
,

119 
ödexId
,

120 
ªadQueueMaxSize
,

121 
z⁄eCou¡
,

122 
Vﬁume
 **
√wVﬁume
)

124 
vﬁumeRódThªads
;

126 
UdsP¨amëîVÆue
 
vÆue
;

127 i‡((
	`udsGëP¨amëî
(
UDS_VOLUME_READ_THREADS
, &
vÆue
Ë=
UDS_SUCCESS
) &&

128 (
vÆue
.
ty≥
 =
UDS_PARAM_TYPE_UNSIGNED_INT
)) {

129 
vﬁumeRódThªads
 = 
vÆue
.vÆue.
u_uöt
;

131 
vﬁumeRódThªads
 = 
VOLUME_READ_THREADS
;

134 i‡(
ªadQueueMaxSize
 <
vﬁumeRódThªads
) {

135 
	`logEº‹
("Number ofÑeadÅhreads must be smallerÅhanÑead queue");

136  
UDS_INVALID_ARGUMENT
;

139 
Vﬁume
 *
vﬁume
;

141 
ªsu…
 = 
	`ÆloˇãVﬁume
(
c⁄fig
, 
œyout
, 
ödexId
, 
ªadQueueMaxSize
,

142 
z⁄eCou¡
, !
READ_ONLY_VOLUME
,

143 &
vﬁume
);

144 i‡(
ªsu…
 !
UDS_SUCCESS
) {

145  
ªsu…
;

148 
	`öôMuãx
(&
vﬁume
->
ªadThªadsMuãx
);

149 
	`öôC⁄d
(&
vﬁume
->
ªadThªadsRódD⁄eC⁄d
);

150 
	`öôC⁄d
(&
vﬁume
->
ªadThªadsC⁄d
);

151 
ªsu…
 = 
	`¸óãRódîThªads
(
vﬁume
, 
vﬁumeRódThªads
);

152 i‡(
ªsu…
 !
UDS_SUCCESS
) {

153  
ªsu…
;

156 *
√wVﬁume
 = 
vﬁume
;

157  
UDS_SUCCESS
;

158 
	}
}

161 
	$‰ìVﬁume
(
Vﬁume
 *
vﬁume
)

163 i‡(
vﬁume
 =
NULL
) {

167 
	`de°royRódîThªads
(
vﬁume
);

168 
	`de°royC⁄d
(&
vﬁume
->
ªadThªadsC⁄d
);

169 
	`de°royC⁄d
(&
vﬁume
->
ªadThªadsRódD⁄eC⁄d
);

170 
	`de°royMuãx
(&
vﬁume
->
ªadThªadsMuãx
);

171 
	`ªÀa£Vﬁume
(
vﬁume
);

172 
	}
}

175 
	$˛o£Vﬁume
(
Vﬁume
 *
vﬁume
)

177 
	`övÆid©eS∑r£Cache
(
vﬁume
->
•¨£Cache
);

179 
ªsu…
 = 
	`övÆid©ePageCache
(
vﬁume
->
∑geCache
);

180 i‡(
ªsu…
 !
UDS_SUCCESS
) {

181  
ªsu…
;

184  
	`d⁄eWôhVﬁume
(
vﬁume
);

185 
	}
}

188 
INLINE
 
	$m≠ToPageNumbî
(
Geomëry
 *
geomëry
,

189 
physiˇlPage
)

191  ((
physiˇlPage
 - 1Ë% 
geomëry
->
∑gesPîCh≠ãr
);

192 
	}
}

195 
INLINE
 
	$m≠ToCh≠ãrNumbî
(
Geomëry
 *
geomëry
,

196 
physiˇlPage
)

198  ((
physiˇlPage
 - 1Ë/ 
geomëry
->
∑gesPîCh≠ãr
);

199 
	}
}

202 
INLINE
 
boﬁ
 
	$isRec‹dPage
(
Geomëry
 *
geomëry
, 
physiˇlPage
)

204  (((
physiˇlPage
 - 1Ë% 
geomëry
->
∑gesPîCh≠ãr
)

205 >
geomëry
->
ödexPagesPîCh≠ãr
);

206 
	}
}

209 
INLINE
 
	$gëZ⁄eNumbî
(
Reque°
 *
ªque°
)

211  (
ªque°
 =
NULL
Ë? 0 :Ñeque°->
z⁄eNumbî
;

212 
	}
}

215 
	$waôF‹RódQueueNŸFuŒ
(
Vﬁume
 *
vﬁume
, 
Reque°
 *
ªque°
)

217 
∑geSórched
 = 0;

218 
z⁄eNumbî
 = 
	`gëZ⁄eNumbî
(
ªque°
);

219 i‡(
	`isSórchPídög
(
vﬁume
->
∑geCache
, 
z⁄eNumbî
)) {

224 
∑geSórched
 = 
vﬁume
->
∑geCache
->
£¨chPídögCou¡îs
[
z⁄eNumbî
].
∑ge
;

225 
	`ídPídögSórch
(
vﬁume
->
∑geCache
, 
z⁄eNumbî
);

228 
	`ªadQueueIsFuŒ
(
vﬁume
->
∑geCache
)) {

229 
	`logDebug
("Waiting untilÑead queueÇot full");

230 
	`sig«lC⁄d
(&
vﬁume
->
ªadThªadsC⁄d
);

231 
	`waôC⁄d
(&
vﬁume
->
ªadThªadsRódD⁄eC⁄d
, &vﬁume->
ªadThªadsMuãx
);

234 i‡(
∑geSórched
 != 0) {

236 
	`begöPídögSórch
(
vﬁume
->
∑geCache
, 
∑geSórched
, 
z⁄eNumbî
);

238 
	}
}

241 
	$íqueuePageRód
(
Vﬁume
 *
vﬁume
, 
Reque°
 *
ªque°
, 
physiˇlPage
)

245 i‡((
vﬁume
->
ªadîSèã
 & 
READER_STATE_EXIT
) != 0) {

246 
	`logInfo
("failedÅo queueÑead while shutting down");

247  
UDS_SHUTTINGDOWN
;

253 
ªsu…
;

254 (
ªsu…
 = 
	`íqueueRód
(
vﬁume
->
∑geCache
, 
ªque°
, 
physiˇlPage
))

255 =
UDS_SUCCESS
) {

256 
	`logDebug
("Read queues full, waiting forÑeadsÅo finish");

257 
	`waôF‹RódQueueNŸFuŒ
(
vﬁume
, 
ªque°
);

260 i‡(
ªsu…
 =
UDS_QUEUED
) {

262 
	`sig«lC⁄d
(&
vﬁume
->
ªadThªadsC⁄d
);

265  
ªsu…
;

266 
	}
}

269 
INLINE
 
	$waôToRe£rveRódQueueE¡ry
(
Vﬁume
 *
vﬁume
,

270 *
queuePos
,

271 
UdsQueueHód
 *
queuedReque°s
,

272 *
physiˇlPage
,

273 
boﬁ
 *
övÆid
)

275 ((
vﬁume
->
ªadîSèã
 & 
READER_STATE_EXIT
) == 0)

276 && (((
vﬁume
->
ªadîSèã
 & 
READER_STATE_STOP
) != 0)

277 || !
	`ª£rveRódQueueE¡ry
(
vﬁume
->
∑geCache
, 
queuePos
,

278 
queuedReque°s
, 
physiˇlPage
,

279 
övÆid
))) {

280 
	`waôC⁄d
(&
vﬁume
->
ªadThªadsC⁄d
, &vﬁume->
ªadThªadsMuãx
);

282 
	}
}

285 
	$öôCh≠ãrIndexPage
(c⁄° 
Vﬁume
 *
vﬁume
,

286 
byã
 *
ödexPage
,

287 
ch≠ãr
,

288 
ödexPageNumbî
,

289 
Ch≠ãrIndexPage
 *
ch≠ãrIndexPage
)

291 
Geomëry
 *
geomëry
 = 
vﬁume
->geometry;

293 
ªsu…
 = 
	`öôülizeCh≠ãrIndexPage
(
ch≠ãrIndexPage
, 
geomëry
,

294 
ödexPage
, 
vﬁume
->
n⁄˚
);

295 i‡(
vﬁume
->
lookupMode
 =
LOOKUP_FOR_REBUILD
) {

296  
ªsu…
;

298 i‡(
ªsu…
 !
UDS_SUCCESS
) {

299  
	`logEº‹WôhSåögEº‹
(
ªsu…
,

302 
ch≠ãr
, 
ödexPageNumbî
);

305 
IndexPageBounds
 
bounds
;

306 
ªsu…
 = 
	`gëLi°NumbîBounds
(
vﬁume
->
ödexPageM≠
, 
ch≠ãr
,

307 
ödexPageNumbî
, &
bounds
);

308 i‡(
ªsu…
 !
UDS_SUCCESS
) {

309  
ªsu…
;

312 
uöt64_t
 
ciVútuÆ


313 
	`gëCh≠ãrIndexVútuÆCh≠ãrNumbî
(
ch≠ãrIndexPage
);

314 
ciCh≠ãr
 = 
	`m≠ToPhysiˇlCh≠ãr
(
geomëry
, 
ciVútuÆ
);

315 
ciLowe°
 = 
	`gëCh≠ãrIndexLowe°Li°Numbî
(
ch≠ãrIndexPage
);

316 
ciHighe°
 = 
	`gëCh≠ãrIndexHighe°Li°Numbî
(
ch≠ãrIndexPage
);

317 i‡((
ch≠ãr
 =
ciCh≠ãr
)

318 && (
bounds
.
lowe°Li°
 =
ciLowe°
)

319 && (
bounds
.
highe°Li°
 =
ciHighe°
)) {

320  
UDS_SUCCESS
;

323 
	`logW¨nög
("IndexÖagêm≠ upd©edÅÿ%" 
PRIu64
,

324 
	`gëLa°Upd©e
(
vﬁume
->
ödexPageM≠
));

325 
	`logW¨nög
("Page mapÉxpectsÅhat chapter %uÖage %u hasÑange %uÅo %u, "

326 "buàch≠ã∏ödexÖagêha†ch≠ã∏%" 
PRIu64


328 
ch≠ãr
, 
ödexPageNumbî
, 
bounds
.
lowe°Li°
, bounds.
highe°Li°
,

329 
ciVútuÆ
, 
ciLowe°
, 
ciHighe°
);

330  
	`ASSERT_WITH_ERROR_CODE
(
Ál£
,

331 
UDS_CORRUPT_DATA
,

333 
	}
}

336 
	$öôülizeIndexPage
(
Vﬁume
 *
vﬁume
, 
physiˇlPage
,

337 
CachedPage
 *
∑ge
)

339 
ch≠ãr
 = 
	`m≠ToCh≠ãrNumbî
(
vﬁume
->
geomëry
, 
physiˇlPage
);

340 
ödexPageNumbî
 = 
	`m≠ToPageNumbî
(
vﬁume
->
geomëry
,

341 
physiˇlPage
);

342 
ªsu…
 = 
	`öôCh≠ãrIndexPage
(
vﬁume
, 
∑ge
->
d©a
,

343 
ch≠ãr
, 
ödexPageNumbî
,

344 &
∑ge
->
ödexPage
);

345  
ªsu…
;

346 
	}
}

349 
	$ªadThªadFun˘i⁄
(*
¨g
)

351 
Vﬁume
 *
vﬁume
 = 
¨g
;

352 
queuePos
;

353 
UdsQueueHód
 
queuedReque°s
;

354 
physiˇlPage
;

355 
boﬁ
 
övÆid
 = 
Ál£
;

357 
	`logDebug
("reader starting");

358 
	`lockMuãx
(&
vﬁume
->
ªadThªadsMuãx
);

359 
åue
) {

360 
	`waôToRe£rveRódQueueE¡ry
(
vﬁume
, &
queuePos
, &
queuedReque°s
,

361 &
physiˇlPage
, &
övÆid
);

362 i‡((
vﬁume
->
ªadîSèã
 & 
READER_STATE_EXIT
) != 0) {

366 
vﬁume
->
busyRódîThªads
++;

368 
boﬁ
 
ªc‹dPage
 = 
	`isRec‹dPage
(
vﬁume
->
geomëry
, 
physiˇlPage
);

370 
CachedPage
 *
∑ge
 = 
NULL
;

371 
ªsu…
 = 
UDS_SUCCESS
;

372 i‡(!
övÆid
) {

374 
ªsu…
 = 
	`£À˘Vi˘imInCache
(
vﬁume
->
∑geCache
, &
∑ge
);

375 i‡(
ªsu…
 =
UDS_SUCCESS
) {

376 
	`u∆ockMuãx
(&
vﬁume
->
ªadThªadsMuãx
);

384 
	`mem‹yFí˚
();

386 
ªsu…
 = 
	`waôF‹PídögSórches
(
vﬁume
->
∑geCache
, 
∑ge
->
physiˇlPage
);

387 i‡(
ªsu…
 !
UDS_SUCCESS
) {

388 
	`logW¨nög
("Error waiting forÖending search");

389 
	`ˇn˚lPageInCache
(
vﬁume
->
∑geCache
, 
physiˇlPage
, 
∑ge
);

391 
ªsu…
 = 
	`ªadPageToBuf„r
(
vﬁume
, 
physiˇlPage
, 
∑ge
->
d©a
);

392 i‡(
ªsu…
 !
UDS_SUCCESS
) {

393 
	`logW¨nög
("Eº‹ÑódögÖagê%u from vﬁume", 
physiˇlPage
);

394 
	`ˇn˚lPageInCache
(
vﬁume
->
∑geCache
, 
physiˇlPage
, 
∑ge
);

397 
	`lockMuãx
(&
vﬁume
->
ªadThªadsMuãx
);

399 
	`logW¨nög
("Error selecting cache victim forÖageÑead");

402 i‡(
ªsu…
 =
UDS_SUCCESS
) {

403 i‡(!
vﬁume
->
∑geCache
->
ªadQueue
[
queuePos
].
övÆid
) {

404 i‡(!
ªc‹dPage
) {

405 
ªsu…
 = 
	`öôülizeIndexPage
(
vﬁume
, 
physiˇlPage
, 
∑ge
);

406 i‡(
ªsu…
 !
UDS_SUCCESS
) {

407 
	`logW¨nög
("Error initializing chapter indexÖage");

408 
	`ˇn˚lPageInCache
(
vﬁume
->
∑geCache
, 
physiˇlPage
, 
∑ge
);

412 i‡(
ªsu…
 =
UDS_SUCCESS
) {

420 
	`mem‹yFí˚
();

422 
ªsu…
 = 
	`putPageInCache
(
vﬁume
->
∑geCache
, 
physiˇlPage
, 
∑ge
);

423 i‡(
ªsu…
 !
UDS_SUCCESS
) {

424 
	`logW¨nög
("Eº‹ÖuâögÖagê%u i¿ˇche", 
physiˇlPage
);

425 
	`ˇn˚lPageInCache
(
vﬁume
->
∑geCache
, 
physiˇlPage
, 
∑ge
);

429 
	`logW¨nög
("Pagê%u invÆid©edá·îÑód", 
physiˇlPage
);

430 
	`ˇn˚lPageInCache
(
vﬁume
->
∑geCache
, 
physiˇlPage
, 
∑ge
);

431 
övÆid
 = 
åue
;

435 
	`logDebug
("RequeuingÑequests for invalidÖage");

438 i‡(
övÆid
) {

439 
ªsu…
 = 
UDS_SUCCESS
;

440 
∑ge
 = 
NULL
;

443 !
	`STAILQ_EMPTY
(&
queuedReque°s
)) {

444 
Reque°
 *
ªque°
 = 
	`STAILQ_FIRST
(&
queuedReque°s
);

445 
	`STAILQ_REMOVE_HEAD
(&
queuedReque°s
, 
lök
);

457 i‡((
ªsu…
 =
UDS_SUCCESS
Ë&& (
∑ge
 !
NULL
Ë&& 
ªc‹dPage
) {

458 i‡(
	`£¨chRec‹dPage
(
∑ge
->
d©a
, &
ªque°
->
hash
, 
vﬁume
->
geomëry
,

459 &
ªque°
->
ﬁdMëad©a
)) {

460 
ªque°
->
¶Loˇti⁄
 = 
LOC_IN_DENSE
;

462 
ªque°
->
¶Loˇti⁄
 = 
LOC_UNAVAILABLE
;

464 
ªque°
->
¶Loˇti⁄Known
 = 
åue
;

468 
ªque°
->
°©us
 = 
ªsu…
;

469 
	`ª°¨tReque°
(
ªque°
);

472 
	`ªÀa£RódQueueE¡ry
(
vﬁume
->
∑geCache
, 
queuePos
);

474 
vﬁume
->
busyRódîThªads
--;

475 
	`brﬂdˇ°C⁄d
(&
vﬁume
->
ªadThªadsRódD⁄eC⁄d
);

477 
	`u∆ockMuãx
(&
vﬁume
->
ªadThªadsMuãx
);

478 
	`logDebug
("reader done");

479 
	}
}

482 
	$¸óãRódîThªads
(
Vﬁume
 *
vﬁume
, 
numRódîThªads
)

484 c⁄° 
READER_THREAD_NAME
[] = "volumeReader";

485 
vﬁume
->
numRódThªads
 = 
numRódîThªads
;

486 
ªsu…
 = 
	`ALLOCATE
(
numRódîThªads
, 
Thªad
,

487 "ªadîÅhªads", &
vﬁume
->
ªadîThªads
);

488 i‡(
ªsu…
 !
UDS_SUCCESS
) {

489  
ªsu…
;

492 
i
 = 0; i < 
numRódîThªads
; i++) {

493 
ªsu…
 = 
	`¸óãThªad
(
ªadThªadFun˘i⁄
, (*Ë
vﬁume
,

494 
READER_THREAD_NAME
, 
READER_STACK_SIZE
,

495 &
vﬁume
->
ªadîThªads
[
i
]);

496 i‡(
ªsu…
 !
UDS_SUCCESS
) {

497  
UDS_ENOTHREADS
;

500  
UDS_SUCCESS
;

501 
	}
}

504 
	$de°royRódîThªads
(
Vﬁume
 *
vﬁume
)

506 
	`lockMuãx
(&
vﬁume
->
ªadThªadsMuãx
);

507 
vﬁume
->
ªadîSèã
 |
READER_STATE_EXIT
;

508 
	`brﬂdˇ°C⁄d
(&
vﬁume
->
ªadThªadsC⁄d
);

509 
	`u∆ockMuãx
(&
vﬁume
->
ªadThªadsMuãx
);

511 
i
 = 0; i < 
vﬁume
->
numRódThªads
; i++) {

512 
	`joöThªads
(
vﬁume
->
ªadîThªads
[
i
]);

514 
	`FREE
(
vﬁume
->
ªadîThªads
);

515 
	}
}

518 
	$ªadPageLocked
(
Vﬁume
 *
vﬁume
,

519 
Reque°
 *
ªque°
,

520 
physiˇlPage
,

521 
boﬁ
 
syncRód
,

522 
CachedPage
 **
∑gePå
)

524 
syncRód
 |(
vﬁume
->
lookupMode
 =
LOOKUP_FOR_REBUILD
)

525 || (
ªque°
 =
NULL
)

526 || ((
ªque°
->
c⁄ãxt
 =
NULL
)

527 && (
ªque°
->
£rvîC⁄ãxt
 =
NULL
));

529 
ªsu…
 = 
UDS_SUCCESS
;

531 
CachedPage
 *
∑ge
 = 
NULL
;

532 i‡(
syncRód
) {

534 
ªsu…
 = 
	`£À˘Vi˘imInCache
(
vﬁume
->
∑geCache
, &
∑ge
);

535 i‡(
ªsu…
 !
UDS_SUCCESS
) {

536 
	`logW¨nög
("Error selecting cache victim forÖageÑead");

537  
ªsu…
;

539 
ªsu…
 = 
	`waôF‹PídögSórches
(
vﬁume
->
∑geCache
, 
∑ge
->
physiˇlPage
);

540 i‡(
ªsu…
 !
UDS_SUCCESS
) {

541 
	`logW¨nög
("Error waiting forÖending search");

542 
	`ˇn˚lPageInCache
(
vﬁume
->
∑geCache
, 
physiˇlPage
, 
∑ge
);

543  
ªsu…
;

545 
ªsu…
 = 
	`ªadPageFromVﬁume
(
vﬁume
, 
physiˇlPage
, 
∑ge
);

546 i‡(
ªsu…
 !
UDS_SUCCESS
) {

547 
	`logW¨nög
("Eº‹ÑódögÖagê%u from vﬁume", 
physiˇlPage
);

548 
	`ˇn˚lPageInCache
(
vﬁume
->
∑geCache
, 
physiˇlPage
, 
∑ge
);

549  
ªsu…
;

551 
ªsu…
 = 
	`putPageInCache
(
vﬁume
->
∑geCache
, 
physiˇlPage
, 
∑ge
);

552 i‡(
ªsu…
 !
UDS_SUCCESS
) {

553 
	`logW¨nög
("Eº‹ÖuâögÖagê%u i¿ˇche", 
physiˇlPage
);

554 
	`ˇn˚lPageInCache
(
vﬁume
->
∑geCache
, 
physiˇlPage
, 
∑ge
);

555  
ªsu…
;

558 
ªsu…
 = 
	`íqueuePageRód
(
vﬁume
, 
ªque°
, 
physiˇlPage
);

559 i‡(
ªsu…
 !
UDS_SUCCESS
) {

560  
ªsu…
;

564 *
∑gePå
 = 
∑ge
;

566  
UDS_SUCCESS
;

567 
	}
}

570 
	$gëPageLocked
(
Vﬁume
 *
vﬁume
,

571 
Reque°
 *
ªque°
,

572 
physiˇlPage
,

573 
CacheProbeTy≥
 
¥obeTy≥
,

574 
CachedPage
 **
∑gePå
)

576 
CachedPage
 *
∑ge
 = 
NULL
;

577 
ªsu…
 = 
	`gëPageFromCache
(
vﬁume
->
∑geCache
, 
physiˇlPage
, 
¥obeTy≥
,

578 &
∑ge
);

579 i‡(
ªsu…
 !
UDS_SUCCESS
) {

580  
ªsu…
;

582 i‡(
∑ge
 =
NULL
) {

583 
ªsu…
 = 
	`ªadPageLocked
(
vﬁume
, 
ªque°
, 
physiˇlPage
, 
åue
, &
∑ge
);

584 i‡(
ªsu…
 !
UDS_SUCCESS
) {

585  
ªsu…
;

587 } i‡(
	`gëZ⁄eNumbî
(
ªque°
) == 0) {

589 
	`makePageMo°Re˚¡
(
vﬁume
->
∑geCache
, 
∑ge
);

592 *
∑gePå
 = 
∑ge
;

593  
UDS_SUCCESS
;

594 
	}
}

597 
	$gëPagePrŸe˘ed
(
Vﬁume
 *
vﬁume
,

598 
Reque°
 *
ªque°
,

599 
physiˇlPage
,

600 
CacheProbeTy≥
 
¥obeTy≥
,

601 
CachedPage
 **
∑gePå
)

603 
CachedPage
 *
∑ge
 = 
NULL
;

604 
ªsu…
 = 
	`gëPageFromCache
(
vﬁume
->
∑geCache
, 
physiˇlPage
,

605 
¥obeTy≥
 | 
CACHE_PROBE_IGNORE_FAILURE
,

606 &
∑ge
);

607 i‡(
ªsu…
 !
UDS_SUCCESS
) {

608  
ªsu…
;

611 
z⁄eNumbî
 = 
	`gëZ⁄eNumbî
(
ªque°
);

614 i‡(
∑ge
 =
NULL
) {

615 
	`ídPídögSórch
(
vﬁume
->
∑geCache
, 
z⁄eNumbî
);

616 
	`lockMuãx
(&
vﬁume
->
ªadThªadsMuãx
);

627 
ªsu…


628 
	`gëPageFromCache
(
vﬁume
->
∑geCache
, 
physiˇlPage
, 
¥obeTy≥
, &
∑ge
);

629 i‡(
ªsu…
 !
UDS_SUCCESS
) {

646 
	`u∆ockMuãx
(&
vﬁume
->
ªadThªadsMuãx
);

647 
	`begöPídögSórch
(
vﬁume
->
∑geCache
, 
physiˇlPage
, 
z⁄eNumbî
);

648  
ªsu…
;

653 i‡(
∑ge
 !
NULL
) {

662 
	`begöPídögSórch
(
vﬁume
->
∑geCache
, 
physiˇlPage
, 
z⁄eNumbî
);

663 
	`u∆ockMuãx
(&
vﬁume
->
ªadThªadsMuãx
);

667 i‡(
∑ge
 =
NULL
) {

668 
ªsu…
 = 
	`ªadPageLocked
(
vﬁume
, 
ªque°
, 
physiˇlPage
, 
Ál£
, &
∑ge
);

669 i‡(
ªsu…
 !
UDS_SUCCESS
) {

676 
	`u∆ockMuãx
(&
vﬁume
->
ªadThªadsMuãx
);

677 
	`begöPídögSórch
(
vﬁume
->
∑geCache
, 
physiˇlPage
, 
z⁄eNumbî
);

678  
ªsu…
;

682 
	`begöPídögSórch
(
vﬁume
->
∑geCache
, 
physiˇlPage
, 
z⁄eNumbî
);

683 
	`u∆ockMuãx
(&
vﬁume
->
ªadThªadsMuãx
);

685 i‡(
	`gëZ⁄eNumbî
(
ªque°
) == 0 ) {

687 
	`makePageMo°Re˚¡
(
vﬁume
->
∑geCache
, 
∑ge
);

691 *
∑gePå
 = 
∑ge
;

692  
UDS_SUCCESS
;

693 
	}
}

696 
	$gëPage
(
Vﬁume
 *
vﬁume
,

697 
Reque°
 *
ªque°
,

698 
ch≠ãr
,

699 
∑geNumbî
,

700 
CacheProbeTy≥
 
¥obeTy≥
,

701 
byã
 **
∑gePå
)

703 
physiˇlPage


704 
	`m≠ToPhysiˇlPage
(
vﬁume
->
geomëry
, 
ch≠ãr
, 
∑geNumbî
);

706 
	`lockMuãx
(&
vﬁume
->
ªadThªadsMuãx
);

707 
CachedPage
 *
∑ge
 = 
NULL
;

708 
ªsu…
 = 
	`gëPageLocked
(
vﬁume
, 
ªque°
, 
physiˇlPage
, 
¥obeTy≥
,

709 &
∑ge
);

710 
	`u∆ockMuãx
(&
vﬁume
->
ªadThªadsMuãx
);

712 i‡(
∑gePå
 !
NULL
) {

713 *
∑gePå
 = (
∑ge
 !
NULL
Ë?Öage->
d©a
 : NULL;

715  
ªsu…
;

716 
	}
}

734 
	$£¨chCachedIndexPage
(
Vﬁume
 *
vﬁume
,

735 
Reque°
 *
ªque°
,

736 c⁄° 
UdsChunkName
 *
«me
,

737 
ch≠ãr
,

738 
ödexPageNumbî
,

739 *
ªc‹dPageNumbî
)

741 
z⁄eNumbî
 = 
	`gëZ⁄eNumbî
(
ªque°
);

742 
physiˇlPage


743 
	`m≠ToPhysiˇlPage
(
vﬁume
->
geomëry
, 
ch≠ãr
, 
ödexPageNumbî
);

752 
	`begöPídögSórch
(
vﬁume
->
∑geCache
, 
physiˇlPage
, 
z⁄eNumbî
);

753 
	`mem‹yFí˚
();

755 
CachedPage
 *
∑ge
 = 
NULL
;

756 
ªsu…
 = 
	`gëPagePrŸe˘ed
(
vﬁume
, 
ªque°
, 
physiˇlPage
,

757 
	`ˇcheProbeTy≥
(
ªque°
, 
åue
), &
∑ge
);

758 i‡(
ªsu…
 !
UDS_SUCCESS
) {

761 
	`mem‹yFí˚
();

762 
	`ídPídögSórch
(
vﬁume
->
∑geCache
, 
z⁄eNumbî
);

763  
ªsu…
;

766 
ªsu…
 = 
	`ASSERT_SEARCH_IS_PENDING
(
vﬁume
->
∑geCache
, 
z⁄eNumbî
);

767 i‡(
ªsu…
 !
UDS_SUCCESS
) {

768  
ªsu…
;

771 
ªsu…
 = 
	`£¨chCh≠ãrIndexPage
(&
∑ge
->
ödexPage
, 
vﬁume
->
geomëry
, 
«me
,

772 
ªc‹dPageNumbî
);

776 
	`mem‹yFí˚
();

777 
	`ídPídögSórch
(
vﬁume
->
∑geCache
, 
z⁄eNumbî
);

779  
ªsu…
;

780 
	}
}

805 
	$£¨chCachedRec‹dPage
(
Vﬁume
 *
vﬁume
,

806 
Reque°
 *
ªque°
,

807 c⁄° 
UdsChunkName
 *
«me
,

808 
ch≠ãr
,

809 
ªc‹dPageNumbî
,

810 
UdsChunkD©a
 *
du∂iˇã
,

811 
boﬁ
 *
found
)

813 *
found
 = 
Ál£
;

815 i‡(
ªc‹dPageNumbî
 =
NO_CHAPTER_INDEX_ENTRY
) {

817  
UDS_SUCCESS
;

820 
Geomëry
 *
geomëry
 = 
vﬁume
->geometry;

821 
ªsu…
 = 
	`ASSERT
(((
ªc‹dPageNumbî
 >= 0)

822 && ((Ë
ªc‹dPageNumbî


823 < 
geomëry
->
ªc‹dPagesPîCh≠ãr
)),

825 
ªc‹dPageNumbî
, 
geomëry
->
ªc‹dPagesPîCh≠ãr
);

826 i‡(
ªsu…
 !
UDS_SUCCESS
) {

827  
ªsu…
;

830 
∑geNumbî
 = 
geomëry
->
ödexPagesPîCh≠ãr
 + 
ªc‹dPageNumbî
;

832 
z⁄eNumbî
 = 
	`gëZ⁄eNumbî
(
ªque°
);

833 
physiˇlPage


834 
	`m≠ToPhysiˇlPage
(
vﬁume
->
geomëry
, 
ch≠ãr
, 
∑geNumbî
);

843 
	`begöPídögSórch
(
vﬁume
->
∑geCache
, 
physiˇlPage
, 
z⁄eNumbî
);

844 
	`mem‹yFí˚
();

846 
CachedPage
 *
ªc‹dPage
;

847 
ªsu…
 = 
	`gëPagePrŸe˘ed
(
vﬁume
, 
ªque°
, 
physiˇlPage
,

848 
	`ˇcheProbeTy≥
(
ªque°
, 
Ál£
), &
ªc‹dPage
);

849 i‡(
ªsu…
 !
UDS_SUCCESS
) {

852 
	`mem‹yFí˚
();

853 
	`ídPídögSórch
(
vﬁume
->
∑geCache
, 
z⁄eNumbî
);

854  
ªsu…
;

857 i‡(
	`£¨chRec‹dPage
(
ªc‹dPage
->
d©a
, 
«me
, 
geomëry
, 
du∂iˇã
)) {

858 *
found
 = 
åue
;

861 
	`mem‹yFí˚
();

862 
	`ídPídögSórch
(
vﬁume
->
∑geCache
, 
z⁄eNumbî
);

864  
UDS_SUCCESS
;

865 
	}
}

868 
	$ªadPageFromVﬁume
(
Vﬁume
 *
vﬁume
,

869 
physiˇlPage
,

870 
CachedPage
 *
∑ge
)

872 
boﬁ
 
ªc‹dPage
 = 
	`isRec‹dPage
(
vﬁume
->
geomëry
, 
physiˇlPage
);

873 
ªsu…
 = 
	`ªadPageToBuf„r
(
vﬁume
, 
physiˇlPage
, 
∑ge
->
d©a
);

874 i‡(
ªsu…
 !
UDS_SUCCESS
) {

875  
ªsu…
;

877 i‡(!
ªc‹dPage
) {

878 
ªsu…
 = 
	`öôülizeIndexPage
(
vﬁume
, 
physiˇlPage
, 
∑ge
);

881  
ªsu…
;

882 
	}
}

885 
	$ªadCh≠ãrIndexFromVﬁume
(c⁄° 
Vﬁume
 *
vﬁume
,

886 
uöt64_t
 
vútuÆCh≠ãr
,

887 
byã
 
∑geD©a
[],

888 
Ch≠ãrIndexPage
 
ödexPages
[])

890 
physiˇlCh≠ãr


891 
	`m≠ToPhysiˇlCh≠ãr
(
vﬁume
->
geomëry
, 
vútuÆCh≠ãr
);

892 
ªsu…
 = 
	`ªadCh≠ãrIndexToBuf„r
(
vﬁume
, 
physiˇlCh≠ãr
, 
∑geD©a
);

893 i‡(
ªsu…
 !
UDS_SUCCESS
) {

894  
ªsu…
;

897 
i
 = 0; i < 
vﬁume
->
geomëry
->
ödexPagesPîCh≠ãr
; i++) {

898 
byã
 *
ödexPage
 = &
∑geD©a
[
i
 * 
vﬁume
->
geomëry
->
byãsPîPage
];

899 
ªsu…
 = 
	`öôCh≠ãrIndexPage
(
vﬁume
, 
ödexPage
, 
physiˇlCh≠ãr
,

900 
i
, &
ödexPages
[i]);

901 i‡(
ªsu…
 !
UDS_SUCCESS
) {

902  
ªsu…
;

905  
UDS_SUCCESS
;

906 
	}
}

909 
	$£¨chVﬁumePageCache
(
Vﬁume
 *
vﬁume
,

910 
Reque°
 *
ªque°
,

911 c⁄° 
UdsChunkName
 *
«me
,

912 
ch≠ãr
,

913 
ödexPageNumbî
,

914 
UdsChunkD©a
 *
mëad©a
,

915 
boﬁ
 *
found
)

917 
ªc‹dPageNumbî
;

918 
ªsu…
 = 
	`£¨chCachedIndexPage
(
vﬁume
, 
ªque°
, 
«me
, 
ch≠ãr
,

919 
ödexPageNumbî
, &
ªc‹dPageNumbî
);

920 i‡(
ªsu…
 =
UDS_SUCCESS
) {

921 
ªsu…
 = 
	`£¨chCachedRec‹dPage
(
vﬁume
, 
ªque°
, 
«me
, 
ch≠ãr
,

922 
ªc‹dPageNumbî
, 
mëad©a
, 
found
);

925  
ªsu…
;

926 
	}
}

929 
	$£¨chVﬁume
(
Vﬁume
 *
vﬁume
,

930 
Reque°
 *
ªque°
,

931 c⁄° 
UdsChunkName
 *
«me
,

932 
uöt64_t
 
vútuÆCh≠ãr
,

933 
boﬁ
 
isS∑r£
,

934 
UdsChunkD©a
 *
mëad©a
,

935 
boﬁ
 *
found
)

937 i‡(
found
 =
NULL
) {

938  
	`logEº‹WôhSåögEº‹
(
UDS_INVALID_ARGUMENT
,

944 i‡((
ªque°
 !
NULL
Ë&&Ñeque°->
¶Loˇti⁄Known
) {

945 *
found
 = (
ªque°
->
¶Loˇti⁄
 !
LOC_UNAVAILABLE
);

946  
UDS_SUCCESS
;

949 i‡(
isS∑r£
 && 
	`•¨£CacheC⁄èös
(
vﬁume
->
•¨£Cache
,

950 
vútuÆCh≠ãr
,

951 
ªque°
->
z⁄eNumbî
)) {

954  
	`£¨chVﬁumeS∑r£Cache
(
vﬁume
, 
ªque°
, 
vútuÆCh≠ãr
, 
found
);

957 
physiˇlCh≠ãr


958 
	`m≠ToPhysiˇlCh≠ãr
(
vﬁume
->
geomëry
, 
vútuÆCh≠ãr
);

959 
ödexPageNumbî
;

960 
ªsu…
 = 
	`födIndexPageNumbî
(
vﬁume
->
ödexPageM≠
, 
«me
, 
physiˇlCh≠ãr
,

961 &
ödexPageNumbî
);

962 i‡(
ªsu…
 !
UDS_SUCCESS
) {

963  
ªsu…
;

966  (
	`£¨chVﬁumePageCache
(
vﬁume
, 
ªque°
, 
«me
, 
physiˇlCh≠ãr
,

967 
ödexPageNumbî
, 
mëad©a
, 
found
));

968 
	}
}

971 
	$£¨chVﬁumeS∑r£Cache
(
Vﬁume
 *
vﬁume
,

972 
Reque°
 *
ªque°
,

973 
uöt64_t
 
vútuÆCh≠ãr
,

974 
boﬁ
 *
found
)

976 i‡(
found
 =
NULL
) {

977  
	`logEº‹WôhSåögEº‹
(
UDS_INVALID_ARGUMENT
,

981 
ªc‹dPageNumbî
;

982 
ªsu…
 = 
	`£¨chS∑r£Cache
(
vﬁume
->
•¨£Cache
,

983 
vﬁume
->
ödexPageM≠
,

984 &
ªque°
->
hash
,

985 
ªque°
->
z⁄eNumbî
,

986 &
vútuÆCh≠ãr
,

987 &
ªc‹dPageNumbî
);

988 i‡((
ªsu…
 !
UDS_SUCCESS
Ë|| (
vútuÆCh≠ãr
 =
UINT64_MAX
)) {

989  
ªsu…
;

994 
ch≠ãr


995 
	`m≠ToPhysiˇlCh≠ãr
(
vﬁume
->
geomëry
, 
vútuÆCh≠ãr
);

997 
ªsu…
 = 
	`£¨chCachedRec‹dPage
(
vﬁume
, 
ªque°
, &ªque°->
hash
,

998 
ch≠ãr
, 
ªc‹dPageNumbî
,

999 &
ªque°
->
ﬁdMëad©a
, 
found
);

1000  
ªsu…
;

1001 
	}
}

1004 
	$f‹gëCh≠ãr
(
Vﬁume
 *
vﬁume
,

1005 
uöt64_t
 
vútuÆCh≠ãr
,

1006 
InvÆid©i⁄Rós⁄
 
ªas⁄
)

1008 
	`logDebug
("f‹gëtög ch≠ã∏%" 
PRIu64
, 
vútuÆCh≠ãr
);

1009 
	`övÆid©eS∑r£CacheCh≠ãr
(
vﬁume
->
•¨£Cache
, 
vútuÆCh≠ãr
);

1011 
physiˇlCh≠ãr


1012 
	`m≠ToPhysiˇlCh≠ãr
(
vﬁume
->
geomëry
, 
vútuÆCh≠ãr
);

1013 
	`lockMuãx
(&
vﬁume
->
ªadThªadsMuãx
);

1014 
ªsu…


1015 
	`övÆid©ePageCacheF‹Ch≠ãr
(
vﬁume
->
∑geCache
, 
physiˇlCh≠ãr
,

1016 
vﬁume
->
geomëry
->
∑gesPîCh≠ãr
,

1017 
ªas⁄
);

1018 
	`u∆ockMuãx
(&
vﬁume
->
ªadThªadsMuãx
);

1019  
ªsu…
;

1020 
	}
}

1023 
	$wrôeS¸©chPage
(
Vﬁume
 *
vﬁume
, 
off_t
 *
off£t
)

1025 
ªsu…
 = 
	`wrôeToRegi⁄
(
vﬁume
->
ªgi⁄
, *
off£t
, vﬁume->
s¸©chPage
,

1026 
vﬁume
->
geomëry
->
byãsPîPage
,

1027 
vﬁume
->
geomëry
->
byãsPîPage
);

1028 *
off£t
 +
vﬁume
->
geomëry
->
byãsPîPage
;

1029  
ªsu…
;

1030 
	}
}

1033 
	$upd©eVﬁumeSize
(
Vﬁume
 *
vﬁume
, 
off_t
 
size
)

1035 i‡(
vﬁume
->
vﬁumeSize
 < 
size
) {

1036 
vﬁume
->
vﬁumeSize
 = 
size
;

1038 
	}
}

1050 
	$d⁄©eIndexPageLocked
(
Vﬁume
 *
vﬁume
,

1051 
physiˇlCh≠ãr
,

1052 
ödexPageNumbî
)

1054 
physiˇlPage


1055 
	`m≠ToPhysiˇlPage
(
vﬁume
->
geomëry
, 
physiˇlCh≠ãr
, 
ödexPageNumbî
);

1058 
CachedPage
 *
∑ge
 = 
NULL
;

1059 
ªsu…
 = 
	`£À˘Vi˘imInCache
(
vﬁume
->
∑geCache
, &
∑ge
);

1060 i‡(
ªsu…
 !
UDS_SUCCESS
) {

1061  
ªsu…
;

1064 
ªsu…
 = 
	`waôF‹PídögSórches
(
vﬁume
->
∑geCache
, 
∑ge
->
physiˇlPage
);

1065 i‡(
ªsu…
 !
UDS_SUCCESS
) {

1066 
	`logW¨nög
("Error waiting forÖending search");

1067 
	`ˇn˚lPageInCache
(
vﬁume
->
∑geCache
, 
physiˇlPage
, 
∑ge
);

1068  
ªsu…
;

1072 
	`mem˝y
(
∑ge
->
d©a
, 
vﬁume
->
s¸©chPage
, vﬁume->
geomëry
->
byãsPîPage
);

1074 
ªsu…
 = 
	`öôCh≠ãrIndexPage
(
vﬁume
, 
∑ge
->
d©a
, 
physiˇlCh≠ãr
,

1075 
ödexPageNumbî
, &
∑ge
->
ödexPage
);

1076 i‡(
ªsu…
 !
UDS_SUCCESS
) {

1077 
	`logW¨nög
("Error initialize chapter indexÖage");

1078 
	`ˇn˚lPageInCache
(
vﬁume
->
∑geCache
, 
physiˇlPage
, 
∑ge
);

1079  
ªsu…
;

1082 
ªsu…
 = 
	`putPageInCache
(
vﬁume
->
∑geCache
, 
physiˇlPage
, 
∑ge
);

1083 i‡(
ªsu…
 !
UDS_SUCCESS
) {

1084 
	`logW¨nög
("Eº‹ÖuâögÖagê%u i¿ˇche", 
physiˇlPage
);

1085 
	`ˇn˚lPageInCache
(
vﬁume
->
∑geCache
, 
physiˇlPage
, 
∑ge
);

1086  
ªsu…
;

1089  
UDS_SUCCESS
;

1090 
	}
}

1093 
	$wrôeIndexPages
(
Vﬁume
 *
vﬁume
,

1094 
off_t
 
ch≠ãrOff£t
,

1095 
O≥nCh≠ãrIndex
 *
ch≠ãrIndex
,

1096 
byã
 **
∑ges
)

1098 
Geomëry
 *
geomëry
 = 
vﬁume
->geometry;

1099 
physiˇlCh≠ãrNumbî


1100 
	`m≠ToPhysiˇlCh≠ãr
(
geomëry
, 
ch≠ãrIndex
->
vútuÆCh≠ãrNumbî
);

1101 
dñèLi°Numbî
 = 0;

1103 
off_t
 
∑geOff£t
 = 
ch≠ãrOff£t
;

1105 
ödexPageNumbî
 = 0;

1106 
ödexPageNumbî
 < 
geomëry
->
ödexPagesPîCh≠ãr
;

1107 
ödexPageNumbî
++) {

1109 
li°sPacked
;

1110 
boﬁ
 
œ°Page
 = ((
ödexPageNumbî
 + 1Ë=
geomëry
->
ödexPagesPîCh≠ãr
);

1111 
ªsu…
 = 
	`∑ckO≥nCh≠ãrIndexPage
(
ch≠ãrIndex
, 
vﬁume
->
n⁄˚
,

1112 
vﬁume
->
s¸©chPage
,

1113 
dñèLi°Numbî
, 
œ°Page
,

1114 &
li°sPacked
);

1115 i‡(
ªsu…
 !
UDS_SUCCESS
) {

1116  
	`logEº‹WôhSåögEº‹
(
ªsu…
, "failedÅoÖack indexÖage");

1120 
ªsu…
 = 
	`wrôeS¸©chPage
(
vﬁume
, &
∑geOff£t
);

1121 i‡(
ªsu…
 !
UDS_SUCCESS
) {

1122  
	`logEº‹WôhSåögEº‹
(
ªsu…
,

1126 i‡(
∑ges
 !
NULL
) {

1127 
	`mem˝y
(
∑ges
[
ödexPageNumbî
], 
vﬁume
->
s¸©chPage
,

1128 
geomëry
->
byãsPîPage
);

1133 i‡(
li°sPacked
 == 0) {

1134 
	`logInfo
("no deltaÜistsÖacked on chapter %uÖage %u",

1135 
physiˇlCh≠ãrNumbî
, 
ödexPageNumbî
);

1137 
dñèLi°Numbî
 +
li°sPacked
;

1139 
ªsu…
 = 
	`upd©eIndexPageM≠
(
vﬁume
->
ödexPageM≠
,

1140 
ch≠ãrIndex
->
vútuÆCh≠ãrNumbî
,

1141 
physiˇlCh≠ãrNumbî
,

1142 
ödexPageNumbî
, 
dñèLi°Numbî
 - 1);

1143 i‡(
ªsu…
 !
UDS_SUCCESS
) {

1144  
	`logEº‹WôhSåögEº‹
(
ªsu…
,

1149 
	`lockMuãx
(&
vﬁume
->
ªadThªadsMuãx
);

1150 
ªsu…
 = 
	`d⁄©eIndexPageLocked
(
vﬁume
, 
physiˇlCh≠ãrNumbî
,

1151 
ödexPageNumbî
);

1152 
	`u∆ockMuãx
(&
vﬁume
->
ªadThªadsMuãx
);

1153 i‡(
ªsu…
 !
UDS_SUCCESS
) {

1154  
ªsu…
;

1158  
	`ASSERT
((
∑geOff£t
 =(
ch≠ãrOff£t
 + 
geomëry
->
ªc‹dPageOff£t
)),

1160  
UDS_SUCCESS
;

1161 
	}
}

1164 
	$wrôeRec‹dPages
(
Vﬁume
 *
vﬁume
,

1165 
off_t
 
ch≠ãrOff£t
,

1166 c⁄° 
UdsChunkRec‹d
 
ªc‹ds
[],

1167 
byã
 **
∑ges
)

1169 
Geomëry
 *
geomëry
 = 
vﬁume
->geometry;

1170 
off_t
 
∑geOff£t
 = 
ch≠ãrOff£t
 + 
geomëry
->
ªc‹dPageOff£t
;

1172 c⁄° 
UdsChunkRec‹d
 *
√xtRec‹d
 = &
ªc‹ds
[1];

1174 
ªc‹dPageNumbî
 = 0;

1175 
ªc‹dPageNumbî
 < 
geomëry
->
ªc‹dPagesPîCh≠ãr
;

1176 
ªc‹dPageNumbî
++) {

1179 
ªsu…
 = 
	`ícodeRec‹dPage
(
vﬁume
, 
√xtRec‹d
);

1180 i‡(
ªsu…
 !
UDS_SUCCESS
) {

1181  
	`logW¨nögWôhSåögEº‹
(
ªsu…
,

1183 
ªc‹dPageNumbî
);

1185 
√xtRec‹d
 +
geomëry
->
ªc‹dsPîPage
;

1188 
ªsu…
 = 
	`wrôeS¸©chPage
(
vﬁume
, &
∑geOff£t
);

1189 i‡(
ªsu…
 !
UDS_SUCCESS
) {

1190  
	`logW¨nögWôhSåögEº‹
(
ªsu…
, "failedÅo writeÑecordÖage %u",

1191 
ªc‹dPageNumbî
);

1194 i‡(
∑ges
 !
NULL
) {

1195 
	`mem˝y
(
∑ges
[
ªc‹dPageNumbî
], 
vﬁume
->
s¸©chPage
,

1196 
geomëry
->
byãsPîPage
);

1200  
	`ASSERT
((
∑geOff£t


1201 =(
ch≠ãrOff£t
 + (
off_t
Ë
geomëry
->
byãsPîCh≠ãr
)),

1203 
	}
}

1206 
	$wrôeCh≠ãr
(
Vﬁume
 *
vﬁume
,

1207 
O≥nCh≠ãrIndex
 *
ch≠ãrIndex
,

1208 c⁄° 
UdsChunkRec‹d
 
ªc‹ds
[])

1211 
Geomëry
 *
geomëry
 = 
vﬁume
->geometry;

1212 
physiˇlCh≠ãrNumbî


1213 
	`m≠ToPhysiˇlCh≠ãr
(
geomëry
, 
ch≠ãrIndex
->
vútuÆCh≠ãrNumbî
);

1214 
physiˇlPage
 = 
	`m≠ToPhysiˇlPage
(
geomëry
, 
physiˇlCh≠ãrNumbî
, 0);

1215 
off_t
 
ch≠ãrOff£t
 = (off_tË
physiˇlPage
 * (off_tË
geomëry
->
byãsPîPage
;

1218 
ªsu…
 = 
	`wrôeIndexPages
(
vﬁume
, 
ch≠ãrOff£t
, 
ch≠ãrIndex
, 
NULL
);

1219 i‡(
ªsu…
 !
UDS_SUCCESS
) {

1220  
ªsu…
;

1223 
ªsu…
 = 
	`wrôeRec‹dPages
(
vﬁume
, 
ch≠ãrOff£t
, 
ªc‹ds
, 
NULL
);

1224 i‡(
ªsu…
 !
UDS_SUCCESS
) {

1225  
ªsu…
;

1227 
	`upd©eVﬁumeSize
(
vﬁume
, 
ch≠ãrOff£t
 + 
geomëry
->
byãsPîCh≠ãr
);

1228  
UDS_SUCCESS
;

1229 
	}
}

1232 
off_t
 
	$gëVﬁumeSize
(
Vﬁume
 *
vﬁume
)

1234  
vﬁume
->
vﬁumeSize
;

1235 
	}
}

1238 
size_t
 
	$gëCacheSize
(
Vﬁume
 *
vﬁume
)

1240  (
	`gëPageCacheSize
(
vﬁume
->
∑geCache
)

1241 + 
	`gëS∑r£CacheMem‹ySize
(
vﬁume
->
•¨£Cache
));

1242 
	}
}

1245 
	$gëCacheCou¡îs
(
Vﬁume
 *
vﬁume
, 
CacheCou¡îs
 *
cou¡îs
)

1247 
	`gëPageCacheCou¡îs
(
vﬁume
->
∑geCache
, 
cou¡îs
);

1248 
	`addCacheCou¡îs
(
cou¡îs
, 
	`gëS∑r£CacheCou¡îs
(
vﬁume
->
•¨£Cache
));

1249 
	}
}

1252 
off_t
 
	$off£tF‹Ch≠ãr
(c⁄° 
Geomëry
 *
geomëry
,

1253 
ch≠ãr
)

1255  
geomëry
->
byãsPîPage
 +

1256 (((
off_t
Ë
ch≠ãr
Ë* 
geomëry
->
byãsPîCh≠ãr
);

1257 
	}
}

1260 
	$¥obeCh≠ãr
(c⁄° 
Vﬁume
 *
vﬁume
,

1261 
ch≠ãrNumbî
,

1262 
uöt64_t
 *
vútuÆCh≠ãrNumbî
,

1263 
byã
 *
buf„r
)

1265 c⁄° 
Geomëry
 *
geomëry
 = 
vﬁume
->geometry;

1266 
off_t
 
ba£Off£t
 = 
	`off£tF‹Ch≠ãr
(
geomëry
, 
ch≠ãrNumbî
);

1267 
ex≥˘edLi°Numbî
 = 0;

1268 
uöt64_t
 
œ°VCN
 = 
UINT64_MAX
;

1270 
i
 = 0; i < 
geomëry
->
ödexPagesPîCh≠ãr
; ++i) {

1271 
ªsu…
 = 
	`ªadFromRegi⁄
(
vﬁume
->
ªgi⁄
,

1272 
ba£Off£t
 + (
i
 * 
geomëry
->
byãsPîPage
),

1273 
buf„r
, 
geomëry
->
byãsPîPage
, 
NULL
);

1274 i‡(
ªsu…
 !
UDS_SUCCESS
) {

1275 
	`logW¨nögWôhSåögEº‹
(
ªsu…
, "%s gotÑeadFromRegionÉrror",

1276 
__func__
);

1277  
ªsu…
;

1280 
Ch≠ãrIndexPage
 
∑ge
;

1281 
ªsu…
 = 
	`öôülizeCh≠ãrIndexPage
(&
∑ge
, 
geomëry
, 
buf„r
, 
vﬁume
->
n⁄˚
);

1282 i‡(
ªsu…
 !
UDS_SUCCESS
) {

1283  
ªsu…
;

1286 
uöt64_t
 
v˙
 = 
	`gëCh≠ãrIndexVútuÆCh≠ãrNumbî
(&
∑ge
);

1287 i‡(
œ°VCN
 =
UINT64_MAX
) {

1288 
œ°VCN
 = 
v˙
;

1289 } i‡(
v˙
 !
œ°VCN
) {

1290 
	`logEº‹
("inconsistent chapter %u indexÖage %u:Éxpected vcn %"

1291 
PRIu64
 ", got vcn %" PRIu64,

1292 
ch≠ãrNumbî
, 
i
, 
œ°VCN
, 
v˙
);

1293  
UDS_CORRUPT_COMPONENT
;

1296 i‡(
ex≥˘edLi°Numbî
 !
	`gëCh≠ãrIndexLowe°Li°Numbî
(&
∑ge
)) {

1297 
	`logEº‹
("inconsistent chapter %u indexÖage %u:ÉxpectedÜistÇumber %u"

1299 
ch≠ãrNumbî
, 
i
, 
ex≥˘edLi°Numbî
,

1300 
	`gëCh≠ãrIndexLowe°Li°Numbî
(&
∑ge
));

1301  
UDS_CORRUPT_COMPONENT
;

1303 
ex≥˘edLi°Numbî
 = 
	`gëCh≠ãrIndexHighe°Li°Numbî
(&
∑ge
) + 1;

1305 
ªsu…
 = 
	`vÆid©eCh≠ãrIndexPage
(&
∑ge
, 
geomëry
);

1306 i‡(
ªsu…
 !
UDS_SUCCESS
) {

1307  
ªsu…
;

1311 i‡(
œ°VCN
 =
UINT64_MAX
) {

1312 
	`logEº‹
("nÿch≠ã∏%u vútuÆ ch≠ã∏numbî dëîmöed", 
ch≠ãrNumbî
);

1313  
UDS_CORRUPT_COMPONENT
;

1315 i‡(
ch≠ãrNumbî
 !
œ°VCN
 % 
geomëry
->
ch≠ãrsPîVﬁume
) {

1316 
	`logEº‹
("ch≠ã∏%u v˙ %" 
PRIu64
 " is out ofÖhase (%u)",

1317 
ch≠ãrNumbî
, 
œ°VCN
, 
geomëry
->
ch≠ãrsPîVﬁume
);

1318  
UDS_CORRUPT_COMPONENT
;

1320 *
vútuÆCh≠ãrNumbî
 = 
œ°VCN
;

1321  
UDS_SUCCESS
;

1322 
	}
}

1325 
	$¥obeWøµî
(c⁄° *
aux
,

1326 
ch≠ãrNumbî
,

1327 
uöt64_t
 *
vútuÆCh≠ãrNumbî
,

1328 
byã
 *
buf„r
)

1330 c⁄° 
Vﬁume
 *
vﬁume
 = 
aux
;

1331 
ªsu…
 = 
	`¥obeCh≠ãr
(
vﬁume
, 
ch≠ãrNumbî
, 
vútuÆCh≠ãrNumbî
,

1332 
buf„r
);

1333 i‡((
ªsu…
 =
UDS_CORRUPT_COMPONENT
Ë|| (ªsu… =
UDS_CORRUPT_DATA
)) {

1334 *
vútuÆCh≠ãrNumbî
 = 
UINT64_MAX
;

1335  
UDS_SUCCESS
;

1337  
ªsu…
;

1338 
	}
}

1341 
	$födRólEndOfVﬁume
(c⁄° 
Vﬁume
 *
vﬁume
,

1342 
limô
,

1343 *
limôPå
)

1345 
byã
 *
buf„r
;

1346 
ªsu…
 = 
	`ALLOCATE_IO_ALIGNED
(
vﬁume
->
geomëry
->
byãsPîPage
, 
byã
,

1347 
__func__
, &
buf„r
);

1348 i‡(
ªsu…
 !
UDS_SUCCESS
) {

1349  
ªsu…
;

1357 
•™
 = 1;

1358 
åõs
 = 0;

1359 
limô
 > 0) {

1360 
ch≠ãr
 = (
•™
 > 
limô
) ? 0 :Üimit - span;

1361 
uöt64_t
 
v˙
 = 0;

1362 
ªsu…
 = 
	`¥obeCh≠ãr
(
vﬁume
, 
ch≠ãr
, &
v˙
, 
buf„r
);

1363 i‡(
ªsu…
 =
UDS_SUCCESS
) {

1364 i‡(
•™
 == 1) {

1367 
•™
 /= 2;

1368 
åõs
 = 0;

1369 } i‡(
ªsu…
 =
UDS_CORRUPT_COMPONENT
) {

1370 
limô
 = 
ch≠ãr
;

1371 i‡(++
åõs
 > 1) {

1372 
•™
 *= 2;

1375 
	`FREE
(
buf„r
);

1376  
	`logEº‹WôhSåögEº‹
(
ªsu…
, "cannot determineÉnd of volume");

1380 i‡(
limôPå
 !
NULL
) {

1381 *
limôPå
 = 
limô
;

1383 
	`FREE
(
buf„r
);

1384  
UDS_SUCCESS
;

1385 
	}
}

1388 
	$födVﬁumeCh≠ãrBound¨õs
(c⁄° 
Vﬁume
 *
vﬁume
,

1389 
uöt64_t
 *
lowe°VCN
,

1390 
uöt64_t
 *
highe°VCN
,

1391 
boﬁ
 *
isEm±y
)

1393 c⁄° 
Geomëry
 *
geomëry
 = 
vﬁume
->geometry;

1395 
off_t
 
vﬁSize
 = 0;

1397 
ªsu…
 = 
	`gëRegi⁄D©aSize
(
vﬁume
->
ªgi⁄
, &
vﬁSize
);

1398 i‡(
ªsu…
 !
UDS_SUCCESS
) {

1399  
ªsu…
;

1402 i‡(
vﬁSize
 < (
off_t
Ë(
geomëry
->
byãsPîPage
 + geomëry->
byãsPîCh≠ãr
)) {

1403 i‡(
vﬁSize
 =(
off_t
Ë(
geomëry
->
byãsPîPage
)) {

1404 *
lowe°VCN
 = 0;

1405 *
highe°VCN
 = 0;

1406 *
isEm±y
 = 
åue
;

1407  
UDS_SUCCESS
;

1410  
	`logEº‹WôhSåögEº‹
(
UDS_CORRUPT_COMPONENT
,

1411 "övÆid vﬁumêsizê(%" 
PRIu64
 " bytes)",

1412 (
uöt64_t
Ë
vﬁSize
);

1417 
ch≠ãrLimô
 = ()

1418 ((
vﬁSize
 - 
geomëry
->
byãsPîPage
Ë/ geomëry->
byãsPîCh≠ãr
);

1420 
	`logDebug
("vﬁumêsizê%" 
PRIu64
 " bytes, %u chapters",

1421 (
uöt64_t
Ë
vﬁSize
, 
ch≠ãrLimô
);

1423 i‡(
ch≠ãrLimô
 > 
geomëry
->
ch≠ãrsPîVﬁume
) {

1424 
	`logW¨nög
("excess chapters detected,ÉxpectedÇo moreÅhan %u",

1425 
geomëry
->
ch≠ãrsPîVﬁume
);

1426 
ch≠ãrLimô
 = 
geomëry
->
ch≠ãrsPîVﬁume
;

1429 
ªsu…
 = 
	`födRólEndOfVﬁume
(
vﬁume
, 
ch≠ãrLimô
, &chapterLimit);

1430 i‡(
ªsu…
 !
UDS_SUCCESS
) {

1431  
	`logEº‹WôhSåögEº‹
(
ªsu…
, "cannot findÉnd of volume");

1434 i‡(
ch≠ãrLimô
 == 0) {

1435 *
lowe°VCN
 = 0;

1436 *
highe°VCN
 = 0;

1437 *
isEm±y
 = 
åue
;

1438  
UDS_SUCCESS
;

1441 
byã
 *
buf„r
;

1442 
ªsu…
 = 
	`ALLOCATE_IO_ALIGNED
(
vﬁume
->
geomëry
->
byãsPîPage
, 
byã
, 
__func__
,

1443 &
buf„r
);

1444 i‡(
ªsu…
 !
UDS_SUCCESS
) {

1445  
ªsu…
;

1447 *
isEm±y
 = 
Ál£
;

1448 
ªsu…
 = 
	`födVﬁumeCh≠ãrBound¨õsIm∂
(
ch≠ãrLimô
, 
MAX_BAD_CHAPTERS
,

1449 
lowe°VCN
, 
highe°VCN
, 
¥obeWøµî
,

1450 
vﬁume
, 
buf„r
);

1451 
	`FREE
(
buf„r
);

1452  
ªsu…
;

1453 
	}
}

1456 
födVﬁumeCh≠ãrBound¨õsIm∂
(
ch≠ãrLimô
,

1457 
maxBadCh≠ãrs
,

1458 
uöt64_t
 *
lowe°VCN
,

1459 
uöt64_t
 *
highe°VCN
,

1460 (*
¥obeFunc
)(c⁄° *
aux
,

1461 
ch≠ãr
,

1462 
uöt64_t
 *
v˙
,

1463 
byã
 *
buf„r
),

1464 c⁄° *
aux
,

1465 
byã
 *
buf„r
)

1467 i‡(
ch≠ãrLimô
 == 0) {

1468 *
lowe°VCN
 = 0;

1469 *
highe°VCN
 = 0;

1470  
UDS_SUCCESS
;

1482 
uöt64_t
 
fú°VCN
 = 
UINT64_MAX
;

1485 
ªsu…
 = (*
¥obeFunc
)(
aux
, 0, &
fú°VCN
, 
buf„r
);

1486 i‡(
ªsu…
 !
UDS_SUCCESS
) {

1487  
UDS_SUCCESS
;

1498 
À·Ch≠ãr
 = 0;

1499 
rightCh≠ãr
 = 
ch≠ãrLimô
;

1501 
À·Ch≠ãr
 < 
rightCh≠ãr
) {

1502 
ch≠ãr
 = (
À·Ch≠ãr
 + 
rightCh≠ãr
) / 2;

1503 
uöt64_t
 
¥obeVCN
;

1505 
ªsu…
 = (*
¥obeFunc
)(
aux
, 
ch≠ãr
, &
¥obeVCN
, 
buf„r
);

1506 i‡(
ªsu…
 !
UDS_SUCCESS
) {

1507  
ªsu…
;

1509 i‡(
fú°VCN
 <
¥obeVCN
) {

1510 
À·Ch≠ãr
 = 
ch≠ãr
 + 1;

1512 
rightCh≠ãr
 = 
ch≠ãr
;

1516 
uöt64_t
 
lowe°
 = 
UINT64_MAX
;

1517 
uöt64_t
 
highe°
 = 
UINT64_MAX
;

1519 
ªsu…
 = 
	`ASSERT
(
À·Ch≠ãr
 =
rightCh≠ãr
, "leftChapter ==ÑightChapter");

1520 i‡(
ªsu…
 !
UDS_SUCCESS
) {

1521  
ªsu…
;

1524 
À·Ch≠ãr
 %
ch≠ãrLimô
;

1529 
ªsu…
 = (*
¥obeFunc
)(
aux
, 
À·Ch≠ãr
, &
lowe°
, 
buf„r
);

1530 i‡(
ªsu…
 !
UDS_SUCCESS
) {

1531  
ªsu…
;

1534 
ªsu…
 = 
	`ASSERT
((
lowe°
 !
UINT64_MAX
), "invalidÜowest chapter");

1535 i‡(
ªsu…
 !
UDS_SUCCESS
) {

1536  
ªsu…
;

1543 
badCh≠ãrs
 = 0;

1546 
rightCh≠ãr
 = (rightCh≠ã∏+ 
ch≠ãrLimô
 - 1) % chapterLimit;

1547 
ªsu…
 = (*
¥obeFunc
)(
aux
, 
rightCh≠ãr
, &
highe°
, 
buf„r
);

1548 i‡(
ªsu…
 !
UDS_SUCCESS
) {

1549  
ªsu…
;

1551 i‡(
highe°
 !
UINT64_MAX
) {

1554 i‡(++
badCh≠ãrs
 >
maxBadCh≠ãrs
) {

1555 
	`logEº‹
("toÿm™y bad ch≠ãr†ö vﬁume: %u", 
badCh≠ãrs
);

1556  
UDS_CORRUPT_COMPONENT
;

1560 *
lowe°VCN
 = 
lowe°
;

1561 *
highe°VCN
 = 
highe°
;

1562  
UDS_SUCCESS
;

1563 
	}
}

	@uds/volume.h

22 #i‚de‡
VOLUME_H


23 
	#VOLUME_H


	)

25 
	~"ˇcheCou¡îs.h
"

26 
	~"comm⁄.h
"

27 
	~"ch≠ãrIndex.h
"

28 
	~"ödexC⁄fig.h
"

29 
	~"ödexLayout.h
"

30 
	~"ödexPageM≠.h
"

31 
	~"ioRegi⁄.h
"

32 
	~"∑geCache.h
"

33 
	~"ªque°.h
"

34 
	~"•¨£Cache.h
"

35 
	~"uds.h
"

36 
	~"utû/ødixS‹t.h
"

39 
	mMAX_VOLUME_READ_THREADS
 = 16

43 
	mREADER_STATE_RUN
 = 1,

44 
	mREADER_STATE_EXIT
 = 2,

45 
	mREADER_STATE_STOP
 = 4

46 } 
	tRódîSèã
;

48 
	eödexLookupMode
 {

50 
	mLOOKUP_NORMAL
,

58 
	mLOOKUP_CURRENT_CHAPTER_ONLY
,

63 
	mLOOKUP_FOR_REBUILD


64 } 
	tIndexLookupMode
;

66 
	svﬁume
 {

68 
Geomëry
 *
	mgeomëry
;

70 
C⁄figuøti⁄
 *
	mc⁄fig
;

72 
IORegi⁄
 *
	mªgi⁄
;

74 
boﬁ
 
	mªadO∆y
;

76 
off_t
 
	mvﬁumeSize
;

78 
uöt64_t
 
	mn⁄˚
;

80 
byã
 *
	ms¸©chPage
;

82 c⁄° 
UdsChunkRec‹d
 **
	mªc‹dPoöãrs
;

84 
RadixS‹ãr
 *
	mødixS‹ãr
;

86 
S∑r£Cache
 *
	m•¨£Cache
;

88 
PageCache
 *
	m∑geCache
;

90 
IndexPageM≠
 *
	mödexPageM≠
;

92 
Muãx
 
	mªadThªadsMuãx
;

94 
C⁄dV¨
 
	mªadThªadsC⁄d
;

96 
C⁄dV¨
 
	mªadThªadsRódD⁄eC⁄d
;

98 
Thªad
 *
	mªadîThªads
;

100 
	mbusyRódîThªads
;

102 
RódîSèã
 
	mªadîSèã
;

104 
IndexLookupMode
 
	mlookupMode
;

106 
	mnumRódThªads
;

107 } 
	tVﬁume
;

121 
	$makeVﬁume
(c⁄° 
C⁄figuøti⁄
 *
c⁄fig
,

122 
IndexLayout
 *
œyout
,

123 
ödexId
,

124 
ªadQueueMaxSize
,

125 
z⁄eCou¡
,

126 
Vﬁume
 **
√wVﬁume
)

127 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

134 
	`‰ìVﬁume
(
Vﬁume
 *
vﬁume
);

143 
	$˛o£Vﬁume
(
Vﬁume
 *
vﬁume
)

144 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

155 
	$íqueuePageRód
(
Vﬁume
 *
vﬁume
, 
Reque°
 *
ªque°
, 
physiˇlPage
)

156 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

166 
	`¸óãRódîThªads
(
Vﬁume
 *
vﬁume
, 
numRódîThªads
);

173 
	`de°royRódîThªads
(
Vﬁume
 *
vﬁume
);

183 
	$f‹m©Vﬁume
(
IORegi⁄
 *
ªgi⁄
, c⁄° 
Geomëry
 *
geomëry
)

184 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

210 
	$födVﬁumeCh≠ãrBound¨õs
(c⁄° 
Vﬁume
 *
vﬁume
,

211 
uöt64_t
 *
lowe°VCN
,

212 
uöt64_t
 *
highe°VCN
,

213 
boﬁ
 *
isEm±y
)

214 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

231 
	$£¨chVﬁume
(
Vﬁume
 *
vﬁume
,

232 
Reque°
 *
ªque°
,

233 c⁄° 
UdsChunkName
 *
«me
,

234 
uöt64_t
 
vútuÆCh≠ãr
,

235 
boﬁ
 
isS∑r£
,

236 
UdsChunkD©a
 *
mëad©a
,

237 
boﬁ
 *
found
)

238 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

253 
	$£¨chVﬁumeS∑r£Cache
(
Vﬁume
 *
vﬁume
,

254 
Reque°
 *
ªque°
,

255 
uöt64_t
 
vútuÆCh≠ãr
,

256 
boﬁ
 *
found
)

257 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

269 
	$f‹gëCh≠ãr
(
Vﬁume
 *
vﬁume
,

270 
uöt64_t
 
ch≠ãr
,

271 
InvÆid©i⁄Rós⁄
 
ªas⁄
)

272 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

280 
	`upd©eVﬁumeSize
(
Vﬁume
 *
vﬁume
, 
off_t
 
size
);

294 
	$wrôeIndexPages
(
Vﬁume
 *
vﬁume
,

295 
off_t
 
ch≠ãrOff£t
,

296 
O≥nCh≠ãrIndex
 *
ch≠ãrIndex
,

297 
byã
 **
∑ges
)

298 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

312 
	$wrôeRec‹dPages
(
Vﬁume
 *
vﬁume
,

313 
off_t
 
ch≠ãrOff£t
,

314 c⁄° 
UdsChunkRec‹d
 
ªc‹ds
[],

315 
byã
 **
∑ges
)

316 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

328 
	$wrôeCh≠ãr
(
Vﬁume
 *
vﬁume
,

329 
O≥nCh≠ãrIndex
 *
ch≠ãrIndex
,

330 c⁄° 
UdsChunkRec‹d
 
ªc‹ds
[])

331 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

342 
	$ªadPageFromVﬁume
(
Vﬁume
 *
vﬁume
,

343 
physiˇlPage
,

344 
CachedPage
 *
íåy
)

345 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

358 
	$ªadCh≠ãrIndexFromVﬁume
(c⁄° 
Vﬁume
 *
vﬁume
,

359 
uöt64_t
 
vútuÆCh≠ãr
,

360 
byã
 
∑geD©a
[],

361 
Ch≠ãrIndexPage
 
ödexPages
[])

362 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

385 
	$gëPageLocked
(
Vﬁume
 *
vﬁume
,

386 
Reque°
 *
ªque°
,

387 
physiˇlPage
,

388 
CacheProbeTy≥
 
¥obeTy≥
,

389 
CachedPage
 **
íåyPå
)

390 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

417 
	$gëPagePrŸe˘ed
(
Vﬁume
 *
vﬁume
,

418 
Reque°
 *
ªque°
,

419 
physiˇlPage
,

420 
CacheProbeTy≥
 
¥obeTy≥
,

421 
CachedPage
 **
íåyPå
)

422 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

450 
	$gëPage
(
Vﬁume
 *
vﬁume
,

451 
Reque°
 *
ªque°
,

452 
ch≠ãr
,

453 
∑geNumbî
,

454 
CacheProbeTy≥
 
¥obeTy≥
,

455 
byã
 **
∑gePå
)

456 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

459 
size_t
 
	$gëCacheSize
(
Vﬁume
 *
vﬁume
Ë
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

462 
off_t
 
	$gëVﬁumeSize
(
Vﬁume
 *
vﬁume
Ë
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

465 
off_t
 
	$off£tF‹Ch≠ãr
(c⁄° 
Geomëry
 *
geomëry
,

466 
ch≠ãr
)

467 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

470 
	`gëCacheCou¡îs
(
Vﬁume
 *
vﬁume
, 
CacheCou¡îs
 *
cou¡îs
);

473 
	`födVﬁumeCh≠ãrBound¨õsIm∂
(
ch≠ãrLimô
,

474 
maxBadCh≠ãrs
,

475 
uöt64_t
 *
lowe°VCN
,

476 
uöt64_t
 *
highe°VCN
,

477 (*
¥obeFunc
)(c⁄° *
aux
,

478 
ch≠ãr
,

479 
uöt64_t
 *
v˙
,

480 
byã
 *
buf„r
),

481 c⁄° *
aux
,

482 
byã
 *
buf„r
)

483 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

	@uds/volumeInternals.c

22 
	~"vﬁumeI¡î«ls.h
"

24 
	~"buf„ªdRódî.h
"

25 
	~"îr‹s.h
"

26 
	~"hashUtûs.h
"

27 
	~"ödexC⁄fig.h
"

28 
	~"loggî.h
"

29 
	~"mem‹yAŒoc.h
"

30 
	~"ªc‹dPage.h
"

31 
	~"°rögUtûs.h
"

32 
	~"vﬁume.h
"

35 c⁄° 
byã
 
	gVOLUME_MAGIC_NUMBER
[] = "ALBV";

36 c⁄° 
byã
 
	gVOLUME_VERSION
[] = "04.20";

37 c⁄° 
byã
 
	gVOLUME_VERSION_V4_10
[] = "04.10";

38 c⁄° 
byã
 
	gVOLUME_VERSION_V4
[] = "04.00";

39 c⁄° 
byã
 
	gVOLUME_VERSION_V3
[] = "00227";

40 c⁄° 
	gVOLUME_MAGIC_LENGTH
 = (
VOLUME_MAGIC_NUMBER
) - 1;

41 c⁄° 
	gVOLUME_VERSION_LENGTH
 = (
VOLUME_VERSION
) - 1;

43 c⁄° 
boﬁ
 
	gREAD_ONLY_VOLUME
 = 
åue
;

45 
ªadGeomëryV4_10
(
Buf„ªdRódî
 *
ªadî
, 
Vﬁume
 *
vﬁume
);

46 
ªadGeomëryV4
(
Buf„ªdRódî
 *
ªadî
, 
Vﬁume
 *
vﬁume
);

49 
size_t
 
	$ícodeVﬁumeF‹m©
(
byã
 *
vﬁumeF‹m©
, c⁄° 
Geomëry
 *
geomëry
)

51 
size
 = 0;

52 
	`mem˝y
(
vﬁumeF‹m©
, 
VOLUME_MAGIC_NUMBER
, 
VOLUME_MAGIC_LENGTH
);

53 
size
 +
VOLUME_MAGIC_LENGTH
;

55 
	`mem˝y
(
vﬁumeF‹m©
 + 
size
, 
VOLUME_VERSION
, 
VOLUME_VERSION_LENGTH
);

56 
size
 +
VOLUME_VERSION_LENGTH
;

58 i‡(
geomëry
) {

59 
	`mem˝y
(
vﬁumeF‹m©
 + 
size
, 
geomëry
, (
Geomëry
));

60 
size
 +(
Geomëry
);

63  
size
;

64 
	}
}

74 
	$ªadGeomëry
(
Buf„ªdRódî
 *
ªadî
, 
Vﬁume
 *
vﬁume
)

76 
ªsu…
 = 
	`ALLOCATE
(1, 
Geomëry
, "geomëry", &
vﬁume
->
geomëry
);

77 i‡(
ªsu…
 !
UDS_SUCCESS
) {

78  
ªsu…
;

80 
	`mem£t
(
vﬁume
->
geomëry
, 0, (
Geomëry
));

81  
	`ªadFromBuf„ªdRódî
(
ªadî
, 
vﬁume
->
geomëry
, (
Geomëry
));

82 
	}
}

92 
	$ªadVîsi⁄Numbî
(
Buf„ªdRódî
 *
ªadî
, 
byã
 *
vîsi⁄Numbî
)

94 
ªsu…
 =

95 
	`vîifyBuf„ªdD©a
(
ªadî
, 
VOLUME_MAGIC_NUMBER
, 
VOLUME_MAGIC_LENGTH
);

96 i‡(
ªsu…
 !
UDS_SUCCESS
) {

97  
ªsu…
;

100 
ªsu…
 = 
	`ªadFromBuf„ªdRódî
(
ªadî
, 
vîsi⁄Numbî
, 
VOLUME_VERSION_LENGTH
);

101 i‡(
ªsu…
 !
UDS_SUCCESS
) {

102  
ªsu…
;

105  
UDS_SUCCESS
;

106 
	}
}

109 
boﬁ
 
	$isVîsi⁄
(
byã
 *
vîsi⁄Numbî
, c⁄° byã *
ex≥˘edVîsi⁄Numbî
)

112 
	`memcmp
(
vîsi⁄Numbî
, 
ex≥˘edVîsi⁄Numbî
, 
VOLUME_VERSION_LENGTH
) == 0;

113 
	}
}

116 
__©åibuã__
((
w¨n_unu£d_ªsu…
))

117 
	$›íVﬁume
(
Vﬁume
 *
vﬁume
)

119 
Buf„ªdRódî
 *
ªadî
 = 
NULL
;

120 
ªsu…
 = 
	`makeBuf„ªdRódî
(
vﬁume
->
ªgi⁄
, &
ªadî
);

121 i‡(
ªsu…
 !
UDS_SUCCESS
) {

122  
ªsu…
;

125 
byã
 
vîsi⁄Numbî
[
VOLUME_VERSION_LENGTH
];

126 
ªsu…
 = 
	`ªadVîsi⁄Numbî
(
ªadî
, 
vîsi⁄Numbî
);

127 i‡(
ªsu…
 !
UDS_SUCCESS
) {

128 
	`‰ìBuf„ªdRódî
(
ªadî
);

129  
ªsu…
;

132 
ªsu…
 = 
UDS_UNSUPPORTED_VERSION
;

133 i‡(
	`isVîsi⁄
(
vîsi⁄Numbî
, 
VOLUME_VERSION
)) {

134 
ªsu…
 = 
	`ªadGeomëry
(
ªadî
, 
vﬁume
);

135 } i‡(
	`isVîsi⁄
(
vîsi⁄Numbî
, 
VOLUME_VERSION_V4_10
)) {

136 i‡(
vﬁume
->
ªadO∆y
) {

137 
	`logW¨nög
("opening obsolete volume version v4.10 forÑeading");

138 
ªsu…
 = 
	`ªadGeomëryV4_10
(
ªadî
, 
vﬁume
);

140 } i‡(
	`isVîsi⁄
(
vîsi⁄Numbî
, 
VOLUME_VERSION_V4
)) {

141 i‡(
vﬁume
->
ªadO∆y
) {

142 
	`logW¨nög
("opening obsolete volume version v4.00 forÑeading");

143 
ªsu…
 = 
	`ªadGeomëryV4
(
ªadî
, 
vﬁume
);

145 } i‡(
	`isVîsi⁄
(
vîsi⁄Numbî
, 
VOLUME_VERSION_V3
)) {

146 i‡(
vﬁume
->
ªadO∆y
) {

147 
	`logW¨nög
("opening obsolete volume version v3 forÑeading");

148 
ªsu…
 = 
	`ªadGeomëryV4
(
ªadî
, 
vﬁume
);

152 i‡(
ªsu…
 !
UDS_SUCCESS
) {

153 
	`‰ìBuf„ªdRódî
(
ªadî
);

154  
	`logEº‹WôhSåögEº‹
(
UDS_UNSUPPORTED_VERSION
,

158 
	`‰ìBuf„ªdRódî
(
ªadî
);

159  
UDS_SUCCESS
;

160 
	}
}

163 
	$ÆloˇãVﬁume
(c⁄° 
C⁄figuøti⁄
 *
c⁄fig
,

164 
IndexLayout
 *
œyout
,

165 
ödexId
,

166 
ªadQueueMaxSize
,

167 
z⁄eCou¡
,

168 
boﬁ
 
ªadO∆y
,

169 
Vﬁume
 **
√wVﬁume
)

171 
IOAc˚ssMode
 
ac˚ss
 = 
ªadO∆y
 ? 
IO_READ
 : 
IO_READ_WRITE
;

172 
IORegi⁄
 *
ªgi⁄
;

173 
ªsu…
 = 
	`›íVﬁumeRegi⁄
(
œyout
, 
ödexId
, 
ac˚ss
, &
ªgi⁄
);

174 i‡(
ªsu…
 !
UDS_SUCCESS
) {

175  
ªsu…
;

178 
Vﬁume
 *
vﬁume
;

179 
ªsu…
 = 
	`ALLOCATE
(1, 
Vﬁume
, "vﬁume", &
vﬁume
);

180 i‡(
ªsu…
 !
UDS_SUCCESS
) {

181 
	`˛o£IORegi⁄
(&
ªgi⁄
);

182  
ªsu…
;

185 
vﬁume
->
ªgi⁄
 =Ñegion;

186 
vﬁume
->
ªadO∆y
 =ÑeadOnly;

188 
ªsu…
 = 
	`gëVﬁumeN⁄˚
(
œyout
, 
ödexId
, &
vﬁume
->
n⁄˚
);

189 i‡(
ªsu…
 !
UDS_SUCCESS
) {

190 
	`ªÀa£Vﬁume
(
vﬁume
);

191  
ªsu…
;

194 
ªsu…
 = 
	`›íVﬁume
(
vﬁume
);

195 i‡(
ªsu…
 !
UDS_SUCCESS
) {

196 
	`ªÀa£Vﬁume
(
vﬁume
);

197  
ªsu…
;

200 i‡(
vﬁume
->
geomëry
 =
NULL
) {

201 
ªsu…
 = 
	`c›yGeomëry
(
c⁄fig
->
geomëry
, &
vﬁume
->geometry);

202 i‡(
ªsu…
 !
UDS_SUCCESS
) {

203 
	`ªÀa£Vﬁume
(
vﬁume
);

204  
	`logW¨nögWôhSåögEº‹
(

205 
ªsu…
, "failedÅoállocate geometry:Érror");

208 i‡(!
ªadO∆y
 && !
	`vîifyGeomëry
(
c⁄fig
->
geomëry
, 
vﬁume
->geometry)) {

209 
	`ªÀa£Vﬁume
(
vﬁume
);

210  
	`logW¨nögWôhSåögEº‹
(

211 
UDS_CORRUPT_COMPONENT
, "configánd volume geometriesáre inconsistent");

215 
ªsu…
 = 
	`ALLOCATE_IO_ALIGNED
(
c⁄fig
->
geomëry
->
byãsPîPage
, 
byã
,

216 "s¸©chÖage", &
vﬁume
->
s¸©chPage
);

217 i‡(
ªsu…
 !
UDS_SUCCESS
) {

218 
	`ªÀa£Vﬁume
(
vﬁume
);

219  
ªsu…
;

221 
ªsu…
 = 
	`makeRadixS‹ãr
(
c⁄fig
->
geomëry
->
ªc‹dsPîPage
,

222 &
vﬁume
->
ødixS‹ãr
);

223 i‡(
ªsu…
 !
UDS_SUCCESS
) {

224 
	`ªÀa£Vﬁume
(
vﬁume
);

225  
ªsu…
;

227 
ªsu…
 = 
	`ALLOCATE
(
c⁄fig
->
geomëry
->
ªc‹dsPîPage
, c⁄° 
UdsChunkRec‹d
 *,

228 "ªc‹dÖoöãrs", &
vﬁume
->
ªc‹dPoöãrs
);

229 i‡(
ªsu…
 !
UDS_SUCCESS
) {

230 
	`ªÀa£Vﬁume
(
vﬁume
);

231  
ªsu…
;

234 i‡(!
ªadO∆y
) {

235 
ªsu…
 = 
	`makeS∑r£Cache
(
vﬁume
->
geomëry
, 
c⁄fig
->
ˇcheCh≠ãrs
,

236 
z⁄eCou¡
, &
vﬁume
->
•¨£Cache
);

237 i‡(
ªsu…
 !
UDS_SUCCESS
) {

238 
	`ªÀa£Vﬁume
(
vﬁume
);

239  
ªsu…
;

241 
ªsu…
 = 
	`makePageCache
(
vﬁume
->
geomëry
, 
c⁄fig
->
ˇcheCh≠ãrs
,

242 
ªadQueueMaxSize
, 
z⁄eCou¡
, &
vﬁume
->
∑geCache
);

243 i‡(
ªsu…
 !
UDS_SUCCESS
) {

244 
	`ªÀa£Vﬁume
(
vﬁume
);

245  
ªsu…
;

247 
ªsu…
 = 
	`makeIndexPageM≠
(
vﬁume
->
geomëry
, &vﬁume->
ödexPageM≠
);

248 i‡(
ªsu…
 !
UDS_SUCCESS
) {

249 
	`ªÀa£Vﬁume
(
vﬁume
);

250  
ªsu…
;

254 *
√wVﬁume
 = 
vﬁume
;

255  
UDS_SUCCESS
;

256 
	}
}

259 
	$ªÀa£Vﬁume
(
Vﬁume
 *
vﬁume
)

261 i‡(
vﬁume
 =
NULL
) {

264 
ªsu…
 = 
	`d⁄eWôhVﬁume
(
vﬁume
);

265 i‡(
ªsu…
 !
UDS_SUCCESS
) {

266 
	`logEº‹WôhSåögEº‹
(
ªsu…
, "error closing volume,Ñeleasingányway");

268 
	`‰ìIndexPageM≠
(
vﬁume
->
ödexPageM≠
);

269 
	`‰ìPageCache
(
vﬁume
->
∑geCache
);

270 
	`‰ìRadixS‹ãr
(
vﬁume
->
ødixS‹ãr
);

271 
	`‰ìS∑r£Cache
(
vﬁume
->
•¨£Cache
);

272 
	`FREE
(
vﬁume
->
geomëry
);

273 
	`FREE
(
vﬁume
->
ªc‹dPoöãrs
);

274 
	`FREE
(
vﬁume
->
s¸©chPage
);

275 
	`FREE
(
vﬁume
);

276 
	}
}

279 
	$d⁄eWôhVﬁume
(
Vﬁume
 *
vﬁume
)

281 i‡(
vﬁume
->
ªgi⁄
 !
NULL
) {

282  
	`syncAndClo£Regi⁄
(&
vﬁume
->
ªgi⁄
, "index volume");

284  
UDS_SUCCESS
;

285 
	}
}

288 
ölöe
 
	$m≠ToPhysiˇlPage
(
Geomëry
 *
geomëry
,

289 
ch≠ãr
,

290 
∑ge
)

294  (1 + (
geomëry
->
∑gesPîCh≠ãr
 * 
ch≠ãr
Ë+ 
∑ge
);

295 
	}
}

298 
	$ªadPageToBuf„r
(c⁄° 
Vﬁume
 *
vﬁume
,

299 
physiˇlPage
,

300 
byã
 *
buf„r
)

302 
off_t
 
∑geOff£t


303 ((
off_t
Ë
physiˇlPage
Ë* ((off_tË
vﬁume
->
geomëry
->
byãsPîPage
);

304 
ªsu…
 = 
	`ªadFromRegi⁄
(
vﬁume
->
ªgi⁄
, 
∑geOff£t
, 
buf„r
,

305 
vﬁume
->
geomëry
->
byãsPîPage
, 
NULL
);

306 i‡(
ªsu…
 !
UDS_SUCCESS
) {

307  
	`logW¨nögWôhSåögEº‹
(
ªsu…
,

309 
physiˇlPage
);

311  
UDS_SUCCESS
;

312 
	}
}

315 
	$ªadCh≠ãrIndexToBuf„r
(c⁄° 
Vﬁume
 *
vﬁume
,

316 
ch≠ãrNumbî
,

317 
byã
 *
buf„r
)

319 
Geomëry
 *
geomëry
 = 
vﬁume
->geometry;

320 
off_t
 
ch≠ãrIndexOff£t
 = 
	`off£tF‹Ch≠ãr
(
geomëry
, 
ch≠ãrNumbî
);

321 
ªsu…
 = 
	`ªadFromRegi⁄
(
vﬁume
->
ªgi⁄
, 
ch≠ãrIndexOff£t
, 
buf„r
,

322 
geomëry
->
byãsPîPage
 *

323 
geomëry
->
ödexPagesPîCh≠ãr
, 
NULL
);

324 i‡(
ªsu…
 !
UDS_SUCCESS
) {

325  
	`logW¨nögWôhSåögEº‹
(
ªsu…
,

327 
ch≠ãrNumbî
);

329  
UDS_SUCCESS
;

330 
	}
}

335 
	sgeomëry_V4_10
 {

337 
size_t
 
	mbyãsPîPage
;

339 
	mªc‹dPagesPîCh≠ãr
;

341 
	mch≠ãrsPîVﬁume
;

343 
	m•¨£Ch≠ãrsPîVﬁume
;

345 
	mch≠ãrDñèLi°Bôs
;

347 
	m∑gesPîVﬁume
;

349 
size_t
 
	mbyãsPîVﬁume
;

351 
size_t
 
	mbyãsPîCh≠ãr
;

353 
	m∑gesPîCh≠ãr
;

355 
	mödexPagesPîCh≠ãr
;

357 
	m›íCh≠ãrLﬂdR©io
;

359 
	mªc‹dsPîPage
;

361 
	mªc‹dsPîCh≠ãr
;

363 
uöt64_t
 
	mªc‹dsPîVﬁume
;

365 
	mªc‹dPageOff£t
;

367 
	mdñèLi°sPîCh≠ãr
;

369 
	mch≠ãrMónDñè
;

371 
	mch≠ãrPaylﬂdBôs
;

373 
	mch≠ãrAddªssBôs
;

375 
	mdí£Ch≠ãrsPîVﬁume
;

376 } 
	tGeomëryV4_10
;

378 
	$c⁄vîtGeomëryV4_10
(
Geomëry
 *
d°
, c⁄° 
GeomëryV4_10
 *
§c
)

380 
d°
->
byãsPîPage
 = 
§c
->bytesPerPage;

381 
d°
->
ªc‹dPagesPîCh≠ãr
 = 
§c
->recordPagesPerChapter;

382 
d°
->
ch≠ãrsPîVﬁume
 = 
§c
->chaptersPerVolume;

383 
d°
->
•¨£Ch≠ãrsPîVﬁume
 = 
§c
->sparseChaptersPerVolume;

384 
d°
->
ch≠ãrDñèLi°Bôs
 = 
§c
->chapterDeltaListBits;

385 
d°
->
∑gesPîVﬁume
 = 
§c
->pagesPerVolume;

386 
d°
->
hódîPagesPîVﬁume
 = 1;

387 
d°
->
byãsPîVﬁume
 = 
§c
->byãsPîVﬁumê+ src->
byãsPîPage
;

388 
d°
->
byãsPîCh≠ãr
 = 
§c
->bytesPerChapter;

389 
d°
->
∑gesPîCh≠ãr
 = 
§c
->pagesPerChapter;

390 
d°
->
ödexPagesPîCh≠ãr
 = 
§c
->indexPagesPerChapter;

391 
d°
->
›íCh≠ãrLﬂdR©io
 = 
§c
->openChapterLoadRatio;

392 
d°
->
ªc‹dsPîPage
 = 
§c
->recordsPerPage;

393 
d°
->
ªc‹dsPîCh≠ãr
 = 
§c
->recordsPerChapter;

394 
d°
->
ªc‹dsPîVﬁume
 = 
§c
->recordsPerVolume;

395 
d°
->
ªc‹dPageOff£t
 = 
§c
->recordPageOffset;

396 
d°
->
dñèLi°sPîCh≠ãr
 = 
§c
->deltaListsPerChapter;

397 
d°
->
ch≠ãrMónDñè
 = 
§c
->chapterMeanDelta;

398 
d°
->
ch≠ãrPaylﬂdBôs
 = 
§c
->chapterPayloadBits;

399 
d°
->
ch≠ãrAddªssBôs
 = 
§c
->chapterAddressBits;

400 
d°
->
dí£Ch≠ãrsPîVﬁume
 = 
§c
->denseChaptersPerVolume;

401 
	}
}

406 
	sgeomëryV4
 {

408 
	mbyãsPîPage
;

410 
	mªc‹dPagesPîCh≠ãr
;

412 
	mch≠ãrsPîVﬁume
;

414 
	m•¨£Ch≠ãrsPîVﬁume
;

416 
	mch≠ãrMónDñèBôs
;

418 
	mch≠ãrDñèLi°Bôs
;

422 
	m∑gesPîVﬁume
;

424 
uöt64_t
 
	mbyãsPîVﬁume
;

426 
uöt64_t
 
	mbyãsPîCh≠ãr
;

428 
	m∑gesPîCh≠ãr
;

430 
	mödexPagesPîCh≠ãr
;

432 
	mödexSlŸsPîCh≠ãr
;

434 
	m¶ŸsPîIndexPage
;

436 
	mªc‹dsPîPage
;

438 
	mªc‹dsPîCh≠ãr
;

440 
uöt64_t
 
	mªc‹dsPîVﬁume
;

442 
	mªc‹dPageOff£t
;

444 
	mdñèLi°sPîCh≠ãr
;

446 
	mch≠ãrMónDñè
;

448 
	mch≠ãrPaylﬂdBôs
;

450 
	mch≠ãrAddªssBôs
;

452 
	mdí£Ch≠ãrsPîVﬁume
;

453 } 
	tGeomëryV4
;

455 
	$c⁄vîtGeomëryV4
(
Geomëry
 *
d°
, c⁄° 
GeomëryV4
 *
§c
)

457 
d°
->
byãsPîPage
 = 
§c
->bytesPerPage;

458 
d°
->
ªc‹dPagesPîCh≠ãr
 = 
§c
->recordPagesPerChapter;

459 
d°
->
ch≠ãrsPîVﬁume
 = 
§c
->chaptersPerVolume;

460 
d°
->
•¨£Ch≠ãrsPîVﬁume
 = 
§c
->sparseChaptersPerVolume;

461 
d°
->
ch≠ãrDñèLi°Bôs
 = 
§c
->chapterDeltaListBits;

462 
d°
->
∑gesPîVﬁume
 = 
§c
->pagesPerVolume;

463 
d°
->
hódîPagesPîVﬁume
 = 1;

464 
d°
->
byãsPîVﬁume
 = 
§c
->byãsPîVﬁumê+ src->
byãsPîPage
;

465 
d°
->
byãsPîCh≠ãr
 = 
§c
->bytesPerChapter;

466 
d°
->
∑gesPîCh≠ãr
 = 
§c
->pagesPerChapter;

467 
d°
->
ödexPagesPîCh≠ãr
 = 
§c
->indexPagesPerChapter;

468 
d°
->
›íCh≠ãrLﬂdR©io
 = 
DEFAULT_OPEN_CHAPTER_LOAD_RATIO
;

469 
d°
->
ªc‹dsPîPage
 = 
§c
->recordsPerPage;

470 
d°
->
ªc‹dsPîCh≠ãr
 = 
§c
->recordsPerChapter;

471 
d°
->
ªc‹dsPîVﬁume
 = 
§c
->recordsPerVolume;

472 
d°
->
ªc‹dPageOff£t
 = 
§c
->recordPageOffset;

473 
d°
->
dñèLi°sPîCh≠ãr
 = 
§c
->deltaListsPerChapter;

474 
d°
->
ch≠ãrMónDñè
 = 
§c
->chapterMeanDelta;

475 
d°
->
ch≠ãrPaylﬂdBôs
 = 
§c
->chapterPayloadBits;

476 
d°
->
ch≠ãrAddªssBôs
 = 
§c
->chapterAddressBits;

477 
d°
->
dí£Ch≠ãrsPîVﬁume
 = 
§c
->denseChaptersPerVolume;

478 
	}
}

488 
	$ªadGeomëryV4_10
(
Buf„ªdRódî
 *
ªadî
, 
Vﬁume
 *
vﬁume
)

490 
ªsu…
 = 
	`ALLOCATE
(1, 
Geomëry
, "geomëry", &
vﬁume
->
geomëry
);

491 i‡(
ªsu…
 !
UDS_SUCCESS
) {

492  
ªsu…
;

495 
GeomëryV4_10
 
ﬁdGeomëry
;

496 
	`mem£t
(&
ﬁdGeomëry
, 0, (oldGeometry));

497 
ªsu…
 = 
	`ªadFromBuf„ªdRódî
(
ªadî
, &
ﬁdGeomëry
, (oldGeometry));

498 i‡(
ªsu…
 !
UDS_SUCCESS
) {

499  
ªsu…
;

502 
	`mem£t
(
vﬁume
->
geomëry
, 0, (
Geomëry
));

503 
	`c⁄vîtGeomëryV4_10
(
vﬁume
->
geomëry
, &
ﬁdGeomëry
);

504  
UDS_SUCCESS
;

505 
	}
}

515 
	$ªadGeomëryV4
(
Buf„ªdRódî
 *
ªadî
, 
Vﬁume
 *
vﬁume
)

517 
ªsu…
 = 
	`ALLOCATE
(1, 
Geomëry
, "geomëry", &
vﬁume
->
geomëry
);

518 i‡(
ªsu…
 !
UDS_SUCCESS
) {

519  
ªsu…
;

522 
GeomëryV4
 
geomëryV4
;

523 
	`mem£t
(&
geomëryV4
, 0, (
GeomëryV4
));

524 
ªsu…
 = 
	`ªadFromBuf„ªdRódî
(
ªadî
, &
geomëryV4
, (
GeomëryV4
));

525 i‡(
ªsu…
 !
UDS_SUCCESS
) {

526  
ªsu…
;

529 
	`mem£t
(
vﬁume
->
geomëry
, 0, (
Geomëry
));

530 
	`c⁄vîtGeomëryV4
(
vﬁume
->
geomëry
, &
geomëryV4
);

531  
UDS_SUCCESS
;

532 
	}
}

	@uds/volumeInternals.h

22 #i‚de‡
VOLUME_INTERNALS_H


23 
	#VOLUME_INTERNALS_H


	)

25 
	~"vﬁume.h
"

28 c⁄° 
byã
 
VOLUME_MAGIC_NUMBER
[];

29 c⁄° 
byã
 
VOLUME_VERSION
[];

31 c⁄° 
VOLUME_MAGIC_LENGTH
;

32 c⁄° 
VOLUME_VERSION_LENGTH
;

34 c⁄° 
boﬁ
 
READ_ONLY_VOLUME
;

44 
size_t
 
	$ícodeVﬁumeF‹m©
(
byã
 *
vﬁumeF‹m©
, c⁄° 
Geomëry
 *
geomëry
)

45 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

61 
	$ÆloˇãVﬁume
(c⁄° 
C⁄figuøti⁄
 *
c⁄fig
,

62 
IndexLayout
 *
œyout
,

63 
ödexId
,

64 
ªadQueueMaxSize
,

65 
z⁄eCou¡
,

66 
boﬁ
 
ªadO∆y
,

67 
Vﬁume
 **
√wVﬁume
)

68 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

75 
	`ªÀa£Vﬁume
(
Vﬁume
 *
vﬁume
);

84 
	$d⁄eWôhVﬁume
(
Vﬁume
 *
vﬁume
Ë
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

95 
	$m≠ToPhysiˇlPage
(
Geomëry
 *
geomëry
, 
ch≠ãr
, 
∑ge
)

96 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

107 
	$ªadPageToBuf„r
(c⁄° 
Vﬁume
 *
vﬁume
,

108 
physiˇlPage
,

109 
byã
 *
buf„r
)

110 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

121 
	$ªadCh≠ãrIndexToBuf„r
(c⁄° 
Vﬁume
 *
vﬁume
,

122 
ch≠ãrNumbî
,

123 
byã
 *
buf„r
)

124 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

	@uds/zone.c

22 
	~"z⁄e.h
"

24 
	~"„©uªDefs.h
"

25 
	~"loggî.h
"

26 
	~"∑ømëî.h
"

27 
	~"≥rmas£π.h
"

28 
	~"°rögUtûs.h
"

29 
	~"thªads.h
"

31 c⁄° 
NumîicVÆid©i⁄D©a
 
	gvÆidR™ge
 = {

32 .
möVÆue
 = 1,

33 .
	gmaxVÆue
 = 
MAX_ZONES
,

37 
	$gëDeÁu…Z⁄eCou¡
()

39 
z⁄eCou¡
 = 
	`gëNumC‹es
();

40 i‡(
z⁄eCou¡
 < 
vÆidR™ge
.
möVÆue
) {

41 
z⁄eCou¡
 = 
vÆidR™ge
.
möVÆue
;

43 i‡(
z⁄eCou¡
 > 
vÆidR™ge
.
maxVÆue
) {

44 
z⁄eCou¡
 = 
vÆidR™ge
.
maxVÆue
;

46  
z⁄eCou¡
;

47 
	}
}

50 
UdsP¨amëîVÆue
 
	$gëZ⁄eCou¡InôülVÆue
()

52 
UdsP¨amëîVÆue
 
vÆue
;

54 #i‡
ENVIRONMENT


55 *
ív
 = 
	`gëív
(
UDS_PARALLEL_FACTOR
);

56 i‡(
ív
 !
NULL
) {

57 
UdsP¨amëîVÆue
 
tmp
 = {

58 .
ty≥
 = 
UDS_PARAM_TYPE_STRING
,

59 .
vÆue
.
u_°rög
 = *
ív
 ?Énv : "true",

61 i‡(
	`vÆid©eNumîicR™ge
(&
tmp
, &
vÆidR™ge
, &
vÆue
Ë=
UDS_SUCCESS
) {

62  
vÆue
;

67 
vÆue
.
ty≥
 = 
UDS_PARAM_TYPE_UNSIGNED_INT
;

68 
vÆue
.vÆue.
u_uöt
 = 
	`gëDeÁu…Z⁄eCou¡
();

69  
vÆue
;

70 
	}
}

73 
	$deföeP¨ÆÀlFa˘‹
(
P¨amëîDeföôi⁄
 *
pd
)

75 
pd
->
vÆid©e
 = 
vÆid©eNumîicR™ge
;

76 
pd
->
vÆid©i⁄D©a
 = &
vÆidR™ge
;

77 
pd
->
cuºítVÆue
 = 
	`gëZ⁄eCou¡InôülVÆue
();

78  
UDS_SUCCESS
;

79 
	}
}

82 
	$gëZ⁄eCou¡
()

84 
z⁄eCou¡
 = 0;

86 
UdsP¨amëîVÆue
 
vÆue
;

87 i‡((
	`udsGëP¨amëî
(
UDS_PARALLEL_FACTOR
, &
vÆue
Ë=
UDS_SUCCESS
) &&

88 
vÆue
.
ty≥
 =
UDS_PARAM_TYPE_UNSIGNED_INT
)

90 
z⁄eCou¡
 = 
vÆue
.vÆue.
u_uöt
;

93 i‡(
z⁄eCou¡
 == 0) {

94 
z⁄eCou¡
 = 
	`gëDeÁu…Z⁄eCou¡
();

97 
	`logInfo
("Usög %u indexög z⁄e%†f‹ c⁄cuºícy.", 
z⁄eCou¡
,

98 
z⁄eCou¡
 == 1 ? "" : "s");

99  
z⁄eCou¡
;

100 
	}
}

103 
	$£tZ⁄eCou¡
(
cou¡
)

105 
ªsu…
 = 
	`udsSëP¨amëî
(
UDS_PARALLEL_FACTOR
, 
	`udsUnsig√dVÆue
(
cou¡
));

106 i‡(
ªsu…
 !
UDS_SUCCESS
) {

107  
	`logEº‹WôhSåögEº‹
(
ªsu…
,

109 
UDS_PARALLEL_FACTOR
, 
cou¡
);

111  
UDS_SUCCESS
;

112 
	}
}

115 
	$ª£tZ⁄eCou¡
()

117 
ªsu…
 = 
	`udsRe£tP¨amëî
(
UDS_PARALLEL_FACTOR
);

118 i‡(
ªsu…
 !
UDS_SUCCESS
) {

119 
	`logEº‹WôhSåögEº‹
(
ªsu…
, "ˇ¬ŸÑe£à%s", 
UDS_PARALLEL_FACTOR
);

121 
	}
}

	@uds/zone.h

22 #i‚de‡
ZONE_H


23 
	#ZONE_H


	)

26 
	mMAX_ZONES
 = 16,

34 
	$gëZ⁄eCou¡
(Ë
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

46 
	`£tZ⁄eCou¡
(
cou¡
);

55 
	`ª£tZ⁄eCou¡
();

	@vdo/base/adminCompletion.c

22 
	~"admöCom∂ëi⁄.h
"

24 
	~"mem‹yAŒoc.h
"

25 
	~"≥rmas£π.h
"

27 
	~"com∂ëi⁄.h
"

28 
	~"ty≥s.h
"

29 
	~"vdoI¡î«l.h
"

31 
	sadmöCom∂ëi⁄
 {

33 
VDOCom∂ëi⁄
 
	mcom∂ëi⁄
;

35 
VDOCom∂ëi⁄
 
	msubTaskCom∂ëi⁄
;

37 
AdmöO≥øti⁄Ty≥
 
	mty≥
;

46 
	$as£πAdmöO≥øti⁄Ty≥
(
AdmöCom∂ëi⁄
 *
com∂ëi⁄
,

47 
AdmöO≥øti⁄Ty≥
 
ex≥˘ed
)

49 
	`ASSERT_LOG_ONLY
(
com∂ëi⁄
->
ty≥
 =
ex≥˘ed
,

51 
com∂ëi⁄
->
ty≥
, 
ex≥˘ed
);

52 
	}
}

61 
__©åibuã__
((
w¨n_unu£d_ªsu…
))

62 
AdmöCom∂ëi⁄
 *
	$admöCom∂ëi⁄FromSubTask
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

64 
	`STATIC_ASSERT
(
	`off£tof
(
AdmöCom∂ëi⁄
, 
com∂ëi⁄
) == 0);

65 
	`as£πCom∂ëi⁄Ty≥
(
com∂ëi⁄
->
ty≥
, 
SUB_TASK_COMPLETION
);

66 
VDOCom∂ëi⁄
 *
∑ª¡
 = 
com∂ëi⁄
->parent;

67 
	`as£πCom∂ëi⁄Ty≥
(
∑ª¡
->
ty≥
, 
ADMIN_COMPLETION
);

68  (
AdmöCom∂ëi⁄
 *Ë
∑ª¡
;

69 
	}
}

72 
VDO
 *
	$vdoFromAdmöSubTask
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
,

73 
AdmöO≥øti⁄Ty≥
 
ex≥˘ed
)

75 
AdmöCom∂ëi⁄
 *
admöCom∂ëi⁄
 = 
	`admöCom∂ëi⁄FromSubTask
(
com∂ëi⁄
);

76 
	`as£πAdmöO≥øti⁄Ty≥
(
admöCom∂ëi⁄
, 
ex≥˘ed
);

77  
admöCom∂ëi⁄
->
com∂ëi⁄
.
∑ª¡
;

78 
	}
}

81 
	$makeAdmöCom∂ëi⁄
(
PhysiˇlLayî
 *
œyî
,

82 
AdmöCom∂ëi⁄
 **
admöCom∂ëi⁄På
)

84 
AdmöCom∂ëi⁄
 *
admöCom∂ëi⁄
;

85 
ªsu…
 = 
	`ALLOCATE
(1, 
AdmöCom∂ëi⁄
, 
__func__
, &
admöCom∂ëi⁄
);

86 i‡(
ªsu…
 !
VDO_SUCCESS
) {

87  
ªsu…
;

90 
ªsu…
 = 
	`öôülizeEnqueuóbÀCom∂ëi⁄
(&
admöCom∂ëi⁄
->
com∂ëi⁄
,

91 
ADMIN_COMPLETION
, 
œyî
);

92 i‡(
ªsu…
 !
VDO_SUCCESS
) {

93 
	`‰ìAdmöCom∂ëi⁄
(&
admöCom∂ëi⁄
);

94  
ªsu…
;

97 
ªsu…
 = 
	`öôülizeEnqueuóbÀCom∂ëi⁄
(&
admöCom∂ëi⁄
->
subTaskCom∂ëi⁄
,

98 
SUB_TASK_COMPLETION
, 
œyî
);

99 i‡(
ªsu…
 !
VDO_SUCCESS
) {

100 
	`‰ìAdmöCom∂ëi⁄
(&
admöCom∂ëi⁄
);

101  
ªsu…
;

104 *
admöCom∂ëi⁄På
 = 
admöCom∂ëi⁄
;

105  
VDO_SUCCESS
;

106 
	}
}

109 
	$‰ìAdmöCom∂ëi⁄
(
AdmöCom∂ëi⁄
 **
admöCom∂ëi⁄På
)

111 
AdmöCom∂ëi⁄
 *
admöCom∂ëi⁄
 = *
admöCom∂ëi⁄På
;

112 i‡(
admöCom∂ëi⁄
 =
NULL
) {

116 
	`de°royEnqueuóbÀ
(&
admöCom∂ëi⁄
->
subTaskCom∂ëi⁄
);

117 
	`de°royEnqueuóbÀ
(&
admöCom∂ëi⁄
->
com∂ëi⁄
);

118 
	`FREE
(
admöCom∂ëi⁄
);

119 *
admöCom∂ëi⁄På
 = 
NULL
;

120 
	}
}

123 
	$¥ï¨eAdmöSubTaskOnThªad
(
VDO
 *
vdo
,

124 
VDOA˘i⁄
 *
ˇŒback
,

125 
VDOA˘i⁄
 *
îr‹H™dÀr
,

126 
ThªadID
 
thªadID
)

128 
	`¥ï¨eF‹Requeue
(&
vdo
->
admöCom∂ëi⁄
->
subTaskCom∂ëi⁄
, 
ˇŒback
,

129 
îr‹H™dÀr
, 
thªadID
, 
vdo
->
admöCom∂ëi⁄
);

130 
	}
}

133 
	$¥ï¨eAdmöSubTask
(
VDO
 *
vdo
,

134 
VDOA˘i⁄
 *
ˇŒback
,

135 
VDOA˘i⁄
 *
îr‹H™dÀr
)

137 
AdmöCom∂ëi⁄
 *
admöCom∂ëi⁄
 = 
vdo
->adminCompletion;

138 
	`¥ï¨eAdmöSubTaskOnThªad
(
vdo
, 
ˇŒback
, 
îr‹H™dÀr
,

139 
admöCom∂ëi⁄
->
com∂ëi⁄
.
ˇŒbackThªadID
);

140 
	}
}

148 
	$admöO≥øti⁄CÆlback
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

150 
com∂ëi⁄
->
œyî
->
	`com∂ëeAdmöO≥øti⁄
(completion->layer);

151 
	}
}

154 
	$≥rf‹mAdmöO≥øti⁄
(
VDO
 *
vdo
, 
AdmöO≥øti⁄Ty≥
 
ty≥
, 
VDOA˘i⁄
 *
a˘i⁄
)

156 
AdmöCom∂ëi⁄
 *
admöCom∂ëi⁄
 = 
vdo
->adminCompletion;

157 
	`¥ï¨eCom∂ëi⁄
(&
admöCom∂ëi⁄
->
com∂ëi⁄
, 
admöO≥øti⁄CÆlback
,

158 
admöO≥øti⁄CÆlback
,

159 
	`gëAdmöThªad
(
	`gëThªadC⁄fig
(
vdo
)), vdo);

160 
admöCom∂ëi⁄
->
ty≥
 =Åype;

161 
	`¥ï¨eAdmöSubTask
(
vdo
, 
a˘i⁄
,áction);

163 
PhysiˇlLayî
 *
œyî
 = 
vdo
->layer;

164 
œyî
->
	`íqueue
(
admöCom∂ëi⁄
->
subTaskCom∂ëi⁄
.
íqueuóbÀ
);

165 
œyî
->
	`waôF‹AdmöO≥øti⁄
(layer);

166  
admöCom∂ëi⁄
->
com∂ëi⁄
.
ªsu…
;

167 
	}
}

	@vdo/base/adminCompletion.h

22 #i‚de‡
ADMIN_COMPLETION_H


23 
	#ADMIN_COMPLETION_H


	)

25 
	~"com∂ëi⁄.h
"

26 
	~"ty≥s.h
"

28 
	eadmöO≥øti⁄Ty≥
 {

29 
	mADMIN_OPERATION_UNKNOWN
 = 0,

30 
	mADMIN_OPERATION_CLOSE
,

31 
	mADMIN_OPERATION_GROW_LOGICAL
,

32 
	mADMIN_OPERATION_GROW_PHYSICAL
,

33 
	mADMIN_OPERATION_LOAD
,

34 } 
	tAdmöO≥øti⁄Ty≥
;

44 
VDO
 *
	$vdoFromAdmöSubTask
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
,

45 
AdmöO≥øti⁄Ty≥
 
ex≥˘ed
)

46 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

57 
	$makeAdmöCom∂ëi⁄
(
PhysiˇlLayî
 *
œyî
,

58 
AdmöCom∂ëi⁄
 **
admöCom∂ëi⁄På
)

59 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

66 
	`‰ìAdmöCom∂ëi⁄
(
AdmöCom∂ëi⁄
 **
admöCom∂ëi⁄På
);

76 
	`¥ï¨eAdmöSubTaskOnThªad
(
VDO
 *
vdo
,

77 
VDOA˘i⁄
 *
ˇŒback
,

78 
VDOA˘i⁄
 *
îr‹H™dÀr
,

79 
ThªadID
 
thªadID
);

89 
	`¥ï¨eAdmöSubTask
(
VDO
 *
vdo
,

90 
VDOA˘i⁄
 *
ˇŒback
,

91 
VDOA˘i⁄
 *
îr‹H™dÀr
);

105 
	$≥rf‹mAdmöO≥øti⁄
(
VDO
 *
vdo
, 
AdmöO≥øti⁄Ty≥
 
ty≥
, 
VDOA˘i⁄
 *
a˘i⁄
)

106 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

	@vdo/base/allocatingVIO.c

22 
	~"ÆloˇtögVIO.h
"

24 
	~"loggî.h
"

26 
	~"blockAŒoˇt‹.h
"

27 
	~"d©aVIO.h
"

28 
	~"¶abDïŸ.h
"

29 
	~"vdoI¡î«l.h
"

30 
	~"vioWrôe.h
"

40 
	$©ãm±PBNWrôeLock
(
AŒoˇtögVIO
 *
ÆloˇtögVIO
)

42 
	`as£πInPhysiˇlZ⁄e
(
ÆloˇtögVIO
);

44 
	`ASSERT_LOG_ONLY
(!
	`isPBNLocked
(
ÆloˇtögVIO
->
wrôeLock
),

46 
	`ASSERT_LOG_ONLY
(
ÆloˇtögVIO
->
wrôeLock
 =
NULL
,

49 
PBNLock
 *
lock
;

50 
ªsu…
 = 
	`©ãm±PBNLock
(
ÆloˇtögVIO
->
z⁄e
,áŒoˇtögVIO->
Æloˇti⁄
,

51 
ÆloˇtögVIO
->
wrôeLockTy≥
, &
lock
);

52 i‡(
ªsu…
 !
VDO_SUCCESS
) {

53  
ªsu…
;

56 i‡(
lock
->
hﬁdî
 =
NULL
) {

58 
lock
->
hﬁdî
 = 
ÆloˇtögVIO
;

59 
ÆloˇtögVIO
->
wrôeLock
 = 
lock
;

60 
	`assignProvisi⁄ÆRe„ªn˚
(
lock
);

61  
VDO_SUCCESS
;

65 
AŒoˇtögVIO
 *
lockHﬁdî
 = 
	`lockHﬁdîAsAŒoˇtögVIO
(
lock
);

66  
	`logEº‹WôhSåögEº‹
(
VDO_LOCK_ERROR
,

67 "NewlyáŒoˇãd block %" 
PRIu64


69 
ÆloˇtögVIO
->
Æloˇti⁄
,

70 
	`ÆloˇtögVIOAsVIO
(
lockHﬁdî
)->
ty≥
);

71 
	}
}

81 
	$ÆloˇãAndLockBlock
(
AŒoˇtögVIO
 *
ÆloˇtögVIO
)

83 
BlockAŒoˇt‹
 *
Æloˇt‹
 = 
	`gëBlockAŒoˇt‹
(
ÆloˇtögVIO
->
z⁄e
);

84 
ªsu…
 = 
	`ÆloˇãBlock
(
Æloˇt‹
, &
ÆloˇtögVIO
->
Æloˇti⁄
);

85 i‡(
ªsu…
 !
VDO_SUCCESS
) {

86  
ªsu…
;

89 
ªsu…
 = 
	`©ãm±PBNWrôeLock
(
ÆloˇtögVIO
);

90 i‡(
ªsu…
 !
VDO_SUCCESS
) {

91  
ªsu…
;

95 
VIO
 *
vio
 = 
	`ÆloˇtögVIOAsVIO
(
ÆloˇtögVIO
);

96 
vio
->
physiˇl
 = 
ÆloˇtögVIO
->
Æloˇti⁄
;

97 
ÆloˇtögVIO
->
	`Æloˇti⁄CÆlback
(allocatingVIO);

98  
VDO_SUCCESS
;

99 
	}
}

101 
ÆloˇãBlockF‹Wrôe
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
);

110 
ªåyAŒoˇãBlockF‹Wrôe
(
Waôî
 *
waôî
,

111 *
c⁄ãxt
 
__©åibuã__
((
unu£d
)))

113 
AŒoˇtögVIO
 *
	gÆloˇtögVIO
 = 
waôîAsAŒoˇtögVIO
(
waôî
);

114 
ÆloˇãBlockF‹Wrôe
(
ÆloˇtögVIOAsCom∂ëi⁄
(
ÆloˇtögVIO
));

127 
	$waôF‹CÀ™Sœb
(
AŒoˇtögVIO
 *
ÆloˇtögVIO
)

129 
Waôî
 *
waôî
 = 
	`ÆloˇtögVIOAsWaôî
(
ÆloˇtögVIO
);

130 
waôî
->
ˇŒback
 = 
ªåyAŒoˇãBlockF‹Wrôe
;

132 
BlockAŒoˇt‹
 *
Æloˇt‹
 = 
	`gëBlockAŒoˇt‹
(
ÆloˇtögVIO
->
z⁄e
);

133 
ªsu…
 = 
	`íqueueF‹CÀ™Sœb
(
Æloˇt‹
, 
waôî
);

134 i‡(
ªsu…
 !
VDO_SUCCESS
) {

135  
ªsu…
;

140 
ÆloˇtögVIO
->
waôF‹CÀ™Sœb
 = 
Ál£
;

141 
ÆloˇtögVIO
->
Æloˇti⁄Aâem±s
 = 0;

142  
VDO_SUCCESS
;

143 
	}
}

152 
	$ÆloˇãBlockInZ⁄e
(
AŒoˇtögVIO
 *
ÆloˇtögVIO
)

154 
ÆloˇtögVIO
->
Æloˇti⁄Aâem±s
++;

155 
ªsu…
 = 
	`ÆloˇãAndLockBlock
(
ÆloˇtögVIO
);

156 i‡(
ªsu…
 !
VDO_NO_SPACE
) {

157  
ªsu…
;

160 i‡(
ÆloˇtögVIO
->
waôF‹CÀ™Sœb
) {

161 
ªsu…
 = 
	`waôF‹CÀ™Sœb
(
ÆloˇtögVIO
);

162 i‡(
ªsu…
 !
VDO_NO_SPACE
) {

163  
ªsu…
;

167 
VDO
 *
vdo
 = 
	`gëVDOFromAŒoˇtögVIO
(
ÆloˇtögVIO
);

168 c⁄° 
ThªadC⁄fig
 *
thªadC⁄fig
 = 
	`gëThªadC⁄fig
(
vdo
);

169 i‡(
ÆloˇtögVIO
->
Æloˇti⁄Aâem±s
 >
thªadC⁄fig
->
physiˇlZ⁄eCou¡
) {

170 i‡(
ÆloˇtögVIO
->
waôF‹CÀ™Sœb
) {

173 
ÆloˇtögVIO
->
	`Æloˇti⁄CÆlback
(allocatingVIO);

174  
VDO_SUCCESS
;

177 
ÆloˇtögVIO
->
waôF‹CÀ™Sœb
 = 
åue
;

178 
ÆloˇtögVIO
->
Æloˇti⁄Aâem±s
 = 0;

182 
Z⁄eCou¡
 
z⁄eNumbî
 = 
	`gëPhysiˇlZ⁄eNumbî
(
ÆloˇtögVIO
->
z⁄e
) + 1;

183 i‡(
z⁄eNumbî
 =
thªadC⁄fig
->
physiˇlZ⁄eCou¡
) {

184 
z⁄eNumbî
 = 0;

186 
ÆloˇtögVIO
->
z⁄e
 = 
vdo
->
physiˇlZ⁄es
[
z⁄eNumbî
];

187 
	`œunchPhysiˇlZ⁄eCÆlback
(
ÆloˇtögVIO
, 
ÆloˇãBlockF‹Wrôe
,

188 
	`THIS_LOCATION
("$F;cb=allocBlockInZone"));

189  
VDO_SUCCESS
;

190 
	}
}

198 
	$ÆloˇãBlockF‹Wrôe
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

200 
AŒoˇtögVIO
 *
ÆloˇtögVIO
 = 
	`asAŒoˇtögVIO
(
com∂ëi⁄
);

201 
	`as£πInPhysiˇlZ⁄e
(
ÆloˇtögVIO
);

202 
	`ÆloˇtögVIOAddTø˚Rec‹d
(
ÆloˇtögVIO
, 
	`THIS_LOCATION
(
NULL
));

203 
ªsu…
 = 
	`ÆloˇãBlockInZ⁄e
(
ÆloˇtögVIO
);

204 i‡(
ªsu…
 !
VDO_SUCCESS
) {

205 
	`£tCom∂ëi⁄Resu…
(
com∂ëi⁄
, 
ªsu…
);

206 
ÆloˇtögVIO
->
	`Æloˇti⁄CÆlback
(allocatingVIO);

208 
	}
}

211 
	$ÆloˇãD©aBlock
(
AŒoˇtögVIO
 *
ÆloˇtögVIO
,

212 
PBNLockTy≥
 
wrôeLockTy≥
,

213 
AŒoˇti⁄CÆlback
 *
ˇŒback
)

215 
VIO
 *
vio
 = 
	`ÆloˇtögVIOAsVIO
(
ÆloˇtögVIO
);

216 
VDOCom∂ëi⁄
 *
com∂ëi⁄
 = 
	`vioAsCom∂ëi⁄
(
vio
);

218 
ÆloˇtögVIO
->
wrôeLockTy≥
 = writeLockType;

219 
ÆloˇtögVIO
->
Æloˇti⁄CÆlback
 = 
ˇŒback
;

220 
ÆloˇtögVIO
->
Æloˇti⁄Aâem±s
 = 0;

221 
ÆloˇtögVIO
->
Æloˇti⁄
 = 
ZERO_BLOCK
;

222 
ÆloˇtögVIO
->
z⁄e


223 
	`gëNextAŒoˇti⁄Z⁄e
(
vio
->
vdo
, 
com∂ëi⁄
->
ˇŒbackThªadID
);

225 
	`œunchPhysiˇlZ⁄eCÆlback
(
ÆloˇtögVIO
, 
ÆloˇãBlockF‹Wrôe
,

226 
	`THIS_LOCATION
("$F;cb=allocDataBlock"));

227 
	}
}

230 
	$ªÀa£PBNWrôeLock
(
AŒoˇtögVIO
 *
ÆloˇtögVIO
)

232 
	`as£πInPhysiˇlZ⁄e
(
ÆloˇtögVIO
);

233 
PhysiˇlBlockNumbî
 
lockedPBN
 = 
ÆloˇtögVIO
->
Æloˇti⁄
;

234 i‡(
	`hasProvisi⁄ÆRe„ªn˚
(
ÆloˇtögVIO
->
wrôeLock
)) {

235 
ÆloˇtögVIO
->
Æloˇti⁄
 = 
ZERO_BLOCK
;

238 
	`ªÀa£PBNLock
(
ÆloˇtögVIO
->
z⁄e
, 
lockedPBN
, &ÆloˇtögVIO->
wrôeLock
);

239 
	}
}

242 
	$ª£tAŒoˇti⁄
(
AŒoˇtögVIO
 *
ÆloˇtögVIO
)

244 
	`ASSERT_LOG_ONLY
(
ÆloˇtögVIO
->
wrôeLock
 =
NULL
,

247 
	`ÆloˇtögVIOAsVIO
(
ÆloˇtögVIO
)->
physiˇl
 = 
ZERO_BLOCK
;

248 
ÆloˇtögVIO
->
z⁄e
 = 
NULL
;

249 
ÆloˇtögVIO
->
Æloˇti⁄
 = 
ZERO_BLOCK
;

250 
ÆloˇtögVIO
->
Æloˇti⁄Aâem±s
 = 0;

251 
ÆloˇtögVIO
->
waôF‹CÀ™Sœb
 = 
Ál£
;

252 
	}
}

	@vdo/base/allocatingVIO.h

22 #i‚de‡
ALLOCATING_VIO_H


23 
	#ALLOCATING_VIO_H


	)

25 
	~"utû/©omic.h
"

27 
	~"pbnLock.h
"

28 
	~"physiˇlZ⁄e.h
"

29 
	~"vio.h
"

30 
	~"waôQueue.h
"

32 
	tAŒoˇti⁄CÆlback
(
	tAŒoˇtögVIO
 *
	tÆloˇti⁄VIO
);

39 
	sÆloˇtögVIO
 {

41 
VIO
 
	mvio
;

44 
Waôî
 
	mwaôî
;

47 
PhysiˇlZ⁄e
 *
	mz⁄e
;

50 
PhysiˇlBlockNumbî
 
	mÆloˇti⁄
;

53 
PBNLock
 *
	mwrôeLock
;

56 
PBNLockTy≥
 
	mwrôeLockTy≥
;

59 
Z⁄eCou¡
 
	mÆloˇti⁄Aâem±s
;

62 
boﬁ
 
	mwaôF‹CÀ™Sœb
;

65 
AŒoˇti⁄CÆlback
 *
	mÆloˇti⁄CÆlback
;

75 
ölöe
 
AŒoˇtögVIO
 *
	$vioAsAŒoˇtögVIO
(
VIO
 *
vio
)

77 
	`STATIC_ASSERT
(
	`off£tof
(
AŒoˇtögVIO
, 
vio
) == 0);

78 
	`ASSERT_LOG_ONLY
(((
vio
->
ty≥
 =
VIO_TYPE_DATA
)

79 || (
vio
->
ty≥
 =
VIO_TYPE_COMPRESSED_BLOCK
)),

81  (
AŒoˇtögVIO
 *Ë
vio
;

82 
	}
}

91 
ölöe
 
VIO
 *
	$ÆloˇtögVIOAsVIO
(
AŒoˇtögVIO
 *
ÆloˇtögVIO
)

93  &
ÆloˇtögVIO
->
vio
;

94 
	}
}

103 
ölöe
 
AŒoˇtögVIO
 *
	$asAŒoˇtögVIO
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

105  
	`vioAsAŒoˇtögVIO
(
	`asVIO
(
com∂ëi⁄
));

106 
	}
}

115 
ölöe


116 
VDOCom∂ëi⁄
 *
	$ÆloˇtögVIOAsCom∂ëi⁄
(
AŒoˇtögVIO
 *
ÆloˇtögVIO
)

118  
	`vioAsCom∂ëi⁄
(
	`ÆloˇtögVIOAsVIO
(
ÆloˇtögVIO
));

119 
	}
}

128 
ölöe
 
Waôî
 *
	$ÆloˇtögVIOAsWaôî
(
AŒoˇtögVIO
 *
ÆloˇtögVIO
)

130  &
ÆloˇtögVIO
->
waôî
;

131 
	}
}

141 
ölöe
 
AŒoˇtögVIO
 *
	$waôîAsAŒoˇtögVIO
(
Waôî
 *
waôî
)

143 i‡(
waôî
 =
NULL
) {

144  
NULL
;

148 (
AŒoˇtögVIO
 *Ë((
uöçå_t
Ë
waôî
 - 
	`off£tof
(AllocatingVIO, waiter));

149 
	}
}

158 
ölöe
 
boﬁ
 
	$isCom¥es£dWrôeAŒoˇtögVIO
(
AŒoˇtögVIO
 *
ÆloˇtögVIO
)

160  
	`isCom¥es£dWrôeVIO
(
	`ÆloˇtögVIOAsVIO
(
ÆloˇtögVIO
));

161 
	}
}

169 
ölöe
 
	$ÆloˇtögVIOAddTø˚Rec‹d
(
AŒoˇtögVIO
 *
ÆloˇtögVIO
,

170 
Tø˚Loˇti⁄
 
loˇti⁄
)

172 
	`vioAddTø˚Rec‹d
(
	`ÆloˇtögVIOAsVIO
(
ÆloˇtögVIO
), 
loˇti⁄
);

173 
	}
}

182 
ölöe
 
VDO
 *
	$gëVDOFromAŒoˇtögVIO
(
AŒoˇtögVIO
 *
ÆloˇtögVIO
)

184  
	`ÆloˇtögVIOAsVIO
(
ÆloˇtögVIO
)->
vdo
;

185 
	}
}

193 
ölöe
 
	$as£πInPhysiˇlZ⁄e
(
AŒoˇtögVIO
 *
ÆloˇtögVIO
)

195 
ThªadID
 
ex≥˘ed
 = 
	`gëPhysiˇlZ⁄eThªadID
(
ÆloˇtögVIO
->
z⁄e
);

196 
ThªadID
 
thªadID
 = 
	`gëCÆlbackThªadID
();

197 
	`ASSERT_LOG_ONLY
((
ex≥˘ed
 =
thªadID
),

198 "AŒoˇtögVIO f‹áŒoˇãdÖhysiˇ»block %" 
PRIu64


200 
ÆloˇtögVIO
->
Æloˇti⁄
, 
thªadID
, 
ex≥˘ed
);

201 
	}
}

211 
ölöe
 
	$£tPhysiˇlZ⁄eCÆlback
(
AŒoˇtögVIO
 *
ÆloˇtögVIO
,

212 
VDOA˘i⁄
 *
ˇŒback
,

213 
Tø˚Loˇti⁄
 
loˇti⁄
)

215 
	`£tCÆlback
(
	`ÆloˇtögVIOAsCom∂ëi⁄
(
ÆloˇtögVIO
), 
ˇŒback
,

216 
	`gëPhysiˇlZ⁄eThªadID
(
ÆloˇtögVIO
->
z⁄e
));

217 
	`ÆloˇtögVIOAddTø˚Rec‹d
(
ÆloˇtögVIO
, 
loˇti⁄
);

218 
	}
}

228 
ölöe
 
	$œunchPhysiˇlZ⁄eCÆlback
(
AŒoˇtögVIO
 *
ÆloˇtögVIO
,

229 
VDOA˘i⁄
 *
ˇŒback
,

230 
Tø˚Loˇti⁄
 
loˇti⁄
)

232 
	`£tPhysiˇlZ⁄eCÆlback
(
ÆloˇtögVIO
, 
ˇŒback
, 
loˇti⁄
);

233 
	`övokeCÆlback
(
	`ÆloˇtögVIOAsCom∂ëi⁄
(
ÆloˇtögVIO
));

234 
	}
}

243 
ÆloˇãD©aBlock
(
AŒoˇtögVIO
 *
ÆloˇtögVIO
,

244 
PBNLockTy≥
 
wrôeLockTy≥
,

245 
AŒoˇti⁄CÆlback
 *
ˇŒback
);

253 
ªÀa£PBNWrôeLock
(
AŒoˇtögVIO
 *
ÆloˇtögVIO
);

260 
ª£tAŒoˇti⁄
(
AŒoˇtögVIO
 *
ÆloˇtögVIO
);

	@vdo/base/blockAllocator.c

22 
	~"blockAŒoˇt‹I¡î«ls.h
"

24 
	~"loggî.h
"

25 
	~"mem‹yAŒoc.h
"

27 
	~"blockDes¸ùt‹.h
"

28 
	~"hóp.h
"

29 
	~"numUtûs.h
"

30 
	~"¥i‹ôyTabÀ.h
"

31 
	~"ªfCou¡s.h
"

32 
	~"¶ab.h
"

33 
	~"¶abCom∂ëi⁄.h
"

34 
	~"¶abDïŸI¡î«ls.h
"

35 
	~"¶abIãøt‹.h
"

36 
	~"¶abJou∫ÆI¡î«ls.h
"

37 
	~"¶abS¸ubbî.h
"

38 
	~"¶abSumm¨y.h
"

39 
	~"vio.h
"

40 
	~"vioPoﬁ.h
"

48 
ölöe
 
	$as£πOnAŒoˇt‹Thªad
(
ThªadID
 
thªadID
,

49 c⁄° *
fun˘i⁄Name
)

51 
	`ASSERT_LOG_ONLY
((
	`gëCÆlbackThªadID
(Ë=
thªadID
),

52 "%†ˇŒed o¿c‹ª˘Åhªad", 
fun˘i⁄Name
);

53 
	}
}

65 
	$ˇlcuœãSœbPri‹ôy
(
Sœb
 *
¶ab
)

67 
BlockCou¡
 
‰ìBlocks
 = 
	`gëSœbFªeBlockCou¡
(
¶ab
);

71 i‡(
‰ìBlocks
 == 0) {

84 
un›íedSœbPri‹ôy
 = 
¶ab
->
Æloˇt‹
->unopenedSlabPriority;

85 i‡(
	`isSœbJou∫ÆBœnk
(
¶ab
->
jou∫Æ
)) {

86  
un›íedSœbPri‹ôy
;

96 
¥i‹ôy
 = (1 + 
	`logBa£Two
(
‰ìBlocks
));

97  ((
¥i‹ôy
 < 
un›íedSœbPri‹ôy
) ?Öriority :Öriority + 1);

98 
	}
}

105 
	$¥i‹ôizeSœb
(
Sœb
 *
¶ab
)

107 
	`ASSERT_LOG_ONLY
(
	`isRögEm±y
(&
¶ab
->
rögNode
),

109 
¶ab
->
¥i‹ôy
 = 
	`ˇlcuœãSœbPri‹ôy
(slab);

110 
	`¥i‹ôyTabÀEnqueue
(
¶ab
->
Æloˇt‹
->
¥i‹ôizedSœbs
, sœb->
¥i‹ôy
,

111 &
¶ab
->
rögNode
);

112 
	}
}

115 
	$ªgi°îSœbWôhAŒoˇt‹
(
BlockAŒoˇt‹
 *
Æloˇt‹
,

116 
Sœb
 *
¶ab
,

117 
boﬁ
 
ªsizög
)

119 
Æloˇt‹
->
¶abCou¡
++;

120 
Æloˇt‹
->
œ°Sœb
 = 
¶ab
->
¶abNumbî
;

121 i‡(
ªsizög
) {

122 
	`¥i‹ôizeSœb
(
¶ab
);

124 
	}
}

133 
SœbIãøt‹
 
	$gëSœbIãøt‹
(c⁄° 
BlockAŒoˇt‹
 *
Æloˇt‹
)

135  
	`ôî©eSœbs
(
Æloˇt‹
->
dïŸ
->
¶abs
,áŒoˇt‹->
œ°Sœb
,

136 
Æloˇt‹
->
z⁄eNumbî
,áŒoˇt‹->
dïŸ
->
z⁄eCou¡
);

137 
	}
}

140 
	$makeAŒoˇt‹PoﬁVIOs
(
PhysiˇlLayî
 *
œyî
,

141 *
∑ª¡
,

142 *
buf„r
,

143 
VIO
 **
vioPå
)

145  
	`¸óãVIO
(
œyî
, 
VIO_TYPE_SLAB_JOURNAL
, 
VIO_PRIORITY_METADATA
, 
∑ª¡
,

146 
buf„r
, 
vioPå
);

147 
	}
}

157 
__©åibuã__
((
w¨n_unu£d_ªsu…
))

158 
	$makeBlockDes¸ùt‹Poﬁ
(
BlockCou¡
 
size
, 
Obje˘Poﬁ
 **
poﬁPå
)

160 
BlockDes¸ùt‹
 *
des¸ùt‹s
;

161 
ªsu…
 = 
	`ALLOCATE
(
size
, 
BlockDes¸ùt‹
, 
__func__
, &
des¸ùt‹s
);

162 i‡(
ªsu…
 !
VDO_SUCCESS
) {

163  
ªsu…
;

166 
Obje˘Poﬁ
 *
poﬁ
;

167 
ªsu…
 = 
	`makeObje˘Poﬁ
(
des¸ùt‹s
, &
poﬁ
);

168 i‡(
ªsu…
 !
VDO_SUCCESS
) {

169 
	`FREE
(
des¸ùt‹s
);

170  
ªsu…
;

173 
BlockCou¡
 
i
 = 0; i < 
size
; i++) {

174 
	`addE¡ryToObje˘Poﬁ
(
poﬁ
, &
des¸ùt‹s
[
i
].
rögNode
);

177 *
poﬁPå
 = 
poﬁ
;

178  
VDO_SUCCESS
;

179 
	}
}

192 
	$ÆloˇãComp⁄íts
(
BlockAŒoˇt‹
 *
Æloˇt‹
,

193 
PhysiˇlLayî
 *
œyî
,

194 
BlockCou¡
 
vioPoﬁSize
,

195 
BlockCou¡
 
des¸ùt‹PoﬁSize
)

202 i‡(
œyî
->
¸óãMëad©aVIO
 =
NULL
) {

203  
VDO_SUCCESS
;

206 
SœbDïŸ
 *
dïŸ
 = 
Æloˇt‹
->depot;

207 
ªsu…
 = 
	`öôülizeEnqueuóbÀCom∂ëi⁄
(&
Æloˇt‹
->
com∂ëi⁄
,

208 
BLOCK_ALLOCATOR_COMPLETION
,

209 
œyî
);

210 i‡(
ªsu…
 !
VDO_SUCCESS
) {

211  
ªsu…
;

214 
Æloˇt‹
->
summ¨y
 = 
	`gëSœbSumm¨yF‹Z⁄e
(
dïŸ
,áŒoˇt‹->
z⁄eNumbî
);

216 
ªsu…
 = 
	`makeVIOPoﬁ
(
œyî
, 
vioPoﬁSize
, 
makeAŒoˇt‹PoﬁVIOs
, 
NULL
,

217 &
Æloˇt‹
->
vioPoﬁ
);

218 i‡(
ªsu…
 !
VDO_SUCCESS
) {

219  
ªsu…
;

222 
ªsu…
 = 
	`makeBlockDes¸ùt‹Poﬁ
(
des¸ùt‹PoﬁSize
,

223 &
Æloˇt‹
->
blockDes¸ùt‹Poﬁ
);

224 i‡(
ªsu…
 !
VDO_SUCCESS
) {

225  
ªsu…
;

228 
ªsu…
 = 
	`makeSœbCom∂ëi⁄
(
œyî
, &
Æloˇt‹
->
¶abCom∂ëi⁄
);

229 i‡(
ªsu…
 !
VDO_SUCCESS
) {

230  
ªsu…
;

233 
BlockCou¡
 
¶abJou∫ÆSize
 = 
dïŸ
->
¶abC⁄fig
.
¶abJou∫ÆBlocks
;

234 
ªsu…
 = 
	`makeSœbS¸ubbî
(
œyî
, 
¶abJou∫ÆSize
, 
Æloˇt‹
->
ªadO∆yC⁄ãxt
,

235 &
Æloˇt‹
->
¶abS¸ubbî
);

236 i‡(
ªsu…
 !
VDO_SUCCESS
) {

237  
ªsu…
;

242 
BlockCou¡
 
maxFªeBlocks
 = 
dïŸ
->
¶abC⁄fig
.
d©aBlocks
;

243 
maxPri‹ôy
 = (2 + 
	`logBa£Two
(
maxFªeBlocks
));

244 
ªsu…
 = 
	`makePri‹ôyTabÀ
(
maxPri‹ôy
, &
Æloˇt‹
->
¥i‹ôizedSœbs
);

245 i‡(
ªsu…
 !
VDO_SUCCESS
) {

246  
ªsu…
;

265 
Æloˇt‹
->
un›íedSœbPri‹ôy
 = (1 + 
	`logBa£Two
((
maxFªeBlocks
 * 3) / 4));

267  
VDO_SUCCESS
;

268 
	}
}

271 
	$makeBlockAŒoˇt‹
(
SœbDïŸ
 *
dïŸ
,

272 
Z⁄eCou¡
 
z⁄eNumbî
,

273 
ThªadID
 
thªadID
,

274 
N⁄˚
 
n⁄˚
,

275 
BlockCou¡
 
vioPoﬁSize
,

276 
BlockCou¡
 
des¸ùt‹PoﬁSize
,

277 
PhysiˇlLayî
 *
œyî
,

278 
RódO∆yModeC⁄ãxt
 *
ªadO∆yC⁄ãxt
,

279 
BlockAŒoˇt‹
 **
Æloˇt‹På
)

282 
BlockAŒoˇt‹
 *
Æloˇt‹
;

283 
ªsu…
 = 
	`ALLOCATE
(1, 
BlockAŒoˇt‹
, 
__func__
, &
Æloˇt‹
);

284 i‡(
ªsu…
 !
VDO_SUCCESS
) {

285  
ªsu…
;

288 
Æloˇt‹
->
dïŸ
 = depot;

289 
Æloˇt‹
->
z⁄eNumbî
 = zoneNumber;

290 
Æloˇt‹
->
thªadID
 =ÅhreadID;

291 
Æloˇt‹
->
n⁄˚
 =Çonce;

292 
Æloˇt‹
->
ªadO∆yC⁄ãxt
 =ÑeadOnlyContext;

293 
	`öôülizeRög
(&
Æloˇt‹
->
dútySœbJou∫Æs
);

295 
ªsu…
 = 
	`ÆloˇãComp⁄íts
(
Æloˇt‹
, 
œyî
, 
vioPoﬁSize
,

296 
des¸ùt‹PoﬁSize
);

297 i‡(
ªsu…
 !
VDO_SUCCESS
) {

298 
	`‰ìBlockAŒoˇt‹
(&
Æloˇt‹
);

299  
ªsu…
;

302 *
Æloˇt‹På
 = 
Æloˇt‹
;

303  
VDO_SUCCESS
;

304 
	}
}

311 
	$‰ìDes¸ùt‹Poﬁ
(
BlockAŒoˇt‹
 *
Æloˇt‹
)

313 i‡(
Æloˇt‹
->
blockDes¸ùt‹Poﬁ
 =
NULL
) {

317 
BlockDes¸ùt‹
 *
des¸ùt‹s


318 
	`gëObje˘PoﬁE¡ryD©a
(
Æloˇt‹
->
blockDes¸ùt‹Poﬁ
);

319 
	`‰ìObje˘Poﬁ
(&
Æloˇt‹
->
blockDes¸ùt‹Poﬁ
);

320 
	`FREE
(
des¸ùt‹s
);

321 
	}
}

324 
	$‰ìBlockAŒoˇt‹
(
BlockAŒoˇt‹
 **
blockAŒoˇt‹På
)

326 
BlockAŒoˇt‹
 *
Æloˇt‹
 = *
blockAŒoˇt‹På
;

327 i‡(
Æloˇt‹
 =
NULL
) {

331 
	`‰ìSœbS¸ubbî
(&
Æloˇt‹
->
¶abS¸ubbî
);

332 
	`‰ìSœbCom∂ëi⁄
(&
Æloˇt‹
->
¶abCom∂ëi⁄
);

333 
	`‰ìVIOPoﬁ
(&
Æloˇt‹
->
vioPoﬁ
);

334 
	`‰ìDes¸ùt‹Poﬁ
(
Æloˇt‹
);

335 
	`‰ìPri‹ôyTabÀ
(&
Æloˇt‹
->
¥i‹ôizedSœbs
);

336 
	`de°royEnqueuóbÀ
(&
Æloˇt‹
->
com∂ëi⁄
);

337 
	`FREE
(
Æloˇt‹
);

338 *
blockAŒoˇt‹På
 = 
NULL
;

339 
	}
}

342 
	$ª∂a˚Des¸ùt‹Poﬁ
(
BlockAŒoˇt‹
 *
Æloˇt‹
, 
size_t
 
size
)

344 
	`‰ìDes¸ùt‹Poﬁ
(
Æloˇt‹
);

345  
	`makeBlockDes¸ùt‹Poﬁ
(
size
, &
Æloˇt‹
->
blockDes¸ùt‹Poﬁ
);

346 
	}
}

349 
	$ª∂a˚VIOPoﬁ
(
BlockAŒoˇt‹
 *
Æloˇt‹
,

350 
size_t
 
size
,

351 
PhysiˇlLayî
 *
œyî
)

353 
	`‰ìVIOPoﬁ
(&
Æloˇt‹
->
vioPoﬁ
);

354  
	`makeVIOPoﬁ
(
œyî
, 
size
, 
makeAŒoˇt‹PoﬁVIOs
, 
NULL
,

355 &
Æloˇt‹
->
vioPoﬁ
);

356 
	}
}

359 
	$nŸifyBlockAŒoˇt‹OfRódO∆yMode
(
BlockAŒoˇt‹
 *
Æloˇt‹
)

361 
	`as£πOnAŒoˇt‹Thªad
(
Æloˇt‹
->
thªadID
, 
__func__
);

362 
SœbIãøt‹
 
ôî©‹
 = 
	`gëSœbIãøt‹
(
Æloˇt‹
);

363 
	`hasNextSœb
(&
ôî©‹
)) {

364 
Sœb
 *
¶ab
 = 
	`√xtSœb
(&
ôî©‹
);

365 
	`ab‹tSœbJou∫ÆWaôîs
(
¶ab
->
jou∫Æ
);

367 
	}
}

376 
__©åibuã__
((
w¨n_unu£d_ªsu…
))

377 
ölöe
 
BlockCou¡
 
	$gëD©aBlockCou¡
(c⁄° 
BlockAŒoˇt‹
 *
Æloˇt‹
)

379  (
Æloˇt‹
->
¶abCou¡
 *áŒoˇt‹->
dïŸ
->
¶abC⁄fig
.
d©aBlocks
);

380 
	}
}

383 
BlockCou¡
 
	$gëAŒoˇãdBlocks
(c⁄° 
BlockAŒoˇt‹
 *
Æloˇt‹
)

385  
	`ªœxedLﬂd64
(&
Æloˇt‹
->
°©i°ics
.
ÆloˇãdBlocks
);

386 
	}
}

389 
BlockCou¡
 
	$gëUƒecovîedSœbCou¡
(c⁄° 
BlockAŒoˇt‹
 *
Æloˇt‹
)

391  
	`gëS¸ubbîSœbCou¡
(
Æloˇt‹
->
¶abS¸ubbî
);

392 
	}
}

395 
	$queueSœb
(
Sœb
 *
¶ab
)

397 
	`ASSERT_LOG_ONLY
(
	`isRögEm±y
(&
¶ab
->
rögNode
),

399 
BlockAŒoˇt‹
 *
Æloˇt‹
 = 
¶ab
->allocator;

400 
BlockCou¡
 
‰ìBlocks
 = 
	`gëSœbFªeBlockCou¡
(
¶ab
);

401 
ªsu…
 = 
	`ASSERT
((
‰ìBlocks
 <
Æloˇt‹
->
dïŸ
->
¶abC⁄fig
.
d©aBlocks
),

403 " (ha†%" 
PRIu64
 ",Éxpected maximum %" PRIu64 ")",

404 
¶ab
->
¶abNumbî
, 
‰ìBlocks
,

405 
Æloˇt‹
->
dïŸ
->
¶abC⁄fig
.
d©aBlocks
);

406 i‡(
ªsu…
 !
VDO_SUCCESS
) {

407 
	`íãrRódO∆yMode
(
Æloˇt‹
->
ªadO∆yC⁄ãxt
, 
ªsu…
);

411 
	`ªœxedAdd64
(&
Æloˇt‹
->
°©i°ics
.
ÆloˇãdBlocks
, -
‰ìBlocks
);

412 i‡(!
	`isSœbJou∫ÆBœnk
(
¶ab
->
jou∫Æ
)) {

413 
	`ªœxedAdd64
(&
Æloˇt‹
->
°©i°ics
.
¶absO≥√d
, 1);

417 
	`¥i‹ôizeSœb
(
¶ab
);

418 
	}
}

421 
	$adju°FªeBlockCou¡
(
Sœb
 *
¶ab
, 
boﬁ
 
ö¸emít
)

423 
BlockAŒoˇt‹
 *
Æloˇt‹
 = 
¶ab
->allocator;

425 
	`ªœxedAdd64
(&
Æloˇt‹
->
°©i°ics
.
ÆloˇãdBlocks
, (
ö¸emít
 ? -1 : 1));

428 i‡(
¶ab
 =
Æloˇt‹
->
›íSœb
) {

433 i‡(
¶ab
->
¥i‹ôy
 =
	`ˇlcuœãSœbPri‹ôy
(slab)) {

439 
	`¥i‹ôyTabÀRemove
(
Æloˇt‹
->
¥i‹ôizedSœbs
, &
¶ab
->
rögNode
);

440 
	`¥i‹ôizeSœb
(
¶ab
);

441 
	}
}

456 
	$ÆloˇãSœbBlock
(
Sœb
 *
¶ab
, 
PhysiˇlBlockNumbî
 *
blockNumbîPå
)

458 
PhysiˇlBlockNumbî
 
pbn
;

459 
ªsu…
 = 
	`ÆloˇãUƒe„ªn˚dBlock
(
¶ab
->
ª„ªn˚Cou¡s
, &
pbn
);

460 i‡(
ªsu…
 !
VDO_SUCCESS
) {

461  
ªsu…
;

464 
	`adju°FªeBlockCou¡
(
¶ab
, 
Ál£
);

466 *
blockNumbîPå
 = 
pbn
;

467  
VDO_SUCCESS
;

468 
	}
}

471 
	$ÆloˇãBlock
(
BlockAŒoˇt‹
 *
Æloˇt‹
,

472 
PhysiˇlBlockNumbî
 *
blockNumbîPå
)

474 i‡(
Æloˇt‹
->
›íSœb
 !
NULL
) {

476 
ªsu…
 = 
	`ÆloˇãSœbBlock
(
Æloˇt‹
->
›íSœb
, 
blockNumbîPå
);

477 i‡((
ªsu…
 =
VDO_SUCCESS
Ë|| (ªsu… !
VDO_NO_SPACE
)) {

478  
ªsu…
;

482 
	`¥i‹ôizeSœb
(
Æloˇt‹
->
›íSœb
);

487 
Æloˇt‹
->
›íSœb


488 
	`¶abFromRögNode
(
	`¥i‹ôyTabÀDequeue
(
Æloˇt‹
->
¥i‹ôizedSœbs
));

490 i‡(
	`isSœbJou∫ÆBœnk
(
Æloˇt‹
->
›íSœb
->
jou∫Æ
)) {

491 
	`ªœxedAdd64
(&
Æloˇt‹
->
°©i°ics
.
¶absO≥√d
, 1);

492 
ªsu…
 = 
	`dútyAŒRe„ªn˚Blocks
(
Æloˇt‹
->
›íSœb
->
ª„ªn˚Cou¡s
);

493 i‡(
ªsu…
 !
VDO_SUCCESS
) {

494  
ªsu…
;

497 
	`ªœxedAdd64
(&
Æloˇt‹
->
°©i°ics
.
¶absRe›íed
, 1);

502  
	`ÆloˇãSœbBlock
(
Æloˇt‹
->
›íSœb
, 
blockNumbîPå
);

503 
	}
}

506 
	$ªÀa£BlockRe„ªn˚
(
BlockAŒoˇt‹
 *
Æloˇt‹
,

507 
PhysiˇlBlockNumbî
 
pbn
,

508 c⁄° *
why
)

510 i‡(
pbn
 =
ZERO_BLOCK
) {

514 
Sœb
 *
¶ab
 = 
	`gëSœb
(
Æloˇt‹
->
dïŸ
, 
pbn
);

515 
Re„ªn˚O≥øti⁄
 
›î©i⁄
 = {

516 .
ty≥
 = 
DATA_DECREMENT
,

517 .
pbn
 =Öbn,

519 
ªsu…
 = 
	`modifySœbRe„ªn˚Cou¡
(
¶ab
, 
NULL
, 
›î©i⁄
);

520 i‡(
ªsu…
 !
VDO_SUCCESS
) {

521 
	`logEº‹WôhSåögEº‹
(
ªsu…
,

523 "physiˇ»block %" 
PRIu64
,

524 
why
, 
pbn
);

526 
	}
}

545 
	$com∑ªSœbSètu£s
(c⁄° *
ôem1
, c⁄° *
ôem2
)

547 c⁄° 
SœbSètus
 *
öfo1
 = (c⁄° SœbSètu†*Ë
ôem1
;

548 c⁄° 
SœbSètus
 *
öfo2
 = (c⁄° SœbSètu†*Ë
ôem2
;

550 i‡(
öfo1
->
isCÀ™
 !
öfo2
->isClean) {

551  (
öfo1
->
isCÀ™
 ? 1 : -1);

553 i‡(
öfo1
->
em±öess
 !
öfo2
->emptiness) {

554  ((
öfo1
->
em±öess
 > 
öfo2
->emptiness) ? 1 : -1);

556  ((
öfo1
->
¶abNumbî
 < 
öfo2
->slabNumber) ? 1 : -1);

557 
	}
}

560 
	$¥ï¨eSœbsF‹AŒoˇti⁄
(
BlockAŒoˇt‹
 *
Æloˇt‹
)

562 
	`ªœxedSt‹e64
(&
Æloˇt‹
->
°©i°ics
.
ÆloˇãdBlocks
,

563 
	`gëD©aBlockCou¡
(
Æloˇt‹
));

565 
SœbDïŸ
 *
dïŸ
 = 
Æloˇt‹
->depot;

566 
SœbCou¡
 
¶abCou¡
 = 
dïŸ
->slabCount;

568 
SœbSètus
 *
¶abSètu£s
;

569 
ªsu…
 = 
	`ALLOCATE
(
¶abCou¡
, 
SœbSètus
, 
__func__
, &
¶abSètu£s
);

570 i‡(
ªsu…
 !
VDO_SUCCESS
) {

571  
ªsu…
;

574 
	`gëSumm¨izedSœbSètu£s
(
Æloˇt‹
->
summ¨y
, 
¶abCou¡
, 
¶abSètu£s
);

577 
Hóp
 
hóp
;

578 
	`öôülizeHóp
(&
hóp
, 
com∑ªSœbSètu£s
, 
¶abSètu£s
, 
¶abCou¡
,

579 (
SœbSètus
));

580 
	`buûdHóp
(&
hóp
, 
¶abCou¡
);

582 
SœbSètus
 
cuºítSœbSètus
;

583 
	`p›MaxHópEÀmít
(&
hóp
, &
cuºítSœbSètus
)) {

584 
Sœb
 *
¶ab
 = 
dïŸ
->
¶abs
[
cuºítSœbSètus
.
¶abNumbî
];

585 i‡(
¶ab
->
Æloˇt‹
 !=állocator) {

589 i‡((
dïŸ
->
lﬂdTy≥
 =
NO_LOAD
)

590 || (!
	`mu°LﬂdRefCou¡s
(
Æloˇt‹
->
summ¨y
, 
¶ab
->
¶abNumbî
)

591 && 
cuºítSœbSètus
.
isCÀ™
)) {

592 
	`queueSœb
(
¶ab
);

596 
	`m¨kSœbUƒecovîed
(
¶ab
);

597 
boﬁ
 
highPri‹ôy


598 ((
cuºítSœbSètus
.
isCÀ™
 && (
dïŸ
->
lﬂdTy≥
 =
NORMAL_LOAD
))

599 || 
	`ªquúesS¸ubbög
(
¶ab
->
jou∫Æ
));

600 
	`ªgi°îSœbF‹S¸ubbög
(
Æloˇt‹
->
¶abS¸ubbî
, 
¶ab
, 
highPri‹ôy
);

602 
	`FREE
(
¶abSètu£s
);

604  
VDO_SUCCESS
;

605 
	}
}

608 
	$¥ï¨eAŒoˇt‹ToAŒoˇã
(
BlockAŒoˇt‹
 *
Æloˇt‹
,

609 
VDOCom∂ëi⁄
 *
∑ª¡
,

610 
VDOA˘i⁄
 *
ˇŒback
,

611 
VDOA˘i⁄
 *
îr‹H™dÀr
)

613 
ªsu…
 = 
	`¥ï¨eSœbsF‹AŒoˇti⁄
(
Æloˇt‹
);

614 i‡(
ªsu…
 !
VDO_SUCCESS
) {

615 
	`föishCom∂ëi⁄
(
∑ª¡
, 
ªsu…
);

619 
	`s¸ubHighPri‹ôySœbs
(
Æloˇt‹
->
¶abS¸ubbî
,

620 
	`isPri‹ôyTabÀEm±y
(
Æloˇt‹
->
¥i‹ôizedSœbs
),

621 
∑ª¡
, 
ˇŒback
, 
îr‹H™dÀr
);

622 
	}
}

625 
	$ªgi°îNewSœbsF‹AŒoˇt‹
(
BlockAŒoˇt‹
 *
Æloˇt‹
,

626 
VDOCom∂ëi⁄
 *
∑ª¡
,

627 
VDOA˘i⁄
 *
ˇŒback
,

628 
VDOA˘i⁄
 *
îr‹H™dÀr
)

630 
	`¥ï¨eCom∂ëi⁄
(&
Æloˇt‹
->
com∂ëi⁄
, 
ˇŒback
, 
îr‹H™dÀr
,

631 
∑ª¡
->
ˇŒbackThªadID
,Öarent);

632 
SœbDïŸ
 *
dïŸ
 = 
Æloˇt‹
->depot;

633 
SœbCou¡
 
i
 = 
dïŸ
->
¶abCou¡
; i < dïŸ->
√wSœbCou¡
; i++) {

634 
Sœb
 *
¶ab
 = 
dïŸ
->
√wSœbs
[
i
];

635 i‡(
¶ab
->
Æloˇt‹
 ==állocator) {

636 
	`ªgi°îSœbWôhAŒoˇt‹
(
Æloˇt‹
, 
¶ab
, 
åue
);

639 
	`föishCom∂ëi⁄
(&
Æloˇt‹
->
com∂ëi⁄
, 
VDO_SUCCESS
);

640 
	}
}

643 
	$su•ídSumm¨yZ⁄e
(
BlockAŒoˇt‹
 *
Æloˇt‹
,

644 
VDOCom∂ëi⁄
 *
∑ª¡
,

645 
VDOA˘i⁄
 *
ˇŒback
,

646 
VDOA˘i⁄
 *
îr‹H™dÀr
)

648 
	`¥ï¨eCom∂ëi⁄
(&
Æloˇt‹
->
com∂ëi⁄
, 
ˇŒback
, 
îr‹H™dÀr
,

649 
∑ª¡
->
ˇŒbackThªadID
,Öarent);

650 
	`su•ídSœbSumm¨yZ⁄e
(
Æloˇt‹
->
summ¨y
, &Æloˇt‹->
com∂ëi⁄
);

651 
	}
}

654 
	$ªsumeSumm¨yZ⁄e
(
BlockAŒoˇt‹
 *
Æloˇt‹
,

655 
VDOCom∂ëi⁄
 *
∑ª¡
,

656 
VDOA˘i⁄
 *
ˇŒback
,

657 
VDOA˘i⁄
 *
îr‹H™dÀr
)

659 
	`¥ï¨eCom∂ëi⁄
(&
Æloˇt‹
->
com∂ëi⁄
, 
ˇŒback
, 
îr‹H™dÀr
,

660 
∑ª¡
->
ˇŒbackThªadID
,Öarent);

661 
	`ªsumeSœbSumm¨yZ⁄e
(
Æloˇt‹
->
summ¨y
, &Æloˇt‹->
com∂ëi⁄
);

662 
	}
}

670 
	$föishSavögSœbs
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

672 
BlockAŒoˇt‹
 *
Æloˇt‹
 = 
com∂ëi⁄
->
∑ª¡
;

673 
	`˛o£SœbSumm¨yZ⁄e
(
Æloˇt‹
->
summ¨y
, &Æloˇt‹->
com∂ëi⁄
);

674 
	}
}

681 
	$h™dÀSœbSaveEº‹
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

684 
BlockAŒoˇt‹
 *
Æloˇt‹
 = 
com∂ëi⁄
->
∑ª¡
;

685 
	`£tCom∂ëi⁄Resu…
(&
Æloˇt‹
->
com∂ëi⁄
, com∂ëi⁄->
ªsu…
);

686 
	`föishSavögSœbs
(
com∂ëi⁄
);

687 
	}
}

694 
	$œunchSave
(
BlockAŒoˇt‹
 *
Æloˇt‹
)

696 
	`¥ï¨eCom∂ëi⁄
(
Æloˇt‹
->
¶abCom∂ëi⁄
, 
föishSavögSœbs
,

697 
h™dÀSœbSaveEº‹
, 
Æloˇt‹
->
thªadID
,állocator);

698 
	`ßveSœbs
(
Æloˇt‹
->
¶abCom∂ëi⁄
, 
	`gëSœbIãøt‹
(allocator));

699 
	}
}

702 
	$˛o£BlockAŒoˇt‹
(
BlockAŒoˇt‹
 *
Æloˇt‹
,

703 
VDOCom∂ëi⁄
 *
∑ª¡
,

704 
VDOA˘i⁄
 *
ˇŒback
,

705 
VDOA˘i⁄
 *
îr‹H™dÀr
)

707 
Æloˇt‹
->
ßveReque°ed
 = 
åue
;

708 
	`¥ï¨eCom∂ëi⁄
(&
Æloˇt‹
->
com∂ëi⁄
, 
ˇŒback
, 
îr‹H™dÀr
,

709 
∑ª¡
->
ˇŒbackThªadID
,Öarent);

710 i‡(
	`isS¸ubbög
(
Æloˇt‹
->
¶abS¸ubbî
)) {

711 
	`°›S¸ubbög
(
Æloˇt‹
->
¶abS¸ubbî
);

713 
	`œunchSave
(
Æloˇt‹
);

715 
	}
}

718 
	$ßveBlockAŒoˇt‹F‹FuŒRebuûd
(
BlockAŒoˇt‹
 *
Æloˇt‹
,

719 
VDOCom∂ëi⁄
 *
∑ª¡
,

720 
VDOA˘i⁄
 *
ˇŒback
,

721 
VDOA˘i⁄
 *
îr‹H™dÀr
)

723 
	`¥ï¨eCom∂ëi⁄
(
Æloˇt‹
->
¶abCom∂ëi⁄
, 
ˇŒback
, 
îr‹H™dÀr
,

724 
∑ª¡
->
ˇŒbackThªadID
,Öarent);

725 
	`ßveFuŒyRebuûtSœbs
(
Æloˇt‹
->
¶abCom∂ëi⁄
, 
	`gëSœbIãøt‹
(allocator));

726 
	}
}

735 
	$föishFlushögSœbJou∫Æs
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

737 
BlockAŒoˇt‹
 *
Æloˇt‹
 = 
com∂ëi⁄
->
∑ª¡
;

738 
	`ßveSœbSumm¨yZ⁄e
(
Æloˇt‹
->
summ¨y
, &Æloˇt‹->
com∂ëi⁄
);

739 
	}
}

746 
	$h™dÀFlushEº‹
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

749 
BlockAŒoˇt‹
 *
Æloˇt‹
 = 
com∂ëi⁄
->
∑ª¡
;

750 
	`£tCom∂ëi⁄Resu…
(&
Æloˇt‹
->
com∂ëi⁄
, com∂ëi⁄->
ªsu…
);

751 
	`föishFlushögSœbJou∫Æs
(
com∂ëi⁄
);

752 
	}
}

755 
	$ÊushAŒoˇt‹SœbJou∫Æs
(
BlockAŒoˇt‹
 *
Æloˇt‹
,

756 
VDOCom∂ëi⁄
 *
∑ª¡
,

757 
VDOA˘i⁄
 
ˇŒback
,

758 
VDOA˘i⁄
 *
îr‹H™dÀr
)

760 
	`¥ï¨eCom∂ëi⁄
(&
Æloˇt‹
->
com∂ëi⁄
, 
ˇŒback
, 
îr‹H™dÀr
,

761 
∑ª¡
->
ˇŒbackThªadID
,Öarent);

762 
	`¥ï¨eCom∂ëi⁄
(
Æloˇt‹
->
¶abCom∂ëi⁄
, 
föishFlushögSœbJou∫Æs
,

763 
h™dÀFlushEº‹
, 
Æloˇt‹
->
thªadID
,állocator);

764 
	`ÊushSœbJou∫Æs
(
Æloˇt‹
->
¶abCom∂ëi⁄
, 
	`gëSœbIãøt‹
(allocator));

765 
	}
}

768 
	$ßveRebuûtSœb
(
Sœb
 *
¶ab
,

769 
VDOCom∂ëi⁄
 *
∑ª¡
,

770 
VDOA˘i⁄
 *
ˇŒback
,

771 
VDOA˘i⁄
 *
îr‹H™dÀr
)

773 
BlockAŒoˇt‹
 *
Æloˇt‹
 = 
¶ab
->allocator;

774 
	`¥ï¨eCom∂ëi⁄
(
Æloˇt‹
->
¶abCom∂ëi⁄
, 
ˇŒback
, 
îr‹H™dÀr
,

775 
∑ª¡
->
ˇŒbackThªadID
,Öarent);

776 
	`ßveSœb
(
Æloˇt‹
->
¶abCom∂ëi⁄
, 
¶ab
);

777 
	}
}

780 
	$ªÀa£TaûBlockLocks
(
BlockAŒoˇt‹
 *
Æloˇt‹
,

781 
VDOCom∂ëi⁄
 *
∑ª¡
,

782 
VDOA˘i⁄
 *
ˇŒback
,

783 
VDOA˘i⁄
 *
îr‹H™dÀr
)

785 
	`¥ï¨eCom∂ëi⁄
(&
Æloˇt‹
->
com∂ëi⁄
, 
ˇŒback
, 
îr‹H™dÀr
,

786 
∑ª¡
->
ˇŒbackThªadID
,Öarent);

787 
RögNode
 *
rög
 = &
Æloˇt‹
->
dútySœbJou∫Æs
;

788 !
	`isRögEm±y
(
rög
)) {

789 i‡(!
	`ªÀa£RecovîyJou∫ÆLock
(
	`¶abJou∫ÆFromDútyNode
(
rög
->
√xt
),

790 
Æloˇt‹
->
dïŸ
->
a˘iveRñó£Reque°
)) {

794 
	`com∂ëeCom∂ëi⁄
(&
Æloˇt‹
->
com∂ëi⁄
);

795 
	}
}

798 
SœbSumm¨yZ⁄e
 *
	$gëSœbSumm¨yZ⁄e
(c⁄° 
BlockAŒoˇt‹
 *
Æloˇt‹
)

800  
Æloˇt‹
->
summ¨y
;

801 
	}
}

804 
	$acquúeBlockDes¸ùt‹
(
BlockAŒoˇt‹
 *
Æloˇt‹
, 
Waôî
 *
waôî
)

806  
	`acquúeE¡ryFromObje˘Poﬁ
(
Æloˇt‹
->
blockDes¸ùt‹Poﬁ
, 
waôî
);

807 
	}
}

810 
	$ªtu∫BlockDes¸ùt‹
(
BlockAŒoˇt‹
 *
Æloˇt‹
,

811 
BlockDes¸ùt‹
 *
des¸ùt‹
)

813 
	`ªtu∫E¡ryToObje˘Poﬁ
(
Æloˇt‹
->
blockDes¸ùt‹Poﬁ
,

814 &
des¸ùt‹
->
rögNode
);

815 
	}
}

818 
	$acquúeVIO
(
BlockAŒoˇt‹
 *
Æloˇt‹
, 
Waôî
 *
waôî
)

820  
	`acquúeVIOFromPoﬁ
(
Æloˇt‹
->
vioPoﬁ
, 
waôî
);

821 
	}
}

824 
	$ªtu∫VIO
(
BlockAŒoˇt‹
 *
Æloˇt‹
, 
VIOPoﬁE¡ry
 *
íåy
)

826 
	`ªtu∫VIOToPoﬁ
(
Æloˇt‹
->
vioPoﬁ
, 
íåy
);

827 
	}
}

835 
	$s¸ubbîFöished
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

837 
BlockAŒoˇt‹
 *
Æloˇt‹
 = 
com∂ëi⁄
->
∑ª¡
;

838 
	`nŸifyZ⁄eSt›≥dS¸ubbög
(
Æloˇt‹
->
dïŸ
);

839 i‡(
Æloˇt‹
->
ßveReque°ed
) {

840 
	`œunchSave
(
Æloˇt‹
);

842 
	}
}

845 
	$s¸ubAŒUƒecovîedSœbsInZ⁄e
(
BlockAŒoˇt‹
 *
Æloˇt‹
,

846 
VDOCom∂ëi⁄
 *
∑ª¡
,

847 
VDOA˘i⁄
 *
ˇŒback
,

848 
VDOA˘i⁄
 *
îr‹H™dÀr
)

850 
	`¥ï¨eCom∂ëi⁄
(&
Æloˇt‹
->
com∂ëi⁄
, 
ˇŒback
, 
îr‹H™dÀr
,

851 
∑ª¡
->
ˇŒbackThªadID
,Öarent);

852 
	`s¸ubSœbs
(
Æloˇt‹
->
¶abS¸ubbî
,áŒoˇt‹, 
s¸ubbîFöished
,

853 
s¸ubbîFöished
, 
Æloˇt‹
->
thªadID
);

854 
	`com∂ëeCom∂ëi⁄
(&
Æloˇt‹
->
com∂ëi⁄
);

855 
	}
}

858 
	$íqueueF‹CÀ™Sœb
(
BlockAŒoˇt‹
 *
Æloˇt‹
, 
Waôî
 *
waôî
)

860  
	`íqueueCÀ™SœbWaôî
(
Æloˇt‹
->
¶abS¸ubbî
, 
waôî
);

861 
	}
}

864 
	$ö¸ó£S¸ubbögPri‹ôy
(
Sœb
 *
¶ab
)

866 
	`ªgi°îSœbF‹S¸ubbög
(
¶ab
->
Æloˇt‹
->
¶abS¸ubbî
, sœb, 
åue
);

867 
	}
}

870 
	$ÆloˇãFromAŒoˇt‹La°Sœb
(
BlockAŒoˇt‹
 *
Æloˇt‹
)

872 
	`ASSERT_LOG_ONLY
(
Æloˇt‹
->
›íSœb
 =
NULL
, "mustn't haveán open slab");

873 
Sœb
 *
œ°Sœb
 = 
Æloˇt‹
->
dïŸ
->
¶abs
[allocator->lastSlab];

874 
	`¥i‹ôyTabÀRemove
(
Æloˇt‹
->
¥i‹ôizedSœbs
, &
œ°Sœb
->
rögNode
);

875 
Æloˇt‹
->
›íSœb
 = 
œ°Sœb
;

876 
	}
}

879 
BlockAŒoˇt‹Sèti°ics


880 
	$gëBlockAŒoˇt‹Sèti°ics
(c⁄° 
BlockAŒoˇt‹
 *
Æloˇt‹
)

882 c⁄° 
AtomicAŒoˇt‹Sèti°ics
 *
©oms
 = &
Æloˇt‹
->
°©i°ics
;

883  (
BlockAŒoˇt‹Sèti°ics
) {

884 .
¶abCou¡
 = 
Æloˇt‹
->slabCount,

885 .
¶absO≥√d
 = 
	`ªœxedLﬂd64
(&
©oms
->slabsOpened),

886 .
¶absRe›íed
 = 
	`ªœxedLﬂd64
(&
©oms
->slabsReopened),

888 
	}
}

891 
SœbJou∫ÆSèti°ics
 
	$gëSœbJou∫ÆSèti°ics
(c⁄° 
BlockAŒoˇt‹
 *
Æloˇt‹
)

893 c⁄° 
AtomicSœbJou∫ÆSèti°ics
 *
©oms
 = &
Æloˇt‹
->
¶abJou∫ÆSèti°ics
;

894  (
SœbJou∫ÆSèti°ics
) {

895 .
diskFuŒCou¡
 = 
	`©omicLﬂd64
(&
©oms
->diskFullCount),

896 .
ÊushCou¡
 = 
	`©omicLﬂd64
(&
©oms
->flushCount),

897 .
blockedCou¡
 = 
	`©omicLﬂd64
(&
©oms
->blockedCount),

898 .
blocksWrôãn
 = 
	`©omicLﬂd64
(&
©oms
->blocksWritten),

899 .
èûBusyCou¡
 = 
	`©omicLﬂd64
(&
©oms
->tailBusyCount),

901 
	}
}

904 
RefCou¡sSèti°ics
 
	$gëRefCou¡sSèti°ics
(c⁄° 
BlockAŒoˇt‹
 *
Æloˇt‹
)

906 c⁄° 
AtomicRefCou¡Sèti°ics
 *
©oms
 = &
Æloˇt‹
->
ªfCou¡Sèti°ics
;

907  (
RefCou¡sSèti°ics
) {

908 .
blocksWrôãn
 = 
	`©omicLﬂd64
(&
©oms
->blocksWritten),

910 
	}
}

913 
	$dumpBlockAŒoˇt‹
(c⁄° 
BlockAŒoˇt‹
 *
Æloˇt‹
)

915 
∑u£Cou¡î
 = 0;

916 
	`logInfo
("BlockAŒoˇt‹ z⁄ê%u", 
Æloˇt‹
->
z⁄eNumbî
);

917 
SœbIãøt‹
 
ôî©‹
 = 
	`gëSœbIãøt‹
(
Æloˇt‹
);

918 
	`hasNextSœb
(&
ôî©‹
)) {

919 
	`dumpSœb
(
	`√xtSœb
(&
ôî©‹
));

923 i‡(
∑u£Cou¡î
++ == 31) {

924 
∑u£Cou¡î
 = 0;

925 
	`∑u£F‹Loggî
();

929 
	`dumpSœbS¸ubbî
(
Æloˇt‹
->
¶abS¸ubbî
);

930 
	}
}

	@vdo/base/blockAllocator.h

22 #i‚de‡
BLOCK_ALLOCATOR_H


23 
	#BLOCK_ALLOCATOR_H


	)

25 
	~"blockDes¸ùt‹.h
"

26 
	~"com∂ëi⁄.h
"

27 
	~"fixedLayout.h
"

28 
	~"°©i°ics.h
"

29 
	~"ty≥s.h
"

30 
	~"vioPoﬁ.h
"

31 
	~"waôQueue.h
"

48 
	$makeBlockAŒoˇt‹
(
SœbDïŸ
 *
dïŸ
,

49 
Z⁄eCou¡
 
z⁄eNumbî
,

50 
ThªadID
 
thªadID
,

51 
N⁄˚
 
n⁄˚
,

52 
BlockCou¡
 
vioPoﬁSize
,

53 
BlockCou¡
 
des¸ùt‹PoﬁSize
,

54 
PhysiˇlLayî
 *
œyî
,

55 
RódO∆yModeC⁄ãxt
 *
ªadO∆yC⁄ãxt
,

56 
BlockAŒoˇt‹
 **
Æloˇt‹På
)

57 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

64 
	`‰ìBlockAŒoˇt‹
(
BlockAŒoˇt‹
 **
blockAŒoˇt‹På
);

71 
	`nŸifyBlockAŒoˇt‹OfRódO∆yMode
(
BlockAŒoˇt‹
 *
Æloˇt‹
);

78 
	`queueSœb
(
Sœb
 *
¶ab
);

89 
	`adju°FªeBlockCou¡
(
Sœb
 *
¶ab
, 
boﬁ
 
ö¸emít
);

104 
	$ÆloˇãBlock
(
BlockAŒoˇt‹
 *
Æloˇt‹
,

105 
PhysiˇlBlockNumbî
 *
blockNumbîPå
)

106 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

115 
	`ªÀa£BlockRe„ªn˚
(
BlockAŒoˇt‹
 *
Æloˇt‹
,

116 
PhysiˇlBlockNumbî
 
pbn
,

117 c⁄° *
why
);

127 
BlockCou¡
 
	$gëAŒoˇãdBlocks
(c⁄° 
BlockAŒoˇt‹
 *
Æloˇt‹
)

128 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

137 
BlockCou¡
 
	$gëUƒecovîedSœbCou¡
(c⁄° 
BlockAŒoˇt‹
 *
Æloˇt‹
)

138 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

149 
	`¥ï¨eAŒoˇt‹ToAŒoˇã
(
BlockAŒoˇt‹
 *
Æloˇt‹
,

150 
VDOCom∂ëi⁄
 *
∑ª¡
,

151 
VDOA˘i⁄
 *
ˇŒback
,

152 
VDOA˘i⁄
 *
îr‹H™dÀr
);

161 
	`ªgi°îSœbWôhAŒoˇt‹
(
BlockAŒoˇt‹
 *
Æloˇt‹
,

162 
Sœb
 *
¶ab
,

163 
boﬁ
 
ªsizög
);

174 
	`ªgi°îNewSœbsF‹AŒoˇt‹
(
BlockAŒoˇt‹
 *
Æloˇt‹
,

175 
VDOCom∂ëi⁄
 *
∑ª¡
,

176 
VDOA˘i⁄
 *
ˇŒback
,

177 
VDOA˘i⁄
 *
îr‹H™dÀr
);

188 
	`ÊushAŒoˇt‹SœbJou∫Æs
(
BlockAŒoˇt‹
 *
Æloˇt‹
,

189 
VDOCom∂ëi⁄
 *
∑ª¡
,

190 
VDOA˘i⁄
 
ˇŒback
,

191 
VDOA˘i⁄
 *
îr‹H™dÀr
);

202 
	`su•ídSumm¨yZ⁄e
(
BlockAŒoˇt‹
 *
Æloˇt‹
,

203 
VDOCom∂ëi⁄
 *
∑ª¡
,

204 
VDOA˘i⁄
 *
ˇŒback
,

205 
VDOA˘i⁄
 *
îr‹H™dÀr
);

216 
	`ªsumeSumm¨yZ⁄e
(
BlockAŒoˇt‹
 *
Æloˇt‹
,

217 
VDOCom∂ëi⁄
 *
∑ª¡
,

218 
VDOA˘i⁄
 *
ˇŒback
,

219 
VDOA˘i⁄
 *
îr‹H™dÀr
);

230 
	`˛o£BlockAŒoˇt‹
(
BlockAŒoˇt‹
 *
Æloˇt‹
,

231 
VDOCom∂ëi⁄
 *
∑ª¡
,

232 
VDOA˘i⁄
 *
ˇŒback
,

233 
VDOA˘i⁄
 *
îr‹H™dÀr
);

244 
	`ßveBlockAŒoˇt‹F‹FuŒRebuûd
(
BlockAŒoˇt‹
 *
Æloˇt‹
,

245 
VDOCom∂ëi⁄
 *
∑ª¡
,

246 
VDOA˘i⁄
 *
ˇŒback
,

247 
VDOA˘i⁄
 *
îr‹H™dÀr
);

257 
	`ßveRebuûtSœb
(
Sœb
 *
¶ab
,

258 
VDOCom∂ëi⁄
 *
∑ª¡
,

259 
VDOA˘i⁄
 *
ˇŒback
,

260 
VDOA˘i⁄
 *
îr‹H™dÀr
);

271 
	`ªÀa£TaûBlockLocks
(
BlockAŒoˇt‹
 *
Æloˇt‹
,

272 
VDOCom∂ëi⁄
 *
∑ª¡
,

273 
VDOA˘i⁄
 *
ˇŒback
,

274 
VDOA˘i⁄
 *
îr‹H™dÀr
);

283 
SœbSumm¨yZ⁄e
 *
	$gëSœbSumm¨yZ⁄e
(c⁄° 
BlockAŒoˇt‹
 *
Æloˇt‹
)

284 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

295 
	$acquúeBlockDes¸ùt‹
(
BlockAŒoˇt‹
 *
Æloˇt‹
, 
Waôî
 *
waôî
)

296 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

304 
	`ªtu∫BlockDes¸ùt‹
(
BlockAŒoˇt‹
 *
Æloˇt‹
,

305 
BlockDes¸ùt‹
 *
des¸ùt‹
);

315 
	$acquúeVIO
(
BlockAŒoˇt‹
 *
Æloˇt‹
, 
Waôî
 *
waôî
)

316 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

324 
	`ªtu∫VIO
(
BlockAŒoˇt‹
 *
Æloˇt‹
, 
VIOPoﬁE¡ry
 *
íåy
);

334 
	`s¸ubAŒUƒecovîedSœbsInZ⁄e
(
BlockAŒoˇt‹
 *
Æloˇt‹
,

335 
VDOCom∂ëi⁄
 *
∑ª¡
,

336 
VDOA˘i⁄
 *
ˇŒback
,

337 
VDOA˘i⁄
 *
îr‹H™dÀr
);

348 
	$íqueueF‹CÀ™Sœb
(
BlockAŒoˇt‹
 *
Æloˇt‹
, 
Waôî
 *
waôî
)

349 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

356 
	`ö¸ó£S¸ubbögPri‹ôy
(
Sœb
 *
¶ab
);

365 
BlockAŒoˇt‹Sèti°ics


366 
	$gëBlockAŒoˇt‹Sèti°ics
(c⁄° 
BlockAŒoˇt‹
 *
Æloˇt‹
)

367 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

376 
SœbJou∫ÆSèti°ics
 
	$gëSœbJou∫ÆSèti°ics
(c⁄° 
BlockAŒoˇt‹
 *
Æloˇt‹
)

377 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

386 
RefCou¡sSèti°ics
 
	$gëRefCou¡sSèti°ics
(c⁄° 
BlockAŒoˇt‹
 *
Æloˇt‹
)

387 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

394 
	`dumpBlockAŒoˇt‹
(c⁄° 
BlockAŒoˇt‹
 *
Æloˇt‹
);

	@vdo/base/blockAllocatorInternals.h

22 #i‚de‡
BLOCK_ALLOCATOR_INTERNALS_H


23 
	#BLOCK_ALLOCATOR_INTERNALS_H


	)

25 
	~"utû/©omic.h
"

27 
	~"blockAŒoˇt‹.h
"

28 
	~"¥i‹ôyTabÀ.h
"

29 
	~"rögNode.h
"

30 
	~"¶abS¸ubbî.h
"

37 
	mBLOCK_DESCRIPTOR_POOL_SIZE
 = 256,

38 
	mVIO_POOL_SIZE
 = 128,

42 
VDOCom∂ëi⁄
 
	mcom∂ëi⁄
;

43 
RögNode
 *
	mrögToS¸ub
;

44 } 
	tSœbRögRebuûdCom∂ëi⁄
;

50 
	s©omicAŒoˇt‹Sèti°ics
 {

52 
Atomic64
 
	mÆloˇãdBlocks
;

54 
Atomic64
 
	m¶absO≥√d
;

56 
Atomic64
 
	m¶absRe›íed
;

57 } 
	tAtomicAŒoˇt‹Sèti°ics
;

65 
	s©omicSœbJou∫ÆSèti°ics
 {

67 
Atomic64
 
	mdiskFuŒCou¡
;

69 
Atomic64
 
	mÊushCou¡
;

71 
Atomic64
 
	mblockedCou¡
;

73 
Atomic64
 
	mblocksWrôãn
;

75 
Atomic64
 
	mèûBusyCou¡
;

76 } 
	tAtomicSœbJou∫ÆSèti°ics
;

84 
	s©omicRefCou¡Sèti°ics
 {

86 
Atomic64
 
	mblocksWrôãn
;

87 } 
	tAtomicRefCou¡Sèti°ics
;

89 
	sblockAŒoˇt‹
 {

90 
VDOCom∂ëi⁄
 
	mcom∂ëi⁄
;

92 
SœbDïŸ
 *
	mdïŸ
;

94 
SœbSumm¨yZ⁄e
 *
	msumm¨y
;

96 
RódO∆yModeC⁄ãxt
 *
	mªadO∆yC⁄ãxt
;

98 
N⁄˚
 
	mn⁄˚
;

100 
Z⁄eCou¡
 
	mz⁄eNumbî
;

102 
ThªadID
 
	mthªadID
;

104 
SœbCou¡
 
	m¶abCou¡
;

106 
SœbCou¡
 
	mœ°Sœb
;

108 
	mun›íedSœbPri‹ôy
;

110 
boﬁ
 
	mßveReque°ed
;

113 
Sœb
 *
	m›íSœb
;

115 
Pri‹ôyTabÀ
 *
	m¥i‹ôizedSœbs
;

117 
SœbS¸ubbî
 *
	m¶abS¸ubbî
;

119 
VDOCom∂ëi⁄
 *
	m¶abCom∂ëi⁄
;

122 
AtomicAŒoˇt‹Sèti°ics
 
	m°©i°ics
;

124 
AtomicSœbJou∫ÆSèti°ics
 
	m¶abJou∫ÆSèti°ics
;

126 
AtomicRefCou¡Sèti°ics
 
	mªfCou¡Sèti°ics
;

136 
RögNode
 
	mdútySœbJou∫Æs
;

139 
Obje˘Poﬁ
 *
	mvioPoﬁ
;

142 
Obje˘Poﬁ
 *
	mblockDes¸ùt‹Poﬁ
;

150 
	$makeAŒoˇt‹PoﬁVIOs
(
PhysiˇlLayî
 *
œyî
,

151 *
∑ª¡
,

152 *
buf„r
,

153 
VIO
 **
vioPå
)

154 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

165 
	$ª∂a˚Des¸ùt‹Poﬁ
(
BlockAŒoˇt‹
 *
Æloˇt‹
, 
size_t
 
size
)

166 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

178 
	$ª∂a˚VIOPoﬁ
(
BlockAŒoˇt‹
 *
Æloˇt‹
,

179 
size_t
 
size
,

180 
PhysiˇlLayî
 *
œyî
)

181 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

191 
	$¥ï¨eSœbsF‹AŒoˇti⁄
(
BlockAŒoˇt‹
 *
Æloˇt‹
)

192 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

199 
	`ÆloˇãFromAŒoˇt‹La°Sœb
(
BlockAŒoˇt‹
 *
Æloˇt‹
);

	@vdo/base/blockDescriptor.h

22 #i‚de‡
BLOCK_DESCRIPTOR_H


23 
	#BLOCK_DESCRIPTOR_H


	)

25 
	~"≥rmas£π.h
"

27 
	~"rögNode.h
"

28 
	~"ty≥s.h
"

31 
RögNode
 
	mrögNode
;

32 
SœbJou∫Æ
 *
	mjou∫Æ
;

33 
Sequí˚Numbî
 
	m£quí˚Numbî
;

34 } 
	tBlockDes¸ùt‹
;

43 
__©åibuã__
((
w¨n_unu£d_ªsu…
))

44 
ölöe
 
BlockDes¸ùt‹
 *
	$asBlockDes¸ùt‹
(
RögNode
 *
node
)

46 
	`STATIC_ASSERT
(
	`off£tof
(
BlockDes¸ùt‹
, 
rögNode
) == 0);

47  (
BlockDes¸ùt‹
 *Ë
node
;

48 
	}
}

	@vdo/base/blockMap.c

22 
	~"blockM≠.h
"

24 
	~"loggî.h
"

25 
	~"mem‹yAŒoc.h
"

26 
	~"≥rmas£π.h
"

28 
	~"blockM≠I¡î«ls.h
"

29 
	~"blockM≠Page.h
"

30 
	~"blockM≠Tªe.h
"

31 
	~"c⁄°™ts.h
"

32 
	~"d©aVIO.h
"

33 
	~"f‹e°.h
"

34 
	~"numUtûs.h
"

35 
	~"obje˘Poﬁ.h
"

36 
	~"ªcovîyJou∫Æ.h
"

37 
	~"°©usCodes.h
"

38 
	~"ty≥s.h
"

39 
	~"vdoI¡î«l.h
"

40 
	~"vioPoﬁ.h
"

43 
PhysiˇlBlockNumbî
 
	mÊ©PageOrigö
;

44 
BlockCou¡
 
	mÊ©PageCou¡
;

45 
PhysiˇlBlockNumbî
 
	mroŸOrigö
;

46 
BlockCou¡
 
	mroŸCou¡
;

47 } 
	t__©åibuã__
((
	t∑cked
)Ë
	tBlockM≠Sèã2_0
;

49 c⁄° 
Hódî
 
	gBLOCK_MAP_HEADER_2_0
 = {

50 .
id
 = 
BLOCK_MAP
,

51 .
	gvîsi⁄
 = {

52 .
maj‹Vîsi⁄
 = 2,

53 .
	gmö‹Vîsi⁄
 = 0,

55 .
	gsize
 = (
BlockM≠Sèã2_0
),

58 c⁄° 
Hódî
 *
	gCURRENT_BLOCK_MAP_HEADER
 = &
BLOCK_MAP_HEADER_2_0
;

63 
	$vÆid©ePageOnRód
(*
buf„r
,

64 
PhysiˇlBlockNumbî
 
pbn
,

65 *
c⁄ãxt
)

67 
BlockM≠Page
 *
∑ge
 = (BlockM≠Pagê*Ë
buf„r
;

68 
N⁄˚
 
n⁄˚
 = ((
BlockM≠Z⁄e
 *Ë
c⁄ãxt
)->
blockM≠
->nonce;

69 
BlockM≠PageVÆidôy
 
vÆidôy
 = 
	`vÆid©eBlockM≠Page
(
∑ge
, 
n⁄˚
, 
pbn
);

70 i‡(
vÆidôy
 =
BLOCK_MAP_PAGE_BAD
) {

71  
	`logEº‹WôhSåögEº‹
(
VDO_BAD_PAGE
,

72 "Ex≥˘edÖagê%" 
PRIu64


73 " buàgŸÖagê%" 
PRIu64
 " instead",

74 
pbn
, 
∑ge
->
hódî
.pbn);

77 i‡(
vÆidôy
 =
BLOCK_MAP_PAGE_INVALID
) {

78 
	`f‹m©BlockM≠Page
(
∑ge
, 
n⁄˚
, 
pbn
);

81  
VDO_SUCCESS
;

82 
	}
}

89 
boﬁ
 
	$h™dÀPageWrôe
(*
øwPage
, *
c⁄ãxt
)

91 
BlockM≠Z⁄e
 *
z⁄e
 = 
c⁄ãxt
;

92 
BlockM≠Page
 *
∑ge
 = (BlockM≠Pagê*Ë
øwPage
;

94 i‡(!
∑ge
->
hódî
.
öôülized
) {

95 
∑ge
->
hódî
.
öôülized
 = 
åue
;

97  
åue
;

101 
	`ªÀa£RecovîyJou∫ÆBlockRe„ªn˚
(
z⁄e
->
blockM≠
->
jou∫Æ
,

102 
∑ge
->
hódî
.
ªcovîySequí˚Numbî
,

103 
ZONE_TYPE_LOGICAL
, 
z⁄e
->
z⁄eNumbî
);

104 
∑ge
->
hódî
.
ªcovîySequí˚Numbî
 = 0;

105  
Ál£
;

106 
	}
}

109 
PageCou¡
 
	$compuãBlockM≠PageCou¡
(
BlockCou¡
 
íåõs
)

111  
	`compuãBuckëCou¡
(
íåõs
, 
BLOCK_MAP_ENTRIES_PER_PAGE
);

112 
	}
}

115 
BlockCou¡
 
	$compuãBlockM≠Size
(
BlockCou¡
 
tŸÆE¡rõs
,

116 
BlockCou¡
 
¶abSize
,

117 
BlockCou¡
 
d©aBlocksPîSœb
)

119 
uöt64_t
 
∑geCou¡
 = 
	`compuãBlockM≠PageCou¡
(
tŸÆE¡rõs
);

121 
uöt64_t
 
¶abCou¡
 = 
	`compuãBuckëCou¡
(
∑geCou¡
, 
d©aBlocksPîSœb
);

122  (
¶abCou¡
 * 
¶abSize
);

123 
	}
}

126 
	$makeBlockM≠
(
BlockCou¡
 
logiˇlBlocks
,

127 c⁄° 
ThªadC⁄fig
 *
thªadC⁄fig
,

128 
BlockCou¡
 
Ê©PageCou¡
,

129 
PhysiˇlBlockNumbî
 
roŸOrigö
,

130 
BlockCou¡
 
roŸCou¡
,

131 
BlockM≠
 **
m≠På
)

133 
	`STATIC_ASSERT
(
BLOCK_MAP_ENTRIES_PER_PAGE


134 =((
VDO_BLOCK_SIZE
 - (
BlockM≠Page
))

135 / (
BlockM≠E¡ry
)));

137 
BlockM≠
 *
m≠
;

138 
ªsu…
 = 
	`ALLOCATE_EXTENDED
(
BlockM≠
, 
thªadC⁄fig
->
logiˇlZ⁄eCou¡
,

139 
BlockM≠Z⁄e
, 
__func__
, &
m≠
);

140 i‡(
ªsu…
 !
UDS_SUCCESS
) {

141  
ªsu…
;

144 
m≠
->
Ê©PageCou¡
 = flatPageCount;

145 
m≠
->
roŸOrigö
 =ÑootOrigin;

146 
m≠
->
roŸCou¡
 =ÑootCount;

147 
m≠
->
íåyCou¡
 = 
logiˇlBlocks
;

148 
m≠
->
ªcovîyJou∫ÆThªadID
 = 
	`gëJou∫ÆZ⁄eThªad
(
thªadC⁄fig
);

150 
Z⁄eCou¡
 
z⁄eCou¡
 = 
thªadC⁄fig
->
logiˇlZ⁄eCou¡
;

151 
Z⁄eCou¡
 
z⁄e
 = 0; z⁄ê< 
z⁄eCou¡
; zone++) {

152 
BlockM≠Z⁄e
 *
blockM≠Z⁄e
 = &
m≠
->
z⁄es
[
z⁄e
];

153 
blockM≠Z⁄e
->
z⁄eNumbî
 = 
z⁄e
;

154 
blockM≠Z⁄e
->
thªadID
 = 
	`gëLogiˇlZ⁄eThªad
(
thªadC⁄fig
, 
z⁄e
);

155 
blockM≠Z⁄e
->
blockM≠
 = 
m≠
;

156 
m≠
->
z⁄eCou¡
++;

159 *
m≠På
 = 
m≠
;

160  
VDO_SUCCESS
;

161 
	}
}

164 
	$decodeBlockM≠
(
Buf„r
 *
buf„r
,

165 
BlockCou¡
 
logiˇlBlocks
,

166 c⁄° 
ThªadC⁄fig
 *
thªadC⁄fig
,

167 
BlockM≠
 **
m≠På
)

169 
Hódî
 
hódî
;

170 
ªsu…
 = 
	`decodeHódî
(
buf„r
, &
hódî
);

171 i‡(
ªsu…
 !
VDO_SUCCESS
) {

172  
ªsu…
;

175 
ªsu…
 = 
	`vÆid©eHódî
(
CURRENT_BLOCK_MAP_HEADER
, &
hódî
, 
åue
, 
__func__
);

176 i‡(
ªsu…
 !
VDO_SUCCESS
) {

177  
ªsu…
;

180 
BlockM≠Sèã2_0
 
°©e
;

181 
ªsu…
 = 
	`gëByãsFromBuf„r
(
buf„r
, (
°©e
), &state);

182 i‡(
ªsu…
 !
UDS_SUCCESS
) {

183  
ªsu…
;

186 
ªsu…
 = 
	`ASSERT
(
°©e
.
Ê©PageOrigö
 =
BLOCK_MAP_FLAT_PAGE_ORIGIN
,

188 
PRIu64
 ")", 
BLOCK_MAP_FLAT_PAGE_ORIGIN
,

189 
°©e
.
Ê©PageOrigö
);

190 i‡(
ªsu…
 !
UDS_SUCCESS
) {

191  
ªsu…
;

194 
BlockM≠
 *
m≠
;

195 
ªsu…
 = 
	`makeBlockM≠
(
logiˇlBlocks
, 
thªadC⁄fig
,

196 
°©e
.
Ê©PageCou¡
, sèã.
roŸOrigö
,

197 
°©e
.
roŸCou¡
, &
m≠
);

198 i‡(
ªsu…
 !
VDO_SUCCESS
) {

199  
ªsu…
;

202 *
m≠På
 = 
m≠
;

203  
VDO_SUCCESS
;

204 
	}
}

207 
	$decodeSodiumBlockM≠
(
Buf„r
 *
buf„r
,

208 
BlockCou¡
 
logiˇlBlocks
,

209 c⁄° 
ThªadC⁄fig
 *
thªadC⁄fig
,

210 
BlockM≠
 **
m≠På
)

213  
	`decodeBlockM≠
(
buf„r
, 
logiˇlBlocks
, 
thªadC⁄fig
, 
m≠På
);

214 
	}
}

228 
__©åibuã__
((
w¨n_unu£d_ªsu…
))

229 
	$öôülizeBlockM≠Z⁄e
(
BlockM≠Z⁄e
 *
z⁄e
,

230 
PhysiˇlLayî
 *
œyî
,

231 
RódO∆yModeC⁄ãxt
 *
ªadO∆yC⁄ãxt
,

232 
PageCou¡
 
ˇcheSize
,

233 
BlockCou¡
 
maximumAge
)

235 
	`STATIC_ASSERT
(
	`off£tof
(
BlockM≠Z⁄e
, 
com∂ëi⁄
) == 0);

236 
	`öôülizeCom∂ëi⁄
(&
z⁄e
->
com∂ëi⁄
, 
BLOCK_MAP_ZONE_COMPLETION
, 
œyî
);

237 
ªsu…
 = 
	`öôülizeTªeZ⁄e
(
z⁄e
, 
œyî
, 
ªadO∆yC⁄ãxt
, 
maximumAge
);

238 i‡(
ªsu…
 !
VDO_SUCCESS
) {

239  
ªsu…
;

242  
	`makeVDOPageCache
(
z⁄e
->
thªadID
, 
œyî
, 
ªadO∆yC⁄ãxt
, 
ˇcheSize
,

243 
vÆid©ePageOnRód
, 
h™dÀPageWrôe
, 
z⁄e
,

244 
maximumAge
, &
z⁄e
->
∑geCache
);

245 
	}
}

248 
	$makeBlockM≠Caches
(
BlockM≠
 *
m≠
,

249 
PhysiˇlLayî
 *
œyî
,

250 
RódO∆yModeC⁄ãxt
 *
ªadO∆yC⁄ãxt
,

251 
RecovîyJou∫Æ
 *
jou∫Æ
,

252 
N⁄˚
 
n⁄˚
,

253 
PageCou¡
 
ˇcheSize
,

254 
BlockCou¡
 
maximumAge
)

256 
ªsu…
 = 
	`ASSERT
(
ˇcheSize
 > 0, "block map cache size is specified");

257 i‡(
ªsu…
 !
UDS_SUCCESS
) {

258  
ªsu…
;

261 
m≠
->
jou∫Æ
 = journal;

262 
m≠
->
n⁄˚
 =Çonce;

264 
ªsu…
 = 
	`makeF‹e°
(
m≠
, m≠->
íåyCou¡
);

265 i‡(
ªsu…
 !
VDO_SUCCESS
) {

266  
ªsu…
;

269 
	`ª∂a˚F‹e°
(
m≠
);

270 
Z⁄eCou¡
 
z⁄e
 = 0; z⁄ê< 
m≠
->
z⁄eCou¡
; zone++) {

271 
ªsu…
 = 
	`öôülizeBlockM≠Z⁄e
(&
m≠
->
z⁄es
[
z⁄e
], 
œyî
, 
ªadO∆yC⁄ãxt
,

272 
ˇcheSize
 / 
m≠
->
z⁄eCou¡
, 
maximumAge
);

273 i‡(
ªsu…
 !
VDO_SUCCESS
) {

274  
ªsu…
;

278 
ªsu…
 = 
	`öôülizeEnqueuóbÀCom∂ëi⁄
(&
m≠
->
com∂ëi⁄
,

279 
BLOCK_MAP_COMPLETION
, 
œyî
);

280 i‡(
ªsu…
 !
VDO_SUCCESS
) {

281  
ªsu…
;

284 
ªsu…
 = 
	`öôülizeEnqueuóbÀCom∂ëi⁄
(&
m≠
->
a˘i⁄Com∂ëi⁄
,

285 
SUB_TASK_COMPLETION
, 
œyî
);

286 i‡(
ªsu…
 !
VDO_SUCCESS
) {

287  
ªsu…
;

290  
VDO_SUCCESS
;

291 
	}
}

298 
	$unöôülizeBlockM≠Z⁄e
(
BlockM≠Z⁄e
 *
z⁄e
)

300 
	`unöôülizeBlockM≠TªeZ⁄e
(&
z⁄e
->
åìZ⁄e
);

301 
	`‰ìVDOPageCache
(&
z⁄e
->
∑geCache
);

302 
	}
}

305 
	$‰ìBlockM≠
(
BlockM≠
 **
m≠På
)

307 
BlockM≠
 *
m≠
 = *
m≠På
;

308 i‡(
m≠
 =
NULL
) {

312 
Z⁄eCou¡
 
z⁄e
 = 0; z⁄ê< 
m≠
->
z⁄eCou¡
; zone++) {

313 
	`unöôülizeBlockM≠Z⁄e
(&
m≠
->
z⁄es
[
z⁄e
]);

316 
	`ab™d⁄BlockM≠Growth
(
m≠
);

317 
	`‰ìF‹e°
(&
m≠
->
f‹e°
);

318 
	`de°royEnqueuóbÀ
(&
m≠
->
com∂ëi⁄
);

319 
	`de°royEnqueuóbÀ
(&
m≠
->
a˘i⁄Com∂ëi⁄
);

321 
	`FREE
(
m≠
);

322 *
m≠På
 = 
NULL
;

323 
	}
}

326 
size_t
 
	$gëBlockM≠EncodedSize
()

328  
ENCODED_HEADER_SIZE
 + (
BlockM≠Sèã2_0
);

329 
	}
}

332 
	$ícodeBlockM≠
(c⁄° 
BlockM≠
 *
m≠
, 
Buf„r
 *
buf„r
)

334 
BlockM≠Sèã2_0
 
°©e
 = (BlockMapState2_0) {

335 .
Ê©PageOrigö
 = 
BLOCK_MAP_FLAT_PAGE_ORIGIN
,

336 .
Ê©PageCou¡
 = 
m≠
->flatPageCount,

337 .
roŸOrigö
 = 
m≠
->rootOrigin,

338 .
roŸCou¡
 = 
m≠
->rootCount,

340  
	`ícodeWôhHódî
(
CURRENT_BLOCK_MAP_HEADER
, &
°©e
, 
buf„r
);

341 
	}
}

344 
	$öôülizeBlockM≠FromJou∫Æ
(
BlockM≠
 *
m≠
, 
RecovîyJou∫Æ
 *
jou∫Æ
)

346 
m≠
->
cuºítEøPoöt
 = 
	`gëCuºítJou∫ÆSequí˚Numbî
(
jou∫Æ
);

347 
m≠
->
≥ndögEøPoöt
 = m≠->
cuºítEøPoöt
;

348 
m≠
->
¥eviousEøPoöt
 = m≠->
cuºítEøPoöt
;

350 
Z⁄eCou¡
 
z⁄e
 = 0; z⁄ê< 
m≠
->
z⁄eCou¡
; zone++) {

351 
	`£tTªeZ⁄eInôülPîiod
(&
m≠
->
z⁄es
[
z⁄e
].
åìZ⁄e
, m≠->
cuºítEøPoöt
);

352 
	`£tVDOPageCacheInôülPîiod
(
m≠
->
z⁄es
[
z⁄e
].
∑geCache
,

353 
m≠
->
cuºítEøPoöt
);

355 
	}
}

364 
ölöe
 
BlockM≠
 *
	$asBlockM≠
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

366 
	`STATIC_ASSERT
(
	`off£tof
(
BlockM≠
, 
com∂ëi⁄
) == 0);

367 
	`as£πCom∂ëi⁄Ty≥
(
com∂ëi⁄
->
ty≥
, 
BLOCK_MAP_COMPLETION
);

368  (
BlockM≠
 *Ë
com∂ëi⁄
;

369 
	}
}

372 
BlockM≠Z⁄e
 *
	$gëBlockM≠Z⁄e
(
BlockM≠
 *
m≠
, 
Z⁄eCou¡
 
z⁄eNumbî
)

374  &
m≠
->
z⁄es
[
z⁄eNumbî
];

375 
	}
}

378 
Z⁄eCou¡
 
	$compuãLogiˇlZ⁄e
(
D©aVIO
 *
d©aVIO
)

380 
BlockM≠
 *
m≠
 = 
	`gëBlockM≠
(
	`gëVDOFromD©aVIO
(
d©aVIO
));

381 
TªeLock
 *
åìLock
 = &
d©aVIO
->treeLock;

382 
PageNumbî
 
∑geNumbî
 = 
	`compuãPageNumbî
(
d©aVIO
->
logiˇl
.
lbn
);

383 
åìLock
->
åìSlŸs
[0].
∑geIndex
 = 
∑geNumbî
;

384 
åìLock
->
roŸIndex
 = 
∑geNumbî
 % 
m≠
->
roŸCou¡
;

385  (
åìLock
->
roŸIndex
 % 
m≠
->
z⁄eCou¡
);

386 
	}
}

389 
	$födBlockM≠SlŸAsync
(
D©aVIO
 *
d©aVIO
,

390 
VDOA˘i⁄
 *
ˇŒback
,

391 
ThªadID
 
thªadID
)

393 
BlockM≠
 *
m≠
 = 
	`gëBlockM≠
(
	`gëVDOFromD©aVIO
(
d©aVIO
));

394 i‡(
d©aVIO
->
logiˇl
.
lbn
 >
m≠
->
íåyCou¡
) {

395 
	`föishD©aVIO
(
d©aVIO
, 
VDO_OUT_OF_RANGE
);

399 
TªeLock
 *
åìLock
 = &
d©aVIO
->treeLock;

400 
BlockM≠TªeSlŸ
 *
¶Ÿ
 = &
åìLock
->
åìSlŸs
[0];

401 
¶Ÿ
->
blockM≠SlŸ
.¶Ÿ = 
	`compuãSlŸ
(
d©aVIO
->
logiˇl
.
lbn
);

402 i‡(
¶Ÿ
->
∑geIndex
 < 
m≠
->
Ê©PageCou¡
) {

403 
¶Ÿ
->
blockM≠SlŸ
.
pbn
 = slŸ->
∑geIndex
 + 
BLOCK_MAP_FLAT_PAGE_ORIGIN
;

404 
	`œunchCÆlback
(
	`d©aVIOAsCom∂ëi⁄
(
d©aVIO
), 
ˇŒback
, 
thªadID
);

408 
åìLock
->
ˇŒback
 = callback;

409 
åìLock
->
thªadID
 =ÅhreadID;

410 
	`lookupBlockM≠PBN
(
d©aVIO
);

411 
	}
}

414 
PhysiˇlBlockNumbî
 
	$födBlockM≠PagePBN
(
BlockM≠
 *
m≠
, 
PageCou¡
 
∑geNumbî
)

416 i‡(
∑geNumbî
 < 
m≠
->
Ê©PageCou¡
) {

417  
∑geNumbî
 + 
BLOCK_MAP_FLAT_PAGE_ORIGIN
;

420  
	`gëBlockM≠PagePBN
(
m≠
, 
∑geNumbî
);

421 
	}
}

424 
PageCou¡
 
	$gëNumbîOfFixedBlockM≠Pages
(c⁄° 
BlockM≠
 *
m≠
)

426  (
m≠
->
Ê©PageCou¡
 + m≠->
roŸCou¡
);

427 
	}
}

430 
BlockCou¡
 
	$gëNumbîOfBlockM≠E¡rõs
(c⁄° 
BlockM≠
 *
m≠
)

432  
m≠
->
íåyCou¡
;

433 
	}
}

440 
	$h™dÀZ⁄eEº‹
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

443 
	`£tCom∂ëi⁄Resu…
(
com∂ëi⁄
->
∑ª¡
, com∂ëi⁄->
ªsu…
);

446 
	`ª£tCom∂ëi⁄
(
com∂ëi⁄
);

447 
	`övokeCÆlback
(
com∂ëi⁄
);

448 
	}
}

455 
	$≠∂yToNextZ⁄e
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

457 
BlockM≠
 *
m≠
 = 
	`asBlockM≠
(
com∂ëi⁄
);

458 
BlockM≠Z⁄e
 *
z⁄e
 = &
m≠
->
z⁄es
[m≠->
a˘ögZ⁄e
];

459 
	`ASSERT_LOG_ONLY
((
	`gëCÆlbackThªadID
(Ë=
z⁄e
->
thªadID
),

462 
m≠
->
a˘ögZ⁄e
++;

463 i‡(
m≠
->
a˘ögZ⁄e
 =m≠->
z⁄eCou¡
) {

466 
	`¥ï¨eToFöishP¨ít
(
com∂ëi⁄
, com∂ëi⁄->
∑ª¡
);

469 
	`¥ï¨eCom∂ëi⁄
(
com∂ëi⁄
, 
≠∂yToNextZ⁄e
, 
h™dÀZ⁄eEº‹
,

470 
m≠
->
z⁄es
[m≠->
a˘ögZ⁄e
].
thªadID
,

471 
com∂ëi⁄
->
∑ª¡
);

474 
m≠
->
	`a˘i⁄
(
z⁄e
);

475 
	}
}

489 
	$œunchOnAŒZ⁄es
(
BlockM≠
 *
m≠
,

490 
BlockM≠Z⁄eA˘i⁄
 *
a˘i⁄
,

491 *
∑ª¡
,

492 
VDOA˘i⁄
 *
ˇŒback
,

493 
VDOA˘i⁄
 *
îr‹H™dÀr
)

495 
	`¥ï¨eCom∂ëi⁄
(&
m≠
->
a˘i⁄Com∂ëi⁄
, 
ˇŒback
, 
îr‹H™dÀr
,

496 
m≠
->
ªcovîyJou∫ÆThªadID
, 
∑ª¡
);

497 
m≠
->
a˘i⁄
 =áction;

498 
m≠
->
a˘ögZ⁄e
 = 0;

499 
	`¥ï¨eCom∂ëi⁄
(&
m≠
->
com∂ëi⁄
, 
≠∂yToNextZ⁄e
, 
h™dÀZ⁄eEº‹
,

500 
m≠
->
z⁄es
[m≠->
a˘ögZ⁄e
].
thªadID
,

501 &
m≠
->
a˘i⁄Com∂ëi⁄
);

502 
	`övokeCÆlback
(&
m≠
->
com∂ëi⁄
);

503 
	}
}

512 
boﬁ
 
	$isA˘ög
(
BlockM≠
 *
m≠
)

514  (
m≠
->
cuºítA˘i⁄
.
a˘i⁄
 !
BLOCK_MAP_ACTION_NONE
);

515 
	}
}

524 
boﬁ
 
	$hasNextA˘i⁄
(
BlockM≠
 *
m≠
)

526  (
m≠
->
√xtA˘i⁄
.
a˘i⁄
 !
BLOCK_MAP_ACTION_NONE
);

527 
	}
}

536 
BlockM≠A˘i⁄
 
	$adv™˚A˘i⁄s
(
BlockM≠
 *
m≠
)

538 
BlockM≠A˘i⁄
 
com∂ëed
 = 
m≠
->
cuºítA˘i⁄
;

539 
m≠
->
cuºítA˘i⁄
 = m≠->
√xtA˘i⁄
;

540 
m≠
->
√xtA˘i⁄
 = (
BlockM≠A˘i⁄
) {

541 .
a˘i⁄
 = 
BLOCK_MAP_ACTION_NONE
,

542 .
∑ª¡
 = 
NULL


544  
com∂ëed
;

545 
	}
}

556 
boﬁ
 
	$scheduÀA˘i⁄
(
BlockM≠
 *
m≠
,

557 
BlockM≠A˘i⁄Ty≥
 
a˘i⁄
,

558 
VDOCom∂ëi⁄
 *
∑ª¡
)

560 
	`ASSERT_LOG_ONLY
((
	`gëCÆlbackThªadID
(Ë=
m≠
->
ªcovîyJou∫ÆThªadID
),

562 i‡(
	`hasNextA˘i⁄
(
m≠
)) {

563 
	`föishCom∂ëi⁄
(
∑ª¡
, 
VDO_COMPONENT_BUSY
);

564  
Ál£
;

567 
m≠
->
√xtA˘i⁄
 = (
BlockM≠A˘i⁄
) {

568 .
a˘i⁄
 =áction,

569 .
∑ª¡
 =Öarent,

572 i‡(
	`isA˘ög
(
m≠
)) {

573  
Ál£
;

576 
	`adv™˚A˘i⁄s
(
m≠
);

577  
åue
;

578 
	}
}

581 
föishA˘ög
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
);

588 
	$föishAgög
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

590 
BlockM≠
 *
m≠
 = 
com∂ëi⁄
->
∑ª¡
;

591 
m≠
->
¥eviousEøPoöt
 = m≠->
cuºítEøPoöt
;

592 
	`föishA˘ög
(
com∂ëi⁄
);

593 
	}
}

602 
	$adv™˚BlockM≠Z⁄eEø
(
BlockM≠Z⁄e
 *
z⁄e
)

604 
	`adv™˚VDOPageCachePîiod
(
z⁄e
->
∑geCache
, z⁄e->
blockM≠
->
cuºítEøPoöt
);

605 
	`adv™˚Z⁄eTªePîiod
(&
z⁄e
->
åìZ⁄e
, z⁄e->
blockM≠
->
cuºítEøPoöt
);

606 
	`föishCom∂ëi⁄
(&
z⁄e
->
blockM≠
->
com∂ëi⁄
, 
VDO_SUCCESS
);

607 
	}
}

615 
	$œunchAdv™˚BlockM≠Eø
(
BlockM≠
 *
m≠
)

617 i‡(
m≠
->
cuºítEøPoöt
 =m≠->
≥ndögEøPoöt
) {

622 
m≠
->
cuºítA˘i⁄
.
a˘i⁄
 = 
BLOCK_MAP_ACTION_ADVANCE_ERA
;

623 
m≠
->
cuºítEøPoöt
 = m≠->
≥ndögEøPoöt
;

624 
	`œunchOnAŒZ⁄es
(
m≠
, 
adv™˚BlockM≠Z⁄eEø
, m≠, 
föishAgög
, finishAging);

625 
	}
}

628 
	$adv™˚BlockM≠Eø
(
BlockM≠
 *
m≠
, 
Sequí˚Numbî
 
ªcovîyBlockNumbî
)

630 i‡(
m≠
 =
NULL
) {

634 
	`ASSERT_LOG_ONLY
((
	`gëCÆlbackThªadID
(Ë=
m≠
->
ªcovîyJou∫ÆThªadID
),

637 
m≠
->
≥ndögEøPoöt
 = 
ªcovîyBlockNumbî
;

638 i‡(!
	`isA˘ög
(
m≠
)) {

639 
	`œunchAdv™˚BlockM≠Eø
(
m≠
);

641 
	}
}

649 
	$ª›íBlockM≠Z⁄e
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

651 
BlockM≠Z⁄e
 *
z⁄e
 = (BlockM≠Z⁄ê*Ë
com∂ëi⁄
;

652 
z⁄e
->
admöSèã
 = 
ADMIN_STATE_NORMAL_OPERATION
;

653 
	`›íObje˘Poﬁ
(
z⁄e
->
åìZ⁄e
.
vioPoﬁ
);

654 
	`ÊushVDOPageCacheAsync
(
z⁄e
->
∑geCache
, 
com∂ëi⁄
->
∑ª¡
);

655 
	}
}

665 
	$ÊushBlockM≠Z⁄eAsync
(
BlockM≠Z⁄e
 *
z⁄e
)

667 
	`¥ï¨eCom∂ëi⁄
(&
z⁄e
->
com∂ëi⁄
, 
ª›íBlockM≠Z⁄e
,

668 
föishP¨ítCÆlback
, 
z⁄e
->
thªadID
,

669 &
z⁄e
->
blockM≠
->
com∂ëi⁄
);

670 
	`˛o£Z⁄eTªes
(&
z⁄e
->
åìZ⁄e
);

671 
	}
}

678 
	$œunchFlushBlockM≠
(
BlockM≠
 *
m≠
)

680 
	`œunchOnAŒZ⁄es
(
m≠
, 
ÊushBlockM≠Z⁄eAsync
, m≠, 
föishA˘ög
,

681 
föishA˘ög
);

682 
	}
}

685 
	$ÊushBlockM≠
(
BlockM≠
 *
m≠
, 
VDOCom∂ëi⁄
 *
∑ª¡
)

687 i‡(
	`scheduÀA˘i⁄
(
m≠
, 
BLOCK_MAP_ACTION_FLUSH
, 
∑ª¡
)) {

688 
	`œunchFlushBlockM≠
(
m≠
);

690 
	}
}

697 
	$åìIsClo£d
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

699 
BlockM≠Z⁄e
 *
z⁄e
 = ((BlockM≠Z⁄ê*Ë
com∂ëi⁄
);

700 
	`ÊushVDOPageCacheAsync
(
z⁄e
->
∑geCache
, 
com∂ëi⁄
->
∑ª¡
);

701 
	}
}

710 
	$˛o£BlockM≠Z⁄eAsync
(
BlockM≠Z⁄e
 *
z⁄e
)

712 
	`¥ï¨eCom∂ëi⁄
(&
z⁄e
->
com∂ëi⁄
, 
åìIsClo£d
, 
föishP¨ítCÆlback
,

713 
z⁄e
->
thªadID
, &z⁄e->
blockM≠
->
com∂ëi⁄
);

714 
	`˛o£Z⁄eTªes
(&
z⁄e
->
åìZ⁄e
);

715 
	}
}

722 
	$œunchClo£BlockM≠
(
BlockM≠
 *
m≠
)

724 
	`œunchOnAŒZ⁄es
(
m≠
, 
˛o£BlockM≠Z⁄eAsync
, m≠, 
föishA˘ög
,

725 
föishA˘ög
);

726 
	}
}

729 
	$˛o£BlockM≠
(
BlockM≠
 *
m≠
, 
VDOCom∂ëi⁄
 *
∑ª¡
)

731 i‡(
	`scheduÀA˘i⁄
(
m≠
, 
BLOCK_MAP_ACTION_CLOSE
, 
∑ª¡
)) {

732 
	`œunchClo£BlockM≠
(
m≠
);

734 
	}
}

737 
	$¥ï¨eToGrowBlockM≠
(
BlockM≠
 *
m≠
, 
BlockCou¡
 
√wLogiˇlBlocks
)

739 i‡(
m≠
->
√xtE¡ryCou¡
 =
√wLogiˇlBlocks
) {

740  
VDO_SUCCESS
;

743 i‡(
m≠
->
√xtE¡ryCou¡
 > 0) {

744 
	`ab™d⁄BlockM≠Growth
(
m≠
);

747 i‡(
√wLogiˇlBlocks
 < 
m≠
->
íåyCou¡
) {

748 
m≠
->
√xtE¡ryCou¡
 = m≠->
íåyCou¡
;

749  
VDO_SUCCESS
;

752  
	`makeF‹e°
(
m≠
, 
√wLogiˇlBlocks
);

753 
	}
}

756 
BlockCou¡
 
	$gëNewE¡ryCou¡
(
BlockM≠
 *
m≠
)

758  
m≠
->
√xtE¡ryCou¡
;

759 
	}
}

768 
	$ªsumeBlockM≠Z⁄e
(
BlockM≠Z⁄e
 *
z⁄e
)

770 
	`ªsumeZ⁄eTªes
(&
z⁄e
->
åìZ⁄e
);

771 
	`föishCom∂ëi⁄
(&
z⁄e
->
blockM≠
->
com∂ëi⁄
, 
VDO_SUCCESS
);

772 
	}
}

781 
	$su•ídBlockM≠Z⁄e
(
BlockM≠Z⁄e
 *
z⁄e
)

783 
	`su•ídZ⁄eTªes
(&
z⁄e
->
åìZ⁄e
, &z⁄e->
blockM≠
->
com∂ëi⁄
);

784 
	}
}

792 
	$ö°ÆlF‹e°
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

794 
BlockM≠
 *
m≠
 = 
com∂ëi⁄
->
∑ª¡
;

795 
	`ASSERT_LOG_ONLY
((
	`gëCÆlbackThªadID
(Ë=
m≠
->
ªcovîyJou∫ÆThªadID
),

798 
	`ª∂a˚F‹e°
(
m≠
);

799 
	`œunchOnAŒZ⁄es
(
m≠
, 
ªsumeBlockM≠Z⁄e
, m≠, 
föishA˘ög
, finishActing);

800 
	}
}

808 
	$h™dÀGrowthEº‹
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

810 
BlockM≠
 *
m≠
 = 
com∂ëi⁄
->
∑ª¡
;

811 
	`ASSERT_LOG_ONLY
((
	`gëCÆlbackThªadID
(Ë=
m≠
->
ªcovîyJou∫ÆThªadID
),

814 
	`ab™d⁄BlockM≠Growth
(
m≠
);

815 
	`£tCom∂ëi⁄Resu…
(
m≠
->
cuºítA˘i⁄
.
∑ª¡
, 
com∂ëi⁄
->
ªsu…
);

816 
	`œunchOnAŒZ⁄es
(
m≠
, 
ªsumeBlockM≠Z⁄e
, m≠, 
föishA˘ög
, finishActing);

817 
	}
}

825 
	$œunchGrowBlockM≠
(
BlockM≠
 *
m≠
)

827 i‡(
m≠
->
√xtF‹e°
 =
NULL
) {

830 
m≠
->
íåyCou¡
 = m≠->
√xtE¡ryCou¡
;

831 
m≠
->
√xtE¡ryCou¡
 = 0;

834 
m≠
->
a˘i⁄Com∂ëi⁄
.
∑ª¡
 = map;

835 
	`föishA˘ög
(&
m≠
->
a˘i⁄Com∂ëi⁄
);

839 
	`œunchOnAŒZ⁄es
(
m≠
, 
su•ídBlockM≠Z⁄e
, m≠, 
ö°ÆlF‹e°
,

840 
h™dÀGrowthEº‹
);

841 
	}
}

844 
	$growBlockM≠
(
BlockM≠
 *
m≠
, 
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

846 i‡(
	`scheduÀA˘i⁄
(
m≠
, 
BLOCK_MAP_ACTION_GROW
, 
com∂ëi⁄
)) {

847 
	`œunchGrowBlockM≠
(
m≠
);

849 
	}
}

857 
	$föishA˘ög
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

859 
BlockM≠
 *
m≠
 = 
com∂ëi⁄
->
∑ª¡
;

860 
	`ASSERT_LOG_ONLY
((
	`gëCÆlbackThªadID
(Ë=
m≠
->
ªcovîyJou∫ÆThªadID
),

862 
m≠
->
cuºítA˘i⁄
.
a˘i⁄
);

864 
BlockM≠A˘i⁄
 
com∂ëed
 = 
	`adv™˚A˘i⁄s
(
m≠
);

865 i‡(
com∂ëed
.
∑ª¡
 !
NULL
) {

866 
	`föishCom∂ëi⁄
(
com∂ëed
.
∑ª¡
, 
com∂ëi⁄
->
ªsu…
);

869 
m≠
->
cuºítA˘i⁄
.
a˘i⁄
) {

870 
BLOCK_MAP_ACTION_CLOSE
:

871 
	`œunchClo£BlockM≠
(
m≠
);

874 
BLOCK_MAP_ACTION_FLUSH
:

875 
	`œunchFlushBlockM≠
(
m≠
);

878 
BLOCK_MAP_ACTION_GROW
:

879 
	`œunchGrowBlockM≠
(
m≠
);

882 
BLOCK_MAP_ACTION_ADVANCE_ERA
:

884 
	`œunchAdv™˚BlockM≠Eø
(
m≠
);

887 
	}
}

890 
	$ab™d⁄BlockM≠Growth
(
BlockM≠
 *
m≠
)

892 
	`ab™d⁄F‹e°
(
m≠
);

893 
	}
}

902 
ölöe
 
	$föishPro˚ssögPage
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
, 
ªsu…
)

904 
VDOCom∂ëi⁄
 *
∑ª¡
 = 
com∂ëi⁄
->parent;

905 
	`ªÀa£VDOPageCom∂ëi⁄
(
com∂ëi⁄
);

906 
	`c⁄töueCom∂ëi⁄
(
∑ª¡
, 
ªsu…
);

907 
	}
}

915 
	$h™dÀPageEº‹
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

917 
	`föishPro˚ssögPage
(
com∂ëi⁄
, com∂ëi⁄->
ªsu…
);

918 
	}
}

928 
	$£tupM≠≥dBlock
(
D©aVIO
 *
d©aVIO
,

929 
boﬁ
 
modifübÀ
,

930 
VDOA˘i⁄
 *
a˘i⁄
)

932 
BlockM≠Z⁄e
 *
z⁄e
 = 
	`gëBlockM≠F‹Z⁄e
(
d©aVIO
->
logiˇl
.zone);

933 i‡(
	`isClosög
(
z⁄e
->
admöSèã
)) {

934 
	`föishD©aVIO
(
d©aVIO
, 
VDO_SHUTTING_DOWN
);

938 
	`öôVDOPageCom∂ëi⁄
(&
d©aVIO
->
∑geCom∂ëi⁄
, 
z⁄e
->
∑geCache
,

939 
d©aVIO
->
åìLock
.
åìSlŸs
[0].
blockM≠SlŸ
.
pbn
,

940 
modifübÀ
, 
	`d©aVIOAsCom∂ëi⁄
(
d©aVIO
), 
a˘i⁄
,

941 
h™dÀPageEº‹
);

942 
	`gëVDOPageAsync
(&
d©aVIO
->
∑geCom∂ëi⁄
.
com∂ëi⁄
);

943 
	}
}

956 
__©åibuã__
((
w¨n_unu£d_ªsu…
))

957 
	$£tM≠≥dE¡ry
(
D©aVIO
 *
d©aVIO
,

958 c⁄° 
BlockM≠E¡ry
 *
íåy
,

959 
uöt8_t
 
íåyOff£t
)

962 
PhysiˇlBlockNumbî
 
pbn
 = 
	`u≈ackOff£tPBN
(
íåy
, 
íåyOff£t
);

964 i‡(!
	`isInvÆid
(
íåy
)) {

965 
ªsu…
 = 
	`£tM≠≥dLoˇti⁄
(
d©aVIO
, 
pbn
, 
íåy
->
m≠pögSèã
);

971 i‡((
ªsu…
 =
VDO_SUCCESS
)

972 || ((
ªsu…
 !
VDO_OUT_OF_RANGE
Ë&& (ªsu… !
VDO_BAD_MAPPING
))) {

973  
ªsu…
;

979 
	`logEº‹WôhSåögEº‹
(
VDO_BAD_MAPPING
, "PBN %" 
PRIu64


981 
pbn
, 
íåy
->
m≠pögSèã
);

985 i‡(
	`isRódD©aVIO
(
d©aVIO
)) {

986  
VDO_BAD_MAPPING
;

991 
	`˛órM≠≥dLoˇti⁄
(
d©aVIO
);

992  
VDO_SUCCESS
;

993 
	}
}

998 
	$gëM≠pögFromFëchedPage
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

1000 i‡(
com∂ëi⁄
->
ªsu…
 !
VDO_SUCCESS
) {

1001 
	`föishPro˚ssögPage
(
com∂ëi⁄
, com∂ëi⁄->
ªsu…
);

1005 c⁄° 
BlockM≠Page
 *
∑ge
 = 
	`dîe„ªn˚RódabÀVDOPage
(
com∂ëi⁄
);

1006 
ªsu…
 = 
	`ASSERT
(
∑ge
 !
NULL
, "pageávailable");

1007 i‡(
ªsu…
 !
VDO_SUCCESS
) {

1008 
	`föishPro˚ssögPage
(
com∂ëi⁄
, 
ªsu…
);

1012 
D©aVIO
 *
d©aVIO
 = 
	`asD©aVIO
(
com∂ëi⁄
->
∑ª¡
);

1013 
BlockM≠TªeSlŸ
 *
åìSlŸ
 = &
d©aVIO
->
åìLock
.
åìSlŸs
[0];

1014 c⁄° 
BlockM≠E¡ry
 *
íåy
 = &
∑ge
->
íåõs
[
åìSlŸ
->
blockM≠SlŸ
.
¶Ÿ
];

1016 
ªsu…
 = 
	`£tM≠≥dE¡ry
(
d©aVIO
, 
íåy
, 
∑ge
->
hódî
.
íåyOff£t
);

1017 
	`föishPro˚ssögPage
(
com∂ëi⁄
, 
ªsu…
);

1018 
	}
}

1023 
	$putM≠pögInFëchedPage
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

1025 i‡(
com∂ëi⁄
->
ªsu…
 !
VDO_SUCCESS
) {

1026 
	`föishPro˚ssögPage
(
com∂ëi⁄
, com∂ëi⁄->
ªsu…
);

1030 
BlockM≠Page
 *
∑ge
 = 
	`dîe„ªn˚WrôabÀVDOPage
(
com∂ëi⁄
);

1031 
ªsu…
 = 
	`ASSERT
(
∑ge
 !
NULL
, "pageávailable");

1032 i‡(
ªsu…
 !
VDO_SUCCESS
) {

1033 
	`föishPro˚ssögPage
(
com∂ëi⁄
, 
ªsu…
);

1037 
D©aVIO
 *
d©aVIO
 = 
	`asD©aVIO
(
com∂ëi⁄
->
∑ª¡
);

1038 
Sequí˚Numbî
 
ﬁdLockPîiod
 = 
∑ge
->
hódî
.
ªcovîySequí˚Numbî
;

1039 
	`upd©eBlockM≠Page
(
d©aVIO
, 
∑ge
, d©aVIO->
√wM≠≥d
.
pbn
,

1040 
d©aVIO
->
√wM≠≥d
.
°©e
);

1041 
	`m¨kCom∂ëedVDOPageDúty
(
com∂ëi⁄
, 
ﬁdLockPîiod
,

1042 
∑ge
->
hódî
.
ªcovîySequí˚Numbî
);

1043 
	`föishPro˚ssögPage
(
com∂ëi⁄
, 
VDO_SUCCESS
);

1044 
	}
}

1047 
	$gëM≠≥dBlockAsync
(
D©aVIO
 *
d©aVIO
)

1049 i‡(
d©aVIO
->
åìLock
.
åìSlŸs
[0].
blockM≠SlŸ
.
pbn
 =
ZERO_BLOCK
) {

1052 
	`˛órM≠≥dLoˇti⁄
(
d©aVIO
);

1053 
	`c⁄töueD©aVIO
(
d©aVIO
, 
VDO_SUCCESS
);

1057 
	`£tupM≠≥dBlock
(
d©aVIO
, 
Ál£
, 
gëM≠pögFromFëchedPage
);

1058 
	}
}

1061 
	$putM≠≥dBlockAsync
(
D©aVIO
 *
d©aVIO
)

1063 
	`£tupM≠≥dBlock
(
d©aVIO
, 
åue
, 
putM≠pögInFëchedPage
);

1064 
	}
}

1067 
BlockM≠Sèti°ics
 
	$gëBlockM≠Sèti°ics
(
BlockM≠
 *
m≠
)

1069 
BlockM≠Sèti°ics
 
°©s
;

1070 
	`mem£t
(&
°©s
, 0, (
BlockM≠Sèti°ics
));

1072 
Z⁄eCou¡
 
z⁄e
 = 0; z⁄ê< 
m≠
->
z⁄eCou¡
; zone++) {

1073 c⁄° 
AtomicPageCacheSèti°ics
 *
©oms


1074 
	`gëVDOPageCacheSèti°ics
(
m≠
->
z⁄es
[
z⁄e
].
∑geCache
);

1075 
°©s
.
dútyPages
 +
	`©omicLﬂd64
(&
©oms
->
cou¡s
.dirtyPages);

1076 
°©s
.
˛ónPages
 +
	`©omicLﬂd64
(&
©oms
->
cou¡s
.cleanPages);

1077 
°©s
.
‰ìPages
 +
	`©omicLﬂd64
(&
©oms
->
cou¡s
.freePages);

1078 
°©s
.
ÁûedPages
 +
	`©omicLﬂd64
(&
©oms
->
cou¡s
.failedPages);

1079 
°©s
.
öcomögPages
 +
	`©omicLﬂd64
(&
©oms
->
cou¡s
.incomingPages);

1080 
°©s
.
outgoögPages
 +
	`©omicLﬂd64
(&
©oms
->
cou¡s
.outgoingPages);

1082 
°©s
.
ˇchePªssuª
 +
	`©omicLﬂd64
(&
©oms
->cachePressure);

1083 
°©s
.
ªadCou¡
 +
	`©omicLﬂd64
(&
©oms
->readCount);

1084 
°©s
.
wrôeCou¡
 +
	`©omicLﬂd64
(&
©oms
->writeCount);

1085 
°©s
.
ÁûedRóds
 +
	`©omicLﬂd64
(&
©oms
->failedReads);

1086 
°©s
.
ÁûedWrôes
 +
	`©omicLﬂd64
(&
©oms
->failedWrites);

1087 
°©s
.
ª˛aimed
 +
	`©omicLﬂd64
(&
©oms
->reclaimed);

1088 
°©s
.
ªadOutgoög
 +
	`©omicLﬂd64
(&
©oms
->readOutgoing);

1089 
°©s
.
foundInCache
 +
	`©omicLﬂd64
(&
©oms
->foundInCache);

1090 
°©s
.
disˇrdRequúed
 +
	`©omicLﬂd64
(&
©oms
->discardRequired);

1091 
°©s
.
waôF‹Page
 +
	`©omicLﬂd64
(&
©oms
->waitForPage);

1092 
°©s
.
„tchRequúed
 +
	`©omicLﬂd64
(&
©oms
->fetchRequired);

1093 
°©s
.
∑gesLﬂded
 +
	`©omicLﬂd64
(&
©oms
->pagesLoaded);

1094 
°©s
.
∑gesSaved
 +
	`©omicLﬂd64
(&
©oms
->pagesSaved);

1095 
°©s
.
ÊushCou¡
 +
	`©omicLﬂd64
(&
©oms
->flushCount);

1098  
°©s
;

1099 
	}
}

	@vdo/base/blockMap.h

22 #i‚de‡
BLOCK_MAP_H


23 
	#BLOCK_MAP_H


	)

25 
	~"blockM≠E¡ry.h
"

26 
	~"com∂ëi⁄.h
"

27 
	~"fixedLayout.h
"

28 
	~"ªadO∆yModeC⁄ãxt.h
"

29 
	~"°©i°ics.h
"

30 
	~"ty≥s.h
"

45 
BlockCou¡
 
compuãBlockM≠Size
(BlockCou¡ 
tŸÆE¡rõs
,

46 
BlockCou¡
 
¶abSize
,

47 
BlockCou¡
 
d©aBlocksPîSœb
);

61 
	$makeBlockM≠
(
BlockCou¡
 
logiˇlBlocks
,

62 c⁄° 
ThªadC⁄fig
 *
thªadC⁄fig
,

63 
BlockCou¡
 
Ê©PageCou¡
,

64 
PhysiˇlBlockNumbî
 
roŸOrigö
,

65 
BlockCou¡
 
roŸCou¡
,

66 
BlockM≠
 **
m≠På
)

67 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

77 
	$¥ï¨eToGrowBlockM≠
(
BlockM≠
 *
m≠
, 
BlockCou¡
 
√wLogiˇlBlocks
)

78 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

88 
BlockCou¡
 
	$gëNewE¡ryCou¡
(
BlockM≠
 *
m≠
)

89 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

97 
	`growBlockM≠
(
BlockM≠
 *
m≠
, 
VDOCom∂ëi⁄
 *
com∂ëi⁄
);

104 
	`ab™d⁄BlockM≠Growth
(
BlockM≠
 *
m≠
);

117 
	$decodeBlockM≠
(
Buf„r
 *
buf„r
,

118 
BlockCou¡
 
logiˇlBlocks
,

119 c⁄° 
ThªadC⁄fig
 *
thªadC⁄fig
,

120 
BlockM≠
 **
m≠På
)

121 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

134 
	$decodeSodiumBlockM≠
(
Buf„r
 *
buf„r
,

135 
BlockCou¡
 
logiˇlBlocks
,

136 c⁄° 
ThªadC⁄fig
 *
thªadC⁄fig
,

137 
BlockM≠
 **
m≠På
)

138 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

154 
	$makeBlockM≠Caches
(
BlockM≠
 *
m≠
,

155 
PhysiˇlLayî
 *
œyî
,

156 
RódO∆yModeC⁄ãxt
 *
ªadO∆yC⁄ãxt
,

157 
RecovîyJou∫Æ
 *
jou∫Æ
,

158 
N⁄˚
 
n⁄˚
,

159 
PageCou¡
 
ˇcheSize
,

160 
BlockCou¡
 
maximumAge
)

161 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

168 
	`‰ìBlockM≠
(
BlockM≠
 **
m≠På
);

175 
size_t
 
	$gëBlockM≠EncodedSize
()

176 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

186 
	$ícodeBlockM≠
(c⁄° 
BlockM≠
 *
m≠
, 
Buf„r
 *
buf„r
)

187 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

196 
	`öôülizeBlockM≠FromJou∫Æ
(
BlockM≠
 *
m≠
, 
RecovîyJou∫Æ
 *
jou∫Æ
);

206 
BlockM≠Z⁄e
 *
	$gëBlockM≠Z⁄e
(
BlockM≠
 *
m≠
, 
Z⁄eCou¡
 
z⁄eNumbî
)

207 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

217 
Z⁄eCou¡
 
	`compuãLogiˇlZ⁄e
(
D©aVIO
 *
d©aVIO
);

227 
	`födBlockM≠SlŸAsync
(
D©aVIO
 *
d©aVIO
,

228 
VDOA˘i⁄
 *
ˇŒback
,

229 
ThªadID
 
thªadID
);

238 
PageCou¡
 
	$gëNumbîOfFixedBlockM≠Pages
(c⁄° 
BlockM≠
 *
m≠
)

239 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

248 
BlockCou¡
 
	$gëNumbîOfBlockM≠E¡rõs
(c⁄° 
BlockM≠
 *
m≠
)

249 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

259 
	`adv™˚BlockM≠Eø
(
BlockM≠
 *
m≠
, 
Sequí˚Numbî
 
ªcovîyBlockNumbî
);

267 
	`ÊushBlockM≠
(
BlockM≠
 *
m≠
, 
VDOCom∂ëi⁄
 *
∑ª¡
);

278 
	`˛o£BlockM≠
(
BlockM≠
 *
m≠
, 
VDOCom∂ëi⁄
 *
∑ª¡
);

287 
	`gëM≠≥dBlockAsync
(
D©aVIO
 *
d©aVIO
);

295 
	`putM≠≥dBlockAsync
(
D©aVIO
 *
d©aVIO
);

304 
BlockM≠Sèti°ics
 
	$gëBlockM≠Sèti°ics
(
BlockM≠
 *
m≠
)

305 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

	@vdo/base/blockMapEntry.h

22 #i‚de‡
BLOCK_MAP_ENTRY_H


23 
	#BLOCK_MAP_ENTRY_H


	)

25 
	~"blockM≠pögSèã.h
"

26 
	~"c⁄°™ts.h
"

27 
	~"ty≥s.h
"

36 
__©åibuã__
((
	t∑cked
)Ë
	tblockM≠E¡ry
 {

37 
	gm≠pögSèã
 : 4;

38 
	gpbnHighNibbÀ
 : 4;

39 
uöt32_t
 
	gpbnLowW‹d
;

40 } 
	tBlockM≠E¡ry
;

49 
ölöe
 
PhysiˇlBlockNumbî
 
	$u≈ackPBN
(c⁄° 
BlockM≠E¡ry
 *
íåy
)

51  (((
PhysiˇlBlockNumbî
Ë
íåy
->
pbnHighNibbÀ
 << 32)

52 | 
íåy
->
pbnLowW‹d
);

53 
	}
}

63 
ölöe
 
PhysiˇlBlockNumbî
 
	$u≈ackOff£tPBN
(c⁄° 
BlockM≠E¡ry
 *
íåy
,

64 
uöt8_t
 
off£t
)

66 
PhysiˇlBlockNumbî
 
pbn
 = 
	`u≈ackPBN
(
íåy
);

67  (
pbn
 =
ZERO_BLOCK
Ë?Öb¿:Öb¿+ 
off£t
;

68 
	}
}

71 
ölöe
 
boﬁ
 
	$isUnm≠≥d
(c⁄° 
BlockM≠E¡ry
 *
íåy
)

73  (
íåy
->
m≠pögSèã
 =
MAPPING_STATE_UNMAPPED
);

74 
	}
}

77 
ölöe
 
boﬁ
 
	$isInvÆid
(c⁄° 
BlockM≠E¡ry
 *
íåy
)

79 
PhysiˇlBlockNumbî
 
pbn
 = 
	`u≈ackPBN
(
íåy
);

80  (((
pbn
 =
ZERO_BLOCK
Ë&& 
	`isCom¥es£d
(
íåy
->
m≠pögSèã
))

81 || ((
pbn
 !
ZERO_BLOCK
Ë&& 
	`isUnm≠≥d
(
íåy
)));

82 
	}
}

95 
ölöe
 
BlockM≠E¡ry
 
	$∑ckPBN
(
PhysiˇlBlockNumbî
 
pbn
,

96 
BlockM≠pögSèã
 
m≠pögSèã
)

98  (
BlockM≠E¡ry
) {

99 .
m≠pögSèã
 = mappingState,

100 .
pbnHighNibbÀ
 = ((
pbn
 >> 32) & 0x0F),

101 .
pbnLowW‹d
 = (
pbn
 & 0xFFFFFFFF),

103 
	}
}

	@vdo/base/blockMapInternals.h

22 #i‚de‡
BLOCK_MAP_INTERNALS_H


23 
	#BLOCK_MAP_INTERNALS_H


	)

25 
	~"blockM≠E¡ry.h
"

26 
	~"blockM≠Tªe.h
"

27 
	~"com∂ëi⁄.h
"

28 
	~"dútyLi°s.h
"

29 
	~"hódî.h
"

30 
	~"ötM≠.h
"

31 
	~"obje˘Poﬁ.h
"

32 
	~"rögNode.h
"

33 
	~"ty≥s.h
"

34 
	~"vdoPageCache.h
"

39 
	sblockM≠TªeZ⁄e
 {

41 
BlockM≠Z⁄e
 *
	mm≠Z⁄e
;

43 
DútyLi°s
 *
	mdútyLi°s
;

45 
VIOCou¡
 
	ma˘iveLookups
;

47 
I¡M≠
 *
	mlﬂdögPages
;

49 
Obje˘Poﬁ
 *
	mvioPoﬁ
;

51 
RódO∆yModeC⁄ãxt
 *
	mªadO∆yC⁄ãxt
;

53 
TªePage
 *
	mÊushî
;

55 
WaôQueue
 
	mÊushWaôîs
;

57 
uöt8_t
 
	mgíî©i⁄
;

59 
uöt8_t
 
	mﬁde°Gíî©i⁄
;

61 
uöt32_t
 
	mdútyPageCou¡s
[256];

67 
	sblockM≠Z⁄e
 {

69 
VDOCom∂ëi⁄
 
	mcom∂ëi⁄
;

71 
Z⁄eCou¡
 
	mz⁄eNumbî
;

73 
ThªadID
 
	mthªadID
;

75 
BlockM≠
 *
	mblockM≠
;

77 
VDOPageCache
 *
	m∑geCache
;

79 
BlockM≠TªeZ⁄e
 
	måìZ⁄e
;

81 
AdmöSèã
 
	madmöSèã
;

90 
	tBlockM≠Z⁄eA˘i⁄
(
	tBlockM≠Z⁄e
 *
	tz⁄e
);

93 
	mBLOCK_MAP_ACTION_NONE
 = 0,

94 
	mBLOCK_MAP_ACTION_ADVANCE_ERA
,

95 
	mBLOCK_MAP_ACTION_CLOSE
,

96 
	mBLOCK_MAP_ACTION_FLUSH
,

97 
	mBLOCK_MAP_ACTION_GROW
,

98 } 
	tBlockM≠A˘i⁄Ty≥
;

102 
BlockM≠A˘i⁄Ty≥
 
	ma˘i⁄
;

104 
VDOCom∂ëi⁄
 *
	m∑ª¡
;

105 } 
	tBlockM≠A˘i⁄
;

107 
	sblockM≠
 {

109 
VDOCom∂ëi⁄
 
	mcom∂ëi⁄
;

111 
VDOCom∂ëi⁄
 
	ma˘i⁄Com∂ëi⁄
;

113 
BlockM≠Z⁄eA˘i⁄
 *
	ma˘i⁄
;

115 
Z⁄eCou¡
 
	ma˘ögZ⁄e
;

117 
BlockM≠A˘i⁄
 
	mcuºítA˘i⁄
;

119 
BlockM≠A˘i⁄
 
	m√xtA˘i⁄
;

122 
ThªadID
 
	mªcovîyJou∫ÆThªadID
;

125 
BlockCou¡
 
	mÊ©PageCou¡
;

127 
PhysiˇlBlockNumbî
 
	mroŸOrigö
;

129 
BlockCou¡
 
	mroŸCou¡
;

132 
Sequí˚Numbî
 
	m¥eviousEøPoöt
;

134 
Sequí˚Numbî
 
	mcuºítEøPoöt
;

136 
Sequí˚Numbî
 
	m≥ndögEøPoöt
;

139 
BlockCou¡
 
	míåyCou¡
;

141 
N⁄˚
 
	mn⁄˚
;

143 
RecovîyJou∫Æ
 *
	mjou∫Æ
;

146 
F‹e°
 *
	mf‹e°
;

148 
F‹e°
 *
	m√xtF‹e°
;

150 
BlockCou¡
 
	m√xtE¡ryCou¡
;

153 
Z⁄eCou¡
 
	mz⁄eCou¡
;

155 
BlockM≠Z⁄e
 
	mz⁄es
[];

166 
PageCou¡
 
compuãBlockM≠PageCou¡
(
BlockCou¡
 
íåõs
);

174 
PhysiˇlBlockNumbî
 
födBlockM≠PagePBN
(
BlockM≠
 *
m≠
, 
PageCou¡
 
∑geNumbî
);

185 
__©åibuã__
((
w¨n_unu£d_ªsu…
))

186 
ölöe
 
PageNumbî
 
	$compuãPageNumbî
(
LogiˇlBlockNumbî
 
lbn
)

188  (
lbn
 / 
BLOCK_MAP_ENTRIES_PER_PAGE
);

189 
	}
}

199 
__©åibuã__
((
w¨n_unu£d_ªsu…
))

200 
ölöe
 
SlŸNumbî
 
	$compuãSlŸ
(
LogiˇlBlockNumbî
 
lbn
)

202  (
lbn
 % 
BLOCK_MAP_ENTRIES_PER_PAGE
);

203 
	}
}

	@vdo/base/blockMapPage.c

22 
	~"blockM≠Page.h
"

24 
	~"≥rmas£π.h
"

26 
	~"blockM≠.h
"

27 
	~"blockM≠I¡î«ls.h
"

28 
	~"blockM≠Tªe.h
"

29 
	~"c⁄°™ts.h
"

30 
	~"d©aVIO.h
"

31 
	~"ªcovîyJou∫Æ.h
"

32 
	~"°©usCodes.h
"

33 
	~"ty≥s.h
"

36 
	mPAGE_HEADER_4_1_SIZE
 = 8 + 8 + 8 + 1 + 1 + 1 + 1,

37 
	mPAGE_HEADER_4_0_SIZE
 = 8 + 4 + 8 + 8,

40 c⁄° 
Vîsi⁄Numbî
 
	gBLOCK_MAP_4_1
 = {

41 .
maj‹Vîsi⁄
 = 4,

42 .
	gmö‹Vîsi⁄
 = 1,

45 c⁄° 
Vîsi⁄Numbî
 *
	gCURRENT_BLOCK_MAP_VERSION
 = &
BLOCK_MAP_4_1
;

48 
boﬁ
 
	$isCuºítBlockM≠Page
(c⁄° 
BlockM≠Page
 *
∑ge
)

50  
	`¨eSameVîsi⁄
(
CURRENT_BLOCK_MAP_VERSION
, &
∑ge
->
vîsi⁄
);

51 
	}
}

54 
	$ícodeBlockM≠E¡ry
(
BlockM≠Page
 *
∑ge
,

55 
SlŸNumbî
 
¶Ÿ
,

56 
PhysiˇlBlockNumbî
 
pbn
,

57 
BlockM≠pögSèã
 
°©e
)

59 i‡(
pbn
 !
ZERO_BLOCK
) {

60 
pbn
 -
∑ge
->
hódî
.
íåyOff£t
;

63 
∑ge
->
íåõs
[
¶Ÿ
] = 
	`∑ckPBN
(
pbn
, 
°©e
);

64 
	}
}

67 
	$f‹m©BlockM≠Page
(*
buf„r
, 
N⁄˚
 
n⁄˚
, 
PhysiˇlBlockNumbî
 
pbn
)

69 
	`mem£t
(
buf„r
, 0, 
VDO_BLOCK_SIZE
);

70 
BlockM≠Page
 *
∑ge
 = (BlockM≠Pagê*Ë
buf„r
;

71 
∑ge
->
vîsi⁄
 = *
CURRENT_BLOCK_MAP_VERSION
;

72 
∑ge
->
hódî
 = (
PageHódî
) {

73 .
n⁄˚
 =Çonce,

74 .
pbn
 =Öbn,

75 .
öôülized
 = 
Ál£
,

76 .
íåyOff£t
 = 0,

77 .
öãri‹TªePageWrôög
 = 
Ál£
,

78 .
gíî©i⁄
 = 0,

80 
	}
}

87 
	$upgødePageTo4_1
(
BlockM≠Page
 *
∑ge
)

89 
∑ge
->
vîsi⁄
 = 
BLOCK_MAP_4_1
;

90 
PageHódî4_0
 *
ﬁdHódî
 = (PageHódî4_0 *Ë&
∑ge
->
hódî
;

91 
PageHódî
 
√wHódî
 = (PageHeader) {

92 .
n⁄˚
 = 
ﬁdHódî
->nonce,

93 .
pbn
 = 
ﬁdHódî
->
∑geID
 + 
BLOCK_MAP_FLAT_PAGE_ORIGIN
,

94 .
ªcovîySequí˚Numbî
 = 0,

95 .
öôülized
 = (
ﬁdHódî
->
unöôülized
 == 0),

96 .
íåyOff£t
 = 
NEON_BLOCK_MAP_ENTRY_PBN_OFFSET
,

97 .
öãri‹TªePageWrôög
 = 
Ál£
,

98 .
gíî©i⁄
 = 0,

100 
	`mem˝y
(&
∑ge
->
hódî
, &
√wHódî
, (
PageHódî
));

101 
	}
}

104 
BlockM≠PageVÆidôy
 
	$vÆid©eBlockM≠Page
(
BlockM≠Page
 *
∑ge
,

105 
N⁄˚
 
n⁄˚
,

106 
PhysiˇlBlockNumbî
 
pbn
)

110 
	`STATIC_ASSERT_SIZEOF
(
PageHódî4_0
, 
PAGE_HEADER_4_0_SIZE
);

111 
	`STATIC_ASSERT_SIZEOF
(
PageHódî
, 
PAGE_HEADER_4_0_SIZE
);

112 
	`STATIC_ASSERT_SIZEOF
(
PageHódî
, 
PAGE_HEADER_4_1_SIZE
);

114 i‡(
	`isUpgødabÀVîsi⁄
(&
BLOCK_MAP_4_1
, &
∑ge
->
vîsi⁄
)) {

115 
	`upgødePageTo4_1
(
∑ge
);

118 i‡(!
	`¨eSameVîsi⁄
(&
BLOCK_MAP_4_1
, &
∑ge
->
vîsi⁄
)

119 || !
∑ge
->
hódî
.
öôülized
 || (∑ge->hódî.
n⁄˚
 !=Çonce)) {

120  
BLOCK_MAP_PAGE_INVALID
;

123 i‡(
∑ge
->
hódî
.
pbn
 !=Öbn) {

124  
BLOCK_MAP_PAGE_BAD
;

127 
∑ge
->
hódî
.
ªcovîySequí˚Numbî
 = 0;

128 
∑ge
->
hódî
.
öãri‹TªePageWrôög
 = 
Ál£
;

129 
∑ge
->
hódî
.
gíî©i⁄
 = 0;

130  
BLOCK_MAP_PAGE_VALID
;

131 
	}
}

134 
	$upd©eBlockM≠Page
(
D©aVIO
 *
d©aVIO
,

135 
BlockM≠Page
 *
∑ge
,

136 
PhysiˇlBlockNumbî
 
pbn
,

137 
BlockM≠pögSèã
 
m≠pögSèã
)

140 
TªeLock
 *
åìLock
 = &
d©aVIO
->treeLock;

141 
	`ícodeBlockM≠E¡ry
(
∑ge
,

142 
åìLock
->
åìSlŸs
[åìLock->
height
].
blockM≠SlŸ
.
¶Ÿ
,

143 
pbn
, 
m≠pögSèã
);

146 
BlockM≠Z⁄e
 *
z⁄e
 = 
	`gëBlockM≠F‹Z⁄e
(
d©aVIO
->
logiˇl
.zone);

147 
BlockM≠
 *
blockM≠
 = 
z⁄e
->blockMap;

148 
RecovîyJou∫Æ
 *
jou∫Æ
 = 
blockM≠
->journal;

149 
Sequí˚Numbî
 
ﬁdLocked
 = 
∑ge
->
hódî
.
ªcovîySequí˚Numbî
;

150 
Sequí˚Numbî
 
√wLocked
 = 
d©aVIO
->
ªcovîySequí˚Numbî
;

152 i‡((
ﬁdLocked
 =0Ë|| (ﬁdLocked > 
√wLocked
)) {

154 
	`acquúeRecovîyJou∫ÆBlockRe„ªn˚
(
jou∫Æ
, 
√wLocked
, 
ZONE_TYPE_LOGICAL
,

155 
z⁄e
->
z⁄eNumbî
);

158 i‡(
ﬁdLocked
 > 0) {

159 
	`ªÀa£RecovîyJou∫ÆBlockRe„ªn˚
(
jou∫Æ
, 
ﬁdLocked
,

160 
ZONE_TYPE_LOGICAL
,

161 
z⁄e
->
z⁄eNumbî
);

165 
∑ge
->
hódî
.
ªcovîySequí˚Numbî
 = 
√wLocked
;

169 
	`ªÀa£PîE¡ryLockFromOthîZ⁄e
(
jou∫Æ
, 
√wLocked
);

170 
d©aVIO
->
ªcovîySequí˚Numbî
 = 0;

171 
	}
}

	@vdo/base/blockMapPage.h

22 #i‚de‡
BLOCK_MAP_PAGE_H


23 
	#BLOCK_MAP_PAGE_H


	)

25 
	~"blockM≠E¡ry.h
"

26 
	~"hódî.h
"

27 
	~"ty≥s.h
"

34 
	mNEON_BLOCK_MAP_ENTRY_PBN_OFFSET
 = 1,

40 
__©åibuã__
((
	t∑cked
)) {

45 
uöt64_t
 
	gn⁄˚
;

48 
PageNumbî
 
	g∑geID
;

55 
Sequí˚Numbî
 
	gªcovîySequí˚Numbî
;

58 
uöt64_t
 
	gunöôülized
;

59 } 
	tPageHódî4_0
;

64 
__©åibuã__
((
	t∑cked
)) {

69 
uöt64_t
 
	gn⁄˚
;

72 
PhysiˇlBlockNumbî
 
	gpbn
;

79 
Sequí˚Numbî
 
	gªcovîySequí˚Numbî
;

82 
boﬁ
 
	göôülized
;

88 
uöt8_t
 
	gíåyOff£t
;

94 
boﬁ
 
	göãri‹TªePageWrôög
;

101 
uöt8_t
 
	ggíî©i⁄
;

102 } 
	tPageHódî
;

107 
__©åibuã__
((
	t∑cked
)) {

108 
Vîsi⁄Numbî
 
	gvîsi⁄
;

109 
PageHódî
 
	ghódî
;

110 
BlockM≠E¡ry
 
	gíåõs
[];

111 } 
	tBlockM≠Page
;

115 
	mBLOCK_MAP_PAGE_VALID
,

117 
	mBLOCK_MAP_PAGE_INVALID
,

119 
	mBLOCK_MAP_PAGE_BAD
,

120 } 
	tBlockM≠PageVÆidôy
;

129 
boﬁ
 
	$isCuºítBlockM≠Page
(c⁄° 
BlockM≠Page
 *
∑ge
)

130 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

140 
	`ícodeBlockM≠E¡ry
(
BlockM≠Page
 *
∑ge
,

141 
SlŸNumbî
 
¶Ÿ
,

142 
PhysiˇlBlockNumbî
 
pbn
,

143 
BlockM≠pögSèã
 
°©e
);

152 
	`f‹m©BlockM≠Page
(*
buf„r
, 
N⁄˚
 
n⁄˚
, 
PhysiˇlBlockNumbî
 
pbn
);

165 
BlockM≠PageVÆidôy
 
	$vÆid©eBlockM≠Page
(
BlockM≠Page
 *
∑ge
,

166 
N⁄˚
 
n⁄˚
,

167 
PhysiˇlBlockNumbî
 
pbn
)

168 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

178 
	`upd©eBlockM≠Page
(
D©aVIO
 *
d©aVIO
,

179 
BlockM≠Page
 *
∑ge
,

180 
PhysiˇlBlockNumbî
 
pbn
,

181 
BlockM≠pögSèã
 
m≠pögSèã
);

	@vdo/base/blockMapRecovery.c

22 
	~"blockM≠Recovîy.h
"

24 
	~"loggî.h
"

25 
	~"mem‹yAŒoc.h
"

27 
	~"blockM≠I¡î«ls.h
"

28 
	~"blockM≠Page.h
"

29 
	~"hóp.h
"

30 
	~"numUtûs.h
"

31 
	~"ªfCou¡s.h
"

32 
	~"¶abDïŸ.h
"

33 
	~"vdoI¡î«l.h
"

34 
	~"vdoPageCache.h
"

44 
VDOCom∂ëi⁄
 
	mcom∂ëi⁄
;

46 
VDOCom∂ëi⁄
 
	msubTaskCom∂ëi⁄
;

48 
ThªadID
 
	mlogiˇlThªadID
;

50 
BlockM≠
 *
	mblockM≠
;

52 
boﬁ
 
	mab‹ãd
;

54 
boﬁ
 
	mœunchög
;

58 
NumbîedBlockM≠pög
 *
	mjou∫ÆE¡rõs
;

64 
Hóp
 
	mª∂ayHóp
;

68 
NumbîedBlockM≠pög
 *
	mcuºítE¡ry
;

70 
NumbîedBlockM≠pög
 *
	mcuºítUn„tchedE¡ry
;

74 
PhysiˇlBlockNumbî
 
	mpbn
;

76 
PageCou¡
 
	mout°™dög
;

78 
PageCou¡
 
	m∑geCou¡
;

80 
VDOPageCom∂ëi⁄
 
	m∑geCom∂ëi⁄s
[];

81 } 
	tBlockM≠RecovîyCom∂ëi⁄
;

95 
	$com∑ªM≠pögs
(c⁄° *
ôem1
, c⁄° *
ôem2
)

97 c⁄° 
NumbîedBlockM≠pög
 *
m≠pög1
 = (c⁄° NumbîedBlockM≠pög *Ë
ôem1
;

98 c⁄° 
NumbîedBlockM≠pög
 *
m≠pög2
 = (c⁄° NumbîedBlockM≠pög *Ë
ôem2
;

100 i‡(
m≠pög1
->
blockM≠SlŸ
.
pbn
 !
m≠pög2
->blockMapSlot.pbn) {

102 ((
m≠pög1
->
blockM≠SlŸ
.
pbn
 < 
m≠pög2
->blockMapSlot.pbn) ? 1 : -1);

105 i‡(
m≠pög1
->
blockM≠SlŸ
.
¶Ÿ
 !
m≠pög2
->blockMapSlot.slot) {

107 ((
m≠pög1
->
blockM≠SlŸ
.
¶Ÿ
 < 
m≠pög2
->blockMapSlot.slot) ? 1 : -1);

110 i‡(
m≠pög1
->
numbî
 !
m≠pög2
->number) {

111  ((
m≠pög1
->
numbî
 < 
m≠pög2
->number) ? 1 : -1);

115 
	}
}

124 
__©åibuã__
((
w¨n_unu£d_ªsu…
))

125 
ölöe
 
BlockM≠RecovîyCom∂ëi⁄
 *

126 
	$asBlockM≠RecovîyCom∂ëi⁄
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

128 
	`STATIC_ASSERT
(
	`off£tof
(
BlockM≠RecovîyCom∂ëi⁄
, 
com∂ëi⁄
) == 0);

129 
	`as£πCom∂ëi⁄Ty≥
(
com∂ëi⁄
->
ty≥
, 
BLOCK_MAP_RECOVERY_COMPLETION
);

130  (
BlockM≠RecovîyCom∂ëi⁄
 *Ë
com∂ëi⁄
;

131 
	}
}

138 
	$‰ìRecovîyCom∂ëi⁄
(
VDOCom∂ëi⁄
 **
com∂ëi⁄På
)

140 
VDOCom∂ëi⁄
 *
com∂ëi⁄
 = *
com∂ëi⁄På
;

141 i‡(
com∂ëi⁄
 =
NULL
) {

145 
	`de°royEnqueuóbÀ
(
com∂ëi⁄
);

146 
	`FREE
(
	`asBlockM≠RecovîyCom∂ëi⁄
(*
com∂ëi⁄På
));

147 *
com∂ëi⁄På
 = 
NULL
;

148 
	}
}

156 
	$föishBlockM≠Recovîy
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

158 
ªsu…
 = 
com∂ëi⁄
->result;

159 
VDOCom∂ëi⁄
 *
∑ª¡
 = 
com∂ëi⁄
->parent;

160 
	`‰ìRecovîyCom∂ëi⁄
(&
com∂ëi⁄
);

161 
	`föishCom∂ëi⁄
(
∑ª¡
, 
ªsu…
);

162 
	}
}

175 
	$makeRecovîyCom∂ëi⁄
(
VDO
 *
vdo
,

176 
BlockCou¡
 
íåyCou¡
,

177 
NumbîedBlockM≠pög
 *
jou∫ÆE¡rõs
,

178 
VDOCom∂ëi⁄
 *
∑ª¡
,

179 
BlockM≠RecovîyCom∂ëi⁄
 **
ªcovîyPå
)

181 
BlockM≠
 *
blockM≠
 = 
	`gëBlockM≠
(
vdo
);

182 
PageCou¡
 
∑geCou¡


183 
	`möPageCou¡
(
	`gëC⁄figuªdCacheSize
(
vdo
) >> 1,

184 
MAXIMUM_SIMULTANEOUS_BLOCK_MAP_RESTORATION_READS
);

186 
BlockM≠RecovîyCom∂ëi⁄
 *
ªcovîy
;

187 
ªsu…
 = 
	`ALLOCATE_EXTENDED
(
BlockM≠RecovîyCom∂ëi⁄
, 
∑geCou¡
,

188 
VDOPageCom∂ëi⁄
, 
__func__
, &
ªcovîy
);

189 i‡(
ªsu…
 !
UDS_SUCCESS
) {

190  
ªsu…
;

193 
ªsu…
 = 
	`öôülizeEnqueuóbÀCom∂ëi⁄
(&
ªcovîy
->
com∂ëi⁄
,

194 
BLOCK_MAP_RECOVERY_COMPLETION
,

195 
vdo
->
œyî
);

196 i‡(
ªsu…
 !
VDO_SUCCESS
) {

197 
VDOCom∂ëi⁄
 *
com∂ëi⁄
 = &
ªcovîy
->completion;

198 
	`‰ìRecovîyCom∂ëi⁄
(&
com∂ëi⁄
);

199  
ªsu…
;

202 
ªcovîy
->
blockM≠
 = blockMap;

203 
ªcovîy
->
jou∫ÆE¡rõs
 = journalEntries;

204 
ªcovîy
->
∑geCou¡
 =ÖageCount;

205 
ªcovîy
->
cuºítE¡ry
 = &ªcovîy->
jou∫ÆE¡rõs
[
íåyCou¡
 - 1];

207 
	`öôülizeCom∂ëi⁄
(&
ªcovîy
->
subTaskCom∂ëi⁄
, 
SUB_TASK_COMPLETION
,

208 
vdo
->
œyî
);

209 
ªcovîy
->
logiˇlThªadID
 = 
	`gëLogiˇlZ⁄eThªad
(
	`gëThªadC⁄fig
(
vdo
), 0);

213 
	`öôülizeHóp
(&
ªcovîy
->
ª∂ayHóp
, 
com∑ªM≠pögs
, 
jou∫ÆE¡rõs
,

214 
íåyCou¡
, (
NumbîedBlockM≠pög
));

215 
	`buûdHóp
(&
ªcovîy
->
ª∂ayHóp
, 
íåyCou¡
);

217 
	`ASSERT_LOG_ONLY
((
	`gëCÆlbackThªadID
(Ë=
ªcovîy
->
logiˇlThªadID
),

218 "%†mu° bêˇŒed o¿logiˇ»thªad %u (nŸ %u)", 
__func__
,

219 
ªcovîy
->
logiˇlThªadID
, 
	`gëCÆlbackThªadID
());

220 
	`¥ï¨eCom∂ëi⁄
(&
ªcovîy
->
com∂ëi⁄
, 
föishBlockM≠Recovîy
,

221 
föishBlockM≠Recovîy
, 
ªcovîy
->
logiˇlThªadID
, 
∑ª¡
);

224 
	`logInfo
("Replaying %zuÑecoveryÉntries into block map",

225 
ªcovîy
->
ª∂ayHóp
.
cou¡
);

227 *
ªcovîyPå
 = 
ªcovîy
;

228  
VDO_SUCCESS
;

229 
	}
}

240 
boﬁ
 
	$föishIfD⁄e
(
BlockM≠RecovîyCom∂ëi⁄
 *
ªcovîy
)

243 i‡(
ªcovîy
->
œunchög
 || (ªcovîy->
out°™dög
 > 0)

244 || (!
ªcovîy
->
ab‹ãd


245 && (
ªcovîy
->
cuºítE¡ry
 >ªcovîy->
jou∫ÆE¡rõs
))) {

246  
Ál£
;

249 
VDOPageCache
 *
ˇche
 = 
	`gëBlockM≠Z⁄e
(
ªcovîy
->
blockM≠
, 0)->
∑geCache
;

250 i‡(
ªcovîy
->
ab‹ãd
) {

255 
size_t
 
i
 = 0; i < 
ªcovîy
->
∑geCou¡
; i++) {

256 
VDOPageCom∂ëi⁄
 *
∑geCom∂ëi⁄
 = &
ªcovîy
->
∑geCom∂ëi⁄s
[
i
];

257 i‡(
ªcovîy
->
∑geCom∂ëi⁄s
[
i
].
ªady
) {

258 
	`ªÀa£VDOPageCom∂ëi⁄
(&
∑geCom∂ëi⁄
->
com∂ëi⁄
);

261 
	`com∂ëeCom∂ëi⁄
(&
ªcovîy
->
com∂ëi⁄
);

263 
	`logInfo
("Flushing block map changes");

264 
	`¥ï¨eToFöishP¨ít
(&
ªcovîy
->
subTaskCom∂ëi⁄
, &ªcovîy->
com∂ëi⁄
);

265 
	`ÊushVDOPageCacheAsync
(
ˇche
, &
ªcovîy
->
subTaskCom∂ëi⁄
);

267  
åue
;

268 
	}
}

277 
	$ab‹tRecovîy
(
BlockM≠RecovîyCom∂ëi⁄
 *
ªcovîy
, 
ªsu…
)

279 
ªcovîy
->
ab‹ãd
 = 
åue
;

280 
	`£tCom∂ëi⁄Resu…
(&
ªcovîy
->
com∂ëi⁄
, 
ªsu…
);

281 
	`föishIfD⁄e
(
ªcovîy
);

282 
	}
}

296 
NumbîedBlockM≠pög
 *

297 
	$födE¡rySèπögNextPage
(
BlockM≠RecovîyCom∂ëi⁄
 *
ªcovîy
,

298 
NumbîedBlockM≠pög
 *
cuºítE¡ry
,

299 
boﬁ
 
√edsS‹t
)

302 i‡(
cuºítE¡ry
 < 
ªcovîy
->
jou∫ÆE¡rõs
) {

303  
cuºítE¡ry
;

305 
size_t
 
cuºítPage
 = 
cuºítE¡ry
->
blockM≠SlŸ
.
pbn
;

308 (
cuºítE¡ry
 >
ªcovîy
->
jou∫ÆE¡rõs
)

309 && (
cuºítE¡ry
->
blockM≠SlŸ
.
pbn
 =
cuºítPage
)) {

310 i‡(
√edsS‹t
) {

311 
NumbîedBlockM≠pög
 *
ju°S‹ãdE¡ry


312 
	`s‹tNextHópEÀmít
(&
ªcovîy
->
ª∂ayHóp
);

313 
	`ASSERT_LOG_ONLY
(
ju°S‹ãdE¡ry
 < 
cuºítE¡ry
,

316 
cuºítE¡ry
--;

318  
cuºítE¡ry
;

319 
	}
}

328 
	$≠∂yJou∫ÆE¡rõsToPage
(
BlockM≠Page
 *
∑ge
,

329 
NumbîedBlockM≠pög
 *
°¨tögE¡ry
,

330 
NumbîedBlockM≠pög
 *
ídögE¡ry
)

332 
NumbîedBlockM≠pög
 *
cuºítE¡ry
 = 
°¨tögE¡ry
;

333 
cuºítE¡ry
 !
ídögE¡ry
) {

334 i‡(
∑ge
->
hódî
.
íåyOff£t
 == 0) {

335 
∑ge
->
íåõs
[
cuºítE¡ry
->
blockM≠SlŸ
.
¶Ÿ
]

336 
cuºítE¡ry
->
blockM≠E¡ry
;

339 
PhysiˇlBlockNumbî
 
pbn
 = 
	`u≈ackPBN
(&
cuºítE¡ry
->
blockM≠E¡ry
);

340 
	`ícodeBlockM≠E¡ry
(
∑ge
, 
cuºítE¡ry
->
blockM≠SlŸ
.
¶Ÿ
, 
pbn
,

341 
cuºítE¡ry
->
blockM≠E¡ry
.
m≠pögSèã
);

343 
cuºítE¡ry
--;

345 
	}
}

348 
ªcovîRódyPages
(
BlockM≠RecovîyCom∂ëi⁄
 *
ªcovîy
,

349 
VDOCom∂ëi⁄
 *
com∂ëi⁄
);

357 
	$∑geLﬂded
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

359 
BlockM≠RecovîyCom∂ëi⁄
 *
ªcovîy


360 
	`asBlockM≠RecovîyCom∂ëi⁄
(
com∂ëi⁄
->
∑ª¡
);

361 
ªcovîy
->
out°™dög
--;

362 i‡(!
ªcovîy
->
œunchög
) {

363 
	`ªcovîRódyPages
(
ªcovîy
, 
com∂ëi⁄
);

365 
	}
}

372 
	$h™dÀPageLﬂdEº‹
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

374 
BlockM≠RecovîyCom∂ëi⁄
 *
ªcovîy


375 
	`asBlockM≠RecovîyCom∂ëi⁄
(
com∂ëi⁄
->
∑ª¡
);

376 
ªcovîy
->
out°™dög
--;

377 
	`ab‹tRecovîy
(
ªcovîy
, 
com∂ëi⁄
->
ªsu…
);

378 
	}
}

386 
	$„tchPage
(
BlockM≠RecovîyCom∂ëi⁄
 *
ªcovîy
,

387 
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

389 i‡(
ªcovîy
->
cuºítUn„tchedE¡ry
 <Ñecovîy->
jou∫ÆE¡rõs
) {

395 
PageNumbî
 
√wPageNumbî
 = 
ªcovîy
->
cuºítUn„tchedE¡ry
->
blockM≠SlŸ
.
pbn
;

396 
ªcovîy
->
cuºítUn„tchedE¡ry


397 
	`födE¡rySèπögNextPage
(
ªcovîy
,Ñecovîy->
cuºítUn„tchedE¡ry
,

398 
åue
);

399 
	`öôVDOPageCom∂ëi⁄
(((
VDOPageCom∂ëi⁄
 *Ë
com∂ëi⁄
),

400 
ªcovîy
->
blockM≠
->
z⁄es
[0].
∑geCache
,

401 
√wPageNumbî
, 
åue
, &
ªcovîy
->
com∂ëi⁄
,

402 
∑geLﬂded
, 
h™dÀPageLﬂdEº‹
);

403 
ªcovîy
->
out°™dög
++;

404 
	`gëVDOPageAsync
(
com∂ëi⁄
);

405 
	}
}

416 
VDOPageCom∂ëi⁄
 *

417 
	$gëNextPageCom∂ëi⁄
(
BlockM≠RecovîyCom∂ëi⁄
 *
ªcovîy
,

418 
VDOPageCom∂ëi⁄
 *
com∂ëi⁄
)

420 
com∂ëi⁄
++;

421 i‡(
com∂ëi⁄
 =(&
ªcovîy
->
∑geCom∂ëi⁄s
[ªcovîy->
∑geCou¡
])) {

422 
com∂ëi⁄
 = &
ªcovîy
->
∑geCom∂ëi⁄s
[0];

424  
com∂ëi⁄
;

425 
	}
}

433 
	$ªcovîRódyPages
(
BlockM≠RecovîyCom∂ëi⁄
 *
ªcovîy
,

434 
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

436 i‡(
	`föishIfD⁄e
(
ªcovîy
)) {

440 
VDOPageCom∂ëi⁄
 *
∑geCom∂ëi⁄
 = (VDOPageCom∂ëi⁄ *Ë
com∂ëi⁄
;

441 i‡(
ªcovîy
->
pbn
 !
∑geCom∂ëi⁄
->pbn) {

445 
∑geCom∂ëi⁄
->
ªady
) {

446 
BlockM≠Page
 *
∑ge
 = 
	`dîe„ªn˚WrôabÀVDOPage
(
com∂ëi⁄
);

447 
ªsu…
 = 
	`ASSERT
(
∑ge
 !
NULL
, "pageávailable");

448 i‡(
ªsu…
 !
VDO_SUCCESS
) {

449 
	`ab‹tRecovîy
(
ªcovîy
, 
ªsu…
);

453 
NumbîedBlockM≠pög
 *
°¨tOfNextPage


454 
	`födE¡rySèπögNextPage
(
ªcovîy
,Ñecovîy->
cuºítE¡ry
, 
Ál£
);

455 
	`≠∂yJou∫ÆE¡rõsToPage
(
∑ge
, 
ªcovîy
->
cuºítE¡ry
, 
°¨tOfNextPage
);

456 
ªcovîy
->
cuºítE¡ry
 = 
°¨tOfNextPage
;

457 
	`ªque°VDOPageWrôe
(
com∂ëi⁄
);

458 
	`ªÀa£VDOPageCom∂ëi⁄
(
com∂ëi⁄
);

460 i‡(
	`föishIfD⁄e
(
ªcovîy
)) {

464 
ªcovîy
->
pbn
 =Ñecovîy->
cuºítE¡ry
->
blockM≠SlŸ
.pbn;

465 
	`„tchPage
(
ªcovîy
, 
com∂ëi⁄
);

466 
∑geCom∂ëi⁄
 = 
	`gëNextPageCom∂ëi⁄
(
ªcovîy
,ÖageCompletion);

467 
com∂ëi⁄
 = &
∑geCom∂ëi⁄
->completion;

469 
	}
}

472 
	$ªcovîBlockM≠
(
VDO
 *
vdo
,

473 
BlockCou¡
 
íåyCou¡
,

474 
NumbîedBlockM≠pög
 *
jou∫ÆE¡rõs
,

475 
VDOCom∂ëi⁄
 *
∑ª¡
)

477 
BlockM≠RecovîyCom∂ëi⁄
 *
ªcovîy
;

478 
ªsu…
 = 
	`makeRecovîyCom∂ëi⁄
(
vdo
, 
íåyCou¡
, 
jou∫ÆE¡rõs
, 
∑ª¡
,

479 &
ªcovîy
);

480 i‡(
ªsu…
 !
VDO_SUCCESS
) {

481 
	`föishCom∂ëi⁄
(
∑ª¡
, 
ªsu…
);

485 i‡(
	`isHópEm±y
(&
ªcovîy
->
ª∂ayHóp
)) {

486 
	`föishCom∂ëi⁄
(&
ªcovîy
->
com∂ëi⁄
, 
VDO_SUCCESS
);

490 
NumbîedBlockM≠pög
 *
fú°S‹ãdE¡ry


491 
	`s‹tNextHópEÀmít
(&
ªcovîy
->
ª∂ayHóp
);

492 
	`ASSERT_LOG_ONLY
(
fú°S‹ãdE¡ry
 =
ªcovîy
->
cuºítE¡ry
,

496 
ªcovîy
->
œunchög
 = 
åue
;

497 
ªcovîy
->
pbn
 =Ñecovîy->
cuºítE¡ry
->
blockM≠SlŸ
.pbn;

498 
ªcovîy
->
cuºítUn„tchedE¡ry
 =Ñecovîy->
cuºítE¡ry
;

499 
PageCou¡
 
i
 = 0; i < 
ªcovîy
->
∑geCou¡
; i++) {

500 i‡(
ªcovîy
->
cuºítUn„tchedE¡ry
 <Ñecovîy->
jou∫ÆE¡rõs
) {

504 
	`„tchPage
(
ªcovîy
, &ªcovîy->
∑geCom∂ëi⁄s
[
i
].
com∂ëi⁄
);

506 
ªcovîy
->
œunchög
 = 
Ál£
;

509 
	`ªcovîRódyPages
(
ªcovîy
, &ªcovîy->
∑geCom∂ëi⁄s
[0].
com∂ëi⁄
);

510 
	}
}

	@vdo/base/blockMapRecovery.h

22 #i‚de‡
BLOCK_MAP_RECOVERY_H


23 
	#BLOCK_MAP_RECOVERY_H


	)

25 
	~"blockM≠.h
"

26 
	~"blockM≠pögSèã.h
"

27 
	~"ty≥s.h
"

35 
BlockM≠SlŸ
 
	mblockM≠SlŸ
;

36 
BlockM≠E¡ry
 
	mblockM≠E¡ry
;

37 
uöt32_t
 
	mnumbî
;

38 } 
	t__©åibuã__
((
	t∑cked
)Ë
	tNumbîedBlockM≠pög
;

48 
ªcovîBlockM≠
(
VDO
 *
vdo
,

49 
BlockCou¡
 
íåyCou¡
,

50 
NumbîedBlockM≠pög
 *
jou∫ÆE¡rõs
,

51 
VDOCom∂ëi⁄
 *
∑ª¡
);

	@vdo/base/blockMapTree.c

22 
	~"blockM≠Tªe.h
"

24 
	~"loggî.h
"

26 
	~"blockM≠.h
"

27 
	~"blockM≠I¡î«ls.h
"

28 
	~"blockM≠Page.h
"

29 
	~"blockM≠TªeI¡î«ls.h
"

30 
	~"c⁄°™ts.h
"

31 
	~"d©aVIO.h
"

32 
	~"dútyLi°s.h
"

33 
	~"f‹e°.h
"

34 
	~"numUtûs.h
"

35 
	~"ªcovîyJou∫Æ.h
"

36 
	~"ª„ªn˚O≥øti⁄.h
"

37 
	~"¶abDïŸ.h
"

38 
	~"¶abJou∫Æ.h
"

39 
	~"ty≥s.h
"

40 
	~"vdoI¡î«l.h
"

41 
	~"vioPoﬁ.h
"

44 
	mBLOCK_MAP_VIO_POOL_SIZE
 = 64,

47 
__©åibuã__
((
	t∑cked
)) {

48 
RoŸCou¡
 
	groŸIndex
;

49 
Height
 
	gheight
;

50 
PageNumbî
 
	g∑geIndex
;

51 
SlŸNumbî
 
	g¶Ÿ
;

52 } 
	tPageDes¸ùt‹
;

55 
PageDes¸ùt‹
 
	mdes¸ùt‹
;

56 
uöt64_t
 
	mkey
;

57 } 
	tPageKey
;

60 
BlockM≠TªeZ⁄e
 *
	mz⁄e
;

61 
uöt8_t
 
	mgíî©i⁄
;

62 } 
	tWrôeIfNŸDútõdC⁄ãxt
;

68 c⁄° 
PhysiˇlBlockNumbî
 
	gINVALID_PBN
 = 0xFFFFFFFFFFFFFFFF;

77 
ölöe
 
TªePage
 *
	$åìPageFromRögNode
(
RögNode
 *
rögNode
)

79  (
TªePage
 *Ë((
byã
 *Ë
rögNode
 - 
	`off£tof
(TªePage, 
node
));

80 
	}
}

83 
wrôeDútyPagesCÆlback
(
RögNode
 *
expúed
, *
c⁄ãxt
);

90 
__©åibuã__
((
w¨n_unu£d_ªsu…
))

91 
	$makeBlockM≠VIOs
(
PhysiˇlLayî
 *
œyî
,

92 *
∑ª¡
,

93 *
buf„r
,

94 
VIO
 **
vioPå
)

96  
	`¸óãVIO
(
œyî
, 
VIO_TYPE_BLOCK_MAP_INTERIOR
, 
VIO_PRIORITY_METADATA
,

97 
∑ª¡
, 
buf„r
, 
vioPå
);

98 
	}
}

101 
	$öôülizeTªeZ⁄e
(
BlockM≠Z⁄e
 *
z⁄e
,

102 
PhysiˇlLayî
 *
œyî
,

103 
RódO∆yModeC⁄ãxt
 *
ªadO∆yC⁄ãxt
,

104 
BlockCou¡
 
îaLígth
)

106 
	`STATIC_ASSERT_SIZEOF
(
PageDes¸ùt‹
, (
uöt64_t
));

107 
BlockM≠TªeZ⁄e
 *
åìZ⁄e
 = &
z⁄e
->treeZone;

108 
åìZ⁄e
->
m≠Z⁄e
 = 
z⁄e
;

109 
åìZ⁄e
->
ªadO∆yC⁄ãxt
 =ÑeadOnlyContext;

111 
ªsu…
 = 
	`makeDútyLi°s
(
îaLígth
, 
wrôeDútyPagesCÆlback
, 
åìZ⁄e
,

112 &
åìZ⁄e
->
dútyLi°s
);

113 i‡(
ªsu…
 !
VDO_SUCCESS
) {

114  
ªsu…
;

117 
ªsu…
 = 
	`makeI¡M≠
(
LOCK_MAP_CAPACITY
, 0, &
åìZ⁄e
->
lﬂdögPages
);

118 i‡(
ªsu…
 !
VDO_SUCCESS
) {

119  
ªsu…
;

122  
	`makeVIOPoﬁ
(
œyî
, 
BLOCK_MAP_VIO_POOL_SIZE
, 
makeBlockM≠VIOs
,

123 
åìZ⁄e
, &åìZ⁄e->
vioPoﬁ
);

124 
	}
}

127 
	$ª∂a˚TªeZ⁄eVIOPoﬁ
(
BlockM≠TªeZ⁄e
 *
z⁄e
,

128 
PhysiˇlLayî
 *
œyî
,

129 
size_t
 
poﬁSize
)

131 
	`‰ìVIOPoﬁ
(&
z⁄e
->
vioPoﬁ
);

132  
	`makeVIOPoﬁ
(
œyî
, 
poﬁSize
, 
makeBlockM≠VIOs
, 
z⁄e
, &z⁄e->
vioPoﬁ
);

133 
	}
}

136 
	$unöôülizeBlockM≠TªeZ⁄e
(
BlockM≠TªeZ⁄e
 *
åìZ⁄e
)

138 
	`‰ìDútyLi°s
(&
åìZ⁄e
->
dútyLi°s
);

139 
	`‰ìVIOPoﬁ
(&
åìZ⁄e
->
vioPoﬁ
);

140 
	`‰ìI¡M≠
(&
åìZ⁄e
->
lﬂdögPages
);

141 
	}
}

144 
	$£tTªeZ⁄eInôülPîiod
(
BlockM≠TªeZ⁄e
 *
åìZ⁄e
,

145 
Sequí˚Numbî
 
≥riod
)

147 
	`£tCuºítPîiod
(
åìZ⁄e
->
dútyLi°s
, 
≥riod
);

148 
	}
}

157 
__©åibuã__
((
w¨n_unu£d_ªsu…
))

158 
ölöe
 
BlockM≠TªeZ⁄e
 *
	$gëBlockM≠TªeZ⁄e
(
D©aVIO
 *
d©aVIO
)

160  &(
	`gëBlockM≠F‹Z⁄e
(
d©aVIO
->
logiˇl
.
z⁄e
)->
åìZ⁄e
);

161 
	}
}

171 
ölöe
 
BlockM≠Tªe
 *
	$gëTªe
(
BlockM≠TªeZ⁄e
 *
z⁄e
, 
D©aVIO
 *
d©aVIO
)

173 
RoŸCou¡
 
roŸIndex
 = 
d©aVIO
->
åìLock
.rootIndex;

174  
	`gëTªeFromF‹e°
(
z⁄e
->
m≠Z⁄e
->
blockM≠
->
f‹e°
, 
roŸIndex
);

175 
	}
}

187 
ölöe
 
TªePage
 *
	$gëTªePage
(
BlockM≠TªeZ⁄e
 *
z⁄e
,

188 
BlockM≠Tªe
 *
åì
,

189 
TªeLock
 *
lock
)

191  
	`gëTªePageByIndex
(
z⁄e
->
m≠Z⁄e
->
blockM≠
->
f‹e°
, 
åì
,

192 
lock
->
height
,

193 
lock
->
åìSlŸs
[lock->
height
].
∑geIndex
);

194 
	}
}

197 
boﬁ
 
	$c›yVÆidPage
(*
buf„r
,

198 
N⁄˚
 
n⁄˚
,

199 
PhysiˇlBlockNumbî
 
pbn
,

200 
BlockM≠Page
 *
∑ge
)

202 
BlockM≠Page
 *
lﬂded
 = (BlockM≠Pagê*Ë
buf„r
;

203 
BlockM≠PageVÆidôy
 
vÆidôy
 = 
	`vÆid©eBlockM≠Page
(
lﬂded
, 
n⁄˚
, 
pbn
);

204 i‡(
vÆidôy
 =
BLOCK_MAP_PAGE_VALID
) {

205 
	`mem˝y
(
∑ge
, 
lﬂded
, 
VDO_BLOCK_SIZE
);

206  
åue
;

209 i‡(
vÆidôy
 =
BLOCK_MAP_PAGE_BAD
) {

210 
	`logEº‹WôhSåögEº‹
(
VDO_BAD_PAGE
,

211 "Ex≥˘edÖagê%" 
PRIu64


212 " buàgŸÖagê%" 
PRIu64
 " instead",

213 
pbn
, 
lﬂded
->
hódî
.pbn);

216  
Ál£
;

217 
	}
}

225 
	$checkF‹IOCom∂ëe
(
BlockM≠TªeZ⁄e
 *
z⁄e
)

227 i‡((
z⁄e
->
m≠Z⁄e
->
admöSèã
 !
ADMIN_STATE_CLOSING
)

228 || (
z⁄e
->
a˘iveLookups
 > 0Ë|| 
	`hasWaôîs
(&z⁄e->
ÊushWaôîs
)) {

232 
z⁄e
->
m≠Z⁄e
->
admöSèã
 = 
ADMIN_STATE_CLOSED
;

233 i‡(
	`isRódO∆y
(
z⁄e
->
ªadO∆yC⁄ãxt
)) {

234 
	`£tCom∂ëi⁄Resu…
(&
z⁄e
->
m≠Z⁄e
->
com∂ëi⁄
, 
VDO_READ_ONLY
);

236 
	`˛o£Obje˘Poﬁ
(
z⁄e
->
vioPoﬁ
, &z⁄e->
m≠Z⁄e
->
com∂ëi⁄
);

237 
	}
}

245 
	$íãrZ⁄eRódO∆yMode
(
BlockM≠TªeZ⁄e
 *
z⁄e
, 
ªsu…
)

247 
	`íãrRódO∆yMode
(
z⁄e
->
ªadO∆yC⁄ãxt
, 
ªsu…
);

251 
	`hasWaôîs
(&
z⁄e
->
ÊushWaôîs
)) {

252 
	`dequeueNextWaôî
(&
z⁄e
->
ÊushWaôîs
);

255 
	`checkF‹IOCom∂ëe
(
z⁄e
);

256 
	}
}

269 
__©åibuã__
((
w¨n_unu£d_ªsu…
))

270 
boﬁ
 
	$isNŸOldî
(
BlockM≠TªeZ⁄e
 *
z⁄e
, 
uöt8_t
 
a
, uöt8_à
b
)

272 
ªsu…
 = 
	`ASSERT
((
	`öCy˛icR™ge
(
z⁄e
->
ﬁde°Gíî©i⁄
, 
a
,

273 
z⁄e
->
gíî©i⁄
, 1 << 8)

274 && 
	`öCy˛icR™ge
(
z⁄e
->
ﬁde°Gíî©i⁄
, 
b
,

275 
z⁄e
->
gíî©i⁄
, 1 << 8)),

277 
a
, 
b
, 
z⁄e
->
ﬁde°Gíî©i⁄
, z⁄e->
gíî©i⁄
);

278 i‡(
ªsu…
 !
VDO_SUCCESS
) {

279 
	`íãrZ⁄eRódO∆yMode
(
z⁄e
, 
ªsu…
);

280  
åue
;

283  
	`öCy˛icR™ge
(
b
, 
a
, 
z⁄e
->
gíî©i⁄
, 1 << 8);

284 
	}
}

293 
	$ªÀa£Gíî©i⁄
(
BlockM≠TªeZ⁄e
 *
z⁄e
, 
uöt8_t
 
gíî©i⁄
)

295 
ªsu…
 = 
	`ASSERT
((
z⁄e
->
dútyPageCou¡s
[
gíî©i⁄
] > 0),

297 
gíî©i⁄
);

298 i‡(
ªsu…
 !
VDO_SUCCESS
) {

299 
	`íãrZ⁄eRódO∆yMode
(
z⁄e
, 
ªsu…
);

303 
z⁄e
->
dútyPageCou¡s
[
gíî©i⁄
]--;

304 (
z⁄e
->
dútyPageCou¡s
[z⁄e->
ﬁde°Gíî©i⁄
] == 0)

305 && (
z⁄e
->
ﬁde°Gíî©i⁄
 !z⁄e->
gíî©i⁄
)) {

306 
z⁄e
->
ﬁde°Gíî©i⁄
++;

308 
	}
}

319 
	$£tGíî©i⁄
(
BlockM≠TªeZ⁄e
 *
z⁄e
,

320 
TªePage
 *
∑ge
,

321 
uöt8_t
 
√wGíî©i⁄
,

322 
boﬁ
 
de¸emítOld
)

324 
PageHódî
 *
hódî
 = &(
	`asBlockM≠Page
(
∑ge
)->header);

325 
uöt8_t
 
ﬁdGíî©i⁄
 = 
hódî
->
gíî©i⁄
;

326 i‡(
de¸emítOld
 && (
ﬁdGíî©i⁄
 =
√wGíî©i⁄
)) {

330 
hódî
->
gíî©i⁄
 = 
√wGíî©i⁄
;

331 
uöt32_t
 
√wCou¡
 = ++
z⁄e
->
dútyPageCou¡s
[
√wGíî©i⁄
];

332 
ªsu…
 = 
	`ASSERT
((
√wCou¡
 != 0),

334 
√wGíî©i⁄
);

335 i‡(
ªsu…
 !
VDO_SUCCESS
) {

336 
	`íãrZ⁄eRódO∆yMode
(
z⁄e
, 
ªsu…
);

340 i‡(
de¸emítOld
) {

341 
	`ªÀa£Gíî©i⁄
(
z⁄e
, 
ﬁdGíî©i⁄
);

343 
	}
}

346 
wrôePage
(
TªePage
 *
åìPage
, 
VIOPoﬁE¡ry
 *
íåy
);

347 
wrôePageCÆlback
(
Waôî
 *
waôî
, *
c⁄ãxt
);

355 
	$acquúeVIO
(
Waôî
 *
waôî
, 
BlockM≠TªeZ⁄e
 *
z⁄e
)

357 
waôî
->
ˇŒback
 = 
wrôePageCÆlback
;

358 
ªsu…
 = 
	`acquúeVIOFromPoﬁ
(
z⁄e
->
vioPoﬁ
, 
waôî
);

359 i‡(
ªsu…
 !
VDO_SUCCESS
) {

360 
	`íãrZ⁄eRódO∆yMode
(
z⁄e
, 
ªsu…
);

362 
	}
}

372 
boﬁ
 
	$©ãm±In¸emít
(
BlockM≠TªeZ⁄e
 *
z⁄e
)

374 
uöt8_t
 
gíî©i⁄
 = 
z⁄e
->generation + 1;

375 i‡(
z⁄e
->
ﬁde°Gíî©i⁄
 =
gíî©i⁄
) {

376  
Ál£
;

379 
z⁄e
->
gíî©i⁄
 = generation;

380  
åue
;

381 
	}
}

390 
	$íqueuePage
(
TªePage
 *
∑ge
, 
BlockM≠TªeZ⁄e
 *
z⁄e
)

392 i‡((
z⁄e
->
Êushî
 =
NULL
Ë&& 
	`©ãm±In¸emít
(zone)) {

393 
z⁄e
->
Êushî
 = 
∑ge
;

394 
	`acquúeVIO
(&
∑ge
->
waôî
, 
z⁄e
);

398 
ªsu…
 = 
	`íqueueWaôî
(&
z⁄e
->
ÊushWaôîs
, &
∑ge
->
waôî
);

399 i‡(
ªsu…
 !
VDO_SUCCESS
) {

400 
	`íãrZ⁄eRódO∆yMode
(
z⁄e
, 
ªsu…
);

402 
	}
}

413 
	$wrôePageIfNŸDútõd
(
Waôî
 *
waôî
, *
c⁄ãxt
)

415 
TªePage
 *
∑ge
 = (TªePagê*Ë
waôî
;

416 
WrôeIfNŸDútõdC⁄ãxt
 *
wrôeC⁄ãxt


417 (
WrôeIfNŸDútõdC⁄ãxt
 *Ë
c⁄ãxt
;

418 i‡(
	`asBlockM≠Page
(
∑ge
)->
hódî
.
gíî©i⁄
 =
wrôeC⁄ãxt
->generation) {

419 
	`acquúeVIO
(
waôî
, 
wrôeC⁄ãxt
->
z⁄e
);

423 
	`íqueuePage
(
∑ge
, 
wrôeC⁄ãxt
->
z⁄e
);

424 
	}
}

432 
	$föishPageWrôe
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

434 
VIOPoﬁE¡ry
 *
íåy
 = 
com∂ëi⁄
->
∑ª¡
;

435 
PageHódî
 
wrôãnHódî
 = ((
BlockM≠Page
 *Ë
íåy
->
buf„r
)->
hódî
;

436 
BlockM≠TªeZ⁄e
 *
z⁄e
 = 
íåy
->
c⁄ãxt
;

437 
	`ªÀa£RecovîyJou∫ÆBlockRe„ªn˚
(
z⁄e
->
m≠Z⁄e
->
blockM≠
->
jou∫Æ
,

438 
wrôãnHódî
.
ªcovîySequí˚Numbî
,

439 
ZONE_TYPE_LOGICAL
,

440 
z⁄e
->
m≠Z⁄e
->
z⁄eNumbî
);

442 
TªePage
 *
∑ge
 = (TªePagê*Ë
íåy
->
∑ª¡
;

443 
PageHódî
 *
hódî
 = &(
	`asBlockM≠Page
(
∑ge
)->header);

444 
boﬁ
 
dúty
 = (
wrôãnHódî
.
gíî©i⁄
 !
hódî
->generation);

445 
	`ªÀa£Gíî©i⁄
(
z⁄e
, 
wrôãnHódî
.
gíî©i⁄
);

446 
hódî
->
öãri‹TªePageWrôög
 = 
Ál£
;

448 i‡(
z⁄e
->
Êushî
 =
∑ge
) {

449 
WrôeIfNŸDútõdC⁄ãxt
 
c⁄ãxt
 = {

450 .
z⁄e
 = zone,

451 .
gíî©i⁄
 = 
wrôãnHódî
.generation,

453 
	`nŸifyAŒWaôîs
(&
z⁄e
->
ÊushWaôîs
, 
wrôePageIfNŸDútõd
, &
c⁄ãxt
);

454 i‡(
dúty
 && 
	`©ãm±In¸emít
(
z⁄e
)) {

455 
	`wrôePage
(
∑ge
, 
íåy
);

459 
z⁄e
->
Êushî
 = 
NULL
;

462 i‡(
dúty
) {

463 
	`íqueuePage
(
∑ge
, 
z⁄e
);

464 } i‡((
z⁄e
->
Êushî
 =
NULL
)

465 && 
	`hasWaôîs
(&
z⁄e
->
ÊushWaôîs
)

466 && 
	`©ãm±In¸emít
(
z⁄e
)) {

467 
z⁄e
->
Êushî
 = (
TªePage
 *Ë
	`dequeueNextWaôî
(&z⁄e->
ÊushWaôîs
);

468 
	`wrôePage
(
z⁄e
->
Êushî
, 
íåy
);

472 
	`checkF‹IOCom∂ëe
(
z⁄e
);

473 
	`ªtu∫VIOToPoﬁ
(
z⁄e
->
vioPoﬁ
, 
íåy
);

474 
	}
}

482 
	$h™dÀWrôeEº‹
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

484 
ªsu…
 = 
com∂ëi⁄
->result;

485 
VIOPoﬁE¡ry
 *
íåy
 = 
com∂ëi⁄
->
∑ª¡
;

486 
BlockM≠TªeZ⁄e
 *
z⁄e
 = 
íåy
->
c⁄ãxt
;

487 
	`íãrZ⁄eRódO∆yMode
(
z⁄e
, 
ªsu…
);

488 
	`ªtu∫VIOToPoﬁ
(
z⁄e
->
vioPoﬁ
, 
íåy
);

489 
	}
}

497 
	$wrôeInôülizedPage
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

499 
VIOPoﬁE¡ry
 *
íåy
 = 
com∂ëi⁄
->
∑ª¡
;

500 
BlockM≠TªeZ⁄e
 *
z⁄e
 = (BlockM≠TªeZ⁄ê*Ë
íåy
->
c⁄ãxt
;

501 
TªePage
 *
åìPage
 = (TªePagê*Ë
íåy
->
∑ª¡
;

508 
PageHódî
 *
hódî
 = &(((
BlockM≠Page
 *Ë
íåy
->
buf„r
)->header);

509 
hódî
->
öôülized
 = 
åue
;

510 
	`œunchWrôeMëad©aVIOWôhFlush
(
íåy
->
vio
, 
hódî
->
pbn
, 
föishPageWrôe
,

511 
h™dÀWrôeEº‹
,

512 (
z⁄e
->
Êushî
 =
åìPage
), 
Ál£
);

513 
	}
}

521 
	$wrôePage
(
TªePage
 *
åìPage
, 
VIOPoﬁE¡ry
 *
íåy
)

523 
BlockM≠TªeZ⁄e
 *
z⁄e
 = (BlockM≠TªeZ⁄ê*Ë
íåy
->
c⁄ãxt
;

524 
BlockM≠Page
 *
∑ge
 = 
	`asBlockM≠Page
(
åìPage
);

525 i‡((
z⁄e
->
Êushî
 !
åìPage
)

526 && (
	`isNŸOldî
(
z⁄e
, 
∑ge
->
hódî
.
gíî©i⁄
, zone->generation))) {

529 
	`íqueuePage
(
åìPage
, 
z⁄e
);

530 
	`ªtu∫VIOToPoﬁ
(
z⁄e
->
vioPoﬁ
, 
íåy
);

534 
íåy
->
∑ª¡
 = 
åìPage
;

535 
	`mem˝y
(
íåy
->
buf„r
, 
åìPage
->
∑geBuf„r
, 
VDO_BLOCK_SIZE
);

537 
VDOCom∂ëi⁄
 *
com∂ëi⁄
 = 
	`vioAsCom∂ëi⁄
(
íåy
->
vio
);

538 
com∂ëi⁄
->
ˇŒbackThªadID
 = 
z⁄e
->
m≠Z⁄e
->
thªadID
;

541 
∑ge
->
hódî
.
ªcovîySequí˚Numbî
 = 0;

542 
∑ge
->
hódî
.
öãri‹TªePageWrôög
 = 
åue
;

544 i‡(
∑ge
->
hódî
.
öôülized
) {

545 
	`wrôeInôülizedPage
(
com∂ëi⁄
);

549 
∑ge
->
hódî
.
öôülized
 = 
åue
;

550 
	`œunchWrôeMëad©aVIO
(
íåy
->
vio
, 
∑ge
->
hódî
.
pbn
, 
wrôeInôülizedPage
,

551 
h™dÀWrôeEº‹
);

552 
	}
}

563 
	$wrôePageCÆlback
(
Waôî
 *
waôî
, *
c⁄ãxt
)

565 
	`wrôePage
((
TªePage
 *Ë
waôî
, (
VIOPoﬁE¡ry
 *Ë
c⁄ãxt
);

566 
	}
}

576 
	$wrôeDútyPagesCÆlback
(
RögNode
 *
expúed
, *
c⁄ãxt
)

578 
BlockM≠TªeZ⁄e
 *
z⁄e
 = (BlockM≠TªeZ⁄ê*Ë
c⁄ãxt
;

579 
uöt8_t
 
gíî©i⁄
 = 
z⁄e
->generation;

580 !
	`isRögEm±y
(
expúed
)) {

581 
TªePage
 *
∑ge
 = 
	`åìPageFromRögNode
(
	`ch›RögNode
(
expúed
));

583 
ªsu…
 = 
	`ASSERT
(!
	`isWaôög
(&
∑ge
->
waôî
),

585 i‡(
ªsu…
 !
VDO_SUCCESS
) {

586 
	`íãrZ⁄eRódO∆yMode
(
z⁄e
, 
ªsu…
);

590 
	`£tGíî©i⁄
(
z⁄e
, 
∑ge
, 
gíî©i⁄
, 
Ál£
);

591 i‡(!(
	`asBlockM≠Page
(
∑ge
)->
hódî
.
öãri‹TªePageWrôög
)) {

592 
	`íqueuePage
(
∑ge
, 
z⁄e
);

595 
	}
}

598 
	$adv™˚Z⁄eTªePîiod
(
BlockM≠TªeZ⁄e
 *
z⁄e
, 
Sequí˚Numbî
 
≥riod
)

600 
	`adv™˚Pîiod
(
z⁄e
->
dútyLi°s
, 
≥riod
);

601 
	}
}

604 
	$˛o£Z⁄eTªes
(
BlockM≠TªeZ⁄e
 *
z⁄e
)

606 i‡(
z⁄e
->
m≠Z⁄e
->
admöSèã
 =
ADMIN_STATE_CLOSED
) {

607 
	`föishCom∂ëi⁄
(&
z⁄e
->
m≠Z⁄e
->
com∂ëi⁄
, 
VDO_SUCCESS
);

611 i‡(
z⁄e
->
a˘iveLookups
 > 0) {

612 
z⁄e
->
m≠Z⁄e
->
admöSèã
 = 
ADMIN_STATE_CLOSE_REQUESTED
;

616 
z⁄e
->
m≠Z⁄e
->
admöSèã
 = 
ADMIN_STATE_CLOSING
;

617 
	`ÊushDútyLi°s
(
z⁄e
->
dútyLi°s
);

618 
	`checkF‹IOCom∂ëe
(
z⁄e
);

619 
	}
}

622 
	$su•ídZ⁄eTªes
(
BlockM≠TªeZ⁄e
 *
z⁄e
, 
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

624 
	`su•ídObje˘Poﬁ
(
z⁄e
->
vioPoﬁ
, 
com∂ëi⁄
);

625 
	}
}

628 
	$ªsumeZ⁄eTªes
(
BlockM≠TªeZ⁄e
 *
z⁄e
)

630 
	`ªsumeObje˘Poﬁ
(
z⁄e
->
vioPoﬁ
);

631 
	}
}

639 
	$ªÀa£PageLock
(
D©aVIO
 *
d©aVIO
, *
wh©
)

641 
TªeLock
 *
lock
 = &
d©aVIO
->
åìLock
;

642 
	`ASSERT_LOG_ONLY
(
lock
->
locked
,

643 "ªÀa£ o‡u∆ocked block m≠Öagê%†f‹ key %" 
PRIu64


645 
wh©
, 
lock
->
key
,Üock->
roŸIndex
);

646 
BlockM≠TªeZ⁄e
 *
z⁄e
 = 
	`gëBlockM≠TªeZ⁄e
(
d©aVIO
);

647 
TªeLock
 *
lockHﬁdî
 = 
	`ötM≠Remove
(
z⁄e
->
lﬂdögPages
, 
lock
->
key
);

648 
	`ASSERT_LOG_ONLY
((
lockHﬁdî
 =
lock
),

649 "block m≠Öagê%†mism©ch f‹ key %" 
PRIu64
 " inÅree %u",

650 
wh©
, 
lock
->
key
,Üock->
roŸIndex
);

651 
lock
->
locked
 = 
Ál£
;

652 
	}
}

660 
	$föishLookup
(
D©aVIO
 *
d©aVIO
, 
ªsu…
)

662 
d©aVIO
->
åìLock
.
height
 = 0;

664 
BlockM≠TªeZ⁄e
 *
z⁄e
 = 
	`gëBlockM≠TªeZ⁄e
(
d©aVIO
);

665 
VDOCom∂ëi⁄
 *
com∂ëi⁄
 = 
	`d©aVIOAsCom∂ëi⁄
(
d©aVIO
);

666 
	`£tCom∂ëi⁄Resu…
(
com∂ëi⁄
, 
ªsu…
);

667 
	`œunchCÆlback
(
com∂ëi⁄
, 
d©aVIO
->
åìLock
.
ˇŒback
,

668 
d©aVIO
->
åìLock
.
thªadID
);

669 i‡((--
z⁄e
->
a˘iveLookups
 == 0)

670 && (
z⁄e
->
m≠Z⁄e
->
admöSèã
 =
ADMIN_STATE_CLOSE_REQUESTED
)) {

671 
	`˛o£Z⁄eTªes
(
z⁄e
);

673 
	}
}

682 
	$ab‹tLookupF‹Waôî
(
Waôî
 *
waôî
, *
c⁄ãxt
)

684 
D©aVIO
 *
d©aVIO
 = 
	`waôîAsD©aVIO
(
waôî
);

685 
ªsu…
 = *((*Ë
c⁄ãxt
);

686 i‡(
	`isRódD©aVIO
(
d©aVIO
)) {

687 i‡(
ªsu…
 =
VDO_NO_SPACE
) {

688 
ªsu…
 = 
VDO_SUCCESS
;

690 } i‡(
ªsu…
 !
VDO_NO_SPACE
) {

691 
ªsu…
 = 
VDO_READ_ONLY
;

694 
	`föishLookup
(
d©aVIO
, 
ªsu…
);

695 
	}
}

704 
	$ab‹tLookup
(
D©aVIO
 *
d©aVIO
, 
ªsu…
, *
wh©
)

706 i‡(
ªsu…
 !
VDO_NO_SPACE
) {

707 
	`íãrZ⁄eRódO∆yMode
(
	`gëBlockM≠TªeZ⁄e
(
d©aVIO
), 
ªsu…
);

710 i‡(
d©aVIO
->
åìLock
.
locked
) {

711 
	`ªÀa£PageLock
(
d©aVIO
, 
wh©
);

712 
	`nŸifyAŒWaôîs
(&
d©aVIO
->
åìLock
.
waôîs
, 
ab‹tLookupF‹Waôî
,

713 &
ªsu…
);

716 
	`föishLookup
(
d©aVIO
, 
ªsu…
);

717 
	}
}

725 
	$ab‹tLﬂd
(
D©aVIO
 *
d©aVIO
, 
ªsu…
)

727 
	`ab‹tLookup
(
d©aVIO
, 
ªsu…
, "load");

728 
	}
}

739 
__©åibuã__
((
w¨n_unu£d_ªsu…
))

740 
boﬁ
 
	$isInvÆidTªeE¡ry
(c⁄° 
VDO
 *
vdo
,

741 c⁄° 
BlockM≠E¡ry
 *
íåy
,

742 
Height
 
height
)

744 
PhysiˇlBlockNumbî
 
pbn
 = 
	`u≈ackPBN
(
íåy
);

745 i‡(
	`isInvÆid
(
íåy
)

746 || 
	`isCom¥es£d
(
íåy
->
m≠pögSèã
)

747 || (!
	`isUnm≠≥d
(
íåy
Ë&& (
pbn
 =
ZERO_BLOCK
))) {

748  
åue
;

752 i‡(
height
 =
BLOCK_MAP_TREE_HEIGHT
) {

753  
Ál£
;

756  !
	`isPhysiˇlD©aBlock
(
vdo
->
dïŸ
, 
pbn
);

757 
	}
}

760 
lﬂdBlockM≠Page
(
BlockM≠TªeZ⁄e
 *
z⁄e
, 
D©aVIO
 *
d©aVIO
);

761 
ÆloˇãBlockM≠Page
(
BlockM≠TªeZ⁄e
 *
z⁄e
, 
D©aVIO
 *
d©aVIO
);

770 
	$c⁄töueWôhLﬂdedPage
(
D©aVIO
 *
d©aVIO
, 
BlockM≠Page
 *
∑ge
)

772 
TªeLock
 *
lock
 = &
d©aVIO
->
åìLock
;

773 
BlockM≠TªeSlŸ
 
¶Ÿ
 = 
lock
->
åìSlŸs
[lock->
height
];

774 c⁄° 
BlockM≠E¡ry
 *
íåy
 = &
∑ge
->
íåõs
[
¶Ÿ
.
blockM≠SlŸ
.slot];

775 i‡(
	`isInvÆidTªeE¡ry
(
	`gëVDOFromD©aVIO
(
d©aVIO
), 
íåy
, 
lock
->
height
)) {

776 
	`logEº‹WôhSåögEº‹
(
VDO_BAD_MAPPING
,

777 "InvÆid block m≠ÅªêPBN: %" 
PRIu64
 " with "

779 
	`u≈ackPBN
(
íåy
),É¡ry->
m≠pögSèã
,

780 
lock
->
åìSlŸs
[lock->
height
 - 1].
∑geIndex
,

781 
lock
->
height
 - 1);

782 
	`ab‹tLﬂd
(
d©aVIO
, 
VDO_BAD_MAPPING
);

787 i‡(
	`isUnm≠≥d
(
íåy
)) {

789 
	`ÆloˇãBlockM≠Page
(
	`gëBlockM≠TªeZ⁄e
(
d©aVIO
), dataVIO);

793 
lock
->
åìSlŸs
[lock->
height
 - 1].
blockM≠SlŸ
.
pbn
 = 
	`u≈ackPBN
(
íåy
);

794 i‡(
lock
->
height
 == 1) {

795 
	`föishLookup
(
d©aVIO
, 
VDO_SUCCESS
);

800 
	`lﬂdBlockM≠Page
(
	`gëBlockM≠TªeZ⁄e
(
d©aVIO
), dataVIO);

801 
	}
}

810 
	$c⁄töueLﬂdF‹Waôî
(
Waôî
 *
waôî
, *
c⁄ãxt
)

812 
D©aVIO
 *
d©aVIO
 = 
	`waôîAsD©aVIO
(
waôî
);

813 
d©aVIO
->
åìLock
.
height
--;

814 
	`c⁄töueWôhLﬂdedPage
(
d©aVIO
, (
BlockM≠Page
 *Ë
c⁄ãxt
);

815 
	}
}

823 
	$föishBlockM≠PageLﬂd
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

825 
VIOPoﬁE¡ry
 *
íåy
 = 
com∂ëi⁄
->
∑ª¡
;

826 
D©aVIO
 *
d©aVIO
 = 
íåy
->
∑ª¡
;

827 
BlockM≠TªeZ⁄e
 *
z⁄e
 = (BlockM≠TªeZ⁄ê*Ë
íåy
->
c⁄ãxt
;

828 
BlockM≠Tªe
 *
åì
 = 
	`gëTªe
(
z⁄e
, 
d©aVIO
);

829 
TªeLock
 *
åìLock
 = &
d©aVIO
->treeLock;

831 
åìLock
->
height
--;

832 
PhysiˇlBlockNumbî
 
pbn


833 
åìLock
->
åìSlŸs
[åìLock->
height
].
blockM≠SlŸ
.
pbn
;

834 
TªePage
 *
åìPage
 = 
	`gëTªePage
(
z⁄e
, 
åì
, 
åìLock
);

835 
BlockM≠Page
 *
∑ge
 = (BlockM≠Pagê*Ë
åìPage
->
∑geBuf„r
;

836 
N⁄˚
 
n⁄˚
 = 
z⁄e
->
m≠Z⁄e
->
blockM≠
->nonce;

837 i‡(!
	`c›yVÆidPage
(
íåy
->
buf„r
, 
n⁄˚
, 
pbn
, 
∑ge
)) {

838 
	`f‹m©BlockM≠Page
(
∑ge
, 
n⁄˚
, 
pbn
);

840 
	`ªtu∫VIOToPoﬁ
(
z⁄e
->
vioPoﬁ
, 
íåy
);

843 
	`ªÀa£PageLock
(
d©aVIO
, "load");

844 
	`nŸifyAŒWaôîs
(&
åìLock
->
waôîs
, 
c⁄töueLﬂdF‹Waôî
, 
∑ge
);

845 
	`c⁄töueWôhLﬂdedPage
(
d©aVIO
, 
∑ge
);

846 
	}
}

853 
	$h™dÀIOEº‹
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

855 
ªsu…
 = 
com∂ëi⁄
->result;

856 
VIOPoﬁE¡ry
 *
íåy
 = 
com∂ëi⁄
->
∑ª¡
;

857 
D©aVIO
 *
d©aVIO
 = 
íåy
->
∑ª¡
;

858 
BlockM≠TªeZ⁄e
 *
z⁄e
 = (BlockM≠TªeZ⁄ê*Ë
íåy
->
c⁄ãxt
;

859 
	`ªtu∫VIOToPoﬁ
(
z⁄e
->
vioPoﬁ
, 
íåy
);

860 
	`ab‹tLﬂd
(
d©aVIO
, 
ªsu…
);

861 
	}
}

870 
	$lﬂdPage
(
Waôî
 *
waôî
, *
c⁄ãxt
)

872 
VIOPoﬁE¡ry
 *
íåy
 = 
c⁄ãxt
;

873 
D©aVIO
 *
d©aVIO
 = 
	`waôîAsD©aVIO
(
waôî
);

875 
íåy
->
∑ª¡
 = 
d©aVIO
;

876 
íåy
->
vio
->
com∂ëi⁄
.
ˇŒbackThªadID


877 
	`gëBlockM≠F‹Z⁄e
(
d©aVIO
->
logiˇl
.
z⁄e
)->
thªadID
;

879 
TªeLock
 *
lock
 = &
d©aVIO
->
åìLock
;

880 
	`œunchRódMëad©aVIO
(
íåy
->
vio
,

881 
lock
->
åìSlŸs
[lock->
height
 - 1].
blockM≠SlŸ
.
pbn
,

882 
föishBlockM≠PageLﬂd
, 
h™dÀIOEº‹
);

883 
	}
}

895 
	$©ãm±PageLock
(
BlockM≠TªeZ⁄e
 *
z⁄e
, 
D©aVIO
 *
d©aVIO
)

897 
TªeLock
 *
lock
 = &
d©aVIO
->
åìLock
;

898 
Height
 
height
 = 
lock
->height;

899 
BlockM≠TªeSlŸ
 
åìSlŸ
 = 
lock
->
åìSlŸs
[
height
];

900 
PageKey
 
key
;

901 
key
.
des¸ùt‹
 = (
PageDes¸ùt‹
) {

902 .
roŸIndex
 = 
lock
->rootIndex,

903 .
height
 = height,

904 .
∑geIndex
 = 
åìSlŸ
.pageIndex,

905 .
¶Ÿ
 = 
åìSlŸ
.
blockM≠SlŸ
.slot,

907 
lock
->
key
 = key.key;

909 
TªeLock
 *
lockHﬁdî
;

910 
ªsu…
 = 
	`ötM≠Put
(
z⁄e
->
lﬂdögPages
, 
lock
->
key
,Üock, 
Ál£
,

911 (**Ë&
lockHﬁdî
);

912 i‡(
ªsu…
 !
VDO_SUCCESS
) {

913  
ªsu…
;

916 i‡(
lockHﬁdî
 =
NULL
) {

918 
d©aVIO
->
åìLock
.
locked
 = 
åue
;

919  
VDO_SUCCESS
;

923  
	`íqueueD©aVIO
(&
lockHﬁdî
->
waôîs
, 
d©aVIO
,

924 
	`THIS_LOCATION
("$F;cb=blockMapTreePage"));

925 
	}
}

933 
	$lﬂdBlockM≠Page
(
BlockM≠TªeZ⁄e
 *
z⁄e
, 
D©aVIO
 *
d©aVIO
)

935 
ªsu…
 = 
	`©ãm±PageLock
(
z⁄e
, 
d©aVIO
);

936 i‡(
ªsu…
 !
VDO_SUCCESS
) {

937 
	`ab‹tLﬂd
(
d©aVIO
, 
ªsu…
);

941 i‡(
d©aVIO
->
åìLock
.
locked
) {

942 
Waôî
 *
waôî
 = 
	`d©aVIOAsWaôî
(
d©aVIO
);

943 
waôî
->
ˇŒback
 = 
lﬂdPage
;

944 
ªsu…
 = 
	`acquúeVIOFromPoﬁ
(
z⁄e
->
vioPoﬁ
, 
waôî
);

945 i‡(
ªsu…
 !
VDO_SUCCESS
) {

946 
	`ab‹tLﬂd
(
d©aVIO
, 
ªsu…
);

949 
	}
}

956 
	$£tPo°AŒoˇti⁄CÆlback
(
D©aVIO
 *
d©aVIO
)

958 
	`£tCÆlback
(
	`d©aVIOAsCom∂ëi⁄
(
d©aVIO
), d©aVIO->
åìLock
.
ˇŒback
,

959 
d©aVIO
->
åìLock
.
thªadID
);

960 
	}
}

968 
	$ab‹tAŒoˇti⁄
(
D©aVIO
 *
d©aVIO
, 
ªsu…
)

970 
	`£tPo°AŒoˇti⁄CÆlback
(
d©aVIO
);

971 
	`ab‹tLookup
(
d©aVIO
, 
ªsu…
, "allocation");

972 
	}
}

981 
	$Æloˇti⁄Faûuª
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

983 
D©aVIO
 *
d©aVIO
 = 
	`asD©aVIO
(
com∂ëi⁄
);

984 
	`as£πInLogiˇlZ⁄e
(
d©aVIO
);

985 
	`ab‹tAŒoˇti⁄
(
d©aVIO
, 
com∂ëi⁄
->
ªsu…
);

986 
	}
}

995 
	$c⁄töueAŒoˇti⁄F‹Waôî
(
Waôî
 *
waôî
, *
c⁄ãxt
)

997 
D©aVIO
 *
d©aVIO
 = 
	`waôîAsD©aVIO
(
waôî
);

998 
TªeLock
 *
åìLock
 = &
d©aVIO
->treeLock;

999 
PhysiˇlBlockNumbî
 
pbn
 = *((PhysiˇlBlockNumbî *Ë
c⁄ãxt
);

1001 
åìLock
->
height
--;

1002 
d©aVIO
->
åìLock
.
åìSlŸs
[åìLock->
height
].
blockM≠SlŸ
.
pbn
 =Öbn;

1004 i‡(
åìLock
->
height
 == 0) {

1005 
	`föishLookup
(
d©aVIO
, 
VDO_SUCCESS
);

1009 
	`ÆloˇãBlockM≠Page
(
	`gëBlockM≠TªeZ⁄e
(
d©aVIO
), dataVIO);

1010 
	}
}

1019 
	$föishBlockM≠AŒoˇti⁄
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

1021 
D©aVIO
 *
d©aVIO
 = 
	`asD©aVIO
(
com∂ëi⁄
);

1022 
	`as£πInLogiˇlZ⁄e
(
d©aVIO
);

1023 i‡(
com∂ëi⁄
->
ªsu…
 !
VDO_SUCCESS
) {

1024 
	`Æloˇti⁄Faûuª
(
com∂ëi⁄
);

1028 
BlockM≠TªeZ⁄e
 *
z⁄e
 = 
	`gëBlockM≠TªeZ⁄e
(
d©aVIO
);

1029 
BlockM≠Tªe
 *
åì
 = 
	`gëTªe
(
z⁄e
, 
d©aVIO
);

1030 
TªeLock
 *
åìLock
 = &
d©aVIO
->treeLock;

1031 
TªePage
 *
åìPage
 = 
	`gëTªePage
(
z⁄e
, 
åì
, 
åìLock
);

1032 
Height
 
height
 = 
åìLock
->height;

1034 
PhysiˇlBlockNumbî
 
pbn
 = 
åìLock
->
åìSlŸs
[
height
 - 1].
blockM≠SlŸ
.pbn;

1037 
BlockM≠Page
 *
∑ge
 = (BlockM≠Pagê*Ë
åìPage
->
∑geBuf„r
;

1038 
Sequí˚Numbî
 
ﬁdLock
 = 
∑ge
->
hódî
.
ªcovîySequí˚Numbî
;

1039 
	`upd©eBlockM≠Page
(
d©aVIO
, 
∑ge
, 
pbn
, 
MAPPING_STATE_UNCOMPRESSED
);

1041 i‡(
	`isWaôög
(&
åìPage
->
waôî
)) {

1043 i‡(
z⁄e
->
Êushî
 !
åìPage
) {

1046 
	`£tGíî©i⁄
(
z⁄e
, 
åìPage
, z⁄e->
gíî©i⁄
, 
åue
);

1050 i‡(
ﬁdLock
 == 0) {

1051 
	`öôülizeRög
(&
åìPage
->
node
);

1053 
	`addToDútyLi°s
(
z⁄e
->
dútyLi°s
, &
åìPage
->
node
, 
ﬁdLock
,

1054 
∑ge
->
hódî
.
ªcovîySequí˚Numbî
);

1057 
åìLock
->
height
--;

1058 i‡(
height
 > 1) {

1060 
åìPage
 = 
	`gëTªePage
(
z⁄e
, 
åì
, 
åìLock
);

1061 
	`f‹m©BlockM≠Page
(
åìPage
->
∑geBuf„r
, 
z⁄e
->
m≠Z⁄e
->
blockM≠
->
n⁄˚
,

1062 
pbn
);

1066 
	`ªÀa£PageLock
(
d©aVIO
, "allocation");

1067 
	`nŸifyAŒWaôîs
(&
åìLock
->
waôîs
, 
c⁄töueAŒoˇti⁄F‹Waôî
, &
pbn
);

1068 i‡(
åìLock
->
height
 == 0) {

1069 
	`föishLookup
(
d©aVIO
, 
VDO_SUCCESS
);

1073 
	`ÆloˇãBlockM≠Page
(
z⁄e
, 
d©aVIO
);

1074 
	}
}

1083 
	$ªÀa£BlockM≠WrôeLock
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

1085 
D©aVIO
 *
d©aVIO
 = 
	`asD©aVIO
(
com∂ëi⁄
);

1086 
AŒoˇtögVIO
 *
ÆloˇtögVIO
 = 
	`d©aVIOAsAŒoˇtögVIO
(
d©aVIO
);

1087 
	`as£πInAŒoˇãdZ⁄e
(
d©aVIO
);

1088 i‡(
com∂ëi⁄
->
ªsu…
 !
VDO_SUCCESS
) {

1089 
	`œunchLogiˇlCÆlback
(
d©aVIO
, 
Æloˇti⁄Faûuª
, 
	`THIS_LOCATION
(
NULL
));

1093 
	`ªÀa£PBNWrôeLock
(
ÆloˇtögVIO
);

1094 
	`ª£tAŒoˇti⁄
(
ÆloˇtögVIO
);

1095 
	`œunchLogiˇlCÆlback
(
d©aVIO
, 
föishBlockM≠AŒoˇti⁄
,

1096 
	`THIS_LOCATION
("$F;cb=finishBlockMapAllocation"));

1097 
	}
}

1107 
	$£tBlockM≠PageRe„ªn˚Cou¡
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

1109 
D©aVIO
 *
d©aVIO
 = 
	`asD©aVIO
(
com∂ëi⁄
);

1110 
	`as£πInAŒoˇãdZ⁄e
(
d©aVIO
);

1111 i‡(
com∂ëi⁄
->
ªsu…
 !
VDO_SUCCESS
) {

1112 
	`œunchLogiˇlCÆlback
(
d©aVIO
, 
Æloˇti⁄Faûuª
, 
	`THIS_LOCATION
(
NULL
));

1116 
TªeLock
 *
lock
 = &
d©aVIO
->
åìLock
;

1117 
PhysiˇlBlockNumbî
 
pbn
 = 
lock
->
åìSlŸs
[lock->
height
 - 1].
blockM≠SlŸ
.pbn;

1118 
com∂ëi⁄
->
ˇŒback
 = 
ªÀa£BlockM≠WrôeLock
;

1119 
	`addSœbJou∫ÆE¡ry
(
	`gëSœbJou∫Æ
(
	`gëVDOFromD©aVIO
(
d©aVIO
)->
dïŸ
, 
pbn
),

1120 
d©aVIO
);

1121 
	}
}

1129 
	$jou∫ÆBlockM≠AŒoˇti⁄
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

1131 
D©aVIO
 *
d©aVIO
 = 
	`asD©aVIO
(
com∂ëi⁄
);

1132 
	`as£πInJou∫ÆZ⁄e
(
d©aVIO
);

1133 i‡(
com∂ëi⁄
->
ªsu…
 !
VDO_SUCCESS
) {

1134 
	`œunchLogiˇlCÆlback
(
d©aVIO
, 
Æloˇti⁄Faûuª
, 
	`THIS_LOCATION
(
NULL
));

1138 
	`£tAŒoˇãdZ⁄eCÆlback
(
d©aVIO
, 
£tBlockM≠PageRe„ªn˚Cou¡
,

1139 
	`THIS_LOCATION
(
NULL
));

1140 
	`addRecovîyJou∫ÆE¡ry
(
	`gëVDOFromD©aVIO
(
d©aVIO
)->
ªcovîyJou∫Æ
,

1141 
d©aVIO
);

1142 
	}
}

1151 
	$c⁄töueBlockM≠PageAŒoˇti⁄
(
AŒoˇtögVIO
 *
ÆloˇtögVIO
)

1153 
D©aVIO
 *
d©aVIO
 = 
	`ÆloˇtögVIOAsD©aVIO
(
ÆloˇtögVIO
);

1154 i‡(!
	`hasAŒoˇti⁄
(
d©aVIO
)) {

1155 
	`£tLogiˇlCÆlback
(
d©aVIO
, 
Æloˇti⁄Faûuª
, 
	`THIS_LOCATION
(
NULL
));

1156 
	`c⁄töueD©aVIO
(
d©aVIO
, 
VDO_NO_SPACE
);

1160 
PhysiˇlBlockNumbî
 
pbn
 = 
ÆloˇtögVIO
->
Æloˇti⁄
;

1161 
TªeLock
 *
lock
 = &
d©aVIO
->
åìLock
;

1162 
lock
->
åìSlŸs
[lock->
height
 - 1].
blockM≠SlŸ
.
pbn
 =Öbn;

1163 
	`£tUpRe„ªn˚O≥øti⁄WôhLock
(
BLOCK_MAP_INCREMENT
, 
pbn
,

1164 
MAPPING_STATE_UNCOMPRESSED
,

1165 
ÆloˇtögVIO
->
wrôeLock
,

1166 &
d©aVIO
->
›î©i⁄
);

1167 
	`œunchJou∫ÆCÆlback
(
d©aVIO
, 
jou∫ÆBlockM≠AŒoˇti⁄
,

1168 
	`THIS_LOCATION
("$F;cb=journalBlockMapAllocation"));

1169 
	}
}

1177 
	$ÆloˇãBlockM≠Page
(
BlockM≠TªeZ⁄e
 *
z⁄e
, 
D©aVIO
 *
d©aVIO
)

1179 i‡(!
	`isWrôeD©aVIO
(
d©aVIO
Ë|| 
	`isTrimD©aVIO
(dataVIO)) {

1182 
	`föishLookup
(
d©aVIO
, 
VDO_SUCCESS
);

1186 
ªsu…
 = 
	`©ãm±PageLock
(
z⁄e
, 
d©aVIO
);

1187 i‡(
ªsu…
 !
VDO_SUCCESS
) {

1188 
	`ab‹tAŒoˇti⁄
(
d©aVIO
, 
ªsu…
);

1192 i‡(!
d©aVIO
->
åìLock
.
locked
) {

1196 
	`ÆloˇãD©aBlock
(
	`d©aVIOAsAŒoˇtögVIO
(
d©aVIO
),

1197 
VIO_BLOCK_MAP_WRITE_LOCK
,

1198 
c⁄töueBlockM≠PageAŒoˇti⁄
);

1199 
	}
}

1202 
	$lookupBlockM≠PBN
(
D©aVIO
 *
d©aVIO
)

1204 
BlockM≠TªeZ⁄e
 *
z⁄e
 = 
	`gëBlockM≠TªeZ⁄e
(
d©aVIO
);

1205 
z⁄e
->
a˘iveLookups
++;

1206 i‡(
	`isClosög
(
z⁄e
->
m≠Z⁄e
->
admöSèã
)) {

1207 
	`föishLookup
(
d©aVIO
, 
VDO_SHUTTING_DOWN
);

1212 
TªeLock
 *
lock
 = &
d©aVIO
->
åìLock
;

1213 
BlockM≠Tªe
 *
åì
 = 
	`gëTªe
(
z⁄e
, 
d©aVIO
);

1215 
PageNumbî
 
∑geIndex


1216 ((
lock
->
åìSlŸs
[0].
∑geIndex
 - 
z⁄e
->
m≠Z⁄e
->
blockM≠
->
Ê©PageCou¡
)

1217 / 
z⁄e
->
m≠Z⁄e
->
blockM≠
->
roŸCou¡
);

1218 
BlockM≠TªeSlŸ
 
åìSlŸ
 = {

1219 .
∑geIndex
 =ÖageIndex / 
BLOCK_MAP_ENTRIES_PER_PAGE
,

1220 .
blockM≠SlŸ
 = {

1221 .
pbn
 = 0,

1222 .
¶Ÿ
 = 
∑geIndex
 % 
BLOCK_MAP_ENTRIES_PER_PAGE
,

1226 
BlockM≠Page
 *
∑ge
 = 
NULL
;

1227 
lock
->
height
 = 1;Üock->heighà<
BLOCK_MAP_TREE_HEIGHT
;

1228 
lock
->
height
++) {

1229 
lock
->
åìSlŸs
[lock->
height
] = 
åìSlŸ
;

1230 
∑ge
 = (
BlockM≠Page
 *Ë(
	`gëTªePage
(
z⁄e
, 
åì
, 
lock
)->
∑geBuf„r
);

1231 i‡(
∑ge
->
hódî
.
pbn
 != 0) {

1232 
lock
->
åìSlŸs
[lock->
height
].
blockM≠SlŸ
.
pbn
 = 
∑ge
->
hódî
.pbn;

1237 
åìSlŸ
.
blockM≠SlŸ
.
¶Ÿ


1238 
åìSlŸ
.
∑geIndex
 % 
BLOCK_MAP_ENTRIES_PER_PAGE
;

1239 
åìSlŸ
.
∑geIndex


1240 
åìSlŸ
.
∑geIndex
 / 
BLOCK_MAP_ENTRIES_PER_PAGE
;

1244 c⁄° 
BlockM≠E¡ry
 *
íåy
 = &
∑ge
->
íåõs
[
åìSlŸ
.
blockM≠SlŸ
.
¶Ÿ
];

1245 i‡(
	`isInvÆidTªeE¡ry
(
	`gëVDOFromD©aVIO
(
d©aVIO
), 
íåy
, 
lock
->
height
)) {

1246 
	`logEº‹WôhSåögEº‹
(
VDO_BAD_MAPPING
,

1247 "InvÆid block m≠ÅªêPBN: %" 
PRIu64
 " with "

1249 
	`u≈ackPBN
(
íåy
),É¡ry->
m≠pögSèã
,

1250 
lock
->
åìSlŸs
[lock->
height
 - 1].
∑geIndex
,

1251 
lock
->
height
 - 1);

1252 
	`ab‹tLﬂd
(
d©aVIO
, 
VDO_BAD_MAPPING
);

1256 i‡(
	`isUnm≠≥d
(
íåy
)) {

1258 
	`ÆloˇãBlockM≠Page
(
z⁄e
, 
d©aVIO
);

1262 
lock
->
åìSlŸs
[lock->
height
 - 1].
blockM≠SlŸ
.
pbn
 = 
	`u≈ackPBN
(
íåy
);

1263 i‡(
lock
->
height
 == 1) {

1265 
	`föishLookup
(
d©aVIO
, 
VDO_SUCCESS
);

1270 
	`lﬂdBlockM≠Page
(
z⁄e
, 
d©aVIO
);

1271 
	}
}

1274 
PhysiˇlBlockNumbî
 
	$gëBlockM≠PagePBN
(
BlockM≠
 *
m≠
, 
PageNumbî
 
∑geNumbî
)

1276 
RoŸCou¡
 
roŸIndex
 = 
∑geNumbî
 % 
m≠
->
roŸCou¡
;

1277 
PageNumbî
 
∑geIndex
 = ((
∑geNumbî
 - 
m≠
->
Ê©PageCou¡
Ë/ m≠->
roŸCou¡
);

1278 
SlŸNumbî
 
¶Ÿ
 = 
∑geIndex
 % 
BLOCK_MAP_ENTRIES_PER_PAGE
;

1279 
∑geIndex
 /
BLOCK_MAP_ENTRIES_PER_PAGE
;

1281 
BlockM≠Tªe
 *
åì
 = 
	`gëTªeFromF‹e°
(
m≠
->
f‹e°
, 
roŸIndex
);

1282 
TªePage
 *
åìPage
 = 
	`gëTªePageByIndex
(
m≠
->
f‹e°
, 
åì
, 1, 
∑geIndex
);

1283 
BlockM≠Page
 *
∑ge
 = (BlockM≠Pagê*Ë(
åìPage
->
∑geBuf„r
);

1284 i‡(!
∑ge
->
hódî
.
öôülized
) {

1285  
ZERO_BLOCK
;

1288 c⁄° 
BlockM≠E¡ry
 *
íåy
 = &
∑ge
->
íåõs
[
¶Ÿ
];

1289 i‡(
	`isInvÆid
(
íåy
Ë|| 
	`isUnm≠≥d
(entry)

1290 || 
	`isCom¥es£d
(
íåy
->
m≠pögSèã
)) {

1291  
ZERO_BLOCK
;

1294  
	`u≈ackPBN
(
íåy
);

1295 
	}
}

1298 
	$wrôeTªePage
(
TªePage
 *
∑ge
, 
BlockM≠TªeZ⁄e
 *
z⁄e
)

1300 
boﬁ
 
waôög
 = 
	`isWaôög
(&
∑ge
->
waôî
);

1301 i‡(
waôög
 && (
z⁄e
->
Êushî
 =
∑ge
)) {

1305 
	`£tGíî©i⁄
(
z⁄e
, 
∑ge
, z⁄e->
gíî©i⁄
, 
waôög
);

1306 i‡(
waôög
 || 
	`asBlockM≠Page
(
∑ge
)->
hódî
.
öãri‹TªePageWrôög
) {

1310 
	`íqueuePage
(
∑ge
, 
z⁄e
);

1311 
	}
}

	@vdo/base/blockMapTree.h

22 #i‚de‡
BLOCK_MAP_TREE_H


23 
	#BLOCK_MAP_TREE_H


	)

25 
	~"c⁄°™ts.h
"

26 
	~"ty≥s.h
"

28 
åìPage
 
	tTªePage
;

41 
	$öôülizeTªeZ⁄e
(
BlockM≠Z⁄e
 *
z⁄e
,

42 
PhysiˇlLayî
 *
œyî
,

43 
RódO∆yModeC⁄ãxt
 *
ªadO∆yC⁄ãxt
,

44 
BlockCou¡
 
maximumAge
)

45 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

52 
	`unöôülizeBlockM≠TªeZ⁄e
(
BlockM≠TªeZ⁄e
 *
åìZ⁄e
);

60 
	`£tTªeZ⁄eInôülPîiod
(
BlockM≠TªeZ⁄e
 *
åìZ⁄e
,

61 
Sequí˚Numbî
 
≥riod
);

69 
	`adv™˚Z⁄eTªePîiod
(
BlockM≠TªeZ⁄e
 *
z⁄e
, 
Sequí˚Numbî
 
≥riod
);

77 
	`˛o£Z⁄eTªes
(
BlockM≠TªeZ⁄e
 *
z⁄e
);

86 
	`su•ídZ⁄eTªes
(
BlockM≠TªeZ⁄e
 *
z⁄e
, 
VDOCom∂ëi⁄
 *
com∂ëi⁄
);

93 
	`ªsumeZ⁄eTªes
(
BlockM≠TªeZ⁄e
 *
z⁄e
);

102 
	`lookupBlockM≠PBN
(
D©aVIO
 *
d©aVIO
);

114 
PhysiˇlBlockNumbî
 
	`gëBlockM≠PagePBN
(
BlockM≠
 *
m≠
, 
PageNumbî
 
∑geNumbî
);

124 
	`wrôeTªePage
(
TªePage
 *
∑ge
, 
BlockM≠TªeZ⁄e
 *
z⁄e
);

	@vdo/base/blockMapTreeInternals.h

22 #i‚de‡
BLOCK_MAP_TREE_INTERNALS_H


23 
	#BLOCK_MAP_TREE_INTERNALS_H


	)

25 
	~"blockM≠Tªe.h
"

27 
	~"blockM≠Page.h
"

28 
	~"ty≥s.h
"

31 
	såìPage
 {

33 
Waôî
 
	mwaôî
;

35 
RögNode
 
	mnode
;

37 
	m∑geBuf„r
[
VDO_BLOCK_SIZE
];

41 
TªePage
 *
	mÀvñs
[
BLOCK_MAP_TREE_HEIGHT
];

42 } 
	tBlockM≠TªeSegmít
;

44 
	sblockM≠Tªe
 {

45 
BlockM≠TªeSegmít
 *
	m£gmíts
;

49 
PageNumbî
 
	mÀvñs
[
BLOCK_MAP_TREE_HEIGHT
];

50 } 
	tBound¨y
;

56 c⁄° 
PhysiˇlBlockNumbî
 
INVALID_PBN
;

65 
__©åibuã__
((
w¨n_unu£d_ªsu…
))

66 
ölöe
 
BlockM≠Page
 *
	$asBlockM≠Page
(
TªePage
 *
åìPage
)

68  (
BlockM≠Page
 *Ë
åìPage
->
∑geBuf„r
;

69 
	}
}

80 
	$ª∂a˚TªeZ⁄eVIOPoﬁ
(
BlockM≠TªeZ⁄e
 *
z⁄e
,

81 
PhysiˇlLayî
 *
œyî
,

82 
size_t
 
poﬁSize
)

83 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

96 
boﬁ
 
	`c›yVÆidPage
(*
buf„r
,

97 
N⁄˚
 
n⁄˚
,

98 
PhysiˇlBlockNumbî
 
pbn
,

99 
BlockM≠Page
 *
∑ge
);

	@vdo/base/blockMappingState.h

22 #i‚de‡
BLOCK_MAPPING_STATE_H


23 
	#BLOCK_MAPPING_STATE_H


	)

25 
	~"comm⁄.h
"

34 
	mMAPPING_STATE_UNMAPPED
 = 0,

35 
	mMAPPING_STATE_UNCOMPRESSED
 = 1,

36 
	mMAPPING_STATE_COMPRESSED_BASE
 = 2,

37 
	mMAPPING_STATE_COMPRESSED_MAX
 = 15,

38 } 
	tBlockM≠pögSèã
;

44 
	mMAX_COMPRESSION_SLOTS
 =

45 
MAPPING_STATE_COMPRESSED_MAX
 - 
MAPPING_STATE_COMPRESSED_BASE
 + 1,

49 
ölöe
 
BlockM≠pögSèã
 
	$gëSèãF‹SlŸ
(
byã
 
¶ŸNumbî
)

51  (
¶ŸNumbî
 + 
MAPPING_STATE_COMPRESSED_BASE
);

52 
	}
}

55 
ölöe
 
byã
 
	$gëSlŸFromSèã
(
BlockM≠pögSèã
 
m≠pögSèã
)

57  (
m≠pögSèã
 - 
MAPPING_STATE_COMPRESSED_BASE
);

58 
	}
}

61 
ölöe
 
boﬁ
 
	$isCom¥es£d
(c⁄° 
BlockM≠pögSèã
 
m≠pögSèã
)

63  (
m≠pögSèã
 > 
MAPPING_STATE_UNCOMPRESSED
);

64 
	}
}

	@vdo/base/completion.c

22 
	~"com∂ëi⁄.h
"

24 
	~"loggî.h
"

25 
	~"°©usCodes.h
"

27 c⁄° *
	gVDO_COMPLETION_TYPE_NAMES
[] = {

70 
	$öôülizeCom∂ëi⁄
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
,

71 
VDOCom∂ëi⁄Ty≥
 
ty≥
,

72 
PhysiˇlLayî
 *
œyî
)

74 
	`mem£t
(
com∂ëi⁄
, 0, (*completion));

75 
com∂ëi⁄
->
œyî
 =Üayer;

76 
com∂ëi⁄
->
ty≥
 =Åype;

77 
	`ª£tCom∂ëi⁄
(
com∂ëi⁄
);

78 
	}
}

81 
	$öôülizeEnqueuóbÀCom∂ëi⁄
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
,

82 
VDOCom∂ëi⁄Ty≥
 
ty≥
,

83 
PhysiˇlLayî
 *
œyî
)

85 
	`öôülizeCom∂ëi⁄
(
com∂ëi⁄
, 
ty≥
, 
œyî
);

86  ((
œyî
->
¸óãEnqueuóbÀ
 =
NULL
)

87 ? 
VDO_SUCCESS
 : 
œyî
->
	`¸óãEnqueuóbÀ
(
com∂ëi⁄
));

88 
	}
}

91 
	$ª£tCom∂ëi⁄
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

93 
com∂ëi⁄
->
ªsu…
 = 
VDO_SUCCESS
;

94 
com∂ëi⁄
->
com∂ëe
 = 
Ál£
;

95 
	}
}

102 
ölöe
 
	$as£πIncom∂ëe
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

104 
	`ASSERT_LOG_ONLY
(!
com∂ëi⁄
->
com∂ëe
, "completion isÇot complete");

105 
	}
}

108 
	$£tCom∂ëi⁄Resu…
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
, 
ªsu…
)

110 
	`as£πIncom∂ëe
(
com∂ëi⁄
);

111 i‡(
com∂ëi⁄
->
ªsu…
 =
VDO_SUCCESS
) {

112 
com∂ëi⁄
->
ªsu…
 =Ñesult;

114 
	}
}

126 
__©åibuã__
((
w¨n_unu£d_ªsu…
))

127 
ölöe
 
boﬁ
 
	$ªquúesEnqueue
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

129 i‡(
com∂ëi⁄
->
ªqueue
) {

130 
com∂ëi⁄
->
ªqueue
 = 
Ál£
;

131  
åue
;

134 
ThªadID
 
ˇŒbackThªad
 = 
com∂ëi⁄
->
ˇŒbackThªadID
;

135  (
ˇŒbackThªad
 !
com∂ëi⁄
->
œyî
->
	`gëCuºítThªadID
());

136 
	}
}

139 
	$övokeCÆlback
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

141 i‡(
	`ªquúesEnqueue
(
com∂ëi⁄
)) {

142 i‡(
com∂ëi⁄
->
íqueuóbÀ
 !
NULL
) {

143 
com∂ëi⁄
->
œyî
->
	`íqueue
(com∂ëi⁄->
íqueuóbÀ
);

146 
	`ASSERT_LOG_ONLY
(
Ál£
,

148 
	`gëCom∂ëi⁄Ty≥Name
(
com∂ëi⁄
->
ty≥
));

151 
	`runCÆlback
(
com∂ëi⁄
);

152 
	}
}

155 
	$c⁄töueCom∂ëi⁄
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
, 
ªsu…
)

157 
	`£tCom∂ëi⁄Resu…
(
com∂ëi⁄
, 
ªsu…
);

158 
	`övokeCÆlback
(
com∂ëi⁄
);

159 
	}
}

162 
	$com∂ëeCom∂ëi⁄
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

164 
	`as£πIncom∂ëe
(
com∂ëi⁄
);

165 
com∂ëi⁄
->
com∂ëe
 = 
åue
;

166 i‡(
com∂ëi⁄
->
ˇŒback
 !
NULL
) {

167 
	`övokeCÆlback
(
com∂ëi⁄
);

169 
	}
}

172 
	$föishP¨ítCÆlback
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

174 
	`föishCom∂ëi⁄
((
VDOCom∂ëi⁄
 *Ë
com∂ëi⁄
->
∑ª¡
, com∂ëi⁄->
ªsu…
);

175 
	}
}

178 c⁄° *
	$gëCom∂ëi⁄Ty≥Name
(
VDOCom∂ëi⁄Ty≥
 
com∂ëi⁄Ty≥
)

181 
	`STATIC_ASSERT
(
	`COUNT_OF
(
VDO_COMPLETION_TYPE_NAMES
)

182 =(
MAX_COMPLETION_TYPE
 - 
UNSET_COMPLETION_TYPE
));

184 i‡(
com∂ëi⁄Ty≥
 >
MAX_COMPLETION_TYPE
) {

185 
numîic
[100];

186 
	`¢¥ötf
(
numîic
, 99, "%d (%#x)", 
com∂ëi⁄Ty≥
, completionType);

187  
numîic
;

190  
VDO_COMPLETION_TYPE_NAMES
[
com∂ëi⁄Ty≥
];

191 
	}
}

194 
	$de°royEnqueuóbÀ
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

196 i‡((
com∂ëi⁄
 =
NULL
Ë|| (com∂ëi⁄->
œyî
 == NULL)

197 || (
com∂ëi⁄
->
œyî
->
de°royEnqueuóbÀ
 =
NULL
)) {

201 
com∂ëi⁄
->
œyî
->
	`de°royEnqueuóbÀ
(&com∂ëi⁄->
íqueuóbÀ
);

202 
	}
}

205 
	$as£πCom∂ëi⁄Ty≥
(
VDOCom∂ëi⁄Ty≥
 
a˘uÆ
,

206 
VDOCom∂ëi⁄Ty≥
 
ex≥˘ed
)

208  
	`ASSERT
((
ex≥˘ed
 =
a˘uÆ
),

210 
	`gëCom∂ëi⁄Ty≥Name
(
a˘uÆ
),

211 
	`gëCom∂ëi⁄Ty≥Name
(
ex≥˘ed
));

212 
	}
}

	@vdo/base/completion.h

22 #i‚de‡
COMPLETION_H


23 
	#COMPLETION_H


	)

25 
	~"≥rmas£π.h
"

27 
	~"physiˇlLayî.h
"

28 
	~"rögNode.h
"

29 
	~"ty≥s.h
"

31 
__©åibuã__
((
	t∑cked
)) {

33 
	gUNSET_COMPLETION_TYPE
 = 0,

37 
	gADMIN_COMPLETION
,

38 
	gASYNC_ACTION_CONTEXT
,

39 
	gBLOCK_ALLOCATOR_COMPLETION
,

40 
	gBLOCK_MAP_COMPLETION
,

41 
	gBLOCK_MAP_RECOVERY_COMPLETION
,

42 
	gBLOCK_MAP_ZONE_COMPLETION
,

43 
	gCHECK_IDENTIFIER_COMPLETION
,

44 
	gEXTERNAL_COMPLETION
,

45 
	gFLUSH_NOTIFICATION_COMPLETION
,

46 
	gGENERATION_FLUSHED_COMPLETION
,

47 
	gHEARTBEAT_COMPLETION
,

48 
	gLOCK_COUNTER_COMPLETION
,

49 
	gPARTITION_COPY_COMPLETION
,

50 
	gREAD_ONLY_MODE_COMPLETION
,

51 
	gREAD_ONLY_REBUILD_COMPLETION
,

52 
	gRECOVERY_COMPLETION
,

53 
	gRECOVERY_JOURNAL_COMPLETION
,

54 
	gREFERENCE_COUNTS_COMPLETION
,

55 
	gREFERENCE_COUNT_REBUILD_COMPLETION
,

56 
	gSLAB_COMPLETION
,

57 
	gSLAB_DEPOT_COMPLETION
,

58 
	gSLAB_JOURNAL_COMPLETION
,

59 
	gSLAB_REBUILD_COMPLETION
,

60 
	gSLAB_SCRUBBER_COMPLETION
,

61 
	gSLAB_SUMMARY_COMPLETION
,

62 
	gSUB_TASK_COMPLETION
,

63 
	gTEST_COMPLETION
,

64 
	gVDO_COMMAND_COMPLETION
,

65 
	gVDO_COMMAND_SUB_COMPLETION
,

66 
	gVDO_EXTENT_COMPLETION
,

67 
	gVDO_PAGE_COMPLETION
,

68 
	gVIO_COMPLETION
,

69 
	gWAIT_FOR_READ_ONLY_MODE_COMPLETION
,

70 
	gWRAPPING_COMPLETION
,

73 
	gMAX_COMPLETION_TYPE


74 } 
	tVDOCom∂ëi⁄Ty≥
;

81 
	tVDOA˘i⁄
(
	tVDOCom∂ëi⁄
 *
	tcom∂ëi⁄
);

83 
	svdoCom∂ëi⁄
 {

85 
VDOCom∂ëi⁄Ty≥
 
	mty≥
;

92 
boﬁ
 
	mcom∂ëe
;

98 
boﬁ
 
	mªqueue
;

101 
ThªadID
 
	mˇŒbackThªadID
;

104 
	mªsu…
;

107 
PhysiˇlLayî
 *
	mœyî
;

110 
VDOA˘i⁄
 *
	mˇŒback
;

113 
VDOA˘i⁄
 *
	mîr‹H™dÀr
;

116 *
	m∑ª¡
;

119 
EnqueuóbÀ
 *
	míqueuóbÀ
;

126 
ölöe
 
	$runCÆlback
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

128 i‡((
com∂ëi⁄
->
ªsu…
 !
VDO_SUCCESS
)

129 && (
com∂ëi⁄
->
îr‹H™dÀr
 !
NULL
)) {

130 
com∂ëi⁄
->
	`îr‹H™dÀr
(completion);

134 
com∂ëi⁄
->
	`ˇŒback
(completion);

135 
	}
}

143 
£tCom∂ëi⁄Resu…
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
, 
ªsu…
);

152 
öôülizeCom∂ëi⁄
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
,

153 
VDOCom∂ëi⁄Ty≥
 
ty≥
,

154 
PhysiˇlLayî
 *
œyî
);

165 
	$öôülizeEnqueuóbÀCom∂ëi⁄
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
,

166 
VDOCom∂ëi⁄Ty≥
 
ty≥
,

167 
PhysiˇlLayî
 *
œyî
)

168 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

176 
	`ª£tCom∂ëi⁄
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
);

184 
	`övokeCÆlback
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
);

193 
	`c⁄töueCom∂ëi⁄
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
, 
ªsu…
);

200 
	`com∂ëeCom∂ëi⁄
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
);

208 
ölöe
 
	$föishCom∂ëi⁄
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
, 
ªsu…
)

210 
	`£tCom∂ëi⁄Resu…
(
com∂ëi⁄
, 
ªsu…
);

211 
	`com∂ëeCom∂ëi⁄
(
com∂ëi⁄
);

212 
	}
}

220 
föishP¨ítCÆlback
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
);

227 
de°royEnqueuóbÀ
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
);

237 
as£πCom∂ëi⁄Ty≥
(
VDOCom∂ëi⁄Ty≥
 
a˘uÆ
,

238 
VDOCom∂ëi⁄Ty≥
 
ex≥˘ed
);

248 c⁄° *
gëCom∂ëi⁄Ty≥Name
(
VDOCom∂ëi⁄Ty≥
 
com∂ëi⁄Ty≥
);

257 
ölöe
 
	$£tCÆlback
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
,

258 
VDOA˘i⁄
 *
ˇŒback
,

259 
ThªadID
 
thªadID
)

261 
com∂ëi⁄
->
ˇŒback
 = callback;

262 
com∂ëi⁄
->
ˇŒbackThªadID
 = 
thªadID
;

263 
	}
}

272 
ölöe
 
	$œunchCÆlback
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
,

273 
VDOA˘i⁄
 *
ˇŒback
,

274 
ThªadID
 
thªadID
)

276 
	`£tCÆlback
(
com∂ëi⁄
, 
ˇŒback
, 
thªadID
);

277 
	`övokeCÆlback
(
com∂ëi⁄
);

278 
	}
}

288 
ölöe
 
	$£tCÆlbackWôhP¨ít
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
,

289 
VDOA˘i⁄
 *
ˇŒback
,

290 
ThªadID
 
thªadID
,

291 *
∑ª¡
)

293 
	`£tCÆlback
(
com∂ëi⁄
, 
ˇŒback
, 
thªadID
);

294 
com∂ëi⁄
->
∑ª¡
 =Öarent;

295 
	}
}

306 
ölöe
 
	$œunchCÆlbackWôhP¨ít
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
,

307 
VDOA˘i⁄
 *
ˇŒback
,

308 
ThªadID
 
thªadID
,

309 *
∑ª¡
)

311 
	`£tCÆlbackWôhP¨ít
(
com∂ëi⁄
, 
ˇŒback
, 
thªadID
, 
∑ª¡
);

312 
	`övokeCÆlback
(
com∂ëi⁄
);

313 
	}
}

325 
ölöe
 
	$¥ï¨eCom∂ëi⁄
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
,

326 
VDOA˘i⁄
 *
ˇŒback
,

327 
VDOA˘i⁄
 *
îr‹H™dÀr
,

328 
ThªadID
 
thªadID
,

329 *
∑ª¡
)

331 
	`ª£tCom∂ëi⁄
(
com∂ëi⁄
);

332 
	`£tCÆlbackWôhP¨ít
(
com∂ëi⁄
, 
ˇŒback
, 
thªadID
, 
∑ª¡
);

333 
com∂ëi⁄
->
îr‹H™dÀr
 =ÉrrorHandler;

334 
	}
}

347 
ölöe
 
	$¥ï¨eF‹Requeue
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
,

348 
VDOA˘i⁄
 *
ˇŒback
,

349 
VDOA˘i⁄
 *
îr‹H™dÀr
,

350 
ThªadID
 
thªadID
,

351 *
∑ª¡
)

353 
	`¥ï¨eCom∂ëi⁄
(
com∂ëi⁄
, 
ˇŒback
, 
îr‹H™dÀr
, 
thªadID
, 
∑ª¡
);

354 
com∂ëi⁄
->
ªqueue
 = 
åue
;

355 
	}
}

364 
ölöe
 
	$¥ï¨eToFöishP¨ít
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
,

365 
VDOCom∂ëi⁄
 *
∑ª¡
)

367 
	`¥ï¨eCom∂ëi⁄
(
com∂ëi⁄
, 
föishP¨ítCÆlback
, finishParentCallback,

368 
∑ª¡
->
ˇŒbackThªadID
,Öarent);

369 
	}
}

	@vdo/base/compressedBlock.c

22 
	~"com¥es£dBlock.h
"

24 
	~"mem‹yAŒoc.h
"

26 c⁄° 
Vîsi⁄Numbî
 
	gCOMPRESSED_BLOCK_1_0
 = {

27 .
maj‹Vîsi⁄
 = 1,

28 .
	gmö‹Vîsi⁄
 = 0,

31 c⁄° 
Vîsi⁄Numbî
 *
	gCURRENT_BLOCK_VERSION
 = &
COMPRESSED_BLOCK_1_0
;

34 
	$ª£tCom¥es£dBlockHódî
(
Com¥es£dBlockHódî
 *
hódî
)

36 
	`mem£t
(
hódî
, 0, (*header));

37 
hódî
->
vîsi⁄
 = *
CURRENT_BLOCK_VERSION
;

38 
	}
}

41 
	$gëCom¥es£dBlockFøgmít
(
BlockM≠pögSèã
 
m≠pögSèã
,

42 *
buf„r
,

43 
BlockSize
 
blockSize
,

44 
uöt16_t
 *
‰agmítOff£t
,

45 
uöt16_t
 *
‰agmítSize
)

47 i‡(!
	`isCom¥es£d
(
m≠pögSèã
)) {

48  
VDO_INVALID_FRAGMENT
;

51 
Com¥es£dBlockHódî
 *
hódî
 = (Com¥es£dBlockHódî *Ë
buf„r
;

52 i‡(!
	`¨eSameVîsi⁄
(&
hódî
->
vîsi⁄
, 
CURRENT_BLOCK_VERSION
)) {

53  
VDO_INVALID_FRAGMENT
;

56 
byã
 
¶Ÿ
 = 
	`gëSlŸFromSèã
(
m≠pögSèã
);

57 i‡(
¶Ÿ
 >
MAX_COMPRESSION_SLOTS
) {

58  
VDO_INVALID_FRAGMENT
;

61 
uöt16_t
 
com¥es£dSize
 = 
hódî
->
sizes
[
¶Ÿ
];

62 
uöt16_t
 
off£t
 = (
Com¥es£dBlockHódî
);

63 
i
 = 0; i < 
¶Ÿ
; i++) {

64 
off£t
 +
hódî
->
sizes
[
i
];

65 i‡(
off£t
 >
blockSize
) {

66  
VDO_INVALID_FRAGMENT
;

70 i‡((
off£t
 + 
com¥es£dSize
Ë> 
blockSize
) {

71  
VDO_INVALID_FRAGMENT
;

74 *
‰agmítOff£t
 = 
off£t
;

75 *
‰agmítSize
 = 
com¥es£dSize
;

76  
VDO_SUCCESS
;

77 
	}
}

80 
	$putCom¥es£dBlockFøgmít
(
Com¥es£dBlock
 *
block
,

81 
‰agmít
,

82 
uöt16_t
 
off£t
,

83 c⁄° *
d©a
,

84 
uöt16_t
 
size
)

86 
block
->
hódî
.
sizes
[
‰agmít
] = 
size
;

87 
	`mem˝y
(&
block
->
d©a
[
off£t
], d©a, 
size
);

88 
	}
}

	@vdo/base/compressedBlock.h

22 #i‚de‡
COMPRESSED_BLOCK_H


23 
	#COMPRESSED_BLOCK_H


	)

25 
	~"blockM≠pögSèã.h
"

26 
	~"hódî.h
"

33 
Vîsi⁄Numbî
 
	mvîsi⁄
;

35 
uöt16_t
 
	msizes
[
MAX_COMPRESSION_SLOTS
];

36 } 
	t__©åibuã__
((
	t∑cked
)Ë
	tCom¥es£dBlockHódî
;

42 
Com¥es£dBlockHódî
 
	mhódî
;

43 
	md©a
[];

44 } 
	t__©åibuã__
((
	t∑cked
)Ë
	tCom¥es£dBlock
;

54 
ª£tCom¥es£dBlockHódî
(
Com¥es£dBlockHódî
 *
hódî
);

69 
gëCom¥es£dBlockFøgmít
(
BlockM≠pögSèã
 
m≠pögSèã
,

70 *
buf„r
,

71 
BlockSize
 
blockSize
,

72 
uöt16_t
 *
‰agmítOff£t
,

73 
uöt16_t
 *
‰agmítSize
);

86 
putCom¥es£dBlockFøgmít
(
Com¥es£dBlock
 *
block
,

87 
‰agmít
,

88 
uöt16_t
 
off£t
,

89 c⁄° *
d©a
,

90 
uöt16_t
 
size
);

	@vdo/base/compressionState.c

22 
	~"com¥essi⁄SèãI¡î«ls.h
"

24 
	~"d©aVIO.h
"

25 
	~"∑ckî.h
"

27 c⁄° 
uöt32_t
 
	gSTATUS_MASK
 = 0xff;

28 c⁄° 
uöt32_t
 
	gMAY_NOT_COMPRESS_MASK
 = 0x80000000;

31 
VIOCom¥essi⁄Sèã
 
	$gëCom¥essi⁄Sèã
(
D©aVIO
 *
d©aVIO
)

33 
uöt32_t
 
∑ckedVÆue
 = 
	`©omicLﬂd32
(&
d©aVIO
->
com¥essi⁄
.
°©e
);

34  (
VIOCom¥essi⁄Sèã
) {

35 .
°©us
 = 
∑ckedVÆue
 & 
STATUS_MASK
,

36 .
mayNŸCom¥ess
 = ((
∑ckedVÆue
 & 
MAY_NOT_COMPRESS_MASK
) != 0),

38 
	}
}

48 
__©åibuã__
((
w¨n_unu£d_ªsu…
))

49 
uöt32_t
 
	$∑ckSèã
(
VIOCom¥essi⁄Sèã
 
°©e
)

51  
°©e
.
°©us
 | (°©e.
mayNŸCom¥ess
 ? 
MAY_NOT_COMPRESS_MASK
 : 0);

52 
	}
}

55 
boﬁ
 
	$£tCom¥essi⁄Sèã
(
D©aVIO
 *
d©aVIO
,

56 
VIOCom¥essi⁄Sèã
 
°©e
,

57 
VIOCom¥essi⁄Sèã
 
√wSèã
)

59  
	`com∑ªAndSw≠32
(&
d©aVIO
->
com¥essi⁄
.
°©e
, 
	`∑ckSèã
(state),

60 
	`∑ckSèã
(
√wSèã
));

61 
	}
}

70 
VIOCom¥essi⁄Sètus
 
	$adv™˚Sètus
(
D©aVIO
 *
d©aVIO
)

73 
VIOCom¥essi⁄Sèã
 
°©e
 = 
	`gëCom¥essi⁄Sèã
(
d©aVIO
);

74 i‡(
°©e
.
°©us
 =
VIO_POST_PACKER
) {

76  
°©e
.
°©us
;

79 
VIOCom¥essi⁄Sèã
 
√wSèã
 = 
°©e
;

80 i‡(
°©e
.
mayNŸCom¥ess
) {

83 
√wSèã
.
°©us
 = 
VIO_POST_PACKER
;

86 
√wSèã
.
°©us
++;

89 i‡(
	`£tCom¥essi⁄Sèã
(
d©aVIO
, 
°©e
, 
√wSèã
)) {

90  
√wSèã
.
°©us
;

95 
	}
}

98 
boﬁ
 
	$mayCom¥essD©aVIO
(
D©aVIO
 *
d©aVIO
)

100 i‡(!
	`hasAŒoˇti⁄
(
d©aVIO
)

101 || !
	`gëVDOCom¥essög
(
	`gëVDOFromD©aVIO
(
d©aVIO
))) {

107 
	`£tCom¥essi⁄D⁄e
(
d©aVIO
);

108  
Ál£
;

111  (
	`adv™˚Sètus
(
d©aVIO
Ë=
VIO_COMPRESSING
);

112 
	}
}

115 
boﬁ
 
	$mayPackD©aVIO
(
D©aVIO
 *
d©aVIO
)

117 i‡(!
	`isSufficõ¡lyCom¥essibÀ
(
d©aVIO
)

118 || !
	`gëVDOCom¥essög
(
	`gëVDOFromD©aVIO
(
d©aVIO
))

119 || 
	`gëCom¥essi⁄Sèã
(
d©aVIO
).
mayNŸCom¥ess
) {

122 
	`£tCom¥essi⁄D⁄e
(
d©aVIO
);

123  
Ál£
;

126  
åue
;

127 
	}
}

130 
boﬁ
 
	$mayBlockInPackî
(
D©aVIO
 *
d©aVIO
)

132  (
	`adv™˚Sètus
(
d©aVIO
Ë=
VIO_PACKING
);

133 
	}
}

136 
boﬁ
 
	$mayWrôeCom¥es£dD©aVIO
(
D©aVIO
 *
d©aVIO
)

138 
	`adv™˚Sètus
(
d©aVIO
);

139  !
	`gëCom¥essi⁄Sèã
(
d©aVIO
).
mayNŸCom¥ess
;

140 
	}
}

143 
	$£tCom¥essi⁄D⁄e
(
D©aVIO
 *
d©aVIO
)

146 
VIOCom¥essi⁄Sèã
 
°©e
 = 
	`gëCom¥essi⁄Sèã
(
d©aVIO
);

147 i‡(
°©e
.
°©us
 =
VIO_POST_PACKER
) {

153 
VIOCom¥essi⁄Sèã
 
√wSèã
 = {

154 .
°©us
 = 
VIO_POST_PACKER
,

155 .
mayNŸCom¥ess
 = 
åue
,

157 i‡(
	`£tCom¥essi⁄Sèã
(
d©aVIO
, 
°©e
, 
√wSèã
)) {

161 
	}
}

164 
boﬁ
 
	$ˇn˚lCom¥essi⁄
(
D©aVIO
 *
d©aVIO
)

166 
VIOCom¥essi⁄Sèã
 
°©e
;

168 
°©e
 = 
	`gëCom¥essi⁄Sèã
(
d©aVIO
);

169 i‡(
°©e
.
mayNŸCom¥ess
 || (°©e.
°©us
 =
VIO_POST_PACKER
)) {

174 
VIOCom¥essi⁄Sèã
 
√wSèã
 = {

175 .
°©us
 = 
°©e
.status,

176 .
mayNŸCom¥ess
 = 
åue
,

178 i‡(
	`£tCom¥essi⁄Sèã
(
d©aVIO
, 
°©e
, 
√wSèã
)) {

183  ((
°©e
.
°©us
 =
VIO_PACKING
Ë&& !°©e.
mayNŸCom¥ess
);

184 
	}
}

	@vdo/base/compressionState.h

22 #i‚de‡
COMPRESSION_STATE_H


23 
	#COMPRESSION_STATE_H


	)

25 
	~"utû/©omic.h
"

27 
	~"ty≥s.h
"

35 
	mVIO_PRE_COMPRESSOR
 = 0,

37 
	mVIO_COMPRESSING
,

39 
	mVIO_PACKING
,

41 
	mVIO_POST_PACKER
,

42 } 
	tVIOCom¥essi⁄Sètus
;

45 
VIOCom¥essi⁄Sètus
 
	m°©us
;

46 
boﬁ
 
	mmayNŸCom¥ess
;

47 } 
	tVIOCom¥essi⁄Sèã
;

56 
__©åibuã__
((
w¨n_unu£d_ªsu…
))

57 
VIOCom¥essi⁄Sèã
 
gëCom¥essi⁄Sèã
(
D©aVIO
 *
d©aVIO
);

66 
boﬁ
 
	$mayCom¥essD©aVIO
(
D©aVIO
 *
d©aVIO
)

67 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

76 
boﬁ
 
	$mayPackD©aVIO
(
D©aVIO
 *
d©aVIO
)

77 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

88 
boﬁ
 
	$mayBlockInPackî
(
D©aVIO
 *
d©aVIO
)

89 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

100 
boﬁ
 
	$mayWrôeCom¥es£dD©aVIO
(
D©aVIO
 *
d©aVIO
)

101 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

108 
	`£tCom¥essi⁄D⁄e
(
D©aVIO
 *
d©aVIO
);

118 
boﬁ
 
	`ˇn˚lCom¥essi⁄
(
D©aVIO
 *
d©aVIO
);

	@vdo/base/compressionStateInternals.h

22 #i‚de‡
COMPRESSION_STATE_INTERNALS_H


23 
	#COMPRESSION_STATE_INTERNALS_H


	)

25 
	~"com¥essi⁄Sèã.h
"

38 
boﬁ
 
£tCom¥essi⁄Sèã
(
D©aVIO
 *
d©aVIO
,

39 
VIOCom¥essi⁄Sèã
 
°©e
,

40 
VIOCom¥essi⁄Sèã
 
√wSèã
);

	@vdo/base/constants.c

22 
	~"ty≥s.h
"

25 c⁄° 
BlockCou¡
 
	gMAXIMUM_LOGICAL_BLOCKS
 = 1024ULL * 1024 * 1024 * 1024;

28 c⁄° 
BlockCou¡
 
	gMAXIMUM_PHYSICAL_BLOCKS
 = 1024ULL * 1024 * 1024 * 64;

31 c⁄° 
BlockCou¡
 
	gMINIMUM_SLAB_JOURNAL_BLOCKS
 = 2;

	@vdo/base/constants.h

22 #i‚de‡
CONSTANTS_H


23 
	#CONSTANTS_H


	)

25 
	~"ty≥s.h
"

29 
	mBLOCK_MAP_ENTRIES_PER_PAGE
 = 812,

32 
	mBLOCK_MAP_FLAT_PAGE_ORIGIN
 = 1,

39 
	mBLOCK_MAP_TREE_HEIGHT
 = 5,

42 
	mDEFAULT_BLOCK_MAP_TREE_ROOT_COUNT
 = 60,

45 
	mDEFAULT_RECOVERY_JOURNAL_SIZE
 = 32 * 1024,

48 
	mDEFAULT_SLAB_JOURNAL_SIZE
 = 224,

55 
	mLOCK_MAP_CAPACITY
 = 10000,

58 
	mMAX_PHYSICAL_ZONES
 = 16,

61 
	mMAX_SLAB_BITS
 = 23,

64 
	mMAX_SLABS
 = 8192,

70 
	mMAXIMUM_SIMULTANEOUS_BLOCK_MAP_RESTORATION_READS
 = 1024,

73 
	mMAXIMUM_USER_VIOS
 = 2048,

81 
	mRECOVERY_JOURNAL_TAIL_BUFFER_SIZE
 = 64,

84 
	mSECTORS_PER_BLOCK
 = 8,

87 
	mVDO_BLOCK_SIZE
 = 4096,

90 
	mVDO_SECTOR_SIZE
 = 512,

93 
	mZERO_BLOCK
 = 0,

97 c⁄° 
BlockCou¡
 
MAXIMUM_LOGICAL_BLOCKS
;

100 c⁄° 
BlockCou¡
 
MAXIMUM_PHYSICAL_BLOCKS
;

103 c⁄° 
BlockCou¡
 
MINIMUM_SLAB_JOURNAL_BLOCKS
;

	@vdo/base/countedList.h

22 #i‚de‡
COUNTED_LIST_H


23 
	#COUNTED_LIST_H


	)

25 
	~"rögNode.h
"

26 
	~"ty≥s.h
"

33 
RögNode
 
	mhód
;

34 
size_t
 
	mÀngth
;

35 } 
	tCou¡edLi°
;

42 
ölöe
 
	$öôülizeCou¡edLi°
(
Cou¡edLi°
 *
li°
)

44 
	`öôülizeRög
(&
li°
->
hód
);

45 
li°
->
Àngth
 = 0;

46 
	}
}

55 
ölöe
 
boﬁ
 
	$isCou¡edLi°Em±y
(c⁄° 
Cou¡edLi°
 *
li°
)

57  (
li°
->
Àngth
 == 0);

58 
	}
}

69 
ölöe
 
RögNode
 *
	$ªmoveCou¡edLi°Node
(
Cou¡edLi°
 *
li°
,

70 
RögNode
 *
node
)

72 
li°
->
Àngth
--;

73  
	`un•li˚RögNode
(
node
);

74 
	}
}

82 
ölöe
 
	$addToCou¡edLi°Hód
(
Cou¡edLi°
 *
li°
, 
RögNode
 *
node
)

84 
li°
->
Àngth
++;

85 
	`•li˚RögChaöA·î
(
node
,Çode, &
li°
->
hód
);

86 
	}
}

94 
ölöe
 
	$addToCou¡edLi°Taû
(
Cou¡edLi°
 *
li°
, 
RögNode
 *
node
)

96 
li°
->
Àngth
++;

97 
	`•li˚RögChaöBef‹e
(
node
,Çode, &
li°
->
hód
);

98 
	}
}

107 
ölöe
 
	$å™s„rToCou¡edLi°Taû
(
Cou¡edLi°
 *
‰om
,

108 
Cou¡edLi°
 *
to
)

110 i‡(
	`isCou¡edLi°Em±y
(
‰om
)) {

114 
to
->
Àngth
 +
‰om
->length;

115 
‰om
->
Àngth
 = 0;

116 
	`•li˚RögChaöBef‹e
(
‰om
->
hód
.
√xt
, from->hód.
¥ev
, &
to
->head);

117 
	}
}

126 
ölöe
 
RögNode
 *
	$ªmoveFromCou¡edLi°Hód
(
Cou¡edLi°
 *
li°
)

128 
RögNode
 *
node
 = 
	`ch›RögNode
(&
li°
->
hód
);

129 i‡(
node
 !
NULL
) {

130 
li°
->
Àngth
--;

132  
node
;

133 
	}
}

142 
ölöe
 
RögNode
 *
	$ªmoveFromCou¡edLi°Taû
(
Cou¡edLi°
 *
li°
)

144 
RögNode
 *
node
 = 
	`p›RögNode
(&
li°
->
hód
);

145 i‡(
node
 !
NULL
) {

146 
li°
->
Àngth
--;

148  
node
;

149 
	}
}

	@vdo/base/dataVIO.c

22 
	~"d©aVIO.h
"

24 
	~"loggî.h
"

25 
	~"utû/©omic.h
"

27 
	~"blockM≠.h
"

28 
	~"com¥essi⁄Sèã.h
"

29 
	~"exã¡.h
"

30 
	~"thªadC⁄fig.h
"

31 
	~"vdoI¡î«l.h
"

32 
	~"vioRód.h
"

33 
	~"vioWrôe.h
"

35 c⁄° *
	gASYNC_OPERATION_NAMES
[] = {

80 
	$öôülizeLBNLock
(
D©aVIO
 *
d©aVIO
, 
LogiˇlBlockNumbî
 
lbn
)

82 
LBNLock
 *
lock
 = &
d©aVIO
->
logiˇl
;

83 
lock
->
lbn
 =Übn;

84 
lock
->
locked
 = 
Ál£
;

85 
	`öôülizeWaôQueue
(&
lock
->
waôîs
);

87 
VDO
 *
vdo
 = 
	`gëVDOFromD©aVIO
(
d©aVIO
);

88 
lock
->
z⁄e
 = 
vdo
->
logiˇlZ⁄es
[
	`compuãLogiˇlZ⁄e
(
d©aVIO
)];

89 
	}
}

92 
	$¥ï¨eD©aVIO
(
D©aVIO
 *
d©aVIO
,

93 
LogiˇlBlockNumbî
 
lbn
,

94 
VIOO≥øti⁄
 
›î©i⁄
,

95 
boﬁ
 
isTrim
,

96 
VDOA˘i⁄
 *
ˇŒback
)

98 
	`öôülizeLBNLock
(
d©aVIO
, 
lbn
);

99 
	`öôülizeRög
(&
d©aVIO
->
hashLockNode
);

100 
	`öôülizeRög
(&
d©aVIO
->
wrôeNode
);

102 
	`ª£tAŒoˇti⁄
(
	`d©aVIOAsAŒoˇtögVIO
(
d©aVIO
));

104 
d©aVIO
->
chunkNameSë
 = 
Ál£
;

105 
d©aVIO
->
du∂iˇãLock
 = 
NULL
;

106 
d©aVIO
->
isDu∂iˇã
 = 
Ál£
;

108 
	`©omicSt‹e64
(&
d©aVIO
->
du∂iˇãPBN
, 0);

109 
	`mem£t
(&
d©aVIO
->
chunkName
, 0, (dataVIO->chunkName));

110 
	`mem£t
(&
d©aVIO
->
du∂iˇã
, 0, (dataVIO->duplicate));

111 
	`öôülizeWaôQueue
(&
d©aVIO
->
lockRëryWaôîs
);

113 
VIO
 *
vio
 = 
	`d©aVIOAsVIO
(
d©aVIO
);

114 
vio
->
›î©i⁄
 = operation;

115 
vio
->
ˇŒback
 = callback;

116 
d©aVIO
->
∑geCom∂ëi⁄
.
com∂ëi⁄
.
íqueuóbÀ


117 
	`vioAsCom∂ëi⁄
(
vio
)->
íqueuóbÀ
;

119 
d©aVIO
->
m≠≥d
.
°©e
 = 
MAPPING_STATE_UNCOMPRESSED
;

120 
d©aVIO
->
√wM≠≥d
.
°©e


121 (
isTrim
 ? 
MAPPING_STATE_UNMAPPED
 : 
MAPPING_STATE_UNCOMPRESSED
);

122 
	`ª£tCom∂ëi⁄
(
	`vioAsCom∂ëi⁄
(
vio
));

123 
	`£tLogiˇlCÆlback
(
d©aVIO
, 
©ãm±LogiˇlBlockLock
,

124 
	`THIS_LOCATION
("$F;cb=acquireLogicalBlockLock"));

125 
	}
}

128 
	$com∂ëeD©aVIO
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

130 
D©aVIO
 *
d©aVIO
 = 
	`asD©aVIO
(
com∂ëi⁄
);

131 i‡(
com∂ëi⁄
->
ªsu…
 !
VDO_SUCCESS
) {

132 
VIO
 *
vio
 = 
	`d©aVIOAsVIO
(
d©aVIO
);

133 
	`logWôhSåögEº‹
(
	`upd©eVIOEº‹Sèts
(
vio
), 
com∂ëi⁄
->
ªsu…
,

134 "Com∂ëög %†VIO f‹ LBN %" 
PRIu64


136 
	`gëVIORódWrôeFœv‹
(
vio
), 
d©aVIO
->
logiˇl
.
lbn
,

137 
	`gëO≥øti⁄Name
(
d©aVIO
));

140 
	`d©aVIOAddTø˚Rec‹d
(
d©aVIO
, 
	`THIS_LOCATION
("$F($io)"));

141 i‡(
	`isRódD©aVIO
(
d©aVIO
)) {

142 
	`˛ónupRódD©aVIO
(
d©aVIO
);

144 
	`˛ónupWrôeD©aVIO
(
d©aVIO
);

146 
	}
}

149 
	$föishD©aVIO
(
D©aVIO
 *
d©aVIO
, 
ªsu…
)

151 
VDOCom∂ëi⁄
 *
com∂ëi⁄
 = 
	`d©aVIOAsCom∂ëi⁄
(
d©aVIO
);

152 
	`£tCom∂ëi⁄Resu…
(
com∂ëi⁄
, 
ªsu…
);

153 
	`com∂ëeD©aVIO
(
com∂ëi⁄
);

154 
	}
}

157 c⁄° *
	$gëO≥øti⁄Name
(
D©aVIO
 *
d©aVIO
)

159 
	`STATIC_ASSERT
((
MAX_ASYNC_OPERATION_NUMBER
 - 
MIN_ASYNC_OPERATION_NUMBER
)

160 =
	`COUNT_OF
(
ASYNC_OPERATION_NAMES
));

162  ((
d©aVIO
->
œ°AsyncO≥øti⁄
 < 
MAX_ASYNC_OPERATION_NUMBER
)

163 ? 
ASYNC_OPERATION_NAMES
[
d©aVIO
->
œ°AsyncO≥øti⁄
]

165 
	}
}

168 
	$ª˚iveDedu≥Advi˚
(
D©aVIO
 *
d©aVIO
, c⁄° 
D©aLoˇti⁄
 *
advi˚
)

176 
VDO
 *
vdo
 = 
	`gëVDOFromD©aVIO
(
d©aVIO
);

177 
Z⁄edPBN
 
du∂iˇã
 = 
	`vÆid©eDedu≥Advi˚
(
vdo
, 
advi˚
, 
d©aVIO
->
logiˇl
.
lbn
);

178 
	`£tDu∂iˇãLoˇti⁄
(
d©aVIO
, 
du∂iˇã
);

179 
	}
}

182 
	$£tDu∂iˇãLoˇti⁄
(
D©aVIO
 *
d©aVIO
, c⁄° 
Z⁄edPBN
 
sour˚
)

184 
	`ASSERT_LOG_ONLY
(
d©aVIO
->
du∂iˇãLock
 =
NULL
,

186 
d©aVIO
->
isDu∂iˇã
 = (
sour˚
.
pbn
 !
ZERO_BLOCK
);

187 
d©aVIO
->
du∂iˇã
 = 
sour˚
;

188 
	`©omicSt‹e64
(&
d©aVIO
->
du∂iˇãPBN
, 
sour˚
.
pbn
);

189 
	}
}

192 
	$˛órM≠≥dLoˇti⁄
(
D©aVIO
 *
d©aVIO
)

194 
d©aVIO
->
m≠≥d
 = (
Z⁄edPBN
Ë{ .
°©e
 = 
MAPPING_STATE_UNMAPPED
 };

195 
	}
}

198 
	$£tM≠≥dLoˇti⁄
(
D©aVIO
 *
d©aVIO
,

199 
PhysiˇlBlockNumbî
 
pbn
,

200 
BlockM≠pögSèã
 
°©e
)

202 
PhysiˇlZ⁄e
 *
z⁄e
;

203 
ªsu…
 = 
	`gëPhysiˇlZ⁄e
(
	`gëVDOFromD©aVIO
(
d©aVIO
), 
pbn
, &
z⁄e
);

204 i‡(
ªsu…
 !
VDO_SUCCESS
) {

205  
ªsu…
;

208 
d©aVIO
->
m≠≥d
 = (
Z⁄edPBN
) {

209 .
pbn
 =Öbn,

210 .
°©e
 = state,

211 .
z⁄e
 = zone,

213  
VDO_SUCCESS
;

214 
	}
}

221 
	$œunchLockedReque°
(
D©aVIO
 *
d©aVIO
)

223 
	`d©aVIOAddTø˚Rec‹d
(
d©aVIO
, 
	`THIS_LOCATION
(
NULL
));

224 
d©aVIO
->
logiˇl
.
locked
 = 
åue
;

226 i‡(
	`isWrôeD©aVIO
(
d©aVIO
)) {

227 
	`œunchWrôeD©aVIO
(
d©aVIO
);

229 
	`œunchRódD©aVIO
(
d©aVIO
);

231 
	}
}

234 
	$©ãm±LogiˇlBlockLock
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

236 
D©aVIO
 *
d©aVIO
 = 
	`asD©aVIO
(
com∂ëi⁄
);

237 
	`as£πInLogiˇlZ⁄e
(
d©aVIO
);

239 i‡(
d©aVIO
->
logiˇl
.
lbn


240 >
	`gëVDOFromD©aVIO
(
d©aVIO
)->
c⁄fig
.
logiˇlBlocks
) {

241 
	`föishD©aVIO
(
d©aVIO
, 
VDO_OUT_OF_RANGE
);

245 
D©aVIO
 *
lockHﬁdî
;

246 
LBNLock
 *
lock
 = &
d©aVIO
->
logiˇl
;

247 
ªsu…
 = 
	`ötM≠Put
(
	`gëLBNLockM≠
(
lock
->
z⁄e
),Üock->
lbn
, 
d©aVIO
, 
Ál£
,

248 (**Ë&
lockHﬁdî
);

249 i‡(
ªsu…
 !
VDO_SUCCESS
) {

250 
	`föishD©aVIO
(
d©aVIO
, 
ªsu…
);

254 i‡(
lockHﬁdî
 =
NULL
) {

256 
	`œunchLockedReque°
(
d©aVIO
);

260 
ªsu…
 = 
	`ASSERT
(
lockHﬁdî
->
logiˇl
.
locked
, "logical blockÜock held");

261 i‡(
ªsu…
 !
VDO_SUCCESS
) {

262 
	`föishD©aVIO
(
d©aVIO
, 
ªsu…
);

274 i‡(
	`isRódD©aVIO
(
d©aVIO
Ë&& 
	`©omicLﬂdBoﬁ
(&
lockHﬁdî
->
hasAŒoˇti⁄
)) {

275 
	`d©aVIOAsCom∂ëi⁄
(
d©aVIO
)->
œyî
->
	`c›yD©a
(
lockHﬁdî
, dataVIO);

276 
	`föishD©aVIO
(
d©aVIO
, 
VDO_SUCCESS
);

280 
d©aVIO
->
œ°AsyncO≥øti⁄
 = 
ACQUIRE_LOGICAL_BLOCK_LOCK
;

281 
ªsu…
 = 
	`íqueueD©aVIO
(&
lockHﬁdî
->
logiˇl
.
waôîs
, 
d©aVIO
,

282 
	`THIS_LOCATION
("$F;cb=logicalBlockLock"));

283 i‡(
ªsu…
 !
VDO_SUCCESS
) {

284 
	`föishD©aVIO
(
d©aVIO
, 
ªsu…
);

290 i‡(!
	`isRódD©aVIO
(
lockHﬁdî
Ë&& 
	`ˇn˚lCom¥essi⁄
(lockHolder)) {

291 
d©aVIO
->
com¥essi⁄
.
lockHﬁdî
 =ÜockHolder;

292 
	`œunchPackîCÆlback
(
d©aVIO
, 
ªmoveLockHﬁdîFromPackî
,

293 
	`THIS_LOCATION
("$F;cb=removeLockHolderFromPacker"));

295 
	}
}

302 
	$ªÀa£Lock
(
D©aVIO
 *
d©aVIO
)

304 
LBNLock
 *
lock
 = &
d©aVIO
->
logiˇl
;

305 
I¡M≠
 *
lockM≠
 = 
	`gëLBNLockM≠
(
lock
->
z⁄e
);

306 i‡(!
lock
->
locked
) {

309 
D©aVIO
 *
lockHﬁdî
 = 
	`ötM≠Gë
(
lockM≠
, 
lock
->
lbn
);

310 
	`ASSERT_LOG_ONLY
((
d©aVIO
 !
lockHﬁdî
),

311 "nÿlogiˇ»blockÜock hñd f‹ block %" 
PRIu64
,

312 
lock
->
lbn
);

317 
D©aVIO
 *
lockHﬁdî
 = 
	`ötM≠Remove
(
lockM≠
, 
lock
->
lbn
);

318 
	`ASSERT_LOG_ONLY
((
d©aVIO
 =
lockHﬁdî
),

319 "logiˇ»blockÜock mism©ch f‹ block %" 
PRIu64
, 
lock
->
lbn
);

320 
lock
->
locked
 = 
Ál£
;

322 
	}
}

325 
	$ªÀa£LogiˇlBlockLock
(
D©aVIO
 *
d©aVIO
)

327 
	`as£πInLogiˇlZ⁄e
(
d©aVIO
);

328 i‡(!
	`hasWaôîs
(&
d©aVIO
->
logiˇl
.
waôîs
)) {

329 
	`ªÀa£Lock
(
d©aVIO
);

333 
LBNLock
 *
lock
 = &
d©aVIO
->
logiˇl
;

334 
	`ASSERT_LOG_ONLY
(
lock
->
locked
, "LBNLock with waiters isÇotÜocked");

338 
D©aVIO
 *
√xtLockHﬁdî
 = 
	`waôîAsD©aVIO
(
	`dequeueNextWaôî
(&
lock
->
waôîs
));

341 
	`å™s„rAŒWaôîs
(&
lock
->
waôîs
, &
√xtLockHﬁdî
->
logiˇl
.waiters);

343 
D©aVIO
 *
lockHﬁdî
;

344 
ªsu…
 = 
	`ötM≠Put
(
	`gëLBNLockM≠
(
lock
->
z⁄e
),Üock->
lbn
, 
√xtLockHﬁdî
,

345 
åue
, (**Ë&
lockHﬁdî
);

346 i‡(
ªsu…
 !
VDO_SUCCESS
) {

347 
	`föishD©aVIO
(
√xtLockHﬁdî
, 
ªsu…
);

351 
	`ASSERT_LOG_ONLY
((
lockHﬁdî
 =
d©aVIO
),

352 "logiˇ»blockÜock mism©ch f‹ block %" 
PRIu64
, 
lock
->
lbn
);

353 
lock
->
locked
 = 
Ál£
;

360 i‡(
	`hasWaôîs
(&
√xtLockHﬁdî
->
logiˇl
.
waôîs
)) {

361 
	`ˇn˚lCom¥essi⁄
(
√xtLockHﬁdî
);

366 
	`d©aVIOAsCom∂ëi⁄
(
√xtLockHﬁdî
)->
ªqueue
 = 
åue
;

367 
	`œunchLockedReque°
(
√xtLockHﬁdî
);

368 
	}
}

	@vdo/base/dataVIO.h

22 #i‚de‡
DATA_VIO_H


23 
	#DATA_VIO_H


	)

25 
	~"ÆloˇtögVIO.h
"

26 
	~"blockM≠E¡ry.h
"

27 
	~"blockM≠pögSèã.h
"

28 
	~"c⁄°™ts.h
"

29 
	~"hashZ⁄e.h
"

30 
	~"jou∫ÆPoöt.h
"

31 
	~"logiˇlZ⁄e.h
"

32 
	~"ª„ªn˚O≥øti⁄.h
"

33 
	~"rögNode.h
"

34 
	~"thªadC⁄fig.h
"

35 
	~"åa˚.h
"

36 
	~"ty≥s.h
"

37 
	~"vdoPageCache.h
"

38 
	~"vio.h
"

39 
	~"waôQueue.h
"

44 
__©åibuã__
((
	t∑cked
)) {

45 
	gMIN_ASYNC_OPERATION_NUMBER
 = 0,

46 
	gLAUNCH
 = 
MIN_ASYNC_OPERATION_NUMBER
,

47 
	gACKNOWLEDGE_WRITE
,

48 
	gACQUIRE_HASH_LOCK
,

49 
	gACQUIRE_LOGICAL_BLOCK_LOCK
,

50 
	gACQUIRE_PBN_READ_LOCK
,

51 
	gCHECK_FOR_DEDUPE_FOR_ROLLOVER
,

52 
	gCHECK_FOR_DEDUPLICATION
,

53 
	gCOMPRESS_DATA
,

54 
	gCONTINUE_VIO_ASYNC
,

55 
	gFIND_BLOCK_MAP_SLOT
,

56 
	gGET_MAPPED_BLOCK
,

57 
	gGET_MAPPED_BLOCK_FOR_DEDUPE
,

58 
	gGET_MAPPED_BLOCK_FOR_WRITE
,

59 
	gHASH_DATA
,

60 
	gJOURNAL_DECREMENT_FOR_DEDUPE
,

61 
	gJOURNAL_DECREMENT_FOR_WRITE
,

62 
	gJOURNAL_INCREMENT_FOR_COMPRESSION
,

63 
	gJOURNAL_INCREMENT_FOR_DEDUPE
,

64 
	gJOURNAL_INCREMENT_FOR_WRITE
,

65 
	gJOURNAL_MAPPING_FOR_COMPRESSION
,

66 
	gJOURNAL_MAPPING_FOR_DEDUPE
,

67 
	gJOURNAL_MAPPING_FOR_WRITE
,

68 
	gJOURNAL_UNMAPPING_FOR_DEDUPE
,

69 
	gJOURNAL_UNMAPPING_FOR_WRITE
,

70 
	gPACK_COMPRESSED_BLOCK
,

71 
	gPUT_MAPPED_BLOCK
,

72 
	gPUT_MAPPED_BLOCK_FOR_DEDUPE
,

73 
	gREAD_DATA
,

74 
	gUPDATE_ALBIREO_FOR_COMPRESSION
,

75 
	gUPDATE_ALBIREO_FOR_NON_BLOCK_MAP_DEDUPE
,

76 
	gUPDATE_ALBIREO_FOR_RECOVERY
,

77 
	gUPDATE_ALBIREO_FOR_ROLLOVER
,

78 
	gVERIFY_DEDUPLICATION
,

79 
	gWRITE_DATA
,

80 
	gMAX_ASYNC_OPERATION_NUMBER
,

81 } 
	tAsyncO≥øti⁄Numbî
;

86 
	slbnLock
 {

88 
LogiˇlBlockNumbî
 
	mlbn
;

90 
boﬁ
 
	mlocked
;

92 
WaôQueue
 
	mwaôîs
;

94 
LogiˇlZ⁄e
 *
	mz⁄e
;

102 
Height
 
	mheight
;

104 
RoŸCou¡
 
	mroŸIndex
;

106 
BlockM≠TªeSlŸ
 
	måìSlŸs
[
BLOCK_MAP_TREE_HEIGHT
 + 1];

108 
uöt64_t
 
	mkey
;

110 
WaôQueue
 
	mwaôîs
;

112 
boﬁ
 
	mlocked
;

114 
VDOA˘i⁄
 *
	mˇŒback
;

116 
ThªadID
 
	mthªadID
;

117 } 
	tTªeLock
;

129 
Atomic32
 
	m°©e
;

132 
uöt16_t
 
	msize
;

135 
SlŸNumbî
 
	m¶Ÿ
;

138 
I≈utBö
 *
	mbö
;

141 *
	md©a
;

147 
AŒoˇtögVIO
 *
	mwrôî
;

152 
D©aVIO
 *
	mlockHﬁdî
;

154 } 
	tCom¥essi⁄Sèã
;

159 
	sd©aVIO
 {

161 
AŒoˇtögVIO
 
	mÆloˇtögVIO
;

164 
LBNLock
 
	mlogiˇl
;

167 
TªeLock
 
	måìLock
;

170 
Z⁄edPBN
 
	mm≠≥d
;

173 
UdsChunkName
 
	mchunkName
;

176 
boﬁ
 
	mchunkNameSë
;

179 
AsyncO≥øti⁄Numbî
 
	mœ°AsyncO≥øti⁄
;

182 
Re„ªn˚O≥øti⁄
 
	m›î©i⁄
;

185 
boﬁ
 
	misP¨tülWrôe
;

188 
boﬁ
 
	misZîoBlock
;

191 
boﬁ
 
	misDu∂iˇã
;

194 
boﬁ
 
	mrﬁÀdOvî
;

200 
AtomicBoﬁ
 
	mhasAŒoˇti⁄
;

203 
Z⁄edPBN
 
	m√wM≠≥d
;

206 
HashZ⁄e
 *
	mhashZ⁄e
;

209 
HashLock
 *
	mhashLock
;

212 
RögNode
 
	mhashLockNode
;

215 
Z⁄edPBN
 
	mdu∂iˇã
;

218 
Atomic64
 
	mdu∂iˇãPBN
;

221 
PBNLock
 *
	mdu∂iˇãLock
;

229 
WaôQueue
 
	mlockRëryWaôîs
;

235 
Sequí˚Numbî
 
	mªcovîySequí˚Numbî
;

238 
Jou∫ÆPoöt
 
	mªcovîyJou∫ÆPoöt
;

241 
RögNode
 
	mwrôeNode
;

244 
boﬁ
 
	mhasFlushGíî©i⁄Lock
;

247 
Sequí˚Numbî
 
	mÊushGíî©i⁄
;

250 
VDOPageCom∂ëi⁄
 
	m∑geCom∂ëi⁄
;

253 
Com¥essi⁄Sèã
 
	mcom¥essi⁄
;

263 
ölöe
 
D©aVIO
 *
	$ÆloˇtögVIOAsD©aVIO
(
AŒoˇtögVIO
 *
ÆloˇtögVIO
)

265 
	`STATIC_ASSERT
(
	`off£tof
(
D©aVIO
, 
ÆloˇtögVIO
) == 0);

266 
	`ASSERT_LOG_ONLY
((
	`ÆloˇtögVIOAsVIO
(
ÆloˇtögVIO
)->
ty≥
 =
VIO_TYPE_DATA
),

268  (
D©aVIO
 *Ë
ÆloˇtögVIO
;

269 
	}
}

278 
ölöe
 
D©aVIO
 *
	$vioAsD©aVIO
(
VIO
 *
vio
)

280 
	`STATIC_ASSERT
(
	`off£tof
(
D©aVIO
, 
ÆloˇtögVIO
) == 0);

281 
	`STATIC_ASSERT
(
	`off£tof
(
AŒoˇtögVIO
, 
vio
) == 0);

282 
	`ASSERT_LOG_ONLY
((
vio
->
ty≥
 =
VIO_TYPE_DATA
), "VIO isá DataVIO");

283  (
D©aVIO
 *Ë
vio
;

284 
	}
}

293 
ölöe
 
AŒoˇtögVIO
 *
	$d©aVIOAsAŒoˇtögVIO
(
D©aVIO
 *
d©aVIO
)

295  &
d©aVIO
->
ÆloˇtögVIO
;

296 
	}
}

305 
ölöe
 
VIO
 *
	$d©aVIOAsVIO
(
D©aVIO
 *
d©aVIO
)

307  
	`ÆloˇtögVIOAsVIO
(
	`d©aVIOAsAŒoˇtögVIO
(
d©aVIO
));

308 
	}
}

317 
ölöe
 
D©aVIO
 *
	$asD©aVIO
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

319  
	`vioAsD©aVIO
(
	`asVIO
(
com∂ëi⁄
));

320 
	}
}

329 
ölöe
 
VDOCom∂ëi⁄
 *
	$d©aVIOAsCom∂ëi⁄
(
D©aVIO
 *
d©aVIO
)

331  
	`ÆloˇtögVIOAsCom∂ëi⁄
(
	`d©aVIOAsAŒoˇtögVIO
(
d©aVIO
));

332 
	}
}

341 
ölöe
 
Waôî
 *
	$d©aVIOAsWaôî
(
D©aVIO
 *
d©aVIO
)

343  
	`ÆloˇtögVIOAsWaôî
(
	`d©aVIOAsAŒoˇtögVIO
(
d©aVIO
));

344 
	}
}

353 
ölöe
 
D©aVIO
 *
	$waôîAsD©aVIO
(
Waôî
 *
waôî
)

355 i‡(
waôî
 =
NULL
) {

356  
NULL
;

359  
	`ÆloˇtögVIOAsD©aVIO
(
	`waôîAsAŒoˇtögVIO
(
waôî
));

360 
	}
}

367 
ölöe
 
boﬁ
 
	$isRódD©aVIO
(
D©aVIO
 *
d©aVIO
)

369  
	`isRódVIO
(
	`d©aVIOAsVIO
(
d©aVIO
));

370 
	}
}

377 
ölöe
 
boﬁ
 
	$isWrôeD©aVIO
(
D©aVIO
 *
d©aVIO
)

379  
	`isWrôeVIO
(
	`d©aVIOAsVIO
(
d©aVIO
));

380 
	}
}

389 
ölöe
 
boﬁ
 
	$isCom¥es£dWrôeD©aVIO
(
D©aVIO
 *
d©aVIO
)

391  
	`isCom¥es£dWrôeVIO
(
	`d©aVIOAsVIO
(
d©aVIO
));

392 
	}
}

401 
ölöe
 
boﬁ
 
	$isTrimD©aVIO
(
D©aVIO
 *
d©aVIO
)

403  (
d©aVIO
->
√wM≠≥d
.
°©e
 =
MAPPING_STATE_UNMAPPED
);

404 
	}
}

414 
ölöe
 
D©aLoˇti⁄
 
	$gëD©aVIONewAdvi˚
(c⁄° 
D©aVIO
 *
d©aVIO
)

416  (
D©aLoˇti⁄
) {

417 .
pbn
 = 
d©aVIO
->
√wM≠≥d
.pbn,

418 .
°©e
 = 
d©aVIO
->
√wM≠≥d
.state,

420 
	}
}

429 
ölöe
 
VDO
 *
	$gëVDOFromD©aVIO
(
D©aVIO
 *
d©aVIO
)

431  
	`d©aVIOAsVIO
(
d©aVIO
)->
vdo
;

432 
	}
}

441 
ölöe
 c⁄° 
ThªadC⁄fig
 *
	$gëThªadC⁄figFromD©aVIO
(
D©aVIO
 *
d©aVIO
)

443  
	`gëThªadC⁄fig
(
	`gëVDOFromD©aVIO
(
d©aVIO
));

444 
	}
}

453 
ölöe
 
PhysiˇlBlockNumbî
 
	$gëD©aVIOAŒoˇti⁄
(
D©aVIO
 *
d©aVIO
)

455  
	`d©aVIOAsAŒoˇtögVIO
(
d©aVIO
)->
Æloˇti⁄
;

456 
	}
}

465 
ölöe
 
boﬁ
 
	$hasAŒoˇti⁄
(
D©aVIO
 *
d©aVIO
)

467  (
	`gëD©aVIOAŒoˇti⁄
(
d©aVIO
Ë!
ZERO_BLOCK
);

468 
	}
}

482 
¥ï¨eD©aVIO
(
D©aVIO
 *
d©aVIO
,

483 
LogiˇlBlockNumbî
 
lbn
,

484 
VIOO≥øti⁄
 
›î©i⁄
,

485 
boﬁ
 
isTrim
,

486 
VDOA˘i⁄
 *
ˇŒback
);

493 
com∂ëeD©aVIO
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
);

502 
föishD©aVIO
(
D©aVIO
 *
d©aVIO
, 
ªsu…
);

511 
ölöe
 
	$c⁄töueD©aVIO
(
D©aVIO
 *
d©aVIO
, 
ªsu…
)

513 
	`c⁄töueCom∂ëi⁄
(
	`d©aVIOAsCom∂ëi⁄
(
d©aVIO
), 
ªsu…
);

514 
	}
}

523 c⁄° *
	$gëO≥øti⁄Name
(
D©aVIO
 *
d©aVIO
)

524 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

532 
ölöe
 
	$d©aVIOAddTø˚Rec‹d
(
D©aVIO
 *
d©aVIO
,

533 
Tø˚Loˇti⁄
 
loˇti⁄
)

535 
	`vioAddTø˚Rec‹d
(
	`d©aVIOAsVIO
(
d©aVIO
), 
loˇti⁄
);

536 
	}
}

548 
__©åibuã__
((
w¨n_unu£d_ªsu…
))

549 
ölöe
 
	$íqueueD©aVIO
(
WaôQueue
 *
queue
,

550 
D©aVIO
 *
waôî
,

551 
Tø˚Loˇti⁄
 
loˇti⁄
)

553 
	`d©aVIOAddTø˚Rec‹d
(
waôî
, 
loˇti⁄
);

554  
	`íqueueWaôî
(
queue
, 
	`d©aVIOAsWaôî
(
waôî
));

555 
	}
}

562 
ölöe
 
	$as£πInHashZ⁄e
(
D©aVIO
 *
d©aVIO
)

564 
ThªadID
 
ex≥˘ed
 = 
	`gëHashZ⁄eThªadID
(
d©aVIO
->
hashZ⁄e
);

565 
ThªadID
 
thªadID
 = 
	`gëCÆlbackThªadID
();

568 
	`ASSERT_LOG_ONLY
((
ex≥˘ed
 =
thªadID
),

569 "D©aVIO f‹Üogiˇ»block %" 
PRIu64


571 
d©aVIO
->
logiˇl
.
lbn
, 
thªadID
, 
ex≥˘ed
);

572 
	}
}

582 
ölöe
 
	$£tHashZ⁄eCÆlback
(
D©aVIO
 *
d©aVIO
,

583 
VDOA˘i⁄
 *
ˇŒback
,

584 
Tø˚Loˇti⁄
 
loˇti⁄
)

586 
	`£tCÆlback
(
	`d©aVIOAsCom∂ëi⁄
(
d©aVIO
), 
ˇŒback
,

587 
	`gëHashZ⁄eThªadID
(
d©aVIO
->
hashZ⁄e
));

588 
	`d©aVIOAddTø˚Rec‹d
(
d©aVIO
, 
loˇti⁄
);

589 
	}
}

598 
ölöe
 
	$œunchHashZ⁄eCÆlback
(
D©aVIO
 *
d©aVIO
,

599 
VDOA˘i⁄
 *
ˇŒback
,

600 
Tø˚Loˇti⁄
 
loˇti⁄
)

602 
	`£tHashZ⁄eCÆlback
(
d©aVIO
, 
ˇŒback
, 
loˇti⁄
);

603 
	`övokeCÆlback
(
	`d©aVIOAsCom∂ëi⁄
(
d©aVIO
));

604 
	}
}

611 
ölöe
 
	$as£πInLogiˇlZ⁄e
(
D©aVIO
 *
d©aVIO
)

613 
ThªadID
 
ex≥˘ed
 = 
	`gëLogiˇlZ⁄eThªadID
(
d©aVIO
->
logiˇl
.
z⁄e
);

614 
ThªadID
 
thªadID
 = 
	`gëCÆlbackThªadID
();

615 
	`ASSERT_LOG_ONLY
((
ex≥˘ed
 =
thªadID
),

616 "D©aVIO f‹Üogiˇ»block %" 
PRIu64


618 
d©aVIO
->
logiˇl
.
lbn
, 
thªadID
, 
ex≥˘ed
);

619 
	}
}

629 
ölöe
 
	$£tLogiˇlCÆlback
(
D©aVIO
 *
d©aVIO
,

630 
VDOA˘i⁄
 *
ˇŒback
,

631 
Tø˚Loˇti⁄
 
loˇti⁄
)

633 
	`£tCÆlback
(
	`d©aVIOAsCom∂ëi⁄
(
d©aVIO
), 
ˇŒback
,

634 
	`gëLogiˇlZ⁄eThªadID
(
d©aVIO
->
logiˇl
.
z⁄e
));

635 
	`d©aVIOAddTø˚Rec‹d
(
d©aVIO
, 
loˇti⁄
);

636 
	}
}

645 
ölöe
 
	$œunchLogiˇlCÆlback
(
D©aVIO
 *
d©aVIO
,

646 
VDOA˘i⁄
 *
ˇŒback
,

647 
Tø˚Loˇti⁄
 
loˇti⁄
)

649 
	`£tLogiˇlCÆlback
(
d©aVIO
, 
ˇŒback
, 
loˇti⁄
);

650 
	`övokeCÆlback
(
	`d©aVIOAsCom∂ëi⁄
(
d©aVIO
));

651 
	}
}

659 
ölöe
 
	$as£πInAŒoˇãdZ⁄e
(
D©aVIO
 *
d©aVIO
)

661 
	`as£πInPhysiˇlZ⁄e
(
	`d©aVIOAsAŒoˇtögVIO
(
d©aVIO
));

662 
	}
}

671 
ölöe
 
	$£tAŒoˇãdZ⁄eCÆlback
(
D©aVIO
 *
d©aVIO
,

672 
VDOA˘i⁄
 *
ˇŒback
,

673 
Tø˚Loˇti⁄
 
loˇti⁄
)

675 
	`£tPhysiˇlZ⁄eCÆlback
(
	`d©aVIOAsAŒoˇtögVIO
(
d©aVIO
), 
ˇŒback
,

676 
loˇti⁄
);

677 
	}
}

687 
ölöe
 
	$œunchAŒoˇãdZ⁄eCÆlback
(
D©aVIO
 *
d©aVIO
,

688 
VDOA˘i⁄
 *
ˇŒback
,

689 
Tø˚Loˇti⁄
 
loˇti⁄
)

691 
	`œunchPhysiˇlZ⁄eCÆlback
(
	`d©aVIOAsAŒoˇtögVIO
(
d©aVIO
), 
ˇŒback
,

692 
loˇti⁄
);

693 
	}
}

701 
ölöe
 
	$as£πInDu∂iˇãZ⁄e
(
D©aVIO
 *
d©aVIO
)

703 
ThªadID
 
ex≥˘ed
 = 
	`gëPhysiˇlZ⁄eThªadID
(
d©aVIO
->
du∂iˇã
.
z⁄e
);

704 
ThªadID
 
thªadID
 = 
	`gëCÆlbackThªadID
();

705 
	`ASSERT_LOG_ONLY
((
ex≥˘ed
 =
thªadID
),

706 "D©aVIO f‹ du∂iˇãÖhysiˇ»block %" 
PRIu64


708 
d©aVIO
->
du∂iˇã
.
pbn
, 
thªadID
, 
ex≥˘ed
);

709 
	}
}

718 
ölöe
 
	$£tDu∂iˇãZ⁄eCÆlback
(
D©aVIO
 *
d©aVIO
,

719 
VDOA˘i⁄
 *
ˇŒback
,

720 
Tø˚Loˇti⁄
 
loˇti⁄
)

722 
	`£tCÆlback
(
	`d©aVIOAsCom∂ëi⁄
(
d©aVIO
), 
ˇŒback
,

723 
	`gëPhysiˇlZ⁄eThªadID
(
d©aVIO
->
du∂iˇã
.
z⁄e
));

724 
	`d©aVIOAddTø˚Rec‹d
(
d©aVIO
, 
loˇti⁄
);

725 
	}
}

735 
ölöe
 
	$œunchDu∂iˇãZ⁄eCÆlback
(
D©aVIO
 *
d©aVIO
,

736 
VDOA˘i⁄
 *
ˇŒback
,

737 
Tø˚Loˇti⁄
 
loˇti⁄
)

739 
	`£tDu∂iˇãZ⁄eCÆlback
(
d©aVIO
, 
ˇŒback
, 
loˇti⁄
);

740 
	`övokeCÆlback
(
	`d©aVIOAsCom∂ëi⁄
(
d©aVIO
));

741 
	}
}

748 
ölöe
 
	$as£πInM≠≥dZ⁄e
(
D©aVIO
 *
d©aVIO
)

750 
ThªadID
 
ex≥˘ed
 = 
	`gëPhysiˇlZ⁄eThªadID
(
d©aVIO
->
m≠≥d
.
z⁄e
);

751 
ThªadID
 
thªadID
 = 
	`gëCÆlbackThªadID
();

752 
	`ASSERT_LOG_ONLY
((
ex≥˘ed
 =
thªadID
),

753 "D©aVIO f‹ m≠≥dÖhysiˇ»block %" 
PRIu64


755 
d©aVIO
->
m≠≥d
.
pbn
, 
thªadID
, 
ex≥˘ed
);

756 
	}
}

765 
ölöe
 
	$£tM≠≥dZ⁄eCÆlback
(
D©aVIO
 *
d©aVIO
,

766 
VDOA˘i⁄
 *
ˇŒback
,

767 
Tø˚Loˇti⁄
 
loˇti⁄
)

769 
	`£tCÆlback
(
	`d©aVIOAsCom∂ëi⁄
(
d©aVIO
), 
ˇŒback
,

770 
	`gëPhysiˇlZ⁄eThªadID
(
d©aVIO
->
m≠≥d
.
z⁄e
));

771 
	`d©aVIOAddTø˚Rec‹d
(
d©aVIO
, 
loˇti⁄
);

772 
	}
}

780 
ölöe
 
	$as£πInNewM≠≥dZ⁄e
(
D©aVIO
 *
d©aVIO
)

782 
ThªadID
 
ex≥˘ed
 = 
	`gëPhysiˇlZ⁄eThªadID
(
d©aVIO
->
√wM≠≥d
.
z⁄e
);

783 
ThªadID
 
thªadID
 = 
	`gëCÆlbackThªadID
();

784 
	`ASSERT_LOG_ONLY
((
ex≥˘ed
 =
thªadID
),

785 "D©aVIO f‹ÇewM≠≥dÖhysiˇ»block %" 
PRIu64


787 
d©aVIO
->
√wM≠≥d
.
pbn
, 
thªadID
, 
ex≥˘ed
);

788 
	}
}

797 
ölöe
 
	$£tNewM≠≥dZ⁄eCÆlback
(
D©aVIO
 *
d©aVIO
,

798 
VDOA˘i⁄
 *
ˇŒback
,

799 
Tø˚Loˇti⁄
 
loˇti⁄
)

801 
	`£tCÆlback
(
	`d©aVIOAsCom∂ëi⁄
(
d©aVIO
), 
ˇŒback
,

802 
	`gëPhysiˇlZ⁄eThªadID
(
d©aVIO
->
√wM≠≥d
.
z⁄e
));

803 
	`d©aVIOAddTø˚Rec‹d
(
d©aVIO
, 
loˇti⁄
);

804 
	}
}

814 
ölöe
 
	$œunchNewM≠≥dZ⁄eCÆlback
(
D©aVIO
 *
d©aVIO
,

815 
VDOA˘i⁄
 *
ˇŒback
,

816 
Tø˚Loˇti⁄
 
loˇti⁄
)

818 
	`£tNewM≠≥dZ⁄eCÆlback
(
d©aVIO
, 
ˇŒback
, 
loˇti⁄
);

819 
	`övokeCÆlback
(
	`d©aVIOAsCom∂ëi⁄
(
d©aVIO
));

820 
	}
}

827 
ölöe
 
	$as£πInJou∫ÆZ⁄e
(
D©aVIO
 *
d©aVIO
)

829 
ThªadID
 
ex≥˘ed


830 
	`gëJou∫ÆZ⁄eThªad
(
	`gëThªadC⁄figFromD©aVIO
(
d©aVIO
));

831 
ThªadID
 
thªadID
 = 
	`gëCÆlbackThªadID
();

832 
	`ASSERT_LOG_ONLY
((
ex≥˘ed
 =
thªadID
),

833 "D©aVIO f‹Üogiˇ»block %" 
PRIu64


835 
d©aVIO
->
logiˇl
.
lbn
, 
thªadID
, 
ex≥˘ed
);

836 
	}
}

845 
ölöe
 
	$£tJou∫ÆCÆlback
(
D©aVIO
 *
d©aVIO
,

846 
VDOA˘i⁄
 *
ˇŒback
,

847 
Tø˚Loˇti⁄
 
loˇti⁄
)

849 
	`£tCÆlback
(
	`d©aVIOAsCom∂ëi⁄
(
d©aVIO
), 
ˇŒback
,

850 
	`gëJou∫ÆZ⁄eThªad
(
	`gëThªadC⁄figFromD©aVIO
(
d©aVIO
)));

851 
	`d©aVIOAddTø˚Rec‹d
(
d©aVIO
, 
loˇti⁄
);

852 
	}
}

861 
ölöe
 
	$œunchJou∫ÆCÆlback
(
D©aVIO
 *
d©aVIO
,

862 
VDOA˘i⁄
 *
ˇŒback
,

863 
Tø˚Loˇti⁄
 
loˇti⁄
)

865 
	`£tJou∫ÆCÆlback
(
d©aVIO
, 
ˇŒback
, 
loˇti⁄
);

866 
	`övokeCÆlback
(
	`d©aVIOAsCom∂ëi⁄
(
d©aVIO
));

867 
	}
}

874 
ölöe
 
	$as£πInPackîZ⁄e
(
D©aVIO
 *
d©aVIO
)

876 
ThªadID
 
ex≥˘ed
 = 
	`gëPackîZ⁄eThªad
(
	`gëThªadC⁄figFromD©aVIO
(
d©aVIO
));

877 
ThªadID
 
thªadID
 = 
	`gëCÆlbackThªadID
();

878 
	`ASSERT_LOG_ONLY
((
ex≥˘ed
 =
thªadID
),

879 "D©aVIO f‹Üogiˇ»block %" 
PRIu64


881 
d©aVIO
->
logiˇl
.
lbn
, 
thªadID
, 
ex≥˘ed
);

882 
	}
}

891 
ölöe
 
	$£tPackîCÆlback
(
D©aVIO
 *
d©aVIO
,

892 
VDOA˘i⁄
 *
ˇŒback
,

893 
Tø˚Loˇti⁄
 
loˇti⁄
)

895 
	`£tCÆlback
(
	`d©aVIOAsCom∂ëi⁄
(
d©aVIO
), 
ˇŒback
,

896 
	`gëPackîZ⁄eThªad
(
	`gëThªadC⁄figFromD©aVIO
(
d©aVIO
)));

897 
	`d©aVIOAddTø˚Rec‹d
(
d©aVIO
, 
loˇti⁄
);

898 
	}
}

907 
ölöe
 
	$œunchPackîCÆlback
(
D©aVIO
 *
d©aVIO
,

908 
VDOA˘i⁄
 *
ˇŒback
,

909 
Tø˚Loˇti⁄
 
loˇti⁄
)

911 
	`£tPackîCÆlback
(
d©aVIO
, 
ˇŒback
, 
loˇti⁄
);

912 
	`övokeCÆlback
(
	`d©aVIOAsCom∂ëi⁄
(
d©aVIO
));

913 
	}
}

923 
ª˚iveDedu≥Advi˚
(
D©aVIO
 *
d©aVIO
, c⁄° 
D©aLoˇti⁄
 *
advi˚
);

932 
£tDu∂iˇãLoˇti⁄
(
D©aVIO
 *
d©aVIO
, c⁄° 
Z⁄edPBN
 
sour˚
);

941 
˛órM≠≥dLoˇti⁄
(
D©aVIO
 *
d©aVIO
);

953 
	$£tM≠≥dLoˇti⁄
(
D©aVIO
 *
d©aVIO
,

954 
PhysiˇlBlockNumbî
 
pbn
,

955 
BlockM≠pögSèã
 
°©e
)

956 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

964 
	`©ãm±LogiˇlBlockLock
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
);

971 
	`ªÀa£LogiˇlBlockLock
(
D©aVIO
 *
d©aVIO
);

	@vdo/base/dirtyLists.c

22 
	~"dútyLi°s.h
"

23 
	~"dútyLi°sI¡î«ls.h
"

25 
	~"loggî.h
"

26 
	~"mem‹yAŒoc.h
"

28 
	~"ty≥s.h
"

30 
	sdútyLi°s
 {

32 
BlockCou¡
 
	mmaximumAge
;

34 
Sequí˚Numbî
 
	mﬁde°Pîiod
;

36 
Sequí˚Numbî
 
	m√xtPîiod
;

38 
DútyCÆlback
 *
	mˇŒback
;

40 *
	mc⁄ãxt
;

42 
BlockCou¡
 
	moff£t
;

44 
RögNode
 
	mexpúed
;

46 
RögNode
 
	mli°s
[];

50 
	$makeDútyLi°s
(
BlockCou¡
 
maximumAge
,

51 
DútyCÆlback
 *
ˇŒback
,

52 *
c⁄ãxt
,

53 
DútyLi°s
 **
dútyLi°sPå
)

55 
DútyLi°s
 *
dútyLi°s
;

56 
ªsu…
 = 
	`ALLOCATE_EXTENDED
(
DútyLi°s
, 
maximumAge
, 
RögNode
, 
__func__
,

57 &
dútyLi°s
);

58 i‡(
ªsu…
 !
VDO_SUCCESS
) {

59  
ªsu…
;

62 
dútyLi°s
->
maximumAge
 = maximumAge;

63 
dútyLi°s
->
ˇŒback
 = callback;

64 
dútyLi°s
->
c⁄ãxt
 = context;

66 
	`öôülizeRög
(&
dútyLi°s
->
expúed
);

67 
BlockCou¡
 
i
 = 0; i < 
maximumAge
; i++) {

68 
	`öôülizeRög
(&
dútyLi°s
->
li°s
[
i
]);

71 *
dútyLi°sPå
 = 
dútyLi°s
;

72  
VDO_SUCCESS
;

73 
	}
}

76 
	$‰ìDútyLi°s
(
DútyLi°s
 **
dútyLi°sPå
)

78 
DútyLi°s
 *
li°s
 = *
dútyLi°sPå
;

79 i‡(
li°s
 =
NULL
) {

83 
	`FREE
(
li°s
);

84 *
dútyLi°sPå
 = 
NULL
;

85 
	}
}

88 
	$£tCuºítPîiod
(
DútyLi°s
 *
dútyLi°s
, 
Sequí˚Numbî
 
≥riod
)

90 
	`ASSERT_LOG_ONLY
(
dútyLi°s
->
√xtPîiod
 == 0, "currentÖeriodÇot set");

91 
dútyLi°s
->
ﬁde°Pîiod
 = 
≥riod
;

92 
dútyLi°s
->
√xtPîiod
 = 
≥riod
 + 1;

93 
dútyLi°s
->
off£t
 = 
≥riod
 % dútyLi°s->
maximumAge
;

94 
	}
}

101 
	$expúeOlde°Li°
(
DútyLi°s
 *
dútyLi°s
)

103 
dútyLi°s
->
ﬁde°Pîiod
++;

104 
RögNode
 *
rög
 = &(
dútyLi°s
->
li°s
[dútyLi°s->
off£t
++]);

105 i‡(!
	`isRögEm±y
(
rög
)) {

106 
	`•li˚RögChaöBef‹e
(
rög
->
√xt
,Ñög->
¥ev
, &
dútyLi°s
->
expúed
);

109 i‡(
dútyLi°s
->
off£t
 =dútyLi°s->
maximumAge
) {

110 
dútyLi°s
->
off£t
 = 0;

112 
	}
}

120 
	$upd©ePîiod
(
DútyLi°s
 *
dútyLi°s
, 
Sequí˚Numbî
 
≥riod
)

122 
dútyLi°s
->
√xtPîiod
 <
≥riod
) {

123 i‡((
dútyLi°s
->
√xtPîiod
 - dútyLi°s->
ﬁde°Pîiod
)

124 =
dútyLi°s
->
maximumAge
) {

125 
	`expúeOlde°Li°
(
dútyLi°s
);

127 
dútyLi°s
->
√xtPîiod
++;

129 
	}
}

136 
	$wrôeExpúedEÀmíts
(
DútyLi°s
 *
dútyLi°s
)

138 i‡(
	`isRögEm±y
(&
dútyLi°s
->
expúed
)) {

142 
dútyLi°s
->
	`ˇŒback
(&dútyLi°s->
expúed
, dútyLi°s->
c⁄ãxt
);

143 
	`ASSERT_LOG_ONLY
(
	`isRögEm±y
(&
dútyLi°s
->
expúed
),

145 
	}
}

148 
	$addToDútyLi°s
(
DútyLi°s
 *
dútyLi°s
,

149 
RögNode
 *
node
,

150 
Sequí˚Numbî
 
ﬁdPîiod
,

151 
Sequí˚Numbî
 
√wPîiod
)

153 i‡((
ﬁdPîiod
 =
√wPîiod
)

154 || ((
ﬁdPîiod
 !0Ë&& (ﬁdPîiod < 
√wPîiod
))) {

158 i‡(
√wPîiod
 < 
dútyLi°s
->
ﬁde°Pîiod
) {

159 
	`pushRögNode
(&
dútyLi°s
->
expúed
, 
node
);

161 
	`upd©ePîiod
(
dútyLi°s
, 
√wPîiod
);

162 
	`pushRögNode
(&
dútyLi°s
->
li°s
[
√wPîiod
 % dútyLi°s->
maximumAge
], 
node
);

165 
	`wrôeExpúedEÀmíts
(
dútyLi°s
);

166 
	}
}

169 
	$adv™˚Pîiod
(
DútyLi°s
 *
dútyLi°s
, 
Sequí˚Numbî
 
≥riod
)

171 
	`upd©ePîiod
(
dútyLi°s
, 
≥riod
);

172 
	`wrôeExpúedEÀmíts
(
dútyLi°s
);

173 
	}
}

176 
	$ÊushDútyLi°s
(
DútyLi°s
 *
dútyLi°s
)

178 
dútyLi°s
->
ﬁde°Pîiod
 < dútyLi°s->
√xtPîiod
) {

179 
	`expúeOlde°Li°
(
dútyLi°s
);

181 
	`wrôeExpúedEÀmíts
(
dútyLi°s
);

182 
	}
}

185 
Sequí˚Numbî
 
	$gëDútyLi°sNextPîiod
(
DútyLi°s
 *
dútyLi°s
)

187  
dútyLi°s
->
√xtPîiod
;

188 
	}
}

	@vdo/base/dirtyLists.h

22 #i‚de‡
DIRTY_LISTS_H


23 
	#DIRTY_LISTS_H


	)

25 
	~"rögNode.h
"

26 
	~"ty≥s.h
"

35 
dútyLi°s
 
	tDútyLi°s
;

45 
	tDútyCÆlback
(
	tRögNode
 *
	texpúed
, *
	tc⁄ãxt
);

58 
	$makeDútyLi°s
(
BlockCou¡
 
maximumAge
,

59 
DútyCÆlback
 *
ˇŒback
,

60 *
c⁄ãxt
,

61 
DútyLi°s
 **
dútyLi°sPå
)

62 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

69 
	`‰ìDútyLi°s
(
DútyLi°s
 **
dútyLi°sPå
);

77 
	`£tCuºítPîiod
(
DútyLi°s
 *
dútyLi°s
, 
Sequí˚Numbî
 
≥riod
);

89 
	`addToDútyLi°s
(
DútyLi°s
 *
dútyLi°s
,

90 
RögNode
 *
node
,

91 
Sequí˚Numbî
 
ﬁdPîiod
,

92 
Sequí˚Numbî
 
√wPîiod
);

101 
	`adv™˚Pîiod
(
DútyLi°s
 *
dútyLi°s
, 
Sequí˚Numbî
 
≥riod
);

109 
	`ÊushDútyLi°s
(
DútyLi°s
 *
dútyLi°s
);

	@vdo/base/dirtyListsInternals.h

22 #i‚de‡
DIRTY_LISTS_INTERNALS_H


23 
	#DIRTY_LISTS_INTERNALS_H


	)

25 
	~"dútyLi°s.h
"

26 
	~"ty≥s.h
"

33 
Sequí˚Numbî
 
	$gëDútyLi°sNextPîiod
(
DútyLi°s
 *
dútyLi°s
)

34 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

	@vdo/base/extent.c

22 
	~"exã¡.h
"

24 
	~"mem‹yAŒoc.h
"

26 
	~"com∂ëi⁄.h
"

27 
	~"c⁄°™ts.h
"

28 
	~"loggî.h
"

29 
	~"physiˇlLayî.h
"

30 
	~"ty≥s.h
"

31 
	~"vdo.h
"

32 
	~"vioRód.h
"

33 
	~"vioWrôe.h
"

36 
	$¸óãExã¡
(
PhysiˇlLayî
 *
œyî
,

37 
VIOTy≥
 
vioTy≥
,

38 
VIOPri‹ôy
 
¥i‹ôy
,

39 
BlockCou¡
 
blockCou¡
,

40 *
d©a
,

41 
VDOExã¡
 **
exã¡På
)

43 
ªsu…
 = 
	`ASSERT
(
	`isMëad©aVIOTy≥
(
vioTy≥
),

45 i‡(
ªsu…
 !
VDO_SUCCESS
) {

46  
ªsu…
;

49 
VDOExã¡
 *
exã¡
;

50 
ªsu…
 = 
	`ALLOCATE_EXTENDED
(
VDOExã¡
, 
blockCou¡
, 
VIO
 *, 
__func__
, &
exã¡
);

51 i‡(
ªsu…
 !
VDO_SUCCESS
) {

52  
ªsu…
;

55 
ªsu…
 = 
	`öôülizeEnqueuóbÀCom∂ëi⁄
(&
exã¡
->
com∂ëi⁄
,

56 
VDO_EXTENT_COMPLETION
, 
œyî
);

58 ; 
exã¡
->
cou¡
 < 
blockCou¡
;Éxtent->count++) {

59 
ªsu…
 = 
œyî
->
	`¸óãMëad©aVIO
÷ayî, 
vioTy≥
, 
¥i‹ôy
, 
exã¡
, 
d©a
,

60 &
exã¡
->
vios
[exã¡->
cou¡
]);

61 i‡(
ªsu…
 !
VDO_SUCCESS
) {

62 
	`‰ìExã¡
(&
exã¡
);

63  
ªsu…
;

66 
d©a
 +
VDO_BLOCK_SIZE
;

69 *
exã¡På
 = 
exã¡
;

70  
VDO_SUCCESS
;

71 
	}
}

74 
	$‰ìExã¡
(
VDOExã¡
 **
exã¡På
)

76 
VDOExã¡
 *
exã¡
 = *
exã¡På
;

77 i‡(
exã¡
 =
NULL
) {

81 
BlockCou¡
 
i
 = 0; i < 
exã¡
->
cou¡
; i++) {

82 
	`‰ìVIO
(&
exã¡
->
vios
[
i
]);

85 
	`de°royEnqueuóbÀ
(&
exã¡
->
com∂ëi⁄
);

86 
	`FREE
(
exã¡
);

87 *
exã¡På
 = 
NULL
;

88 
	}
}

98 
	$œunchMëad©aExã¡
(
VDOExã¡
 *
exã¡
,

99 
PhysiˇlBlockNumbî
 
°¨tBlock
,

100 
VIOO≥øti⁄
 
›î©i⁄
)

102 
	`ª£tCom∂ëi⁄
(&
exã¡
->
com∂ëi⁄
);

103 
exã¡
->
com∂ëeCou¡
 = 0;

104 
BlockCou¡
 
vioCou¡
 = 
exã¡
->
cou¡
;

105 
BlockCou¡
 
i
 = 0; i < 
vioCou¡
; i++) {

106 
VIO
 *
vio
 = 
exã¡
->
vios
[
i
];

107 
vio
->
com∂ëi⁄
.
ˇŒbackThªadID
 = 
exã¡
->completion.callbackThreadID;

108 
	`œunchMëad©aVIO
(
vio
, 
°¨tBlock
++, 
h™dÀVIOCom∂ëi⁄
,

109 
h™dÀVIOCom∂ëi⁄
, 
›î©i⁄
);

111 
	}
}

114 
	$ªadMëad©aExã¡
(
VDOExã¡
 *
exã¡
, 
PhysiˇlBlockNumbî
 
°¨tBlock
)

116 
	`œunchMëad©aExã¡
(
exã¡
, 
°¨tBlock
, 
VIO_READ
);

117 
	}
}

120 
	$wrôeMëad©aExã¡
(
VDOExã¡
 *
exã¡
, 
PhysiˇlBlockNumbî
 
°¨tBlock
)

122 
	`œunchMëad©aExã¡
(
exã¡
, 
°¨tBlock
, 
VIO_WRITE
);

123 
	}
}

126 
	$h™dÀVIOCom∂ëi⁄
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

128 
VDOExã¡
 *
exã¡
 = 
	`asVDOExã¡
(
com∂ëi⁄
->
∑ª¡
);

129 i‡(++
exã¡
->
com∂ëeCou¡
 !exã¡->
cou¡
) {

130 
	`£tCom∂ëi⁄Resu…
(
	`exã¡AsCom∂ëi⁄
(
exã¡
), 
com∂ëi⁄
->
ªsu…
);

134 
	`föishCom∂ëi⁄
(
	`exã¡AsCom∂ëi⁄
(
exã¡
), 
com∂ëi⁄
->
ªsu…
);

135 
	}
}

	@vdo/base/extent.h

22 #i‚de‡
EXTENT_H


23 
	#EXTENT_H


	)

25 
	~"≥rmas£π.h
"

27 
	~"com∂ëi⁄.h
"

28 
	~"ty≥s.h
"

29 
	~"vio.h
"

37 
	svdoExã¡
 {

39 
VDOCom∂ëi⁄
 
	mcom∂ëi⁄
;

41 
BlockCou¡
 
	mcou¡
;

43 
BlockCou¡
 
	mcom∂ëeCou¡
;

45 
VIO
 *
	mvios
[];

55 
ölöe
 
VDOExã¡
 *
	$asVDOExã¡
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

57 
	`STATIC_ASSERT
(
	`off£tof
(
VDOExã¡
, 
com∂ëi⁄
) == 0);

58 
	`as£πCom∂ëi⁄Ty≥
(
com∂ëi⁄
->
ty≥
, 
VDO_EXTENT_COMPLETION
);

59  (
VDOExã¡
 *Ë
com∂ëi⁄
;

60 
	}
}

69 
ölöe
 
VDOCom∂ëi⁄
 *
	$exã¡AsCom∂ëi⁄
(
VDOExã¡
 *
exã¡
)

71  &
exã¡
->
com∂ëi⁄
;

72 
	}
}

87 
	$¸óãExã¡
(
PhysiˇlLayî
 *
œyî
,

88 
VIOTy≥
 
vioTy≥
,

89 
VIOPri‹ôy
 
¥i‹ôy
,

90 
BlockCou¡
 
blockCou¡
,

91 *
d©a
,

92 
VDOExã¡
 **
exã¡På
)

93 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

100 
	`‰ìExã¡
(
VDOExã¡
 **
exã¡På
);

109 
	`ªadMëad©aExã¡
(
VDOExã¡
 *
exã¡
, 
PhysiˇlBlockNumbî
 
°¨tBlock
);

118 
	`wrôeMëad©aExã¡
(
VDOExã¡
 *
exã¡
, 
PhysiˇlBlockNumbî
 
°¨tBlock
);

127 
	`h™dÀVIOCom∂ëi⁄
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
);

	@vdo/base/fixedLayout.c

22 
	~"fixedLayout.h
"

24 
	~"buf„r.h
"

25 
	~"loggî.h
"

26 
	~"mem‹yAŒoc.h
"

28 
	~"hódî.h
"

29 
	~"°©usCodes.h
"

31 c⁄° 
BlockCou¡
 
	gALL_FREE_BLOCKS
 = (
uöt64_t
) -1;

33 
	sfixedLayout
 {

34 
PhysiˇlBlockNumbî
 
	mfú°Fªe
;

35 
PhysiˇlBlockNumbî
 
	mœ°Fªe
;

36 
size_t
 
	mnumP¨tôi⁄s
;

37 
P¨tôi⁄
 *
	mhód
;

40 
	s∑πôi⁄
 {

41 
P¨tôi⁄ID
 
	mid
;

42 
FixedLayout
 *
	mœyout
;

43 
PhysiˇlBlockNumbî
 
	moff£t
;

44 
PhysiˇlBlockNumbî
 
	mba£
;

45 
BlockCou¡
 
	mcou¡
;

46 
P¨tôi⁄
 *
	m√xt
;

50 
PhysiˇlBlockNumbî
 
	mfú°Fªe
;

51 
PhysiˇlBlockNumbî
 
	mœ°Fªe
;

52 
byã
 
	m∑πôi⁄Cou¡
;

53 } 
	t__©åibuã__
((
	t∑cked
)Ë
	tLayout3_0
;

56 
P¨tôi⁄ID
 
	mid
;

57 
PhysiˇlBlockNumbî
 
	moff£t
;

58 
PhysiˇlBlockNumbî
 
	mba£
;

59 
BlockCou¡
 
	mcou¡
;

60 } 
	t__©åibuã__
((
	t∑cked
)Ë
	tP¨tôi⁄3_0
;

62 c⁄° 
Hódî
 
	gLAYOUT_HEADER_3_0
 = {

63 .
id
 = 
FIXED_LAYOUT
,

64 .
	gvîsi⁄
 = {

65 .
maj‹Vîsi⁄
 = 3,

66 .
	gmö‹Vîsi⁄
 = 0,

68 .
	gsize
 = (
Layout3_0
),

71 c⁄° 
Hódî
 *
	gCURRENT_LAYOUT_HEADER
 = &
LAYOUT_HEADER_3_0
;

74 
	$makeFixedLayout
(
BlockCou¡
 
tŸÆBlocks
,

75 
PhysiˇlBlockNumbî
 
°¨tOff£t
,

76 
FixedLayout
 **
œyoutPå
)

78 
FixedLayout
 *
œyout
;

79 
ªsu…
 = 
	`ALLOCATE
(1, 
FixedLayout
, "fixedÜayout", &
œyout
);

80 i‡(
ªsu…
 !
UDS_SUCCESS
) {

81  
ªsu…
;

84 
œyout
->
fú°Fªe
 = 
°¨tOff£t
;

85 
œyout
->
œ°Fªe
 = 
°¨tOff£t
 + 
tŸÆBlocks
;

86 
œyout
->
numP¨tôi⁄s
 = 0;

87 
œyout
->
hód
 = 
NULL
;

89 *
œyoutPå
 = 
œyout
;

90  
VDO_SUCCESS
;

91 
	}
}

94 
	$‰ìFixedLayout
(
FixedLayout
 **
œyoutPå
)

96 
FixedLayout
 *
œyout
 = *
œyoutPå
;

97 i‡(
œyout
 =
NULL
) {

101 
œyout
->
hód
 !
NULL
) {

102 
P¨tôi⁄
 *
∑π
 = 
œyout
->
hód
;

103 
œyout
->
hód
 = 
∑π
->
√xt
;

104 
	`FREE
(
∑π
);

107 
	`FREE
(
œyout
);

108 *
œyoutPå
 = 
NULL
;

109 
	}
}

112 
BlockCou¡
 
	$gëTŸÆFixedLayoutSize
(c⁄° 
FixedLayout
 *
œyout
)

114 
BlockCou¡
 
size
 = 
	`gëFixedLayoutBlocksAvaûabÀ
(
œyout
);

115 
P¨tôi⁄
 *
∑πôi⁄
 = 
œyout
->
hód
;Ö¨tôi⁄ !
NULL
;

116 
∑πôi⁄
 =Ö¨tôi⁄->
√xt
) {

117 
size
 +
∑πôi⁄
->
cou¡
;

120  
size
;

121 
	}
}

124 
	$gëP¨tôi⁄
(
FixedLayout
 *
œyout
, 
P¨tôi⁄ID
 
id
, 
P¨tôi⁄
 **
∑πôi⁄På
)

126 
P¨tôi⁄
 *
∑πôi⁄
 = 
œyout
->
hód
;Ö¨tôi⁄ !
NULL
;

127 
∑πôi⁄
 =Ö¨tôi⁄->
√xt
) {

128 i‡(
∑πôi⁄
->
id
 == id) {

129 i‡(
∑πôi⁄På
 !
NULL
) {

130 *
∑πôi⁄På
 = 
∑πôi⁄
;

132  
VDO_SUCCESS
;

136  
VDO_UNKNOWN_PARTITION
;

137 
	}
}

140 
	$å™¶©eToPBN
(c⁄° 
P¨tôi⁄
 *
∑πôi⁄
,

141 
PhysiˇlBlockNumbî
 
∑πôi⁄BlockNumbî
,

142 
PhysiˇlBlockNumbî
 *
œyîBlockNumbî
)

144 i‡(
∑πôi⁄
 =
NULL
) {

145 *
œyîBlockNumbî
 = 
∑πôi⁄BlockNumbî
;

146  
VDO_SUCCESS
;

149 i‡(
∑πôi⁄BlockNumbî
 < 
∑πôi⁄
->
ba£
) {

150  
VDO_OUT_OF_RANGE
;

153 
PhysiˇlBlockNumbî
 
off£tFromBa£
 = 
∑πôi⁄BlockNumbî
 - 
∑πôi⁄
->
ba£
;

154 i‡(
off£tFromBa£
 >
∑πôi⁄
->
cou¡
) {

155  
VDO_OUT_OF_RANGE
;

158 *
œyîBlockNumbî
 = 
∑πôi⁄
->
off£t
 + 
off£tFromBa£
;

159  
VDO_SUCCESS
;

160 
	}
}

163 
	$å™¶©eFromPBN
(c⁄° 
P¨tôi⁄
 *
∑πôi⁄
,

164 
PhysiˇlBlockNumbî
 
œyîBlockNumbî
,

165 
PhysiˇlBlockNumbî
 *
∑πôi⁄BlockNumbîPå
)

167 i‡(
∑πôi⁄
 =
NULL
) {

168 *
∑πôi⁄BlockNumbîPå
 = 
œyîBlockNumbî
;

169  
VDO_SUCCESS
;

172 i‡(
œyîBlockNumbî
 < 
∑πôi⁄
->
off£t
) {

173  
VDO_OUT_OF_RANGE
;

176 
PhysiˇlBlockNumbî
 
∑πôi⁄BlockNumbî


177 
œyîBlockNumbî
 - 
∑πôi⁄
->
off£t
;

178 i‡(
∑πôi⁄BlockNumbî
 >
∑πôi⁄
->
cou¡
) {

179  
VDO_OUT_OF_RANGE
;

182 *
∑πôi⁄BlockNumbîPå
 = 
∑πôi⁄BlockNumbî
 + 
∑πôi⁄
->
ba£
;

183  
VDO_SUCCESS
;

184 
	}
}

187 
BlockCou¡
 
	$gëFixedLayoutBlocksAvaûabÀ
(c⁄° 
FixedLayout
 *
œyout
)

189  
œyout
->
œ°Fªe
 -Üayout->
fú°Fªe
;

190 
	}
}

204 
	$ÆloˇãP¨tôi⁄
(
FixedLayout
 *
œyout
,

205 
byã
 
id
,

206 
PhysiˇlBlockNumbî
 
off£t
,

207 
PhysiˇlBlockNumbî
 
ba£
,

208 
BlockCou¡
 
blockCou¡
)

210 
P¨tôi⁄
 *
∑πôi⁄
;

211 
ªsu…
 = 
	`ALLOCATE
(1, 
P¨tôi⁄
, "fixedÜayouà∑πôi⁄", &
∑πôi⁄
);

212 i‡(
ªsu…
 !
UDS_SUCCESS
) {

213  
ªsu…
;

216 
∑πôi⁄
->
id
 = id;

217 
∑πôi⁄
->
œyout
 =Üayout;

218 
∑πôi⁄
->
off£t
 = offset;

219 
∑πôi⁄
->
ba£
 = base;

220 
∑πôi⁄
->
cou¡
 = 
blockCou¡
;

221 
∑πôi⁄
->
√xt
 = 
œyout
->
hód
;

222 
œyout
->
hód
 = 
∑πôi⁄
;

224  
VDO_SUCCESS
;

225 
	}
}

228 
	$makeFixedLayoutP¨tôi⁄
(
FixedLayout
 *
œyout
,

229 
P¨tôi⁄ID
 
id
,

230 
BlockCou¡
 
blockCou¡
,

231 
P¨tôi⁄Dúe˘i⁄
 
dúe˘i⁄
,

232 
PhysiˇlBlockNumbî
 
ba£
)

234 
BlockCou¡
 
‰ìBlocks
 = 
œyout
->
œ°Fªe
 -Üayout->
fú°Fªe
;

235 i‡(
blockCou¡
 =
ALL_FREE_BLOCKS
) {

236 i‡(
‰ìBlocks
 == 0) {

237  
VDO_NO_SPACE
;

239 
blockCou¡
 = 
‰ìBlocks
;

241 } i‡(
blockCou¡
 > 
‰ìBlocks
) {

242  
VDO_NO_SPACE
;

245 
ªsu…
 = 
	`gëP¨tôi⁄
(
œyout
, 
id
, 
NULL
);

246 i‡(
ªsu…
 !
VDO_UNKNOWN_PARTITION
) {

247  
VDO_PARTITION_EXISTS
;

250 
PhysiˇlBlockNumbî
 
off£t
 = ((
dúe˘i⁄
 =
FROM_END
)

251 ? (
œyout
->
œ°Fªe
 - 
blockCou¡
)

252 : 
œyout
->
fú°Fªe
);

253 
ªsu…
 = 
	`ÆloˇãP¨tôi⁄
(
œyout
, 
id
, 
off£t
, 
ba£
, 
blockCou¡
);

254 i‡(
ªsu…
 !
VDO_SUCCESS
) {

255  
ªsu…
;

258 
œyout
->
numP¨tôi⁄s
++;

259 i‡(
dúe˘i⁄
 =
FROM_END
) {

260 
œyout
->
œ°Fªe
 =Üayout->œ°Fªê- 
blockCou¡
;

262 
œyout
->
fú°Fªe
 +
blockCou¡
;

265  
VDO_SUCCESS
;

266 
	}
}

269 
BlockCou¡
 
	$gëFixedLayoutP¨tôi⁄Size
(c⁄° 
P¨tôi⁄
 *
∑πôi⁄
)

271  
∑πôi⁄
->
cou¡
;

272 
	}
}

275 
PhysiˇlBlockNumbî
 
	$gëFixedLayoutP¨tôi⁄Off£t
(c⁄° 
P¨tôi⁄
 *
∑πôi⁄
)

277  
∑πôi⁄
->
off£t
;

278 
	}
}

281 
PhysiˇlBlockNumbî
 
	$gëFixedLayoutP¨tôi⁄Ba£
(c⁄° 
P¨tôi⁄
 *
∑πôi⁄
)

283  
∑πôi⁄
->
ba£
;

284 
	}
}

287 
ölöe
 
size_t
 
	$gëEncodedSize
(c⁄° 
FixedLayout
 *
œyout
)

289  (
Layout3_0
Ë+ ((
P¨tôi⁄3_0
Ë* 
œyout
->
numP¨tôi⁄s
);

290 
	}
}

293 
size_t
 
	$gëFixedLayoutEncodedSize
(c⁄° 
FixedLayout
 *
œyout
)

295  
ENCODED_HEADER_SIZE
 + 
	`gëEncodedSize
(
œyout
);

296 
	}
}

299 
	$ícodeFixedLayout
(c⁄° 
FixedLayout
 *
œyout
, 
Buf„r
 *
buf„r
)

301 
	`STATIC_ASSERT_SIZEOF
(
P¨tôi⁄ID
, (
byã
));

302 
Hódî
 
hódî
 = *
CURRENT_LAYOUT_HEADER
;

303 
hódî
.
size
 = 
	`gëEncodedSize
(
œyout
);

305 i‡(!
	`ísuªAvaûabÀS∑˚
(
buf„r
, 
	`gëFixedLayoutEncodedSize
(
œyout
))) {

306  
UDS_BUFFER_ERROR
;

309 
ªsu…
 = 
	`ícodeHódî
(&
hódî
, 
buf„r
);

310 i‡(
ªsu…
 !
UDS_SUCCESS
) {

311  
ªsu…
;

314 
Layout3_0
 
œyoutHódî
 = {

315 .
fú°Fªe
 = 
œyout
->firstFree,

316 .
œ°Fªe
 = 
œyout
->lastFree,

317 .
∑πôi⁄Cou¡
 = (
byã
Ë
œyout
->
numP¨tôi⁄s
,

319 
ªsu…
 = 
	`putByãs
(
buf„r
, (
Layout3_0
), &
œyoutHódî
);

320 i‡(
ªsu…
 !
UDS_SUCCESS
) {

321  
ªsu…
;

324 
P¨tôi⁄
 *
∑πôi⁄
 = 
œyout
->
hód
;Ö¨tôi⁄ !
NULL
;

325 
∑πôi⁄
 =Ö¨tôi⁄->
√xt
) {

326 
P¨tôi⁄3_0
 
∑πôi⁄Sèã
 = {

327 .
id
 = 
∑πôi⁄
->id,

328 .
off£t
 = 
∑πôi⁄
->offset,

329 .
ba£
 = 
∑πôi⁄
->base,

330 .
cou¡
 = 
∑πôi⁄
->count,

332 
ªsu…
 = 
	`putByãs
(
buf„r
, (
P¨tôi⁄3_0
), &
∑πôi⁄Sèã
);

333 i‡(
ªsu…
 !
UDS_SUCCESS
) {

334  
ªsu…
;

338  
VDO_SUCCESS
;

339 
	}
}

342 
	$decodeFixedLayout
(
Buf„r
 *
buf„r
, 
FixedLayout
 **
œyoutPå
)

344 
Hódî
 
hódî
;

345 
ªsu…
 = 
	`decodeHódî
(
buf„r
, &
hódî
);

346 i‡(
ªsu…
 !
UDS_SUCCESS
) {

347  
ªsu…
;

351 
ªsu…
 = 
	`vÆid©eHódî
(
CURRENT_LAYOUT_HEADER
, &
hódî
, 
Ál£
, 
__func__
);

352 i‡(
ªsu…
 !
VDO_SUCCESS
) {

353  
ªsu…
;

356 
Layout3_0
 
œyoutHódî
;

357 
ªsu…
 = 
	`gëByãsFromBuf„r
(
buf„r
, (
Layout3_0
), &
œyoutHódî
);

358 i‡(
ªsu…
 !
UDS_SUCCESS
) {

359  
ªsu…
;

362 i‡(
	`c⁄ã¡Lígth
(
buf„r
)

363 < ((
P¨tôi⁄3_0
Ë* 
œyoutHódî
.
∑πôi⁄Cou¡
)) {

364  
VDO_UNSUPPORTED_VERSION
;

367 
FixedLayout
 *
œyout
;

368 
ªsu…
 = 
	`ALLOCATE
(1, 
FixedLayout
, "fixedÜayout", &
œyout
);

369 i‡(
ªsu…
 !
UDS_SUCCESS
) {

370  
ªsu…
;

373 
œyout
->
fú°Fªe
 = 
œyoutHódî
.firstFree;

374 
œyout
->
œ°Fªe
 = 
œyoutHódî
.lastFree;

375 
œyout
->
numP¨tôi⁄s
 = 
œyoutHódî
.
∑πôi⁄Cou¡
;

377 
size_t
 
i
 = 0; i < 
œyout
->
numP¨tôi⁄s
; i++) {

378 
P¨tôi⁄3_0
 
∑πôi⁄Hódî
;

379 
ªsu…
 = 
	`gëByãsFromBuf„r
(
buf„r
, (
P¨tôi⁄3_0
),

380 &
∑πôi⁄Hódî
);

381 i‡(
ªsu…
 !
UDS_SUCCESS
) {

385 
ªsu…
 = 
	`ÆloˇãP¨tôi⁄
(
œyout
, 
∑πôi⁄Hódî
.
id
,

386 
∑πôi⁄Hódî
.
off£t
,Ö¨tôi⁄Hódî.
ba£
,

387 
∑πôi⁄Hódî
.
cou¡
);

388 i‡(
ªsu…
 !
VDO_SUCCESS
) {

393 i‡(
ªsu…
 !
VDO_SUCCESS
) {

394 
	`‰ìFixedLayout
(&
œyout
);

395  
ªsu…
;

398 *
œyoutPå
 = 
œyout
;

399  
VDO_SUCCESS
;

400 
	}
}

	@vdo/base/fixedLayout.h

22 #i‚de‡
FIXED_LAYOUT_H


23 
	#FIXED_LAYOUT_H


	)

25 
	~"buf„r.h
"

27 
	~"ty≥s.h
"

30 
	mFROM_BEGINNING
,

31 
	mFROM_END
,

32 } 
	tP¨tôi⁄Dúe˘i⁄
;

34 c⁄° 
BlockCou¡
 
ALL_FREE_BLOCKS
;

41 
fixedLayout
 
	tFixedLayout
;

42 
∑πôi⁄
 
	tP¨tôi⁄
;

54 
	$makeFixedLayout
(
BlockCou¡
 
tŸÆBlocks
,

55 
PhysiˇlBlockNumbî
 
°¨tOff£t
,

56 
FixedLayout
 **
œyoutPå
)

57 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

66 
	`‰ìFixedLayout
(
FixedLayout
 **
œyoutPå
);

75 
BlockCou¡
 
	$gëTŸÆFixedLayoutSize
(c⁄° 
FixedLayout
 *
œyout
)

76 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

87 
	$gëP¨tôi⁄
(
FixedLayout
 *
œyout
, 
P¨tôi⁄ID
 
id
, 
P¨tôi⁄
 **
∑πôi⁄På
)

88 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

99 
	$å™¶©eToPBN
(c⁄° 
P¨tôi⁄
 *
∑πôi⁄
,

100 
PhysiˇlBlockNumbî
 
∑πôi⁄BlockNumbî
,

101 
PhysiˇlBlockNumbî
 *
œyîBlockNumbî
)

102 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

114 
	$å™¶©eFromPBN
(c⁄° 
P¨tôi⁄
 *
∑πôi⁄
,

115 
PhysiˇlBlockNumbî
 
œyîBlockNumbî
,

116 
PhysiˇlBlockNumbî
 *
∑πôi⁄BlockNumbî
)

117 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

126 
BlockCou¡
 
	$gëFixedLayoutBlocksAvaûabÀ
(c⁄° 
FixedLayout
 *
œyout
)

127 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

145 
	$makeFixedLayoutP¨tôi⁄
(
FixedLayout
 *
œyout
,

146 
P¨tôi⁄ID
 
id
,

147 
BlockCou¡
 
blockCou¡
,

148 
P¨tôi⁄Dúe˘i⁄
 
dúe˘i⁄
,

149 
PhysiˇlBlockNumbî
 
ba£
)

150 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

159 
BlockCou¡
 
	$gëFixedLayoutP¨tôi⁄Size
(c⁄° 
P¨tôi⁄
 *
∑πôi⁄
)

160 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

169 
PhysiˇlBlockNumbî
 
	$gëFixedLayoutP¨tôi⁄Off£t
(c⁄° 
P¨tôi⁄
 *
∑πôi⁄
)

170 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

180 
PhysiˇlBlockNumbî
 
	$gëFixedLayoutP¨tôi⁄Ba£
(c⁄° 
P¨tôi⁄
 *
∑πôi⁄
)

181 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

190 
size_t
 
	$gëFixedLayoutEncodedSize
(c⁄° 
FixedLayout
 *
œyout
)

191 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

201 
	$ícodeFixedLayout
(c⁄° 
FixedLayout
 *
œyout
, 
Buf„r
 *
buf„r
)

202 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

212 
	$decodeFixedLayout
(
Buf„r
 *
buf„r
, 
FixedLayout
 **
œyoutPå
)

213 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

	@vdo/base/flush.c

22 
	~"Êush.h
"

24 
	~"loggî.h
"

25 
	~"mem‹yAŒoc.h
"

27 
	~"blockAŒoˇt‹.h
"

28 
	~"com∂ëi⁄.h
"

29 
	~"logiˇlZ⁄e.h
"

30 
	~"numUtûs.h
"

31 
	~"¶abDïŸ.h
"

32 
	~"vdoI¡î«l.h
"

34 
	sÊushî
 {

35 
VDOCom∂ëi⁄
 
	mcom∂ëi⁄
;

37 
VDO
 *
	mvdo
;

39 
Sequí˚Numbî
 
	mÊushGíî©i⁄
;

41 
Sequí˚Numbî
 
	mfú°U«cknowÀdgedGíî©i⁄
;

43 
WaôQueue
 
	mnŸifõrs
;

45 
WaôQueue
 
	m≥ndögFlushes
;

47 
Sequí˚Numbî
 
	mnŸifyGíî©i⁄
;

49 
LogiˇlZ⁄e
 *
	mlogiˇlZ⁄eToNŸify
;

51 
ThªadID
 
	mthªadID
;

61 
Flushî
 *
	$asFlushî
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

63 
	`STATIC_ASSERT
(
	`off£tof
(
Flushî
, 
com∂ëi⁄
) == 0);

64 
	`as£πCom∂ëi⁄Ty≥
(
com∂ëi⁄
->
ty≥
, 
FLUSH_NOTIFICATION_COMPLETION
);

65  (
Flushî
 *Ë
com∂ëi⁄
;

66 
	}
}

75 
VDOFlush
 *
	$waôîAsFlush
(
Waôî
 *
waôî
)

77 
	`STATIC_ASSERT
(
	`off£tof
(
VDOFlush
, 
waôî
) == 0);

78  (
VDOFlush
 *Ë
waôî
;

79 
	}
}

82 
	$makeFlushî
(
VDO
 *
vdo
)

84 
ªsu…
 = 
	`ALLOCATE
(1, 
Flushî
, 
__func__
, &
vdo
->
Êushî
);

85 i‡(
ªsu…
 !
VDO_SUCCESS
) {

86  
ªsu…
;

89 
vdo
->
Êushî
->vdo = vdo;

90 
vdo
->
Êushî
->
thªadID
 = 
	`gëPackîZ⁄eThªad
(
	`gëThªadC⁄fig
(vdo));

91  
	`öôülizeEnqueuóbÀCom∂ëi⁄
(&
vdo
->
Êushî
->
com∂ëi⁄
,

92 
FLUSH_NOTIFICATION_COMPLETION
,

93 
vdo
->
œyî
);

94 
	}
}

97 
	$‰ìFlushî
(
Flushî
 **
ÊushîPå
)

99 i‡(*
ÊushîPå
 =
NULL
) {

103 
Flushî
 *
Êushî
 = *
ÊushîPå
;

104 
	`de°royEnqueuóbÀ
(&
Êushî
->
com∂ëi⁄
);

105 
	`FREE
(
Êushî
);

106 *
ÊushîPå
 = 
NULL
;

107 
	}
}

110 
ThªadID
 
	$gëFlushîThªadID
(
Flushî
 *
Êushî
)

112  
Êushî
->
thªadID
;

113 
	}
}

116 
nŸifyFlush
(
Flushî
 *
Êushî
);

126 
	$föishNŸifiˇti⁄
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

128 
Flushî
 *
Êushî
 = 
	`asFlushî
(
com∂ëi⁄
);

129 
	`ASSERT_LOG_ONLY
((
	`gëCÆlbackThªadID
(Ë=
Êushî
->
thªadID
),

132 
Waôî
 *
waôî
 = 
	`dequeueNextWaôî
(&
Êushî
->
nŸifõrs
);

133 
ªsu…
 = 
	`íqueueWaôî
(&
Êushî
->
≥ndögFlushes
, 
waôî
);

134 i‡(
ªsu…
 !
VDO_SUCCESS
) {

135 
	`íãrRódO∆yMode
(&
Êushî
->
vdo
->
ªadO∆yC⁄ãxt
, 
ªsu…
);

136 
VDOFlush
 *
Êush
 = 
	`waôîAsFlush
(
waôî
);

137 
com∂ëi⁄
->
œyî
->
	`com∂ëeFlush
(&
Êush
);

141 
	`com∂ëeFlushes
(
Êushî
);

142 i‡(
	`hasWaôîs
(&
Êushî
->
nŸifõrs
)) {

143 
	`nŸifyFlush
(
Êushî
);

145 
	}
}

154 
	$ÊushPackîCÆlback
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

156 
Flushî
 *
Êushî
 = 
	`asFlushî
(
com∂ëi⁄
);

157 
	`ö¸emítPackîFlushGíî©i⁄
(
Êushî
->
vdo
->
∑ckî
);

158 
	`œunchCÆlback
(
com∂ëi⁄
, 
föishNŸifiˇti⁄
, 
Êushî
->
thªadID
);

159 
	}
}

168 
	$ö¸emítGíî©i⁄
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

170 
Flushî
 *
Êushî
 = 
	`asFlushî
(
com∂ëi⁄
);

171 
	`ö¸emítFlushGíî©i⁄
(
Êushî
->
logiˇlZ⁄eToNŸify
,

172 
Êushî
->
nŸifyGíî©i⁄
);

173 
Êushî
->
logiˇlZ⁄eToNŸify


174 
	`gëNextLogiˇlZ⁄e
(
Êushî
->
logiˇlZ⁄eToNŸify
);

175 i‡(
Êushî
->
logiˇlZ⁄eToNŸify
 =
NULL
) {

176 
	`œunchCÆlback
(
com∂ëi⁄
, 
ÊushPackîCÆlback
, 
Êushî
->
thªadID
);

180 
	`œunchCÆlback
(
com∂ëi⁄
, 
ö¸emítGíî©i⁄
,

181 
	`gëLogiˇlZ⁄eThªadID
(
Êushî
->
logiˇlZ⁄eToNŸify
));

182 
	}
}

189 
	$nŸifyFlush
(
Flushî
 *
Êushî
)

191 
VDOFlush
 *
Êush
 = 
	`waôîAsFlush
(
	`gëFú°Waôî
(&
Êushî
->
nŸifõrs
));

192 
Êushî
->
nŸifyGíî©i⁄
 = 
Êush
->
ÊushGíî©i⁄
;

193 
Êushî
->
logiˇlZ⁄eToNŸify
 = flushî->
vdo
->
logiˇlZ⁄es
[0];

194 
Êushî
->
com∂ëi⁄
.
ªqueue
 = 
åue
;

195 
	`œunchCÆlback
(&
Êushî
->
com∂ëi⁄
, 
ö¸emítGíî©i⁄
,

196 
	`gëLogiˇlZ⁄eThªadID
(
Êushî
->
logiˇlZ⁄eToNŸify
));

197 
	}
}

200 
	$Êush
(
VDO
 *
vdo
, 
VDOFlush
 *
Êush
)

202 
Flushî
 *
Êushî
 = 
vdo
->flusher;

203 
	`ASSERT_LOG_ONLY
((
	`gëCÆlbackThªadID
(Ë=
Êushî
->
thªadID
),

206 
Êush
->
ÊushGíî©i⁄
 = 
Êushî
->flushGeneration++;

207 
boﬁ
 
mayNŸify
 = !
	`hasWaôîs
(&
Êushî
->
nŸifõrs
);

209 
ªsu…
 = 
	`íqueueWaôî
(&
Êushî
->
nŸifõrs
, &
Êush
->
waôî
);

210 i‡(
ªsu…
 !
VDO_SUCCESS
) {

211 
	`íãrRódO∆yMode
(&
vdo
->
ªadO∆yC⁄ãxt
, 
ªsu…
);

212 
Êushî
->
com∂ëi⁄
.
œyî
->
	`com∂ëeFlush
(&
Êush
);

216 i‡(
mayNŸify
) {

217 
	`nŸifyFlush
(
Êushî
);

219 
	}
}

222 
	$com∂ëeFlushes
(
Flushî
 *
Êushî
)

224 
	`ASSERT_LOG_ONLY
((
	`gëCÆlbackThªadID
(Ë=
Êushî
->
thªadID
),

227 
Sequí˚Numbî
 
ﬁde°A˘iveGíî©i⁄
 = 
UINT64_MAX
;

228 
LogiˇlZ⁄e
 *
z⁄e
 = 
Êushî
->
vdo
->
logiˇlZ⁄es
[0];

229 
z⁄e
 !
NULL
;

230 
z⁄e
 = 
	`gëNextLogiˇlZ⁄e
(zone)) {

231 
Sequí˚Numbî
 
ﬁde°InZ⁄e
 = 
	`gëOlde°LockedGíî©i⁄
(
z⁄e
);

232 
ﬁde°A˘iveGíî©i⁄
 = 
	`möSequí˚Numbî
(oldestActiveGeneration,

233 
ﬁde°InZ⁄e
);

236 
	`hasWaôîs
(&
Êushî
->
≥ndögFlushes
)) {

237 
VDOFlush
 *
Êush
 = 
	`waôîAsFlush
(
	`gëFú°Waôî
(&
Êushî
->
≥ndögFlushes
));

238 i‡(
Êush
->
ÊushGíî©i⁄
 >
ﬁde°A˘iveGíî©i⁄
) {

242 
	`ASSERT_LOG_ONLY
((
Êush
->
ÊushGíî©i⁄


243 =
Êushî
->
fú°U«cknowÀdgedGíî©i⁄
),

244 "acknowÀdgedÇexàex≥˘ed flush, %" 
PRIu64


245 ", was: %" 
PRIu64
,

246 
Êushî
->
fú°U«cknowÀdgedGíî©i⁄
,

247 
Êush
->
ÊushGíî©i⁄
);

248 
	`dequeueNextWaôî
(&
Êushî
->
≥ndögFlushes
);

249 
Êushî
->
com∂ëi⁄
.
œyî
->
	`com∂ëeFlush
(&
Êush
);

250 
Êushî
->
fú°U«cknowÀdgedGíî©i⁄
++;

252 
	}
}

255 
	$dumpFlushî
(c⁄° 
Flushî
 *
Êushî
)

257 
	`logInfo
("Flusher");

258 
	`logInfo
(" flushGíî©i⁄=%" 
PRIu64


259 " fú°U«cknowÀdgedGíî©i⁄=%" 
PRIu64
,

260 
Êushî
->
ÊushGíî©i⁄
, flushî->
fú°U«cknowÀdgedGíî©i⁄
);

261 
	`logInfo
("Çotifiers queue is %s;ÖendingFlushes queue is %s",

262 (
	`hasWaôîs
(&
Êushî
->
nŸifõrs
) ? "notÉmpty" : "empty"),

263 (
	`hasWaôîs
(&
Êushî
->
≥ndögFlushes
) ? "notÉmpty" : "empty"));

264 
	}
}

	@vdo/base/flush.h

22 #i‚de‡
FLUSH_H


23 
	#FLUSH_H


	)

25 
	~"ty≥s.h
"

26 
	~"waôQueue.h
"

31 
	svdoFlush
 {

33 
Waôî
 
	mwaôî
;

35 
Sequí˚Numbî
 
	mÊushGíî©i⁄
;

45 
	$makeFlushî
(
VDO
 *
vdo
)

46 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

53 
	`‰ìFlushî
(
Flushî
 **
ÊushîPå
);

62 
ThªadID
 
	$gëFlushîThªadID
(
Flushî
 *
Êushî
)

63 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

71 
	`Êush
(
VDO
 *
vdo
, 
VDOFlush
 *
vdoFlush
);

78 
	`com∂ëeFlushes
(
Flushî
 *
Êushî
);

85 
	`dumpFlushî
(c⁄° 
Flushî
 *
Êushî
);

	@vdo/base/forest.c

22 
	~"f‹e°.h
"

24 
	~"loggî.h
"

25 
	~"mem‹yAŒoc.h
"

27 
	~"blockM≠.h
"

28 
	~"blockM≠I¡î«ls.h
"

29 
	~"blockM≠Page.h
"

30 
	~"blockM≠Tªe.h
"

31 
	~"blockM≠TªeI¡î«ls.h
"

32 
	~"c⁄°™ts.h
"

33 
	~"d©aVIO.h
"

34 
	~"dútyLi°s.h
"

35 
	~"f‹e°.h
"

36 
	~"numUtûs.h
"

37 
	~"ªcovîyJou∫Æ.h
"

38 
	~"¶abDïŸ.h
"

39 
	~"¶abJou∫Æ.h
"

40 
	~"ty≥s.h
"

41 
	~"vdoI¡î«l.h
"

42 
	~"vioPoﬁ.h
"

45 
	mBLOCK_MAP_VIO_POOL_SIZE
 = 64,

48 
	sf‹e°
 {

49 
BlockM≠
 *
	mm≠
;

50 
size_t
 
	m£gmíts
;

51 
Bound¨y
 *
	mbound¨õs
;

52 
TªePage
 **
	m∑ges
;

53 
BlockM≠Tªe
 
	måìs
[];

57 
PageNumbî
 
	m∑geIndex
;

58 
SlŸNumbî
 
	m¶Ÿ
;

59 } 
	tCurs‹Levñ
;

61 
curs‹s
 
	tCurs‹s
;

64 
Waôî
 
	mwaôî
;

65 
BlockM≠Tªe
 *
	måì
;

66 
Height
 
	mheight
;

67 
Curs‹s
 *
	m∑ª¡
;

68 
Bound¨y
 
	mbound¨y
;

69 
Curs‹Levñ
 
	mÀvñs
[
BLOCK_MAP_TREE_HEIGHT
];

70 
VIOPoﬁE¡ry
 *
	mvioPoﬁE¡ry
;

71 } 
	tCurs‹
;

73 
	scurs‹s
 {

74 
BlockM≠
 *
	mm≠
;

75 
BlockM≠TªeZ⁄e
 *
	mz⁄e
;

76 
Obje˘Poﬁ
 *
	mpoﬁ
;

77 
E¡ryCÆlback
 *
	míåyCÆlback
;

78 
VDOCom∂ëi⁄
 *
	m∑ª¡
;

79 
RoŸCou¡
 
	ma˘iveRoŸs
;

80 
Curs‹
 
	mcurs‹s
[];

84 
BlockM≠Tªe
 *
	$gëTªeFromF‹e°
(
F‹e°
 *
f‹e°
, 
RoŸCou¡
 
ödex
)

86  &(
f‹e°
->
åìs
[
ödex
]);

87 
	}
}

90 
TªePage
 *
	$gëTªePageByIndex
(
F‹e°
 *
f‹e°
,

91 
BlockM≠Tªe
 *
åì
,

92 
Height
 
height
,

93 
PageNumbî
 
∑geIndex
)

95 
PageNumbî
 
off£t
 = 0;

96 
size_t
 
£gmít
 = 0; segmíà< 
f‹e°
->
£gmíts
; segment++) {

97 
PageNumbî
 
b‹dî
 = 
f‹e°
->
bound¨õs
[
£gmít
].
Àvñs
[
height
 - 1];

98 i‡(
∑geIndex
 < 
b‹dî
) {

99  &(
åì
->
£gmíts
[
£gmít
].
Àvñs
[
height
 - 1][
∑geIndex
 - 
off£t
]);

101 
off£t
 = 
b‹dî
;

104  
NULL
;

105 
	}
}

115 
PageCou¡
 
	$compuãLófPagesPîRoŸ
(
BlockM≠
 *
m≠
,

116 
BlockCou¡
 
logiˇlBlocks
)

118 
PageCou¡
 
ÀafPages


119 
	`compuãBlockM≠PageCou¡
(
logiˇlBlocks
Ë- 
m≠
->
Ê©PageCou¡
;

120 
ÀafPages
 = 
	`maxPageCou¡
(leafPages, 1);

121  
	`compuãBuckëCou¡
(
ÀafPages
, 
m≠
->
roŸCou¡
);

122 
	}
}

125 
BlockCou¡
 
	$compuãNewPages
(
BlockM≠
 *
m≠
,

126 
Bound¨y
 *
ﬁdSizes
,

127 
BlockCou¡
 
íåõs
,

128 
Bound¨y
 *
√wSizes
)

130 
PageCou¡
 
ÀvñSize
 = 
	`compuãLófPagesPîRoŸ
(
m≠
, 
íåõs
);

131 
BlockCou¡
 
tŸÆPages
 = 0;

132 
Height
 
height
 = 0; heighà< 
BLOCK_MAP_TREE_HEIGHT
; height++) {

133 
ÀvñSize
 = 
	`compuãBuckëCou¡
÷evñSize, 
BLOCK_MAP_ENTRIES_PER_PAGE
);

134 
√wSizes
->
Àvñs
[
height
] = 
ÀvñSize
;

135 
BlockCou¡
 
√wPages
 = 
ÀvñSize
;

136 i‡(
ﬁdSizes
 !
NULL
) {

137 
√wPages
 -
ﬁdSizes
->
Àvñs
[
height
];

139 
tŸÆPages
 +(
√wPages
 * 
m≠
->
roŸCou¡
);

142  
tŸÆPages
;

143 
	}
}

146 
	$makeSegmít
(
F‹e°
 *
ﬁdF‹e°
,

147 
BlockCou¡
 
√wPages
,

148 
Bound¨y
 *
√wBound¨y
,

149 
F‹e°
 *
f‹e°
)

151 
size_t
 
ödex
 = (
ﬁdF‹e°
 =
NULL
Ë? 0 : oldF‹e°->
£gmíts
;

152 
f‹e°
->
£gmíts
 = 
ödex
 + 1;

154 
ªsu…
 = 
	`ALLOCATE
(
f‹e°
->
£gmíts
, 
Bound¨y
, "forest boundaryárray",

155 &
f‹e°
->
bound¨õs
);

156 i‡(
ªsu…
 !
VDO_SUCCESS
) {

157  
ªsu…
;

160 
ªsu…
 = 
	`ALLOCATE
(
f‹e°
->
£gmíts
, 
TªePage
 *, "forestÖageÖointers",

161 &
f‹e°
->
∑ges
);

162 i‡(
ªsu…
 !
VDO_SUCCESS
) {

163  
ªsu…
;

166 
ªsu…
 = 
	`ALLOCATE
(
√wPages
, 
TªePage
, "new forestÖages",

167 &
f‹e°
->
∑ges
[
ödex
]);

168 i‡(
ªsu…
 !
VDO_SUCCESS
) {

169  
ªsu…
;

172 i‡(
ödex
 > 0) {

173 
	`mem˝y
(
f‹e°
->
bound¨õs
, 
ﬁdF‹e°
->boundaries,

174 
ödex
 * (
Bound¨y
));

175 
	`mem˝y
(
f‹e°
->
∑ges
, 
ﬁdF‹e°
->∑ges, 
ödex
 * (
TªePage
 *));

178 
	`mem˝y
(&(
f‹e°
->
bound¨õs
[
ödex
]), 
√wBound¨y
, (
Bound¨y
));

180 
PageCou¡
 
£gmítSizes
[
BLOCK_MAP_TREE_HEIGHT
];

181 
Height
 
height
 = 0; heighà< 
BLOCK_MAP_TREE_HEIGHT
; height++) {

182 
£gmítSizes
[
height
] = 
√wBound¨y
->
Àvñs
[height];

183 i‡(
ödex
 > 0) {

184 
£gmítSizes
[
height
] -
ﬁdF‹e°
->
bound¨õs
[
ödex
 - 1].
Àvñs
[height];

188 
TªePage
 *
∑gePå
 = 
f‹e°
->
∑ges
[
ödex
];

189 
RoŸCou¡
 
roŸ
 = 0;ÑoŸ < 
f‹e°
->
m≠
->
roŸCou¡
;Ñoot++) {

190 
BlockM≠Tªe
 *
åì
 = &(
f‹e°
->
åìs
[
roŸ
]);

191 
ªsu…
 = 
	`ALLOCATE
(
f‹e°
->
£gmíts
, 
BlockM≠TªeSegmít
,

192 "åìÑoŸ segmíts", &
åì
->
£gmíts
);

193 i‡(
ªsu…
 !
VDO_SUCCESS
) {

194  
ªsu…
;

197 i‡(
ödex
 > 0) {

198 
	`mem˝y
(
åì
->
£gmíts
, 
ﬁdF‹e°
->
åìs
[
roŸ
].segments,

199 
ödex
 * (
BlockM≠TªeSegmít
));

202 
BlockM≠TªeSegmít
 *
£gmít
 = &(
åì
->
£gmíts
[
ödex
]);

203 
Height
 
height
 = 0; heighà< 
BLOCK_MAP_TREE_HEIGHT
; height++) {

204 i‡(
£gmítSizes
[
height
] == 0) {

208 
£gmít
->
Àvñs
[
height
] = 
∑gePå
;

209 i‡(
height
 =(
BLOCK_MAP_TREE_HEIGHT
 - 1)) {

211 
	`f‹m©BlockM≠Page
(
∑gePå
->
∑geBuf„r
, 
f‹e°
->
m≠
->
n⁄˚
,

212 
INVALID_PBN
);

213 
BlockM≠Page
 *
∑ge
 = (BlockM≠Pagê*Ë
∑gePå
->
∑geBuf„r
;

214 
	`ícodeBlockM≠E¡ry
(
∑ge
, 0, 
f‹e°
->
m≠
->
roŸOrigö
 + 
roŸ
,

215 
MAPPING_STATE_UNCOMPRESSED
);

216 
∑ge
->
hódî
.
öôülized
 = 
åue
;

218 
∑gePå
 +
£gmítSizes
[
height
];

222  
VDO_SUCCESS
;

223 
	}
}

226 
	$def‹e°
(
F‹e°
 *
f‹e°
, 
size_t
 
fú°PageSegmít
)

228 i‡(
f‹e°
->
∑ges
 !
NULL
) {

229 
size_t
 
£gmít
 = 
fú°PageSegmít
; segmíà< 
f‹e°
->
£gmíts
;

230 
£gmít
++) {

231 
	`FREE
(
f‹e°
->
∑ges
[
£gmít
]);

233 
	`FREE
(
f‹e°
->
∑ges
);

236 
RoŸCou¡
 
roŸ
 = 0;ÑoŸ < 
f‹e°
->
m≠
->
roŸCou¡
;Ñoot++) {

237 
BlockM≠Tªe
 *
åì
 = &(
f‹e°
->
åìs
[
roŸ
]);

238 
	`FREE
(
åì
->
£gmíts
);

241 
	`FREE
(
f‹e°
->
bound¨õs
);

242 
	`FREE
(
f‹e°
);

243 
	}
}

246 
	$makeF‹e°
(
BlockM≠
 *
m≠
, 
BlockCou¡
 
íåõs
)

248 
	`STATIC_ASSERT
(
	`off£tof
(
TªePage
, 
waôî
) == 0);

250 
F‹e°
 *
ﬁdF‹e°
 = 
m≠
->
f‹e°
;

251 
Bound¨y
 *
ﬁdBound¨y
 = 
NULL
;

252 i‡(
ﬁdF‹e°
 !
NULL
) {

253 
ﬁdBound¨y
 = &(
ﬁdF‹e°
->
bound¨õs
[ﬁdF‹e°->
£gmíts
 - 1]);

256 
Bound¨y
 
√wBound¨y
;

257 
BlockCou¡
 
√wPages
 = 
	`compuãNewPages
(
m≠
, 
ﬁdBound¨y
, 
íåõs
,

258 &
√wBound¨y
);

259 i‡(
√wPages
 == 0) {

260 
m≠
->
√xtE¡ryCou¡
 = 
íåõs
;

261  
VDO_SUCCESS
;

264 
F‹e°
 *
f‹e°
;

265 
ªsu…
 = 
	`ALLOCATE_EXTENDED
(
F‹e°
, 
m≠
->
roŸCou¡
, 
BlockM≠Tªe
,

266 
__func__
, &
f‹e°
);

267 i‡(
ªsu…
 !
VDO_SUCCESS
) {

268  
ªsu…
;

271 
f‹e°
->
m≠
 = map;

272 
ªsu…
 = 
	`makeSegmít
(
ﬁdF‹e°
, 
√wPages
, &
√wBound¨y
, 
f‹e°
);

273 i‡(
ªsu…
 !
VDO_SUCCESS
) {

274 
	`def‹e°
(
f‹e°
, f‹e°->
£gmíts
 - 1);

275  
ªsu…
;

278 
m≠
->
√xtF‹e°
 = 
f‹e°
;

279 
m≠
->
√xtE¡ryCou¡
 = 
íåõs
;

280  
VDO_SUCCESS
;

281 
	}
}

284 
	$‰ìF‹e°
(
F‹e°
 **
f‹e°På
)

286 
F‹e°
 *
f‹e°
 = *
f‹e°På
;

287 i‡(
f‹e°
 =
NULL
) {

291 
	`def‹e°
(
f‹e°
, 0);

292 *
f‹e°På
 = 
NULL
;

293 
	}
}

296 
	$ab™d⁄F‹e°
(
BlockM≠
 *
m≠
)

298 
F‹e°
 *
f‹e°
 = 
m≠
->
√xtF‹e°
;

299 
m≠
->
√xtF‹e°
 = 
NULL
;

300 i‡(
f‹e°
 !
NULL
) {

301 
	`def‹e°
(
f‹e°
, f‹e°->
£gmíts
 - 1);

304 
m≠
->
√xtE¡ryCou¡
 = 0;

305 
	}
}

308 
	$ª∂a˚F‹e°
(
BlockM≠
 *
m≠
)

310 
F‹e°
 *
ﬁdF‹e°
 = 
m≠
->
f‹e°
;

311 
m≠
->
f‹e°
 = m≠->
√xtF‹e°
;

312 
m≠
->
√xtF‹e°
 = 
NULL
;

313 
m≠
->
íåyCou¡
 = m≠->
√xtE¡ryCou¡
;

314 
m≠
->
√xtE¡ryCou¡
 = 0;

316 i‡(
ﬁdF‹e°
 !
NULL
) {

317 
	`def‹e°
(
ﬁdF‹e°
, oldF‹e°->
£gmíts
);

319 
	}
}

327 
	$föishCurs‹
(
Curs‹
 *
curs‹
)

329 
Curs‹s
 *
curs‹s
 = 
curs‹
->
∑ª¡
;

330 
	`ªtu∫VIOToPoﬁ
(
curs‹s
->
poﬁ
, 
curs‹
->
vioPoﬁE¡ry
);

331 i‡(--
curs‹s
->
a˘iveRoŸs
 > 0) {

335 
VDOCom∂ëi⁄
 *
∑ª¡
 = 
curs‹s
->parent;

336 
	`FREE
(
curs‹s
);

338 
	`föishCom∂ëi⁄
(
∑ª¡
, 
VDO_SUCCESS
);

339 
	}
}

342 
åavî£
(
Curs‹
 *
curs‹
);

349 
	$c⁄töueTøvîßl
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

351 
VIOPoﬁE¡ry
 *
poﬁE¡ry
 = 
com∂ëi⁄
->
∑ª¡
;

352 
Curs‹
 *
curs‹
 = 
poﬁE¡ry
->
∑ª¡
;

353 
	`åavî£
(
curs‹
);

354 
	}
}

361 
	$föishTøvîßlLﬂd
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

363 
VIOPoﬁE¡ry
 *
íåy
 = 
com∂ëi⁄
->
∑ª¡
;

364 
Curs‹
 *
curs‹
 = 
íåy
->
∑ª¡
;

365 
Height
 
height
 = 
curs‹
->height;

366 
Curs‹Levñ
 *
Àvñ
 = &
curs‹
->
Àvñs
[
height
];

368 
TªePage
 *
åìPage


369 &(
curs‹
->
åì
->
£gmíts
[0].
Àvñs
[
height
][
Àvñ
->
∑geIndex
]);

370 
BlockM≠Page
 *
∑ge
 = (BlockM≠Pagê*Ë
åìPage
->
∑geBuf„r
;

371 
	`c›yVÆidPage
(
íåy
->
buf„r
, 
curs‹
->
∑ª¡
->
m≠
->
n⁄˚
,

372 
íåy
->
vio
->
physiˇl
, 
∑ge
);

373 
	`åavî£
(
curs‹
);

374 
	}
}

382 
	$åavî£
(
Curs‹
 *
curs‹
)

384 ; 
curs‹
->
height
 < 
BLOCK_MAP_TREE_HEIGHT
; cursor->height++) {

385 
Height
 
height
 = 
curs‹
->height;

386 
Curs‹Levñ
 *
Àvñ
 = &
curs‹
->
Àvñs
[
height
];

387 
TªePage
 *
åìPage


388 &(
curs‹
->
åì
->
£gmíts
[0].
Àvñs
[
height
][
Àvñ
->
∑geIndex
]);

389 
BlockM≠Page
 *
∑ge
 = (BlockM≠Pagê*Ë
åìPage
->
∑geBuf„r
;

390 i‡(!
∑ge
->
hódî
.
öôülized
) {

394 ; 
Àvñ
->
¶Ÿ
 < 
BLOCK_MAP_ENTRIES_PER_PAGE
;Üevel->slot++) {

395 c⁄° 
BlockM≠E¡ry
 *
íåy
 = &
∑ge
->
íåõs
[
Àvñ
->
¶Ÿ
];

396 i‡(
	`isInvÆid
(
íåy
)) {

398 
	`ícodeBlockM≠E¡ry
(
∑ge
, 
Àvñ
->
¶Ÿ
, 
ZERO_BLOCK
,

399 
MAPPING_STATE_UNMAPPED
);

400 
	`wrôeTªePage
(
åìPage
, 
curs‹
->
∑ª¡
->
z⁄e
);

404 i‡(
	`isUnm≠≥d
(
íåy
)) {

408 
PageNumbî
 
íåyIndex


409 (
BLOCK_MAP_ENTRIES_PER_PAGE
 * 
Àvñ
->
∑geIndex
Ë+Üevñ->
¶Ÿ
;

412 i‡(
íåyIndex
 >
curs‹
->
bound¨y
.
Àvñs
[
height
]) {

413 
	`ícodeBlockM≠E¡ry
(
∑ge
, 
Àvñ
->
¶Ÿ
, 
ZERO_BLOCK
,

414 
MAPPING_STATE_UNMAPPED
);

415 
	`wrôeTªePage
(
åìPage
, 
curs‹
->
∑ª¡
->
z⁄e
);

419 
PhysiˇlBlockNumbî
 
pbn
 = 
	`u≈ackPBN
(
íåy
);

420 i‡(
curs‹
->
height
 < 
BLOCK_MAP_TREE_HEIGHT
 - 1) {

421 
ªsu…
 = 
curs‹
->
∑ª¡
->
	`íåyCÆlback
(
pbn
,

422 
curs‹
->
∑ª¡
->parent);

423 i‡(
ªsu…
 !
VDO_SUCCESS
) {

424 
	`ícodeBlockM≠E¡ry
(
∑ge
, 
Àvñ
->
¶Ÿ
, 
ZERO_BLOCK
,

425 
MAPPING_STATE_UNMAPPED
);

426 
	`wrôeTªePage
(
åìPage
, 
curs‹
->
∑ª¡
->
z⁄e
);

431 i‡(
curs‹
->
height
 == 0) {

435 
curs‹
->
height
--;

436 
Curs‹Levñ
 *
√xtLevñ
 = &
curs‹
->
Àvñs
[curs‹->
height
];

437 
√xtLevñ
->
∑geIndex
 = 
íåyIndex
;

438 
√xtLevñ
->
¶Ÿ
 = 0;

439 
Àvñ
->
¶Ÿ
++;

440 
	`œunchRódMëad©aVIO
(
curs‹
->
vioPoﬁE¡ry
->
vio
, 
pbn
,

441 
föishTøvîßlLﬂd
, 
c⁄töueTøvîßl
);

446 
	`föishCurs‹
(
curs‹
);

447 
	}
}

458 
	$œunchCurs‹
(
Waôî
 *
waôî
, *
c⁄ãxt
)

460 
	`STATIC_ASSERT
(
	`off£tof
(
Curs‹
, 
waôî
) == 0);

461 
Curs‹
 *
curs‹
 = (Curs‹ *Ë
waôî
;

462 
curs‹
->
vioPoﬁE¡ry
 = (
VIOPoﬁE¡ry
 *Ë
c⁄ãxt
;

463 
curs‹
->
vioPoﬁE¡ry
->
∑ª¡
 = cursor;

464 
	`vioAsCom∂ëi⁄
(
curs‹
->
vioPoﬁE¡ry
->
vio
)->
ˇŒbackThªadID


465 
curs‹
->
∑ª¡
->
z⁄e
->
m≠Z⁄e
->
thªadID
;

466 
	`åavî£
(
curs‹
);

467 
	}
}

477 
Bound¨y
 
	$compuãBound¨y
(
BlockM≠
 *
m≠
, 
RoŸCou¡
 
roŸIndex
)

479 
PageCou¡
 
ÀafPages
 = 
	`compuãBlockM≠PageCou¡
(
m≠
->
íåyCou¡
);

480 
PageCou¡
 
åìLófPages
 = 
ÀafPages
 - 
m≠
->
Ê©PageCou¡
;

487 
PageCou¡
 
fú°TªeRoŸ
 = 
m≠
->
Ê©PageCou¡
 % m≠->
roŸCou¡
;

488 
PageCou¡
 
œ°TªeRoŸ
 = (
ÀafPages
 - 1Ë% 
m≠
->
roŸCou¡
;

490 
PageCou¡
 
ÀvñPages
 = 
åìLófPages
 / 
m≠
->
roŸCou¡
;

491 i‡(
	`öCy˛icR™ge
(
fú°TªeRoŸ
, 
roŸIndex
, 
œ°TªeRoŸ
, 
m≠
->
roŸCou¡
)) {

492 
ÀvñPages
++;

495 
Bound¨y
 
bound¨y
;

496 
Height
 
height
 = 0; heighà< 
BLOCK_MAP_TREE_HEIGHT
 - 1; height++) {

497 
bound¨y
.
Àvñs
[
height
] = 
ÀvñPages
;

498 
ÀvñPages
 = 
	`compuãBuckëCou¡
÷evñPages, 
BLOCK_MAP_ENTRIES_PER_PAGE
);

502 
bound¨y
.
Àvñs
[
BLOCK_MAP_TREE_HEIGHT
 - 1] = 1;

504  
bound¨y
;

505 
	}
}

508 
	$åavî£F‹e°
(
BlockM≠
 *
m≠
,

509 
E¡ryCÆlback
 *
íåyCÆlback
,

510 
VDOCom∂ëi⁄
 *
∑ª¡
)

512 i‡(
	`compuãBlockM≠PageCou¡
(
m≠
->
íåyCou¡
Ë<m≠->
Ê©PageCou¡
) {

514 
	`föishCom∂ëi⁄
(
∑ª¡
, 
VDO_SUCCESS
);

518 
Curs‹s
 *
curs‹s
;

519 
ªsu…
 = 
	`ALLOCATE_EXTENDED
(
Curs‹s
, 
m≠
->
roŸCou¡
, 
Curs‹
, 
__func__
,

520 &
curs‹s
);

521 i‡(
ªsu…
 !
VDO_SUCCESS
) {

522 
	`föishCom∂ëi⁄
(
∑ª¡
, 
ªsu…
);

526 
curs‹s
->
m≠
 = map;

527 
curs‹s
->
z⁄e
 = &(
	`gëBlockM≠Z⁄e
(
m≠
, 0)->
åìZ⁄e
);

528 
curs‹s
->
poﬁ
 = curs‹s->
z⁄e
->
vioPoﬁ
;

529 
curs‹s
->
íåyCÆlback
 =ÉntryCallback;

530 
curs‹s
->
∑ª¡
 =Öarent;

531 
curs‹s
->
a˘iveRoŸs
 = 
m≠
->
roŸCou¡
;

532 
RoŸCou¡
 
roŸ
 = 0;ÑoŸ < 
m≠
->
roŸCou¡
;Ñoot++) {

533 
Curs‹
 *
curs‹
 = &
curs‹s
->curs‹s[
roŸ
];

534 *
curs‹
 = (
Curs‹
) {

535 .
åì
 = &
m≠
->
f‹e°
->
åìs
[
roŸ
],

536 .
height
 = 
BLOCK_MAP_TREE_HEIGHT
 - 1,

537 .
∑ª¡
 = 
curs‹s
,

538 .
bound¨y
 = 
	`compuãBound¨y
(
m≠
, 
roŸ
),

541 
curs‹
->
waôî
.
ˇŒback
 = 
œunchCurs‹
;

542 
	`acquúeVIOFromPoﬁ
(
curs‹s
->
poﬁ
, &
curs‹
->
waôî
);

544 
	}
}

	@vdo/base/forest.h

22 #i‚de‡
FOREST_H


23 
	#FOREST_H


	)

25 
	~"blockM≠Tªe.h
"

26 
	~"ty≥s.h
"

36 
	tE¡ryCÆlback
(
	tPhysiˇlBlockNumbî
 
	tpbn
, 
	tVDOCom∂ëi⁄
 *
	tcom∂ëi⁄
);

46 
BlockM≠Tªe
 *
	$gëTªeFromF‹e°
(
F‹e°
 *
f‹e°
, 
RoŸCou¡
 
ödex
)

47 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

59 
TªePage
 *
	$gëTªePageByIndex
(
F‹e°
 *
f‹e°
,

60 
BlockM≠Tªe
 *
åì
,

61 
Height
 
height
,

62 
PageNumbî
 
∑geIndex
)

63 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

74 
	$makeF‹e°
(
BlockM≠
 *
m≠
, 
BlockCou¡
 
íåõs
)

75 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

83 
	`‰ìF‹e°
(
F‹e°
 **
f‹e°På
);

90 
	`ab™d⁄F‹e°
(
BlockM≠
 *
m≠
);

97 
	`ª∂a˚F‹e°
(
BlockM≠
 *
m≠
);

108 
	`åavî£F‹e°
(
BlockM≠
 *
m≠
,

109 
E¡ryCÆlback
 *
íåyCÆlback
,

110 
VDOCom∂ëi⁄
 *
∑ª¡
);

	@vdo/base/hashLock.c

37 
	~"hashLock.h
"

38 
	~"hashLockI¡î«ls.h
"

40 
	~"≥rmas£π.h
"

42 
	~"com¥essi⁄Sèã.h
"

43 
	~"c⁄°™ts.h
"

44 
	~"d©aVIO.h
"

45 
	~"hashZ⁄e.h
"

46 
	~"∑ckî.h
"

47 
	~"rögNode.h
"

48 
	~"ty≥s.h
"

49 
	~"vioWrôe.h
"

50 
	~"waôQueue.h
"

52 c⁄° *
	gLOCK_STATE_NAMES
[] = {

53 [
HASH_LOCK_BYPASSING
] = "BYPASSING",

54 [
HASH_LOCK_DEDUPING
] = "DEDUPING",

55 [
HASH_LOCK_DESTROYING
] = "DESTROYING",

56 [
HASH_LOCK_INITIALIZING
] = "INITIALIZING",

57 [
HASH_LOCK_LOCKING
] = "LOCKING",

58 [
HASH_LOCK_QUERYING
] = "QUERYING",

59 [
HASH_LOCK_UNLOCKING
] = "UNLOCKING",

60 [
HASH_LOCK_UPDATING
] = "UPDATING",

61 [
HASH_LOCK_VERIFYING
] = "VERIFYING",

62 [
HASH_LOCK_WRITING
] = "WRITING",

66 
PBNLock
 *
	$gëDu∂iˇãLock
(
D©aVIO
 *
d©aVIO
)

68 i‡(
d©aVIO
->
du∂iˇãLock
 !
NULL
) {

69  
d©aVIO
->
du∂iˇãLock
;

71 i‡(
d©aVIO
->
hashLock
 =
NULL
) {

72  
NULL
;

75  
NULL
;

76 
	}
}

79 c⁄° *
	$gëHashLockSèãName
(
HashLockSèã
 
°©e
)

82 
	`STATIC_ASSERT
((
HASH_LOCK_DESTROYING
 + 1Ë=
	`COUNT_OF
(
LOCK_STATE_NAMES
));

83  (
°©e
 < 
	`COUNT_OF
(
LOCK_STATE_NAMES
)Ë? LOCK_STATE_NAMES[°©e] : 
NULL
;

84 
	}
}

93 
	$as£πHashLockSèã
(
HashLock
 *
lock
,

94 
HashLockSèã
 
ex≥˘edSèã
,

95 c⁄° *
whîe
)

97 
	`ASSERT_LOG_ONLY
(
lock
->
°©e
 =
ex≥˘edSèã
,

99 
	`gëHashLockSèãName
(
ex≥˘edSèã
), 
whîe
);

100 
	}
}

108 
	$£tHashLockSèã
(
HashLock
 *
lock
, 
HashLockSèã
 
√wSèã
)

110 
lock
->
°©e
 = 
√wSèã
;

111 
	}
}

120 
	$as£πHashLockAgít
(
D©aVIO
 *
d©aVIO
, c⁄° *
whîe
)

123 
	`as£πInHashZ⁄e
(
d©aVIO
);

124 
	`ASSERT_LOG_ONLY
(
d©aVIO
 =d©aVIO->
hashLock
->
agít
,

125 "%†mu° bêf‹ÅhêhashÜockágít", 
whîe
);

126 
	}
}

134 
	$£tAgít
(
HashLock
 *
lock
, 
D©aVIO
 *
√wAgít
)

136 
lock
->
agít
 = 
√wAgít
;

137 
	}
}

147 
ölöe
 
D©aVIO
 *
	$d©aVIOFromLockNode
(
RögNode
 *
lockNode
)

149  (
D©aVIO
 *Ë((
byã
 *Ë
lockNode
 - 
	`off£tof
(D©aVIO, 
hashLockNode
));

150 
	}
}

160 
ölöe
 
D©aVIO
 *
	$dequeueLockWaôî
(
HashLock
 *
lock
)

162  
	`waôîAsD©aVIO
(
	`dequeueNextWaôî
(&
lock
->
waôîs
));

163 
	}
}

173 
	$c⁄töueD©aVIOIn
(
D©aVIO
 *
d©aVIO
,

174 
ªsu…
,

175 
VDOA˘i⁄
 *
ˇŒback
)

177 
	`d©aVIOAsCom∂ëi⁄
(
d©aVIO
)->
ˇŒback
 = callback;

178 
	`c⁄töueD©aVIO
(
d©aVIO
, 
ªsu…
);

179 
	}
}

187 
	$exôHashLock
(
D©aVIO
 *
d©aVIO
)

192 
	`ªÀa£HashLock
(
d©aVIO
);

209 
	`föishD©aVIO
(
d©aVIO
, 
VDO_SUCCESS
);

210 
	}
}

218 
	$waôOnHashLock
(
HashLock
 *
lock
, 
D©aVIO
 *
d©aVIO
)

220 
ªsu…
 = 
	`íqueueD©aVIO
(&
lock
->
waôîs
, 
d©aVIO
, 
	`THIS_LOCATION
(
NULL
));

221 i‡(
ªsu…
 !
VDO_SUCCESS
) {

224 
	`c⁄töueD©aVIOIn
(
d©aVIO
, 
ªsu…
, 
vîifyAdvi˚
);

230 i‡((
lock
->
°©e
 =
HASH_LOCK_WRITING
Ë&& 
	`ˇn˚lCom¥essi⁄
÷ock->
agít
)) {

238 
d©aVIO
->
com¥essi⁄
.
lockHﬁdî
 = 
lock
->
agít
;

239 
	`œunchPackîCÆlback
(
d©aVIO
, 
ªmoveLockHﬁdîFromPackî
,

240 
	`THIS_LOCATION
("$F;cb=removeLockHolderFromPacker"));

242 
	}
}

252 
	$ªqueueAdvi˚Waôî
(
Waôî
 *
waôî
, *
c⁄ãxt
)

254 
D©aVIO
 *
d©aVIO
 = 
	`waôîAsD©aVIO
(
waôî
);

255 
Z⁄edPBN
 *
du∂iˇã
 = 
c⁄ãxt
;

256 
	`£tDu∂iˇãLoˇti⁄
(
d©aVIO
, *
du∂iˇã
);

258 
VDOCom∂ëi⁄
 *
com∂ëi⁄
 = 
	`d©aVIOAsCom∂ëi⁄
(
d©aVIO
);

259 
com∂ëi⁄
->
ªqueue
 = 
åue
;

260 
com∂ëi⁄
->
ˇŒback
 = 
vîifyAdvi˚
;

261 
	`övokeCÆlback
(
com∂ëi⁄
);

262 
	}
}

272 
	$°¨tBy∑ssög
(
HashLock
 *
lock
, 
D©aVIO
 *
agít
)

276 
	`£tHashLockSèã
(
lock
, 
HASH_LOCK_BYPASSING
);

277 
	`£tAgít
(
lock
, 
NULL
);

279 i‡(!
	`hasWaôîs
(&
lock
->
waôîs
)) {

280 i‡(
agít
 =
NULL
) {

285 
	`c⁄töueD©aVIOIn
(
agít
, 
VDO_SUCCESS
, 
vîifyAdvi˚
);

289 
	`ASSERT_LOG_ONLY
(
agít
 !
NULL
, "can't have waiters butÇoágent");

293 
Z⁄edPBN
 
du∂iˇã


294 (
agít
->
isDu∂iˇã
 ?ágít->
du∂iˇã
 :ágít->
√wM≠≥d
);

295 
	`c⁄töueD©aVIOIn
(
agít
, 
VDO_SUCCESS
, 
vîifyAdvi˚
);

296 
	`nŸifyAŒWaôîs
(&
lock
->
waôîs
, 
ªqueueAdvi˚Waôî
, &
du∂iˇã
);

297 
	}
}

306 
	$ab‹tHashLock
(
HashLock
 *
lock
, 
D©aVIO
 *
d©aVIO
)

308 i‡(
d©aVIO
 =
lock
->
agít
) {

314 
	`°¨tBy∑ssög
(
lock
, 
d©aVIO
);

320 
	`exôHashLock
(
d©aVIO
);

321 
	}
}

324 
	$c⁄töueHashLockOnEº‹
(
D©aVIO
 *
d©aVIO
)

327 
	`ab‹tHashLock
(
d©aVIO
->
hashLock
, dataVIO);

328 
	}
}

344 
	$föishWrôög
(
HashLock
 *
lock
, 
D©aVIO
 *
agít
)

346 
D©aVIO
 *
√wAgít
 = 
	`waôîAsD©aVIO
(
	`dequeueNextWaôî
(&
lock
->
waôîs
));

347 i‡(
√wAgít
 !
NULL
) {

348 
	`£tAgít
(
lock
, 
√wAgít
);

351 
	`£tDu∂iˇãLoˇti⁄
(
√wAgít
, 
agít
->
√wM≠≥d
);

353 
	`°¨tBy∑ssög
(
lock
, 
√wAgít
);

359 
	`°¨tBy∑ssög
(
lock
, 
NULL
);

364 
	`exôHashLock
(
agít
);

365 
	}
}

374 
D©aVIO
 *
	$£À˘WrôögAgít
(
HashLock
 *
lock
)

376 
WaôQueue
 
ãmpQueue
;

377 
	`öôülizeWaôQueue
(&
ãmpQueue
);

381 
D©aVIO
 *
d©aVIO
;

382 ((
d©aVIO
 = 
	`dequeueLockWaôî
(
lock
)Ë!
NULL
)

383 && !
	`hasAŒoˇti⁄
(
d©aVIO
)) {

385 
ªsu…
 = 
	`íqueueWaôî
(&
ãmpQueue
, 
	`d©aVIOAsWaôî
(
d©aVIO
));

389 
	`ASSERT_LOG_ONLY
(
ªsu…
 =
VDO_SUCCESS
, "impossibleÉnqueueWaiterÉrror");

392 i‡(
d©aVIO
 !
NULL
) {

395 
	`å™s„rAŒWaôîs
(&
lock
->
waôîs
, &
ãmpQueue
);

399 
ªsu…
 = 
	`íqueueD©aVIO
(&
lock
->
waôîs
,Üock->
agít
,

400 
	`THIS_LOCATION
(
NULL
));

401 
	`ASSERT_LOG_ONLY
(
ªsu…
 =
VDO_SUCCESS
, "impossibleÉnqueueDataVIOÉrror");

402 
	`£tAgít
(
lock
, 
d©aVIO
);

405 
d©aVIO
 = 
lock
->
agít
;

409 
	`å™s„rAŒWaôîs
(&
ãmpQueue
, &
lock
->
waôîs
);

410  
d©aVIO
;

411 
	}
}

421 
	$°¨tWrôög
(
HashLock
 *
lock
, 
D©aVIO
 *
agít
)

423 
	`£tHashLockSèã
(
lock
, 
HASH_LOCK_WRITING
);

427 i‡(!
	`hasAŒoˇti⁄
(
agít
)) {

428 
agít
 = 
	`£À˘WrôögAgít
(
lock
);

430 i‡(!
	`hasAŒoˇti⁄
(
agít
)) {

438 
	`°¨tBy∑ssög
(
lock
, 
agít
);

445 i‡(
	`hasWaôîs
(&
lock
->
waôîs
)) {

447 
	`ˇn˚lCom¥essi⁄
(
agít
);

456 
	`com¥essD©a
(
agít
);

457 
	}
}

465 
	$föishQuîyög
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

467 
D©aVIO
 *
agít
 = 
	`asD©aVIO
(
com∂ëi⁄
);

468 
	`as£πHashLockAgít
(
agít
, 
__func__
);

469 
HashLock
 *
lock
 = 
agít
->
hashLock
;

471 i‡(
com∂ëi⁄
->
ªsu…
 !
VDO_SUCCESS
) {

472 
	`ab‹tHashLock
(
lock
, 
agít
);

476 i‡(
agít
->
isDu∂iˇã
) {

483 
	`°¨tBy∑ssög
(
lock
, 
agít
);

489 
	`°¨tWrôög
(
lock
, 
agít
);

491 
	}
}

502 
	$°¨tQuîyög
(
HashLock
 *
lock
, 
D©aVIO
 *
d©aVIO
)

504 
	`£tAgít
(
lock
, 
d©aVIO
);

505 
	`£tHashLockSèã
(
lock
, 
HASH_LOCK_QUERYING
);

507 
VDOCom∂ëi⁄
 *
com∂ëi⁄
 = 
	`d©aVIOAsCom∂ëi⁄
(
d©aVIO
);

508 
d©aVIO
->
œ°AsyncO≥øti⁄
 = 
CHECK_FOR_DEDUPLICATION
;

509 
	`£tHashZ⁄eCÆlback
(
d©aVIO
, 
föishQuîyög
, 
	`THIS_LOCATION
(
NULL
));

510 
com∂ëi⁄
->
œyî
->
	`checkF‹Du∂iˇti⁄
(
d©aVIO
);

511 
	}
}

519 
	$œunchOldDedu≥
(
D©aVIO
 *
d©aVIO
)

521 
VDOCom∂ëi⁄
 *
com∂ëi⁄
 = 
	`d©aVIOAsCom∂ëi⁄
(
d©aVIO
);

522 
d©aVIO
->
œ°AsyncO≥øti⁄
 = 
CHECK_FOR_DEDUPLICATION
;

523 
com∂ëi⁄
->
ˇŒback
 = 
vîifyAdvi˚
;

524 
com∂ëi⁄
->
œyî
->
	`checkF‹Du∂iˇti⁄
(
d©aVIO
);

525 
	}
}

534 
	$ªp‹tBogusLockSèã
(
HashLock
 *
lock
, 
D©aVIO
 *
d©aVIO
)

536 
ªsu…
 = 
	`ASSERT_FALSE
("hashÜock mustÇot be in unimplemented state %s",

537 
	`gëHashLockSèãName
(
lock
->
°©e
));

538 
	`c⁄töueD©aVIOIn
(
d©aVIO
, 
ªsu…
, 
vîifyAdvi˚
);

539 
	}
}

542 
	$íãrHashLock
(
D©aVIO
 *
d©aVIO
)

544 
HashLock
 *
lock
 = 
d©aVIO
->
hashLock
;

545 
lock
->
°©e
) {

546 
HASH_LOCK_INITIALIZING
:

547 
	`°¨tQuîyög
(
lock
, 
d©aVIO
);

550 
HASH_LOCK_QUERYING
:

551 
HASH_LOCK_WRITING
:

552 
HASH_LOCK_LOCKING
:

553 
HASH_LOCK_VERIFYING
:

555 
	`waôOnHashLock
(
lock
, 
d©aVIO
);

558 
HASH_LOCK_BYPASSING
:

561 
	`œunchOldDedu≥
(
d©aVIO
);

564 
HASH_LOCK_DEDUPING
:

565 
HASH_LOCK_UNLOCKING
:

566 
HASH_LOCK_UPDATING
:

569 
	`ªp‹tBogusLockSèã
(
lock
, 
d©aVIO
);

572 
HASH_LOCK_DESTROYING
:

574 
	`ªp‹tBogusLockSèã
(
lock
, 
d©aVIO
);

578 
	`ªp‹tBogusLockSèã
(
lock
, 
d©aVIO
);

580 
	}
}

583 
	$c⁄töueHashLock
(
D©aVIO
 *
d©aVIO
)

585 
HashLock
 *
lock
 = 
d©aVIO
->
hashLock
;

589 
lock
->
°©e
) {

590 
HASH_LOCK_WRITING
:

591 
	`ASSERT_LOG_ONLY
(
d©aVIO
 =
lock
->
agít
,

593 
	`föishWrôög
(
lock
, 
d©aVIO
);

596 
HASH_LOCK_BYPASSING
:

599 
	`föishD©aVIO
(
d©aVIO
, 
VDO_SUCCESS
);

602 
HASH_LOCK_INITIALIZING
:

603 
HASH_LOCK_QUERYING
:

604 
HASH_LOCK_UPDATING
:

605 
HASH_LOCK_LOCKING
:

606 
HASH_LOCK_VERIFYING
:

607 
HASH_LOCK_DEDUPING
:

608 
HASH_LOCK_UNLOCKING
:

609 
HASH_LOCK_DESTROYING
:

611 
	`ªp‹tBogusLockSèã
(
lock
, 
d©aVIO
);

615 
	`ªp‹tBogusLockSèã
(
lock
, 
d©aVIO
);

617 
	}
}

630 
boﬁ
 
	$isHashCﬁlisi⁄
(
HashLock
 *
lock
, 
D©aVIO
 *
ˇndid©e
)

632 i‡(
	`isRögEm±y
(&
lock
->
du∂iˇãRög
)) {

633  
Ál£
;

635 
D©aVIO
 *
lockHﬁdî
 = 
	`d©aVIOFromLockNode
(
lock
->
du∂iˇãRög
.
√xt
);

636 
PhysiˇlLayî
 *
œyî
 = 
	`d©aVIOAsCom∂ëi⁄
(
ˇndid©e
)->layer;

637  !
œyî
->
	`com∑ªD©aVIOs
(
lockHﬁdî
, 
ˇndid©e
);

638 
	}
}

641 
ölöe
 
	$as£πHashLockPªc⁄dôi⁄s
(c⁄° 
D©aVIO
 *
d©aVIO
)

643 
ªsu…
 = 
	`ASSERT
(
d©aVIO
->
hashLock
 =
NULL
,

645 i‡(
ªsu…
 !
VDO_SUCCESS
) {

646  
ªsu…
;

648 
ªsu…
 = 
	`ASSERT
(
	`isRögEm±y
(&
d©aVIO
->
hashLockNode
),

650 i‡(
ªsu…
 !
VDO_SUCCESS
) {

651  
ªsu…
;

653 
ªsu…
 = 
	`ASSERT
(
d©aVIO
->
du∂iˇãLock
 =
NULL
,

655 i‡(
ªsu…
 !
VDO_SUCCESS
) {

656  
ªsu…
;

658  
	`ASSERT
(
d©aVIO
->
ªcovîySequí˚Numbî
 == 0,

660 
	}
}

663 
	$acquúeHashLock
(
D©aVIO
 *
d©aVIO
)

665 
ªsu…
 = 
	`as£πHashLockPªc⁄dôi⁄s
(
d©aVIO
);

666 i‡(
ªsu…
 !
VDO_SUCCESS
) {

667  
ªsu…
;

670 
HashLock
 *
lock
;

671 
ªsu…
 = 
	`acquúeHashLockFromZ⁄e
(
d©aVIO
->
hashZ⁄e
, &d©aVIO->
chunkName
,

672 &
lock
);

673 i‡(
ªsu…
 !
VDO_SUCCESS
) {

674  
ªsu…
;

677 i‡(
	`isHashCﬁlisi⁄
(
lock
, 
d©aVIO
)) {

681  
VDO_SUCCESS
;

686 
	`pushRögNode
(&
lock
->
du∂iˇãRög
, &
d©aVIO
->
hashLockNode
);

687 
lock
->
ª„ªn˚Cou¡
 += 1;

691 i‡(
lock
->
maxRe„ªn˚s
 <Üock->
ª„ªn˚Cou¡
) {

692 
lock
->
maxRe„ªn˚s
 =Üock->
ª„ªn˚Cou¡
;

695 
d©aVIO
->
hashLock
 = 
lock
;

696  
VDO_SUCCESS
;

697 
	}
}

700 
	$ªÀa£HashLock
(
D©aVIO
 *
d©aVIO
)

702 
HashLock
 *
lock
 = 
d©aVIO
->
hashLock
;

703 i‡(
lock
 =
NULL
) {

707 i‡(
lock
->
°©e
 !
HASH_LOCK_BYPASSING
) {

709 
	`ASSERT_LOG_ONLY
(
	`d©aVIOAsCom∂ëi⁄
(
d©aVIO
)->
ªsu…
 !
VDO_SUCCESS
,

711 
	`ASSERT_LOG_ONLY
(
lock
->
°©e
 =
HASH_LOCK_WRITING
,

713 
	`ASSERT_LOG_ONLY
(
lock
->
agít
 =
d©aVIO
,

716 
D©aVIO
 *
√wAgít
 = 
	`dequeueLockWaôî
(
lock
);

717 
	`£tAgít
(
lock
, 
√wAgít
);

718 
	`°¨tBy∑ssög
(
lock
, 
√wAgít
);

721 
d©aVIO
->
hashLock
 = 
NULL
;

723 
	`ASSERT_LOG_ONLY
(
d©aVIO
->
hashZ⁄e
 !
NULL
,

725 
	`ASSERT_LOG_ONLY
(!
	`isRögEm±y
(&
d©aVIO
->
hashLockNode
),

727 
	`ASSERT_LOG_ONLY
(
lock
->
ª„ªn˚Cou¡
 > 0,

730 
	`un•li˚RögNode
(&
d©aVIO
->
hashLockNode
);

731 i‡(--
lock
->
ª„ªn˚Cou¡
 > 0) {

736 
	`as£πHashLockSèã
(
lock
, 
HASH_LOCK_BYPASSING
, 
__func__
);

744 
	`£tHashLockSèã
(
lock
, 
HASH_LOCK_DESTROYING
);

747 
	`ªtu∫HashLockToZ⁄e
(
d©aVIO
->
hashZ⁄e
, &
lock
);

748 
	}
}

	@vdo/base/hashLock.h

22 #i‚de‡
HASH_LOCK_H


23 
	#HASH_LOCK_H


	)

25 
	~"ty≥s.h
"

36 
PBNLock
 *
	$gëDu∂iˇãLock
(
D©aVIO
 *
d©aVIO
)

37 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

47 
	$acquúeHashLock
(
D©aVIO
 *
d©aVIO
)

48 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

57 
	`íãrHashLock
(
D©aVIO
 *
d©aVIO
);

68 
	`c⁄töueHashLock
(
D©aVIO
 *
d©aVIO
);

76 
	`c⁄töueHashLockOnEº‹
(
D©aVIO
 *
d©aVIO
);

90 
	`ªÀa£HashLock
(
D©aVIO
 *
d©aVIO
);

	@vdo/base/hashLockInternals.h

22 #i‚de‡
HASH_LOCK_INTERNALS_H


23 
	#HASH_LOCK_INTERNALS_H


	)

25 
	~"com∂ëi⁄.h
"

26 
	~"rögNode.h
"

27 
	~"ty≥s.h
"

28 
	~"uds.h
"

29 
	~"waôQueue.h
"

33 
	mHASH_LOCK_INITIALIZING
 = 0,

36 
	mHASH_LOCK_QUERYING
,

37 
	mHASH_LOCK_WRITING
,

38 
	mHASH_LOCK_UPDATING
,

41 
	mHASH_LOCK_LOCKING
,

42 
	mHASH_LOCK_VERIFYING
,

43 
	mHASH_LOCK_DEDUPING
,

44 
	mHASH_LOCK_UNLOCKING
,

49 
	mHASH_LOCK_BYPASSING
,

55 
	mHASH_LOCK_DESTROYING
,

56 } 
	tHashLockSèã
;

58 
	shashLock
 {

60 
RögNode
 
	mpoﬁNode
;

63 
UdsChunkName
 
	mhash
;

69 
RögNode
 
	mdu∂iˇãRög
;

72 
VIOCou¡
 
	mª„ªn˚Cou¡
;

75 
VIOCou¡
 
	mmaxRe„ªn˚s
;

78 
HashLockSèã
 
	m°©e
;

81 
D©aVIO
 *
	magít
;

88 
WaôQueue
 
	mwaôîs
;

96 
ölöe
 
	$öôülizeHashLock
(
HashLock
 *
lock
)

98 
	`öôülizeRög
(&
lock
->
poﬁNode
);

99 
	`öôülizeRög
(&
lock
->
du∂iˇãRög
);

100 
	`öôülizeWaôQueue
(&
lock
->
waôîs
);

101 
	}
}

110 c⁄° *
	$gëHashLockSèãName
(
HashLockSèã
 
°©e
)

111 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

	@vdo/base/hashZone.c

22 
	~"hashZ⁄e.h
"

24 
	~"mem‹yAŒoc.h
"

25 
	~"numîic.h
"

26 
	~"≥rmas£π.h
"

28 
	~"c⁄°™ts.h
"

29 
	~"d©aVIO.h
"

30 
	~"hashLock.h
"

31 
	~"hashLockI¡î«ls.h
"

32 
	~"poöãrM≠.h
"

33 
	~"rögNode.h
"

34 
	~"thªadC⁄fig.h
"

35 
	~"ty≥s.h
"

36 
	~"vdoI¡î«l.h
"

39 
	mLOCK_POOL_CAPACITY
 = 
MAXIMUM_USER_VIOS
,

42 
	shashZ⁄e
 {

44 
Z⁄eCou¡
 
	mz⁄eNumbî
;

46 c⁄° 
ThªadD©a
 *
	mthªadD©a
;

48 
PoöãrM≠
 *
	mhashLockM≠
;

50 
RögNode
 
	mlockPoﬁ
;

52 
HashLock
 *
	mlockAºay
;

58 
boﬁ
 
	$com∑ªKeys
(c⁄° *
thisKey
, c⁄° *
th©Key
)

61  (
	`memcmp
(
thisKey
, 
th©Key
, (
UdsChunkName
)) == 0);

62 
	}
}

67 
uöt32_t
 
	$hashKey
(c⁄° *
key
)

69 c⁄° 
UdsChunkName
 *
«me
 = 
key
;

75  
	`gëUI¡32LE
(&
«me
->name[4]);

76 
	}
}

79 
ölöe
 
HashLock
 *
	$asHashLock
(
RögNode
 *
poﬁNode
)

81 
	`STATIC_ASSERT
(
	`off£tof
(
HashLock
, 
poﬁNode
) == 0);

82  (
HashLock
 *Ë
poﬁNode
;

83 
	}
}

86 
	$makeHashZ⁄e
(
VDO
 *
vdo
, 
Z⁄eCou¡
 
z⁄eNumbî
, 
HashZ⁄e
 **
z⁄ePå
)

88 
HashZ⁄e
 *
z⁄e
;

89 
ªsu…
 = 
	`ALLOCATE
(1, 
HashZ⁄e
, 
__func__
, &
z⁄e
);

90 i‡(
ªsu…
 !
VDO_SUCCESS
) {

91  
ªsu…
;

94 
ªsu…
 = 
	`makePoöãrM≠
(
LOCK_MAP_CAPACITY
, 0, 
com∑ªKeys
, 
hashKey
,

95 &
z⁄e
->
hashLockM≠
);

96 i‡(
ªsu…
 !
VDO_SUCCESS
) {

97 
	`‰ìHashZ⁄e
(&
z⁄e
);

98  
ªsu…
;

101 
ThªadID
 
thªadID
 = 
	`gëHashZ⁄eThªad
(
	`gëThªadC⁄fig
(
vdo
), 
z⁄eNumbî
);

102 
z⁄e
->
z⁄eNumbî
 = zoneNumber;

103 
z⁄e
->
thªadD©a
 = &
vdo
->thªadD©a[
thªadID
];

104 
	`ASSERT_LOG_ONLY
(
thªadID
 =
	`gëHashZ⁄eThªadID
(
z⁄e
),

106 
	`öôülizeRög
(&
z⁄e
->
lockPoﬁ
);

108 
ªsu…
 = 
	`ALLOCATE
(
LOCK_POOL_CAPACITY
, 
HashLock
, "HashLockárray",

109 &
z⁄e
->
lockAºay
);

110 i‡(
ªsu…
 !
VDO_SUCCESS
) {

111 
	`‰ìHashZ⁄e
(&
z⁄e
);

112  
ªsu…
;

115 
VIOCou¡
 
i
 = 0; i < 
LOCK_POOL_CAPACITY
; i++) {

116 
HashLock
 *
lock
 = &
z⁄e
->
lockAºay
[
i
];

117 
	`öôülizeHashLock
(
lock
);

118 
	`pushRögNode
(&
z⁄e
->
lockPoﬁ
, &
lock
->
poﬁNode
);

121 *
z⁄ePå
 = 
z⁄e
;

122  
VDO_SUCCESS
;

123 
	}
}

126 
	$‰ìHashZ⁄e
(
HashZ⁄e
 **
z⁄ePå
)

128 i‡(*
z⁄ePå
 =
NULL
) {

132 
HashZ⁄e
 *
z⁄e
 = *
z⁄ePå
;

133 
	`‰ìPoöãrM≠
(&
z⁄e
->
hashLockM≠
);

134 
	`FREE
(
z⁄e
->
lockAºay
);

135 
	`FREE
(
z⁄e
);

136 *
z⁄ePå
 = 
NULL
;

137 
	}
}

140 
Z⁄eCou¡
 
	$gëHashZ⁄eNumbî
(c⁄° 
HashZ⁄e
 *
z⁄e
)

142  
z⁄e
->
z⁄eNumbî
;

143 
	}
}

146 
ThªadID
 
	$gëHashZ⁄eThªadID
(c⁄° 
HashZ⁄e
 *
z⁄e
)

148  
z⁄e
->
thªadD©a
->
thªadID
;

149 
	}
}

157 
	$ªtu∫HashLockToPoﬁ
(
HashZ⁄e
 *
z⁄e
, 
HashLock
 **
lockPå
)

159 
HashLock
 *
lock
 = *
lockPå
;

160 *
lockPå
 = 
NULL
;

162 
	`ASSERT_LOG_ONLY
(((
lock
->
°©e
 =
HASH_LOCK_DESTROYING
)

163 || (
lock
->
°©e
 =
HASH_LOCK_INITIALIZING
)),

165 
	`gëHashLockSèãName
(
lock
->
°©e
));

166 
	`ASSERT_LOG_ONLY
(
	`isRögEm±y
(&
lock
->
poﬁNode
),

168 
	`ASSERT_LOG_ONLY
(
	`isRögEm±y
(&
lock
->
du∂iˇãRög
),

171 
	`mem£t
(
lock
, 0, (*lock));

172 
	`öôülizeHashLock
(
lock
);

173 
	`pushRögNode
(&
z⁄e
->
lockPoﬁ
, &
lock
->
poﬁNode
);

174 
	}
}

177 
	$acquúeHashLockFromZ⁄e
(
HashZ⁄e
 *
z⁄e
,

178 c⁄° 
UdsChunkName
 *
hash
,

179 
HashLock
 **
lockPå
)

183 
HashLock
 *
√wLock
 = 
	`asHashLock
(
	`p›RögNode
(&
z⁄e
->
lockPoﬁ
));

184 
ªsu…
 = 
	`ASSERT
(
√wLock
 !
NULL
,

186 i‡(
ªsu…
 !
VDO_SUCCESS
) {

187  
ªsu…
;

192 
√wLock
->
hash
 = *hash;

194 
HashLock
 *
lock
;

195 
ªsu…
 = 
	`poöãrM≠Put
(
z⁄e
->
hashLockM≠
, &
√wLock
->
hash
,ÇewLock,

196 
Ál£
, (**Ë&
lock
);

197 i‡(
ªsu…
 !
VDO_SUCCESS
) {

198 
	`ªtu∫HashLockToPoﬁ
(
z⁄e
, &
√wLock
);

199  
ªsu…
;

202 i‡(
lock
 =
NULL
) {

204 
lock
 = 
√wLock
;

207 
	`ªtu∫HashLockToPoﬁ
(
z⁄e
, &
√wLock
);

210 *
lockPå
 = 
lock
;

211  
VDO_SUCCESS
;

212 
	}
}

215 
	$ªtu∫HashLockToZ⁄e
(
HashZ⁄e
 *
z⁄e
, 
HashLock
 **
lockPå
)

217 
HashLock
 *
lock
 = *
lockPå
;

218 *
lockPå
 = 
NULL
;

220 
HashLock
 *
ªmoved
 = 
	`poöãrM≠Remove
(
z⁄e
->
hashLockM≠
, &
lock
->
hash
);

221 
	`ASSERT_LOG_ONLY
(
lock
 =
ªmoved
,

224 
	`ªtu∫HashLockToPoﬁ
(
z⁄e
, &
lock
);

225 
	}
}

	@vdo/base/hashZone.h

22 #i‚de‡
HASH_ZONE_H


23 
	#HASH_ZONE_H


	)

25 
	~"uds.h
"

26 
	~"ty≥s.h
"

37 
	$makeHashZ⁄e
(
VDO
 *
vdo
, 
Z⁄eCou¡
 
z⁄eNumbî
, 
HashZ⁄e
 **
z⁄ePå
)

38 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

45 
	`‰ìHashZ⁄e
(
HashZ⁄e
 **
z⁄ePå
);

54 
Z⁄eCou¡
 
	$gëHashZ⁄eNumbî
(c⁄° 
HashZ⁄e
 *
z⁄e
)

55 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

64 
ThªadID
 
	$gëHashZ⁄eThªadID
(c⁄° 
HashZ⁄e
 *
z⁄e
)

65 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

78 
	$acquúeHashLockFromZ⁄e
(
HashZ⁄e
 *
z⁄e
,

79 c⁄° 
UdsChunkName
 *
hash
,

80 
HashLock
 **
lockPå
)

81 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

92 
	`ªtu∫HashLockToZ⁄e
(
HashZ⁄e
 *
z⁄e
, 
HashLock
 **
lockPå
);

	@vdo/base/header.c

22 
	~"hódî.h
"

24 
	~"loggî.h
"

25 
	~"≥rmas£π.h
"

26 
	~"°©usCodes.h
"

29 
	$vÆid©eVîsi⁄
(c⁄° 
Vîsi⁄Numbî
 *
ex≥˘edVîsi⁄
,

30 c⁄° 
Vîsi⁄Numbî
 *
a˘uÆVîsi⁄
,

31 c⁄° *
comp⁄ítName
)

33 i‡(!
	`¨eSameVîsi⁄
(
ex≥˘edVîsi⁄
, 
a˘uÆVîsi⁄
)) {

34  
	`logEº‹WôhSåögEº‹
(
VDO_UNSUPPORTED_VERSION
,

37 
comp⁄ítName
,

38 
ex≥˘edVîsi⁄
->
maj‹Vîsi⁄
,

39 
ex≥˘edVîsi⁄
->
mö‹Vîsi⁄
,

40 
a˘uÆVîsi⁄
->
maj‹Vîsi⁄
,

41 
a˘uÆVîsi⁄
->
mö‹Vîsi⁄
);

43  
VDO_SUCCESS
;

44 
	}
}

47 
	$vÆid©eHódî
(c⁄° 
Hódî
 *
ex≥˘edHódî
,

48 c⁄° 
Hódî
 *
a˘uÆHódî
,

49 
boﬁ
 
exa˘Size
,

50 c⁄° *
comp⁄ítName
)

52 i‡(
ex≥˘edHódî
->
id
 !
a˘uÆHódî
->id) {

53  
	`logEº‹WôhSåögEº‹
(
VDO_INCORRECT_COMPONENT
,

55 
comp⁄ítName
,

56 
ex≥˘edHódî
->
id
,

57 
a˘uÆHódî
->
id
);

60 
ªsu…
 = 
	`vÆid©eVîsi⁄
(&
ex≥˘edHódî
->
vîsi⁄
,

61 &
a˘uÆHódî
->
vîsi⁄
,

62 
comp⁄ítName
);

63 i‡(
ªsu…
 !
VDO_SUCCESS
) {

64  
ªsu…
;

67 i‡((
ex≥˘edHódî
->
size
 > 
a˘uÆHódî
->size)

68 || (
exa˘Size
 && (
ex≥˘edHódî
->
size
 < 
a˘uÆHódî
->size))) {

69  
	`logEº‹WôhSåögEº‹
(
VDO_UNSUPPORTED_VERSION
,

71 
comp⁄ítName
,

72 
ex≥˘edHódî
->
size
,

73 
a˘uÆHódî
->
size
);

76  
VDO_SUCCESS
;

77 
	}
}

80 
	$ícodeHódî
(c⁄° 
Hódî
 *
hódî
, 
Buf„r
 *
buf„r
)

82  
	`putByãs
(
buf„r
, 
ENCODED_HEADER_SIZE
, 
hódî
);

83 
	}
}

86 
	$ícodeWôhHódî
(c⁄° 
Hódî
 *
hódî
, c⁄° *
d©a
, 
Buf„r
 *
buf„r
)

88 i‡(!
	`ísuªAvaûabÀS∑˚
(
buf„r
, 
ENCODED_HEADER_SIZE
 + 
hódî
->
size
)) {

89  
UDS_BUFFER_ERROR
;

92 
ªsu…
 = 
	`ícodeHódî
(
hódî
, 
buf„r
);

93 i‡(
ªsu…
 !
UDS_SUCCESS
) {

94  
ªsu…
;

97  
	`putByãs
(
buf„r
, 
hódî
->
size
, 
d©a
);

98 
	}
}

101 
	$decodeHódî
(
Buf„r
 *
buf„r
, 
Hódî
 *
hódî
)

103  
	`gëByãsFromBuf„r
(
buf„r
, 
ENCODED_HEADER_SIZE
, 
hódî
);

104 
	}
}

107 
	$decodeWôhHódî
(
Buf„r
 *
buf„r
, 
Hódî
 *
hódî
, 
byã
 *
d©a
)

109 
ªsu…
 = 
	`decodeHódî
(
buf„r
, 
hódî
);

110 i‡(
ªsu…
 !
UDS_SUCCESS
) {

111  
ªsu…
;

114 
ªsu…
 = 
	`gëByãsFromBuf„r
(
buf„r
, 
hódî
->
size
, 
d©a
);

115 i‡(
ªsu…
 !
UDS_SUCCESS
) {

116 
ªwödResu…
 = 
	`ªwödBuf„r
(
buf„r
, 
ENCODED_HEADER_SIZE
);

117 
	`ASSERT_LOG_ONLY
((
ªwödResu…
 =
UDS_SUCCESS
),

120  
ªsu…
;

121 
	}
}

	@vdo/base/header.h

22 #i‚de‡
HEADER_H


23 
	#HEADER_H


	)

25 
	~"buf„r.h
"

26 
	~"ty≥s.h
"

40 
uöt32_t
 
	mmaj‹Vîsi⁄
;

41 
uöt32_t
 
	mmö‹Vîsi⁄
;

42 } 
	t__©åibuã__
((
	t∑cked
)Ë
	tVîsi⁄Numbî
;

48 
	mSUPER_BLOCK
 = 0,

49 
	mFIXED_LAYOUT
 = 1,

50 
	mRECOVERY_JOURNAL
 = 2,

51 
	mSLAB_DEPOT
 = 3,

52 
	mBLOCK_MAP
 = 4,

53 
	mGEOMETRY_BLOCK
 = 5,

54 } 
	tComp⁄ítID
;

60 
Comp⁄ítID
 
	mid
;

61 
Vîsi⁄Numbî
 
	mvîsi⁄
;

62 
size_t
 
	msize
;

63 } 
	t__©åibuã__
((
	t∑cked
)Ë
	tHódî
;

66 
	mENCODED_HEADER_SIZE
 = (
Hódî
),

77 
ölöe
 
boﬁ
 
	$¨eSameVîsi⁄
(c⁄° 
Vîsi⁄Numbî
 *
vîsi⁄A
,

78 c⁄° 
Vîsi⁄Numbî
 *
vîsi⁄B
)

80  ((
vîsi⁄A
->
maj‹Vîsi⁄
 =
vîsi⁄B
->majorVersion)

81 && (
vîsi⁄A
->
mö‹Vîsi⁄
 =
vîsi⁄B
->minorVersion));

82 
	}
}

95 
ölöe
 
boﬁ
 
	$isUpgødabÀVîsi⁄
(c⁄° 
Vîsi⁄Numbî
 *
ex≥˘edVîsi⁄
,

96 c⁄° 
Vîsi⁄Numbî
 *
a˘uÆVîsi⁄
)

98  ((
ex≥˘edVîsi⁄
->
maj‹Vîsi⁄
 =
a˘uÆVîsi⁄
->majorVersion)

99 && (
ex≥˘edVîsi⁄
->
mö‹Vîsi⁄
 > 
a˘uÆVîsi⁄
->minorVersion));

100 
	}
}

114 
	$vÆid©eVîsi⁄
(c⁄° 
Vîsi⁄Numbî
 *
ex≥˘edVîsi⁄
,

115 c⁄° 
Vîsi⁄Numbî
 *
a˘uÆVîsi⁄
,

116 c⁄° *
comp⁄ítName
)

117 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

134 
	$vÆid©eHódî
(c⁄° 
Hódî
 *
ex≥˘edHódî
,

135 c⁄° 
Hódî
 *
a˘uÆHódî
,

136 
boﬁ
 
exa˘Size
,

137 c⁄° *
comp⁄ítName
)

138 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

148 
	$ícodeHódî
(c⁄° 
Hódî
 *
hódî
, 
Buf„r
 *
buf„r
)

149 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

160 
	$ícodeWôhHódî
(c⁄° 
Hódî
 *
hódî
, c⁄° *
d©a
, 
Buf„r
 *
buf„r
)

161 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

169 
	$decodeHódî
(
Buf„r
 *
buf„r
, 
Hódî
 *
hódî
)

170 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

179 
	$decodeWôhHódî
(
Buf„r
 *
buf„r
, 
Hódî
 *
hódî
, 
byã
 *
d©a
)

180 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

	@vdo/base/heap.c

22 
	~"hóp.h
"

24 
	~"îr‹s.h
"

25 
	~"loggî.h
"

26 
	~"numîic.h
"

28 
	~"°©usCodes.h
"

31 
	$öôülizeHóp
(
Hóp
 *
hóp
,

32 
HópCom∑øt‹
 *
com∑øt‹
,

33 *
¨øy
,

34 
size_t
 
ˇ∑côy
,

35 
size_t
 
ñemítSize
)

37 *
hóp
 = (
Hóp
) {

38 .
com∑øt‹
 = comparator,

39 .
ˇ∑côy
 = capacity,

40 .
ñemítSize
 =ÉlementSize,

42 i‡(
¨øy
 !
NULL
) {

45 
hóp
->
¨øy
 = ((
byã
 *Ë¨øy - 
ñemítSize
);

47 
	}
}

50 
ölöe
 
	$sw≠EÀmíts
(
Hóp
 *
hóp
, 
size_t
 
node1
, size_à
node2
)

52 
byã
 
ãmp
[
hóp
->
ñemítSize
];

54 
	`mem˝y
(
ãmp
, &
hóp
->
¨øy
[
node1
], hóp->
ñemítSize
);

55 
	`mem˝y
(&
hóp
->
¨øy
[
node1
], &hóp->¨øy[
node2
], hóp->
ñemítSize
);

56 
	`mem˝y
(&
hóp
->
¨øy
[
node2
], 
ãmp
, hóp->
ñemítSize
);

57 
	}
}

60 
	$si·HópDown
(
Hóp
 *
hóp
, 
size_t
 
t›Node
, size_à
œ°Node
)

63 
size_t
 
À·Chûd
;

64 (
À·Chûd
 = (2 * 
t›Node
)Ë<
œ°Node
) {

66 
size_t
 
sw≠Node
 = 
À·Chûd
;

67 i‡(
À·Chûd
 < 
œ°Node
) {

68 
size_t
 
rightChûd
 = 
À·Chûd
 + 
hóp
->
ñemítSize
;

69 i‡(
hóp
->
	`com∑øt‹
(&hóp->
¨øy
[
À·Chûd
],

70 &
hóp
->
¨øy
[
rightChûd
]) < 0) {

71 
sw≠Node
 = 
rightChûd
;

77 i‡(
hóp
->
	`com∑øt‹
(&hóp->
¨øy
[
t›Node
], &hóp->¨øy[
sw≠Node
]) >= 0) {

82 
	`sw≠EÀmíts
(
hóp
, 
t›Node
, 
sw≠Node
);

86 
t›Node
 = 
sw≠Node
;

91 
	}
}

94 
	$buûdHóp
(
Hóp
 *
hóp
, 
size_t
 
cou¡
)

96 
hóp
->
cou¡
 = 
	`möSizeT
(cou¡, hóp->
ˇ∑côy
);

98 i‡((
hóp
->
cou¡
 < 2Ë|| (hóp->
ñemítSize
 == 0)) {

118 
size_t
 
size
 = 
hóp
->
ñemítSize
;

119 
size_t
 
œ°P¨ít
 = 
size
 * (
hóp
->
cou¡
 / 2);

120 
size_t
 
œ°Node
 = 
size
 * 
hóp
->
cou¡
;

121 
size_t
 
t›Node
 = 
œ°P¨ít
;Å›Nodê> 0;Å›Nodê-
size
) {

122 
	`si·HópDown
(
hóp
, 
t›Node
, 
œ°Node
);

124 
	}
}

127 
boﬁ
 
	$p›MaxHópEÀmít
(
Hóp
 *
hóp
, *
ñemítPå
)

129 i‡(
hóp
->
cou¡
 == 0) {

130  
Ál£
;

133 
size_t
 
roŸNode
 = (
hóp
->
ñemítSize
 * 1);

134 
size_t
 
œ°Node
 = (
hóp
->
ñemítSize
 * hóp->
cou¡
);

137 i‡(
ñemítPå
 !
NULL
) {

138 
	`mem˝y
(
ñemítPå
, &
hóp
->
¨øy
[
roŸNode
], hóp->
ñemítSize
);

143 i‡(
roŸNode
 !
œ°Node
) {

144 
	`mem˝y
(&
hóp
->
¨øy
[
roŸNode
], &hóp->¨øy[
œ°Node
], hóp->
ñemítSize
);

146 
hóp
->
cou¡
 -= 1;

147 
œ°Node
 -
hóp
->
ñemítSize
;

150 
	`si·HópDown
(
hóp
, 
roŸNode
, 
œ°Node
);

151  
åue
;

152 
	}
}

155 
ölöe
 
size_t
 
	$si·AndS‹t
(
Hóp
 *
hóp
, 
size_t
 
roŸNode
, size_à
œ°Node
)

165 
	`sw≠EÀmíts
(
hóp
, 
roŸNode
, 
œ°Node
);

168 
œ°Node
 -
hóp
->
ñemítSize
;

171 
	`si·HópDown
(
hóp
, 
roŸNode
, 
œ°Node
);

172  
œ°Node
;

173 
	}
}

176 
size_t
 
	$s‹tHóp
(
Hóp
 *
hóp
)

180 i‡((
hóp
->
cou¡
 < 2Ë|| (hóp->
ñemítSize
 == 0)) {

181  
hóp
->
cou¡
;

186 
size_t
 
roŸNode
 = (
hóp
->
ñemítSize
 * 1);

187 
size_t
 
œ°Node
 = (
hóp
->
ñemítSize
 * hóp->
cou¡
);

189 
œ°Node
 > 
roŸNode
) {

190 
œ°Node
 = 
	`si·AndS‹t
(
hóp
, 
roŸNode
,ÜastNode);

193 
size_t
 
cou¡
 = 
hóp
->count;

194 
hóp
->
cou¡
 = 0;

195  
cou¡
;

196 
	}
}

199 *
	$s‹tNextHópEÀmít
(
Hóp
 *
hóp
)

201 i‡((
hóp
->
cou¡
 =0Ë|| (hóp->
ñemítSize
 == 0)) {

202  
NULL
;

207 
size_t
 
roŸNode
 = (
hóp
->
ñemítSize
 * 1);

208 
size_t
 
œ°Node
 = (
hóp
->
ñemítSize
 * hóp->
cou¡
);

209 i‡(
hóp
->
cou¡
 > 1) {

210 
	`si·AndS‹t
(
hóp
, 
roŸNode
, 
œ°Node
);

212 
hóp
->
cou¡
--;

214  &
hóp
->
¨øy
[
œ°Node
];

215 
	}
}

	@vdo/base/heap.h

22 #i‚de‡
HEAP_H


23 
	#HEAP_H


	)

25 
	~"comm⁄.h
"

39 
	tHópCom∑øt‹
(c⁄° *
	tôem1
, c⁄° *
	tôem2
);

48 
	shóp
 {

50 
byã
 *
	m¨øy
;

52 
HópCom∑øt‹
 *
	mcom∑øt‹
;

54 
size_t
 
	mˇ∑côy
;

56 
size_t
 
	mñemítSize
;

58 
size_t
 
	mcou¡
;

59 } 
	tHóp
;

73 
öôülizeHóp
(
Hóp
 *
hóp
,

74 
HópCom∑øt‹
 *
com∑øt‹
,

75 *
¨øy
,

76 
size_t
 
ˇ∑côy
,

77 
size_t
 
ñemítSize
);

89 
buûdHóp
(
Hóp
 *
hóp
, 
size_t
 
cou¡
);

98 
ölöe
 
boﬁ
 
	$isHópEm±y
(c⁄° 
Hóp
 *
hóp
)

100  (
hóp
->
cou¡
 == 0);

101 
	}
}

114 
boﬁ
 
p›MaxHópEÀmít
(
Hóp
 *
hóp
, *
ñemítPå
);

131 
size_t
 
s‹tHóp
(
Hóp
 *
hóp
);

141 *
s‹tNextHópEÀmít
(
Hóp
 *
hóp
);

	@vdo/base/intMap.c

73 
	~"ötM≠.h
"

75 
	~"îr‹s.h
"

76 
	~"loggî.h
"

77 
	~"mem‹yAŒoc.h
"

78 
	~"numîic.h
"

79 
	~"≥rmas£π.h
"

82 
	mDEFAULT_CAPACITY
 = 16,

83 
	mNEIGHBORHOOD
 = 255,

84 
	mMAX_PROBES
 = 1024,

85 
	mNULL_HOP_OFFSET
 = 0,

86 
	mDEFAULT_LOAD
 = 75

96 
__©åibuã__
((
	t∑cked
)Ë
	tbuckë
 {

97 
uöt8_t
 
	gfú°H›
;

99 
uöt8_t
 
	g√xtH›
;

101 
uöt64_t
 
	gkey
;

102 *
	gvÆue
;

103 } 
	tBuckë
;

111 
	sötM≠
 {

112 
size_t
 
	msize
;

113 
size_t
 
	mˇ∑côy
;

114 
size_t
 
	mbuckëCou¡
;

115 
Buckë
 *
	mbuckës
;

126 
uöt64_t
 
	$mix
(
uöt64_t
 
öput1
, uöt64_à
öput2
)

128 c⁄° 
uöt64_t
 
CITY_MULTIPLIER
 = 0x9ddfea08eb382d69ULL;

130 
uöt64_t
 
hash
 = (
öput1
 ^ 
öput2
);

131 
hash
 *
CITY_MULTIPLIER
;

132 
hash
 ^= (hash >> 47);

133 
hash
 ^
öput2
;

134 
hash
 *
CITY_MULTIPLIER
;

135 
hash
 ^= (hash >> 47);

136 
hash
 *
CITY_MULTIPLIER
;

137  
hash
;

138 
	}
}

149 
uöt64_t
 
	$hashKey
(
uöt64_t
 
key
)

154 
uöt64_t
 
u64
;

155 
uöt32_t
 
u32
[2];

156 } 
pun
 = { .
u64
 = 
key
 };

157  
	`mix
((
key
Ë+ (((
uöt64_t
Ë
pun
.
u32
[0]) << 3),Öun.u32[1]);

158 
	}
}

168 
	$ÆloˇãBuckës
(
I¡M≠
 *
m≠
, 
size_t
 
ˇ∑côy
)

170 
m≠
->
size
 = 0;

171 
m≠
->
ˇ∑côy
 = capacity;

175 
m≠
->
buckëCou¡
 = 
ˇ∑côy
 + (
NEIGHBORHOOD
 - 1);

176  
	`ALLOCATE
(
m≠
->
buckëCou¡
, 
Buckë
, "I¡M≠ buckës", &m≠->
buckës
);

177 
	}
}

180 
	$makeI¡M≠
(
size_t
 
öôülC≠acôy
,

181 
öôülLﬂd
,

182 
I¡M≠
 **
m≠På
)

185 i‡(
öôülLﬂd
 == 0) {

186 
öôülLﬂd
 = 
DEFAULT_LOAD
;

188 i‡(
öôülLﬂd
 > 100) {

189  
UDS_INVALID_ARGUMENT
;

192 
I¡M≠
 *
m≠
;

193 
ªsu…
 = 
	`ALLOCATE
(1, 
I¡M≠
, "I¡M≠", &
m≠
);

194 i‡(
ªsu…
 !
UDS_SUCCESS
) {

195  
ªsu…
;

199 
size_t
 
ˇ∑côy
 = (
öôülC≠acôy
 > 0Ë? inôülC≠acôy : 
DEFAULT_CAPACITY
;

203 
ˇ∑côy
 = c≠acôy * 100 / 
öôülLﬂd
;

205 
ªsu…
 = 
	`ÆloˇãBuckës
(
m≠
, 
ˇ∑côy
);

206 i‡(
ªsu…
 !
UDS_SUCCESS
) {

207 
	`‰ìI¡M≠
(&
m≠
);

208  
ªsu…
;

211 *
m≠På
 = 
m≠
;

212  
UDS_SUCCESS
;

213 
	}
}

220 
	$‰ìBuckës
(
I¡M≠
 *
m≠
)

222 
	`FREE
(
m≠
->
buckës
);

223 
m≠
->
buckës
 = 
NULL
;

224 
	}
}

227 
	$‰ìI¡M≠
(
I¡M≠
 **
m≠På
)

229 i‡(*
m≠På
 !
NULL
) {

230 
	`‰ìBuckës
(*
m≠På
);

231 
	`FREE
(*
m≠På
);

232 *
m≠På
 = 
NULL
;

234 
	}
}

237 
size_t
 
	$ötM≠Size
(c⁄° 
I¡M≠
 *
m≠
)

239  
m≠
->
size
;

240 
	}
}

252 
Buckë
 *
	$dîe„ªn˚H›
(
Buckë
 *
√ighb‹hood
, 
h›Off£t
)

254 i‡(
h›Off£t
 =
NULL_HOP_OFFSET
) {

255  
NULL
;

258 
	`STATIC_ASSERT
(
NULL_HOP_OFFSET
 == 0);

259  &
√ighb‹hood
[
h›Off£t
 - 1];

260 
	}
}

269 
	$ö£πInH›Li°
(
Buckë
 *
√ighb‹hood
, Buckë *
√wBuckë
)

272 
h›Off£t
 = 1 + (
√wBuckë
 - 
√ighb‹hood
);

275 
√xtH›
 = 
√ighb‹hood
->
fú°H›
;

276 i‡((
√xtH›
 =
NULL_HOP_OFFSET
Ë|| (√xtH› > 
h›Off£t
)) {

277 
√wBuckë
->
√xtH›
 =ÇextHop;

278 
√ighb‹hood
->
fú°H›
 = 
h›Off£t
;

285 
Buckë
 *
buckë
 = 
	`dîe„ªn˚H›
(
√ighb‹hood
, 
√xtH›
);

286 
√xtH›
 = 
buckë
->nextHop;

288 i‡((
√xtH›
 =
NULL_HOP_OFFSET
Ë|| (√xtH› > 
h›Off£t
)) {

289 
√wBuckë
->
√xtH›
 =ÇextHop;

290 
buckë
->
√xtH›
 = 
h›Off£t
;

294 
	}
}

302 
Buckë
 *
	$£À˘Buckë
(c⁄° 
I¡M≠
 *
m≠
, 
uöt64_t
 
key
)

306 
uöt64_t
 
hash
 = 
	`hashKey
(
key
) & 0xFFFFFFFF;

315  &
m≠
->
buckës
[(
hash
 * m≠->
ˇ∑côy
) >> 32];

316 
	}
}

332 
Buckë
 *
£¨chH›Li°
(
I¡M≠
 *
m≠
 
__©åibuã__
((
unu£d
)),

333 
Buckë
 *
buckë
,

334 
uöt64_t
 
key
,

335 
Buckë
 **
¥eviousPå
)

337 
Buckë
 *
	g¥evious
 = 
NULL
;

338 
	g√xtH›
 = 
buckë
->
fú°H›
;

339 
	g√xtH›
 !
NULL_HOP_OFFSET
) {

341 
Buckë
 *
íåy
 = 
dîe„ªn˚H›
(
buckë
, 
√xtH›
);

342 i‡((
	gkey
 =
íåy
->
key
Ë&& (íåy->
vÆue
 !
NULL
)) {

343 i‡(
¥eviousPå
 !
NULL
) {

344 *
¥eviousPå
 = 
¥evious
;

346  
	gíåy
;

348 
	g√xtH›
 = 
íåy
->
√xtH›
;

349 
	g¥evious
 = 
íåy
;

351  
	gNULL
;

355 *
	$ötM≠Gë
(
I¡M≠
 *
m≠
, 
uöt64_t
 
key
)

357 
Buckë
 *
m©ch
 = 
	`£¨chH›Li°
(
m≠
, 
	`£À˘Buckë
(m≠, 
key
), key, 
NULL
);

358  ((
m©ch
 !
NULL
Ë? m©ch->
vÆue
 : NULL);

359 
	}
}

367 
	$ªsizeBuckës
(
I¡M≠
 *
m≠
)

370 
I¡M≠
 
ﬁdM≠
 = *
m≠
;

373 
size_t
 
√wC≠acôy
 = 
m≠
->
ˇ∑côy
 / 2 * 3;

374 
	`logInfo
("%s:áttemptingÑesize from %zuÅo %zu, current size=%zu",

375 
__func__
, 
m≠
->
ˇ∑côy
, 
√wC≠acôy
, m≠->
size
);

376 
ªsu…
 = 
	`ÆloˇãBuckës
(
m≠
, 
√wC≠acôy
);

377 i‡(
ªsu…
 !
UDS_SUCCESS
) {

378 *
m≠
 = 
ﬁdM≠
;

379  
ªsu…
;

383 
size_t
 
i
 = 0; i < 
ﬁdM≠
.
buckëCou¡
; i++) {

384 
Buckë
 *
íåy
 = &
ﬁdM≠
.
buckës
[
i
];

385 i‡(
íåy
->
vÆue
 =
NULL
) {

389 
ªsu…
 = 
	`ötM≠Put
(
m≠
, 
íåy
->
key
,É¡ry->
vÆue
, 
åue
, 
NULL
);

390 i‡(
ªsu…
 !
UDS_SUCCESS
) {

392 
	`‰ìBuckës
(
m≠
);

393 *
m≠
 = 
ﬁdM≠
;

394  
ªsu…
;

399 
	`‰ìBuckës
(&
ﬁdM≠
);

400  
UDS_SUCCESS
;

401 
	}
}

415 
Buckë
 *
	$födEm±yBuckë
(
I¡M≠
 *
m≠
,

416 
Buckë
 *
buckë
,

417 
maxProbes
)

421 
size_t
 
ªmaöög
 = &
m≠
->
buckës
[m≠->
buckëCou¡
] - 
buckë
;

422 
Buckë
 *
£¡öñ
 = &
buckë
[
	`möSizeT
(
ªmaöög
, 
maxProbes
)];

424 
Buckë
 *
íåy
 = 
buckë
;É¡ry < 
£¡öñ
;Éntry++) {

425 i‡(
íåy
->
vÆue
 =
NULL
) {

426  
íåy
;

429  
NULL
;

430 
	}
}

445 
Buckë
 *
moveEm±yBuckë
(
I¡M≠
 *
m≠
 
__©åibuã__
((
unu£d
)),

446 
Buckë
 *
hﬁe
)

455 
Buckë
 *
	gbuckë
 = &
hﬁe
[1 - 
NEIGHBORHOOD
]; buckë < 
	ghﬁe
; bucket++) {

458 
Buckë
 *
	g√wHﬁe
 = 
dîe„ªn˚H›
(
buckë
, buckë->
fú°H›
);

459 i‡(
	g√wHﬁe
 =
NULL
) {

467 i‡(
	ghﬁe
 < 
	g√wHﬁe
) {

479 
	gbuckë
->
	gfú°H›
 = 
√wHﬁe
->
√xtH›
;

480 
	g√wHﬁe
->
	g√xtH›
 = 
NULL_HOP_OFFSET
;

483 
	ghﬁe
->
	gkey
 = 
√wHﬁe
->
key
;

484 
	ghﬁe
->
	gvÆue
 = 
√wHﬁe
->
vÆue
;

485 
	g√wHﬁe
->
	gvÆue
 = 
NULL
;

488 
ö£πInH›Li°
(
buckë
, 
hﬁe
);

489  
	g√wHﬁe
;

493  
	gNULL
;

512 
boﬁ
 
	$upd©eM≠pög
(
I¡M≠
 *
m≠
,

513 
Buckë
 *
√ighb‹hood
,

514 
uöt64_t
 
key
,

515 *
√wVÆue
,

516 
boﬁ
 
upd©e
,

517 **
ﬁdVÆuePå
)

519 
Buckë
 *
buckë
 = 
	`£¨chH›Li°
(
m≠
, 
√ighb‹hood
, 
key
, 
NULL
);

520 i‡(
buckë
 =
NULL
) {

522  
Ál£
;

527 i‡(
ﬁdVÆuePå
 !
NULL
) {

528 *
ﬁdVÆuePå
 = 
buckë
->
vÆue
;

530 i‡(
upd©e
) {

531 
buckë
->
vÆue
 = 
√wVÆue
;

533  
åue
;

534 
	}
}

549 
Buckë
 *
	$födOrMakeVaˇncy
(
I¡M≠
 *
m≠
, 
Buckë
 *
√ighb‹hood
)

552 
Buckë
 *
hﬁe
 = 
	`födEm±yBuckë
(
m≠
, 
√ighb‹hood
, 
MAX_PROBES
);

556 
hﬁe
 !
NULL
) {

557 
di°™˚
 = 
hﬁe
 - 
√ighb‹hood
;

558 i‡(
di°™˚
 < 
NEIGHBORHOOD
) {

561  
hﬁe
;

566 
hﬁe
 = 
	`moveEm±yBuckë
(
m≠
, hole);

569  
NULL
;

570 
	}
}

573 
	$ötM≠Put
(
I¡M≠
 *
m≠
,

574 
uöt64_t
 
key
,

575 *
√wVÆue
,

576 
boﬁ
 
upd©e
,

577 **
ﬁdVÆuePå
)

579 i‡(
√wVÆue
 =
NULL
) {

580  
UDS_INVALID_ARGUMENT
;

585 
Buckë
 *
√ighb‹hood
 = 
	`£À˘Buckë
(
m≠
, 
key
);

589 i‡(
	`upd©eM≠pög
(
m≠
, 
√ighb‹hood
, 
key
, 
√wVÆue
, 
upd©e
, 
ﬁdVÆuePå
)) {

590  
UDS_SUCCESS
;

599 
Buckë
 *
buckë
;

600 (
buckë
 = 
	`födOrMakeVaˇncy
(
m≠
, 
√ighb‹hood
)Ë=
NULL
) {

607 
ªsu…
 = 
	`ªsizeBuckës
(
m≠
);

608 i‡(
ªsu…
 !
UDS_SUCCESS
) {

609  
ªsu…
;

614 
√ighb‹hood
 = 
	`£À˘Buckë
(
m≠
, 
key
);

618 
buckë
->
key
 = key;

619 
buckë
->
vÆue
 = 
√wVÆue
;

620 
	`ö£πInH›Li°
(
√ighb‹hood
, 
buckë
);

621 
m≠
->
size
 += 1;

624 i‡(
ﬁdVÆuePå
 !
NULL
) {

625 *
ﬁdVÆuePå
 = 
NULL
;

627  
UDS_SUCCESS
;

628 
	}
}

631 *
	$ötM≠Remove
(
I¡M≠
 *
m≠
, 
uöt64_t
 
key
)

634 
Buckë
 *
buckë
 = 
	`£À˘Buckë
(
m≠
, 
key
);

635 
Buckë
 *
¥evious
;

636 
Buckë
 *
vi˘im
 = 
	`£¨chH›Li°
(
m≠
, 
buckë
, 
key
, &
¥evious
);

638 i‡(
vi˘im
 =
NULL
) {

640  
NULL
;

645 
m≠
->
size
 -= 1;

646 *
vÆue
 = 
vi˘im
->value;

647 
vi˘im
->
vÆue
 = 
NULL
;

648 
vi˘im
->
key
 = 0;

652 i‡(
¥evious
 =
NULL
) {

654 
buckë
->
fú°H›
 = 
vi˘im
->
√xtH›
;

656 
¥evious
->
√xtH›
 = 
vi˘im
->nextHop;

658 
vi˘im
->
√xtH›
 = 
NULL_HOP_OFFSET
;

660  
vÆue
;

661 
	}
}

	@vdo/base/intMap.h

22 #i‚de‡
INT_MAP_H


23 
	#INT_MAP_H


	)

25 
	~"comm⁄.h
"

39 
ötM≠
 
	tI¡M≠
;

55 
	$makeI¡M≠
(
size_t
 
öôülC≠acôy
,

56 
öôülLﬂd
,

57 
I¡M≠
 **
m≠På
)

58 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

66 
	`‰ìI¡M≠
(
I¡M≠
 **
m≠På
);

75 
size_t
 
	`ötM≠Size
(c⁄° 
I¡M≠
 *
m≠
);

86 *
	`ötM≠Gë
(
I¡M≠
 *
m≠
, 
uöt64_t
 
key
);

107 
	$ötM≠Put
(
I¡M≠
 *
m≠
,

108 
uöt64_t
 
key
,

109 *
√wVÆue
,

110 
boﬁ
 
upd©e
,

111 **
ﬁdVÆuePå
)

112 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

123 *
	`ötM≠Remove
(
I¡M≠
 *
m≠
, 
uöt64_t
 
key
);

	@vdo/base/journalPoint.h

22 #i‚de‡
JOURNAL_POINT_H


23 
	#JOURNAL_POINT_H


	)

25 
	~"ty≥s.h
"

27 
uöt16_t
 
	tJou∫ÆE¡ryCou¡
;

33 
Sequí˚Numbî
 
	m£quí˚Numbî
;

34 
Jou∫ÆE¡ryCou¡
 
	míåyCou¡
;

35 } 
	tJou∫ÆPoöt
;

42 
uöt64_t
 
	mícodedPoöt
;

43 } 
	t__©åibuã__
((
	t∑cked
)Ë
	tPackedJou∫ÆPoöt
;

51 
ölöe
 
	$adv™˚Jou∫ÆPoöt
(
Jou∫ÆPoöt
 *
poöt
,

52 
Jou∫ÆE¡ryCou¡
 
íåõsPîBlock
)

54 
poöt
->
íåyCou¡
++;

55 i‡(
poöt
->
íåyCou¡
 =
íåõsPîBlock
) {

56 
poöt
->
£quí˚Numbî
++;

57 
poöt
->
íåyCou¡
 = 0;

59 
	}
}

68 
ölöe
 
boﬁ
 
	$isVÆidJou∫ÆPoöt
(c⁄° 
Jou∫ÆPoöt
 *
poöt
)

70  ((
poöt
 !
NULL
Ë&& (poöt->
£quí˚Numbî
 > 0));

71 
	}
}

82 
ölöe
 
boﬁ
 
	$bef‹eJou∫ÆPoöt
(c⁄° 
Jou∫ÆPoöt
 *
fú°
,

83 c⁄° 
Jou∫ÆPoöt
 *
£c⁄d
)

85  ((
fú°
->
£quí˚Numbî
 < 
£c⁄d
->sequenceNumber)

86 || ((
fú°
->
£quí˚Numbî
 =
£c⁄d
->sequenceNumber)

87 && (
fú°
->
íåyCou¡
 < 
£c⁄d
->entryCount)));

88 
	}
}

99 
ölöe
 
boﬁ
 
	$¨eEquivÆítJou∫ÆPoöts
(c⁄° 
Jou∫ÆPoöt
 *
fú°
,

100 c⁄° 
Jou∫ÆPoöt
 *
£c⁄d
)

102  ((
fú°
->
£quí˚Numbî
 =
£c⁄d
->sequenceNumber)

103 && (
fú°
->
íåyCou¡
 =
£c⁄d
->entryCount));

104 
	}
}

113 
ölöe
 
	$∑ckJou∫ÆPoöt
(c⁄° 
Jou∫ÆPoöt
 *
u≈acked
,

114 
PackedJou∫ÆPoöt
 *
∑cked
)

116 
∑cked
->
ícodedPoöt


117 ((
u≈acked
->
£quí˚Numbî
 << 16Ë| u≈acked->
íåyCou¡
);

118 
	}
}

127 
ölöe
 
	$u≈ackJou∫ÆPoöt
(c⁄° 
PackedJou∫ÆPoöt
 *
∑cked
,

128 
Jou∫ÆPoöt
 *
u≈acked
)

130 
u≈acked
->
£quí˚Numbî
 = (
∑cked
->
ícodedPoöt
 >> 16);

131 
u≈acked
->
íåyCou¡
 = (
∑cked
->
ícodedPoöt
 & 0xffff);

132 
	}
}

	@vdo/base/lockCounter.c

22 
	~"lockCou¡î.h
"

24 
	~"mem‹yAŒoc.h
"

25 
	~"utû/©omic.h
"

42 
	slockCou¡î
 {

44 
VDOCom∂ëi⁄
 
	mcom∂ëi⁄
;

46 
Z⁄eCou¡
 
	mlogiˇlZ⁄es
;

48 
Z⁄eCou¡
 
	mphysiˇlZ⁄es
;

50 
BlockCou¡
 
	mlocks
;

52 
AtomicBoﬁ
 
	mnŸifyög
;

54 
Atomic32
 *
	mlogiˇlZ⁄eCou¡s
;

56 
Atomic32
 *
	mphysiˇlZ⁄eCou¡s
;

58 
uöt16_t
 *
	mjou∫ÆCou¡îs
;

60 
Atomic32
 *
	mjou∫ÆDe¸emítCou¡s
;

62 
uöt16_t
 *
	mlogiˇlCou¡îs
;

64 
uöt16_t
 *
	mphysiˇlCou¡îs
;

68 
	$makeLockCou¡î
(
PhysiˇlLayî
 *
œyî
,

69 *
∑ª¡
,

70 
VDOA˘i⁄
 
ˇŒback
,

71 
ThªadID
 
thªadID
,

72 
Z⁄eCou¡
 
logiˇlZ⁄es
,

73 
Z⁄eCou¡
 
physiˇlZ⁄es
,

74 
BlockCou¡
 
locks
,

75 
LockCou¡î
 **
lockCou¡îPå
)

77 
LockCou¡î
 *
lockCou¡î
;

79 
ªsu…
 = 
	`ALLOCATE
(1, 
LockCou¡î
, 
__func__
, &
lockCou¡î
);

80 i‡(
ªsu…
 !
VDO_SUCCESS
) {

81  
ªsu…
;

84 
ªsu…
 = 
	`ALLOCATE
(
locks
, 
uöt16_t
, 
__func__
, &
lockCou¡î
->
jou∫ÆCou¡îs
);

85 i‡(
ªsu…
 !
VDO_SUCCESS
) {

86 
	`‰ìLockCou¡î
(&
lockCou¡î
);

87  
ªsu…
;

90 
ªsu…
 = 
	`ALLOCATE
(
locks
, 
Atomic32
, 
__func__
,

91 &
lockCou¡î
->
jou∫ÆDe¸emítCou¡s
);

92 i‡(
ªsu…
 !
VDO_SUCCESS
) {

93 
	`‰ìLockCou¡î
(&
lockCou¡î
);

94  
ªsu…
;

97 
ªsu…
 = 
	`ALLOCATE
(
locks
 * 
logiˇlZ⁄es
, 
uöt16_t
, 
__func__
,

98 &
lockCou¡î
->
logiˇlCou¡îs
);

99 i‡(
ªsu…
 !
VDO_SUCCESS
) {

100 
	`‰ìLockCou¡î
(&
lockCou¡î
);

101  
ªsu…
;

104 
ªsu…
 = 
	`ALLOCATE
(
locks
, 
Atomic32
, 
__func__
,

105 &
lockCou¡î
->
logiˇlZ⁄eCou¡s
);

106 i‡(
ªsu…
 !
VDO_SUCCESS
) {

107 
	`‰ìLockCou¡î
(&
lockCou¡î
);

108  
ªsu…
;

111 
ªsu…
 = 
	`ALLOCATE
(
locks
 * 
physiˇlZ⁄es
, 
uöt16_t
, 
__func__
,

112 &
lockCou¡î
->
physiˇlCou¡îs
);

113 i‡(
ªsu…
 !
VDO_SUCCESS
) {

114 
	`‰ìLockCou¡î
(&
lockCou¡î
);

115  
ªsu…
;

118 
ªsu…
 = 
	`ALLOCATE
(
locks
, 
Atomic32
, 
__func__
,

119 &
lockCou¡î
->
physiˇlZ⁄eCou¡s
);

120 i‡(
ªsu…
 !
VDO_SUCCESS
) {

121 
	`‰ìLockCou¡î
(&
lockCou¡î
);

122  
ªsu…
;

125 
ªsu…
 = 
	`öôülizeEnqueuóbÀCom∂ëi⁄
(&
lockCou¡î
->
com∂ëi⁄
,

126 
LOCK_COUNTER_COMPLETION
, 
œyî
);

127 i‡(
ªsu…
 !
VDO_SUCCESS
) {

128 
	`‰ìLockCou¡î
(&
lockCou¡î
);

129  
ªsu…
;

132 
	`£tCÆlbackWôhP¨ít
(&
lockCou¡î
->
com∂ëi⁄
, 
ˇŒback
, 
thªadID
, 
∑ª¡
);

133 
lockCou¡î
->
logiˇlZ⁄es
 =ÜogicalZones;

134 
lockCou¡î
->
physiˇlZ⁄es
 =ÖhysicalZones;

135 
lockCou¡î
->
locks
 =Üocks;

136 *
lockCou¡îPå
 = 
lockCou¡î
;

137  
VDO_SUCCESS
;

138 
	}
}

141 
	$‰ìLockCou¡î
(
LockCou¡î
 **
lockCou¡îPå
)

143 i‡(*
lockCou¡îPå
 =
NULL
) {

147 
LockCou¡î
 *
lockCou¡î
 = *
lockCou¡îPå
;

148 
	`de°royEnqueuóbÀ
(&
lockCou¡î
->
com∂ëi⁄
);

149 
	`‰ìVﬁ©ûe
(
lockCou¡î
->
physiˇlZ⁄eCou¡s
);

150 
	`‰ìVﬁ©ûe
(
lockCou¡î
->
logiˇlZ⁄eCou¡s
);

151 
	`‰ìVﬁ©ûe
(
lockCou¡î
->
jou∫ÆDe¸emítCou¡s
);

152 
	`FREE
(
lockCou¡î
->
jou∫ÆCou¡îs
);

153 
	`FREE
(
lockCou¡î
->
logiˇlCou¡îs
);

154 
	`FREE
(
lockCou¡î
->
physiˇlCou¡îs
);

155 
	`FREE
(
lockCou¡î
);

156 *
lockCou¡îPå
 = 
NULL
;

157 
	}
}

168 
ölöe
 
Atomic32
 *
	$gëZ⁄eCou¡På
(
LockCou¡î
 *
cou¡î
,

169 
BlockCou¡
 
lockNumbî
,

170 
Z⁄eTy≥
 
z⁄eTy≥
)

172  ((
z⁄eTy≥
 =
ZONE_TYPE_LOGICAL
)

173 ? &
cou¡î
->
logiˇlZ⁄eCou¡s
[
lockNumbî
]

174 : &
cou¡î
->
physiˇlZ⁄eCou¡s
[
lockNumbî
]);

175 
	}
}

187 
ölöe
 
uöt16_t
 *
	$gëCou¡î
(
LockCou¡î
 *
cou¡î
,

188 
BlockCou¡
 
lockNumbî
,

189 
Z⁄eTy≥
 
z⁄eTy≥
,

190 
Z⁄eCou¡
 
z⁄eID
)

192 
BlockCou¡
 
z⁄eCou¡î
 = (
cou¡î
->
locks
 * 
z⁄eID
Ë+ 
lockNumbî
;

193 i‡(
z⁄eTy≥
 =
ZONE_TYPE_JOURNAL
) {

194  &
cou¡î
->
jou∫ÆCou¡îs
[
z⁄eCou¡î
];

197 i‡(
z⁄eTy≥
 =
ZONE_TYPE_LOGICAL
) {

198  &
cou¡î
->
logiˇlCou¡îs
[
z⁄eCou¡î
];

201  &
cou¡î
->
physiˇlCou¡îs
[
z⁄eCou¡î
];

202 
	}
}

212 
boﬁ
 
	$isJou∫ÆZ⁄eLocked
(
LockCou¡î
 *
cou¡î
, 
BlockCou¡
 
lockNumbî
)

214 
uöt16_t
 
jou∫ÆVÆue


215 *(
	`gëCou¡î
(
cou¡î
, 
lockNumbî
, 
ZONE_TYPE_JOURNAL
, 0));

216 
uöt32_t
 
de¸emíts


217 
	`©omicLﬂd32
(&(
cou¡î
->
jou∫ÆDe¸emítCou¡s
[
lockNumbî
]));

218 
	`ASSERT_LOG_ONLY
((
de¸emíts
 <
jou∫ÆVÆue
),

221  (
jou∫ÆVÆue
 !
de¸emíts
);

222 
	}
}

225 
boﬁ
 
	$isLocked
(
LockCou¡î
 *
lockCou¡î
,

226 
BlockCou¡
 
lockNumbî
,

227 
Z⁄eTy≥
 
z⁄eTy≥
)

229 
	`ASSERT_LOG_ONLY
((
z⁄eTy≥
 !
ZONE_TYPE_JOURNAL
),

231  (
	`isJou∫ÆZ⁄eLocked
(
lockCou¡î
, 
lockNumbî
)

232 || (
	`©omicLﬂd32
(
	`gëZ⁄eCou¡På
(
lockCou¡î
, 
lockNumbî
, 
z⁄eTy≥
))

234 
	}
}

242 
	$as£πOnJou∫ÆThªad
(
LockCou¡î
 *
cou¡î
, c⁄° *
ˇŒî
)

244 
	`ASSERT_LOG_ONLY
((
	`gëCÆlbackThªadID
()

245 =
cou¡î
->
com∂ëi⁄
.
ˇŒbackThªadID
),

246 "%s(ËˇŒed from jou∫Æ z⁄e", 
ˇŒî
);

247 
	}
}

250 
	$öôülizeLockCou¡
(
LockCou¡î
 *
cou¡î
,

251 
BlockCou¡
 
lockNumbî
,

252 
uöt16_t
 
vÆue
)

254 
	`as£πOnJou∫ÆThªad
(
cou¡î
, 
__func__
);

255 
uöt16_t
 *
jou∫ÆVÆue
 = 
	`gëCou¡î
(
cou¡î
, 
lockNumbî
, 
ZONE_TYPE_JOURNAL
,

257 
Atomic32
 *
de¸emítCou¡
 = &(
cou¡î
->
jou∫ÆDe¸emítCou¡s
[
lockNumbî
]);

258 
	`ASSERT_LOG_ONLY
((*
jou∫ÆVÆue
 =
	`©omicLﬂd32
(
de¸emítCou¡
)),

261 *
jou∫ÆVÆue
 = 
vÆue
;

262 
	`©omicSt‹e32
(
de¸emítCou¡
, 0);

263 
	}
}

266 
	$acquúeLockCou¡Re„ªn˚
(
LockCou¡î
 *
cou¡î
,

267 
BlockCou¡
 
lockNumbî
,

268 
Z⁄eTy≥
 
z⁄eTy≥
,

269 
Z⁄eCou¡
 
z⁄eID
)

271 
	`ASSERT_LOG_ONLY
((
z⁄eTy≥
 !
ZONE_TYPE_JOURNAL
),

274 
uöt16_t
 *
cuºítVÆue
 = 
	`gëCou¡î
(
cou¡î
, 
lockNumbî
, 
z⁄eTy≥
, 
z⁄eID
);

275 
	`ASSERT_LOG_ONLY
(*
cuºítVÆue
 < 
UINT16_MAX
,

278 i‡(*
cuºítVÆue
 == 0) {

280 
	`©omicAdd32
(
	`gëZ⁄eCou¡På
(
cou¡î
, 
lockNumbî
, 
z⁄eTy≥
), 1);

282 *
cuºítVÆue
 += 1;

283 
	}
}

295 
uöt16_t
 
	$ªÀa£Re„ªn˚
(
LockCou¡î
 *
cou¡î
,

296 
BlockCou¡
 
lockNumbî
,

297 
Z⁄eTy≥
 
z⁄eTy≥
,

298 
Z⁄eCou¡
 
z⁄eID
)

300 
uöt16_t
 *
cuºítVÆue
 = 
	`gëCou¡î
(
cou¡î
, 
lockNumbî
, 
z⁄eTy≥
, 
z⁄eID
);

301 
	`ASSERT_LOG_ONLY
((*
cuºítVÆue
 >= 1),

304 *
cuºítVÆue
 -= 1;

305  *
cuºítVÆue
;

306 
	}
}

315 
	$©ãm±NŸifiˇti⁄
(
LockCou¡î
 *
cou¡î
)

317 i‡(
	`com∑ªAndSw≠Boﬁ
(&
cou¡î
->
nŸifyög
, 
Ál£
, 
åue
)) {

318 
	`ª£tCom∂ëi⁄
(&
cou¡î
->
com∂ëi⁄
);

319 
	`övokeCÆlback
(&
cou¡î
->
com∂ëi⁄
);

321 
	}
}

324 
	$ªÀa£LockCou¡Re„ªn˚
(
LockCou¡î
 *
cou¡î
,

325 
BlockCou¡
 
lockNumbî
,

326 
Z⁄eTy≥
 
z⁄eTy≥
,

327 
Z⁄eCou¡
 
z⁄eID
)

329 
	`ASSERT_LOG_ONLY
((
z⁄eTy≥
 !
ZONE_TYPE_JOURNAL
),

331 i‡(
	`ªÀa£Re„ªn˚
(
cou¡î
, 
lockNumbî
, 
z⁄eTy≥
, 
z⁄eID
) != 0) {

335 i‡(
	`©omicAdd32
(
	`gëZ⁄eCou¡På
(
cou¡î
, 
lockNumbî
, 
z⁄eTy≥
), -1) == 0) {

338 
	`©ãm±NŸifiˇti⁄
(
cou¡î
);

340 
	}
}

343 
	$ªÀa£Jou∫ÆZ⁄eRe„ªn˚
(
LockCou¡î
 *
cou¡î
, 
BlockCou¡
 
lockNumbî
)

345 
	`as£πOnJou∫ÆThªad
(
cou¡î
, 
__func__
);

346 
	`ªÀa£Re„ªn˚
(
cou¡î
, 
lockNumbî
, 
ZONE_TYPE_JOURNAL
, 0);

347 i‡(!
	`isJou∫ÆZ⁄eLocked
(
cou¡î
, 
lockNumbî
)) {

349 
	`©ãm±NŸifiˇti⁄
(
cou¡î
);

351 
	}
}

354 
	$ªÀa£Jou∫ÆZ⁄eRe„ªn˚FromOthîZ⁄e
(
LockCou¡î
 *
cou¡î
,

355 
BlockCou¡
 
lockNumbî
)

357 
	`©omicAdd32
(&(
cou¡î
->
jou∫ÆDe¸emítCou¡s
[
lockNumbî
]), 1);

358 
	}
}

361 
	$acknowÀdgeU∆ock
(
LockCou¡î
 *
cou¡î
)

363 
	`©omicSt‹eBoﬁ
(&
cou¡î
->
nŸifyög
, 
Ál£
);

364 
	}
}

	@vdo/base/lockCounter.h

22 #i‚de‡
LOCK_COUNTER_H


23 
	#LOCK_COUNTER_H


	)

25 
	~"com∂ëi⁄.h
"

26 
	~"ty≥s.h
"

59 
	$makeLockCou¡î
(
PhysiˇlLayî
 *
œyî
,

60 *
∑ª¡
,

61 
VDOA˘i⁄
 
ˇŒback
,

62 
ThªadID
 
thªadID
,

63 
Z⁄eCou¡
 
logiˇlZ⁄es
,

64 
Z⁄eCou¡
 
physiˇlZ⁄es
,

65 
BlockCou¡
 
locks
,

66 
LockCou¡î
 **
lockCou¡îPå
)

67 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

74 
	`‰ìLockCou¡î
(
LockCou¡î
 **
lockCou¡îPå
);

87 
boﬁ
 
	$isLocked
(
LockCou¡î
 *
lockCou¡î
,

88 
BlockCou¡
 
lockNumbî
,

89 
Z⁄eTy≥
 
z⁄eTy≥
)

90 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

100 
	`öôülizeLockCou¡
(
LockCou¡î
 *
cou¡î
,

101 
BlockCou¡
 
lockNumbî
,

102 
uöt16_t
 
vÆue
);

113 
	`acquúeLockCou¡Re„ªn˚
(
LockCou¡î
 *
cou¡î
,

114 
BlockCou¡
 
lockNumbî
,

115 
Z⁄eTy≥
 
z⁄eTy≥
,

116 
Z⁄eCou¡
 
z⁄eID
);

127 
	`ªÀa£LockCou¡Re„ªn˚
(
LockCou¡î
 *
cou¡î
,

128 
BlockCou¡
 
lockNumbî
,

129 
Z⁄eTy≥
 
z⁄eTy≥
,

130 
Z⁄eCou¡
 
z⁄eID
);

139 
	`ªÀa£Jou∫ÆZ⁄eRe„ªn˚
(
LockCou¡î
 *
cou¡î
, 
BlockCou¡
 
lockNumbî
);

149 
	`ªÀa£Jou∫ÆZ⁄eRe„ªn˚FromOthîZ⁄e
(
LockCou¡î
 *
cou¡î
,

150 
BlockCou¡
 
lockNumbî
);

158 
	`acknowÀdgeU∆ock
(
LockCou¡î
 *
cou¡î
);

	@vdo/base/logicalZone.c

22 
	~"logiˇlZ⁄e.h
"

24 
	~"loggî.h
"

25 
	~"mem‹yAŒoc.h
"

26 
	~"utû/©omic.h
"

28 
	~"blockM≠.h
"

29 
	~"com∂ëi⁄.h
"

30 
	~"c⁄°™ts.h
"

31 
	~"d©aVIO.h
"

32 
	~"Êush.h
"

33 
	~"ötM≠.h
"

34 
	~"vdoI¡î«l.h
"

36 
	slogiˇlZ⁄e
 {

38 
VDOCom∂ëi⁄
 
	mcom∂ëi⁄
;

40 
Z⁄eCou¡
 
	mz⁄eNumbî
;

42 
LogiˇlZ⁄e
 *
	m√xtZ⁄e
;

44 
ThªadD©a
 *
	mthªadD©a
;

46 
I¡M≠
 *
	mlbnO≥øti⁄s
;

48 
BlockM≠Z⁄e
 *
	mblockM≠Z⁄e
;

50 
Sequí˚Numbî
 
	mÊushGíî©i⁄
;

52 
Sequí˚Numbî
 
	mﬁde°A˘iveGíî©i⁄
;

54 
BlockCou¡
 
	miosInFlushGíî©i⁄
;

59 
Atomic64
 
	mﬁde°LockedGíî©i⁄
;

61 
Sequí˚Numbî
 
	mnŸifiˇti⁄Gíî©i⁄
;

63 
boﬁ
 
	mnŸifyög
;

65 
RögNode
 
	mwrôeVIOs
;

67 
VDO
 *
	mvdo
;

69 
VDOCom∂ëi⁄
 *
	m˛o£Com∂ëi⁄
;

71 
boﬁ
 
	m˛o£Reque°ed
;

81 
LogiˇlZ⁄e
 *
	$asLogiˇlZ⁄e
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

83 
	`STATIC_ASSERT
(
	`off£tof
(
LogiˇlZ⁄e
, 
com∂ëi⁄
) == 0);

84 
	`as£πCom∂ëi⁄Ty≥
(
com∂ëi⁄
->
ty≥
, 
GENERATION_FLUSHED_COMPLETION
);

85  (
LogiˇlZ⁄e
 *Ë
com∂ëi⁄
;

86 
	}
}

89 
	$makeLogiˇlZ⁄e
(
VDO
 *
vdo
,

90 
Z⁄eCou¡
 
z⁄eNumbî
,

91 
LogiˇlZ⁄e
 *
√xtZ⁄e
,

92 
LogiˇlZ⁄e
 **
z⁄ePå
)

94 
LogiˇlZ⁄e
 *
z⁄e
;

95 
ªsu…
 = 
	`ALLOCATE
(1, 
LogiˇlZ⁄e
, 
__func__
, &
z⁄e
);

96 i‡(
ªsu…
 !
VDO_SUCCESS
) {

97  
ªsu…
;

100 
ªsu…
 = 
	`makeI¡M≠
(
LOCK_MAP_CAPACITY
, 0, &
z⁄e
->
lbnO≥øti⁄s
);

101 i‡(
ªsu…
 !
VDO_SUCCESS
) {

102 
	`‰ìLogiˇlZ⁄e
(&
z⁄e
);

103  
ªsu…
;

106 
ªsu…
 = 
	`öôülizeEnqueuóbÀCom∂ëi⁄
(&
z⁄e
->
com∂ëi⁄
,

107 
GENERATION_FLUSHED_COMPLETION
,

108 
vdo
->
œyî
);

109 i‡(
ªsu…
 !
VDO_SUCCESS
) {

110 
	`‰ìLogiˇlZ⁄e
(&
z⁄e
);

111  
ªsu…
;

114 
ThªadID
 
thªadID
 = 
	`gëLogiˇlZ⁄eThªad
(
	`gëThªadC⁄fig
(
vdo
), 
z⁄eNumbî
);

115 
z⁄e
->
z⁄eNumbî
 = zoneNumber;

116 
z⁄e
->
√xtZ⁄e
 =ÇextZone;

117 
z⁄e
->
thªadD©a
 = &
vdo
->thªadD©a[
thªadID
];

118 
z⁄e
->
blockM≠Z⁄e
 = 
	`gëBlockM≠Z⁄e
(
vdo
->
blockM≠
, 
z⁄eNumbî
);

119 
z⁄e
->
vdo
 = vdo;

120 
	`öôülizeRög
(&
z⁄e
->
wrôeVIOs
);

121 
	`©omicSt‹e64
(&
z⁄e
->
ﬁde°LockedGíî©i⁄
, 0);

123 *
z⁄ePå
 = 
z⁄e
;

124  
VDO_SUCCESS
;

125 
	}
}

128 
	$‰ìLogiˇlZ⁄e
(
LogiˇlZ⁄e
 **
logiˇlZ⁄ePå
)

130 i‡(*
logiˇlZ⁄ePå
 =
NULL
) {

134 
LogiˇlZ⁄e
 *
z⁄e
 = *
logiˇlZ⁄ePå
;

135 
	`de°royEnqueuóbÀ
(&
z⁄e
->
com∂ëi⁄
);

136 
	`‰ìI¡M≠
(&
z⁄e
->
lbnO≥øti⁄s
);

137 
	`FREE
(
z⁄e
);

138 *
logiˇlZ⁄ePå
 = 
NULL
;

139 
	}
}

142 
ölöe
 
	$as£πOnZ⁄eThªad
(
LogiˇlZ⁄e
 *
z⁄e
, c⁄° *
wh©
)

144 
	`ASSERT_LOG_ONLY
((
	`gëCÆlbackThªadID
(Ë=
z⁄e
->
thªadD©a
->
thªadID
),

145 "%s(ËˇŒed o¿c‹ª˘Åhªad", 
wh©
);

146 
	}
}

153 
	$˛o£LogiˇlZ⁄eCÆlback
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

155 
LogiˇlZ⁄e
 *
z⁄e
 = 
	`asLogiˇlZ⁄e
(
com∂ëi⁄
);

156 
	`˛o£LogiˇlZ⁄e
(
	`gëNextLogiˇlZ⁄e
(
z⁄e
), 
com∂ëi⁄
->
∑ª¡
);

157 
	}
}

164 
	$checkF‹Closuª
(
LogiˇlZ⁄e
 *
z⁄e
)

166 i‡((
z⁄e
->
˛o£Com∂ëi⁄
 =
NULL
Ë|| z⁄e->
nŸifyög


167 || !
	`isRögEm±y
(&
z⁄e
->
wrôeVIOs
)) {

171 
VDOCom∂ëi⁄
 *
˛o£Com∂ëi⁄
 = 
z⁄e
->closeCompletion;

172 
z⁄e
->
˛o£Com∂ëi⁄
 = 
NULL
;

174 i‡(
z⁄e
->
√xtZ⁄e
 =
NULL
) {

176 
	`föishCom∂ëi⁄
(
˛o£Com∂ëi⁄
, 
VDO_SUCCESS
);

181 
z⁄e
->
nŸifyög
 = 
åue
;

182 
	`œunchCÆlbackWôhP¨ít
(&
z⁄e
->
com∂ëi⁄
, 
˛o£LogiˇlZ⁄eCÆlback
,

183 
	`gëLogiˇlZ⁄eThªadID
(
z⁄e
->
√xtZ⁄e
),

184 
˛o£Com∂ëi⁄
);

185 
	}
}

188 
	$˛o£LogiˇlZ⁄e
(
LogiˇlZ⁄e
 *
z⁄e
, 
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

190 
	`as£πOnZ⁄eThªad
(
z⁄e
, 
__func__
);

191 i‡(
z⁄e
->
˛o£Com∂ëi⁄
 !
NULL
) {

192 
	`föishCom∂ëi⁄
(
com∂ëi⁄
, 
VDO_COMPONENT_BUSY
);

196 
z⁄e
->
˛o£Reque°ed
 = 
åue
;

197 
z⁄e
->
˛o£Com∂ëi⁄
 = 
com∂ëi⁄
;

198 
	`checkF‹Closuª
(
z⁄e
);

199 
	}
}

202 
ThªadID
 
	$gëLogiˇlZ⁄eThªadID
(c⁄° 
LogiˇlZ⁄e
 *
z⁄e
)

204  
z⁄e
->
thªadD©a
->
thªadID
;

205 
	}
}

208 
BlockM≠Z⁄e
 *
	$gëBlockM≠F‹Z⁄e
(c⁄° 
LogiˇlZ⁄e
 *
z⁄e
)

210  
z⁄e
->
blockM≠Z⁄e
;

211 
	}
}

214 
I¡M≠
 *
	$gëLBNLockM≠
(c⁄° 
LogiˇlZ⁄e
 *
z⁄e
)

216  
z⁄e
->
lbnO≥øti⁄s
;

217 
	}
}

220 
LogiˇlZ⁄e
 *
	$gëNextLogiˇlZ⁄e
(c⁄° 
LogiˇlZ⁄e
 *
z⁄e
)

222  
z⁄e
->
√xtZ⁄e
;

223 
	}
}

232 
ölöe
 
D©aVIO
 *
	$d©aVIOFromRögNode
(
RögNode
 *
rögNode
)

234  (
D©aVIO
 *Ë((
byã
 *Ë
rögNode
 - 
	`off£tof
(D©aVIO, 
wrôeNode
));

235 
	}
}

245 
boﬁ
 
	$upd©eOlde°A˘iveGíî©i⁄
(
LogiˇlZ⁄e
 *
z⁄e
)

247 
Sequí˚Numbî
 
cuºítOlde°
 = 
z⁄e
->
ﬁde°A˘iveGíî©i⁄
;

248 i‡(
	`isRögEm±y
(&
z⁄e
->
wrôeVIOs
)) {

249 
z⁄e
->
ﬁde°A˘iveGíî©i⁄
 = z⁄e->
ÊushGíî©i⁄
;

251 
z⁄e
->
ﬁde°A˘iveGíî©i⁄


252 
	`d©aVIOFromRögNode
(
z⁄e
->
wrôeVIOs
.
√xt
)->
ÊushGíî©i⁄
;

255 i‡(
z⁄e
->
ﬁde°A˘iveGíî©i⁄
 =
cuºítOlde°
) {

256  
Ál£
;

259 
	`©omicSt‹e64
(&
z⁄e
->
ﬁde°LockedGíî©i⁄
, z⁄e->
ﬁde°A˘iveGíî©i⁄
);

260  
åue
;

261 
	}
}

264 
	$ö¸emítFlushGíî©i⁄
(
LogiˇlZ⁄e
 *
z⁄e
,

265 
Sequí˚Numbî
 
ex≥˘edGíî©i⁄
)

267 
	`as£πOnZ⁄eThªad
(
z⁄e
, 
__func__
);

268 
	`ASSERT_LOG_ONLY
((
z⁄e
->
ÊushGíî©i⁄
 =
ex≥˘edGíî©i⁄
),

269 "logiˇ»z⁄ê%u flush gíî©i⁄ %" 
PRIu64


270 " should bê%" 
PRIu64
 " before increment",

271 
z⁄e
->
z⁄eNumbî
, z⁄e->
ÊushGíî©i⁄
,

272 
ex≥˘edGíî©i⁄
);

274 
z⁄e
->
ÊushGíî©i⁄
++;

275 
z⁄e
->
iosInFlushGíî©i⁄
 = 0;

276 
	`upd©eOlde°A˘iveGíî©i⁄
(
z⁄e
);

277 
	}
}

280 
Sequí˚Numbî
 
	$gëOlde°LockedGíî©i⁄
(c⁄° 
LogiˇlZ⁄e
 *
z⁄e
)

282  (
Sequí˚Numbî
Ë
	`©omicLﬂd64
(&
z⁄e
->
ﬁde°LockedGíî©i⁄
);

283 
	}
}

286 
	$acquúeFlushGíî©i⁄Lock
(
D©aVIO
 *
d©aVIO
)

288 
LogiˇlZ⁄e
 *
z⁄e
 = 
d©aVIO
->
logiˇl
.zone;

289 
	`as£πOnZ⁄eThªad
(
z⁄e
, 
__func__
);

290 i‡(
z⁄e
->
˛o£Reque°ed
 && (z⁄e->
˛o£Com∂ëi⁄
 =
NULL
)) {

291  
VDO_SHUTTING_DOWN
;

294 
d©aVIO
->
ÊushGíî©i⁄
 = 
z⁄e
->flushGeneration;

295 
	`pushRögNode
(&
z⁄e
->
wrôeVIOs
, &
d©aVIO
->
wrôeNode
);

296 
d©aVIO
->
hasFlushGíî©i⁄Lock
 = 
åue
;

297 
z⁄e
->
iosInFlushGíî©i⁄
++;

298  
VDO_SUCCESS
;

299 
	}
}

302 
©ãm±Gíî©i⁄Com∂ëeNŸifiˇti⁄
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
);

310 
	$nŸifyFlushî
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

312 
LogiˇlZ⁄e
 *
z⁄e
 = 
	`asLogiˇlZ⁄e
(
com∂ëi⁄
);

313 
	`com∂ëeFlushes
(
z⁄e
->
vdo
->
Êushî
);

314 
	`œunchCÆlback
(
com∂ëi⁄
, 
©ãm±Gíî©i⁄Com∂ëeNŸifiˇti⁄
,

315 
z⁄e
->
thªadD©a
->
thªadID
);

316 
	}
}

323 
	$©ãm±Gíî©i⁄Com∂ëeNŸifiˇti⁄
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

325 
LogiˇlZ⁄e
 *
z⁄e
 = 
	`asLogiˇlZ⁄e
(
com∂ëi⁄
);

326 
	`as£πOnZ⁄eThªad
(
z⁄e
, 
__func__
);

327 i‡(
z⁄e
->
ﬁde°A˘iveGíî©i⁄
 <z⁄e->
nŸifiˇti⁄Gíî©i⁄
) {

328 
z⁄e
->
nŸifyög
 = 
Ál£
;

329 
	`checkF‹Closuª
(
z⁄e
);

333 
z⁄e
->
nŸifyög
 = 
åue
;

334 
z⁄e
->
nŸifiˇti⁄Gíî©i⁄
 = z⁄e->
ﬁde°A˘iveGíî©i⁄
;

335 
	`œunchCÆlback
(&
z⁄e
->
com∂ëi⁄
, 
nŸifyFlushî
,

336 
	`gëFlushîThªadID
(
z⁄e
->
vdo
->
Êushî
));

337 
	}
}

340 
	$ªÀa£FlushGíî©i⁄Lock
(
D©aVIO
 *
d©aVIO
)

342 
LogiˇlZ⁄e
 *
z⁄e
 = 
d©aVIO
->
logiˇl
.zone;

343 
	`as£πOnZ⁄eThªad
(
z⁄e
, 
__func__
);

344 i‡(
	`isRögEm±y
(&
d©aVIO
->
wrôeNode
)) {

347 
	`ASSERT_LOG_ONLY
(!
d©aVIO
->
hasFlushGíî©i⁄Lock
,

352 
	`un•li˚RögNode
(&
d©aVIO
->
wrôeNode
);

353 
d©aVIO
->
hasFlushGíî©i⁄Lock
 = 
Ál£
;

354 
	`ASSERT_LOG_ONLY
(
z⁄e
->
ﬁde°A˘iveGíî©i⁄
 <
d©aVIO
->
ÊushGíî©i⁄
,

355 "D©aVIOÑñósögÜock o¿gíî©i⁄ %" 
PRIu64


356 " i†nŸ oldîÅh™ olde°á˘ivêgíî©i⁄ %" 
PRIu64
,

357 
d©aVIO
->
ÊushGíî©i⁄
, 
z⁄e
->
ﬁde°A˘iveGíî©i⁄
);

359 i‡(!
	`upd©eOlde°A˘iveGíî©i⁄
(
z⁄e
Ë|| z⁄e->
nŸifyög
) {

363 
	`©ãm±Gíî©i⁄Com∂ëeNŸifiˇti⁄
(&
z⁄e
->
com∂ëi⁄
);

364 
	}
}

367 
	$dumpLogiˇlZ⁄e
(c⁄° 
LogiˇlZ⁄e
 *
z⁄e
)

369 
	`logInfo
("LogiˇlZ⁄ê%u", 
z⁄e
->
z⁄eNumbî
);

370 
	`logInfo
(" flushGíî©i⁄=%" 
PRIu64
 " oldestActiveGeneration=%" PRIu64

371 " olde°LockedGíî©i⁄=%" 
PRIu64
 "ÇotificationGeneration=%" PRIu64

372 "ÇŸifyög=%†iosInCuºítGíî©i⁄=%" 
PRIu64
,

373 
z⁄e
->
ÊushGíî©i⁄
, z⁄e->
ﬁde°A˘iveGíî©i⁄
,

374 
	`ªœxedLﬂd64
(&
z⁄e
->
ﬁde°LockedGíî©i⁄
),

375 
z⁄e
->
nŸifiˇti⁄Gíî©i⁄
, 
	`boﬁToSåög
(z⁄e->
nŸifyög
),

376 
z⁄e
->
iosInFlushGíî©i⁄
);

377 
	}
}

	@vdo/base/logicalZone.h

22 #i‚de‡
LOGICAL_ZONE_H


23 
	#LOGICAL_ZONE_H


	)

25 
	~"ötM≠.h
"

26 
	~"ty≥s.h
"

38 
	$makeLogiˇlZ⁄e
(
VDO
 *
vdo
,

39 
Z⁄eCou¡
 
z⁄eNumbî
,

40 
LogiˇlZ⁄e
 *
√xtZ⁄e
,

41 
LogiˇlZ⁄e
 **
z⁄ePå
)

42 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

49 
	`‰ìLogiˇlZ⁄e
(
LogiˇlZ⁄e
 **
z⁄ePå
);

57 
	`˛o£LogiˇlZ⁄e
(
LogiˇlZ⁄e
 *
z⁄e
, 
VDOCom∂ëi⁄
 *
com∂ëi⁄
);

66 
ThªadID
 
	$gëLogiˇlZ⁄eThªadID
(c⁄° 
LogiˇlZ⁄e
 *
z⁄e
)

67 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

76 
BlockM≠Z⁄e
 *
	$gëBlockM≠F‹Z⁄e
(c⁄° 
LogiˇlZ⁄e
 *
z⁄e
)

77 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

86 
I¡M≠
 *
	$gëLBNLockM≠
(c⁄° 
LogiˇlZ⁄e
 *
z⁄e
)

87 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

98 
LogiˇlZ⁄e
 *
	$gëNextLogiˇlZ⁄e
(c⁄° 
LogiˇlZ⁄e
 *
z⁄e
)

99 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

108 
	`ö¸emítFlushGíî©i⁄
(
LogiˇlZ⁄e
 *
z⁄e
,

109 
Sequí˚Numbî
 
ex≥˘edGíî©i⁄
);

118 
Sequí˚Numbî
 
	$gëOlde°LockedGíî©i⁄
(c⁄° 
LogiˇlZ⁄e
 *
z⁄e
)

119 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

128 
	$acquúeFlushGíî©i⁄Lock
(
D©aVIO
 *
d©aVIO
)

129 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

139 
	`ªÀa£FlushGíî©i⁄Lock
(
D©aVIO
 *
d©aVIO
);

147 
	`dumpLogiˇlZ⁄e
(c⁄° 
LogiˇlZ⁄e
 *
z⁄e
);

	@vdo/base/lz4.c

23 
	~"comm⁄.h
"

72 
	#MEMORY_USAGE
 14

	)

80 
	#NOTCOMPRESSIBLE_DETECTIONLEVEL
 6

	)

94 #i‡(
deföed
(
__x86_64__
Ë|| deföed(
__x86_64
Ë|| deföed(
__amd64__
Ë|| deföed(
__amd64
Ë|| deföed(
__µc64__
Ë|| deföed(
_WIN64
Ë|| deföed(
__LP64__
Ë|| deföed(
_LP64
) )

95 
	#LZ4_ARCH64
 1

	)

97 
	#LZ4_ARCH64
 0

	)

102 #i‡
deföed
 (
__GLIBC__
)

103 
	~<ídün.h
>

104 #i‡(
__BYTE_ORDER
 =
__BIG_ENDIAN
)

105 
	#LZ4_BIG_ENDIAN
 1

	)

107 #ñi‡(
deföed
(
__BIG_ENDIAN__
Ë|| deföed(
__BIG_ENDIAN
Ë|| deföed(
_BIG_ENDIAN
)Ë&& !(deföed(
__LITTLE_ENDIAN__
Ë|| deföed(
__LITTLE_ENDIAN
Ë|| deföed(
_LITTLE_ENDIAN
))

108 
	#LZ4_BIG_ENDIAN
 1

	)

109 #ñi‡
deföed
(
__•¨c
Ë|| deföed(
__•¨c__
) \

110 || 
deföed
(
__µc__
Ë|| deföed(
_POWER
Ë|| deföed(
__powîpc__
Ë|| deföed(
_ARCH_PPC
Ë|| deföed(
__PPC__
Ë|| deföed(
__PPC
Ë|| deföed(
PPC
Ë|| deföed(__powîpc__Ë|| deföed(
__powîpc
Ë|| deföed(
powîpc
) \

111 || 
deföed
(
__hpux
Ë|| deföed(
__hµa
) \

112 || 
deföed
(
_MIPSEB
Ë|| 
	$deföed
(
__s390__
)

113 
	#LZ4_BIG_ENDIAN
 1

	)

121 #i‡
	`deföed
(
__ARM_FEATURE_UNALIGNED
)

122 
	#LZ4_FORCE_UNALIGNED_ACCESS
 1

	)

126 #i‡
	`deföed
(
_MSC_VER
Ë&& deföed(
_WIN32_WCE
)

127 
	#LZ4_FORCE_SW_BITCOUNT


	)

134 #i‡
__STDC_VERSION__
 >= 199901L

137 
	#ª°ri˘


139 

	)

140 
	#_GCC_VERSION
 (
__GNUC__
 * 100 + 
__GNUC_MINOR__
)

	)

142 #ifde‡
_MSC_VER


143 
	~<öåö.h
>

144 #i‡
LZ4_ARCH64


145 #¥agm®
	`öåösic
(
_BôSˇnF‹w¨d64
)

146 #¥agm®
	`öåösic
(
_BôSˇnRevî£64
)

148 #¥agm®
	`öåösic
(
_BôSˇnF‹w¨d
)

149 #¥agm®
	`öåösic
(
_BôSˇnRevî£
)

153 #ifde‡
_MSC_VER


154 
	#lz4_bsw≠16
(
x
Ë
	`_byãsw≠_ush‹t
(x)

	)

156 
	#lz4_bsw≠16
(
x
Ë((Ë((((xË>> 8Ë& 0xffuË| (((xË& 0xffuË<< 8)))

	)

159 #i‡(
_GCC_VERSION
 >302Ë|| (
__INTEL_COMPILER
 >800Ë|| 
	`deföed
(
__˛™g__
)

160 
	#ex≥˘
(
ex¥
,
vÆue
Ë(
	`__buûtö_ex≥˘
 (”x¥),(vÆue)Ë)

	)

162 
	#ex≥˘
(
ex¥
,
vÆue
Ë”x¥)

	)

168 #ifde‡
__KERNEL__


169 
	~<löux/°rög.h
>

171 
	~<°dlib.h
>

172 
	~<°rög.h
>

174 
	~"lz4.h
"

180 #i‡
	`deföed
(
_MSC_VER
)

181 
	#BYTE
 
__öt8


	)

182 
	#U16
 
__öt16


	)

183 
	#U32
 
__öt32


	)

184 
	#S32
 
__öt32


	)

185 
	#U64
 
__öt64


	)

187 #ifde‡
__KERNEL__


188 
	~<löux/ty≥s.h
>

190 
	~<°döt.h
>

192 
	#BYTE
 
uöt8_t


	)

193 
	#U16
 
uöt16_t


	)

194 
	#U32
 
uöt32_t


	)

195 
	#S32
 
öt32_t


	)

196 
	#U64
 
uöt64_t


	)

199 #i‚de‡
LZ4_FORCE_UNALIGNED_ACCESS


200 #¥agm®
	`∑ck
(
push
, 1)

203 
	s_U16_S
 { 
U16
 
v
; } 
	tU16_S
;

204 
	s_U32_S
 { 
U32
 
v
; } 
	tU32_S
;

205 
	s_U64_S
 { 
U64
 
v
; } 
	tU64_S
;

207 #i‚de‡
LZ4_FORCE_UNALIGNED_ACCESS


208 #¥agm®
	`∑ck
(
p›
)

211 
	#A64
(
x
Ë(((
U64_S
 *)(x))->
v
)

	)

212 
	#A32
(
x
Ë(((
U32_S
 *)(x))->
v
)

	)

213 
	#A16
(
x
Ë(((
U16_S
 *)(x))->
v
)

	)

219 
	#MINMATCH
 4

	)

221 
	#HASH_LOG
 (
MEMORY_USAGE
-2)

	)

222 
	#HASHTABLESIZE
 (1 << 
HASH_LOG
)

	)

223 
	#HASH_MASK
 (
HASHTABLESIZE
 - 1)

	)

225 
	#SKIPSTRENGTH
 (
NOTCOMPRESSIBLE_DETECTIONLEVEL
>2?NOTCOMPRESSIBLE_DETECTIONLEVEL:2)

	)

226 
	#STACKLIMIT
 13

	)

227 
	#HEAPMODE
 (
HASH_LOG
>
STACKLIMIT
)

228 
	#COPYLENGTH
 8

	)

229 
	#LASTLITERALS
 5

	)

230 
	#MFLIMIT
 (
COPYLENGTH
+
MINMATCH
)

	)

231 
	#MINLENGTH
 (
MFLIMIT
+1)

	)

233 
	#MAXD_LOG
 16

	)

234 
	#MAX_DISTANCE
 ((1 << 
MAXD_LOG
Ë- 1)

	)

236 
	#ML_BITS
 4

	)

237 
	#ML_MASK
 ((1U<<
ML_BITS
)-1)

	)

238 
	#RUN_BITS
 (8-
ML_BITS
)

	)

239 
	#RUN_MASK
 ((1U<<
RUN_BITS
)-1)

	)

244 #unde‡
STACKLIMIT


245 
	#STACKLIMIT
 0

	)

251 #i‡
LZ4_ARCH64


252 
	#STEPSIZE
 8

	)

253 
	#UARCH
 
U64


	)

254 
	#AARCH
 
A64


	)

255 
	#LZ4_COPYSTEP
(
s
,
d
Ë
	`A64
(dËA64(s); d+=8; s+=8;

	)

256 
	#LZ4_COPYPACKET
(
s
,
d
Ë
	`LZ4_COPYSTEP
(s,d)

	)

257 
	#LZ4_SECURECOPY
(
s
,
d
,
e
Ëi‡(d<eË
	`LZ4_WILDCOPY
(s,d,e)

	)

258 
	#HTYPE
 
U32


	)

259 
	#INITBASE
(
ba£
Ëc⁄° 
BYTE
* c⁄° ba£ = 
ù


	)

261 
	#STEPSIZE
 4

	)

262 
	#UARCH
 
U32


	)

263 
	#AARCH
 
A32


	)

264 
	#LZ4_COPYSTEP
(
s
,
d
Ë
	`A32
(dËA32(s); d+=4; s+=4;

	)

265 
	#LZ4_COPYPACKET
(
s
,
d
Ë
	`LZ4_COPYSTEP
(s,d); LZ4_COPYSTEP(s,d);

	)

266 
	#LZ4_SECURECOPY
 
LZ4_WILDCOPY


	)

267 
	#HTYPE
 c⁄° 
BYTE
*

	)

268 
	#INITBASE
(
ba£
Ëc⁄° ba£ = 0

	)

271 #i‡(
	`deföed
(
LZ4_BIG_ENDIAN
Ë&& !deföed(
BIG_ENDIAN_NATIVE_BUT_INCOMPATIBLE
))

272 
	#LZ4_READ_LITTLEENDIAN_16
(
d
,
s
,
p
Ë{ 
U16
 
v
 = 
	`A16
’); v = 
	`lz4_bsw≠16
(v); d = (sË- v; 
	}

	)
}

273 
	#LZ4_WRITE_LITTLEENDIAN_16
(
p
,
i
Ë{ 
U16
 
v
 = (U16)(i); v = 
	`lz4_bsw≠16
(v); 
	`A16
’Ëv;Ö+=2; }

	)

275 
	#LZ4_READ_LITTLEENDIAN_16
(
d
,
s
,
p
Ë{ d = (sË- 
	`A16
’); }

	)

276 
	#LZ4_WRITE_LITTLEENDIAN_16
(
p
,
v
Ë{ 
	`A16
’Ëv;Ö+=2; }

	)

283 
	sªfTabÀs


285 
HTYPE
 
	mhashTabÀ
[
HASHTABLESIZE
];

292 
	#LZ4_HASH_FUNCTION
(
i
Ë(((iË* 2654435761UË>> ((
MINMATCH
*8)-
HASH_LOG
))

	)

293 
	#LZ4_HASH_VALUE
(
p
Ë
	`LZ4_HASH_FUNCTION
(
	`A32
’))

	)

294 
	#LZ4_WILDCOPY
(
s
,
d
,
e
Ëdÿ{ 
	`LZ4_COPYPACKET
(s,dË} d<e);

	)

295 
	#LZ4_BLINDCOPY
(
s
,
d
,
l
Ë{ 
BYTE
* 
e
=(d)+l; 
	`LZ4_WILDCOPY
(s,d,e); dÛ; }

	)

301 #i‡
LZ4_ARCH64


303 
ölöe
 
	$LZ4_NbComm⁄Byãs
 (
U64
 
vÆ
)

305 #i‡
	`deföed
(
LZ4_BIG_ENDIAN
)

306 #i‡
	`deföed
(
_MSC_VER
Ë&& !deföed(
LZ4_FORCE_SW_BITCOUNT
)

307 
r
 = 0;

308 
	`_BôSˇnRevî£64
–&
r
, 
vÆ
 );

309  ()(
r
>>3);

310 #ñi‡
	`deföed
(
__GNUC__
Ë&& (
_GCC_VERSION
 >304Ë&& !deföed(
LZ4_FORCE_SW_BITCOUNT
)

311  (
	`__buûtö_˛zŒ
(
vÆ
) >> 3);

313 
r
;

314 i‡(!(
vÆ
>>32)Ë{ 
r
=4; } {Ñ=0; val>>=32; }

315 i‡(!(
vÆ
>>16)Ë{ 
r
+=2; val>>=8; } { val>>=24; }

316 
r
 +(!
vÆ
);

317  
r
;

320 #i‡
	`deföed
(
_MSC_VER
Ë&& !deföed(
LZ4_FORCE_SW_BITCOUNT
)

321 
r
 = 0;

322 
	`_BôSˇnF‹w¨d64
–&
r
, 
vÆ
 );

323  ()(
r
>>3);

324 #ñi‡
	`deföed
(
__GNUC__
Ë&& (
_GCC_VERSION
 >304Ë&& !deföed(
LZ4_FORCE_SW_BITCOUNT
)

325  (
	`__buûtö_˘zŒ
(
vÆ
) >> 3);

327 c⁄° 
DeBruijnByãPos
[64] = { 0, 0, 0, 0, 0, 1, 1, 2, 0, 3, 1, 3, 1, 4, 2, 7, 0, 2, 3, 6, 1, 5, 3, 5, 1, 3, 4, 4, 2, 5, 6, 7, 7, 0, 1, 2, 3, 3, 4, 6, 2, 6, 5, 5, 3, 4, 5, 6, 7, 1, 2, 4, 6, 4, 4, 5, 7, 2, 6, 5, 7, 6, 7, 7 };

328  
DeBruijnByãPos
[((
U64
)((
vÆ
 & -val) * 0x0218A392CDABBD3F)) >> 58];

331 
	}
}

335 
ölöe
 
	$LZ4_NbComm⁄Byãs
 (
U32
 
vÆ
)

337 #i‡
	`deföed
(
LZ4_BIG_ENDIAN
)

338 #i‡
	`deföed
(
_MSC_VER
Ë&& !deföed(
LZ4_FORCE_SW_BITCOUNT
)

339 
r
 = 0;

340 
	`_BôSˇnRevî£
–&
r
, 
vÆ
 );

341  ()(
r
>>3);

342 #ñi‡
	`deföed
(
__GNUC__
Ë&& (
_GCC_VERSION
 >304Ë&& !deföed(
LZ4_FORCE_SW_BITCOUNT
)

343  (
	`__buûtö_˛z
(
vÆ
) >> 3);

345 
r
;

346 i‡(!(
vÆ
>>16)Ë{ 
r
=2; val>>=8; } {Ñ=0; val>>=24; }

347 
r
 +(!
vÆ
);

348  
r
;

351 #i‡
	`deföed
(
_MSC_VER
Ë&& !deföed(
LZ4_FORCE_SW_BITCOUNT
)

352 
r
 = 0;

353 
	`_BôSˇnF‹w¨d
–&
r
, 
vÆ
 );

354  ()(
r
>>3);

355 #ñi‡
	`deföed
(
__GNUC__
Ë&& (
_GCC_VERSION
 >304Ë&& !deföed(
LZ4_FORCE_SW_BITCOUNT
)

356  (
	`__buûtö_˘z
(
vÆ
) >> 3);

358 c⁄° 
DeBruijnByãPos
[32] = { 0, 0, 3, 0, 3, 1, 3, 0, 3, 2, 2, 1, 3, 2, 0, 1, 3, 3, 1, 2, 2, 2, 2, 0, 3, 1, 2, 0, 1, 0, 1, 1 };

359  
DeBruijnByãPos
[((
U32
)((
vÆ
 & -(
S32
)val) * 0x077CB531U)) >> 27];

362 
	}
}

378 
ölöe
 
	$LZ4_com¥essCtx
(** 
˘x
,

379 c⁄° * 
sour˚
,

380 * 
de°
,

381 
isize
,

382 
maxOuçutSize
)

384 #i‡
HEAPMODE


385 
ªfTabÀs
 *
§t
 = (ªfTabÀ†*Ë(*
˘x
);

386 
HTYPE
* 
HashTabÀ
;

388 
HTYPE
 
HashTabÀ
[
HASHTABLESIZE
] = {0};

391 c⁄° 
BYTE
* 
ù
 = (BYTE*Ë
sour˚
;

392 
	`INITBASE
(
ba£
);

393 c⁄° 
BYTE
* 
™ch‹
 = 
ù
;

394 c⁄° 
BYTE
* c⁄° 
õnd
 = 
ù
 + 
isize
;

395 c⁄° 
BYTE
* c⁄° 
mÊimô
 = 
õnd
 - 
MFLIMIT
;

396 
	#m©chlimô
 (
õnd
 - 
LASTLITERALS
)

	)

398 
BYTE
* 
›
 = (BYTE*Ë
de°
;

399 
BYTE
* c⁄° 
€nd
 = 
›
 + 
maxOuçutSize
;

401 
Àn
, 
Àngth
;

402 c⁄° 
skùSåígth
 = 
SKIPSTRENGTH
;

403 
U32
 
f‹w¨dH
;

407 i‡(
isize
<
MINLENGTH
Ë
_œ°_lôîÆs
;

408 #i‡
HEAPMODE


409 
HashTabÀ
 = (
HTYPE
*)(
§t
->
hashTabÀ
);

410 
	`mem£t
((*)
HashTabÀ
, 0, (
§t
->
hashTabÀ
));

412 (Ë
˘x
;

417 
HashTabÀ
[
	`LZ4_HASH_VALUE
(
ù
)] = i∞- 
ba£
;

418 
ù
++; 
f‹w¨dH
 = 
	`LZ4_HASH_VALUE
(ip);

423 
födM©chAâem±s
 = (1U << 
skùSåígth
) + 3;

424 c⁄° 
BYTE
* 
f‹w¨dIp
 = 
ù
;

425 c⁄° 
BYTE
* 
ªf
;

426 
BYTE
* 
tokí
;

430 
U32
 
h
 = 
f‹w¨dH
;

431 
°ï
 = 
födM©chAâem±s
++ >> 
skùSåígth
;

432 
ù
 = 
f‹w¨dIp
;

433 
f‹w¨dIp
 = 
ù
 + 
°ï
;

435 i‡(
	`u∆ikñy
(
f‹w¨dIp
 > 
mÊimô
)Ë{ 
_œ°_lôîÆs
; }

437 
f‹w¨dH
 = 
	`LZ4_HASH_VALUE
(
f‹w¨dIp
);

438 
ªf
 = 
ba£
 + 
HashTabÀ
[
h
];

439 
HashTabÀ
[
h
] = 
ù
 - 
ba£
;

441 } (
ªf
 < 
ù
 - 
MAX_DISTANCE
Ë|| (
	`A32
(ref) != A32(ip)));

444 (
ù
>
™ch‹
Ë&& (
ªf
>(
BYTE
*)
sour˚
Ë&& 
	`u∆ikñy
(ip[-1]==ref[-1])) { ip--;Ñef--; }

447 
Àngth
 = ()(
ù
 - 
™ch‹
);

448 
tokí
 = 
›
++;

449 i‡(
	`u∆ikñy
(
›
 + 
Àngth
 + (2 + 1 + 
LASTLITERALS
Ë+ (Àngth>>8Ë> 
€nd
))  0;

450 #ifde‡
_MSC_VER


451 i‡(
Àngth
>=()
RUN_MASK
)

453 
Àn
 = 
Àngth
-
RUN_MASK
;

454 *
tokí
=(
RUN_MASK
<<
ML_BITS
);

455 i‡(
Àn
>254)

457 dÿ{ *
›
++ = 255; 
Àn
 -= 255; } len>254);

458 *
›
++ = (
BYTE
)
Àn
;

459 
	`mem˝y
(
›
, 
™ch‹
, 
Àngth
);

460 
›
 +
Àngth
;

461 
_√xt_m©ch
;

464 *
›
++ = (
BYTE
)
Àn
;

466 *
tokí
 = (
Àngth
<<
ML_BITS
);

468 i‡(
Àngth
>=()
RUN_MASK
Ë{ *
tokí
=(RUN_MASK<<
ML_BITS
); 
Àn
 =Üígth-RUN_MASK; ;Üí > 254 ;Üí-=255Ë*
›
++ = 255; *›++ = (
BYTE
)len; }

469 *
tokí
 = (
Àngth
<<
ML_BITS
);

473 
	`LZ4_BLINDCOPY
(
™ch‹
, 
›
, 
Àngth
);

475 
_√xt_m©ch
:

477 
	`LZ4_WRITE_LITTLEENDIAN_16
(
›
,(
U16
)(
ù
-
ªf
));

480 
ù
+=
MINMATCH
; 
ªf
+=MINMATCH;

481 
™ch‹
 = 
ù
;

482 
	`likñy
(
ù
<
m©chlimô
-(
STEPSIZE
-1)))

484 
UARCH
 
diff
 = 
	`AARCH
(
ªf
Ë^ AARCH(
ù
);

485 i‡(!
diff
Ë{ 
ù
+=
STEPSIZE
; 
ªf
+=STEPSIZE; ; }

486 
ù
 +
	`LZ4_NbComm⁄Byãs
(
diff
);

487 
_ídCou¡
;

489 i‡(
LZ4_ARCH64
Ëi‡((
ù
<(
m©chlimô
-3)Ë&& (
	`A32
(
ªf
) == A32(ip))) { ip+=4;Ñef+=4; }

490 i‡((
ù
<(
m©chlimô
-1)Ë&& (
	`A16
(
ªf
) == A16(ip))) { ip+=2;Ñef+=2; }

491 i‡((
ù
<
m©chlimô
Ë&& (*
ªf
 == *ip)) ip++;

492 
_ídCou¡
:

495 
Àn
 = ()(
ù
 - 
™ch‹
);

496 i‡(
	`u∆ikñy
(
›
 + (1 + 
LASTLITERALS
Ë+ (
Àn
>>8Ë> 
€nd
))  0;

497 i‡(
Àn
>=()
ML_MASK
Ë{ *
tokí
+=ML_MASK;Üí-=ML_MASK; ;Üí > 509 ;Üí-=510Ë{ *
›
++ = 255; *›++ = 255; } i‡÷í > 254Ë{Üí-=255; *›++ = 255; } *›++ = (
BYTE
)len; }

498 *
tokí
 +
Àn
;

501 i‡(
ù
 > 
mÊimô
Ë{ 
™ch‹
 = ip; ; }

504 
HashTabÀ
[
	`LZ4_HASH_VALUE
(
ù
-2)] = i∞- 2 - 
ba£
;

507 
ªf
 = 
ba£
 + 
HashTabÀ
[
	`LZ4_HASH_VALUE
(
ù
)];

508 
HashTabÀ
[
	`LZ4_HASH_VALUE
(
ù
)] = i∞- 
ba£
;

509 i‡((
ªf
 > 
ù
 - (
MAX_DISTANCE
 + 1)Ë&& (
	`A32
‘efË=A32(ù))Ë{ 
tokí
 = 
›
++; *tokí=0; 
_√xt_m©ch
; }

512 
™ch‹
 = 
ù
++;

513 
f‹w¨dH
 = 
	`LZ4_HASH_VALUE
(
ù
);

516 
_œ°_lôîÆs
:

519 
œ°Run
 = ()(
õnd
 - 
™ch‹
);

520 i‡(((*)
›
 - 
de°
Ë+ 
œ°Run
 + 1 + (÷a°Run+255-
RUN_MASK
)/255Ë> (
U32
)
maxOuçutSize
)  0;

521 i‡(
œ°Run
>=()
RUN_MASK
Ë{ *
›
++=(RUN_MASK<<
ML_BITS
);Üa°Run-=RUN_MASK; ;Üa°Ru¿> 254 ;Üa°Run-=255Ë*›++ = 255; *›++ = (
BYTE
)ÜastRun; }

522 *
›
++ = (
œ°Run
<<
ML_BITS
);

523 
	`mem˝y
(
›
, 
™ch‹
, 
õnd
 -ánchor);

524 
›
 +
õnd
-
™ch‹
;

528  (Ë(((*)
›
)-
de°
);

529 
	}
}

534 
	#LZ4_64KLIMIT
 ((1<<16Ë+ (
MFLIMIT
-1))

	)

535 
	#HASHLOG64K
 (
HASH_LOG
+1)

	)

536 
	#HASH64KTABLESIZE
 (1U<<
HASHLOG64K
)

	)

537 
	#LZ4_HASH64K_FUNCTION
(
i
Ë(((iË* 2654435761UË>> ((
MINMATCH
*8)-
HASHLOG64K
))

	)

538 
	#LZ4_HASH64K_VALUE
(
p
Ë
	`LZ4_HASH64K_FUNCTION
(
	`A32
’))

	)

539 
ölöe
 
	$LZ4_com¥ess64kCtx
(** 
˘x
,

540 c⁄° * 
sour˚
,

541 * 
de°
,

542 
isize
,

543 
maxOuçutSize
)

545 #i‡
HEAPMODE


546 
ªfTabÀs
 *
§t
 = (ªfTabÀ†*Ë(*
˘x
);

547 
U16
* 
HashTabÀ
;

549 
U16
 
HashTabÀ
[
HASH64KTABLESIZE
] = {0};

552 c⁄° 
BYTE
* 
ù
 = (BYTE*Ë
sour˚
;

553 c⁄° 
BYTE
* 
™ch‹
 = 
ù
;

554 c⁄° 
BYTE
* c⁄° 
ba£
 = 
ù
;

555 c⁄° 
BYTE
* c⁄° 
õnd
 = 
ù
 + 
isize
;

556 c⁄° 
BYTE
* c⁄° 
mÊimô
 = 
õnd
 - 
MFLIMIT
;

557 
	#m©chlimô
 (
õnd
 - 
LASTLITERALS
)

	)

559 
BYTE
* 
›
 = (BYTE*Ë
de°
;

560 
BYTE
* c⁄° 
€nd
 = 
›
 + 
maxOuçutSize
;

562 
Àn
, 
Àngth
;

563 c⁄° 
skùSåígth
 = 
SKIPSTRENGTH
;

564 
U32
 
f‹w¨dH
;

568 i‡(
isize
<
MINLENGTH
Ë
_œ°_lôîÆs
;

569 #i‡
HEAPMODE


570 
HashTabÀ
 = (
U16
*)(
§t
->
hashTabÀ
);

571 
	`mem£t
((*)
HashTabÀ
, 0, (
§t
->
hashTabÀ
));

573 (Ë
˘x
;

578 
ù
++; 
f‹w¨dH
 = 
	`LZ4_HASH64K_VALUE
(ip);

583 
födM©chAâem±s
 = (1U << 
skùSåígth
) + 3;

584 c⁄° 
BYTE
* 
f‹w¨dIp
 = 
ù
;

585 c⁄° 
BYTE
* 
ªf
;

586 
BYTE
* 
tokí
;

590 
U32
 
h
 = 
f‹w¨dH
;

591 
°ï
 = 
födM©chAâem±s
++ >> 
skùSåígth
;

592 
ù
 = 
f‹w¨dIp
;

593 
f‹w¨dIp
 = 
ù
 + 
°ï
;

595 i‡(
f‹w¨dIp
 > 
mÊimô
Ë{ 
_œ°_lôîÆs
; }

597 
f‹w¨dH
 = 
	`LZ4_HASH64K_VALUE
(
f‹w¨dIp
);

598 
ªf
 = 
ba£
 + 
HashTabÀ
[
h
];

599 
HashTabÀ
[
h
] = (
U16
)(
ù
 - 
ba£
);

601 } 
	`A32
(
ªf
Ë!A32(
ù
));

604 (
ù
>
™ch‹
Ë&& (
ªf
>(
BYTE
*)
sour˚
) && (ip[-1]==ref[-1])) { ip--;Ñef--; }

607 
Àngth
 = ()(
ù
 - 
™ch‹
);

608 
tokí
 = 
›
++;

609 i‡(
	`u∆ikñy
(
›
 + 
Àngth
 + (2 + 1 + 
LASTLITERALS
Ë+ (Àngth>>8Ë> 
€nd
))  0;

610 #ifde‡
_MSC_VER


611 i‡(
Àngth
>=()
RUN_MASK
)

613 
Àn
 = 
Àngth
-
RUN_MASK
;

614 *
tokí
=(
RUN_MASK
<<
ML_BITS
);

615 i‡(
Àn
>254)

617 dÿ{ *
›
++ = 255; 
Àn
 -= 255; } len>254);

618 *
›
++ = (
BYTE
)
Àn
;

619 
	`mem˝y
(
›
, 
™ch‹
, 
Àngth
);

620 
›
 +
Àngth
;

621 
_√xt_m©ch
;

624 *
›
++ = (
BYTE
)
Àn
;

626 *
tokí
 = (
Àngth
<<
ML_BITS
);

628 i‡(
Àngth
>=()
RUN_MASK
Ë{ *
tokí
=(RUN_MASK<<
ML_BITS
); 
Àn
 =Üígth-RUN_MASK; ;Üí > 254 ;Üí-=255Ë*
›
++ = 255; *›++ = (
BYTE
)len; }

629 *
tokí
 = (
Àngth
<<
ML_BITS
);

633 
	`LZ4_BLINDCOPY
(
™ch‹
, 
›
, 
Àngth
);

635 
_√xt_m©ch
:

637 
	`LZ4_WRITE_LITTLEENDIAN_16
(
›
,(
U16
)(
ù
-
ªf
));

640 
ù
+=
MINMATCH
; 
ªf
+=MINMATCH;

641 
™ch‹
 = 
ù
;

642 
ù
<
m©chlimô
-(
STEPSIZE
-1))

644 
UARCH
 
diff
 = 
	`AARCH
(
ªf
Ë^ AARCH(
ù
);

645 i‡(!
diff
Ë{ 
ù
+=
STEPSIZE
; 
ªf
+=STEPSIZE; ; }

646 
ù
 +
	`LZ4_NbComm⁄Byãs
(
diff
);

647 
_ídCou¡
;

649 i‡(
LZ4_ARCH64
Ëi‡((
ù
<(
m©chlimô
-3)Ë&& (
	`A32
(
ªf
) == A32(ip))) { ip+=4;Ñef+=4; }

650 i‡((
ù
<(
m©chlimô
-1)Ë&& (
	`A16
(
ªf
) == A16(ip))) { ip+=2;Ñef+=2; }

651 i‡((
ù
<
m©chlimô
Ë&& (*
ªf
 == *ip)) ip++;

652 
_ídCou¡
:

655 
Àn
 = ()(
ù
 - 
™ch‹
);

656 i‡(
	`u∆ikñy
(
›
 + (1 + 
LASTLITERALS
Ë+ (
Àn
>>8Ë> 
€nd
))  0;

657 i‡(
Àn
>=()
ML_MASK
Ë{ *
tokí
+=ML_MASK;Üí-=ML_MASK; ;Üí > 509 ;Üí-=510Ë{ *
›
++ = 255; *›++ = 255; } i‡÷í > 254Ë{Üí-=255; *›++ = 255; } *›++ = (
BYTE
)len; }

658 *
tokí
 +
Àn
;

661 i‡(
ù
 > 
mÊimô
Ë{ 
™ch‹
 = ip; ; }

664 
HashTabÀ
[
	`LZ4_HASH64K_VALUE
(
ù
-2)] = (
U16
)(ù - 2 - 
ba£
);

667 
ªf
 = 
ba£
 + 
HashTabÀ
[
	`LZ4_HASH64K_VALUE
(
ù
)];

668 
HashTabÀ
[
	`LZ4_HASH64K_VALUE
(
ù
)] = (
U16
)(ù - 
ba£
);

669 i‡(
	`A32
(
ªf
Ë=A32(
ù
)Ë{ 
tokí
 = 
›
++; *tokí=0; 
_√xt_m©ch
; }

672 
™ch‹
 = 
ù
++;

673 
f‹w¨dH
 = 
	`LZ4_HASH64K_VALUE
(
ù
);

676 
_œ°_lôîÆs
:

679 
œ°Run
 = ()(
õnd
 - 
™ch‹
);

680 i‡(
›
 + 
œ°Run
 + 1 + (œ°Run-
RUN_MASK
+255)/255 > 
€nd
)  0;

681 i‡(
œ°Run
>=()
RUN_MASK
Ë{ *
›
++=(RUN_MASK<<
ML_BITS
);Üa°Run-=RUN_MASK; ;Üa°Ru¿> 254 ;Üa°Run-=255Ë*›++ = 255; *›++ = (
BYTE
)ÜastRun; }

682 *
›
++ = (
œ°Run
<<
ML_BITS
);

683 
	`mem˝y
(
›
, 
™ch‹
, 
õnd
 -ánchor);

684 
›
 +
õnd
-
™ch‹
;

688  (Ë(((*)
›
)-
de°
);

689 
	}
}

692 
	$LZ4_com¥ess_˘x_limôedOuçut
(*
˘x
,

693 c⁄° *
sour˚
,

694 *
de°
,

695 
isize
,

696 
maxOuçutSize
)

698 i‡(
isize
 < 
LZ4_64KLIMIT
) {

699  
	`LZ4_com¥ess64kCtx
(&
˘x
, 
sour˚
, 
de°
, 
isize
, 
maxOuçutSize
);

701  
	`LZ4_com¥essCtx
(&
˘x
, 
sour˚
, 
de°
, 
isize
, 
maxOuçutSize
);

703 
	}
}

717 #ifde‡
LZ4_EVERYTHING


718 
	$LZ4_uncom¥ess
(c⁄° * 
sour˚
, * 
de°
, 
osize
)

721 c⁄° 
BYTE
* 
ª°ri˘
 
ù
 = (c⁄° BYTE*Ë
sour˚
;

722 c⁄° 
BYTE
* 
ªf
;

724 
BYTE
* 
›
 = (BYTE*Ë
de°
;

725 
BYTE
* c⁄° 
€nd
 = 
›
 + 
osize
;

726 
BYTE
* 
˝y
;

728 
tokí
;

730 
size_t
 
Àngth
;

731 
size_t
 
dec32èbÀ
[] = {0, 3, 2, 3, 0, 0, 0, 0};

732 #i‡
LZ4_ARCH64


733 
size_t
 
dec64èbÀ
[] = {0, 0, 0, -1, 0, 1, 2, 3};

741 
tokí
 = *
ù
++;

742 i‡((
Àngth
=(
tokí
>>
ML_BITS
)Ë=
RUN_MASK
Ë{ 
size_t
 
Àn
; ;÷í=*
ù
++)==255;length+=255){}Üength +=Üen; }

745 
˝y
 = 
›
+
Àngth
;

746 i‡(
	`u∆ikñy
(
˝y
>
€nd
-
COPYLENGTH
))

748 i‡(
˝y
 !
€nd
Ë
_ouçut_îr‹
;

749 
	`mem˝y
(
›
, 
ù
, 
Àngth
);

750 
ù
 +
Àngth
;

753 
	`LZ4_WILDCOPY
(
ù
, 
›
, 
˝y
); ip -= (op-cpy); op = cpy;

756 
	`LZ4_READ_LITTLEENDIAN_16
(
ªf
,
˝y
,
ù
); ip+=2;

757 i‡(
	`u∆ikñy
(
ªf
 < (
BYTE
* c⁄°)
de°
)Ë
_ouçut_îr‹
;

760 i‡((
Àngth
=(
tokí
&
ML_MASK
)Ë=ML_MASKË{ ;*
ù
==255;length+=255) {ip++;}Üength += *ip++; }

763 i‡(
	`u∆ikñy
((
›
-
ªf
)<
STEPSIZE
))

765 #i‡
LZ4_ARCH64


766 
size_t
 
dec64
 = 
dec64èbÀ
[
›
-
ªf
];

768 c⁄° 
dec64
 = 0;

770 
›
[0] = 
ªf
[0];

771 
›
[1] = 
ªf
[1];

772 
›
[2] = 
ªf
[2];

773 
›
[3] = 
ªf
[3];

774 
›
 +4, 
ªf
 +4;Ñe‡-
dec32èbÀ
[op-ref];

775 
	`A32
(
›
ËA32(
ªf
);

776 
›
 +
STEPSIZE
-4; 
ªf
 -
dec64
;

777 } { 
	`LZ4_COPYSTEP
(
ªf
,
›
); }

778 
˝y
 = 
›
 + 
Àngth
 - (
STEPSIZE
-4);

779 i‡(
˝y
>
€nd
-
COPYLENGTH
)

781 i‡(
˝y
 > 
€nd
Ë
_ouçut_îr‹
;

782 
	`LZ4_SECURECOPY
(
ªf
, 
›
, (
€nd
-
COPYLENGTH
));

783 
›
<
˝y
Ë*›++=*
ªf
++;

784 
›
=
˝y
;

785 i‡(
›
 =
€nd
Ë
_ouçut_îr‹
;

788 
	`LZ4_SECURECOPY
(
ªf
, 
›
, 
˝y
);

789 
›
=
˝y
;

793  (Ë(((*)
ù
)-
sour˚
);

796 
_ouçut_îr‹
:

797  (Ë(-(((*)
ù
)-
sour˚
));

798 
	}
}

801 
	$LZ4_uncom¥ess_unknownOuçutSize
(

802 c⁄° * 
sour˚
,

803 * 
de°
,

804 
isize
,

805 
maxOuçutSize
)

808 c⁄° 
BYTE
* 
ª°ri˘
 
ù
 = (c⁄° BYTE*Ë
sour˚
;

809 c⁄° 
BYTE
* c⁄° 
õnd
 = 
ù
 + 
isize
;

810 c⁄° 
BYTE
* 
ªf
;

812 
BYTE
* 
›
 = (BYTE*Ë
de°
;

813 
BYTE
* c⁄° 
€nd
 = 
›
 + 
maxOuçutSize
;

814 
BYTE
* 
˝y
;

816 
size_t
 
dec32èbÀ
[] = {0, 3, 2, 3, 0, 0, 0, 0};

817 #i‡
LZ4_ARCH64


818 
size_t
 
dec64èbÀ
[] = {0, 0, 0, -1, 0, 1, 2, 3};

823 
ù
<
õnd
)

825 
tokí
;

826 
size_t
 
Àngth
;

829 
tokí
 = *
ù
++;

830 i‡((
Àngth
=(
tokí
>>
ML_BITS
)Ë=
RUN_MASK
Ë{ 
s
=255; (
ù
<
õnd
) && (s==255)) { s=*ip++;Üength += s; } }

833 
˝y
 = 
›
+
Àngth
;

834 i‡((
˝y
>
€nd
-
COPYLENGTH
Ë|| (
ù
+
Àngth
>
õnd
-COPYLENGTH))

836 i‡(
˝y
 > 
€nd
Ë
_ouçut_îr‹
;

837 i‡(
ù
+
Àngth
 !
õnd
Ë
_ouçut_îr‹
;

838 
	`mem˝y
(
›
, 
ù
, 
Àngth
);

839 
›
 +
Àngth
;

842 
	`LZ4_WILDCOPY
(
ù
, 
›
, 
˝y
); ip -= (op-cpy); op = cpy;

845 
	`LZ4_READ_LITTLEENDIAN_16
(
ªf
,
˝y
,
ù
); ip+=2;

846 i‡(
ªf
 < (
BYTE
* c⁄°)
de°
Ë
_ouçut_îr‹
;

849 i‡((
Àngth
=(
tokí
&
ML_MASK
)Ë=ML_MASKË{ 
ù
<
õnd
Ë{ 
s
 = *ip++;Üength +=s; if (s==255) ; ; } }

852 i‡(
	`u∆ikñy
(
›
-
ªf
<
STEPSIZE
))

854 #i‡
LZ4_ARCH64


855 
size_t
 
dec64
 = 
dec64èbÀ
[
›
-
ªf
];

857 c⁄° 
dec64
 = 0;

859 
›
[0] = 
ªf
[0];

860 
›
[1] = 
ªf
[1];

861 
›
[2] = 
ªf
[2];

862 
›
[3] = 
ªf
[3];

863 
›
 +4, 
ªf
 +4;Ñe‡-
dec32èbÀ
[op-ref];

864 
	`A32
(
›
ËA32(
ªf
);

865 
›
 +
STEPSIZE
-4; 
ªf
 -
dec64
;

866 } { 
	`LZ4_COPYSTEP
(
ªf
,
›
); }

867 
˝y
 = 
›
 + 
Àngth
 - (
STEPSIZE
-4);

868 i‡(
˝y
>
€nd
-
COPYLENGTH
)

870 i‡(
˝y
 > 
€nd
Ë
_ouçut_îr‹
;

871 
	`LZ4_SECURECOPY
(
ªf
, 
›
, (
€nd
-
COPYLENGTH
));

872 
›
<
˝y
Ë*›++=*
ªf
++;

873 
›
=
˝y
;

874 i‡(
›
 =
€nd
Ë
_ouçut_îr‹
;

877 
	`LZ4_SECURECOPY
(
ªf
, 
›
, 
˝y
);

878 
›
=
˝y
;

882  (Ë(((*)
›
)-
de°
);

885 
_ouçut_îr‹
:

886  (Ë(-(((*)
ù
)-
sour˚
));

887 
	}
}

889 
	$LZ4_c⁄ãxt_size
()

891  (
ªfTabÀs
);

892 
	}
}

	@vdo/base/lz4.h

22 #i‚de‡
LZ4_H


23 
	#LZ4_H


	)

81 
LZ4_com¥ess_˘x_limôedOuçut
(*
˘x
,

82 c⁄° *
sour˚
,

83 *
de°
,

84 
isize
,

85 
maxOuçutSize
);

93 
LZ4_c⁄ãxt_size
();

110 
LZ4_uncom¥ess_unknownOuçutSize
(c⁄° *
sour˚
,

111 *
de°
,

112 
isize
,

113 
maxOuçutSize
);

	@vdo/base/numUtils.h

24 #i‚de‡
NUM_UTILS_H


25 
	#NUM_UTILS_H


	)

27 
	~"comm⁄.h
"

28 
	~"numîic.h
"

30 
	~"ty≥s.h
"

35 
ölöe
 
boﬁ
 
	$isPowîOfTwo
(
uöt64_t
 
n
)

37  (
n
 > 0) && ((n & (n - 1)) == 0);

38 
	}
}

54 
ölöe
 
	$logBa£Two
(
uöt64_t
 
n
)

56 i‡(
n
 == 0) {

61  63 - 
	`__buûtö_˛zŒ
(
n
);

62 
	}
}

67 
__©åibuã__
((
w¨n_unu£d_ªsu…
))

68 
ölöe
 
PhysiˇlBlockNumbî
 
	$möBlock
(
PhysiˇlBlockNumbî
 
a
,

69 
PhysiˇlBlockNumbî
 
b
)

71  (
a
 < 
b
) ?á : b;

72 
	}
}

77 
__©åibuã__
((
w¨n_unu£d_ªsu…
))

78 
ölöe
 
PhysiˇlBlockNumbî
 
	$maxBlock
(
PhysiˇlBlockNumbî
 
a
,

79 
PhysiˇlBlockNumbî
 
b
)

81  (
a
 > 
b
) ?á : b;

82 
	}
}

87 
__©åibuã__
((
w¨n_unu£d_ªsu…
))

88 
ölöe
 
BlockCou¡
 
	$möBlockCou¡
(
BlockCou¡
 
a
, BlockCou¡ 
b
)

90  (
a
 < 
b
) ?á : b;

91 
	}
}

96 
__©åibuã__
((
w¨n_unu£d_ªsu…
))

97 
ölöe
 
BlockCou¡
 
	$maxBlockCou¡
(
BlockCou¡
 
a
, BlockCou¡ 
b
)

99  (
a
 > 
b
) ?á : b;

100 
	}
}

105 
__©åibuã__
((
w¨n_unu£d_ªsu…
))

106 
ölöe
 
Sequí˚Numbî
 
	$möSequí˚Numbî
(
Sequí˚Numbî
 
a
,

107 
Sequí˚Numbî
 
b
)

109  (
a
 < 
b
) ?á : b;

110 
	}
}

115 
__©åibuã__
((
w¨n_unu£d_ªsu…
))

116 
ölöe
 
PageCou¡
 
	$möPageCou¡
(
PageCou¡
 
a
, PageCou¡ 
b
)

118  (
a
 < 
b
) ?á : b;

119 
	}
}

124 
__©åibuã__
((
w¨n_unu£d_ªsu…
))

125 
ölöe
 
PageCou¡
 
	$maxPageCou¡
(
PageCou¡
 
a
, PageCou¡ 
b
)

127  (
a
 > 
b
) ?á : b;

128 
	}
}

138 
__©åibuã__
((
w¨n_unu£d_ªsu…
))

139 
ölöe
 
size_t
 
	$roundUpToMu…ùÀSizeT
(
size_t
 
numbî
, size_à
qu™tum
)

141  
numbî
 + 
qu™tum
 - 1 - ((number + quantum - 1) % quantum);

142 
	}
}

152 
__©åibuã__
((
w¨n_unu£d_ªsu…
))

153 
ölöe
 
uöt64_t
 
	$roundUpToMu…ùÀUI¡64T
(
uöt64_t
 
numbî
,

154 
uöt64_t
 
qu™tum
)

156  
numbî
 + 
qu™tum
 - 1 - ((number + quantum - 1) % quantum);

157 
	}
}

171 
ölöe
 
boﬁ
 
	$öCy˛icR™ge
(
uöt16_t
 
lowî
,

172 
uöt16_t
 
vÆue
,

173 
uöt16_t
 
uµî
,

174 
uöt16_t
 
modulus
)

176 i‡(
vÆue
 < 
lowî
) {

177 
vÆue
 +
modulus
;

179 i‡(
uµî
 < 
lowî
) {

180 
uµî
 +
modulus
;

182  (
vÆue
 <
uµî
);

183 
	}
}

194 
ölöe
 
uöt64_t
 
	$compuãBuckëCou¡
(
uöt64_t
 
obje˘Cou¡
,

195 
uöt64_t
 
buckëSize
)

197 
uöt64_t
 
quŸõ¡
 = 
obje˘Cou¡
 / 
buckëSize
;

198 i‡((
obje˘Cou¡
 % 
buckëSize
) > 0) {

199 ++
quŸõ¡
;

201  
quŸõ¡
;

202 
	}
}

	@vdo/base/objectPool.c

22 
	~"obje˘Poﬁ.h
"

24 
	~"loggî.h
"

25 
	~"mem‹yAŒoc.h
"

26 
	~"≥rmas£π.h
"

31 
	sobje˘Poﬁ
 {

32 
size_t
 
	mpoﬁSize
;

33 
RögNode
 
	mavaûabÀ
;

34 
WaôQueue
 
	mwaôög
;

35 
size_t
 
	mbusyCou¡
;

36 
RögNode
 
	mbusy
;

37 
AdmöSèã
 
	madmöSèã
;

38 
VDOCom∂ëi⁄
 *
	mcom∂ëi⁄
;

39 
uöt64_t
 
	mouègeCou¡
;

40 
uöt64_t
 
	msu•ídCou¡
;

41 *
	míåyD©a
;

45 
	$makeObje˘Poﬁ
(*
íåyD©a
, 
Obje˘Poﬁ
 **
poﬁPå
)

47 
Obje˘Poﬁ
 *
poﬁ
;

48 
ªsu…
 = 
	`ALLOCATE
(1, 
Obje˘Poﬁ
, 
__func__
, &
poﬁ
);

49 i‡(
ªsu…
 !
VDO_SUCCESS
) {

50  
ªsu…
;

53 
	`öôülizeRög
(&
poﬁ
->
avaûabÀ
);

54 
	`öôülizeRög
(&
poﬁ
->
busy
);

55 
poﬁ
->
íåyD©a
 =ÉntryData;

56 *
poﬁPå
 = 
poﬁ
;

57  
VDO_SUCCESS
;

58 
	}
}

61 
	$‰ìObje˘Poﬁ
(
Obje˘Poﬁ
 **
poﬁPå
)

63 i‡(*
poﬁPå
 =
NULL
) {

67 
Obje˘Poﬁ
 *
poﬁ
 = *
poﬁPå
;

68 
	`ASSERT_LOG_ONLY
(!
	`hasWaôîs
(&
poﬁ
->
waôög
),

70 
	`ASSERT_LOG_ONLY
((
poﬁ
->
busyCou¡
 == 0),

72 
poﬁ
->
busyCou¡
);

73 
	`ASSERT_LOG_ONLY
(
	`isRögEm±y
(&
poﬁ
->
busy
),

75 
	`FREE
(
poﬁ
);

76 *
poﬁPå
 = 
NULL
;

77 
	}
}

80 *
	$gëObje˘PoﬁE¡ryD©a
(
Obje˘Poﬁ
 *
poﬁ
)

82  
poﬁ
->
íåyD©a
;

83 
	}
}

86 
	$addE¡ryToObje˘Poﬁ
(
Obje˘Poﬁ
 *
poﬁ
, 
RögNode
 *
íåy
)

88 
	`öôülizeRög
(
íåy
);

89 
	`pushRögNode
(&
poﬁ
->
avaûabÀ
, 
íåy
);

90 
poﬁ
->
poﬁSize
++;

91 
	}
}

94 
RögNode
 *
	$ªmoveE¡ryFromObje˘Poﬁ
(
Obje˘Poﬁ
 *
poﬁ
)

96 
RögNode
 *
íåy
 = 
	`ch›RögNode
(&
poﬁ
->
avaûabÀ
);

97 i‡(
íåy
 !
NULL
) {

98 
poﬁ
->
poﬁSize
--;

101  
íåy
;

102 
	}
}

110 
	$gø¡Obje˘
(
Obje˘Poﬁ
 *
poﬁ
, 
Waôî
 *
waôî
)

112 
poﬁ
->
busyCou¡
++;

113 
RögNode
 *
íåy
 = 
	`ch›RögNode
(&
poﬁ
->
avaûabÀ
);

114 
	`pushRögNode
(&
poﬁ
->
busy
, 
íåy
);

115 (*
waôî
->
ˇŒback
)(waôî, 
íåy
);

116 
	}
}

119 
	$acquúeE¡ryFromObje˘Poﬁ
(
Obje˘Poﬁ
 *
poﬁ
, 
Waôî
 *
waôî
)

121 i‡(
poﬁ
->
admöSèã
 =
ADMIN_STATE_CLOSED
) {

122  
VDO_SHUTTING_DOWN
;

125 i‡((
poﬁ
->
admöSèã
 =
ADMIN_STATE_SUSPENDED
)

126 || 
	`isRögEm±y
(&
poﬁ
->
avaûabÀ
)) {

127 
ªsu…
 = 
	`íqueueWaôî
(&
poﬁ
->
waôög
, 
waôî
);

128 i‡(
ªsu…
 !
VDO_SUCCESS
) {

129  
ªsu…
;

132 i‡(
poﬁ
->
admöSèã
 =
ADMIN_STATE_SUSPENDED
) {

133 
poﬁ
->
su•ídCou¡
++;

135 
poﬁ
->
ouègeCou¡
++;

138  
VDO_SUCCESS
;

141 
	`gø¡Obje˘
(
poﬁ
, 
waôî
);

142  
VDO_SUCCESS
;

143 
	}
}

146 
	$checkNŸBusy
(
Obje˘Poﬁ
 *
poﬁ
)

148 i‡(
poﬁ
->
busyCou¡
 != 0) {

152 
VDOCom∂ëi⁄
 *
com∂ëi⁄
 = 
poﬁ
->completion;

153 i‡(
com∂ëi⁄
 !
NULL
) {

154 
poﬁ
->
com∂ëi⁄
 = 
NULL
;

155 i‡(
poﬁ
->
admöSèã
 =
ADMIN_STATE_CLOSING
) {

156 
poﬁ
->
admöSèã
 = 
ADMIN_STATE_CLOSED
;

158 
	`föishCom∂ëi⁄
(
com∂ëi⁄
, 
VDO_SUCCESS
);

160 
	}
}

163 
	$ªtu∫E¡ryToObje˘Poﬁ
(
Obje˘Poﬁ
 *
poﬁ
, 
RögNode
 *
íåy
)

165 i‡((
poﬁ
->
admöSèã
 !
ADMIN_STATE_SUSPENDED
)

166 && 
	`hasWaôîs
(&
poﬁ
->
waôög
)) {

167 
	`nŸifyNextWaôî
(&
poﬁ
->
waôög
, 
NULL
, 
íåy
);

171 
poﬁ
->
busyCou¡
--;

172 
	`pushRögNode
(&
poﬁ
->
avaûabÀ
, 
íåy
);

173 i‡(
poﬁ
->
admöSèã
 !
ADMIN_STATE_NORMAL_OPERATION
) {

174 
	`checkNŸBusy
(
poﬁ
);

176 
	}
}

179 
	$su•ídObje˘Poﬁ
(
Obje˘Poﬁ
 *
poﬁ
, 
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

181 
	`ASSERT_LOG_ONLY
((
poﬁ
->
admöSèã
 =
ADMIN_STATE_NORMAL_OPERATION
),

183 
poﬁ
->
com∂ëi⁄
 = completion;

184 
poﬁ
->
admöSèã
 = 
ADMIN_STATE_SUSPENDED
;

185 
	`checkNŸBusy
(
poﬁ
);

186 
	}
}

189 
	$ªsumeObje˘Poﬁ
(
Obje˘Poﬁ
 *
poﬁ
)

191 i‡(!(
poﬁ
->
admöSèã
 =
ADMIN_STATE_SUSPENDED
)) {

195 
poﬁ
->
admöSèã
 = 
ADMIN_STATE_NORMAL_OPERATION
;

196 
poﬁ
->
ouègeCou¡
 +poﬁ->
su•ídCou¡
;

197 
poﬁ
->
su•ídCou¡
 = 0;

198 
	`hasWaôîs
(&
poﬁ
->
waôög
Ë&& !
	`isRögEm±y
(&poﬁ->
avaûabÀ
)) {

199 
	`gø¡Obje˘
(
poﬁ
, 
	`dequeueNextWaôî
(&poﬁ->
waôög
));

201 
	}
}

204 
	$›íObje˘Poﬁ
(
Obje˘Poﬁ
 *
poﬁ
)

206 
	`ASSERT_LOG_ONLY
((
poﬁ
->
admöSèã
 =
ADMIN_STATE_CLOSED
),

208 
poﬁ
->
admöSèã
 = 
ADMIN_STATE_NORMAL_OPERATION
;

209 
	}
}

212 
	$˛o£Obje˘Poﬁ
(
Obje˘Poﬁ
 *
poﬁ
, 
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

214 
	`ASSERT_LOG_ONLY
((
poﬁ
->
admöSèã
 =
ADMIN_STATE_NORMAL_OPERATION
),

216 
poﬁ
->
com∂ëi⁄
 = completion;

217 
poﬁ
->
admöSèã
 = 
ADMIN_STATE_CLOSING
;

218 
	`checkNŸBusy
(
poﬁ
);

219 
	}
}

222 
uöt64_t
 
	$gëObje˘PoﬁOuègeCou¡
(
Obje˘Poﬁ
 *
poﬁ
)

224  
poﬁ
->
ouègeCou¡
;

225 
	}
}

	@vdo/base/objectPool.h

22 #i‚de‡
OBJECT_POOL_H


23 
	#OBJECT_POOL_H


	)

25 
	~"≥rmas£π.h
"

27 
	~"com∂ëi⁄.h
"

28 
	~"ty≥s.h
"

29 
	~"waôQueue.h
"

40 
	$makeObje˘Poﬁ
(*
íåyD©a
, 
Obje˘Poﬁ
 **
poﬁPå
)

41 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

48 
	`‰ìObje˘Poﬁ
(
Obje˘Poﬁ
 **
poﬁPå
);

57 *
	`gëObje˘PoﬁE¡ryD©a
(
Obje˘Poﬁ
 *
poﬁ
);

65 
	`addE¡ryToObje˘Poﬁ
(
Obje˘Poﬁ
 *
poﬁ
, 
RögNode
 *
íåy
);

75 
RögNode
 *
	`ªmoveE¡ryFromObje˘Poﬁ
(
Obje˘Poﬁ
 *
poﬁ
);

85 
	`acquúeE¡ryFromObje˘Poﬁ
(
Obje˘Poﬁ
 *
poﬁ
, 
Waôî
 *
waôî
);

93 
	`ªtu∫E¡ryToObje˘Poﬁ
(
Obje˘Poﬁ
 *
poﬁ
, 
RögNode
 *
íåy
);

103 
	`su•ídObje˘Poﬁ
(
Obje˘Poﬁ
 *
poﬁ
, 
VDOCom∂ëi⁄
 *
com∂ëi⁄
);

112 
	`ªsumeObje˘Poﬁ
(
Obje˘Poﬁ
 *
poﬁ
);

123 
	`˛o£Obje˘Poﬁ
(
Obje˘Poﬁ
 *
poﬁ
, 
VDOCom∂ëi⁄
 *
com∂ëi⁄
);

130 
	`›íObje˘Poﬁ
(
Obje˘Poﬁ
 *
poﬁ
);

139 
uöt64_t
 
	$gëObje˘PoﬁOuègeCou¡
(
Obje˘Poﬁ
 *
poﬁ
)

140 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

	@vdo/base/packer.c

22 
	~"∑ckîI¡î«ls.h
"

24 
	~"loggî.h
"

25 
	~"mem‹yAŒoc.h
"

27 
	~"ÆloˇtögVIO.h
"

28 
	~"com¥essi⁄Sèã.h
"

29 
	~"d©aVIO.h
"

30 
	~"pbnLock.h
"

31 
	~"vdo.h
"

32 
	~"vdoI¡î«l.h
"

40 
ölöe
 
	$as£πOnPackîThªad
(
Packî
 *
∑ckî
, c⁄° *
ˇŒî
)

42 
	`ASSERT_LOG_ONLY
((
	`gëCÆlbackThªadID
(Ë=
∑ckî
->
thªadID
),

43 "%s(ËˇŒed fromÖackîÅhªad", 
ˇŒî
);

44 
	}
}

47 
__©åibuã__
((
w¨n_unu£d_ªsu…
))

48 
ölöe
 
I≈utBö
 *
	$öputBöFromRögNode
(
RögNode
 *
node
)

50 
	`STATIC_ASSERT
(
	`off£tof
(
I≈utBö
, 
rög
) == 0);

51  (
I≈utBö
 *Ë
node
;

52 
	}
}

55 
__©åibuã__
((
w¨n_unu£d_ªsu…
))

56 
ölöe
 
OuçutBö
 *
	$ouçutBöFromRögNode
(
RögNode
 *
node
)

58 
	`STATIC_ASSERT
(
	`off£tof
(
OuçutBö
, 
rög
) == 0);

59  (
OuçutBö
 *Ë
node
;

60 
	}
}

63 
I≈utBö
 *
	$√xtBö
(c⁄° 
Packî
 *
∑ckî
, 
I≈utBö
 *
bö
)

65 i‡(
bö
->
rög
.
√xt
 =&
∑ckî
->
öputBös
) {

66  
NULL
;

68  
	`öputBöFromRögNode
(
bö
->
rög
.
√xt
);

70 
	}
}

73 
I≈utBö
 *
	$gëFuŒe°Bö
(c⁄° 
Packî
 *
∑ckî
)

75 i‡(
	`isRögEm±y
(&
∑ckî
->
öputBös
)) {

76  
NULL
;

78  
	`öputBöFromRögNode
(
∑ckî
->
öputBös
.
√xt
);

80 
	}
}

90 
	$ö£πInS‹ãdLi°
(
Packî
 *
∑ckî
, 
I≈utBö
 *
bö
)

92 
I≈utBö
 *
a˘iveBö
 = 
	`gëFuŒe°Bö
(
∑ckî
);

93 
a˘iveBö
 !
NULL
;

94 
a˘iveBö
 = 
	`√xtBö
(
∑ckî
,áctiveBin)) {

95 i‡(
a˘iveBö
->
‰ìS∑˚
 > 
bö
->freeSpace) {

96 
	`pushRögNode
(&
a˘iveBö
->
rög
, &
bö
->ring);

101 
	`pushRögNode
(&
∑ckî
->
öputBös
, &
bö
->
rög
);

102 
	}
}

109 
__©åibuã__
((
w¨n_unu£d_ªsu…
))

110 
	$makeI≈utBö
(
Packî
 *
∑ckî
)

112 
I≈utBö
 *
bö
;

113 
ªsu…
 = 
	`ALLOCATE_EXTENDED
(
I≈utBö
, 
MAX_COMPRESSION_SLOTS
, 
VIO
 *,

114 
__func__
, &
bö
);

115 i‡(
ªsu…
 !
VDO_SUCCESS
) {

116  
ªsu…
;

119 
bö
->
‰ìS∑˚
 = 
∑ckî
->
böD©aSize
;

120 
	`öôülizeRög
(&
bö
->
rög
);

121 
	`pushRögNode
(&
∑ckî
->
öputBös
, &
bö
->
rög
);

122  
VDO_SUCCESS
;

123 
	}
}

131 
	$pushOuçutBö
(
Packî
 *
∑ckî
, 
OuçutBö
 *
bö
)

133 
	`ASSERT_LOG_ONLY
(!
	`hasWaôîs
(&
bö
->
outgoög
),

135 
	`ASSERT_LOG_ONLY
((
bö
->
out°™dögFøgmíts
 == 0),

137 
∑ckî
->
idÀOuçutBös
[∑ckî->
idÀOuçutBöCou¡
++] = 
bö
;

138 
	}
}

147 
__©åibuã__
((
w¨n_unu£d_ªsu…
))

148 
OuçutBö
 *
	$p›OuçutBö
(
Packî
 *
∑ckî
)

150 i‡(
∑ckî
->
idÀOuçutBöCou¡
 == 0) {

151  
NULL
;

154 
size_t
 
ödex
 = --
∑ckî
->
idÀOuçutBöCou¡
;

155 
OuçutBö
 *
bö
 = 
∑ckî
->
idÀOuçutBös
[
ödex
];

156 
∑ckî
->
idÀOuçutBös
[
ödex
] = 
NULL
;

157  
bö
;

158 
	}
}

169 
__©åibuã__
((
w¨n_unu£d_ªsu…
))

170 
	$makeOuçutBö
(
Packî
 *
∑ckî
, 
PhysiˇlLayî
 *
œyî
)

172 
OuçutBö
 *
ouçut
;

173 
ªsu…
 = 
	`ALLOCATE
(1, 
OuçutBö
, 
__func__
, &
ouçut
);

174 i‡(
ªsu…
 !
VDO_SUCCESS
) {

175  
ªsu…
;

180 
	`öôülizeRög
(&
ouçut
->
rög
);

181 
	`pushRögNode
(&
∑ckî
->
ouçutBös
, &
ouçut
->
rög
);

182 
	`pushOuçutBö
(
∑ckî
, 
ouçut
);

184 
ªsu…
 = 
	`ALLOCATE_EXTENDED
(
Com¥es£dBlock
, 
∑ckî
->
böD©aSize
, ,

185 "com¥es£d block", &
ouçut
->
block
);

186 i‡(
ªsu…
 !
VDO_SUCCESS
) {

187  
ªsu…
;

190  
œyî
->
	`¸óãCom¥es£dWrôeVIO
÷ayî, 
ouçut
, (*Ëouçut->
block
,

191 &
ouçut
->
wrôî
);

192 
	}
}

199 
	$‰ìOuçutBö
(
OuçutBö
 **
böPå
)

201 
OuçutBö
 *
bö
 = *
böPå
;

202 i‡(
bö
 =
NULL
) {

206 
	`un•li˚RögNode
(&
bö
->
rög
);

208 
VIO
 *
vio
 = 
	`ÆloˇtögVIOAsVIO
(
bö
->
wrôî
);

209 
	`‰ìVIO
(&
vio
);

210 
	`FREE
(
bö
->
block
);

211 
	`FREE
(
bö
);

212 *
böPå
 = 
NULL
;

213 
	}
}

216 
	$makePackî
(
PhysiˇlLayî
 *
œyî
,

217 
BlockCou¡
 
öputBöCou¡
,

218 
BlockCou¡
 
ouçutBöCou¡
,

219 c⁄° 
ThªadC⁄fig
 *
thªadC⁄fig
,

220 
Packî
 **
∑ckîPå
)

222 
Packî
 *
∑ckî
;

223 
ªsu…
 = 
	`ALLOCATE_EXTENDED
(
Packî
, 
ouçutBöCou¡
,

224 
OuçutBö
 *, 
__func__
, &
∑ckî
);

225 i‡(
ªsu…
 !
VDO_SUCCESS
) {

226  
ªsu…
;

229 
∑ckî
->
thªadID
 = 
	`gëPackîZ⁄eThªad
(
thªadC⁄fig
);

230 
∑ckî
->
böD©aSize
 = 
VDO_BLOCK_SIZE
 - (
Com¥es£dBlockHódî
);

231 
∑ckî
->
size
 = 
öputBöCou¡
;

232 
∑ckî
->
maxSlŸs
 = 
MAX_COMPRESSION_SLOTS
;

233 
∑ckî
->
ouçutBöCou¡
 = outputBinCount;

234 
	`öôülizeRög
(&
∑ckî
->
öputBös
);

235 
	`öôülizeRög
(&
∑ckî
->
ouçutBös
);

237 
BlockCou¡
 
i
 = 0; i < 
öputBöCou¡
; i++) {

238 
ªsu…
 = 
	`makeI≈utBö
(
∑ckî
);

239 i‡(
ªsu…
 !
VDO_SUCCESS
) {

240 
	`‰ìPackî
(&
∑ckî
);

241  
ªsu…
;

250 
ªsu…
 = 
	`ALLOCATE_EXTENDED
(
I≈utBö
, 
MAXIMUM_USER_VIOS
 / 2, 
VIO
 *, 
__func__
,

251 &
∑ckî
->
ˇn˚ÀdBö
);

252 i‡(
ªsu…
 !
VDO_SUCCESS
) {

253 
	`‰ìPackî
(&
∑ckî
);

254  
ªsu…
;

257 
BlockCou¡
 
i
 = 0; i < 
ouçutBöCou¡
; i++) {

258 
ªsu…
 = 
	`makeOuçutBö
(
∑ckî
, 
œyî
);

259 i‡(
ªsu…
 !
VDO_SUCCESS
) {

260 
	`‰ìPackî
(&
∑ckî
);

261  
ªsu…
;

265 *
∑ckîPå
 = 
∑ckî
;

266  
VDO_SUCCESS
;

267 
	}
}

270 
	$‰ìPackî
(
Packî
 **
∑ckîPå
)

272 
Packî
 *
∑ckî
 = *
∑ckîPå
;

273 i‡(
∑ckî
 =
NULL
) {

277 
I≈utBö
 *
öput
;

278 (
öput
 = 
	`gëFuŒe°Bö
(
∑ckî
)Ë!
NULL
) {

279 
	`un•li˚RögNode
(&
öput
->
rög
);

280 
	`FREE
(
öput
);

283 
	`FREE
(
∑ckî
->
ˇn˚ÀdBö
);

285 
OuçutBö
 *
ouçut
;

286 (
ouçut
 = 
	`p›OuçutBö
(
∑ckî
)Ë!
NULL
) {

287 
	`‰ìOuçutBö
(&
ouçut
);

290 
	`FREE
(
∑ckî
);

291 *
∑ckîPå
 = 
NULL
;

292 
	}
}

301 
ölöe
 
Packî
 *
	$gëPackîFromD©aVIO
(
D©aVIO
 *
d©aVIO
)

303  
	`gëVDOFromD©aVIO
(
d©aVIO
)->
∑ckî
;

304 
	}
}

307 
boﬁ
 
	$isSufficõ¡lyCom¥essibÀ
(
D©aVIO
 *
d©aVIO
)

309 
Packî
 *
∑ckî
 = 
	`gëPackîFromD©aVIO
(
d©aVIO
);

310  (
d©aVIO
->
com¥essi⁄
.
size
 < 
∑ckî
->
böD©aSize
);

311 
	}
}

314 
ThªadID
 
	$gëPackîThªadID
(
Packî
 *
∑ckî
)

316  
∑ckî
->
thªadID
;

317 
	}
}

320 
PackîSèti°ics
 
	$gëPackîSèti°ics
(c⁄° 
Packî
 *
∑ckî
)

327  (
PackîSèti°ics
) {

328 .
com¥es£dFøgmítsWrôãn
 = 
	`ªœxedLﬂd64
(&
∑ckî
->
‰agmítsWrôãn
),

329 .
com¥es£dBlocksWrôãn
 = 
	`ªœxedLﬂd64
(&
∑ckî
->
blocksWrôãn
),

330 .
com¥es£dFøgmítsInPackî
 = 
	`ªœxedLﬂd64
(&
∑ckî
->
‰agmítsPídög
),

332 
	}
}

339 
	$ab‹tPackög
(
D©aVIO
 *
d©aVIO
)

341 
d©aVIO
->
√wM≠≥d
.
°©e
 = 
MAPPING_STATE_UNCOMPRESSED
;

342 
	`£tCom¥essi⁄D⁄e
(
d©aVIO
);

343 
	`ªœxedAdd64
(&
	`gëPackîFromD©aVIO
(
d©aVIO
)->
‰agmítsPídög
, -1);

344 
	`d©aVIOAddTø˚Rec‹d
(
d©aVIO
, 
	`THIS_LOCATION
(
NULL
));

345 
	`c⁄töueD©aVIO
(
d©aVIO
, 
VDO_SUCCESS
);

346 
	}
}

355 
c⁄töueVIOWôhoutPackög
(
Waôî
 *
waôî
,

356 *
unu£d
 
__©åibuã__
((unused)))

358 
ab‹tPackög
(
waôîAsD©aVIO
(
waôî
));

365 
	$m¨kAndC⁄töueCom∂ëi⁄
(
Waôî
 *
waôî
, *
c⁄ãxt
)

367 
D©aVIO
 *
d©aVIO
 = 
	`waôîAsD©aVIO
(
waôî
);

368 
AŒoˇtögVIO
 *
com¥es£dWrôî
 = 
c⁄ãxt
;

374 
d©aVIO
->
com¥essi⁄
.
wrôî
 = 
com¥es£dWrôî
;

375 
d©aVIO
->
√wM≠≥d
.
pbn
 = 
com¥es£dWrôî
->
Æloˇti⁄
;

376 
d©aVIO
->
√wM≠≥d
.
z⁄e
 = 
com¥es£dWrôî
->zone;

378 
VIO
 *
vio
 = 
	`d©aVIOAsVIO
(
d©aVIO
);

379 
vio
->
physiˇl
 = 
	`ÆloˇtögVIOAsVIO
(
com¥es£dWrôî
)->physical;

380 
	`c⁄töueD©aVIO
(
d©aVIO
, 
VDO_SUCCESS
);

381 
	}
}

389 
	$checkFlushProgªss
(
Packî
 *
∑ckî
)

391 i‡(!
∑ckî
->
Êushög


392 || (
∑ckî
->
ˇn˚ÀdBö
->
¶ŸsU£d
 > 0)

393 || (
∑ckî
->
idÀOuçutBöCou¡
 !∑ckî->
ouçutBöCou¡
)) {

397 
∑ckî
->
Êushög
 = 
Ál£
;

398 i‡(
∑ckî
->
˛o£Reque°
 !
NULL
) {

399 
∑ckî
->
˛o£d
 = 
åue
;

400 
	`föishCom∂ëi⁄
(
∑ckî
->
˛o£Reque°
, 
VDO_SUCCESS
);

402 
	}
}

405 
wrôePídögB©ches
(
Packî
 *
∑ckî
);

414 
__©åibuã__
((
w¨n_unu£d_ªsu…
))

415 
boﬁ
 
	$swôchToPackîThªad
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

417 
VIO
 *
vio
 = 
	`asVIO
(
com∂ëi⁄
);

418 
ThªadID
 
thªadID
 = 
vio
->
vdo
->
∑ckî
->threadID;

419 i‡(
com∂ëi⁄
->
ˇŒbackThªadID
 =
thªadID
) {

420  
åue
;

423 
com∂ëi⁄
->
ˇŒbackThªadID
 = 
thªadID
;

424 
	`övokeCÆlback
(
com∂ëi⁄
);

425  
Ál£
;

426 
	}
}

435 
	$föishOuçutBö
(
Packî
 *
∑ckî
, 
OuçutBö
 *
bö
)

437 i‡(
	`hasWaôîs
(&
bö
->
outgoög
)) {

438 
	`nŸifyAŒWaôîs
(&
bö
->
outgoög
, 
c⁄töueVIOWôhoutPackög
, 
NULL
);

441 
	`pushOuçutBö
(
∑ckî
, 
bö
);

442 
	}
}

450 
	$com∂ëeOuçutBö
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

452 i‡(!
	`swôchToPackîThªad
(
com∂ëi⁄
)) {

456 
VIO
 *
vio
 = 
	`asVIO
(
com∂ëi⁄
);

457 i‡(
com∂ëi⁄
->
ªsu…
 !
VDO_SUCCESS
) {

458 
	`logWôhSåögEº‹
(
	`upd©eVIOEº‹Sèts
(
vio
), 
com∂ëi⁄
->
ªsu…
,

460 
PRIu64
 " withÉrror",

461 
vio
->
physiˇl
);

464 
Packî
 *
∑ckî
 = 
vio
->
vdo
->packer;

465 
	`föishOuçutBö
(
∑ckî
, 
com∂ëi⁄
->
∑ª¡
);

466 
	`wrôePídögB©ches
(
∑ckî
);

467 
	`checkFlushProgªss
(
∑ckî
);

468 
	}
}

476 
	$ªÀa£Com¥es£dWrôeLock
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

478 
AŒoˇtögVIO
 *
ÆloˇtögVIO
 = 
	`asAŒoˇtögVIO
(
com∂ëi⁄
);

479 
	`as£πInPhysiˇlZ⁄e
(
ÆloˇtögVIO
);

480 
	`ªÀa£PBNWrôeLock
(
ÆloˇtögVIO
);

481 
	`vioD⁄eCÆlback
(
com∂ëi⁄
);

482 
	}
}

490 
	$föishCom¥es£dWrôe
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

492 
AŒoˇtögVIO
 *
ÆloˇtögVIO
 = 
	`asAŒoˇtögVIO
(
com∂ëi⁄
);

493 
Packî
 *
∑ckî
 = 
	`gëVDOFromAŒoˇtögVIO
(
ÆloˇtögVIO
)->packer;

494 
	`as£πOnPackîThªad
(
∑ckî
, 
__func__
);

495 
	`£tPhysiˇlZ⁄eCÆlback
(
ÆloˇtögVIO
, 
ªÀa£Com¥es£dWrôeLock
,

496 
	`THIS_LOCATION
("$F(meta);cb=releaseLock"));

497 i‡(
com∂ëi⁄
->
ªsu…
 !
VDO_SUCCESS
) {

498 
com∂ëi⁄
->
ªqueue
 = 
åue
;

499 
	`övokeCÆlback
(
com∂ëi⁄
);

503 
OuçutBö
 *
bö
 = 
com∂ëi⁄
->
∑ª¡
;

504 
bö
->
out°™dögFøgmíts
 = bö->
outgoög
.
queueLígth
;

505 
	`ªœxedAdd64
(&
∑ckî
->
blocksWrôãn
, 1);

506 
	`ªœxedAdd64
(&
∑ckî
->
‰agmítsWrôãn
, 
bö
->
out°™dögFøgmíts
);

507 
	`ªœxedAdd64
(&
∑ckî
->
‰agmítsPídög
, -
bö
->
out°™dögFøgmíts
);

508 
	`nŸifyAŒWaôîs
(&
bö
->
outgoög
, 
m¨kAndC⁄töueCom∂ëi⁄
, 
ÆloˇtögVIO
);

509 
	}
}

519 
	$c⁄töueA·îAŒoˇti⁄
(
AŒoˇtögVIO
 *
ÆloˇtögVIO
)

521 
VIO
 *
vio
 = 
	`ÆloˇtögVIOAsVIO
(
ÆloˇtögVIO
);

522 
VDOCom∂ëi⁄
 *
com∂ëi⁄
 = 
	`vioAsCom∂ëi⁄
(
vio
);

523 i‡(
ÆloˇtögVIO
->
Æloˇti⁄
 =
ZERO_BLOCK
) {

524 
com∂ëi⁄
->
ªqueue
 = 
åue
;

525 
	`£tCom∂ëi⁄Resu…
(
com∂ëi⁄
, 
VDO_NO_SPACE
);

526 
	`vioD⁄eCÆlback
(
com∂ëi⁄
);

530 
	`vioAddTø˚Rec‹d
(
vio
, 
	`THIS_LOCATION
("$F(meta);cb=finishCompressedWrite"));

531 
	`£tCÆlback
(
com∂ëi⁄
, 
föishCom¥es£dWrôe
, 
vio
->
vdo
->
∑ckî
->
thªadID
);

532 
com∂ëi⁄
->
œyî
->
	`wrôeCom¥es£dBlock
(
ÆloˇtögVIO
);

533 
	}
}

541 
	$œunchCom¥es£dWrôe
(
Packî
 *
∑ckî
, 
OuçutBö
 *
bö
)

543 i‡(
	`isRódO∆y
(&
	`gëVDOFromAŒoˇtögVIO
(
bö
->
wrôî
)->
ªadO∆yC⁄ãxt
)) {

544 
	`föishOuçutBö
(
∑ckî
, 
bö
);

548 
VIO
 *
vio
 = 
	`ÆloˇtögVIOAsVIO
(
bö
->
wrôî
);

549 
	`ª£tCom∂ëi⁄
(
	`vioAsCom∂ëi⁄
(
vio
));

550 
vio
->
ˇŒback
 = 
com∂ëeOuçutBö
;

551 
vio
->
¥i‹ôy
 = 
VIO_PRIORITY_COMPRESSED_DATA
;

552 
	`ÆloˇãD©aBlock
(
bö
->
wrôî
, 
VIO_COMPRESSED_WRITE_LOCK
,

553 
c⁄töueA·îAŒoˇti⁄
);

554 
	}
}

564 
	$gëNextB©ch
(
Packî
 *
∑ckî
, 
OuçutB©ch
 *
b©ch
)

566 
BlockSize
 
•a˚Remaöög
 = 
∑ckî
->
böD©aSize
;

567 
b©ch
->
¶ŸsU£d
 = 0;

569 
D©aVIO
 *
d©aVIO
;

570 (
d©aVIO
 = 
	`waôîAsD©aVIO
(
	`gëFú°Waôî
(&
∑ckî
->
b©chedD©aVIOs
)))

571 !
NULL
) {

573 i‡((
d©aVIO
->
com¥essi⁄
.
size
 > 
•a˚Remaöög
)

574 || (
b©ch
->
¶ŸsU£d
 =
∑ckî
->
maxSlŸs
)) {

579 
	`dequeueNextWaôî
(&
∑ckî
->
b©chedD©aVIOs
);

580 
b©ch
->
¶Ÿs
[b©ch->
¶ŸsU£d
++] = 
d©aVIO
;

581 
•a˚Remaöög
 -
d©aVIO
->
com¥essi⁄
.
size
;

583 
	}
}

594 
__©åibuã__
((
w¨n_unu£d_ªsu…
))

595 
boﬁ
 
	$wrôeNextB©ch
(
Packî
 *
∑ckî
, 
OuçutBö
 *
ouçut
)

597 
OuçutB©ch
 
b©ch
;

598 
	`gëNextB©ch
(
∑ckî
, &
b©ch
);

600 i‡(
b©ch
.
¶ŸsU£d
 == 0) {

602  
Ál£
;

607 i‡(
b©ch
.
¶ŸsU£d
 == 1) {

608 
	`ab‹tPackög
(
b©ch
.
¶Ÿs
[0]);

609  
Ál£
;

612 
	`ª£tCom¥es£dBlockHódî
(&
ouçut
->
block
->
hódî
);

614 
size_t
 
•a˚U£d
 = 0;

615 
SlŸNumbî
 
¶Ÿ
 = 0; slŸ < 
b©ch
.
¶ŸsU£d
; slot++) {

616 
D©aVIO
 *
d©aVIO
 = 
b©ch
.
¶Ÿs
[
¶Ÿ
];

617 
d©aVIO
->
√wM≠≥d
.
°©e
 = 
	`gëSèãF‹SlŸ
(
¶Ÿ
);

618 
	`putCom¥es£dBlockFøgmít
(
ouçut
->
block
, 
¶Ÿ
, 
•a˚U£d
,

619 
d©aVIO
->
com¥essi⁄
.
d©a
,

620 
d©aVIO
->
com¥essi⁄
.
size
);

621 
•a˚U£d
 +
d©aVIO
->
com¥essi⁄
.
size
;

623 
ªsu…
 = 
	`íqueueD©aVIO
(&
ouçut
->
outgoög
, 
d©aVIO
,

624 
	`THIS_LOCATION
(
NULL
));

625 i‡(
ªsu…
 !
VDO_SUCCESS
) {

626 
	`ab‹tPackög
(
d©aVIO
);

631 
	`œunchCom¥es£dWrôe
(
∑ckî
, 
ouçut
);

632  
åue
;

633 
	}
}

641 
	$addToI≈utBö
(
I≈utBö
 *
bö
, 
D©aVIO
 *
d©aVIO
)

643 
d©aVIO
->
com¥essi⁄
.
bö
 = bin;

644 
d©aVIO
->
com¥essi⁄
.
¶Ÿ
 = 
bö
->
¶ŸsU£d
;

645 
bö
->
öcomög
[bö->
¶ŸsU£d
++] = 
d©aVIO
;

646 
	}
}

655 
	$°¨tNewB©ch
(
Packî
 *
∑ckî
, 
I≈utBö
 *
bö
)

659 
SlŸNumbî
 
i
 = 0; i < 
bö
->
¶ŸsU£d
; i++) {

660 
D©aVIO
 *
d©aVIO
 = 
bö
->
öcomög
[
i
];

661 i‡(!
	`mayWrôeCom¥es£dD©aVIO
(
d©aVIO
)) {

667 
	`addToI≈utBö
(
∑ckî
->
ˇn˚ÀdBö
, 
d©aVIO
);

671 
d©aVIO
->
com¥essi⁄
.
bö
 = 
NULL
;

672 
d©aVIO
->
com¥essi⁄
.
¶Ÿ
 = 0;

674 
ªsu…
 = 
	`íqueueD©aVIO
(&
∑ckî
->
b©chedD©aVIOs
, 
d©aVIO
,

675 
	`THIS_LOCATION
(
NULL
));

676 i‡(
ªsu…
 !
VDO_SUCCESS
) {

678 
	`ab‹tPackög
(
d©aVIO
);

683 
bö
->
¶ŸsU£d
 = 0;

684 
bö
->
‰ìS∑˚
 = 
∑ckî
->
böD©aSize
;

685 
	}
}

695 
	$addD©aVIOToI≈utBö
(
Packî
 *
∑ckî
,

696 
I≈utBö
 *
bö
,

697 
D©aVIO
 *
d©aVIO
)

700 i‡(
bö
->
‰ìS∑˚
 < 
d©aVIO
->
com¥essi⁄
.
size
) {

701 
	`°¨tNewB©ch
(
∑ckî
, 
bö
);

704 
	`addToI≈utBö
(
bö
, 
d©aVIO
);

705 
bö
->
‰ìS∑˚
 -
d©aVIO
->
com¥essi⁄
.
size
;

708 i‡((
bö
->
¶ŸsU£d
 =
∑ckî
->
maxSlŸs
Ë|| (bö->
‰ìS∑˚
 == 0)) {

709 
	`°¨tNewB©ch
(
∑ckî
, 
bö
);

713 
	`ö£πInS‹ãdLi°
(
∑ckî
, 
bö
);

714 
	}
}

724 
	$wrôePídögB©ches
(
Packî
 *
∑ckî
)

726 i‡(
∑ckî
->
wrôögB©ches
) {

738 
∑ckî
->
wrôögB©ches
 = 
åue
;

740 
OuçutBö
 *
ouçut
;

741 
	`hasWaôîs
(&
∑ckî
->
b©chedD©aVIOs
)

742 && ((
ouçut
 = 
	`p›OuçutBö
(
∑ckî
)Ë!
NULL
)) {

743 i‡(!
	`wrôeNextB©ch
(
∑ckî
, 
ouçut
)) {

745 
	`pushOuçutBö
(
∑ckî
, 
ouçut
);

749 
∑ckî
->
wrôögB©ches
 = 
Ál£
;

750 
	}
}

759 
__©åibuã__
((
w¨n_unu£d_ªsu…
))

760 
I≈utBö
 *
	$£À˘I≈utBö
(
Packî
 *
∑ckî
, 
D©aVIO
 *
d©aVIO
)

764 
I≈utBö
 *
fuŒe°Bö
 = 
	`gëFuŒe°Bö
(
∑ckî
);

765 
I≈utBö
 *
bö
 = 
fuŒe°Bö
; bö !
NULL
; bö = 
	`√xtBö
(
∑ckî
, bin)) {

766 i‡(
bö
->
‰ìS∑˚
 >
d©aVIO
->
com¥essi⁄
.
size
) {

767  
bö
;

781 i‡(
d©aVIO
->
com¥essi⁄
.
size


782 >(
∑ckî
->
böD©aSize
 - 
fuŒe°Bö
->
‰ìS∑˚
)) {

783  
NULL
;

788  
fuŒe°Bö
;

789 
	}
}

792 
	$©ãm±Packög
(
D©aVIO
 *
d©aVIO
)

794 
Packî
 *
∑ckî
 = 
	`gëPackîFromD©aVIO
(
d©aVIO
);

795 
	`as£πOnPackîThªad
(
∑ckî
, 
__func__
);

797 
VIOCom¥essi⁄Sèã
 
°©e
 = 
	`gëCom¥essi⁄Sèã
(
d©aVIO
);

798 
ªsu…
 = 
	`ASSERT
((
°©e
.
°©us
 =
VIO_COMPRESSING
),

801 
°©e
.
°©us
);

802 i‡(
ªsu…
 !
VDO_SUCCESS
) {

810 
	`ªœxedAdd64
(&
∑ckî
->
‰agmítsPídög
, 1);

814 i‡(
∑ckî
->
˛o£d
 ||Öackî->
Êushög


815 || (
d©aVIO
->
ÊushGíî©i⁄
 < 
∑ckî
->flushGeneration)) {

816 
	`ab‹tPackög
(
d©aVIO
);

832 
I≈utBö
 *
bö
 = 
	`£À˘I≈utBö
(
∑ckî
, 
d©aVIO
);

833 i‡((
bö
 =
NULL
Ë|| !
	`mayBlockInPackî
(
d©aVIO
)) {

834 
	`ab‹tPackög
(
d©aVIO
);

838 
	`addD©aVIOToI≈utBö
(
∑ckî
, 
bö
, 
d©aVIO
);

839 
	`wrôePídögB©ches
(
∑ckî
);

840 
	}
}

843 
	$ÊushPackî
(
Packî
 *
∑ckî
)

845 
	`as£πOnPackîThªad
(
∑ckî
, 
__func__
);

846 i‡(
∑ckî
->
Êushög
) {

850 
∑ckî
->
Êushög
 = 
åue
;

853 
I≈utBö
 *
bö
 = 
	`gëFuŒe°Bö
(
∑ckî
);

854 
bö
 !
NULL
;

855 
bö
 = 
	`√xtBö
(
∑ckî
, bin)) {

856 
	`°¨tNewB©ch
(
∑ckî
, 
bö
);

861 
	`wrôePídögB©ches
(
∑ckî
);

862 
	`checkFlushProgªss
(
∑ckî
);

863 
	}
}

869 
	$ªmoveFromPackî
(
D©aVIO
 *
d©aVIO
)

871 
I≈utBö
 *
bö
 = 
d©aVIO
->
com¥essi⁄
.bin;

872 
	`ASSERT_LOG_ONLY
((
bö
 !
NULL
), "DataVIO inÖacker hasán input bin");

874 
SlŸNumbî
 
¶Ÿ
 = 
d©aVIO
->
com¥essi⁄
.slot;

875 
bö
->
¶ŸsU£d
--;

876 i‡(
¶Ÿ
 < 
bö
->
¶ŸsU£d
) {

877 
bö
->
öcomög
[
¶Ÿ
] = bö->öcomög[bö->
¶ŸsU£d
];

878 
bö
->
öcomög
[
¶Ÿ
]->
com¥essi⁄
.slot = slot;

881 
d©aVIO
->
com¥essi⁄
.
bö
 = 
NULL
;

882 
d©aVIO
->
com¥essi⁄
.
¶Ÿ
 = 0;

884 
Packî
 *
∑ckî
 = 
	`gëPackîFromD©aVIO
(
d©aVIO
);

885 i‡(
bö
 !
∑ckî
->
ˇn˚ÀdBö
) {

886 
bö
->
‰ìS∑˚
 +
d©aVIO
->
com¥essi⁄
.
size
;

887 
	`ö£πInS‹ãdLi°
(
∑ckî
, 
bö
);

890 
	`ab‹tPackög
(
d©aVIO
);

891 
	`checkFlushProgªss
(
∑ckî
);

892 
	}
}

895 
	$ªmoveLockHﬁdîFromPackî
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

897 
D©aVIO
 *
d©aVIO
 = 
	`asD©aVIO
(
com∂ëi⁄
);

898 
	`as£πInPackîZ⁄e
(
d©aVIO
);

900 
D©aVIO
 *
lockHﬁdî
 = 
d©aVIO
->
com¥essi⁄
.lockHolder;

901 
d©aVIO
->
com¥essi⁄
.
lockHﬁdî
 = 
NULL
;

902 
	`ªmoveFromPackî
(
lockHﬁdî
);

903 
	}
}

906 
	$ö¸emítPackîFlushGíî©i⁄
(
Packî
 *
∑ckî
)

908 
	`as£πOnPackîThªad
(
∑ckî
, 
__func__
);

909 
∑ckî
->
ÊushGíî©i⁄
++;

910 
	`ÊushPackî
(
∑ckî
);

911 
	}
}

914 
	$˛o£Packî
(
Packî
 *
∑ckî
, 
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

916 
	`as£πOnPackîThªad
(
∑ckî
, 
__func__
);

917 
	`ASSERT_LOG_ONLY
((
∑ckî
->
˛o£Reque°
 =
NULL
),

919 
∑ckî
->
˛o£Reque°
 = 
com∂ëi⁄
;

920 
	`ÊushPackî
(
∑ckî
);

921 
	}
}

924 
	$com∂ëeFøgmít
(
D©aVIO
 *
d©aVIO
)

926 
AŒoˇtögVIO
 *
wrôî
 = 
d©aVIO
->
com¥essi⁄
.writer;

927 
d©aVIO
->
com¥essi⁄
.
wrôî
 = 
NULL
;

928 i‡(
wrôî
 =
NULL
) {

932 
VDOCom∂ëi⁄
 *
com∂ëi⁄
 = 
	`ÆloˇtögVIOAsCom∂ëi⁄
(
wrôî
);

933 
OuçutBö
 *
bö
 = 
com∂ëi⁄
->
∑ª¡
;

934 i‡(--
bö
->
out°™dögFøgmíts
 == 0) {

935 
	`övokeCÆlback
(
com∂ëi⁄
);

937 
	}
}

940 
	$ª£tSlŸCou¡
(
Packî
 *
∑ckî
, 
Com¥es£dFøgmítCou¡
 
¶Ÿs
)

942 i‡(
¶Ÿs
 > 
MAX_COMPRESSION_SLOTS
) {

946 
∑ckî
->
maxSlŸs
 = 
¶Ÿs
;

947 
	}
}

950 
	$dumpI≈utBö
(c⁄° 
I≈utBö
 *
bö
, 
boﬁ
 
ˇn˚Àd
)

952 i‡(
bö
->
¶ŸsU£d
 == 0) {

957 
	`logInfo
(" %sBin slotsUsed=%u freeSpace=%zu",

958 (
ˇn˚Àd
 ? "C™˚Àd" : "I≈ut"), 
bö
->
¶ŸsU£d
, bö->
‰ìS∑˚
);

962 
	}
}

965 
	$dumpOuçutBö
(c⁄° 
OuçutBö
 *
bö
)

967 
size_t
 
cou¡
 = 
	`cou¡Waôîs
(&
bö
->
outgoög
);

968 i‡(
cou¡
 == 0) {

973 
	`logInfo
(" OuçutBö c⁄èö†%zu outgoög waôîs", 
cou¡
);

979 
	}
}

982 
	$dumpPackî
(c⁄° 
Packî
 *
∑ckî
)

984 
	`logInfo
("Packer");

985 
	`logInfo
(" flushGíî©i⁄=%" 
PRIu64


987 
∑ckî
->
ÊushGíî©i⁄
, 
	`boﬁToSåög
’ackî->
Êushög
),

988 
	`boﬁToSåög
(
∑ckî
->
˛o£d
), boﬁToSåög’ackî->
wrôögB©ches
));

990 
	`logInfo
(" i≈utBöCou¡=%" 
PRIu64
, 
∑ckî
->
size
);

991 
I≈utBö
 *
bö
 = 
	`gëFuŒe°Bö
(
∑ckî
);

992 
bö
 !
NULL
;

993 
bö
 = 
	`√xtBö
(
∑ckî
, bin)) {

994 
	`dumpI≈utBö
(
bö
, 
Ál£
);

997 
	`dumpI≈utBö
(
∑ckî
->
ˇn˚ÀdBö
, 
åue
);

999 
	`logInfo
(" outputBinCount=%zu idleOutputBinCount=%zu",

1000 
∑ckî
->
ouçutBöCou¡
,Öackî->
idÀOuçutBöCou¡
);

1001 c⁄° 
RögNode
 *
hód
 = &
∑ckî
->
ouçutBös
;

1002 
RögNode
 *
node
 = 
hód
->
√xt
;Çode != head;Çode =Çode->next) {

1003 
	`dumpOuçutBö
(
	`ouçutBöFromRögNode
(
node
));

1005 
	}
}

	@vdo/base/packer.h

22 #i‚de‡
PACKER_H


23 
	#PACKER_H


	)

25 
	~"com∂ëi⁄.h
"

26 
	~"physiˇlLayî.h
"

27 
	~"°©i°ics.h
"

28 
	~"thªadC⁄fig.h
"

29 
	~"ty≥s.h
"

32 
	mDEFAULT_PACKER_INPUT_BINS
 = 16,

33 
	mDEFAULT_PACKER_OUTPUT_BINS
 = 256,

36 
∑ckî
 
	tPackî
;

51 
	$makePackî
(
PhysiˇlLayî
 *
œyî
,

52 
BlockCou¡
 
öputBöCou¡
,

53 
BlockCou¡
 
ouçutBöCou¡
,

54 c⁄° 
ThªadC⁄fig
 *
thªadC⁄fig
,

55 
Packî
 **
∑ckîPå
)

56 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

63 
	`‰ìPackî
(
Packî
 **
∑ckîPå
);

72 
boﬁ
 
	$isSufficõ¡lyCom¥essibÀ
(
D©aVIO
 *
d©aVIO
)

73 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

82 
ThªadID
 
	`gëPackîThªadID
(
Packî
 *
∑ckî
);

91 
PackîSèti°ics
 
	$gëPackîSèti°ics
(c⁄° 
Packî
 *
∑ckî
)

92 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

99 
	`©ãm±Packög
(
D©aVIO
 *
d©aVIO
);

110 
	`ÊushPackî
(
Packî
 *
∑ckî
);

119 
	`ªmoveLockHﬁdîFromPackî
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
);

128 
	`ö¸emítPackîFlushGíî©i⁄
(
Packî
 *
∑ckî
);

137 
	`˛o£Packî
(
Packî
 *
∑ckî
, 
VDOCom∂ëi⁄
 *
com∂ëi⁄
);

146 
	`com∂ëeFøgmít
(
D©aVIO
 *
d©aVIO
);

153 
	`dumpPackî
(c⁄° 
Packî
 *
∑ckî
);

	@vdo/base/packerInternals.h

22 #i‚de‡
PACKER_INTERNALS_H


23 
	#PACKER_INTERNALS_H


	)

25 
	~"∑ckî.h
"

27 
	~"utû/©omic.h
"

29 
	~"com¥es£dBlock.h
"

30 
	~"hódî.h
"

31 
	~"waôQueue.h
"

46 
	söputBö
 {

48 
RögNode
 
	mrög
;

50 
SlŸNumbî
 
	m¶ŸsU£d
;

52 
size_t
 
	m‰ìS∑˚
;

54 
D©aVIO
 *
	möcomög
[];

65 
RögNode
 
	mrög
;

67 
Com¥es£dBlock
 *
	mblock
;

72 
Com¥es£dFøgmítCou¡
 
	mout°™dögFøgmíts
;

74 
AŒoˇtögVIO
 *
	mwrôî
;

76 
WaôQueue
 
	moutgoög
;

77 } 
	tOuçutBö
;

84 
size_t
 
	m¶ŸsU£d
;

85 
D©aVIO
 *
	m¶Ÿs
[
MAX_COMPRESSION_SLOTS
];

86 } 
	tOuçutB©ch
;

88 
	s∑ckî
 {

90 
ThªadID
 
	mthªadID
;

92 
VDOCom∂ëi⁄
 *
	m˛o£Reque°
;

94 
BlockCou¡
 
	msize
;

96 
size_t
 
	mböD©aSize
;

98 
size_t
 
	mmaxSlŸs
;

100 
RögNode
 
	möputBös
;

102 
RögNode
 
	mouçutBös
;

107 
I≈utBö
 *
	mˇn˚ÀdBö
;

110 
Sequí˚Numbî
 
	mÊushGíî©i⁄
;

113 
boﬁ
 
	mÊushög
;

115 
boﬁ
 
	m˛o£d
;

117 
boﬁ
 
	mwrôögB©ches
;

122 
Atomic64
 
	m‰agmítsWrôãn
;

124 
Atomic64
 
	mblocksWrôãn
;

126 
Atomic64
 
	m‰agmítsPídög
;

129 
WaôQueue
 
	mb©chedD©aVIOs
;

132 
size_t
 
	mouçutBöCou¡
;

134 
size_t
 
	midÀOuçutBöCou¡
;

136 
OuçutBö
 *
	midÀOuçutBös
[];

142 
I≈utBö
 *
gëFuŒe°Bö
(c⁄° 
Packî
 *
∑ckî
);

147 
I≈utBö
 *
√xtBö
(c⁄° 
Packî
 *
∑ckî
, I≈utBö *
bö
);

158 
ª£tSlŸCou¡
(
Packî
 *
∑ckî
, 
Com¥es£dFøgmítCou¡
 
¶Ÿs
);

165 
ªmoveFromPackî
(
D©aVIO
 *
d©aVIO
);

	@vdo/base/partitionCopy.c

22 
	~"∑πôi⁄C›y.h
"

24 
	~"mem‹yAŒoc.h
"

26 
	~"com∂ëi⁄.h
"

27 
	~"c⁄°™ts.h
"

28 
	~"exã¡.h
"

31 
	mSTRIDE_LENGTH
 = 2048

39 
VDOCom∂ëi⁄
 
	mcom∂ëi⁄
;

41 
P¨tôi⁄
 *
	msour˚
;

43 
P¨tôi⁄
 *
	mèrgë
;

45 
PhysiˇlBlockNumbî
 
	mcuºítIndex
;

47 
PhysiˇlBlockNumbî
 
	mídögIndex
;

49 *
	md©a
;

51 
VDOExã¡
 *
	mexã¡
;

52 } 
	tC›yCom∂ëi⁄
;

61 
__©åibuã__
((
w¨n_unu£d_ªsu…
))

62 
ölöe


63 
C›yCom∂ëi⁄
 *
	$asC›yCom∂ëi⁄
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

65 
	`STATIC_ASSERT
(
	`off£tof
(
C›yCom∂ëi⁄
, 
com∂ëi⁄
) == 0);

66 
	`as£πCom∂ëi⁄Ty≥
(
com∂ëi⁄
->
ty≥
, 
PARTITION_COPY_COMPLETION
);

67  (
C›yCom∂ëi⁄
 *Ë
com∂ëi⁄
;

68 
	}
}

75 
	$föishC›y
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

77 
VDOCom∂ëi⁄
 *
∑ª¡
 = 
com∂ëi⁄
->parent;

78 
ªsu…
 = 
com∂ëi⁄
->result;

80 
C›yCom∂ëi⁄
 *
c›y
 = 
	`asC›yCom∂ëi⁄
(
com∂ëi⁄
);

81 
	`‰ìExã¡
(&
c›y
->
exã¡
);

82 
	`FREE
(
c›y
->
d©a
);

83 
	`FREE
(
c›y
);

85 
	`föishCom∂ëi⁄
(
∑ª¡
, 
ªsu…
);

86 
	}
}

89 
c›yP¨tôi⁄Såide
(
C›yCom∂ëi⁄
 *
c›y
);

96 
	$com∂ëeWrôeF‹C›y
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

98 
C›yCom∂ëi⁄
 *
c›y
 = 
	`asC›yCom∂ëi⁄
(
com∂ëi⁄
->
∑ª¡
);

99 
c›y
->
cuºítIndex
 +c›y->
exã¡
->
cou¡
;

100 i‡(
c›y
->
cuºítIndex
 >c›y->
ídögIndex
) {

102 
	`föishCom∂ëi⁄
(
com∂ëi⁄
->
∑ª¡
, 
VDO_SUCCESS
);

105 
	`c›yP¨tôi⁄Såide
(
c›y
);

106 
	}
}

114 
	$com∂ëeRódF‹C›y
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

116 
C›yCom∂ëi⁄
 *
c›y
 = 
	`asC›yCom∂ëi⁄
(
com∂ëi⁄
->
∑ª¡
);

117 
PhysiˇlBlockNumbî
 
œyîSèπBlock
;

118 
ªsu…
 = 
	`å™¶©eToPBN
(
c›y
->
èrgë
, c›y->
cuºítIndex
,

119 &
œyîSèπBlock
);

120 i‡(
ªsu…
 !
VDO_SUCCESS
) {

121 
	`föishCom∂ëi⁄
(
com∂ëi⁄
->
∑ª¡
, 
ªsu…
);

125 
com∂ëi⁄
->
ˇŒback
 = 
com∂ëeWrôeF‹C›y
;

126 
	`wrôeMëad©aExã¡
(
	`asVDOExã¡
(
com∂ëi⁄
), 
œyîSèπBlock
);

127 
	}
}

134 
	$c›yP¨tôi⁄Såide
(
C›yCom∂ëi⁄
 *
c›y
)

136 
PhysiˇlBlockNumbî
 
blocksRemaöög


137 (
c›y
->
ídögIndex
 - c›y->
cuºítIndex
);

138 i‡(
blocksRemaöög
 < 
STRIDE_LENGTH
) {

141 
	`‰ìExã¡
(&
c›y
->
exã¡
);

142 
ªsu…
 = 
	`¸óãExã¡
(
c›y
->
com∂ëi⁄
.
œyî
, 
VIO_TYPE_PARTITION_COPY
,

143 
VIO_PRIORITY_HIGH
, 
blocksRemaöög
, 
c›y
->
d©a
,

144 &
c›y
->
exã¡
);

145 i‡(
ªsu…
 !
VDO_SUCCESS
) {

146 
	`föishCom∂ëi⁄
(&
c›y
->
com∂ëi⁄
, 
ªsu…
);

151 
PhysiˇlBlockNumbî
 
œyîSèπBlock
;

152 
ªsu…
 = 
	`å™¶©eToPBN
(
c›y
->
sour˚
, c›y->
cuºítIndex
,

153 &
œyîSèπBlock
);

154 i‡(
ªsu…
 !
VDO_SUCCESS
) {

155 
	`föishCom∂ëi⁄
(&
c›y
->
com∂ëi⁄
, 
ªsu…
);

159 
	`¥ï¨eCom∂ëi⁄
(&
c›y
->
exã¡
->
com∂ëi⁄
, 
com∂ëeRódF‹C›y
,

160 
föishP¨ítCÆlback
, 
c›y
->
com∂ëi⁄
.
ˇŒbackThªadID
,

161 &
c›y
->
com∂ëi⁄
);

162 
	`ªadMëad©aExã¡
(
c›y
->
exã¡
, 
œyîSèπBlock
);

163 
	}
}

176 
__©åibuã__
((
w¨n_unu£d_ªsu…
))

177 
	$öôülizeC›yCom∂ëi⁄
(
PhysiˇlLayî
 *
œyî
,

178 
P¨tôi⁄
 *
sour˚
,

179 
P¨tôi⁄
 *
èrgë
,

180 
VDOCom∂ëi⁄
 *
∑ª¡
,

181 
C›yCom∂ëi⁄
 *
c›y
)

183 
	`öôülizeCom∂ëi⁄
(&
c›y
->
com∂ëi⁄
, 
PARTITION_COPY_COMPLETION
, 
œyî
);

184 
	`¥ï¨eCom∂ëi⁄
(&
c›y
->
com∂ëi⁄
, 
föishC›y
, finishCopy,

185 
∑ª¡
->
ˇŒbackThªadID
,Öarent);

187 
ªsu…
 = 
	`ALLOCATE
((
VDO_BLOCK_SIZE
 * 
STRIDE_LENGTH
), ,

188 "∑πôi⁄ c›yÉxã¡", &
c›y
->
d©a
);

189 i‡(
ªsu…
 !
VDO_SUCCESS
) {

190  
ªsu…
;

193 
ªsu…
 = 
	`¸óãExã¡
(
œyî
, 
VIO_TYPE_PARTITION_COPY
, 
VIO_PRIORITY_HIGH
,

194 
STRIDE_LENGTH
, 
c›y
->
d©a
, &c›y->
exã¡
);

195 i‡(
ªsu…
 !
VDO_SUCCESS
) {

196  
ªsu…
;

199 
c›y
->
sour˚
 = source;

200 
c›y
->
èrgë
 =Åarget;

201 
c›y
->
cuºítIndex
 = 0;

202 
c›y
->
ídögIndex
 = 
	`gëFixedLayoutP¨tôi⁄Size
(
sour˚
);

203  
VDO_SUCCESS
;

204 
	}
}

214 
	$vÆid©eP¨tôi⁄C›y
(
P¨tôi⁄
 *
sour˚
, P¨tôi⁄ *
èrgë
)

216 
BlockCou¡
 
sour˚Size
 = 
	`gëFixedLayoutP¨tôi⁄Size
(
sour˚
);

217 
BlockCou¡
 
èrgëSize
 = 
	`gëFixedLayoutP¨tôi⁄Size
(
èrgë
);

219 
PhysiˇlBlockNumbî
 
sour˚Sèπ
 = 
	`gëFixedLayoutP¨tôi⁄Off£t
(
sour˚
);

220 
PhysiˇlBlockNumbî
 
sour˚End
 = 
sour˚Sèπ
 + 
sour˚Size
;

221 
PhysiˇlBlockNumbî
 
èrgëSèπ
 = 
	`gëFixedLayoutP¨tôi⁄Off£t
(
èrgë
);

222 
PhysiˇlBlockNumbî
 
èrgëEnd
 = 
èrgëSèπ
 + 
èrgëSize
;

224 
ªsu…
 = 
	`ASSERT
(
sour˚Size
 <
èrgëSize
,

227 i‡(
ªsu…
 !
UDS_SUCCESS
) {

228  
ªsu…
;

231  
	`ASSERT
(((
sour˚End
 <
èrgëSèπ
Ë|| (
èrgëEnd
 <
sour˚Sèπ
)),

233 
	}
}

236 
	$c›yP¨tôi⁄Async
(
PhysiˇlLayî
 *
œyî
,

237 
P¨tôi⁄
 *
sour˚
,

238 
P¨tôi⁄
 *
èrgë
,

239 
VDOCom∂ëi⁄
 *
∑ª¡
)

241 
ªsu…
 = 
	`vÆid©eP¨tôi⁄C›y
(
sour˚
, 
èrgë
);

242 i‡(
ªsu…
 !
VDO_SUCCESS
) {

243 
	`föishCom∂ëi⁄
(
∑ª¡
, 
ªsu…
);

247 
C›yCom∂ëi⁄
 *
c›y
;

248 
ªsu…
 = 
	`ALLOCATE
(1, 
C›yCom∂ëi⁄
, 
__func__
, &
c›y
);

249 i‡(
ªsu…
 !
VDO_SUCCESS
) {

250 
	`föishCom∂ëi⁄
(
∑ª¡
, 
ªsu…
);

254 
ªsu…
 = 
	`öôülizeC›yCom∂ëi⁄
(
œyî
, 
sour˚
, 
èrgë
, 
∑ª¡
, 
c›y
);

255 i‡(
ªsu…
 !
VDO_SUCCESS
) {

256 
	`föishCom∂ëi⁄
(&
c›y
->
com∂ëi⁄
, 
ªsu…
);

260 
	`c›yP¨tôi⁄Såide
(
c›y
);

261 
	}
}

	@vdo/base/partitionCopy.h

22 #i‚de‡
PARTITION_COPY_H


23 
	#PARTITION_COPY_H


	)

25 
	~"fixedLayout.h
"

26 
	~"physiˇlLayî.h
"

27 
	~"ty≥s.h
"

37 
c›yP¨tôi⁄Async
(
PhysiˇlLayî
 *
œyî
,

38 
P¨tôi⁄
 *
sour˚
,

39 
P¨tôi⁄
 *
èrgë
,

40 
VDOCom∂ëi⁄
 *
∑ª¡
);

	@vdo/base/pbnLock.c

22 
	~"pbnLock.h
"

24 
	~"loggî.h
"

26 
	~"ÆloˇtögVIO.h
"

27 
	~"blockAŒoˇt‹.h
"

28 
	~"d©aVIO.h
"

29 
	~"ötM≠.h
"

30 
	~"physiˇlZ⁄e.h
"

31 
	~"vioWrôe.h
"

32 
	~"waôQueue.h
"

34 
	tLockQueuî
(
	tD©aVIO
 *
	td©aVIO
, 
	tPBNLock
 *
	tlock
);

36 
	spbnLockIm∂emíèti⁄
 {

37 
PBNLockTy≥
 
	mty≥
;

38 c⁄° *
	m«me
;

39 c⁄° *
	mªÀa£Rós⁄
;

40 
LockQueuî
 *
	mwaôOnLock
;

41 
WaôîCÆlback
 *
	må™s„rLock
;

44 
gëPBNRódLockA·îCom¥es£dWrôeLock
(
Waôî
 *
waôî
,

45 *
c⁄ãxt
);

46 
gëPBNRódLockA·îWrôeLock
(
Waôî
 *
waôî
, *
c⁄ãxt
);

47 
gëPBNRódLockA·îRódLock
(
Waôî
 *
waôî
, *
c⁄ãxt
);

52 c⁄° 
PBNLockIm∂emíèti⁄
 
	gLOCK_IMPLEMENTATIONS
[] = {

53 [
VIO_READ_LOCK
] = {

54 .
ty≥
 = 
VIO_READ_LOCK
,

55 .
	g«me
 = "read",

56 .
	gªÀa£Rós⁄
 = "candidate duplicate",

57 .
	gwaôOnLock
 = 
waôOnPBNRódLock
,

58 .
	gå™s„rLock
 = 
gëPBNRódLockA·îRódLock
,

60 [
VIO_WRITE_LOCK
] = {

61 .
ty≥
 = 
VIO_WRITE_LOCK
,

62 .
	g«me
 = "write",

63 .
	gªÀa£Rós⁄
 = "newlyállocated",

64 .
	gwaôOnLock
 = 
waôOnPBNWrôeLock
,

65 .
	gå™s„rLock
 = 
gëPBNRódLockA·îWrôeLock
,

67 [
VIO_COMPRESSED_WRITE_LOCK
] = {

68 .
ty≥
 = 
VIO_COMPRESSED_WRITE_LOCK
,

69 .
	g«me
 = "compressed write",

70 .
	gªÀa£Rós⁄
 = "failed compression",

71 .
	gwaôOnLock
 = 
waôOnPBNCom¥es£dWrôeLock
,

72 .
	gå™s„rLock
 = 
gëPBNRódLockA·îCom¥es£dWrôeLock
,

74 [
VIO_BLOCK_MAP_WRITE_LOCK
] = {

75 .
ty≥
 = 
VIO_BLOCK_MAP_WRITE_LOCK
,

76 .
	g«me
 = "block map write",

77 .
	gªÀa£Rós⁄
 = "block map write",

78 .
	gwaôOnLock
 = 
waôOnPBNBlockM≠WrôeLock
,

79 .
	gå™s„rLock
 = 
NULL
,

84 
ölöe
 
boﬁ
 
	$hasLockTy≥
(c⁄° 
PBNLock
 *
lock
, 
PBNLockTy≥
 
ty≥
)

86  (
lock
->
im∂emíèti⁄
 =&
LOCK_IMPLEMENTATIONS
[
ty≥
]);

87 
	}
}

90 
boﬁ
 
	$isPBNRódLock
(c⁄° 
PBNLock
 *
lock
)

92  
	`hasLockTy≥
(
lock
, 
VIO_READ_LOCK
);

93 
	}
}

102 
__©åibuã__
((
w¨n_unu£d_ªsu…
))

103 
boﬁ
 
	$isPBNCom¥es£dWrôeLock
(c⁄° 
PBNLock
 *
lock
)

105  
	`hasLockTy≥
(
lock
, 
VIO_COMPRESSED_WRITE_LOCK
);

106 
	}
}

109 
	$öôülizePBNLock
(
PBNLock
 *
lock
, 
PBNLockTy≥
 
ty≥
)

111 
lock
->
hﬁdî
 = 
NULL
;

112 
lock
->
im∂emíèti⁄
 = &
LOCK_IMPLEMENTATIONS
[
ty≥
];

113 
	`öôülizeWaôQueue
(&
lock
->
waôîs
);

114 
	}
}

122 
	$ªåyPBNRódLock
(
D©aVIO
 *
waôî
, 
PBNLock
 *
lock
)

133 
	`å™s„rAŒWaôîs
(&
lock
->
waôîs
, &
waôî
->
lockRëryWaôîs
);

135 
	`d©aVIOAsCom∂ëi⁄
(
waôî
)->
ªqueue
 = 
åue
;

136 
	`œunchDu∂iˇãZ⁄eCÆlback
(
waôî
, 
acquúePBNRódLock
,

137 
	`THIS_LOCATION
("$F;cb=acquirePBNRL"));

138 
	}
}

147 
	$gëPBNRódLockA·îCom¥es£dWrôeLock
(
Waôî
 *
waôî
,

148 *
c⁄ãxt
)

150 
	`ªåyPBNRódLock
(
	`waôîAsD©aVIO
(
waôî
), (
PBNLock
 *Ë
c⁄ãxt
);

151 
	}
}

160 
	$gëPBNRódLockA·îWrôeLock
(
Waôî
 *
waôî
, *
c⁄ãxt
)

162 
D©aVIO
 *
d©aVIO
 = 
	`waôîAsD©aVIO
(
waôî
);

163 
PBNLock
 *
lock
 = (PBNLock *Ë
c⁄ãxt
;

164 
D©aVIO
 *
lockHﬁdî
 = 
	`lockHﬁdîAsD©aVIO
(
lock
);

165 i‡(
d©aVIO
->
du∂iˇã
.
pbn
 !
lockHﬁdî
->
√wM≠≥d
.pbn) {

176 
	`£tDu∂iˇãLoˇti⁄
(
d©aVIO
, 
lockHﬁdî
->
√wM≠≥d
);

179 
	`ªåyPBNRódLock
(
d©aVIO
, 
lock
);

180 
	}
}

189 
	$gëPBNRódLockA·îRódLock
(
Waôî
 *
waôî
, *
c⁄ãxt
)

191 
D©aVIO
 *
d©aVIO
 = 
	`waôîAsD©aVIO
(
waôî
);

192 
PBNLock
 *
lock
 = (PBNLock *Ë
c⁄ãxt
;

193 
D©aVIO
 *
lockHﬁdî
 = 
	`lockHﬁdîAsD©aVIO
(
lock
);

194 i‡(
lockHﬁdî
->
rﬁÀdOvî
) {

195 
	`£tDu∂iˇãLoˇti⁄
(
d©aVIO
, 
lockHﬁdî
->
√wM≠≥d
);

196 } i‡(
d©aVIO
->
du∂iˇã
.
pbn
 !
lockHﬁdî
->duplicate.pbn) {

206 
	`£tDu∂iˇãLoˇti⁄
(
d©aVIO
, 
lockHﬁdî
->
du∂iˇã
);

209 
	`ªåyPBNRódLock
(
d©aVIO
, 
lock
);

210 
	}
}

213 
AŒoˇtögVIO
 *
	$lockHﬁdîAsAŒoˇtögVIO
(c⁄° 
PBNLock
 *
lock
)

215 
	`ASSERT_LOG_ONLY
(!
	`isPBNRódLock
(
lock
), "allocationÜock isÇotáÑeadÜock");

216  
lock
->
hﬁdî
;

217 
	}
}

220 
D©aVIO
 *
	$lockHﬁdîAsD©aVIO
(c⁄° 
PBNLock
 *
lock
)

222 
	`ASSERT_LOG_ONLY
(!
	`isPBNCom¥es£dWrôeLock
(
lock
),

224  
	`ÆloˇtögVIOAsD©aVIO
(
lock
->
hﬁdî
);

225 
	}
}

228 
	$waôOnPBNLock
(
D©aVIO
 *
d©aVIO
, 
PBNLock
 *
lock
)

230 
lock
->
im∂emíèti⁄
->
	`waôOnLock
(
d©aVIO
,Üock);

231 
	}
}

234 
	$nŸifyPBNLockWaôîs
(
PBNLock
 *
lock
)

236 
	`nŸifyNextWaôî
(&
lock
->
waôîs
,Üock->
im∂emíèti⁄
->
å™s„rLock
,Üock);

239 
lock
->
hﬁdî
 = 
NULL
;

240 
	}
}

243 
	$assignProvisi⁄ÆRe„ªn˚
(
PBNLock
 *
lock
)

245 
	`ASSERT_LOG_ONLY
(!
lock
->
hasProvisi⁄ÆRe„ªn˚
,

247 
lock
->
hasProvisi⁄ÆRe„ªn˚
 = 
åue
;

248 
	}
}

251 
	$u«ssignProvisi⁄ÆRe„ªn˚
(
PBNLock
 *
lock
)

253 
lock
->
hasProvisi⁄ÆRe„ªn˚
 = 
Ál£
;

254 
	}
}

257 
	$ªÀa£Provisi⁄ÆRe„ªn˚
(
PBNLock
 *
lock
,

258 
PhysiˇlBlockNumbî
 
lockedPBN
,

259 
BlockAŒoˇt‹
 *
Æloˇt‹
)

261 i‡(
	`hasProvisi⁄ÆRe„ªn˚
(
lock
)) {

262 
	`ªÀa£BlockRe„ªn˚
(
Æloˇt‹
, 
lockedPBN
,

263 
lock
->
im∂emíèti⁄
->
ªÀa£Rós⁄
);

264 
	`u«ssignProvisi⁄ÆRe„ªn˚
(
lock
);

266 
	}
}

	@vdo/base/pbnLock.h

22 #i‚de‡
PBN_LOCK_H


23 
	#PBN_LOCK_H


	)

25 
	~"ty≥s.h
"

26 
	~"waôQueue.h
"

32 
	mVIO_READ_LOCK
 = 0,

33 
	mVIO_WRITE_LOCK
,

34 
	mVIO_COMPRESSED_WRITE_LOCK
,

35 
	mVIO_BLOCK_MAP_WRITE_LOCK
,

36 } 
	tPBNLockTy≥
;

38 
pbnLockIm∂emíèti⁄
 
	tPBNLockIm∂emíèti⁄
;

43 
	spbnLock
 {

45 
AŒoˇtögVIO
 *
	mhﬁdî
;

47 
WaôQueue
 
	mwaôîs
;

49 c⁄° 
PBNLockIm∂emíèti⁄
 *
	mim∂emíèti⁄
;

54 
boﬁ
 
	mhasProvisi⁄ÆRe„ªn˚
;

63 
öôülizePBNLock
(
PBNLock
 *
lock
, 
PBNLockTy≥
 
ty≥
);

73 
AŒoˇtögVIO
 *
	$lockHﬁdîAsAŒoˇtögVIO
(c⁄° 
PBNLock
 *
lock
)

74 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

84 
D©aVIO
 *
	$lockHﬁdîAsD©aVIO
(c⁄° 
PBNLock
 *
lock
)

85 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

95 
ölöe
 
boﬁ
 
	$isPBNLocked
(c⁄° 
PBNLock
 *
lock
)

97  ((
lock
 !
NULL
Ë&& (lock->
hﬁdî
 != NULL));

98 
	}
}

107 
boﬁ
 
	$isPBNRódLock
(c⁄° 
PBNLock
 *
lock
)

108 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

116 
	`waôOnPBNLock
(
D©aVIO
 *
d©aVIO
, 
PBNLock
 *
lock
);

125 
	`nŸifyPBNLockWaôîs
(
PBNLock
 *
lock
);

132 
ölöe
 
boﬁ
 
	$hasProvisi⁄ÆRe„ªn˚
(
PBNLock
 *
lock
)

134  ((
lock
 !
NULL
Ë&&Üock->
hasProvisi⁄ÆRe„ªn˚
);

135 
	}
}

142 
assignProvisi⁄ÆRe„ªn˚
(
PBNLock
 *
lock
);

150 
u«ssignProvisi⁄ÆRe„ªn˚
(
PBNLock
 *
lock
);

160 
ªÀa£Provisi⁄ÆRe„ªn˚
(
PBNLock
 *
lock
,

161 
PhysiˇlBlockNumbî
 
lockedPBN
,

162 
BlockAŒoˇt‹
 *
Æloˇt‹
);

	@vdo/base/pbnLockPool.c

22 
	~"pbnLockPoﬁ.h
"

24 
	~"loggî.h
"

25 
	~"mem‹yAŒoc.h
"

26 
	~"≥rmas£π.h
"

28 
	~"rögNode.h
"

29 
	~"pbnLock.h
"

30 
	~"waôQueue.h
"

38 
	uidÀPBNLock
 {

40 
RögNode
 
	mnode
;

42 
PBNLock
 
	mlock
;

43 } 
	tIdÀPBNLock
;

48 
	spbnLockPoﬁ
 {

50 
size_t
 
	mˇ∑côy
;

52 
size_t
 
	mb‹rowed
;

54 
RögNode
 
	midÀRög
;

56 
IdÀPBNLock
 
	mlocks
[];

60 
	$makePBNLockPoﬁ
(
size_t
 
ˇ∑côy
, 
PBNLockPoﬁ
 **
poﬁPå
)

62 
PBNLockPoﬁ
 *
poﬁ
;

63 
ªsu…
 = 
	`ALLOCATE_EXTENDED
(
PBNLockPoﬁ
, 
ˇ∑côy
, 
IdÀPBNLock
, 
__func__
,

64 &
poﬁ
);

65 i‡(
ªsu…
 !
VDO_SUCCESS
) {

66  
ªsu…
;

69 
poﬁ
->
ˇ∑côy
 = capacity;

70 
poﬁ
->
b‹rowed
 = 
ˇ∑côy
;

71 
	`öôülizeRög
(&
poﬁ
->
idÀRög
);

73 
size_t
 
i
 = 0; i < 
ˇ∑côy
; i++) {

74 
PBNLock
 *
lock
 = &
poﬁ
->
locks
[
i
].lock;

75 
	`ªtu∫PBNLockToPoﬁ
(
poﬁ
, &
lock
);

78 *
poﬁPå
 = 
poﬁ
;

79  
VDO_SUCCESS
;

80 
	}
}

83 
	$‰ìPBNLockPoﬁ
(
PBNLockPoﬁ
 **
poﬁPå
)

85 i‡(*
poﬁPå
 =
NULL
) {

89 
PBNLockPoﬁ
 *
poﬁ
 = *
poﬁPå
;

90 
	`ASSERT_LOG_ONLY
(
poﬁ
->
b‹rowed
 == 0,

93 
poﬁ
->
b‹rowed
);

94 
	`FREE
(
poﬁ
);

95 *
poﬁPå
 = 
NULL
;

96 
	}
}

99 
	$b‹rowPBNLockFromPoﬁ
(
PBNLockPoﬁ
 *
poﬁ
,

100 
PBNLockTy≥
 
ty≥
,

101 
PBNLock
 **
lockPå
)

103 i‡(
poﬁ
->
b‹rowed
 >poﬁ->
ˇ∑côy
) {

104  
	`logEº‹WôhSåögEº‹
(
VDO_LOCK_ERROR
,

107 
poﬁ
->
b‹rowed
 += 1;

109 
RögNode
 *
idÀNode
 = 
	`p›RögNode
(&
poﬁ
->
idÀRög
);

110 
	`STATIC_ASSERT
(
	`off£tof
(
IdÀPBNLock
, 
node
Ë=off£tof(IdÀPBNLock, 
lock
));

111 
PBNLock
 *
lock
 = (PBNLock *Ë
idÀNode
;

112 
	`öôülizePBNLock
(
lock
, 
ty≥
);

114 *
lockPå
 = 
lock
;

115  
VDO_SUCCESS
;

116 
	}
}

119 
	$ªtu∫PBNLockToPoﬁ
(
PBNLockPoﬁ
 *
poﬁ
, 
PBNLock
 **
lockPå
)

122 
PBNLock
 *
lock
 = *
lockPå
;

123 *
lockPå
 = 
NULL
;

125 
	`ASSERT_LOG_ONLY
(!
	`hasWaôîs
(&
lock
->
waôîs
),

130 
	`mem£t
(
lock
, 0, (*lock));

132 
RögNode
 *
idÀNode
 = (RögNodê*Ë
lock
;

133 
	`öôülizeRög
(
idÀNode
);

134 
	`pushRögNode
(&
poﬁ
->
idÀRög
, 
idÀNode
);

136 
	`ASSERT_LOG_ONLY
(
poﬁ
->
b‹rowed
 > 0, "shouldn'tÑeturn moreÅhan borrowed");

137 
poﬁ
->
b‹rowed
 -= 1;

138 
	}
}

	@vdo/base/pbnLockPool.h

22 #i‚de‡
PBN_LOCK_POOL_H


23 
	#PBN_LOCK_POOL_H


	)

25 
	~"pbnLock.h
"

26 
	~"ty≥s.h
"

28 
pbnLockPoﬁ
 
	tPBNLockPoﬁ
;

38 
	$makePBNLockPoﬁ
(
size_t
 
ˇ∑côy
, 
PBNLockPoﬁ
 **
poﬁPå
)

39 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

48 
	`‰ìPBNLockPoﬁ
(
PBNLockPoﬁ
 **
poﬁPå
);

62 
	$b‹rowPBNLockFromPoﬁ
(
PBNLockPoﬁ
 *
poﬁ
,

63 
PBNLockTy≥
 
ty≥
,

64 
PBNLock
 **
lockPå
)

65 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

75 
	`ªtu∫PBNLockToPoﬁ
(
PBNLockPoﬁ
 *
poﬁ
, 
PBNLock
 **
lockPå
);

	@vdo/base/physicalLayer.c

22 
	~"physiˇlLayî.h
"

24 
PhysiˇlLayîGëãr
 *
	gphysiˇlLayîGëãr
;

27 
	$ªgi°îPhysiˇlLayîGëãr
(
PhysiˇlLayîGëãr
 *
gëãr
)

29 
physiˇlLayîGëãr
 = 
gëãr
;

30 
	}
}

33 
PhysiˇlLayî
 *
	$gëPhysiˇlLayî
()

35 i‡(
physiˇlLayîGëãr
 !
NULL
) {

36  (*
physiˇlLayîGëãr
)();

38  
NULL
;

39 
	}
}

	@vdo/base/physicalLayer.h

22 #i‚de‡
PHYSICAL_LAYER_H


23 
	#PHYSICAL_LAYER_H


	)

25 
	~"ty≥s.h
"

27 c⁄° 
CRC32Checksum
 
	gINITIAL_CHECKSUM
 = 0xffffffff;

31 
	mCHECKSUM_SIZE
 = (
CRC32Checksum
),

38 
	mHEARTBEAT_INTERVAL
 = 52000,

46 
	tLayîDe°ru˘‹
(
	tPhysiˇlLayî
 **
	tœyîPå
);

57 
uöt32_t
 
	tCRC32Upd©î
(
	tCRC32Checksum
 
	t¸c
,

58 c⁄° 
	tbyã
 *
	tbuf„r
,

59 
	tsize_t
 
	tÀngth
);

68 
BlockCou¡
 
	tBlockCou¡Gëãr
(
	tPhysiˇlLayî
 *
	tœyî
);

81 
	tBuf„rAŒoˇt‹
(
	tPhysiˇlLayî
 *
	tœyî
,

82 
	tsize_t
 
	tbyãs
,

83 c⁄° *
	twhy
,

84 **
	tbuf„rPå
);

99 
	tExã¡Ródî
(
	tPhysiˇlLayî
 *
	tœyî
,

100 
	tPhysiˇlBlockNumbî
 
	t°¨tBlock
,

101 
	tsize_t
 
	tblockCou¡
,

102 *
	tbuf„r
,

103 
	tsize_t
 *
	tblocksRód
);

118 
	tExã¡Wrôî
(
	tPhysiˇlLayî
 *
	tœyî
,

119 
	tPhysiˇlBlockNumbî
 
	t°¨tBlock
,

120 
	tsize_t
 
	tblockCou¡
,

121 *
	tbuf„r
,

122 
	tsize_t
 *
	tblocksWrôãn
);

136 
	tMëad©aVIOCª©‹
(
	tPhysiˇlLayî
 *
	tœyî
,

137 
	tVIOTy≥
 
	tvioTy≥
,

138 
	tVIOPri‹ôy
 
	t¥i‹ôy
,

139 *
	t∑ª¡
,

140 *
	td©a
,

141 
	tVIO
 **
	tvioPå
);

153 
	tCom¥es£dWrôeVIOCª©‹
(
	tPhysiˇlLayî
 *
	tœyî
,

154 *
	t∑ª¡
,

155 *
	td©a
,

156 
	tAŒoˇtögVIO
 **
	tÆloˇtögVIOPå
);

163 
	tVIODe°ru˘‹
(
	tVIO
 **
	tvioPå
);

170 
AsyncD©aO≥øti⁄
 
	tD©aVIOZî€r
;

178 
	tD©aC›õr
(
	tD©aVIO
 *
	tsour˚
, D©aVIO *
	tde°ö©i⁄
);

186 
AsyncD©aO≥øti⁄
 
	tD©aModifõr
;

195 
AsyncD©aO≥øti⁄
 
	tD©aHashî
;

207 
AsyncD©aO≥øti⁄
 
	tDu∂iˇti⁄Checkî
;

219 
AsyncD©aO≥øti⁄
 
	tDu∂iˇti⁄Vîifõr
;

230 
AsyncD©aO≥øti⁄
 
	tD©aRódî
;

237 
AsyncO≥øti⁄
 
	tMëad©aRódî
;

244 
AsyncD©aO≥øti⁄
 
	tD©aWrôî
;

251 
AsyncO≥øti⁄
 
	tMëad©aWrôî
;

260 
AsyncD©aO≥øti⁄
 
	tD©aAcknowÀdgî
;

270 
boﬁ
 
	tD©aVIOCom∑øt‹
(
	tD©aVIO
 *
	tfú°
, D©aVIO *
	t£c⁄d
);

277 
AsyncD©aO≥øti⁄
 
	tD©aCom¥ess‹
;

284 
AsyncD©aO≥øti⁄
 
	tAlbúeoUpd©î
;

291 
	tFlushCom∂ëe
(
	tVDOFlush
 **
	tvdoFlush
);

300 
boﬁ
 
	tFlushQuîõr
(
	tPhysiˇlLayî
 *
	tœyî
);

311 
	tEnqueuóbÀCª©‹
(
	tVDOCom∂ëi⁄
 *
	tcom∂ëi⁄
);

318 
	tEnqueuóbÀDe°ru˘‹
(
	tEnqueuóbÀ
 **
	tíqueuóbÀPå
);

326 
	tEnqueuî
(
	tEnqueuóbÀ
 *
	tíqueuóbÀ
);

334 
	tO≥øti⁄Waôî
(
	tPhysiˇlLayî
 *
	tœyî
);

341 
	tO≥øti⁄Com∂ëe
(
	tPhysiˇlLayî
 *
	tœyî
);

348 
ThªadID
 
	tThªadIDGëãr
();

355 
PhysiˇlLayî
 *
	tPhysiˇlLayîGëãr
();

360 
	sphysiˇlLayî
 {

362 
LayîDe°ru˘‹
 *
	mde°roy
;

365 
CRC32Upd©î
 *
	mupd©eCRC32
;

366 
BlockCou¡Gëãr
 *
	mgëBlockCou¡
;

367 
BlockCou¡Gëãr
 *
	mgëD©aRegi⁄Off£t
;

370 
Buf„rAŒoˇt‹
 *
	mÆloˇãIOBuf„r
;

371 
Exã¡Ródî
 *
	mªadî
;

372 
Exã¡Wrôî
 *
	mwrôî
;

374 
FlushQuîõr
 *
	misFlushRequúed
;

377 
Mëad©aVIOCª©‹
 *
	m¸óãMëad©aVIO
;

378 
Com¥es£dWrôeVIOCª©‹
 *
	m¸óãCom¥es£dWrôeVIO
;

379 
VIODe°ru˘‹
 *
	m‰ìVIO
;

380 
D©aVIOZî€r
 *
	mzîoD©aVIO
;

381 
D©aC›õr
 *
	mc›yD©a
;

382 
D©aModifõr
 *
	m≠∂yP¨tülWrôe
;

385 
D©aHashî
 *
	mhashD©a
;

386 
Du∂iˇti⁄Checkî
 *
	mcheckF‹Du∂iˇti⁄
;

387 
Du∂iˇti⁄Vîifõr
 *
	mvîifyDu∂iˇti⁄
;

388 
D©aRódî
 *
	mªadD©a
;

389 
D©aWrôî
 *
	mwrôeD©a
;

390 
Com¥es£dWrôî
 *
	mwrôeCom¥es£dBlock
;

391 
Mëad©aRódî
 *
	mªadMëad©a
;

392 
Mëad©aWrôî
 *
	mwrôeMëad©a
;

393 
Mëad©aWrôî
 *
	mÊush
;

394 
D©aAcknowÀdgî
 *
	macknowÀdgeD©aVIO
;

395 
D©aVIOCom∑øt‹
 *
	mcom∑ªD©aVIOs
;

396 
D©aCom¥ess‹
 *
	mcom¥essD©aVIO
;

397 
AlbúeoUpd©î
 *
	mupd©eAlbúeo
;

400 
FlushCom∂ëe
 *
	mcom∂ëeFlush
;

401 
EnqueuóbÀCª©‹
 *
	m¸óãEnqueuóbÀ
;

402 
EnqueuóbÀDe°ru˘‹
 *
	mde°royEnqueuóbÀ
;

403 
Enqueuî
 *
	míqueue
;

404 
O≥øti⁄Waôî
 *
	mwaôF‹AdmöO≥øti⁄
;

405 
O≥øti⁄Com∂ëe
 *
	mcom∂ëeAdmöO≥øti⁄
;

408 
ThªadIDGëãr
 *
	mgëCuºítThªadID
;

416 
ªgi°îPhysiˇlLayîGëãr
(
PhysiˇlLayîGëãr
 *
gëãr
);

423 
PhysiˇlLayî
 *
gëPhysiˇlLayî
();

430 
ölöe
 
ThªadID
 
	$gëCÆlbackThªadID
()

432  
	`gëPhysiˇlLayî
()->
	`gëCuºítThªadID
();

433 
	}
}

	@vdo/base/physicalZone.c

22 
	~"physiˇlZ⁄e.h
"

24 
	~"mem‹yAŒoc.h
"

26 
	~"blockAŒoˇt‹.h
"

27 
	~"blockM≠.h
"

28 
	~"com∂ëi⁄.h
"

29 
	~"c⁄°™ts.h
"

30 
	~"Êush.h
"

31 
	~"ötM≠.h
"

32 
	~"pbnLock.h
"

33 
	~"pbnLockPoﬁ.h
"

34 
	~"¶abDïŸ.h
"

35 
	~"vdoI¡î«l.h
"

40 
	mLOCK_POOL_CAPACITY
 = 2 * 
MAXIMUM_USER_VIOS
 + 
DEFAULT_PACKER_OUTPUT_BINS
,

43 
	sphysiˇlZ⁄e
 {

45 
Z⁄eCou¡
 
	mz⁄eNumbî
;

47 
ThªadD©a
 *
	mthªadD©a
;

49 
I¡M≠
 *
	mpbnO≥øti⁄s
;

51 
PBNLockPoﬁ
 *
	mlockPoﬁ
;

53 
BlockAŒoˇt‹
 *
	mÆloˇt‹
;

57 
	$makePhysiˇlZ⁄e
(
VDO
 *
vdo
, 
Z⁄eCou¡
 
z⁄eNumbî
, 
PhysiˇlZ⁄e
 **
z⁄ePå
)

59 
PhysiˇlZ⁄e
 *
z⁄e
;

60 
ªsu…
 = 
	`ALLOCATE
(1, 
PhysiˇlZ⁄e
, 
__func__
, &
z⁄e
);

61 i‡(
ªsu…
 !
VDO_SUCCESS
) {

62  
ªsu…
;

65 
ªsu…
 = 
	`makeI¡M≠
(
LOCK_MAP_CAPACITY
, 0, &
z⁄e
->
pbnO≥øti⁄s
);

66 i‡(
ªsu…
 !
VDO_SUCCESS
) {

67 
	`‰ìPhysiˇlZ⁄e
(&
z⁄e
);

68  
ªsu…
;

71 
ªsu…
 = 
	`makePBNLockPoﬁ
(
LOCK_POOL_CAPACITY
, &
z⁄e
->
lockPoﬁ
);

72 i‡(
ªsu…
 !
VDO_SUCCESS
) {

73 
	`‰ìPhysiˇlZ⁄e
(&
z⁄e
);

74  
ªsu…
;

77 
ThªadID
 
thªadID
 = 
	`gëPhysiˇlZ⁄eThªad
(
	`gëThªadC⁄fig
(
vdo
), 
z⁄eNumbî
);

78 
z⁄e
->
z⁄eNumbî
 = zoneNumber;

79 
z⁄e
->
thªadD©a
 = &
vdo
->thªadD©a[
thªadID
];

80 
z⁄e
->
Æloˇt‹
 = 
	`gëBlockAŒoˇt‹F‹Z⁄e
(
vdo
->
dïŸ
, 
z⁄eNumbî
);

82 *
z⁄ePå
 = 
z⁄e
;

83  
VDO_SUCCESS
;

84 
	}
}

87 
	$‰ìPhysiˇlZ⁄e
(
PhysiˇlZ⁄e
 **
z⁄ePå
)

89 i‡(*
z⁄ePå
 =
NULL
) {

93 
PhysiˇlZ⁄e
 *
z⁄e
 = *
z⁄ePå
;

94 
	`‰ìPBNLockPoﬁ
(&
z⁄e
->
lockPoﬁ
);

95 
	`‰ìI¡M≠
(&
z⁄e
->
pbnO≥øti⁄s
);

96 
	`FREE
(
z⁄e
);

97 *
z⁄ePå
 = 
NULL
;

98 
	}
}

101 
Z⁄eCou¡
 
	$gëPhysiˇlZ⁄eNumbî
(c⁄° 
PhysiˇlZ⁄e
 *
z⁄e
)

103  
z⁄e
->
z⁄eNumbî
;

104 
	}
}

107 
ThªadID
 
	$gëPhysiˇlZ⁄eThªadID
(c⁄° 
PhysiˇlZ⁄e
 *
z⁄e
)

109  
z⁄e
->
thªadD©a
->
thªadID
;

110 
	}
}

113 
BlockAŒoˇt‹
 *
	$gëBlockAŒoˇt‹
(c⁄° 
PhysiˇlZ⁄e
 *
z⁄e
)

115  
z⁄e
->
Æloˇt‹
;

116 
	}
}

119 
PBNLock
 *
	$gëPBNLock
(
PhysiˇlZ⁄e
 *
z⁄e
, 
PhysiˇlBlockNumbî
 
pbn
)

121  ((
z⁄e
 =
NULL
Ë? NULL : 
	`ötM≠Gë
(z⁄e->
pbnO≥øti⁄s
, 
pbn
));

122 
	}
}

125 
	$©ãm±PBNLock
(
PhysiˇlZ⁄e
 *
z⁄e
,

126 
PhysiˇlBlockNumbî
 
pbn
,

127 
PBNLockTy≥
 
ty≥
,

128 
PBNLock
 **
lockPå
)

132 
PBNLock
 *
√wLock
;

133 
ªsu…
 = 
	`b‹rowPBNLockFromPoﬁ
(
z⁄e
->
lockPoﬁ
, 
ty≥
, &
√wLock
);

134 i‡(
ªsu…
 !
VDO_SUCCESS
) {

135 
	`ASSERT_LOG_ONLY
(
Ál£
, "mustálways beábleÅo borrowá PBNÜock");

136  
ªsu…
;

139 
PBNLock
 *
lock
;

140 
ªsu…
 = 
	`ötM≠Put
(
z⁄e
->
pbnO≥øti⁄s
, 
pbn
, 
√wLock
, 
Ál£
,

141 (**Ë&
lock
);

142 i‡(
ªsu…
 !
VDO_SUCCESS
) {

143 
	`ªtu∫PBNLockToPoﬁ
(
z⁄e
->
lockPoﬁ
, &
√wLock
);

144  
ªsu…
;

147 i‡(
lock
 !
NULL
) {

149 
	`ªtu∫PBNLockToPoﬁ
(
z⁄e
->
lockPoﬁ
, &
√wLock
);

151 
ªsu…
 = 
	`ASSERT
(
	`isPBNLocked
(
lock
),

152 "physiˇ»block %" 
PRIu64
 "Üock hñd", 
pbn
);

153 i‡(
ªsu…
 !
VDO_SUCCESS
) {

154  
ªsu…
;

156 *
lockPå
 = 
lock
;

158 *
lockPå
 = 
√wLock
;

160  
VDO_SUCCESS
;

161 
	}
}

164 
	$ªÀa£PBNLock
(
PhysiˇlZ⁄e
 *
z⁄e
,

165 
PhysiˇlBlockNumbî
 
lockedPBN
,

166 
PBNLock
 **
lockPå
)

168 
PBNLock
 *
lock
 = *
lockPå
;

169 i‡(
lock
 =
NULL
) {

172 *
lockPå
 = 
NULL
;

174 
	`ASSERT_LOG_ONLY
(
	`isPBNLocked
(
lock
),

177 
PBNLock
 *
hﬁdî
 = 
	`ötM≠Remove
(
z⁄e
->
pbnO≥øti⁄s
, 
lockedPBN
);

178 
	`ASSERT_LOG_ONLY
((
lock
 =
hﬁdî
),

179 "physiˇ»blockÜock mism©ch f‹ block %" 
PRIu64
,

180 
lockedPBN
);

182 
	`ªÀa£Provisi⁄ÆRe„ªn˚
(
lock
, 
lockedPBN
, 
z⁄e
->
Æloˇt‹
);

185 
	`nŸifyPBNLockWaôîs
(
lock
);

187 
	`ªtu∫PBNLockToPoﬁ
(
z⁄e
->
lockPoﬁ
, &
lock
);

188 
	}
}

191 
	$dumpPhysiˇlZ⁄e
(c⁄° 
PhysiˇlZ⁄e
 *
z⁄e
)

193 
	`dumpBlockAŒoˇt‹
(
z⁄e
->
Æloˇt‹
);

194 
	}
}

	@vdo/base/physicalZone.h

22 #i‚de‡
PHYSICAL_ZONE_H


23 
	#PHYSICAL_ZONE_H


	)

25 
	~"pbnLock.h
"

26 
	~"ty≥s.h
"

37 
	$makePhysiˇlZ⁄e
(
VDO
 *
vdo
, 
Z⁄eCou¡
 
z⁄eNumbî
, 
PhysiˇlZ⁄e
 **
z⁄ePå
)

38 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

45 
	`‰ìPhysiˇlZ⁄e
(
PhysiˇlZ⁄e
 **
z⁄ePå
);

54 
Z⁄eCou¡
 
	$gëPhysiˇlZ⁄eNumbî
(c⁄° 
PhysiˇlZ⁄e
 *
z⁄e
)

55 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

64 
ThªadID
 
	$gëPhysiˇlZ⁄eThªadID
(c⁄° 
PhysiˇlZ⁄e
 *
z⁄e
)

65 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

74 
BlockAŒoˇt‹
 *
	$gëBlockAŒoˇt‹
(c⁄° 
PhysiˇlZ⁄e
 *
z⁄e
)

75 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

85 
PBNLock
 *
	$gëPBNLock
(
PhysiˇlZ⁄e
 *
z⁄e
, 
PhysiˇlBlockNumbî
 
pbn
)

86 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

103 
	$©ãm±PBNLock
(
PhysiˇlZ⁄e
 *
z⁄e
,

104 
PhysiˇlBlockNumbî
 
pbn
,

105 
PBNLockTy≥
 
ty≥
,

106 
PBNLock
 **
lockPå
)

107 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

119 
	`ªÀa£PBNLock
(
PhysiˇlZ⁄e
 *
z⁄e
,

120 
PhysiˇlBlockNumbî
 
lockedPBN
,

121 
PBNLock
 **
lockPå
);

128 
	`dumpPhysiˇlZ⁄e
(c⁄° 
PhysiˇlZ⁄e
 *
z⁄e
);

	@vdo/base/pointerMap.c

73 
	~"poöãrM≠.h
"

75 
	~"îr‹s.h
"

76 
	~"loggî.h
"

77 
	~"mem‹yAŒoc.h
"

78 
	~"numîic.h
"

79 
	~"≥rmas£π.h
"

82 
	mDEFAULT_CAPACITY
 = 16,

83 
	mNEIGHBORHOOD
 = 255,

84 
	mMAX_PROBES
 = 1024,

85 
	mNULL_HOP_OFFSET
 = 0,

86 
	mDEFAULT_LOAD
 = 75

96 
__©åibuã__
((
	t∑cked
)Ë
	tbuckë
 {

97 
uöt8_t
 
	gfú°H›
;

99 
uöt8_t
 
	g√xtH›
;

101 c⁄° *
	gkey
;

102 *
	gvÆue
;

103 } 
	tBuckë
;

111 
	spoöãrM≠
 {

113 
size_t
 
	msize
;

115 
size_t
 
	mˇ∑côy
;

117 
size_t
 
	mbuckëCou¡
;

119 
Buckë
 *
	mbuckës
;

121 
PoöãrKeyCom∑øt‹
 *
	mcom∑øt‹
;

123 
PoöãrKeyHashî
 *
	mhashî
;

134 
	$ÆloˇãBuckës
(
PoöãrM≠
 *
m≠
, 
size_t
 
ˇ∑côy
)

136 
m≠
->
size
 = 0;

137 
m≠
->
ˇ∑côy
 = capacity;

141 
m≠
->
buckëCou¡
 = 
ˇ∑côy
 + (
NEIGHBORHOOD
 - 1);

142  
	`ALLOCATE
(
m≠
->
buckëCou¡
, 
Buckë
, "PointerMap buckets",

143 &
m≠
->
buckës
);

144 
	}
}

147 
	$makePoöãrM≠
(
size_t
 
öôülC≠acôy
,

148 
öôülLﬂd
,

149 
PoöãrKeyCom∑øt‹
 
com∑øt‹
,

150 
PoöãrKeyHashî
 
hashî
,

151 
PoöãrM≠
 **
m≠På
)

154 i‡(
öôülLﬂd
 == 0) {

155 
öôülLﬂd
 = 
DEFAULT_LOAD
;

157 i‡(
öôülLﬂd
 > 100) {

158  
UDS_INVALID_ARGUMENT
;

161 
PoöãrM≠
 *
m≠
;

162 
ªsu…
 = 
	`ALLOCATE
(1, 
PoöãrM≠
, "PoöãrM≠", &
m≠
);

163 i‡(
ªsu…
 !
UDS_SUCCESS
) {

164  
ªsu…
;

167 
m≠
->
hashî
 = hasher;

168 
m≠
->
com∑øt‹
 = comparator;

171 
size_t
 
ˇ∑côy
 = (
öôülC≠acôy
 > 0Ë? inôülC≠acôy : 
DEFAULT_CAPACITY
;

175 
ˇ∑côy
 = c≠acôy * 100 / 
öôülLﬂd
;

177 
ªsu…
 = 
	`ÆloˇãBuckës
(
m≠
, 
ˇ∑côy
);

178 i‡(
ªsu…
 !
UDS_SUCCESS
) {

179 
	`‰ìPoöãrM≠
(&
m≠
);

180  
ªsu…
;

183 *
m≠På
 = 
m≠
;

184  
UDS_SUCCESS
;

185 
	}
}

192 
	$‰ìBuckës
(
PoöãrM≠
 *
m≠
)

194 
	`FREE
(
m≠
->
buckës
);

195 
m≠
->
buckës
 = 
NULL
;

196 
	}
}

199 
	$‰ìPoöãrM≠
(
PoöãrM≠
 **
m≠På
)

201 i‡(*
m≠På
 !
NULL
) {

202 
	`‰ìBuckës
(*
m≠På
);

203 
	`FREE
(*
m≠På
);

204 *
m≠På
 = 
NULL
;

206 
	}
}

209 
size_t
 
	$poöãrM≠Size
(c⁄° 
PoöãrM≠
 *
m≠
)

211  
m≠
->
size
;

212 
	}
}

224 
Buckë
 *
	$dîe„ªn˚H›
(
Buckë
 *
√ighb‹hood
, 
h›Off£t
)

226 i‡(
h›Off£t
 =
NULL_HOP_OFFSET
) {

227  
NULL
;

230 
	`STATIC_ASSERT
(
NULL_HOP_OFFSET
 == 0);

231  &
√ighb‹hood
[
h›Off£t
 - 1];

232 
	}
}

241 
	$ö£πInH›Li°
(
Buckë
 *
√ighb‹hood
, Buckë *
√wBuckë
)

244 
h›Off£t
 = 1 + (
√wBuckë
 - 
√ighb‹hood
);

247 
√xtH›
 = 
√ighb‹hood
->
fú°H›
;

248 i‡((
√xtH›
 =
NULL_HOP_OFFSET
Ë|| (√xtH› > 
h›Off£t
)) {

249 
√wBuckë
->
√xtH›
 =ÇextHop;

250 
√ighb‹hood
->
fú°H›
 = 
h›Off£t
;

257 
Buckë
 *
buckë
 = 
	`dîe„ªn˚H›
(
√ighb‹hood
, 
√xtH›
);

258 
√xtH›
 = 
buckë
->nextHop;

260 i‡((
√xtH›
 =
NULL_HOP_OFFSET
Ë|| (√xtH› > 
h›Off£t
)) {

261 
√wBuckë
->
√xtH›
 =ÇextHop;

262 
buckë
->
√xtH›
 = 
h›Off£t
;

266 
	}
}

274 
Buckë
 *
	$£À˘Buckë
(c⁄° 
PoöãrM≠
 *
m≠
, c⁄° *
key
)

283 
uöt64_t
 
hash
 = 
m≠
->
	`hashî
(
key
);

284  &
m≠
->
buckës
[(
hash
 * m≠->
ˇ∑côy
) >> 32];

285 
	}
}

301 
Buckë
 *
	$£¨chH›Li°
(
PoöãrM≠
 *
m≠
,

302 
Buckë
 *
buckë
,

303 c⁄° *
key
,

304 
Buckë
 **
¥eviousPå
)

306 
Buckë
 *
¥evious
 = 
NULL
;

307 
√xtH›
 = 
buckë
->
fú°H›
;

308 
√xtH›
 !
NULL_HOP_OFFSET
) {

310 
Buckë
 *
íåy
 = 
	`dîe„ªn˚H›
(
buckë
, 
√xtH›
);

311 i‡((
íåy
->
vÆue
 !
NULL
Ë&& 
m≠
->
	`com∑øt‹
(
key
,Éntry->key)) {

312 i‡(
¥eviousPå
 !
NULL
) {

313 *
¥eviousPå
 = 
¥evious
;

315  
íåy
;

317 
√xtH›
 = 
íåy
->nextHop;

318 
¥evious
 = 
íåy
;

320  
NULL
;

321 
	}
}

324 *
	$poöãrM≠Gë
(
PoöãrM≠
 *
m≠
, c⁄° *
key
)

326 
Buckë
 *
m©ch
 = 
	`£¨chH›Li°
(
m≠
, 
	`£À˘Buckë
(m≠, 
key
), key, 
NULL
);

327  ((
m©ch
 !
NULL
Ë? m©ch->
vÆue
 : NULL);

328 
	}
}

336 
	$ªsizeBuckës
(
PoöãrM≠
 *
m≠
)

339 
PoöãrM≠
 
ﬁdM≠
 = *
m≠
;

342 
size_t
 
√wC≠acôy
 = 
m≠
->
ˇ∑côy
 / 2 * 3;

343 
	`logInfo
("%s:áttemptingÑesize from %zuÅo %zu, current size=%zu",

344 
__func__
, 
m≠
->
ˇ∑côy
, 
√wC≠acôy
, m≠->
size
);

345 
ªsu…
 = 
	`ÆloˇãBuckës
(
m≠
, 
√wC≠acôy
);

346 i‡(
ªsu…
 !
UDS_SUCCESS
) {

347 *
m≠
 = 
ﬁdM≠
;

348  
ªsu…
;

352 
size_t
 
i
 = 0; i < 
ﬁdM≠
.
buckëCou¡
; i++) {

353 
Buckë
 *
íåy
 = &
ﬁdM≠
.
buckës
[
i
];

354 i‡(
íåy
->
vÆue
 =
NULL
) {

358 
ªsu…
 = 
	`poöãrM≠Put
(
m≠
, 
íåy
->
key
,É¡ry->
vÆue
, 
åue
, 
NULL
);

359 i‡(
ªsu…
 !
UDS_SUCCESS
) {

361 
	`‰ìBuckës
(
m≠
);

362 *
m≠
 = 
ﬁdM≠
;

363  
ªsu…
;

368 
	`‰ìBuckës
(&
ﬁdM≠
);

369  
UDS_SUCCESS
;

370 
	}
}

384 
Buckë
 *
	$födEm±yBuckë
(
PoöãrM≠
 *
m≠
,

385 
Buckë
 *
buckë
,

386 
maxProbes
)

390 
size_t
 
ªmaöög
 = &
m≠
->
buckës
[m≠->
buckëCou¡
] - 
buckë
;

391 
Buckë
 *
£¡öñ
 = &
buckë
[
	`möSizeT
(
ªmaöög
, 
maxProbes
)];

393 
Buckë
 *
íåy
 = 
buckë
;É¡ry < 
£¡öñ
;Éntry++) {

394 i‡(
íåy
->
vÆue
 =
NULL
) {

395  
íåy
;

398  
NULL
;

399 
	}
}

414 
Buckë
 *
moveEm±yBuckë
(
PoöãrM≠
 *
m≠
 
__©åibuã__
((
unu£d
)),

415 
Buckë
 *
hﬁe
)

424 
Buckë
 *
	gbuckë
 = &
hﬁe
[1 - 
NEIGHBORHOOD
]; buckë < 
	ghﬁe
; bucket++) {

427 
Buckë
 *
	g√wHﬁe
 = 
dîe„ªn˚H›
(
buckë
, buckë->
fú°H›
);

428 i‡(
	g√wHﬁe
 =
NULL
) {

436 i‡(
	ghﬁe
 < 
	g√wHﬁe
) {

448 
	gbuckë
->
	gfú°H›
 = 
√wHﬁe
->
√xtH›
;

449 
	g√wHﬁe
->
	g√xtH›
 = 
NULL_HOP_OFFSET
;

452 
	ghﬁe
->
	gkey
 = 
√wHﬁe
->
key
;

453 
	ghﬁe
->
	gvÆue
 = 
√wHﬁe
->
vÆue
;

454 
	g√wHﬁe
->
	gvÆue
 = 
NULL
;

457 
ö£πInH›Li°
(
buckë
, 
hﬁe
);

458  
	g√wHﬁe
;

462  
	gNULL
;

481 
boﬁ
 
	$upd©eM≠pög
(
PoöãrM≠
 *
m≠
,

482 
Buckë
 *
√ighb‹hood
,

483 c⁄° *
key
,

484 *
√wVÆue
,

485 
boﬁ
 
upd©e
,

486 **
ﬁdVÆuePå
)

488 
Buckë
 *
buckë
 = 
	`£¨chH›Li°
(
m≠
, 
√ighb‹hood
, 
key
, 
NULL
);

489 i‡(
buckë
 =
NULL
) {

491  
Ál£
;

496 i‡(
ﬁdVÆuePå
 !
NULL
) {

497 *
ﬁdVÆuePå
 = 
buckë
->
vÆue
;

499 i‡(
upd©e
) {

502 
buckë
->
key
 = key;

503 
buckë
->
vÆue
 = 
√wVÆue
;

505  
åue
;

506 
	}
}

521 
Buckë
 *
	$födOrMakeVaˇncy
(
PoöãrM≠
 *
m≠
, 
Buckë
 *
√ighb‹hood
)

524 
Buckë
 *
hﬁe
 = 
	`födEm±yBuckë
(
m≠
, 
√ighb‹hood
, 
MAX_PROBES
);

528 
hﬁe
 !
NULL
) {

529 
di°™˚
 = 
hﬁe
 - 
√ighb‹hood
;

530 i‡(
di°™˚
 < 
NEIGHBORHOOD
) {

533  
hﬁe
;

538 
hﬁe
 = 
	`moveEm±yBuckë
(
m≠
, hole);

541  
NULL
;

542 
	}
}

545 
	$poöãrM≠Put
(
PoöãrM≠
 *
m≠
,

546 c⁄° *
key
,

547 *
√wVÆue
,

548 
boﬁ
 
upd©e
,

549 **
ﬁdVÆuePå
)

551 i‡(
√wVÆue
 =
NULL
) {

552  
UDS_INVALID_ARGUMENT
;

557 
Buckë
 *
√ighb‹hood
 = 
	`£À˘Buckë
(
m≠
, 
key
);

561 i‡(
	`upd©eM≠pög
(
m≠
, 
√ighb‹hood
, 
key
, 
√wVÆue
, 
upd©e
, 
ﬁdVÆuePå
)) {

562  
UDS_SUCCESS
;

571 
Buckë
 *
buckë
;

572 (
buckë
 = 
	`födOrMakeVaˇncy
(
m≠
, 
√ighb‹hood
)Ë=
NULL
) {

579 
ªsu…
 = 
	`ªsizeBuckës
(
m≠
);

580 i‡(
ªsu…
 !
UDS_SUCCESS
) {

581  
ªsu…
;

586 
√ighb‹hood
 = 
	`£À˘Buckë
(
m≠
, 
key
);

590 
buckë
->
key
 = key;

591 
buckë
->
vÆue
 = 
√wVÆue
;

592 
	`ö£πInH›Li°
(
√ighb‹hood
, 
buckë
);

593 
m≠
->
size
 += 1;

596 i‡(
ﬁdVÆuePå
 !
NULL
) {

597 *
ﬁdVÆuePå
 = 
NULL
;

599  
UDS_SUCCESS
;

600 
	}
}

603 *
	$poöãrM≠Remove
(
PoöãrM≠
 *
m≠
, c⁄° *
key
)

606 
Buckë
 *
buckë
 = 
	`£À˘Buckë
(
m≠
, 
key
);

607 
Buckë
 *
¥evious
;

608 
Buckë
 *
vi˘im
 = 
	`£¨chH›Li°
(
m≠
, 
buckë
, 
key
, &
¥evious
);

610 i‡(
vi˘im
 =
NULL
) {

612  
NULL
;

617 
m≠
->
size
 -= 1;

618 *
vÆue
 = 
vi˘im
->value;

619 
vi˘im
->
vÆue
 = 
NULL
;

620 
vi˘im
->
key
 = 0;

624 i‡(
¥evious
 =
NULL
) {

626 
buckë
->
fú°H›
 = 
vi˘im
->
√xtH›
;

628 
¥evious
->
√xtH›
 = 
vi˘im
->nextHop;

630 
vi˘im
->
√xtH›
 = 
NULL_HOP_OFFSET
;

632  
vÆue
;

633 
	}
}

	@vdo/base/pointerMap.h

22 #i‚de‡
POINTER_MAP_H


23 
	#POINTER_MAP_H


	)

25 
	~"comm⁄.h
"

48 
poöãrM≠
 
	tPoöãrM≠
;

61 
boﬁ
 
	tPoöãrKeyCom∑øt‹
(c⁄° *
	tthisKey
, c⁄° *
	tth©Key
);

76 
uöt32_t
 
	tPoöãrKeyHashî
(c⁄° *
	tkey
);

96 
	$makePoöãrM≠
(
size_t
 
öôülC≠acôy
,

97 
öôülLﬂd
,

98 
PoöãrKeyCom∑øt‹
 
com∑øt‹
,

99 
PoöãrKeyHashî
 
hashî
,

100 
PoöãrM≠
 **
m≠På
)

101 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

110 
	`‰ìPoöãrM≠
(
PoöãrM≠
 **
m≠På
);

119 
size_t
 
	`poöãrM≠Size
(c⁄° 
PoöãrM≠
 *
m≠
);

131 *
	`poöãrM≠Gë
(
PoöãrM≠
 *
m≠
, c⁄° *
key
);

159 
	$poöãrM≠Put
(
PoöãrM≠
 *
m≠
,

160 c⁄° *
key
,

161 *
√wVÆue
,

162 
boﬁ
 
upd©e
,

163 **
ﬁdVÆuePå
)

164 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

176 *
	`poöãrM≠Remove
(
PoöãrM≠
 *
m≠
, c⁄° *
key
);

	@vdo/base/priorityTable.c

22 
	~"¥i‹ôyTabÀ.h
"

24 
	~"îr‹s.h
"

25 
	~"mem‹yAŒoc.h
"

26 
	~"numUtûs.h
"

28 
	~"°©usCodes.h
"

31 íum { 
	mMAX_PRIORITY
 = 63 };

37 
	sbuckë
 {

39 
RögNode
 
	mqueue
;

41 
	m¥i‹ôy
;

42 } 
	tBuckë
;

51 
	s¥i‹ôyTabÀ
 {

53 
	mmaxPri‹ôy
;

55 
uöt64_t
 
	m£¨chVe˘‹
;

57 
Buckë
 
	mbuckës
[];

67 
ölöe
 
Buckë
 *
	$asBuckë
(
RögNode
 *
hód
)

69 
	`STATIC_ASSERT
(
	`off£tof
(
Buckë
, 
queue
) == 0);

70  (
Buckë
 *Ë
hód
;

71 
	}
}

74 
	$makePri‹ôyTabÀ
(
maxPri‹ôy
, 
Pri‹ôyTabÀ
 **
èbÀPå
)

76 i‡(
maxPri‹ôy
 > 
MAX_PRIORITY
) {

77  
UDS_INVALID_ARGUMENT
;

80 
Pri‹ôyTabÀ
 *
èbÀ
;

81 
ªsu…
 = 
	`ALLOCATE_EXTENDED
(
Pri‹ôyTabÀ
, 
maxPri‹ôy
 + 1, 
Buckë
,

82 
__func__
, &
èbÀ
);

83 i‡(
ªsu…
 !
VDO_SUCCESS
) {

84  
ªsu…
;

87 
¥i‹ôy
 = 0;Öri‹ôy <
maxPri‹ôy
;Öriority++) {

88 
Buckë
 *
buckë
 = &
èbÀ
->
buckës
[
¥i‹ôy
];

89 
buckë
->
¥i‹ôy
 =Öriority;

90 
	`öôülizeRög
(&
buckë
->
queue
);

93 
èbÀ
->
maxPri‹ôy
 = maxPriority;

94 
èbÀ
->
£¨chVe˘‹
 = 0;

96 *
èbÀPå
 = 
èbÀ
;

97  
VDO_SUCCESS
;

98 
	}
}

101 
	$‰ìPri‹ôyTabÀ
(
Pri‹ôyTabÀ
 **
èbÀPå
)

103 
Pri‹ôyTabÀ
 *
èbÀ
 = *
èbÀPå
;

104 i‡(
èbÀ
 =
NULL
) {

110 
	`ª£tPri‹ôyTabÀ
(
èbÀ
);

112 
	`FREE
(
èbÀ
);

113 *
èbÀPå
 = 
NULL
;

114 
	}
}

117 
	$ª£tPri‹ôyTabÀ
(
Pri‹ôyTabÀ
 *
èbÀ
)

119 
èbÀ
->
£¨chVe˘‹
 = 0;

120 
¥i‹ôy
 = 0;Öri‹ôy <
èbÀ
->
maxPri‹ôy
;Öriority++) {

121 
	`un•li˚RögNode
(&
èbÀ
->
buckës
[
¥i‹ôy
].
queue
);

123 
	}
}

126 
	$¥i‹ôyTabÀEnqueue
(
Pri‹ôyTabÀ
 *
èbÀ
,

127 
¥i‹ôy
,

128 
RögNode
 *
íåy
)

130 
	`ASSERT_LOG_ONLY
((
¥i‹ôy
 <
èbÀ
->
maxPri‹ôy
),

134 
	`pushRögNode
(&
èbÀ
->
buckës
[
¥i‹ôy
].
queue
, 
íåy
);

137 
èbÀ
->
£¨chVe˘‹
 |(1ULL << 
¥i‹ôy
);

138 
	}
}

141 
ölöe
 
	$m¨kBuckëEm±y
(
Pri‹ôyTabÀ
 *
èbÀ
, 
Buckë
 *
buckë
)

143 
èbÀ
->
£¨chVe˘‹
 &~(1ULL << 
buckë
->
¥i‹ôy
);

144 
	}
}

147 
RögNode
 *
	$¥i‹ôyTabÀDequeue
(
Pri‹ôyTabÀ
 *
èbÀ
)

151 
t›Pri‹ôy
 = 
	`logBa£Two
(
èbÀ
->
£¨chVe˘‹
);

153 i‡(
t›Pri‹ôy
 < 0) {

155  
NULL
;

159 
Buckë
 *
buckë
 = &
èbÀ
->
buckës
[
t›Pri‹ôy
];

160 
RögNode
 *
íåy
 = 
	`un•li˚RögNode
(
buckë
->
queue
.
√xt
);

163 i‡(
	`isRögEm±y
(&
buckë
->
queue
)) {

164 
	`m¨kBuckëEm±y
(
èbÀ
, 
buckë
);

167  
íåy
;

168 
	}
}

171 
	$¥i‹ôyTabÀRemove
(
Pri‹ôyTabÀ
 *
èbÀ
, 
RögNode
 *
íåy
)

175 i‡(
	`isRögEm±y
(
íåy
)) {

181 
RögNode
 *
√xtNode
 = 
íåy
->
√xt
;

182 
	`un•li˚RögNode
(
íåy
);

186 i‡(
	`isRögEm±y
(
√xtNode
)) {

187 
	`m¨kBuckëEm±y
(
èbÀ
, 
	`asBuckë
(
√xtNode
));

189 
	}
}

192 
boﬁ
 
	$isPri‹ôyTabÀEm±y
(
Pri‹ôyTabÀ
 *
èbÀ
)

194  (
èbÀ
->
£¨chVe˘‹
 == 0);

195 
	}
}

	@vdo/base/priorityTable.h

22 #i‚de‡
PRIORITY_TABLE_H


23 
	#PRIORITY_TABLE_H


	)

25 
	~"comm⁄.h
"

26 
	~"rögNode.h
"

50 
¥i‹ôyTabÀ
 
	tPri‹ôyTabÀ
;

60 
	$makePri‹ôyTabÀ
(
maxPri‹ôy
, 
Pri‹ôyTabÀ
 **
èbÀPå
)

61 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

69 
	`‰ìPri‹ôyTabÀ
(
Pri‹ôyTabÀ
 **
èbÀPå
);

80 
	`¥i‹ôyTabÀEnqueue
(
Pri‹ôyTabÀ
 *
èbÀ
,

81 
¥i‹ôy
,

82 
RögNode
 *
íåy
);

91 
	`ª£tPri‹ôyTabÀ
(
Pri‹ôyTabÀ
 *
èbÀ
);

102 
RögNode
 *
	$¥i‹ôyTabÀDequeue
(
Pri‹ôyTabÀ
 *
èbÀ
)

103 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

111 
	`¥i‹ôyTabÀRemove
(
Pri‹ôyTabÀ
 *
èbÀ
, 
RögNode
 *
íåy
);

120 
boﬁ
 
	$isPri‹ôyTabÀEm±y
(
Pri‹ôyTabÀ
 *
èbÀ
)

121 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

	@vdo/base/readOnlyModeContext.c

22 
	~"ªadO∆yModeC⁄ãxtI¡î«ls.h
"

25 
boﬁ
 
	$isRódO∆y
(
RódO∆yModeC⁄ãxt
 *
ªadO∆yC⁄ãxt
)

27  
ªadO∆yC⁄ãxt
->
	`isRódO∆y
‘ódO∆yC⁄ãxt->
c⁄ãxt
);

28 
	}
}

31 
	$íãrRódO∆yMode
(
RódO∆yModeC⁄ãxt
 *
ªadO∆yC⁄ãxt
, 
îr‹Code
)

33 
ªadO∆yC⁄ãxt
->
	`íãrRódO∆yMode
‘ódO∆yC⁄ãxt->
c⁄ãxt
, 
îr‹Code
);

34 
	}
}

	@vdo/base/readOnlyModeContext.h

22 #i‚de‡
READ_ONLY_MODE_CONTEXT_H


23 
	#READ_ONLY_MODE_CONTEXT_H


	)

25 
	~"ty≥s.h
"

34 
boﬁ
 
	$isRódO∆y
(
RódO∆yModeC⁄ãxt
 *
ªadO∆yC⁄ãxt
)

35 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

44 
	`íãrRódO∆yMode
(
RódO∆yModeC⁄ãxt
 *
ªadO∆yC⁄ãxt
, 
îr‹Code
);

	@vdo/base/readOnlyModeContextInternals.h

22 #i‚de‡
READ_ONLY_MODE_CONTEXT_INTERNALS_H


23 
	#READ_ONLY_MODE_CONTEXT_INTERNALS_H


	)

25 
	~"ªadO∆yModeC⁄ãxt.h
"

34 
boﬁ
 
	tRódO∆yModeQuîy
(*
	tc⁄ãxt
);

42 
	tRódO∆yModeE¡îî
(*
	tc⁄ãxt
, 
	tîr‹Code
);

44 
	sªadO∆yModeC⁄ãxt
 {

45 *
	mc⁄ãxt
;

46 
RódO∆yModeQuîy
 *
	misRódO∆y
;

47 
RódO∆yModeE¡îî
 *
	míãrRódO∆yMode
;

	@vdo/base/readOnlyRebuild.c

22 
	~"ªadO∆yRebuûd.h
"

24 
	~"loggî.h
"

25 
	~"mem‹yAŒoc.h
"

27 
	~"blockM≠I¡î«ls.h
"

28 
	~"blockM≠Recovîy.h
"

29 
	~"com∂ëi⁄.h
"

30 
	~"numUtûs.h
"

31 
	~"ªcovîyJou∫ÆI¡î«ls.h
"

32 
	~"ªcovîyUtûs.h
"

33 
	~"ª„ªn˚Cou¡Rebuûd.h
"

34 
	~"¶abDïŸ.h
"

35 
	~"vdoI¡î«l.h
"

36 
	~"vdoPageCache.h
"

40 
VDOCom∂ëi⁄
 
	mcom∂ëi⁄
;

42 
VDOCom∂ëi⁄
 
	msubTaskCom∂ëi⁄
;

44 
VDO
 *
	mvdo
;

46 *
	mjou∫ÆD©a
;

48 
NumbîedBlockM≠pög
 *
	míåõs
;

50 
size_t
 
	míåyCou¡
;

52 
Sequí˚Numbî
 
	mhód
;

54 
Sequí˚Numbî
 
	mèû
;

56 
BlockCou¡
 
	mlogiˇlBlocksU£d
;

58 
BlockCou¡
 
	mblockM≠D©aBlocks
;

59 } 
	tRódO∆yRebuûdCom∂ëi⁄
;

68 
__©åibuã__
((
w¨n_unu£d_ªsu…
))

69 
ölöe
 
RódO∆yRebuûdCom∂ëi⁄
 *

70 
	$asRódO∆yRebuûdCom∂ëi⁄
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

72 
	`STATIC_ASSERT
(
	`off£tof
(
RódO∆yRebuûdCom∂ëi⁄
, 
com∂ëi⁄
) == 0);

73 
	`as£πCom∂ëi⁄Ty≥
(
com∂ëi⁄
->
ty≥
, 
READ_ONLY_REBUILD_COMPLETION
);

74  (
RódO∆yRebuûdCom∂ëi⁄
 *Ë
com∂ëi⁄
;

75 
	}
}

82 
	$‰ìRebuûdCom∂ëi⁄
(
RódO∆yRebuûdCom∂ëi⁄
 **
ªbuûdPå
)

84 
RódO∆yRebuûdCom∂ëi⁄
 *
ªbuûd
 = *
ªbuûdPå
;

85 i‡(
ªbuûd
 =
NULL
) {

89 
	`de°royEnqueuóbÀ
(&
ªbuûd
->
subTaskCom∂ëi⁄
);

90 
	`FREE
(
ªbuûd
->
jou∫ÆD©a
);

91 
	`FREE
(
ªbuûd
->
íåõs
);

92 
	`FREE
(
ªbuûd
);

93 *
ªbuûdPå
 = 
NULL
;

94 
	}
}

104 
	$makeRebuûdCom∂ëi⁄
(
VDO
 *
vdo
,

105 
RódO∆yRebuûdCom∂ëi⁄
 **
ªbuûdPå
)

107 
RódO∆yRebuûdCom∂ëi⁄
 *
ªbuûd
;

108 
ªsu…
 = 
	`ALLOCATE
(1, 
RódO∆yRebuûdCom∂ëi⁄
, 
__func__
, &
ªbuûd
);

109 i‡(
ªsu…
 !
VDO_SUCCESS
) {

110  
ªsu…
;

113 
	`öôülizeCom∂ëi⁄
(&
ªbuûd
->
com∂ëi⁄
, 
READ_ONLY_REBUILD_COMPLETION
,

114 
vdo
->
œyî
);

116 
ªsu…
 = 
	`öôülizeEnqueuóbÀCom∂ëi⁄
(&
ªbuûd
->
subTaskCom∂ëi⁄
,

117 
SUB_TASK_COMPLETION
, 
vdo
->
œyî
);

118 i‡(
ªsu…
 !
VDO_SUCCESS
) {

119 
	`‰ìRebuûdCom∂ëi⁄
(&
ªbuûd
);

120  
ªsu…
;

123 
ªbuûd
->
vdo
 = vdo;

124 *
ªbuûdPå
 = 
ªbuûd
;

125  
VDO_SUCCESS
;

126 
	}
}

134 
	$com∂ëeRebuûd
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

136 
VDOCom∂ëi⁄
 *
∑ª¡
 = 
com∂ëi⁄
->parent;

137 
ªsu…
 = 
com∂ëi⁄
->result;

138 
RódO∆yRebuûdCom∂ëi⁄
 *
ªbuûd
 = 
	`asRódO∆yRebuûdCom∂ëi⁄
(
com∂ëi⁄
);

139 
VDO
 *
vdo
 = 
ªbuûd
->vdo;

140 
	`£tVDOPageCacheRebuûdMode
(
	`gëBlockM≠
(
vdo
)->
z⁄es
[0].
∑geCache
, 
Ál£
);

141 
	`‰ìRebuûdCom∂ëi⁄
(&
ªbuûd
);

142 
	`föishCom∂ëi⁄
(
∑ª¡
, 
ªsu…
);

143 
	}
}

150 
	$föishRebuûd
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

152 
RódO∆yRebuûdCom∂ëi⁄
 *
ªbuûd
 = 
	`asRódO∆yRebuûdCom∂ëi⁄
(
com∂ëi⁄
);

153 
	`öôülizeRecovîyJou∫ÆPo°Rebuûd
(
ªbuûd
->
vdo
->
ªcovîyJou∫Æ
,

154 
ªbuûd
->
vdo
->
com∂ëeRecovîõs
,

155 
ªbuûd
->
èû
,

156 
ªbuûd
->
logiˇlBlocksU£d
,

157 
ªbuûd
->
blockM≠D©aBlocks
);

158 
	`logInfo
("Read-onlyÑebuild complete");

159 
	`com∂ëeRebuûd
(
com∂ëi⁄
);

160 
	}
}

167 
	$ab‹tRebuûd
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

169 
	`logInfo
("Read-onlyÑebuildáborted");

170 
	`com∂ëeRebuûd
(
com∂ëi⁄
);

171 
	}
}

181 
__©åibuã__
((
w¨n_unu£d_ªsu…
))

182 
boﬁ
 
	$ab‹tRebuûdOnEº‹
(
ªsu…
,

183 
RódO∆yRebuûdCom∂ëi⁄
 *
ªbuûd
)

185 i‡(
ªsu…
 =
VDO_SUCCESS
) {

186  
Ál£
;

189 
	`föishCom∂ëi⁄
(&
ªbuûd
->
com∂ëi⁄
, 
ªsu…
);

190  
åue
;

191 
	}
}

199 
	$föishRe„ªn˚Cou¡Rebuûd
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

201 
RódO∆yRebuûdCom∂ëi⁄
 *
ªbuûd
 = 
com∂ëi⁄
->
∑ª¡
;

202 
VDO
 *
vdo
 = 
ªbuûd
->vdo;

203 
	`as£πOnAdmöThªad
(
vdo
, 
__func__
);

204 i‡(
vdo
->
lﬂdSèã
 !
VDO_REBUILD_FOR_UPGRADE
) {

206 
vdo
->
com∂ëeRecovîõs
++;

209 
	`logInfo
("SavingÑebuilt state");

210 
	`¥ï¨eToFöishP¨ít
(
com∂ëi⁄
, &
ªbuûd
->completion);

211 
	`ßveSœbDïŸ
(
vdo
->
dïŸ
, 
Ál£
, 
com∂ëi⁄
);

212 
	}
}

221 
	$œunchRe„ªn˚Cou¡Rebuûd
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

223 
RódO∆yRebuûdCom∂ëi⁄
 *
ªbuûd
 = 
com∂ëi⁄
->
∑ª¡
;

224 
VDO
 *
vdo
 = 
ªbuûd
->vdo;

227 
ªsu…
 = 
	`ÆloˇãSœbRefCou¡s
(
vdo
->
dïŸ
, vdo->
œyî
);

228 i‡(
	`ab‹tRebuûdOnEº‹
(
ªsu…
, 
ªbuûd
)) {

232 
	`¥ï¨eCom∂ëi⁄
(
com∂ëi⁄
, 
föishRe„ªn˚Cou¡Rebuûd
,

233 
föishP¨ítCÆlback
, 
	`gëAdmöThªad
(
	`gëThªadC⁄fig
(
vdo
)),

234 
com∂ëi⁄
->
∑ª¡
);

235 
	`ªbuûdRe„ªn˚Cou¡s
(
vdo
, 
com∂ëi⁄
, &
ªbuûd
->
logiˇlBlocksU£d
,

236 &
ªbuûd
->
blockM≠D©aBlocks
);

237 
	}
}

248 
	$≠≥ndSe˘‹E¡rõs
(
RódO∆yRebuûdCom∂ëi⁄
 *
ªbuûd
,

249 
PackedJou∫ÆSe˘‹
 *
£˘‹
,

250 
Jou∫ÆE¡ryCou¡
 
íåyCou¡
)

252 
VDO
 *
vdo
 = 
ªbuûd
->vdo;

254 
Jou∫ÆE¡ryCou¡
 
i
 = 0; i < 
íåyCou¡
; i++) {

255 
Jou∫ÆO≥øti⁄
 
›î©i⁄
;

256 
BlockM≠SlŸ
 
¶Ÿ
;

257 
PhysiˇlBlockNumbî
 
pbn
;

258 
RecovîyJou∫ÆE¡ry
 *
íåy
 = &
£˘‹
->
íåõs
[
i
];

260 
ªsu…
 = 
	`decodeRecovîyJou∫ÆE¡ry
(
vdo
, 
íåy
, &
›î©i⁄
, &
¶Ÿ
,

261 &
pbn
);

262 i‡(
ªsu…
 !
VDO_SUCCESS
) {

267 i‡(
	`isIn¸emítO≥øti⁄
(
›î©i⁄
)) {

268 
ªbuûd
->
íåõs
[ªbuûd->
íåyCou¡
] = (
NumbîedBlockM≠pög
) {

269 .
blockM≠SlŸ
 = 
¶Ÿ
,

270 .
blockM≠E¡ry
 = 
íåy
->blockMapEntry,

271 .
numbî
 = 
ªbuûd
->
íåyCou¡
,

273 
ªbuûd
->
íåyCou¡
++;

276 
	}
}

286 
	$exåa˘Jou∫ÆE¡rõs
(
RódO∆yRebuûdCom∂ëi⁄
 *
ªbuûd
)

288 
VDO
 *
vdo
 = 
ªbuûd
->vdo;

289 
RecovîyJou∫Æ
 *
jou∫Æ
 = 
vdo
->
ªcovîyJou∫Æ
;

290 
Sequí˚Numbî
 
fú°
 = 
ªbuûd
->
hód
;

291 
Sequí˚Numbî
 
œ°
 = 
ªbuûd
->
èû
;

292 
BlockCou¡
 
maxCou¡
 = ((
œ°
 - 
fú°
 + 1Ë* 
jou∫Æ
->
íåõsPîBlock
);

296 
ªsu…
 = 
	`ALLOCATE
(
maxCou¡
, 
NumbîedBlockM≠pög
, 
__func__
,

297 &
ªbuûd
->
íåõs
);

298 i‡(
ªsu…
 !
VDO_SUCCESS
) {

299  
ªsu…
;

302 
Sequí˚Numbî
 
i
 = 
fú°
; i <
œ°
; i++) {

303 
PackedJou∫ÆHódî
 *
hódî


304 
	`gëJou∫ÆBlockHódî
(
jou∫Æ
, 
ªbuûd
->
jou∫ÆD©a
, 
i
);

305 i‡(!
	`isExa˘RecovîyJou∫ÆBlock
(
jou∫Æ
, 
hódî
, 
i
)) {

311 
Jou∫ÆE¡ryCou¡
 
blockE¡rõs
 = 
	`möBlock
(
jou∫Æ
->
íåõsPîBlock
,

312 
hódî
->
íåyCou¡
);

313 
uöt8_t
 
j
 = 1; j < 
SECTORS_PER_BLOCK
; j++) {

315 i‡(
blockE¡rõs
 == 0) {

319 
PackedJou∫ÆSe˘‹
 *
£˘‹
 = 
	`gëJou∫ÆBlockSe˘‹
(
hódî
, 
j
);

320 i‡(!
	`isVÆidRecovîyJou∫ÆSe˘‹
(
hódî
, 
£˘‹
)) {

321 
blockE¡rõs
 -
	`möBlock
(
jou∫Æ
->
íåõsPîSe˘‹
, blockEntries);

326 
Jou∫ÆE¡ryCou¡
 
íåõs
 = 
	`möBlock
(
jou∫Æ
->
íåõsPîSe˘‹
,

327 
£˘‹
->
íåyCou¡
);

329 
íåõs
 = 
	`möBlock
”¡rõs, 
blockE¡rõs
);

330 
	`≠≥ndSe˘‹E¡rõs
(
ªbuûd
, 
£˘‹
, 
íåõs
);

333 
blockE¡rõs
 -
	`möBlock
(
jou∫Æ
->
íåõsPîSe˘‹
, blockEntries);

337  
VDO_SUCCESS
;

338 
	}
}

347 
	$≠∂yJou∫ÆE¡rõs
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

349 
RódO∆yRebuûdCom∂ëi⁄
 *
ªbuûd


350 
	`asRódO∆yRebuûdCom∂ëi⁄
(
com∂ëi⁄
->
∑ª¡
);

351 
VDO
 *
vdo
 = 
ªbuûd
->vdo;

353 
	`logInfo
("FinishedÑeadingÑecovery journal");

354 
	`as£πOnLogiˇlZ⁄eThªad
(
vdo
, 0, 
__func__
);

356 
boﬁ
 
foundE¡rõs
 = 
	`födHódAndTaû
(
vdo
->
ªcovîyJou∫Æ
,

357 
ªbuûd
->
jou∫ÆD©a
, &ªbuûd->
èû
,

358 &
ªbuûd
->
hód
, 
NULL
);

359 i‡(
foundE¡rõs
) {

360 
ªsu…
 = 
	`exåa˘Jou∫ÆE¡rõs
(
ªbuûd
);

361 i‡(
	`ab‹tRebuûdOnEº‹
(
ªsu…
, 
ªbuûd
)) {

367 
	`£tVDOPageCacheRebuûdMode
(
	`gëBlockM≠
(
vdo
)->
z⁄es
[0].
∑geCache
, 
åue
);

370 
	`¥ï¨eCom∂ëi⁄
(
com∂ëi⁄
, 
œunchRe„ªn˚Cou¡Rebuûd
,

371 
föishP¨ítCÆlback
, 
com∂ëi⁄
->
ˇŒbackThªadID
,

372 
com∂ëi⁄
->
∑ª¡
);

373 
	`ªcovîBlockM≠
(
vdo
, 
ªbuûd
->
íåyCou¡
,Ñebuûd->
íåõs
, 
com∂ëi⁄
);

374 
	}
}

381 
	$lﬂdJou∫Æ
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

383 
RódO∆yRebuûdCom∂ëi⁄
 *
ªbuûd


384 
	`asRódO∆yRebuûdCom∂ëi⁄
(
com∂ëi⁄
->
∑ª¡
);

385 
VDO
 *
vdo
 = 
ªbuûd
->vdo;

386 
	`as£πOnLogiˇlZ⁄eThªad
(
vdo
, 0, 
__func__
);

388 
	`¥ï¨eCom∂ëi⁄
(
com∂ëi⁄
, 
≠∂yJou∫ÆE¡rõs
, 
föishP¨ítCÆlback
,

389 
com∂ëi⁄
->
ˇŒbackThªadID
, com∂ëi⁄->
∑ª¡
);

390 
	`lﬂdJou∫ÆAsync
(
vdo
->
ªcovîyJou∫Æ
, 
com∂ëi⁄
, &
ªbuûd
->
jou∫ÆD©a
);

391 
	}
}

394 
	$œunchRebuûd
(
VDO
 *
vdo
, 
VDOCom∂ëi⁄
 *
∑ª¡
)

397 i‡(
vdo
->
lﬂdSèã
 =
VDO_REBUILD_FOR_UPGRADE
) {

398 
	`logW¨nög
("RebuildingÑeference counts for upgrade");

400 
	`logW¨nög
("RebuildingÑeference countsÅo clearÑead-only mode");

401 
vdo
->
ªadO∆yRecovîõs
++;

404 
RódO∆yRebuûdCom∂ëi⁄
 *
ªbuûd
;

405 
ªsu…
 = 
	`makeRebuûdCom∂ëi⁄
(
vdo
, &
ªbuûd
);

406 i‡(
ªsu…
 !
VDO_SUCCESS
) {

407 
	`föishCom∂ëi⁄
(
∑ª¡
, 
ªsu…
);

411 
VDOCom∂ëi⁄
 *
com∂ëi⁄
 = &
ªbuûd
->completion;

412 
	`¥ï¨eCom∂ëi⁄
(
com∂ëi⁄
, 
föishRebuûd
, 
ab‹tRebuûd
,

413 
∑ª¡
->
ˇŒbackThªadID
,Öarent);

415 
VDOCom∂ëi⁄
 *
subTaskCom∂ëi⁄
 = &
ªbuûd
->subTaskCompletion;

416 
	`¥ï¨eCom∂ëi⁄
(
subTaskCom∂ëi⁄
, 
lﬂdJou∫Æ
, 
föishP¨ítCÆlback
,

417 
	`gëLogiˇlZ⁄eThªad
(
	`gëThªadC⁄fig
(
vdo
), 0),

418 
com∂ëi⁄
);

419 
	`lﬂdSœbDïŸF‹Rebuûd
(
vdo
->
dïŸ
, 
subTaskCom∂ëi⁄
);

420 
	}
}

	@vdo/base/readOnlyRebuild.h

22 #i‚de‡
READ_ONLY_REBUILD_H


23 
	#READ_ONLY_REBUILD_H


	)

25 
	~"com∂ëi⁄.h
"

26 
	~"vdo.h
"

35 
œunchRebuûd
(
VDO
 *
vdo
, 
VDOCom∂ëi⁄
 *
∑ª¡
);

	@vdo/base/recoveryJournal.c

22 
	~"ªcovîyJou∫Æ.h
"

23 
	~"ªcovîyJou∫ÆI¡î«ls.h
"

25 
	~"loggî.h
"

26 
	~"mem‹yAŒoc.h
"

28 
	~"blockM≠.h
"

29 
	~"c⁄°™ts.h
"

30 
	~"d©aVIO.h
"

31 
	~"exã¡.h
"

32 
	~"hódî.h
"

33 
	~"numUtûs.h
"

34 
	~"¶abDïŸ.h
"

35 
	~"¶abJou∫Æ.h
"

36 
	~"vdoI¡î«l.h
"

39 
Sequí˚Numbî
 
	mjou∫ÆSèπ
;

40 
BlockCou¡
 
	mlogiˇlBlocksU£d
;

41 
BlockCou¡
 
	mblockM≠D©aBlocks
;

42 } 
	t__©åibuã__
((
	t∑cked
)Ë
	tRecovîyJou∫ÆSèã7_0
;

44 c⁄° 
Hódî
 
	gRECOVERY_JOURNAL_HEADER_7_0
 = {

45 .
id
 = 
RECOVERY_JOURNAL
,

46 .
	gvîsi⁄
 = {

47 .
maj‹Vîsi⁄
 = 7,

48 .
	gmö‹Vîsi⁄
 = 0,

50 .
	gsize
 = (
RecovîyJou∫ÆSèã7_0
),

53 c⁄° 
Hódî
 *
	gCURRENT_RECOVERY_JOURNAL_HEADER


54 &
RECOVERY_JOURNAL_HEADER_7_0
;

56 c⁄° 
uöt64_t
 
	gRECOVERY_COUNT_MASK
 = 0xff;

65 
	mRECOVERY_JOURNAL_RESERVED_BLOCKS
 = 8,

69 c⁄° *
	$gëJou∫ÆO≥øti⁄Name
(
Jou∫ÆO≥øti⁄
 
›î©i⁄
)

71 
›î©i⁄
) {

72 
DATA_DECREMENT
:

75 
DATA_INCREMENT
:

78 
BLOCK_MAP_DECREMENT
:

81 
BLOCK_MAP_INCREMENT
:

87 
	}
}

96 
RecovîyJou∫ÆBlock
 *
	$blockFromRögNode
(
RögNode
 *
node
)

98 
	`STATIC_ASSERT
(
	`off£tof
(
RecovîyJou∫ÆBlock
, 
rögNode
) == 0);

99  (
RecovîyJou∫ÆBlock
 *Ë
node
;

100 
	}
}

109 
RecovîyJou∫ÆBlock
 *
	$p›FªeLi°
(
RecovîyJou∫Æ
 *
jou∫Æ
)

111  
	`blockFromRögNode
(
	`p›RögNode
(&
jou∫Æ
->
‰ìTaûBlocks
));

112 
	}
}

121 
RecovîyJou∫ÆBlock
 *
	$p›A˘iveLi°
(
RecovîyJou∫Æ
 *
jou∫Æ
)

123  
	`blockFromRögNode
(
	`p›RögNode
(&
jou∫Æ
->
a˘iveTaûBlocks
));

124 
	}
}

132 
	$as£πOnJou∫ÆThªad
(
RecovîyJou∫Æ
 *
jou∫Æ
,

133 c⁄° *
fun˘i⁄Name
)

135 
	`ASSERT_LOG_ONLY
((
	`gëCÆlbackThªadID
(Ë=
jou∫Æ
->
thªadID
),

136 "%s(ËˇŒed o¿jou∫ÆÅhªad", 
fun˘i⁄Name
);

137 
	}
}

144 
	$c⁄töueWaôî
(
Waôî
 *
waôî
, *
c⁄ãxt
)

146 
D©aVIO
 *
d©aVIO
 = 
	`waôîAsD©aVIO
(
waôî
);

147 
	`d©aVIOAddTø˚Rec‹d
(
d©aVIO
,

148 
	`THIS_LOCATION
("$F($j-$js);"

150 
waôResu…
 = *((*Ë
c⁄ãxt
);

151 
	`c⁄töueD©aVIO
(
d©aVIO
, 
waôResu…
);

152 
	}
}

161 
ölöe
 
boﬁ
 
	$hasBlockWaôîs
(
RecovîyJou∫Æ
 *
jou∫Æ
)

165 i‡(
	`isRögEm±y
(&
jou∫Æ
->
a˘iveTaûBlocks
)) {

166  
Ál£
;

169 
RecovîyJou∫ÆBlock
 *
block


170 
	`blockFromRögNode
(
jou∫Æ
->
a˘iveTaûBlocks
.
√xt
);

171  (
	`hasWaôîs
(&
block
->
íåyWaôîs
)

172 || 
	`hasWaôîs
(&
block
->
commôWaôîs
));

173 
	}
}

183 
ölöe
 
boﬁ
 
	$checkF‹Closuª
(
RecovîyJou∫Æ
 *
jou∫Æ
)

185 i‡(
	`isRódO∆y
(
jou∫Æ
->
ªadO∆yC⁄ãxt
)) {

186 
nŸifyC⁄ãxt
 = 
VDO_READ_ONLY
;

187 
	`nŸifyAŒWaôîs
(&
jou∫Æ
->
de¸emítWaôîs
, 
c⁄töueWaôî
, &
nŸifyC⁄ãxt
);

188 
	`nŸifyAŒWaôîs
(&
jou∫Æ
->
ö¸emítWaôîs
, 
c⁄töueWaôî
, &
nŸifyC⁄ãxt
);

191 i‡(!
jou∫Æ
->
˛o£Reque°ed
 || jou∫Æ->
com∂ëi⁄
.
com∂ëe


192 || 
jou∫Æ
->
ª≠ög
 || 
	`hasBlockWaôîs
(journal)

193 || 
	`hasWaôîs
(&
jou∫Æ
->
ö¸emítWaôîs
)

194 || 
	`hasWaôîs
(&
jou∫Æ
->
de¸emítWaôîs
)) {

195  
Ál£
;

198 
RecovîyJou∫ÆBlock
 *
block
;

199 (
block
 = 
	`p›A˘iveLi°
(
jou∫Æ
)Ë!
NULL
) {

202 i‡(!
	`isRódO∆y
(
jou∫Æ
->
ªadO∆yC⁄ãxt
)) {

203 
	`ASSERT_LOG_ONLY
(((
block
->
íåyCou¡
 == 0) ||

204 (
block
->
íåyCou¡
 =block->
hódî
->entryCount)),

207 
	`pushRögNode
(&
jou∫Æ
->
‰ìTaûBlocks
, &
block
->
rögNode
);

210 
	`föishCom∂ëi⁄
(&
jou∫Æ
->
com∂ëi⁄
, (
	`isRódO∆y
(jou∫Æ->
ªadO∆yC⁄ãxt
)

211 ? 
VDO_READ_ONLY


212 : 
VDO_SUCCESS
));

213  
åue
;

214 
	}
}

217 
	$nŸifyRecovîyJou∫ÆOfRódO∆yMode
(
RecovîyJou∫Æ
 *
jou∫Æ
)

219 
	`checkF‹Closuª
(
jou∫Æ
);

220 
	}
}

230 
	$íãrJou∫ÆRódO∆yMode
(
RecovîyJou∫Æ
 *
jou∫Æ
, 
îr‹Code
)

232 
	`íãrRódO∆yMode
(
jou∫Æ
->
ªadO∆yC⁄ãxt
, 
îr‹Code
);

233 
	`checkF‹Closuª
(
jou∫Æ
);

234 
	}
}

237 
Sequí˚Numbî
 
	$gëCuºítJou∫ÆSequí˚Numbî
(
RecovîyJou∫Æ
 *
jou∫Æ
)

239  
jou∫Æ
->
èû
;

240 
	}
}

250 
ölöe
 
Sequí˚Numbî
 
	$gëRecovîyJou∫ÆHód
(
RecovîyJou∫Æ
 *
jou∫Æ
)

252  
	`möSequí˚Numbî
(
jou∫Æ
->
blockM≠Hód
, jou∫Æ->
¶abJou∫ÆHód
);

253 
	}
}

262 
__©åibuã__
((
w¨n_unu£d_ªsu…
))

263 
ölöe
 
uöt8_t
 
	$compuãRecovîyCou¡Byã
(
uöt64_t
 
ªcovîyCou¡
)

265  (
uöt8_t
Ë(
ªcovîyCou¡
 & 
RECOVERY_COUNT_MASK
);

266 
	}
}

274 
	$checkSœbJou∫ÆCommôThªshﬁd
(
RecovîyJou∫Æ
 *
jou∫Æ
)

276 
BlockCou¡
 
cuºítLígth
 = 
jou∫Æ
->
èû
 - jou∫Æ->
¶abJou∫ÆHód
;

277 i‡(
cuºítLígth
 > 
jou∫Æ
->
¶abJou∫ÆCommôThªshﬁd
) {

278 
jou∫Æ
->
evíts
.
¶abJou∫ÆCommôsReque°ed
++;

279 
	`commôOlde°SœbJou∫ÆTaûBlocks
(
jou∫Æ
->
dïŸ
,

280 
jou∫Æ
->
¶abJou∫ÆHód
);

282 
	}
}

285 
ª≠RecovîyJou∫Æ
(
RecovîyJou∫Æ
 *
jou∫Æ
);

286 
assignE¡rõs
(
RecovîyJou∫Æ
 *
jou∫Æ
);

293 
	$föishRópög
(
RecovîyJou∫Æ
 *
jou∫Æ
)

295 
Sequí˚Numbî
 
ﬁdHód
 = 
	`gëRecovîyJou∫ÆHód
(
jou∫Æ
);

296 
jou∫Æ
->
blockM≠Hód
 = jou∫Æ->
blockM≠RópHód
;

297 
jou∫Æ
->
¶abJou∫ÆHód
 = jou∫Æ->
¶abJou∫ÆRópHód
;

298 
BlockCou¡
 
blocksRó≥d
 = 
	`gëRecovîyJou∫ÆHód
(
jou∫Æ
Ë- 
ﬁdHód
;

299 
jou∫Æ
->
avaûabÀS∑˚
 +
blocksRó≥d
 * jou∫Æ->
íåõsPîBlock
;

300 
jou∫Æ
->
ª≠ög
 = 
Ál£
;

301 
	`checkSœbJou∫ÆCommôThªshﬁd
(
jou∫Æ
);

302 
	`assignE¡rõs
(
jou∫Æ
);

303 
	`checkF‹Closuª
(
jou∫Æ
);

304 
	}
}

312 
	$com∂ëeRópög
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

314 
RecovîyJou∫Æ
 *
jou∫Æ
 = 
com∂ëi⁄
->
∑ª¡
;

315 
	`föishRópög
(
jou∫Æ
);

318 
	`ª≠RecovîyJou∫Æ
(
jou∫Æ
);

319 
	}
}

326 
	$h™dÀFlushEº‹
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

328 
RecovîyJou∫Æ
 *
jou∫Æ
 = 
com∂ëi⁄
->
∑ª¡
;

329 
jou∫Æ
->
ª≠ög
 = 
Ál£
;

330 
	`íãrJou∫ÆRódO∆yMode
(
jou∫Æ
, 
com∂ëi⁄
->
ªsu…
);

331 
	}
}

338 
	$‰ìTaûBlock
(
RecovîyJou∫ÆBlock
 **
blockPå
)

340 
RecovîyJou∫ÆBlock
 *
block
 = *
blockPå
;

341 i‡(
block
 =
NULL
) {

345 
	`FREE
(
block
->block);

346 
	`‰ìVIO
(&
block
->
vio
);

347 
	`FREE
(
block
);

348 *
blockPå
 = 
NULL
;

349 
	}
}

358 
__©åibuã__
((
w¨n_unu£d_ªsu…
))

359 
	$makeJou∫ÆBlock
(
RecovîyJou∫Æ
 *
jou∫Æ
)

361 
RecovîyJou∫ÆBlock
 *
block
;

362 
ªsu…
 = 
	`ALLOCATE
(1, 
RecovîyJou∫ÆBlock
, 
__func__
, &
block
);

363 i‡(
ªsu…
 !
VDO_SUCCESS
) {

364  
ªsu…
;

369 
ªsu…
 = 
	`ALLOCATE
(
VDO_BLOCK_SIZE
, , "PackedJou∫ÆBlock", &
block
->block);

370 i‡(
ªsu…
 !
VDO_SUCCESS
) {

371 
	`‰ìTaûBlock
(&
block
);

372  
ªsu…
;

375 
ªsu…
 = 
	`¸óãVIO
(
jou∫Æ
->
com∂ëi⁄
.
œyî
, 
VIO_TYPE_RECOVERY_JOURNAL
,

376 
VIO_PRIORITY_HIGH
, 
block
, block->block, &block->
vio
);

377 i‡(
ªsu…
 !
VDO_SUCCESS
) {

378 
	`‰ìTaûBlock
(&
block
);

379  
ªsu…
;

382 
block
->
vio
->
com∂ëi⁄
.
ˇŒbackThªadID
 = 
jou∫Æ
->
thªadID
;

383 
	`öôülizeRög
(&
block
->
rögNode
);

384 
	`pushRögNode
(&
jou∫Æ
->
‰ìTaûBlocks
, &
block
->
rögNode
);

385 
block
->
hódî
 = (
PackedJou∫ÆHódî
 *) block->block;

386 
block
->
jou∫Æ
 = journal;

387  
VDO_SUCCESS
;

388 
	}
}

395 
	$adv™˚Se˘‹
(
RecovîyJou∫ÆBlock
 *
block
)

397 *
£˘‹Buf„r
 = (*Ë
block
->
£˘‹
;

398 
block
->
£˘‹
 = (
PackedJou∫ÆSe˘‹
 *Ë(
£˘‹Buf„r
 + 
VDO_SECTOR_SIZE
);

399 
block
->
£˘‹
->
checkByã
 = block->
hódî
->checkByte;

400 
block
->
£˘‹
->
ªcovîyCou¡
 = block->
jou∫Æ
->recoveryCount;

401 
block
->
£˘‹
->
íåyCou¡
 = 0;

402 
	}
}

409 
	$öôülizeA˘iveBlock
(
RecovîyJou∫Æ
 *
jou∫Æ
)

411 
RecovîyJou∫ÆBlock
 *
block
 = 
jou∫Æ
->
a˘iveBlock
;

412 
	`mem£t
(
block
->block, 0x0, 
VDO_BLOCK_SIZE
);

413 *(
block
->
hódî
Ë(
PackedJou∫ÆHódî
) {

414 .
íåyCou¡
 = 0,

415 .
£quí˚Numbî
 = 
jou∫Æ
->
èû
,

416 .
n⁄˚
 = 
jou∫Æ
->nonce,

417 .
mëad©aTy≥
 = 
VDO_METADATA_RECOVERY_JOURNAL
,

418 .
logiˇlBlocksU£d
 = 
jou∫Æ
->logicalBlocksUsed,

419 .
blockM≠D©aBlocks
 = 
jou∫Æ
->blockMapDataBlocks,

420 .
checkByã
 = 
	`compuãRecovîyCheckByã
(
jou∫Æ
, jou∫Æ->
èû
),

421 .
ªcovîyCou¡
 = 
jou∫Æ
->recoveryCount,

424 
block
->
blockNumbî
 = 
	`gëRecovîyJou∫ÆBlockNumbî
(
jou∫Æ
, jou∫Æ->
èû
);

425 
block
->
íåyCou¡
 = 0;

426 
block
->
£˘‹
 = (
PackedJou∫ÆSe˘‹
 *) block->block;

427 
	`adv™˚Se˘‹
(
block
);

428 
	}
}

436 
	$£tA˘iveBlock
(
RecovîyJou∫Æ
 *
jou∫Æ
)

438 
jou∫Æ
->
a˘iveBlock
 = 
	`p›FªeLi°
(journal);

439 
	`pushRögNode
(&
jou∫Æ
->
a˘iveTaûBlocks
, &jou∫Æ->
a˘iveBlock
->
rögNode
);

440 
	`öôülizeA˘iveBlock
(
jou∫Æ
);

441 
	}
}

449 
	$öôülizeJou∫ÆSèã
(
RecovîyJou∫Æ
 *
jou∫Æ
)

451 
jou∫Æ
->
≠≥ndPoöt
.
£quí˚Numbî
 = jou∫Æ->
èû
;

452 
jou∫Æ
->
œ°WrôeAcknowÀdged
 = jou∫Æ->
èû
;

453 
jou∫Æ
->
blockM≠Hód
 = jou∫Æ->
èû
;

454 
jou∫Æ
->
¶abJou∫ÆHód
 = jou∫Æ->
èû
;

455 
jou∫Æ
->
blockM≠RópHód
 = jou∫Æ->
èû
;

456 
jou∫Æ
->
¶abJou∫ÆRópHód
 = jou∫Æ->
èû
;

457 
jou∫Æ
->
blockM≠HódBlockNumbî


458 
	`gëRecovîyJou∫ÆBlockNumbî
(
jou∫Æ
, jou∫Æ->
blockM≠Hód
);

459 
jou∫Æ
->
¶abJou∫ÆHódBlockNumbî


460 
	`gëRecovîyJou∫ÆBlockNumbî
(
jou∫Æ
, jou∫Æ->
¶abJou∫ÆHód
);

461 
	}
}

464 
BlockCou¡
 
	$gëRecovîyJou∫ÆLígth
(
BlockCou¡
 
jou∫ÆSize
)

466 
BlockCou¡
 
ª£rvedBlocks
 = 
jou∫ÆSize
 / 4;

467 i‡(
ª£rvedBlocks
 > 
RECOVERY_JOURNAL_RESERVED_BLOCKS
) {

468 
ª£rvedBlocks
 = 
RECOVERY_JOURNAL_RESERVED_BLOCKS
;

470  (
jou∫ÆSize
 - 
ª£rvedBlocks
);

471 
	}
}

479 
	$ª≠RecovîyJou∫ÆCÆlback
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

481 
RecovîyJou∫Æ
 *
jou∫Æ
 = (RecovîyJou∫Æ *Ë
com∂ëi⁄
->
∑ª¡
;

484 
	`acknowÀdgeU∆ock
(
jou∫Æ
->
lockCou¡î
);

485 
	`ª≠RecovîyJou∫Æ
(
jou∫Æ
);

486 
	`checkSœbJou∫ÆCommôThªshﬁd
(
jou∫Æ
);

487 
	}
}

490 
	$makeRecovîyJou∫Æ
(
N⁄˚
 
n⁄˚
,

491 
PhysiˇlLayî
 *
œyî
,

492 
P¨tôi⁄
 *
∑πôi⁄
,

493 
uöt64_t
 
ªcovîyCou¡
,

494 
BlockCou¡
 
jou∫ÆSize
,

495 
BlockCou¡
 
èûBuf„rSize
,

496 
RódO∆yModeC⁄ãxt
 *
ªadO∆yC⁄ãxt
,

497 c⁄° 
ThªadC⁄fig
 *
thªadC⁄fig
,

498 
RecovîyJou∫Æ
 **
jou∫ÆPå
)

500 
RecovîyJou∫Æ
 *
jou∫Æ
;

501 
ªsu…
 = 
	`ALLOCATE
(1, 
RecovîyJou∫Æ
, 
__func__
, &
jou∫Æ
);

502 i‡(
ªsu…
 !
VDO_SUCCESS
) {

503  
ªsu…
;

506 
	`öôülizeCom∂ëi⁄
(&
jou∫Æ
->
com∂ëi⁄
, 
RECOVERY_JOURNAL_COMPLETION
,

507 
œyî
);

509 
	`öôülizeRög
(&
jou∫Æ
->
‰ìTaûBlocks
);

510 
	`öôülizeRög
(&
jou∫Æ
->
a˘iveTaûBlocks
);

512 
jou∫Æ
->
thªadID
 = 
	`gëJou∫ÆZ⁄eThªad
(
thªadC⁄fig
);

513 
jou∫Æ
->
∑πôi⁄
 =Öartition;

514 
jou∫Æ
->
n⁄˚
 =Çonce;

515 
jou∫Æ
->
ªcovîyCou¡
 = 
	`compuãRecovîyCou¡Byã
(recoveryCount);

516 
jou∫Æ
->
size
 = 
jou∫ÆSize
;

517 
jou∫Æ
->
ªadO∆yC⁄ãxt
 =ÑeadOnlyContext;

518 
jou∫Æ
->
èû
 = 1;

519 
jou∫Æ
->
¶abJou∫ÆCommôThªshﬁd
 = (
jou∫ÆSize
 * 2) / 3;

520 
	`öôülizeJou∫ÆSèã
(
jou∫Æ
);

524 
	`STATIC_ASSERT
(
RECOVERY_JOURNAL_ENTRIES_PER_BLOCK


525 <((
VDO_BLOCK_SIZE
 - (
PackedJou∫ÆHódî
))

526 / (
RecovîyJou∫ÆE¡ry
)));

527 
jou∫Æ
->
íåõsPîBlock
 = 
RECOVERY_JOURNAL_ENTRIES_PER_BLOCK
;

528 
jou∫Æ
->
íåõsPîSe˘‹
 = ((
VDO_SECTOR_SIZE
 - (
PackedJou∫ÆSe˘‹
))

529 / (
RecovîyJou∫ÆE¡ry
));

530 
jou∫Æ
->
œ°Se˘‹E¡rõs
 = (
RECOVERY_JOURNAL_ENTRIES_PER_BLOCK


531 % 
jou∫Æ
->
íåõsPîSe˘‹
);

532 i‡(
jou∫Æ
->
œ°Se˘‹E¡rõs
 == 0) {

533 
jou∫Æ
->
œ°Se˘‹E¡rõs
 = jou∫Æ->
íåõsPîSe˘‹
;

536 
BlockCou¡
 
jou∫ÆLígth
 = 
	`gëRecovîyJou∫ÆLígth
(
jou∫ÆSize
);

537 
jou∫Æ
->
avaûabÀS∑˚
 = jou∫Æ->
íåõsPîBlock
 * 
jou∫ÆLígth
;

541 i‡(
œyî
->
¸óãMëad©aVIO
 !
NULL
) {

542 
BlockCou¡
 
i
 = 0; i < 
èûBuf„rSize
; i++) {

543 
ªsu…
 = 
	`makeJou∫ÆBlock
(
jou∫Æ
);

544 i‡(
ªsu…
 !
VDO_SUCCESS
) {

545 
	`‰ìRecovîyJou∫Æ
(&
jou∫Æ
);

546  
ªsu…
;

550 
ªsu…
 = 
	`makeLockCou¡î
(
œyî
, 
jou∫Æ
, 
ª≠RecovîyJou∫ÆCÆlback
,

551 
jou∫Æ
->
thªadID
, 
thªadC⁄fig
->
logiˇlZ⁄eCou¡
,

552 
thªadC⁄fig
->
physiˇlZ⁄eCou¡
, 
jou∫Æ
->
size
,

553 &
jou∫Æ
->
lockCou¡î
);

554 i‡(
ªsu…
 !
VDO_SUCCESS
) {

555 
	`‰ìRecovîyJou∫Æ
(&
jou∫Æ
);

556  
ªsu…
;

559 
	`£tA˘iveBlock
(
jou∫Æ
);

561 i‡(
œyî
->
	`isFlushRequúed
(layer)) {

562 
ªsu…
 = 
	`ALLOCATE
(
VDO_BLOCK_SIZE
, , "journal flush data",

563 &
jou∫Æ
->
unu£dFlushVIOD©a
);

564 i‡(
ªsu…
 !
VDO_SUCCESS
) {

565 
	`‰ìRecovîyJou∫Æ
(&
jou∫Æ
);

566  
ªsu…
;

569 
ªsu…
 = 
	`¸óãVIO
(
œyî
, 
VIO_TYPE_RECOVERY_JOURNAL
, 
VIO_PRIORITY_HIGH
,

570 
jou∫Æ
, jou∫Æ->
unu£dFlushVIOD©a
,

571 &
jou∫Æ
->
ÊushVIO
);

572 i‡(
ªsu…
 !
VDO_SUCCESS
) {

573 
	`‰ìRecovîyJou∫Æ
(&
jou∫Æ
);

574  
ªsu…
;

577 
jou∫Æ
->
ÊushVIO
->
com∂ëi⁄
.
ˇŒbackThªadID
 = jou∫Æ->
thªadID
;

581 *
jou∫ÆPå
 = 
jou∫Æ
;

582  
VDO_SUCCESS
;

583 
	}
}

586 
	$‰ìRecovîyJou∫Æ
(
RecovîyJou∫Æ
 **
jou∫ÆPå
)

588 
RecovîyJou∫Æ
 *
jou∫Æ
 = *
jou∫ÆPå
;

589 i‡(
jou∫Æ
 =
NULL
) {

593 
	`‰ìLockCou¡î
(&
jou∫Æ
->
lockCou¡î
);

594 
	`‰ìVIO
(&
jou∫Æ
->
ÊushVIO
);

595 
	`FREE
(
jou∫Æ
->
unu£dFlushVIOD©a
);

597 
	`ASSERT_LOG_ONLY
(
	`isRögEm±y
(&
jou∫Æ
->
a˘iveTaûBlocks
),

599 
RecovîyJou∫ÆBlock
 *
block
;

600 (
block
 = 
	`p›FªeLi°
(
jou∫Æ
)Ë!
NULL
) {

601 
	`‰ìTaûBlock
(&
block
);

604 
	`FREE
(
jou∫Æ
);

605 *
jou∫ÆPå
 = 
NULL
;

606 
	}
}

609 
	$£tRecovîyJou∫ÆP¨tôi⁄
(
RecovîyJou∫Æ
 *
jou∫Æ
,

610 
P¨tôi⁄
 *
∑πôi⁄
)

612 
jou∫Æ
->
∑πôi⁄
 =Öartition;

613 
	}
}

616 
	$öôülizeRecovîyJou∫ÆPo°Recovîy
(
RecovîyJou∫Æ
 *
jou∫Æ
,

617 
uöt64_t
 
ªcovîyCou¡
,

618 
Sequí˚Numbî
 
èû
)

620 
jou∫Æ
->
èû
 =Åail + 1;

621 
jou∫Æ
->
ªcovîyCou¡
 = 
	`compuãRecovîyCou¡Byã
(recoveryCount);

622 
	`öôülizeA˘iveBlock
(
jou∫Æ
);

623 
	`öôülizeJou∫ÆSèã
(
jou∫Æ
);

624 
	}
}

627 
	$öôülizeRecovîyJou∫ÆPo°Rebuûd
(
RecovîyJou∫Æ
 *
jou∫Æ
,

628 
uöt64_t
 
ªcovîyCou¡
,

629 
Sequí˚Numbî
 
èû
,

630 
BlockCou¡
 
logiˇlBlocksU£d
,

631 
BlockCou¡
 
blockM≠D©aBlocks
)

633 
	`öôülizeRecovîyJou∫ÆPo°Recovîy
(
jou∫Æ
, 
ªcovîyCou¡
, 
èû
);

634 
jou∫Æ
->
logiˇlBlocksU£d
 =ÜogicalBlocksUsed;

635 
jou∫Æ
->
blockM≠D©aBlocks
 = blockMapDataBlocks;

636 
	}
}

639 
BlockCou¡
 
	$gëJou∫ÆBlockM≠D©aBlocksU£d
(
RecovîyJou∫Æ
 *
jou∫Æ
)

641  
jou∫Æ
->
blockM≠D©aBlocks
;

642 
	}
}

645 
	$£tJou∫ÆBlockM≠D©aBlocksU£d
(
RecovîyJou∫Æ
 *
jou∫Æ
,

646 
BlockCou¡
 
∑ges
)

648 
jou∫Æ
->
blockM≠D©aBlocks
 = 
∑ges
;

649 
	}
}

652 
	$›íRecovîyJou∫Æ
(
RecovîyJou∫Æ
 *
jou∫Æ
,

653 
SœbDïŸ
 *
dïŸ
,

654 
BlockM≠
 *
blockM≠
)

656 
jou∫Æ
->
dïŸ
 = depot;

657 
jou∫Æ
->
blockM≠
 = blockMap;

658 
	}
}

661 
size_t
 
	$gëRecovîyJou∫ÆEncodedSize
()

663  
ENCODED_HEADER_SIZE
 + (
RecovîyJou∫ÆSèã7_0
);

664 
	}
}

667 
	$decodeRecovîyJou∫ÆE¡ry
(
VDO
 *
vdo
,

668 
RecovîyJou∫ÆE¡ry
 *
íåy
,

669 
Jou∫ÆO≥øti⁄
 *
›î©i⁄
,

670 
BlockM≠SlŸ
 *
¶Ÿ
,

671 
PhysiˇlBlockNumbî
 *
pbn
)

673 
	`decodeO≥øti⁄AndBlockM≠SlŸ
(
íåy
, 
›î©i⁄
, 
¶Ÿ
);

674 
PhysiˇlBlockNumbî
 
u≈ackedPBN
 = 
	`u≈ackPBN
(&
íåy
->
blockM≠E¡ry
);

675 i‡((
¶Ÿ
->
pbn
 >
vdo
->
c⁄fig
.
physiˇlBlocks
)

676 || (
¶Ÿ
->¶Ÿ >
BLOCK_MAP_ENTRIES_PER_PAGE
)

677 || 
	`isInvÆid
(&
íåy
->
blockM≠E¡ry
)

678 || !
	`isPhysiˇlD©aBlock
(
vdo
->
dïŸ
, 
u≈ackedPBN
)) {

679  
	`logEº‹WôhSåögEº‹
(
VDO_CORRUPT_JOURNAL
, "InvalidÉntry:"

680 " (%" 
PRIu64
 ", %" 
PRIu16
 ")Åo %" PRIu64

682 
¶Ÿ
->
pbn
, slŸ->¶Ÿ, 
u≈ackedPBN
,

683 
	`gëJou∫ÆO≥øti⁄Name
(*
›î©i⁄
));

686 i‡((*
›î©i⁄
 =
BLOCK_MAP_INCREMENT
)

687 && (
	`isCom¥es£d
(
íåy
->
blockM≠E¡ry
.
m≠pögSèã
)

688 || (
u≈ackedPBN
 =
ZERO_BLOCK
))) {

689  
	`logEº‹WôhSåögEº‹
(
VDO_CORRUPT_JOURNAL
, "InvalidÉntry:"

690 " (%" 
PRIu64
 ", %" 
PRIu16
 ")Åo %" PRIu64

692 
¶Ÿ
->
pbn
, slŸ->¶Ÿ, 
u≈ackedPBN
,

693 
	`gëJou∫ÆO≥øti⁄Name
(*
›î©i⁄
));

696 i‡(
pbn
 !
NULL
) {

697 *
pbn
 = 
u≈ackedPBN
;

699  
VDO_SUCCESS
;

700 
	}
}

703 
	$ícodeRecovîyJou∫Æ
(
RecovîyJou∫Æ
 *
jou∫Æ
, 
Buf„r
 *
buf„r
)

707 
RecovîyJou∫ÆSèã7_0
 
°©e
 = {

708 .
jou∫ÆSèπ
 = 
	`gëRecovîyJou∫ÆHód
(
jou∫Æ
),

709 .
logiˇlBlocksU£d
 = 
jou∫Æ
->logicalBlocksUsed,

710 .
blockM≠D©aBlocks
 = 
jou∫Æ
->blockMapDataBlocks,

712 i‡(
jou∫Æ
->
˛o£Reque°ed
) {

715 
°©e
.
jou∫ÆSèπ
 = 
jou∫Æ
->
èû
;

718  
	`ícodeWôhHódî
(
CURRENT_RECOVERY_JOURNAL_HEADER
, &
°©e
, 
buf„r
);

719 
	}
}

722 
	$decodeSodiumRecovîyJou∫Æ
(
RecovîyJou∫Æ
 *
jou∫Æ
, 
Buf„r
 *
buf„r
)

725  
	`decodeRecovîyJou∫Æ
(
jou∫Æ
, 
buf„r
);

726 
	}
}

729 
	$decodeRecovîyJou∫Æ
(
RecovîyJou∫Æ
 *
jou∫Æ
, 
Buf„r
 *
buf„r
)

731 
Hódî
 
hódî
;

732 
ªsu…
 = 
	`decodeHódî
(
buf„r
, &
hódî
);

733 i‡(
ªsu…
 !
VDO_SUCCESS
) {

734  
ªsu…
;

737 
ªsu…
 = 
	`vÆid©eHódî
(
CURRENT_RECOVERY_JOURNAL_HEADER
, &
hódî
,

738 
åue
, 
__func__
);

739 i‡(
ªsu…
 !
VDO_SUCCESS
) {

740  
ªsu…
;

743 
RecovîyJou∫ÆSèã7_0
 
°©e
;

744 
ªsu…
 = 
	`gëByãsFromBuf„r
(
buf„r
, (
RecovîyJou∫ÆSèã7_0
), &
°©e
);

745 i‡(
ªsu…
 !
VDO_SUCCESS
) {

746  
ªsu…
;

750 
jou∫Æ
->
èû
 = 
°©e
.
jou∫ÆSèπ
;

751 
jou∫Æ
->
logiˇlBlocksU£d
 = 
°©e
.logicalBlocksUsed;

752 
jou∫Æ
->
blockM≠D©aBlocks
 = 
°©e
.blockMapDataBlocks;

753 
	`öôülizeJou∫ÆSèã
(
jou∫Æ
);

755 i‡(
jou∫Æ
->
com∂ëi⁄
.
œyî
->
¸óãMëad©aVIO
 !
NULL
) {

758 
	`öôülizeA˘iveBlock
(
jou∫Æ
);

761  
VDO_SUCCESS
;

762 
	}
}

771 
__©åibuã__
((
w¨n_unu£d_ªsu…
))

772 
ölöe
 
boﬁ
 
	$isBlockFuŒ
(
RecovîyJou∫ÆBlock
 *
block
)

774  (
block
->
jou∫Æ
->
íåõsPîBlock
 =block->
íåyCou¡
);

775 
	}
}

784 
__©åibuã__
((
w¨n_unu£d_ªsu…
))

785 
ölöe
 
boﬁ
 
	$isSe˘‹FuŒ
(
RecovîyJou∫ÆBlock
 *
block
)

787  (
block
->
jou∫Æ
->
íåõsPîSe˘‹
 =block->
£˘‹
->
íåyCou¡
);

788 
	}
}

797 
__©åibuã__
((
w¨n_unu£d_ªsu…
))

798 
ölöe
 
boﬁ
 
	$isEm±y
(
RecovîyJou∫ÆBlock
 *
block
)

800  (
block
->
íåyCou¡
 == 0);

801 
	}
}

810 
__©åibuã__
((
w¨n_unu£d_ªsu…
))

811 
boﬁ
 
	$isBlockCom∂ëe
(c⁄° 
RecovîyJou∫ÆBlock
 *
block
)

813  (!
block
->
commôtög


814 && (
block
->
jou∫Æ
->
íåõsPîBlock
 =block->
hódî
->
íåyCou¡
));

815 
	}
}

822 
	$adv™˚Taû
(
RecovîyJou∫Æ
 *
jou∫Æ
)

824 
	`adv™˚BlockM≠Eø
(
jou∫Æ
->
blockM≠
, jou∫Æ->
èû
 + 1);

825 
	`£tA˘iveBlock
(
jou∫Æ
);

826 
jou∫Æ
->
èû
++;

827 
	}
}

839 
boﬁ
 
	$checkF‹E¡ryS∑˚
(
RecovîyJou∫Æ
 *
jou∫Æ
, 
boﬁ
 
ö¸emít
)

841 i‡(
ö¸emít
) {

842  ((
jou∫Æ
->
avaûabÀS∑˚
 - jou∫Æ->
≥ndögDe¸emítCou¡
) > 1);

845  (
jou∫Æ
->
avaûabÀS∑˚
 > 0);

846 
	}
}

859 
boﬁ
 
	$¥ï¨eToAssignE¡ry
(
RecovîyJou∫ÆBlock
 *
block
, 
boﬁ
 
ö¸emít
)

861 i‡(
block
 =
NULL
) {

862  
Ál£
;

865 
RecovîyJou∫Æ
 *
jou∫Æ
 = 
block
->journal;

866 i‡(!
	`isEm±y
(
block
)) {

867  
	`checkF‹E¡ryS∑˚
(
jou∫Æ
, 
ö¸emít
);

870 i‡((
jou∫Æ
->
èû
 - 
	`gëRecovîyJou∫ÆHód
(jou∫Æ)Ë> jou∫Æ->
size
) {

872 
jou∫Æ
->
evíts
.
diskFuŒ
++;

873  
Ál£
;

876 i‡(!
	`checkF‹E¡ryS∑˚
(
jou∫Æ
, 
ö¸emít
)) {

877  
Ál£
;

887 
BlockCou¡
 
blockNumbî


888 
	`gëRecovîyJou∫ÆBlockNumbî
(
jou∫Æ
, 
block
->
hódî
->
£quí˚Numbî
);

889 
	`öôülizeLockCou¡
(
jou∫Æ
->
lockCou¡î
, 
blockNumbî
,

890 
jou∫Æ
->
íåõsPîBlock
 + 1);

891  
åue
;

892 
	}
}

895 
wrôeBlock
(
RecovîyJou∫Æ
 *
jou∫Æ
, 
RecovîyJou∫ÆBlock
 *
block
);

902 
	$ªÀa£Jou∫ÆBlockRe„ªn˚
(
RecovîyJou∫ÆBlock
 *
block
)

904 
RecovîyJou∫Æ
 *
jou∫Æ
 = 
block
->journal;

905 
BlockCou¡
 
blockNumbî


906 
	`gëRecovîyJou∫ÆBlockNumbî
(
jou∫Æ
, 
block
->
hódî
->
£quí˚Numbî
);

907 
	`ªÀa£Jou∫ÆZ⁄eRe„ªn˚
(
jou∫Æ
->
lockCou¡î
, 
blockNumbî
);

908 
	}
}

913 
	$assignE¡ry
(
Waôî
 *
waôî
, *
c⁄ãxt
)

915 
D©aVIO
 *
d©aVIO
 = 
	`waôîAsD©aVIO
(
waôî
);

916 
RecovîyJou∫ÆBlock
 *
block
 = (RecovîyJou∫ÆBlock *Ë
c⁄ãxt
;

917 
RecovîyJou∫Æ
 *
jou∫Æ
 = 
block
->journal;

919 i‡(
jou∫Æ
->
èû
 =
	`gëRecovîyJou∫ÆHód
(journal)) {

921 
jou∫Æ
->
èû
++;

924 i‡(
block
->
íåyCou¡
 =block->
hódî
->entryCount) {

927 
jou∫Æ
->
evíts
.
blocks
.
°¨ãd
++;

931 
d©aVIO
->
ªcovîyJou∫ÆPoöt
 = (
Jou∫ÆPoöt
) {

932 .
£quí˚Numbî
 = 
block
->
hódî
->sequenceNumber,

933 .
íåyCou¡
 = 
block
->entryCount,

936 
d©aVIO
->
›î©i⁄
.
ty≥
) {

937 
DATA_INCREMENT
:

938 i‡(
d©aVIO
->
›î©i⁄
.
°©e
 !
MAPPING_STATE_UNMAPPED
) {

939 
jou∫Æ
->
logiˇlBlocksU£d
++;

941 
jou∫Æ
->
≥ndögDe¸emítCou¡
++;

944 
DATA_DECREMENT
:

945 i‡(
d©aVIO
->
›î©i⁄
.
°©e
 !
MAPPING_STATE_UNMAPPED
) {

946 
jou∫Æ
->
logiˇlBlocksU£d
--;

951 
	`ªÀa£Jou∫ÆBlockRe„ªn˚
(
block
);

952 
	`ASSERT_LOG_ONLY
((
jou∫Æ
->
≥ndögDe¸emítCou¡
 != 0),

954 
jou∫Æ
->
≥ndögDe¸emítCou¡
--;

957 
BLOCK_MAP_INCREMENT
:

958 
jou∫Æ
->
blockM≠D©aBlocks
++;

962 
	`logEº‹
("InvÆid jou∫Æ o≥øti⁄ %u", 
d©aVIO
->
›î©i⁄
.
ty≥
);

963 
	`íãrJou∫ÆRódO∆yMode
(
jou∫Æ
, 
VDO_NOT_IMPLEMENTED
);

964 
	`c⁄töueD©aVIO
(
d©aVIO
, 
VDO_NOT_IMPLEMENTED
);

969 
jou∫Æ
->
evíts
.
íåõs
.
°¨ãd
++;

970 
block
->
íåyCou¡
++;

971 
jou∫Æ
->
avaûabÀS∑˚
--;

972 i‡(
	`isBlockFuŒ
(
block
)) {

973 
	`adv™˚Taû
(
jou∫Æ
);

977 
ªsu…
 = 
	`íqueueD©aVIO
(&
block
->
íåyWaôîs
, 
d©aVIO
,

978 
	`THIS_LOCATION
("$F($j-$js)"));

979 i‡(
ªsu…
 !
VDO_SUCCESS
) {

980 
	`íãrJou∫ÆRódO∆yMode
(
jou∫Æ
, 
ªsu…
);

981 
	`c⁄töueD©aVIO
(
d©aVIO
, 
ªsu…
);

984 i‡(
	`isBlockFuŒ
(
block
)) {

987 
	`wrôeBlock
(
jou∫Æ
, 
block
);

991 
	`checkSœbJou∫ÆCommôThªshﬁd
(
jou∫Æ
);

992 
	}
}

995 
boﬁ
 
	$assignE¡rõsFromQueue
(
RecovîyJou∫Æ
 *
jou∫Æ
,

996 
WaôQueue
 *
queue
,

997 
boﬁ
 
ö¸emít
)

999 
	`hasWaôîs
(
queue
)) {

1001 
RecovîyJou∫ÆBlock
 *
block
 = 
jou∫Æ
->
a˘iveBlock
;

1002 i‡(!
	`¥ï¨eToAssignE¡ry
(
block
, 
ö¸emít
)) {

1003 i‡(!
ö¸emít
) {

1004 
	`logEº‹
("No space for decrementÉntry inÑecovery journal");

1005 
	`íãrJou∫ÆRódO∆yMode
(
jou∫Æ
, 
VDO_RECOVERY_JOURNAL_FULL
);

1007  
Ál£
;

1010 
	`nŸifyNextWaôî
(
queue
, 
assignE¡ry
, 
block
);

1013  
åue
;

1014 
	}
}

1017 
	$assignE¡rõs
(
RecovîyJou∫Æ
 *
jou∫Æ
)

1019 i‡(
jou∫Æ
->
addögE¡rõs
) {

1024 
jou∫Æ
->
addögE¡rõs
 = 
åue
;

1025 i‡(
	`assignE¡rõsFromQueue
(
jou∫Æ
, &jou∫Æ->
de¸emítWaôîs
, 
Ál£
)) {

1026 
	`assignE¡rõsFromQueue
(
jou∫Æ
, &jou∫Æ->
ö¸emítWaôîs
, 
åue
);

1031 
	`wrôeBlock
(
jou∫Æ
, jou∫Æ->
a˘iveBlock
);

1032 
jou∫Æ
->
addögE¡rõs
 = 
Ál£
;

1033 
	}
}

1041 
	$ªcy˛eJou∫ÆBlock
(
RecovîyJou∫ÆBlock
 *
block
)

1043 
RecovîyJou∫Æ
 *
jou∫Æ
 = 
block
->journal;

1044 
	`pushRögNode
(&
jou∫Æ
->
‰ìTaûBlocks
, &
block
->
rögNode
);

1048 i‡(
block
->
íåyCou¡
 > 0) {

1049 
	`ªÀa£Jou∫ÆBlockRe„ªn˚
(
block
);

1057 
	`wrôeBlock
(
jou∫Æ
, jou∫Æ->
a˘iveBlock
);

1058 
	}
}

1064 
	$c⁄töueCommôãdWaôî
(
Waôî
 *
waôî
, *
c⁄ãxt
)

1066 
D©aVIO
 *
d©aVIO
 = 
	`waôîAsD©aVIO
(
waôî
);

1067 
RecovîyJou∫Æ
 *
jou∫Æ
 = (RecovîyJou∫Æ *Ë
c⁄ãxt
;

1068 
	`ASSERT_LOG_ONLY
(
	`bef‹eJou∫ÆPoöt
(&
jou∫Æ
->
commôPoöt
,

1069 &
d©aVIO
->
ªcovîyJou∫ÆPoöt
),

1071 "Recovîy jou∫ÆÖoöài†(%" 
PRIu64
 ", %" 
PRIu16
 "), "

1072 "buàcommô waôîÖoöài†(%" 
PRIu64
 ", %" 
PRIu16
 ")",

1073 
jou∫Æ
->
commôPoöt
.
£quí˚Numbî
,

1074 
jou∫Æ
->
commôPoöt
.
íåyCou¡
,

1075 
d©aVIO
->
ªcovîyJou∫ÆPoöt
.
£quí˚Numbî
,

1076 
d©aVIO
->
ªcovîyJou∫ÆPoöt
.
íåyCou¡
);

1077 
jou∫Æ
->
commôPoöt
 = 
d©aVIO
->
ªcovîyJou∫ÆPoöt
;

1079 
ªsu…


1080 (
	`isRódO∆y
(
jou∫Æ
->
ªadO∆yC⁄ãxt
Ë? 
VDO_READ_ONLY
 : 
VDO_SUCCESS
);

1081 
	`c⁄töueWaôî
(
waôî
, &
ªsu…
);

1082 
	}
}

1090 
	$nŸifyCommôWaôîs
(
RecovîyJou∫Æ
 *
jou∫Æ
)

1092 
RecovîyJou∫ÆBlock
 *
œ°Iãøti⁄Block
 = 
NULL
;

1093 !
	`isRögEm±y
(&
jou∫Æ
->
a˘iveTaûBlocks
)) {

1094 
RecovîyJou∫ÆBlock
 *
block


1095 
	`blockFromRögNode
(
jou∫Æ
->
a˘iveTaûBlocks
.
√xt
);

1097 
ªsu…
 = 
	`ASSERT
(
block
 !
œ°Iãøti⁄Block
,

1099 i‡(
ªsu…
 !
VDO_SUCCESS
) {

1100 
	`íãrJou∫ÆRódO∆yMode
(
jou∫Æ
, 
ªsu…
);

1103 
œ°Iãøti⁄Block
 = 
block
;

1105 i‡(
block
->
commôtög
) {

1109 
	`nŸifyAŒWaôîs
(&
block
->
commôWaôîs
, 
c⁄töueCommôãdWaôî
, 
jou∫Æ
);

1110 i‡(
	`isRódO∆y
(
jou∫Æ
->
ªadO∆yC⁄ãxt
)) {

1111 
	`nŸifyAŒWaôîs
(&
block
->
íåyWaôîs
, 
c⁄töueCommôãdWaôî
, 
jou∫Æ
);

1113 i‡(!
	`isBlockCom∂ëe
(
block
)) {

1117 
	`ªcy˛eJou∫ÆBlock
(
block
);

1119 
	}
}

1129 
boﬁ
 
	$shouldCommô
(
RecovîyJou∫Æ
 *
jou∫Æ
, 
RecovîyJou∫ÆBlock
 *
block
)

1133 i‡(
	`isRódO∆y
(
jou∫Æ
->
ªadO∆yC⁄ãxt
Ë|| 
block
->
commôtög


1134 || !
	`hasWaôîs
(&
block
->
íåyWaôîs
)) {

1135  
Ál£
;

1139 i‡(
	`isBlockFuŒ
(
block
)) {

1140  
åue
;

1151  (
jou∫Æ
->
≥ndögWrôeCou¡
 == 0);

1152 
	}
}

1161 
	$com∂ëeWrôe
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

1163 
RecovîyJou∫ÆBlock
 *
block
 = 
com∂ëi⁄
->
∑ª¡
;

1164 
RecovîyJou∫Æ
 *
jou∫Æ
 = 
block
->journal;

1165 
	`as£πOnJou∫ÆThªad
(
jou∫Æ
, 
__func__
);

1167 
jou∫Æ
->
≥ndögWrôeCou¡
 -= 1;

1168 
jou∫Æ
->
evíts
.
blocks
.
commôãd
 += 1;

1169 
jou∫Æ
->
evíts
.
íåõs
.
commôãd
 +
block
->
íåõsInCommô
;

1170 
block
->
commôtög
 = 
Ál£
;

1171 
block
->
ÊushBef‹eWrôe
 = 
Ál£
;

1174 i‡(
block
->
hódî
->
£quí˚Numbî
 > 
jou∫Æ
->
œ°WrôeAcknowÀdged
) {

1175 
jou∫Æ
->
œ°WrôeAcknowÀdged
 = 
block
->
hódî
->
£quí˚Numbî
;

1178 
RecovîyJou∫ÆBlock
 *
œ°A˘iveBlock


1179 
	`blockFromRögNode
(
jou∫Æ
->
a˘iveTaûBlocks
.
√xt
);

1180 
	`ASSERT_LOG_ONLY
((
block
->
hódî
->
£quí˚Numbî


1181 >
œ°A˘iveBlock
->
hódî
->
£quí˚Numbî
),

1184 
	`nŸifyCommôWaôîs
(
jou∫Æ
);

1185 i‡(
	`checkF‹Closuª
(
jou∫Æ
)) {

1190 i‡(
	`hasWaôîs
(&
block
->
íåyWaôîs
)) {

1191 
	`wrôeBlock
(
jou∫Æ
, 
block
);

1193 
	}
}

1196 
	$h™dÀWrôeEº‹
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

1198 
RecovîyJou∫ÆBlock
 *
block
 = 
com∂ëi⁄
->
∑ª¡
;

1199 
RecovîyJou∫Æ
 *
jou∫Æ
 = 
block
->journal;

1200 
	`logEº‹WôhSåögEº‹
(
com∂ëi⁄
->
ªsu…
,

1201 "ˇ¬Ÿ wrôêªcovîy jou∫Æ block %" 
PRIu64
,

1202 
block
->
hódî
->
£quí˚Numbî
);

1203 
	`íãrJou∫ÆRódO∆yMode
(
jou∫Æ
, 
com∂ëi⁄
->
ªsu…
);

1204 
	`com∂ëeWrôe
(
com∂ëi⁄
);

1205 
	}
}

1208 
__©åibuã__
((
w¨n_unu£d_ªsu…
))

1209 
	$gëJou∫ÆBlockPBN
(
RecovîyJou∫ÆBlock
 *
block
,

1210 
PhysiˇlBlockNumbî
 *
pbnPå
)

1212 
RecovîyJou∫Æ
 *
jou∫Æ
 = 
block
->journal;

1213 
ªsu…
 = 
	`å™¶©eToPBN
(
jou∫Æ
->
∑πôi⁄
, 
block
->
blockNumbî
, 
pbnPå
);

1214 i‡(
ªsu…
 !
VDO_SUCCESS
) {

1215 
	`logEº‹WôhSåögEº‹
(
ªsu…
,

1217 "numbî %" 
PRIu64
, 
block
->
blockNumbî
);

1219  
ªsu…
;

1220 
	}
}

1229 
__©åibuã__
((
w¨n_unu£d_ªsu…
))

1230 
	$addE¡rõs
(
RecovîyJou∫ÆBlock
 *
block
)

1232 
	`hasWaôîs
(&
block
->
íåyWaôîs
)) {

1233 
D©aVIO
 *
d©aVIO


1234 
	`waôîAsD©aVIO
(
	`dequeueNextWaôî
(&
block
->
íåyWaôîs
));

1236 i‡(
d©aVIO
->
isP¨tülWrôe
) {

1239 
block
->
ÊushBef‹eWrôe
 = 
åue
;

1243 
RecovîyJou∫ÆE¡ry
 *
√wE¡ry


1244 &
block
->
£˘‹
->
íåõs
[block->£˘‹->
íåyCou¡
++];

1245 
TªeLock
 *
lock
 = &
d©aVIO
->
åìLock
;

1246 
	`ícodeO≥øti⁄AndBlockM≠SlŸ
(
√wE¡ry
, 
d©aVIO
->
›î©i⁄
.
ty≥
,

1247 
lock
->
åìSlŸs
[lock->
height
].
blockM≠SlŸ
);

1248 
√wE¡ry
->
blockM≠E¡ry
 = 
	`∑ckPBN
(
d©aVIO
->
›î©i⁄
.
pbn
,

1249 
d©aVIO
->
›î©i⁄
.
°©e
);

1251 i‡(
	`isIn¸emítO≥øti⁄
(
d©aVIO
->
›î©i⁄
.
ty≥
)) {

1252 
d©aVIO
->
ªcovîySequí˚Numbî
 = 
block
->
hódî
->
£quí˚Numbî
;

1256 
ªsu…
 = 
	`íqueueD©aVIO
(&
block
->
commôWaôîs
, 
d©aVIO
,

1257 
	`THIS_LOCATION
("$F($j-$js)"));

1258 i‡(
ªsu…
 !
VDO_SUCCESS
) {

1259 
	`c⁄töueD©aVIO
(
d©aVIO
, 
ªsu…
);

1260  
ªsu…
;

1263 i‡(
	`isSe˘‹FuŒ
(
block
)) {

1264 
	`adv™˚Se˘‹
(
block
);

1268  
VDO_SUCCESS
;

1269 
	}
}

1279 
	$wrôeBlock
(
RecovîyJou∫Æ
 *
jou∫Æ
, 
RecovîyJou∫ÆBlock
 *
block
)

1281 
	`as£πOnJou∫ÆThªad
(
jou∫Æ
, 
__func__
);

1282 i‡(!
	`shouldCommô
(
jou∫Æ
, 
block
)) {

1286 
PhysiˇlBlockNumbî
 
blockPBN
;

1287 
ªsu…
 = 
	`gëJou∫ÆBlockPBN
(
block
, &
blockPBN
);

1288 i‡(
ªsu…
 !
VDO_SUCCESS
) {

1289 
	`íãrJou∫ÆRódO∆yMode
(
jou∫Æ
, 
ªsu…
);

1293 
block
->
íåõsInCommô
 = 
	`cou¡Waôîs
(&block->
íåyWaôîs
);

1294 
ªsu…
 = 
	`addE¡rõs
(
block
);

1295 i‡(
ªsu…
 !
VDO_SUCCESS
) {

1296 
	`íãrJou∫ÆRódO∆yMode
(
jou∫Æ
, 
ªsu…
);

1301 
jou∫Æ
->
≥ndögWrôeCou¡
 += 1;

1302 
jou∫Æ
->
evíts
.
blocks
.
wrôãn
 += 1;

1303 
jou∫Æ
->
evíts
.
íåõs
.
wrôãn
 +
block
->
íåõsInCommô
;

1305 
block
->
hódî
->
blockM≠Hód
 = 
jou∫Æ
->blockMapHead;

1306 
block
->
hódî
->
¶abJou∫ÆHód
 = 
jou∫Æ
->slabJournalHead;

1307 
block
->
hódî
->
íåyCou¡
 = block->entryCount;

1308 
block
->
commôtög
 = 
åue
;

1310 
	`œunchWrôeMëad©aVIOWôhFlush
(
block
->
vio
, 
blockPBN
, 
com∂ëeWrôe
,

1311 
h™dÀWrôeEº‹
, 
block
->
ÊushBef‹eWrôe
,

1312 
Ál£
);

1313 
	}
}

1316 
	$addRecovîyJou∫ÆE¡ry
(
RecovîyJou∫Æ
 *
jou∫Æ
, 
D©aVIO
 *
d©aVIO
)

1318 
	`as£πOnJou∫ÆThªad
(
jou∫Æ
, 
__func__
);

1319 i‡(
jou∫Æ
->
˛o£Reque°ed
) {

1320 
	`c⁄töueD©aVIO
(
d©aVIO
, 
VDO_SHUTTING_DOWN
);

1324 i‡(
	`isRódO∆y
(
jou∫Æ
->
ªadO∆yC⁄ãxt
)) {

1325 
	`c⁄töueD©aVIO
(
d©aVIO
, 
VDO_READ_ONLY
);

1329 
boﬁ
 
ö¸emít
 = 
	`isIn¸emítO≥øti⁄
(
d©aVIO
->
›î©i⁄
.
ty≥
);

1330 
	`ASSERT_LOG_ONLY
((!
ö¸emít
 || (
d©aVIO
->
ªcovîySequí˚Numbî
 == 0)),

1333 
	`adv™˚Jou∫ÆPoöt
(&
jou∫Æ
->
≠≥ndPoöt
, jou∫Æ->
íåõsPîBlock
);

1334 
ªsu…
 = 
	`íqueueD©aVIO
((
ö¸emít


1335 ? &
jou∫Æ
->
ö¸emítWaôîs


1336 : &
jou∫Æ
->
de¸emítWaôîs
), 
d©aVIO
,

1337 
	`THIS_LOCATION
("$F($j-$js);io=journal($j-$js)"));

1338 i‡(
ªsu…
 !
VDO_SUCCESS
) {

1339 
	`íãrJou∫ÆRódO∆yMode
(
jou∫Æ
, 
ªsu…
);

1340 
	`c⁄töueD©aVIO
(
d©aVIO
, 
ªsu…
);

1344 
	`assignE¡rõs
(
jou∫Æ
);

1345 
	}
}

1352 
	$ª≠RecovîyJou∫Æ
(
RecovîyJou∫Æ
 *
jou∫Æ
)

1354 i‡(
jou∫Æ
->
ª≠ög
) {

1362 (
jou∫Æ
->
blockM≠RópHód
 < jou∫Æ->
œ°WrôeAcknowÀdged
)

1363 && !
	`isLocked
(
jou∫Æ
->
lockCou¡î
, jou∫Æ->
blockM≠HódBlockNumbî
,

1364 
ZONE_TYPE_LOGICAL
)) {

1365 
jou∫Æ
->
blockM≠RópHód
++;

1366 i‡(++
jou∫Æ
->
blockM≠HódBlockNumbî
 =jou∫Æ->
size
) {

1367 
jou∫Æ
->
blockM≠HódBlockNumbî
 = 0;

1371 (
jou∫Æ
->
¶abJou∫ÆRópHód
 < jou∫Æ->
œ°WrôeAcknowÀdged
)

1372 && !
	`isLocked
(
jou∫Æ
->
lockCou¡î
,

1373 
jou∫Æ
->
¶abJou∫ÆHódBlockNumbî
,

1374 
ZONE_TYPE_PHYSICAL
)) {

1375 
jou∫Æ
->
¶abJou∫ÆRópHód
++;

1376 i‡(++
jou∫Æ
->
¶abJou∫ÆHódBlockNumbî
 =jou∫Æ->
size
) {

1377 
jou∫Æ
->
¶abJou∫ÆHódBlockNumbî
 = 0;

1381 i‡((
jou∫Æ
->
blockM≠RópHód
 =jou∫Æ->
blockM≠Hód
)

1382 && (
jou∫Æ
->
¶abJou∫ÆRópHód
 =jou∫Æ->
¶abJou∫ÆHód
)) {

1387 i‡(
jou∫Æ
->
ÊushVIO
 =
NULL
) {

1388 
	`föishRópög
(
jou∫Æ
);

1396 
jou∫Æ
->
ª≠ög
 = 
åue
;

1397 
	`œunchFlush
(
jou∫Æ
->
ÊushVIO
, 
com∂ëeRópög
, 
h™dÀFlushEº‹
);

1398 
	}
}

1401 
	$acquúeRecovîyJou∫ÆBlockRe„ªn˚
(
RecovîyJou∫Æ
 *
jou∫Æ
,

1402 
Sequí˚Numbî
 
£quí˚Numbî
,

1403 
Z⁄eTy≥
 
z⁄eTy≥
,

1404 
Z⁄eCou¡
 
z⁄eID
)

1406 i‡(
£quí˚Numbî
 == 0) {

1410 
BlockCou¡
 
blockNumbî


1411 
	`gëRecovîyJou∫ÆBlockNumbî
(
jou∫Æ
, 
£quí˚Numbî
);

1412 
	`acquúeLockCou¡Re„ªn˚
(
jou∫Æ
->
lockCou¡î
, 
blockNumbî
, 
z⁄eTy≥
,

1413 
z⁄eID
);

1414 
	}
}

1417 
	$ªÀa£RecovîyJou∫ÆBlockRe„ªn˚
(
RecovîyJou∫Æ
 *
jou∫Æ
,

1418 
Sequí˚Numbî
 
£quí˚Numbî
,

1419 
Z⁄eTy≥
 
z⁄eTy≥
,

1420 
Z⁄eCou¡
 
z⁄eID
)

1422 i‡(
£quí˚Numbî
 == 0) {

1426 
BlockCou¡
 
blockNumbî


1427 
	`gëRecovîyJou∫ÆBlockNumbî
(
jou∫Æ
, 
£quí˚Numbî
);

1428 
	`ªÀa£LockCou¡Re„ªn˚
(
jou∫Æ
->
lockCou¡î
, 
blockNumbî
, 
z⁄eTy≥
,

1429 
z⁄eID
);

1430 
	}
}

1433 
	$ªÀa£PîE¡ryLockFromOthîZ⁄e
(
RecovîyJou∫Æ
 *
jou∫Æ
,

1434 
Sequí˚Numbî
 
£quí˚Numbî
)

1436 i‡(
£quí˚Numbî
 == 0) {

1440 
BlockCou¡
 
blockNumbî


1441 
	`gëRecovîyJou∫ÆBlockNumbî
(
jou∫Æ
, 
£quí˚Numbî
);

1442 
	`ªÀa£Jou∫ÆZ⁄eRe„ªn˚FromOthîZ⁄e
(
jou∫Æ
->
lockCou¡î
, 
blockNumbî
);

1443 
	}
}

1446 
	$˛o£RecovîyJou∫Æ
(
RecovîyJou∫Æ
 *
jou∫Æ
, 
VDOCom∂ëi⁄
 *
∑ª¡
)

1450 
	`as£πOnJou∫ÆThªad
(
jou∫Æ
, 
__func__
);

1451 
	`¥ï¨eToFöishP¨ít
(&
jou∫Æ
->
com∂ëi⁄
, 
∑ª¡
);

1452 
jou∫Æ
->
˛o£Reque°ed
 = 
åue
;

1453 
	`checkF‹Closuª
(
jou∫Æ
);

1454 
	}
}

1457 
BlockCou¡
 
	$gëJou∫ÆLogiˇlBlocksU£d
(c⁄° 
RecovîyJou∫Æ
 *
jou∫Æ
)

1459  
jou∫Æ
->
logiˇlBlocksU£d
;

1460 
	}
}

1463 
RecovîyJou∫ÆSèti°ics


1464 
	$gëRecovîyJou∫ÆSèti°ics
(c⁄° 
RecovîyJou∫Æ
 *
jou∫Æ
)

1466  
jou∫Æ
->
evíts
;

1467 
	}
}

1470 
	$dumpRecovîyJou∫ÆSèti°ics
(c⁄° 
RecovîyJou∫Æ
 *
jou∫Æ
)

1472 
RecovîyJou∫ÆSèti°ics
 
°©s
 = 
	`gëRecovîyJou∫ÆSèti°ics
(
jou∫Æ
);

1473 
	`logInfo
("Recovery Journal");

1474 
	`logInfo
(" blockM≠Hód=%" 
PRIu64
 " slabJournalHead=%" PRIu64

1475 "Üa°WrôeAcknowÀdged=%" 
PRIu64
 "Åail=%" PRIu64

1476 " blockM≠RópHód=%" 
PRIu64
 " slabJournalReapHead=%" PRIu64

1477 " diskFuŒ=%" 
PRIu64
 " slabJournalCommitsRequested=%" PRIu64

1479 
jou∫Æ
->
blockM≠Hód
, jou∫Æ->
¶abJou∫ÆHód
,

1480 
jou∫Æ
->
œ°WrôeAcknowÀdged
, jou∫Æ->
èû
,

1481 
jou∫Æ
->
blockM≠RópHód
, jou∫Æ->
¶abJou∫ÆRópHód
,

1482 
°©s
.
diskFuŒ
, sèts.
¶abJou∫ÆCommôsReque°ed
,

1483 
	`cou¡Waôîs
(&
jou∫Æ
->
ö¸emítWaôîs
),

1484 
	`cou¡Waôîs
(&
jou∫Æ
->
de¸emítWaôîs
));

1485 
	`logInfo
("É¡rõs: sèπed=%" 
PRIu64
 " written=%" PRIu64 " committed=%"

1486 
PRIu64
,

1487 
°©s
.
íåõs
.
°¨ãd
, sèts.íåõs.
wrôãn
,

1488 
°©s
.
íåõs
.
commôãd
);

1489 
	`logInfo
(" blocks: sèπed=%" 
PRIu64
 " written=%" PRIu64 " committed=%"

1490 
PRIu64
,

1491 
°©s
.
blocks
.
°¨ãd
, sèts.blocks.
wrôãn
,

1492 
°©s
.
blocks
.
commôãd
);

1494 
	`logInfo
("áctive blocks:");

1495 c⁄° 
RögNode
 *
hód
 = &
jou∫Æ
->
a˘iveTaûBlocks
;

1496 
RögNode
 *
node
 = 
hód
->
√xt
;Çode != head;Çode =Çode->next) {

1497 
RecovîyJou∫ÆBlock
 *
block
 = 
	`blockFromRögNode
(
node
);

1498 
	`logInfo
(" sequí˚Çumbî %" 
PRIu64
 "; commôãdÉ¡ry cou¡ %" 
PRIu16


1500 
block
->
hódî
->
£quí˚Numbî
, block->hódî->
íåyCou¡
,

1501 (
block
->
commôtög
 ? "committing" : "waiting"),

1502 
	`cou¡Waôîs
(&
block
->
íåyWaôîs
),

1503 
	`cou¡Waôîs
(&
block
->
commôWaôîs
));

1505 
	}
}

	@vdo/base/recoveryJournal.h

22 #i‚de‡
RECOVERY_JOURNAL_H


23 
	#RECOVERY_JOURNAL_H


	)

25 
	~"buf„r.h
"

26 
	~"com∂ëi⁄.h
"

27 
	~"fixedLayout.h
"

28 
	~"Êush.h
"

29 
	~"ªadO∆yModeC⁄ãxt.h
"

30 
	~"°©i°ics.h
"

31 
	~"åa˚.h
"

32 
	~"ty≥s.h
"

123 
ölöe
 
boﬁ
 
	$isIn¸emítO≥øti⁄
(
Jou∫ÆO≥øti⁄
 
›î©i⁄
)

125  ((
›î©i⁄
 =
DATA_INCREMENT
Ë|| (›î©i⁄ =
BLOCK_MAP_INCREMENT
));

126 
	}
}

135 c⁄° *
	$gëJou∫ÆO≥øti⁄Name
(
Jou∫ÆO≥øti⁄
 
›î©i⁄
)

136 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

143 
	`nŸifyRecovîyJou∫ÆOfRódO∆yMode
(
RecovîyJou∫Æ
 *
jou∫Æ
);

160 
	$makeRecovîyJou∫Æ
(
N⁄˚
 
n⁄˚
,

161 
PhysiˇlLayî
 *
œyî
,

162 
P¨tôi⁄
 *
∑πôi⁄
,

163 
uöt64_t
 
ªcovîyCou¡
,

164 
BlockCou¡
 
jou∫ÆSize
,

165 
BlockCou¡
 
èûBuf„rSize
,

166 
RódO∆yModeC⁄ãxt
 *
ªadO∆yC⁄ãxt
,

167 c⁄° 
ThªadC⁄fig
 *
thªadC⁄fig
,

168 
RecovîyJou∫Æ
 **
jou∫ÆPå
)

169 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

176 
	`‰ìRecovîyJou∫Æ
(
RecovîyJou∫Æ
 **
jou∫ÆPå
);

185 
	`£tRecovîyJou∫ÆP¨tôi⁄
(
RecovîyJou∫Æ
 *
jou∫Æ
,

186 
P¨tôi⁄
 *
∑πôi⁄
);

195 
	`öôülizeRecovîyJou∫ÆPo°Recovîy
(
RecovîyJou∫Æ
 *
jou∫Æ
,

196 
uöt64_t
 
ªcovîyCou¡
,

197 
Sequí˚Numbî
 
èû
);

208 
	`öôülizeRecovîyJou∫ÆPo°Rebuûd
(
RecovîyJou∫Æ
 *
jou∫Æ
,

209 
uöt64_t
 
ªcovîyCou¡
,

210 
Sequí˚Numbî
 
èû
,

211 
BlockCou¡
 
logiˇlBlocksU£d
,

212 
BlockCou¡
 
blockM≠D©aBlocks
);

222 
BlockCou¡
 
	$gëJou∫ÆBlockM≠D©aBlocksU£d
(
RecovîyJou∫Æ
 *
jou∫Æ
)

223 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

232 
	`£tJou∫ÆBlockM≠D©aBlocksU£d
(
RecovîyJou∫Æ
 *
jou∫Æ
,

233 
BlockCou¡
 
∑ges
);

242 
	`›íRecovîyJou∫Æ
(
RecovîyJou∫Æ
 *
jou∫Æ
,

243 
SœbDïŸ
 *
dïŸ
,

244 
BlockM≠
 *
blockM≠
);

254 
Sequí˚Numbî
 
	`gëCuºítJou∫ÆSequí˚Numbî
(
RecovîyJou∫Æ
 *
jou∫Æ
);

263 
BlockCou¡
 
	$gëRecovîyJou∫ÆLígth
(
BlockCou¡
 
jou∫ÆSize
)

264 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

271 
size_t
 
	$gëRecovîyJou∫ÆEncodedSize
()

272 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

282 
	$ícodeRecovîyJou∫Æ
(
RecovîyJou∫Æ
 *
jou∫Æ
, 
Buf„r
 *
buf„r
)

283 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

293 
	$decodeRecovîyJou∫Æ
(
RecovîyJou∫Æ
 *
jou∫Æ
, 
Buf„r
 *
buf„r
)

294 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

304 
	$decodeSodiumRecovîyJou∫Æ
(
RecovîyJou∫Æ
 *
jou∫Æ
, 
Buf„r
 *
buf„r
)

305 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

318 
	`addRecovîyJou∫ÆE¡ry
(
RecovîyJou∫Æ
 *
jou∫Æ
, 
D©aVIO
 *
d©aVIO
);

329 
	`acquúeRecovîyJou∫ÆBlockRe„ªn˚
(
RecovîyJou∫Æ
 *
jou∫Æ
,

330 
Sequí˚Numbî
 
£quí˚Numbî
,

331 
Z⁄eTy≥
 
z⁄eTy≥
,

332 
Z⁄eCou¡
 
z⁄eID
);

345 
	`ªÀa£RecovîyJou∫ÆBlockRe„ªn˚
(
RecovîyJou∫Æ
 *
jou∫Æ
,

346 
Sequí˚Numbî
 
£quí˚Numbî
,

347 
Z⁄eTy≥
 
z⁄eTy≥
,

348 
Z⁄eCou¡
 
z⁄eID
);

358 
	`ªÀa£PîE¡ryLockFromOthîZ⁄e
(
RecovîyJou∫Æ
 *
jou∫Æ
,

359 
Sequí˚Numbî
 
£quí˚Numbî
);

368 
	`˛o£RecovîyJou∫Æ
(
RecovîyJou∫Æ
 *
jou∫Æ
, 
VDOCom∂ëi⁄
 *
∑ª¡
);

377 
BlockCou¡
 
	$gëJou∫ÆLogiˇlBlocksU£d
(c⁄° 
RecovîyJou∫Æ
 *
jou∫Æ
)

378 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

387 
RecovîyJou∫ÆSèti°ics


388 
	$gëRecovîyJou∫ÆSèti°ics
(c⁄° 
RecovîyJou∫Æ
 *
jou∫Æ
)

389 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

397 
	`dumpRecovîyJou∫ÆSèti°ics
(c⁄° 
RecovîyJou∫Æ
 *
jou∫Æ
);

	@vdo/base/recoveryJournalInternals.h

22 #i‚de‡
RECOVERY_JOURNAL_INTERNALS_H


23 
	#RECOVERY_JOURNAL_INTERNALS_H


	)

25 
	~"blockM≠E¡ry.h
"

26 
	~"blockM≠pögSèã.h
"

27 
	~"jou∫ÆPoöt.h
"

28 
	~"lockCou¡î.h
"

29 
	~"ªadO∆yModeC⁄ãxt.h
"

30 
	~"ªcovîyJou∫Æ.h
"

31 
	~"rögNode.h
"

32 
	~"°©i°ics.h
"

33 
	~"waôQueue.h
"

38 
	mRECOVERY_JOURNAL_ENTRIES_PER_BLOCK
 = 311,

42 
	m›î©i⁄
 : 2;

43 
	m¶Ÿ
 : 10;

44 
	mpbnHighW‹d
 : 4;

45 
uöt32_t
 
	mpbnLowW‹d
;

46 
BlockM≠E¡ry
 
	mblockM≠E¡ry
;

47 } 
	t__©åibuã__
((
	t∑cked
)Ë
	tRecovîyJou∫ÆE¡ry
;

50 
Sequí˚Numbî
 
	mblockM≠Hód
;

51 
Sequí˚Numbî
 
	m¶abJou∫ÆHód
;

52 
Sequí˚Numbî
 
	m£quí˚Numbî
;

53 
N⁄˚
 
	mn⁄˚
;

54 
VDOMëad©aTy≥
 
	mmëad©aTy≥
;

55 
Jou∫ÆE¡ryCou¡
 
	míåyCou¡
;

56 
BlockCou¡
 
	mlogiˇlBlocksU£d
;

57 
BlockCou¡
 
	mblockM≠D©aBlocks
;

58 
uöt8_t
 
	mcheckByã
;

59 
uöt8_t
 
	mªcovîyCou¡
;

60 } 
	t__©åibuã__
((
	t∑cked
)Ë
	tPackedJou∫ÆHódî
;

63 
uöt8_t
 
	mcheckByã
;

64 
uöt8_t
 
	mªcovîyCou¡
;

65 
uöt8_t
 
	míåyCou¡
;

66 
RecovîyJou∫ÆE¡ry
 
	míåõs
[];

67 } 
	t__©åibuã__
((
	t∑cked
)Ë
	tPackedJou∫ÆSe˘‹
;

71 
RögNode
 
	mrögNode
;

73 
RecovîyJou∫Æ
 *
	mjou∫Æ
;

75 *
	mblock
;

77 
PackedJou∫ÆHódî
 *
	mhódî
;

79 
PackedJou∫ÆSe˘‹
 *
	m£˘‹
;

81 
VIO
 *
	mvio
;

83 
PhysiˇlBlockNumbî
 
	mblockNumbî
;

85 
boﬁ
 
	mcommôtög
;

87 
boﬁ
 
	mÊushBef‹eWrôe
;

89 
Jou∫ÆE¡ryCou¡
 
	míåyCou¡
;

91 
Jou∫ÆE¡ryCou¡
 
	míåõsInCommô
;

93 
WaôQueue
 
	míåyWaôîs
;

95 
WaôQueue
 
	mcommôWaôîs
;

96 } 
	tRecovîyJou∫ÆBlock
;

98 
	sªcovîyJou∫Æ
 {

100 
VDOCom∂ëi⁄
 
	mcom∂ëi⁄
;

102 
ThªadID
 
	mthªadID
;

104 
SœbDïŸ
 *
	mdïŸ
;

106 
BlockM≠
 *
	mblockM≠
;

108 
WaôQueue
 
	mö¸emítWaôîs
;

110 
WaôQueue
 
	mde¸emítWaôîs
;

112 
uöt64_t
 
	mavaûabÀS∑˚
;

114 
VIOCou¡
 
	m≥ndögDe¸emítCou¡
;

119 
boﬁ
 
	maddögE¡rõs
;

121 
RódO∆yModeC⁄ãxt
 *
	mªadO∆yC⁄ãxt
;

123 
boﬁ
 
	m˛o£Reque°ed
;

125 
boﬁ
 
	mª≠ög
;

127 
P¨tôi⁄
 *
	m∑πôi⁄
;

129 
Sequí˚Numbî
 
	mblockM≠Hód
;

131 
Sequí˚Numbî
 
	m¶abJou∫ÆHód
;

133 
Sequí˚Numbî
 
	mœ°WrôeAcknowÀdged
;

135 
Sequí˚Numbî
 
	mèû
;

137 
Jou∫ÆPoöt
 
	m≠≥ndPoöt
;

139 
Jou∫ÆPoöt
 
	mcommôPoöt
;

141 
N⁄˚
 
	mn⁄˚
;

143 
uöt8_t
 
	mªcovîyCou¡
;

145 
Jou∫ÆE¡ryCou¡
 
	míåõsPîBlock
;

147 
Jou∫ÆE¡ryCou¡
 
	míåõsPîSe˘‹
;

149 
Jou∫ÆE¡ryCou¡
 
	mœ°Se˘‹E¡rõs
;

151 
RögNode
 
	m‰ìTaûBlocks
;

153 
RögNode
 
	ma˘iveTaûBlocks
;

155 
RecovîyJou∫ÆBlock
 *
	ma˘iveBlock
;

157 
Sequí˚Numbî
 
	mblockM≠RópHód
;

159 
BlockCou¡
 
	mblockM≠HódBlockNumbî
;

161 
Sequí˚Numbî
 
	m¶abJou∫ÆRópHód
;

163 
BlockCou¡
 
	m¶abJou∫ÆHódBlockNumbî
;

165 
VIO
 *
	mÊushVIO
;

167 *
	munu£dFlushVIOD©a
;

169 
BlockCou¡
 
	msize
;

171 
BlockCou¡
 
	mlogiˇlBlocksU£d
;

173 
BlockCou¡
 
	mblockM≠D©aBlocks
;

175 
BlockCou¡
 
	m≥ndögWrôeCou¡
;

177 
BlockCou¡
 
	m¶abJou∫ÆCommôThªshﬁd
;

179 
RecovîyJou∫ÆSèti°ics
 
	mevíts
;

181 
LockCou¡î
 *
	mlockCou¡î
;

191 
ölöe


192 
	$ícodeO≥øti⁄AndBlockM≠SlŸ
(
RecovîyJou∫ÆE¡ry
 *
íåy
,

193 
Jou∫ÆO≥øti⁄
 
›î©i⁄
,

194 
BlockM≠SlŸ
 
¶Ÿ
)

196 
íåy
->
›î©i⁄
 = operation;

197 
íåy
->
¶Ÿ
 = slot.slot;

198 
íåy
->
pbnHighW‹d
 = (
¶Ÿ
.
pbn
 >> 32) & 0xF;

199 
íåy
->
pbnLowW‹d
 = 
¶Ÿ
.
pbn
 & 0xFFFFFFFF;

200 
	}
}

209 
ölöe


210 
	$decodeO≥øti⁄AndBlockM≠SlŸ
(c⁄° 
RecovîyJou∫ÆE¡ry
 *
íåy
,

211 
Jou∫ÆO≥øti⁄
 *
›î©i⁄
,

212 
BlockM≠SlŸ
 *
¶Ÿ
)

214 
¶Ÿ
->
pbn


215 ((
PhysiˇlBlockNumbî
Ë
íåy
->
pbnHighW‹d
 << 32Ë|É¡ry->
pbnLowW‹d
;

216 
¶Ÿ
->¶Ÿ = 
íåy
->slot;

217 (*
›î©i⁄
Ë
íåy
->operation;

218 
	}
}

231 
	$decodeRecovîyJou∫ÆE¡ry
(
VDO
 *
vdo
,

232 
RecovîyJou∫ÆE¡ry
 *
íåy
,

233 
Jou∫ÆO≥øti⁄
 *
›î©i⁄
,

234 
BlockM≠SlŸ
 *
¶Ÿ
,

235 
PhysiˇlBlockNumbî
 *
pbn
)

236 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

246 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
))

247 
ölöe


248 
PhysiˇlBlockNumbî
 
	$gëRecovîyJou∫ÆBlockNumbî
(
RecovîyJou∫Æ
 *
jou∫Æ
,

249 
Sequí˚Numbî
 
£quí˚
)

253  (
£quí˚
 & (
jou∫Æ
->
size
 - 1));

254 
	}
}

264 
__©åibuã__
((
w¨n_unu£d_ªsu…
))

265 
ölöe
 
uöt8_t
 
	$compuãRecovîyCheckByã
(
RecovîyJou∫Æ
 *
jou∫Æ
,

266 
Sequí˚Numbî
 
£quí˚
)

269  (((
£quí˚
 / 
jou∫Æ
->
size
) & 0x7F) | 0x80);

270 
	}
}

	@vdo/base/recoveryUtils.c

22 
	~"ªcovîyUtûs.h
"

24 
	~"mem‹yAŒoc.h
"

26 
	~"com∂ëi⁄.h
"

27 
	~"exã¡.h
"

28 
	~"ªcovîyJou∫ÆI¡î«ls.h
"

36 
	$föishJou∫ÆLﬂd
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

38 
ªsu…
 = 
com∂ëi⁄
->result;

39 
VDOCom∂ëi⁄
 *
∑ª¡
 = 
com∂ëi⁄
->parent;

40 
VDOExã¡
 *
exã¡
 = 
	`asVDOExã¡
(
com∂ëi⁄
);

41 
	`‰ìExã¡
(&
exã¡
);

42 
	`föishCom∂ëi⁄
(
∑ª¡
, 
ªsu…
);

43 
	}
}

46 
	$lﬂdJou∫ÆAsync
(
RecovîyJou∫Æ
 *
jou∫Æ
,

47 
VDOCom∂ëi⁄
 *
∑ª¡
,

48 **
jou∫ÆD©aPå
)

50 
ªsu…
 = 
	`ALLOCATE
(
jou∫Æ
->
size
 * 
VDO_BLOCK_SIZE
, , 
__func__
,

51 
jou∫ÆD©aPå
);

52 i‡(
ªsu…
 !
VDO_SUCCESS
) {

53 
	`föishCom∂ëi⁄
(
∑ª¡
, 
ªsu…
);

57 
VDOExã¡
 *
exã¡
;

58 
ªsu…
 = 
	`¸óãExã¡
(
∑ª¡
->
œyî
, 
VIO_TYPE_RECOVERY_JOURNAL
,

59 
VIO_PRIORITY_METADATA
, 
jou∫Æ
->
size
,

60 *
jou∫ÆD©aPå
, &
exã¡
);

61 i‡(
ªsu…
 !
VDO_SUCCESS
) {

62 
	`föishCom∂ëi⁄
(
∑ª¡
, 
ªsu…
);

66 
	`¥ï¨eCom∂ëi⁄
(&
exã¡
->
com∂ëi⁄
, 
föishJou∫ÆLﬂd
, finishJournalLoad,

67 
∑ª¡
->
ˇŒbackThªadID
,Öarent);

68 
	`ªadMëad©aExã¡
(
exã¡
,

69 
	`gëFixedLayoutP¨tôi⁄Off£t
(
jou∫Æ
->
∑πôi⁄
));

70 
	}
}

73 
boﬁ
 
	$födHódAndTaû
(
RecovîyJou∫Æ
 *
jou∫Æ
,

74 *
jou∫ÆD©a
,

75 
Sequí˚Numbî
 *
èûPå
,

76 
Sequí˚Numbî
 *
blockM≠HódPå
,

77 
Sequí˚Numbî
 *
¶abJou∫ÆHódPå
)

79 
Sequí˚Numbî
 
highe°Taû
 = 
jou∫Æ
->
èû
;

80 
Sequí˚Numbî
 
blockM≠HódMax
 = 0;

81 
Sequí˚Numbî
 
¶abJou∫ÆHódMax
 = 0;

82 
boﬁ
 
foundE¡rõs
 = 
Ál£
;

83 
PhysiˇlBlockNumbî
 
i
 = 0; i < 
jou∫Æ
->
size
; i++) {

84 
PackedJou∫ÆHódî
 *
hódî


85 
	`gëJou∫ÆBlockHódî
(
jou∫Æ
, 
jou∫ÆD©a
, 
i
);

86 i‡(!
	`isC⁄gruítRecovîyJou∫ÆBlock
(
jou∫Æ
, 
hódî
, 
i
)) {

91 i‡(
hódî
->
£quí˚Numbî
 >
highe°Taû
) {

92 
foundE¡rõs
 = 
åue
;

93 
highe°Taû
 = 
hódî
->
£quí˚Numbî
;

95 i‡(
hódî
->
blockM≠Hód
 > 
blockM≠HódMax
) {

96 
blockM≠HódMax
 = 
hódî
->
blockM≠Hód
;

98 i‡(
hódî
->
¶abJou∫ÆHód
 > 
¶abJou∫ÆHódMax
) {

99 
¶abJou∫ÆHódMax
 = 
hódî
->
¶abJou∫ÆHód
;

103 *
èûPå
 = 
highe°Taû
;

104 i‡(!
foundE¡rõs
) {

105  
Ál£
;

108 *
blockM≠HódPå
 = 
blockM≠HódMax
;

109 i‡(
¶abJou∫ÆHódPå
 !
NULL
) {

110 *
¶abJou∫ÆHódPå
 = 
¶abJou∫ÆHódMax
;

112  
åue
;

113 
	}
}

	@vdo/base/recoveryUtils.h

22 #i‚de‡
RECOVERY_UTILS_H


23 
	#RECOVERY_UTILS_H


	)

25 
	~"ªcovîyJou∫ÆI¡î«ls.h
"

26 
	~"ty≥s.h
"

37 
__©åibuã__
((
w¨n_unu£d_ªsu…
))

38 
ölöe


39 
PackedJou∫ÆHódî
 *
	$gëJou∫ÆBlockHódî
(
RecovîyJou∫Æ
 *
jou∫Æ
,

40 *
jou∫ÆD©a
,

41 
Sequí˚Numbî
 
£quí˚
)

43 
off_t
 
blockOff£t
 = (
	`gëRecovîyJou∫ÆBlockNumbî
(
jou∫Æ
, 
£quí˚
)

44 * 
VDO_BLOCK_SIZE
);

45  (
PackedJou∫ÆHódî
 *Ë&
jou∫ÆD©a
[
blockOff£t
];

46 
	}
}

56 
__©åibuã__
((
w¨n_unu£d_ªsu…
))

57 
ölöe


58 
PackedJou∫ÆSe˘‹
 *
	$gëJou∫ÆBlockSe˘‹
(
PackedJou∫ÆHódî
 *
hódî
,

59 
£˘‹Numbî
)

61 *
£˘‹D©a
 = ((*Ë
hódî
Ë+ (
VDO_SECTOR_SIZE
 * 
£˘‹Numbî
);

62  ((
PackedJou∫ÆSe˘‹
 *Ë
£˘‹D©a
);

63 
	}
}

75 
__©åibuã__
((
w¨n_unu£d_ªsu…
))

76 
ölöe
 
boﬁ
 
	$isVÆidRecovîyJou∫ÆBlock
(
RecovîyJou∫Æ
 *
jou∫Æ
,

77 
PackedJou∫ÆHódî
 *
hódî
)

79  ((
hódî
->
mëad©aTy≥
 =
VDO_METADATA_RECOVERY_JOURNAL
)

80 && (
hódî
->
n⁄˚
 =
jou∫Æ
->nonce)

81 && (
hódî
->
ªcovîyCou¡
 =
jou∫Æ
->recoveryCount));

82 
	}
}

94 
__©åibuã__
((
w¨n_unu£d_ªsu…
))

95 
ölöe


96 
boﬁ
 
	$isC⁄gruítRecovîyJou∫ÆBlock
(
RecovîyJou∫Æ
 *
jou∫Æ
,

97 
PackedJou∫ÆHódî
 *
hódî
,

98 
PhysiˇlBlockNumbî
 
off£t
)

100 
PhysiˇlBlockNumbî
 
ex≥˘edOff£t


101 
	`gëRecovîyJou∫ÆBlockNumbî
(
jou∫Æ
, 
hódî
->
£quí˚Numbî
);

102  ((
ex≥˘edOff£t
 =
off£t
)

103 && 
	`isVÆidRecovîyJou∫ÆBlock
(
jou∫Æ
, 
hódî
));

104 
	}
}

115 
__©åibuã__
((
w¨n_unu£d_ªsu…
))

116 
ölöe
 
boﬁ
 
	$isExa˘RecovîyJou∫ÆBlock
(
RecovîyJou∫Æ
 *
jou∫Æ
,

117 
PackedJou∫ÆHódî
 *
hódî
,

118 
Sequí˚Numbî
 
£quí˚
)

120  ((
hódî
->
£quí˚Numbî
 =
£quí˚
)

121 && 
	`isVÆidRecovîyJou∫ÆBlock
(
jou∫Æ
, 
hódî
));

122 
	}
}

133 
__©åibuã__
((
w¨n_unu£d_ªsu…
))

134 
ölöe
 
boﬁ
 
	$isVÆidRecovîyJou∫ÆSe˘‹
(
PackedJou∫ÆHódî
 *
hódî
,

135 
PackedJou∫ÆSe˘‹
 *
£˘‹
)

137  ((
hódî
->
checkByã
 =
£˘‹
->checkByte)

138 && (
hódî
->
ªcovîyCou¡
 =
£˘‹
->recoveryCount));

139 
	}
}

150 
lﬂdJou∫ÆAsync
(
RecovîyJou∫Æ
 *
jou∫Æ
,

151 
VDOCom∂ëi⁄
 *
∑ª¡
,

152 **
jou∫ÆD©aPå
);

170 
boﬁ
 
födHódAndTaû
(
RecovîyJou∫Æ
 *
jou∫Æ
,

171 *
jou∫ÆD©a
,

172 
Sequí˚Numbî
 *
èûPå
,

173 
Sequí˚Numbî
 *
blockM≠HódPå
,

174 
Sequí˚Numbî
 *
¶abJou∫ÆHódPå
);

	@vdo/base/refCounts.c

22 
	~"ªfCou¡s.h
"

23 
	~"ªfCou¡sI¡î«ls.h
"

25 
	~"loggî.h
"

26 
	~"mem‹yAŒoc.h
"

27 
	~"≥rmas£π.h
"

29 
	~"blockAŒoˇt‹I¡î«ls.h
"

30 
	~"com∂ëi⁄.h
"

31 
	~"exã¡.h
"

32 
	~"hódî.h
"

33 
	~"jou∫ÆPoöt.h
"

34 
	~"numUtûs.h
"

35 
	~"pbnLock.h
"

36 
	~"ªadO∆yModeC⁄ãxt.h
"

37 
	~"ª„ªn˚Block.h
"

38 
	~"ª„ªn˚O≥øti⁄.h
"

39 
	~"¶ab.h
"

40 
	~"¶abJou∫Æ.h
"

41 
	~"¶abJou∫ÆI¡î«ls.h
"

42 
	~"¶abSumm¨y.h
"

43 
	~"°©usCodes.h
"

44 
	~"°rögUtûs.h
"

45 
	~"vdo.h
"

46 
	~"vioPoﬁ.h
"

47 
	~"waôQueue.h
"

49 c⁄° 
uöt64_t
 
	gBYTES_PER_WORD
 = (uint64_t);

50 c⁄° 
boﬁ
 
	gNORMAL_OPERATION
 = 
åue
;

59 
__©åibuã__
((
w¨n_unu£d_ªsu…
))

60 
ölöe
 
RefCou¡s
 *
	$ªfCou¡sFromWaôî
(
Waôî
 *
waôî
)

62 i‡(
waôî
 =
NULL
) {

63  
NULL
;

65  (
RefCou¡s
 *)

66 ((
uöçå_t
Ë
waôî
 - 
	`off£tof
(
RefCou¡s
, 
¶abSumm¨yWaôî
));

67 
	}
}

79 
PhysiˇlBlockNumbî
 
	$ödexToPBN
(c⁄° 
RefCou¡s
 *
ªfCou¡s
,

80 
uöt64_t
 
ödex
)

82  (
ªfCou¡s
->
¶ab
->
°¨t
 + 
ödex
);

83 
	}
}

95 
uöt64_t
 
	$pbnToIndex
(c⁄° 
RefCou¡s
 *
ªfCou¡s
, 
PhysiˇlBlockNumbî
 
pbn
)

97 i‡(
pbn
 < 
ªfCou¡s
->
¶ab
->
°¨t
) {

100 
uöt64_t
 
ödex
 = (
pbn
 - 
ªfCou¡s
->
¶ab
->
°¨t
);

101  
	`möBlock
(
ödex
, 
ªfCou¡s
->
blockCou¡
);

102 
	}
}

105 
Re„ªn˚Sètus
 
	$ª„ªn˚Cou¡ToSètus
(
Re„ªn˚Cou¡
 
cou¡
)

107 i‡(
cou¡
 =
EMPTY_REFERENCE_COUNT
) {

108  
RS_FREE
;

109 } i‡(
cou¡
 == 1) {

110  
RS_SINGLE
;

111 } i‡(
cou¡
 =
PROVISIONAL_REFERENCE_COUNT
) {

112  
RS_PROVISIONAL
;

114  
RS_SHARED
;

116 
	}
}

124 
	$ª£tSórchCurs‹
(
RefCou¡s
 *
ªfCou¡s
)

126 
SórchCurs‹
 *
curs‹
 = &
ªfCou¡s
->
£¨chCurs‹
;

128 
curs‹
->
block
 = curs‹->
fú°Block
;

129 
curs‹
->
ödex
 = 0;

131 
curs‹
->
ídIndex
 = 
	`möBlock
(
COUNTS_PER_BLOCK
, 
ªfCou¡s
->
blockCou¡
);

132 
	}
}

143 
boﬁ
 
	$adv™˚SórchCurs‹
(
RefCou¡s
 *
ªfCou¡s
)

145 
SórchCurs‹
 *
curs‹
 = &
ªfCou¡s
->
£¨chCurs‹
;

149 i‡(
curs‹
->
block
 =curs‹->
œ°Block
) {

150 
	`ª£tSórchCurs‹
(
ªfCou¡s
);

151  
Ál£
;

155 
curs‹
->
block
++;

156 
curs‹
->
ödex
 = curs‹->
ídIndex
;

158 i‡(
curs‹
->
block
 =curs‹->
œ°Block
) {

160 
curs‹
->
ídIndex
 = 
ªfCou¡s
->
blockCou¡
;

162 
curs‹
->
ídIndex
 +
COUNTS_PER_BLOCK
;

164  
åue
;

165 
	}
}

168 
	$makeRefCou¡s
(
PhysiˇlLayî
 *
œyî
,

169 
BlockCou¡
 
blockCou¡
,

170 
Sœb
 *
¶ab
,

171 
PhysiˇlBlockNumbî
 
‹igö
,

172 
RódO∆yModeC⁄ãxt
 *
ªadO∆yC⁄ãxt
,

173 
RefCou¡s
 **
ªfCou¡sPå
)

175 
BlockCou¡
 
ªfBlockCou¡
 = 
	`gëSavedRe„ªn˚Cou¡Size
(
blockCou¡
);

176 
RefCou¡s
 *
ªfCou¡s
;

177 
ªsu…
 = 
	`ALLOCATE_EXTENDED
(
RefCou¡s
, 
ªfBlockCou¡
, 
Re„ªn˚Block
,

178 "ª‡cou¡†°ru˘uª", &
ªfCou¡s
);

179 i‡(
ªsu…
 !
UDS_SUCCESS
) {

180  
ªsu…
;

185 
size_t
 
byãs
 = ((
ªfBlockCou¡
 * 
COUNTS_PER_BLOCK
Ë+ (2 * 
BYTES_PER_WORD
));

186 
ªsu…
 = 
	`ALLOCATE
(
byãs
, 
Re„ªn˚Cou¡
, "ref countsárray",

187 &
ªfCou¡s
->
cou¡îs
);

188 i‡(
ªsu…
 !
UDS_SUCCESS
) {

189 
	`‰ìRefCou¡s
(&
ªfCou¡s
);

190  
ªsu…
;

193 
ªsu…
 = 
	`öôülizeEnqueuóbÀCom∂ëi⁄
(&
ªfCou¡s
->
com∂ëi⁄
,

194 
REFERENCE_COUNTS_COMPLETION
, 
œyî
);

195 i‡(
ªsu…
 !
VDO_SUCCESS
) {

196 
	`‰ìRefCou¡s
(&
ªfCou¡s
);

197  
ªsu…
;

200 
ªfCou¡s
->
¶ab
 = slab;

201 
ªfCou¡s
->
blockCou¡
 = blockCount;

202 
ªfCou¡s
->
‰ìBlocks
 = 
blockCou¡
;

203 
ªfCou¡s
->
‹igö
 = origin;

204 
ªfCou¡s
->
ª„ªn˚BlockCou¡
 = 
ªfBlockCou¡
;

205 
ªfCou¡s
->
ªadO∆yC⁄ãxt
 =ÑeadOnlyContext;

206 
ªfCou¡s
->
°©i°ics
 = &
¶ab
->
Æloˇt‹
->
ªfCou¡Sèti°ics
;

207 
ªfCou¡s
->
£¨chCurs‹
.
fú°Block
 = &ªfCou¡s->
blocks
[0];

208 
ªfCou¡s
->
£¨chCurs‹
.
œ°Block
 = &ªfCou¡s->
blocks
[
ªfBlockCou¡
 - 1];

209 
	`ª£tSórchCurs‹
(
ªfCou¡s
);

211 
size_t
 
ödex
 = 0; index < 
ªfBlockCou¡
; index++) {

212 
ªfCou¡s
->
blocks
[
ödex
] = (
Re„ªn˚Block
) {

213 .
ªfCou¡s
 =ÑefCounts,

217 *
ªfCou¡sPå
 = 
ªfCou¡s
;

218  
VDO_SUCCESS
;

219 
	}
}

222 
	$‰ìRefCou¡s
(
RefCou¡s
 **
ªfCou¡sPå
)

224 
RefCou¡s
 *
ªfCou¡s
 = *
ªfCou¡sPå
;

225 i‡(
ªfCou¡s
 =
NULL
) {

229 
	`de°royEnqueuóbÀ
(&
ªfCou¡s
->
com∂ëi⁄
);

230 
	`FREE
(
ªfCou¡s
->
cou¡îs
);

231 
	`FREE
(
ªfCou¡s
);

232 *
ªfCou¡sPå
 = 
NULL
;

233 
	}
}

236 
RefCou¡s
 *
	$asRefCou¡s
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

238 
	`STATIC_ASSERT
(
	`off£tof
(
RefCou¡s
, 
com∂ëi⁄
) == 0);

239 
	`as£πCom∂ëi⁄Ty≥
(
com∂ëi⁄
->
ty≥
, 
REFERENCE_COUNTS_COMPLETION
);

240  (
RefCou¡s
 *Ë
com∂ëi⁄
;

241 
	}
}

251 
__©åibuã__
((
w¨n_unu£d_ªsu…
))

252 
	$dútyBlock
(
Re„ªn˚Block
 *
block
)

254 i‡(
block
->
isDúty
) {

255  
VDO_SUCCESS
;

258 
block
->
isDúty
 = 
åue
;

259 i‡(
block
->
isWrôög
) {

261  
VDO_SUCCESS
;

264  
	`íqueueWaôî
(&
block
->
ªfCou¡s
->
dútyBlocks
, &block->
waôî
);

265 
	}
}

268 
BlockCou¡
 
	$gëUƒe„ªn˚dBlockCou¡
(
RefCou¡s
 *
ªfCou¡s
)

270  
ªfCou¡s
->
‰ìBlocks
;

271 
	}
}

274 
Re„ªn˚Block
 *
	$gëRe„ªn˚Block
(
RefCou¡s
 *
ªfCou¡s
, 
SœbBlockNumbî
 
ödex
)

276  &
ªfCou¡s
->
blocks
[
ödex
 / 
COUNTS_PER_BLOCK
];

277 
	}
}

287 
	$gëRe„ªn˚Cou¡î
(
RefCou¡s
 *
ªfCou¡s
,

288 
PhysiˇlBlockNumbî
 
pbn
,

289 
Re„ªn˚Cou¡
 **
cou¡îPå
)

291 
SœbBlockNumbî
 
ödex
;

292 
ªsu…
 = 
	`¶abBlockNumbîFromPBN
(
ªfCou¡s
->
¶ab
, 
pbn
, &
ödex
);

293 i‡(
ªsu…
 !
VDO_SUCCESS
) {

294  
ªsu…
;

297 *
cou¡îPå
 = &
ªfCou¡s
->
cou¡îs
[
ödex
];

299  
VDO_SUCCESS
;

300 
	}
}

303 
uöt8_t
 
	$gëAvaûabÀRe„ªn˚s
(
RefCou¡s
 *
ªfCou¡s
, 
PhysiˇlBlockNumbî
 
pbn
)

305 
Re„ªn˚Cou¡
 *
cou¡îPå
 = 
NULL
;

306 
ªsu…
 = 
	`gëRe„ªn˚Cou¡î
(
ªfCou¡s
, 
pbn
, &
cou¡îPå
);

307 i‡(
ªsu…
 !
VDO_SUCCESS
) {

311 i‡(*
cou¡îPå
 =
PROVISIONAL_REFERENCE_COUNT
) {

312  (
MAXIMUM_REFERENCE_COUNT
 - 1);

315  (
MAXIMUM_REFERENCE_COUNT
 - *
cou¡îPå
);

316 
	}
}

336 
	$ö¸emítF‹D©a
(
RefCou¡s
 *
ªfCou¡s
,

337 
Re„ªn˚Block
 *
block
,

338 
SœbBlockNumbî
 
¶abBlockNumbî
,

339 
Re„ªn˚Sètus
 
ﬁdSètus
,

340 
PBNLock
 *
lock
,

341 
Re„ªn˚Cou¡
 *
cou¡îPå
,

342 
boﬁ
 *
‰ìSètusCh™ged
)

344 
ﬁdSètus
) {

345 
RS_FREE
:

346 *
cou¡îPå
 = 1;

347 
block
->
ÆloˇãdCou¡
++;

348 
ªfCou¡s
->
‰ìBlocks
--;

349 *
‰ìSètusCh™ged
 = 
åue
;

352 
RS_PROVISIONAL
:

353 *
cou¡îPå
 = 1;

354 *
‰ìSètusCh™ged
 = 
Ál£
;

359 i‡(*
cou¡îPå
 >
MAXIMUM_REFERENCE_COUNT
) {

360  
	`logEº‹WôhSåögEº‹
(
VDO_REF_COUNT_INVALID
,

363 
PRIu32
 ")",

364 
ªfCou¡s
->
¶ab
->
¶abNumbî
,

365 
¶abBlockNumbî
);

367 (*
cou¡îPå
)++;

368 *
‰ìSètusCh™ged
 = 
Ál£
;

371 i‡(
lock
 !
NULL
) {

372 
	`u«ssignProvisi⁄ÆRe„ªn˚
(
lock
);

374  
VDO_SUCCESS
;

375 
	}
}

395 
	$de¸emítF‹D©a
(
RefCou¡s
 *
ªfCou¡s
,

396 
Re„ªn˚Block
 *
block
,

397 
SœbBlockNumbî
 
¶abBlockNumbî
,

398 
Re„ªn˚Sètus
 
ﬁdSètus
,

399 
PBNLock
 *
lock
,

400 
Re„ªn˚Cou¡
 *
cou¡îPå
,

401 
boﬁ
 *
‰ìSètusCh™ged
)

403 
ﬁdSètus
) {

404 
RS_FREE
:

405  
	`logEº‹WôhSåögEº‹
(
VDO_REF_COUNT_INVALID
,

407 
PRIu32
 " i¿¶ab %u", 
¶abBlockNumbî
,

408 
ªfCou¡s
->
¶ab
->
¶abNumbî
);

410 
RS_PROVISIONAL
:

411 
RS_SINGLE
:

412 i‡(
lock
 !
NULL
) {

415 *
cou¡îPå
 = 
PROVISIONAL_REFERENCE_COUNT
;

416 *
‰ìSètusCh™ged
 = 
Ál£
;

417 
	`assignProvisi⁄ÆRe„ªn˚
(
lock
);

419 *
cou¡îPå
 = 
EMPTY_REFERENCE_COUNT
;

420 
block
->
ÆloˇãdCou¡
--;

421 
ªfCou¡s
->
‰ìBlocks
++;

422 *
‰ìSètusCh™ged
 = 
åue
;

428 (*
cou¡îPå
)--;

429 *
‰ìSètusCh™ged
 = 
Ál£
;

432  
VDO_SUCCESS
;

433 
	}
}

459 
	$ö¸emítF‹BlockM≠
(
RefCou¡s
 *
ªfCou¡s
,

460 
Re„ªn˚Block
 *
block
,

461 
SœbBlockNumbî
 
¶abBlockNumbî
,

462 
Re„ªn˚Sètus
 
ﬁdSètus
,

463 
PBNLock
 *
lock
,

464 
boﬁ
 
n‹mÆO≥øti⁄
,

465 
Re„ªn˚Cou¡
 *
cou¡îPå
,

466 
boﬁ
 *
‰ìSètusCh™ged
)

468 
ﬁdSètus
) {

469 
RS_FREE
:

470 i‡(
n‹mÆO≥øti⁄
) {

471  
	`logEº‹WôhSåögEº‹
(
VDO_REF_COUNT_INVALID
,

473 " (¶ab %u, off£à%" 
PRIu32
 ")",

474 
ªfCou¡s
->
¶ab
->
¶abNumbî
,

475 
¶abBlockNumbî
);

478 *
cou¡îPå
 = 
MAXIMUM_REFERENCE_COUNT
;

479 
block
->
ÆloˇãdCou¡
++;

480 
ªfCou¡s
->
‰ìBlocks
--;

481 *
‰ìSètusCh™ged
 = 
åue
;

482  
VDO_SUCCESS
;

484 
RS_PROVISIONAL
:

485 i‡(!
n‹mÆO≥øti⁄
) {

486  
	`logEº‹WôhSåögEº‹
(
VDO_REF_COUNT_INVALID
,

489 " (¶ab %u, off£à%" 
PRIu32
 ")",

490 
ªfCou¡s
->
¶ab
->
¶abNumbî
,

491 
¶abBlockNumbî
);

494 *
cou¡îPå
 = 
MAXIMUM_REFERENCE_COUNT
;

495 *
‰ìSètusCh™ged
 = 
Ál£
;

496 i‡(
lock
 !
NULL
) {

497 
	`u«ssignProvisi⁄ÆRe„ªn˚
(
lock
);

499  
VDO_SUCCESS
;

502  
	`logEº‹WôhSåögEº‹
(
VDO_REF_COUNT_INVALID
,

505 "off£à%" 
PRIu32
 ")",

506 *
cou¡îPå
,

507 
ªfCou¡s
->
¶ab
->
¶abNumbî
,

508 
¶abBlockNumbî
);

510 
	}
}

513 
íãrRefCou¡sRódO∆yMode
(
RefCou¡s
 *
ªfCou¡s
, 
ªsu…
);

537 
	$upd©eRe„ªn˚Cou¡
(
RefCou¡s
 *
ªfCou¡s
,

538 
Re„ªn˚Block
 *
block
,

539 
SœbBlockNumbî
 
¶abBlockNumbî
,

540 c⁄° 
Jou∫ÆPoöt
 *
¶abJou∫ÆPoöt
,

541 
Re„ªn˚O≥øti⁄
 
›î©i⁄
,

542 
boﬁ
 
n‹mÆO≥øti⁄
,

543 
boﬁ
 *
‰ìSètusCh™ged
,

544 
boﬁ
 *
¥ovisi⁄ÆDe¸emítPå
)

546 
Re„ªn˚Cou¡
 *
cou¡îPå
 = &
ªfCou¡s
->
cou¡îs
[
¶abBlockNumbî
];

547 
Re„ªn˚Sètus
 
ﬁdSètus
 = 
	`ª„ªn˚Cou¡ToSètus
(*
cou¡îPå
);

548 
PBNLock
 *
lock
 = 
	`gëRe„ªn˚O≥øti⁄PBNLock
(
›î©i⁄
);

549 
ªsu…
;

551 
›î©i⁄
.
ty≥
) {

552 
DATA_INCREMENT
:

553 
ªsu…
 = 
	`ö¸emítF‹D©a
(
ªfCou¡s
, 
block
, 
¶abBlockNumbî
, 
ﬁdSètus
,

554 
lock
, 
cou¡îPå
, 
‰ìSètusCh™ged
);

557 
DATA_DECREMENT
:

558 
ªsu…
 = 
	`de¸emítF‹D©a
(
ªfCou¡s
, 
block
, 
¶abBlockNumbî
, 
ﬁdSètus
,

559 
lock
, 
cou¡îPå
, 
‰ìSètusCh™ged
);

560 i‡((
ªsu…
 =
VDO_SUCCESS
Ë&& (
ﬁdSètus
 =
RS_PROVISIONAL
)) {

561 i‡(
¥ovisi⁄ÆDe¸emítPå
 !
NULL
) {

562 *
¥ovisi⁄ÆDe¸emítPå
 = 
åue
;

564  
VDO_SUCCESS
;

568 
BLOCK_MAP_INCREMENT
:

569 
ªsu…
 = 
	`ö¸emítF‹BlockM≠
(
ªfCou¡s
, 
block
, 
¶abBlockNumbî
, 
ﬁdSètus
,

570 
lock
, 
n‹mÆO≥øti⁄
, 
cou¡îPå
,

571 
‰ìSètusCh™ged
);

575 
	`logEº‹
("Unknow¿ª„ªn˚ cou¡ o≥øti⁄: %u", 
›î©i⁄
.
ty≥
);

576 
	`íãrRefCou¡sRódO∆yMode
(
ªfCou¡s
, 
VDO_NOT_IMPLEMENTED
);

577 
ªsu…
 = 
VDO_NOT_IMPLEMENTED
;

580 i‡(
ªsu…
 !
VDO_SUCCESS
) {

581  
ªsu…
;

584 i‡(
	`isVÆidJou∫ÆPoöt
(
¶abJou∫ÆPoöt
)) {

585 
ªfCou¡s
->
¶abJou∫ÆPoöt
 = *slabJournalPoint;

588  
VDO_SUCCESS
;

589 
	}
}

592 
	$adju°Re„ªn˚Cou¡
(
RefCou¡s
 *
ªfCou¡s
,

593 
Re„ªn˚O≥øti⁄
 
›î©i⁄
,

594 c⁄° 
Jou∫ÆPoöt
 *
¶abJou∫ÆPoöt
,

595 
boﬁ
 *
‰ìSètusCh™ged
)

597 i‡(
ªfCou¡s
->
˛o£Reque°ed
) {

598  
VDO_COMPONENT_BUSY
;

601 
SœbBlockNumbî
 
¶abBlockNumbî
;

602 
ªsu…
 = 
	`¶abBlockNumbîFromPBN
(
ªfCou¡s
->
¶ab
, 
›î©i⁄
.
pbn
,

603 &
¶abBlockNumbî
);

604 i‡(
ªsu…
 !
VDO_SUCCESS
) {

605  
ªsu…
;

608 
Re„ªn˚Block
 *
block
 = 
	`gëRe„ªn˚Block
(
ªfCou¡s
, 
¶abBlockNumbî
);

609 
boﬁ
 
¥ovisi⁄ÆDe¸emít
 = 
Ál£
;

610 
ªsu…
 = 
	`upd©eRe„ªn˚Cou¡
(
ªfCou¡s
, 
block
, 
¶abBlockNumbî
,

611 
¶abJou∫ÆPoöt
, 
›î©i⁄
,

612 
NORMAL_OPERATION
, 
‰ìSètusCh™ged
,

613 &
¥ovisi⁄ÆDe¸emít
);

614 i‡((
ªsu…
 !
VDO_SUCCESS
Ë|| 
¥ovisi⁄ÆDe¸emít
) {

615  
ªsu…
;

618 i‡(
block
->
isDúty
 && (block->
¶abJou∫ÆLock
 > 0)) {

625 
ªsu…
 = 
	`ASSERT
(
	`isVÆidJou∫ÆPoöt
(
¶abJou∫ÆPoöt
),

627 i‡(
ªsu…
 !
VDO_SUCCESS
) {

628  
ªsu…
;

631 
Sequí˚Numbî
 
íåyLock
 = 
¶abJou∫ÆPoöt
->
£quí˚Numbî
;

632 
	`adju°SœbJou∫ÆBlockRe„ªn˚
(
ªfCou¡s
->
¶ab
->
jou∫Æ
, 
íåyLock
, -1);

633  
VDO_SUCCESS
;

642 i‡(
	`isVÆidJou∫ÆPoöt
(
¶abJou∫ÆPoöt
)) {

643 
block
->
¶abJou∫ÆLock
 = 
¶abJou∫ÆPoöt
->
£quí˚Numbî
;

645 
block
->
¶abJou∫ÆLock
 = 0;

647  
	`dútyBlock
(
block
);

648 
	}
}

651 
	$adju°Re„ªn˚Cou¡F‹Rebuûd
(
RefCou¡s
 *
ªfCou¡s
,

652 
PhysiˇlBlockNumbî
 
pbn
,

653 
Jou∫ÆO≥øti⁄
 
›î©i⁄
)

655 
SœbBlockNumbî
 
¶abBlockNumbî
;

656 
ªsu…
 = 
	`¶abBlockNumbîFromPBN
(
ªfCou¡s
->
¶ab
, 
pbn
, &
¶abBlockNumbî
);

657 i‡(
ªsu…
 !
VDO_SUCCESS
) {

658  
ªsu…
;

661 
Re„ªn˚Block
 *
block
 = 
	`gëRe„ªn˚Block
(
ªfCou¡s
, 
¶abBlockNumbî
);

662 
boﬁ
 
unu£dFªeSètus
;

663 
Re„ªn˚O≥øti⁄
 
physiˇlO≥øti⁄
 = {

664 .
ty≥
 = 
›î©i⁄
,

666 
ªsu…
 = 
	`upd©eRe„ªn˚Cou¡
(
ªfCou¡s
, 
block
, 
¶abBlockNumbî
, 
NULL
,

667 
physiˇlO≥øti⁄
, !
NORMAL_OPERATION
,

668 &
unu£dFªeSètus
, 
NULL
);

669 i‡(
ªsu…
 !
VDO_SUCCESS
) {

670  
ªsu…
;

673  
	`dútyBlock
(
block
);

674 
	}
}

677 
	$ª∂ayRe„ªn˚Cou¡Ch™ge
(
RefCou¡s
 *
ªfCou¡s
,

678 c⁄° 
Jou∫ÆPoöt
 *
íåyPoöt
,

679 
SœbJou∫ÆE¡ry
 
íåy
)

681 
Re„ªn˚Block
 *
block
 = 
	`gëRe„ªn˚Block
(
ªfCou¡s
, 
íåy
.
sbn
);

682 
Se˘‹Cou¡
 
£˘‹


683 (
íåy
.
sbn
 % 
COUNTS_PER_BLOCK
Ë/ 
COUNTS_PER_SECTOR
;

684 i‡(!
	`bef‹eJou∫ÆPoöt
(&
block
->
commôPoöts
[
£˘‹
], 
íåyPoöt
)) {

686  
VDO_SUCCESS
;

690 
boﬁ
 
unu£dFªeSètus
;

691 
Re„ªn˚O≥øti⁄
 
›î©i⁄
 = {

692 .
ty≥
 = 
íåy
.
›î©i⁄


694 
ªsu…
 = 
	`upd©eRe„ªn˚Cou¡
(
ªfCou¡s
, 
block
, 
íåy
.
sbn
,

695 
íåyPoöt
, 
›î©i⁄
, !
NORMAL_OPERATION
,

696 &
unu£dFªeSètus
, 
NULL
);

697 i‡(
ªsu…
 !
VDO_SUCCESS
) {

698  
ªsu…
;

701  
	`dútyBlock
(
block
);

702 
	}
}

705 
	$gëRe„ªn˚Sètus
(
RefCou¡s
 *
ªfCou¡s
,

706 
PhysiˇlBlockNumbî
 
pbn
,

707 
Re„ªn˚Sètus
 *
°©usPå
)

709 
Re„ªn˚Cou¡
 *
cou¡îPå
 = 
NULL
;

710 
ªsu…
 = 
	`gëRe„ªn˚Cou¡î
(
ªfCou¡s
, 
pbn
, &
cou¡îPå
);

711 i‡(
ªsu…
 !
VDO_SUCCESS
) {

712  
ªsu…
;

715 *
°©usPå
 = 
	`ª„ªn˚Cou¡ToSètus
(*
cou¡îPå
);

716  
VDO_SUCCESS
;

717 
	}
}

720 
boﬁ
 
	$¨eEquivÆítRe„ªn˚Cou¡îs
(
RefCou¡s
 *
cou¡îA
, RefCou¡†*
cou¡îB
)

722 i‡((
cou¡îA
->
blockCou¡
 !
cou¡îB
->blockCount)

723 || (
cou¡îA
->
‰ìBlocks
 !
cou¡îB
->freeBlocks)

724 || (
cou¡îA
->
ª„ªn˚BlockCou¡
 !
cou¡îB
->referenceBlockCount)) {

725  
Ál£
;

728 
size_t
 
i
 = 0; i < 
cou¡îA
->
ª„ªn˚BlockCou¡
; i++) {

729 
Re„ªn˚Block
 *
blockA
 = &
cou¡îA
->
blocks
[
i
];

730 
Re„ªn˚Block
 *
blockB
 = &
cou¡îB
->
blocks
[
i
];

731 i‡(
blockA
->
ÆloˇãdCou¡
 !
blockB
->allocatedCount) {

732  
Ál£
;

736  (
	`memcmp
(
cou¡îA
->
cou¡îs
, 
cou¡îB
->counters,

737 (
Re„ªn˚Cou¡
Ë* 
cou¡îA
->
blockCou¡
) == 0);

738 
	}
}

752 
ölöe
 
SœbBlockNumbî
 
	$födZîoByãInW‹d
(c⁄° 
byã
 *
w‹dPå
,

753 
SœbBlockNumbî
 
°¨tIndex
,

754 
SœbBlockNumbî
 
ÁûIndex
)

756 
uöt64_t
 
w‹d
 = *((c⁄° uöt64_à*Ë
w‹dPå
);

759 
off£t
 = 0; off£à< 
BYTES_PER_WORD
; offset++) {

761 i‡((
w‹d
 & 0xFF) == 0) {

762  (
°¨tIndex
 + 
off£t
);

764 
w‹d
 >>= 8;

767  
ÁûIndex
;

768 
	}
}

771 
boﬁ
 
	$födFªeBlock
(c⁄° 
RefCou¡s
 *
ªfCou¡s
,

772 
SœbBlockNumbî
 
°¨tIndex
,

773 
SœbBlockNumbî
 
ídIndex
,

774 
SœbBlockNumbî
 *
ödexPå
)

776 
SœbBlockNumbî
 
zîoIndex
;

777 
SœbBlockNumbî
 
√xtIndex
 = 
°¨tIndex
;

778 
byã
 *
√xtCou¡î
 = &
ªfCou¡s
->
cou¡îs
[
√xtIndex
];

779 
byã
 *
ídCou¡î
 = &
ªfCou¡s
->
cou¡îs
[
ídIndex
];

783 
zîoIndex
 = 
	`födZîoByãInW‹d
(
√xtCou¡î
, 
√xtIndex
, 
ídIndex
);

784 i‡(
zîoIndex
 < 
ídIndex
) {

785 *
ödexPå
 = 
zîoIndex
;

786  
åue
;

791 
√xtIndex
 +
BYTES_PER_WORD
;

792 
√xtCou¡î
 +
BYTES_PER_WORD
;

796 
√xtCou¡î
 < 
ídCou¡î
) {

802 
zîoIndex
 = 
	`födZîoByãInW‹d
(
√xtCou¡î
, 
√xtIndex
, 
ídIndex
);

803 i‡(
zîoIndex
 < 
ídIndex
) {

804 *
ödexPå
 = 
zîoIndex
;

805  
åue
;

808 
√xtIndex
 +
BYTES_PER_WORD
;

809 
√xtCou¡î
 +
BYTES_PER_WORD
;

812  
Ál£
;

813 
	}
}

825 
boﬁ
 
	$£¨chCuºítRe„ªn˚Block
(c⁄° 
RefCou¡s
 *
ªfCou¡s
,

826 
SœbBlockNumbî
 *
‰ìIndexPå
)

829  ((
ªfCou¡s
->
£¨chCurs‹
.
block
->
ÆloˇãdCou¡
 < 
COUNTS_PER_BLOCK
)

830 && 
	`födFªeBlock
(
ªfCou¡s
,ÑefCou¡s->
£¨chCurs‹
.
ödex
,

831 
ªfCou¡s
->
£¨chCurs‹
.
ídIndex
, 
‰ìIndexPå
));

832 
	}
}

845 
boﬁ
 
	$£¨chRe„ªn˚Blocks
(
RefCou¡s
 *
ªfCou¡s
,

846 
SœbBlockNumbî
 *
‰ìIndexPå
)

849 i‡(
	`£¨chCuºítRe„ªn˚Block
(
ªfCou¡s
, 
‰ìIndexPå
)) {

850  
åue
;

854 
	`adv™˚SórchCurs‹
(
ªfCou¡s
)) {

855 i‡(
	`£¨chCuºítRe„ªn˚Block
(
ªfCou¡s
, 
‰ìIndexPå
)) {

856  
åue
;

860  
Ál£
;

861 
	}
}

869 
	$makeProvisi⁄ÆRe„ªn˚
(
RefCou¡s
 *
ªfCou¡s
,

870 
SœbBlockNumbî
 
¶abBlockNumbî
)

874 
ªfCou¡s
->
cou¡îs
[
¶abBlockNumbî
] = 
PROVISIONAL_REFERENCE_COUNT
;

877 
ªfCou¡s
->
£¨chCurs‹
.
block
->
ÆloˇãdCou¡
++;

878 
ªfCou¡s
->
‰ìBlocks
--;

879 
	}
}

882 
	$ÆloˇãUƒe„ªn˚dBlock
(
RefCou¡s
 *
ªfCou¡s
,

883 
PhysiˇlBlockNumbî
 *
ÆloˇãdPå
)

885 i‡(
ªfCou¡s
->
˛o£Reque°ed
) {

886  
VDO_COMPONENT_BUSY
;

889 
SœbBlockNumbî
 
‰ìIndex
;

890 i‡(!
	`£¨chRe„ªn˚Blocks
(
ªfCou¡s
, &
‰ìIndex
)) {

891  
VDO_NO_SPACE
;

894 
	`ASSERT_LOG_ONLY
((
ªfCou¡s
->
cou¡îs
[
‰ìIndex
] =
EMPTY_REFERENCE_COUNT
),

896 
	`makeProvisi⁄ÆRe„ªn˚
(
ªfCou¡s
, 
‰ìIndex
);

900 
ªfCou¡s
->
£¨chCurs‹
.
ödex
 = (
‰ìIndex
 + 1);

902 *
ÆloˇãdPå
 = 
	`ödexToPBN
(
ªfCou¡s
, 
‰ìIndex
);

903  
VDO_SUCCESS
;

904 
	}
}

907 
	$¥ovisi⁄ÆlyRe„ªn˚Block
(
RefCou¡s
 *
ªfCou¡s
,

908 
PhysiˇlBlockNumbî
 
pbn
,

909 
PBNLock
 *
lock
)

911 i‡(
ªfCou¡s
->
˛o£Reque°ed
) {

912  
VDO_COMPONENT_BUSY
;

915 
SœbBlockNumbî
 
¶abBlockNumbî
;

916 
ªsu…
 = 
	`¶abBlockNumbîFromPBN
(
ªfCou¡s
->
¶ab
, 
pbn
, &
¶abBlockNumbî
);

917 i‡(
ªsu…
 !
VDO_SUCCESS
) {

918  
ªsu…
;

921 i‡(
ªfCou¡s
->
cou¡îs
[
¶abBlockNumbî
] =
EMPTY_REFERENCE_COUNT
) {

922 
	`makeProvisi⁄ÆRe„ªn˚
(
ªfCou¡s
, 
¶abBlockNumbî
);

923 i‡(
lock
 !
NULL
) {

924 
	`assignProvisi⁄ÆRe„ªn˚
(
lock
);

928  
VDO_SUCCESS
;

929 
	}
}

932 
BlockCou¡
 
	$cou¡Uƒe„ªn˚dBlocks
(
RefCou¡s
 *
ªfCou¡s
,

933 
PhysiˇlBlockNumbî
 
°¨tPBN
,

934 
PhysiˇlBlockNumbî
 
ídPBN
)

936 
BlockCou¡
 
‰ìBlocks
 = 0;

937 
SœbBlockNumbî
 
°¨tIndex
 = 
	`pbnToIndex
(
ªfCou¡s
, 
°¨tPBN
);

938 
SœbBlockNumbî
 
ídIndex
 = 
	`pbnToIndex
(
ªfCou¡s
, 
ídPBN
);

939 
SœbBlockNumbî
 
ödex
 = 
°¨tIndex
; index < 
ídIndex
; index++) {

940 i‡(
ªfCou¡s
->
cou¡îs
[
ödex
] =
EMPTY_REFERENCE_COUNT
) {

941 
‰ìBlocks
++;

945  
‰ìBlocks
;

946 
	}
}

956 
ölöe
 
Re„ªn˚Block
 *
	$waôîAsRe„ªn˚Block
(
Waôî
 *
waôî
)

958 
	`STATIC_ASSERT
(
	`off£tof
(
Re„ªn˚Block
, 
waôî
) == 0);

959  (
Re„ªn˚Block
 *Ë
waôî
;

960 
	}
}

969 
˛órDútyRe„ªn˚Blocks
(
Waôî
 *
blockWaôî
,

970 *
c⁄ãxt
 
__©åibuã__
((
unu£d
)))

972 
waôîAsRe„ªn˚Block
(
blockWaôî
)->
	gisDúty
 = 
Ál£
;

976 
	$ª£tRe„ªn˚Cou¡s
(
RefCou¡s
 *
ªfCou¡s
)

979 
	`STATIC_ASSERT
((
Re„ªn˚Cou¡
) == 1);

980 
	`mem£t
(
ªfCou¡s
->
cou¡îs
, 0,ÑefCou¡s->
blockCou¡
);

981 
ªfCou¡s
->
‰ìBlocks
 =ÑefCou¡s->
blockCou¡
;

982 
ªfCou¡s
->
¶abJou∫ÆPoöt
 = (
Jou∫ÆPoöt
) {

983 .
£quí˚Numbî
 = 0,

984 .
íåyCou¡
 = 0,

987 
size_t
 
i
 = 0; i < 
ªfCou¡s
->
ª„ªn˚BlockCou¡
; i++) {

988 
ªfCou¡s
->
blocks
[
i
].
ÆloˇãdCou¡
 = 0;

991 
	`nŸifyAŒWaôîs
(&
ªfCou¡s
->
dútyBlocks
, 
˛órDútyRe„ªn˚Blocks
, 
NULL
);

992 
	}
}

995 
BlockCou¡
 
	$gëSavedRe„ªn˚Cou¡Size
(
BlockCou¡
 
blockCou¡
)

997  
	`compuãBuckëCou¡
(
blockCou¡
, 
COUNTS_PER_BLOCK
);

998 
	}
}

1007 
__©åibuã__
((
w¨n_unu£d_ªsu…
))

1008 
boﬁ
 
	$isRefCou¡sDúty
(
RefCou¡s
 *
ªfCou¡s
)

1010  ((
ªfCou¡s
->
a˘iveCou¡
 > 0Ë||ÑefCou¡s->
upd©ögSœbSumm¨y


1011 || 
	`hasWaôîs
(&
ªfCou¡s
->
dútyBlocks
));

1012 
	}
}

1015 
	$checkF‹IOCom∂ëe
(
RefCou¡s
 *
ªfCou¡s
)

1017 i‡(!
ªfCou¡s
->
hasIOWaôî
 || 
	`isRefCou¡sDúty
(refCounts)) {

1021 
ªfCou¡s
->
hasIOWaôî
 = 
Ál£
;

1022 
	`föishCom∂ëi⁄
(&
ªfCou¡s
->
com∂ëi⁄
,

1023 
	`isRódO∆y
(
ªfCou¡s
->
ªadO∆yC⁄ãxt
)

1024 ? 
VDO_READ_ONLY
 : 
VDO_SUCCESS
);

1025 
	}
}

1030 
föishSumm¨yUpd©e
(
Waôî
 *
waôî
,

1031 *
c⁄ãxt
 
__©åibuã__
((
unu£d
)))

1033 
RefCou¡s
 *
	gªfCou¡s
 = 
ªfCou¡sFromWaôî
(
waôî
);

1034 
	gªfCou¡s
->
	gupd©ögSœbSumm¨y
 = 
Ál£
;

1035 
checkF‹IOCom∂ëe
(
ªfCou¡s
);

1043 
	$upd©eSœbSumm¨yAsCÀ™
(
RefCou¡s
 *
ªfCou¡s
)

1045 
SœbSumm¨yZ⁄e
 *
summ¨y
 = 
	`gëSœbSumm¨yZ⁄e
(
ªfCou¡s
->
¶ab
->
Æloˇt‹
);

1046 i‡(
summ¨y
 =
NULL
) {

1051 
TaûBlockOff£t
 
off£t


1052 
	`gëSumm¨izedTaûBlockOff£t
(
summ¨y
, 
ªfCou¡s
->
¶ab
->
¶abNumbî
);

1053 
ªfCou¡s
->
upd©ögSœbSumm¨y
 = 
åue
;

1054 
ªfCou¡s
->
¶abSumm¨yWaôî
.
ˇŒback
 = 
föishSumm¨yUpd©e
;

1055 
	`upd©eSœbSumm¨yE¡ry
(
summ¨y
, &
ªfCou¡s
->
¶abSumm¨yWaôî
,

1056 
ªfCou¡s
->
¶ab
->
¶abNumbî
, 
off£t
, 
åue
,Årue,

1057 
	`gëSœbFªeBlockCou¡
(
ªfCou¡s
->
¶ab
));

1058 
	}
}

1061 
	$íãrRefCou¡sRódO∆yMode
(
RefCou¡s
 *
ªfCou¡s
, 
ªsu…
)

1063 
	`íãrRódO∆yMode
(
ªfCou¡s
->
ªadO∆yC⁄ãxt
, 
ªsu…
);

1064 
	`checkF‹IOCom∂ëe
(
ªfCou¡s
);

1065 
	}
}

1072 
	$h™dÀIOEº‹
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

1074 
ªsu…
 = 
com∂ëi⁄
->result;

1075 
VIOPoﬁE¡ry
 *
íåy
 = 
com∂ëi⁄
->
∑ª¡
;

1076 
RefCou¡s
 *
ªfCou¡s
 = ((
Re„ªn˚Block
 *Ë
íåy
->
∑ª¡
)->refCounts;

1077 
	`ªtu∫VIO
(
ªfCou¡s
->
¶ab
->
Æloˇt‹
, 
íåy
);

1078 
ªfCou¡s
->
a˘iveCou¡
--;

1079 
	`íãrRefCou¡sRódO∆yMode
(
ªfCou¡s
, 
ªsu…
);

1080 
	}
}

1088 
	$föishRe„ªn˚BlockWrôe
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

1090 
VIOPoﬁE¡ry
 *
íåy
 = 
com∂ëi⁄
->
∑ª¡
;

1091 
Re„ªn˚Block
 *
block
 = 
íåy
->
∑ª¡
;

1092 
RefCou¡s
 *
ªfCou¡s
 = 
block
->refCounts;

1093 
ªfCou¡s
->
a˘iveCou¡
--;

1096 
	`adju°SœbJou∫ÆBlockRe„ªn˚
(
ªfCou¡s
->
¶ab
->
jou∫Æ
,

1097 
block
->
¶abJou∫ÆLockToRñó£
, -1);

1098 
	`ªtu∫VIO
(
ªfCou¡s
->
¶ab
->
Æloˇt‹
, 
íåy
);

1105 
block
->
isWrôög
 = 
Ál£
;

1108 i‡(
block
->
isDúty
 && !
	`isRódO∆y
(
ªfCou¡s
->
ªadO∆yC⁄ãxt
)) {

1109 
ªsu…
 = 
	`íqueueWaôî
(&
ªfCou¡s
->
dútyBlocks
, &
block
->
waôî
);

1110 i‡(
ªsu…
 !
VDO_SUCCESS
) {

1112 
	`íãrRefCou¡sRódO∆yMode
(
ªfCou¡s
, 
ªsu…
);

1115 i‡(
ªfCou¡s
->
hasIOWaôî
) {

1117 
	`ßveDútyRe„ªn˚Blocks
(
ªfCou¡s
);

1123 i‡(
	`isRódO∆y
(
ªfCou¡s
->
ªadO∆yC⁄ãxt
)) {

1124 
	`checkF‹IOCom∂ëe
(
ªfCou¡s
);

1130 i‡(!
	`isRefCou¡sDúty
(
ªfCou¡s
)) {

1131 
	`upd©eSœbSumm¨yAsCÀ™
(
ªfCou¡s
);

1133 
	}
}

1136 
Re„ªn˚Cou¡
 *
	$gëRe„ªn˚Cou¡îsF‹Block
(
Re„ªn˚Block
 *
block
)

1138 
size_t
 
blockIndex
 = 
block
 - block->
ªfCou¡s
->
blocks
;

1139  &
block
->
ªfCou¡s
->
cou¡îs
[
blockIndex
 * 
COUNTS_PER_BLOCK
];

1140 
	}
}

1143 
	$∑ckRe„ªn˚Block
(
Re„ªn˚Block
 *
block
, *
buf„r
)

1145 
PackedJou∫ÆPoöt
 
commôPoöt
;

1146 
	`∑ckJou∫ÆPoöt
(&
block
->
ªfCou¡s
->
¶abJou∫ÆPoöt
, &
commôPoöt
);

1148 
PackedRe„ªn˚Block
 *
∑cked
 = 
buf„r
;

1149 
Re„ªn˚Cou¡
 *
cou¡îs
 = 
	`gëRe„ªn˚Cou¡îsF‹Block
(
block
);

1150 
Se˘‹Cou¡
 
i
 = 0; i < 
SECTORS_PER_BLOCK
; i++) {

1151 
∑cked
->
£˘‹s
[
i
].
commôPoöt
 = commitPoint;

1152 
	`mem˝y
(
∑cked
->
£˘‹s
[
i
].
cou¡s
, 
cou¡îs
 + (ò* 
COUNTS_PER_SECTOR
),

1153 ((
Re„ªn˚Cou¡
Ë* 
COUNTS_PER_SECTOR
));

1155 
	}
}

1164 
	$wrôeRe„ªn˚Block
(
Waôî
 *
blockWaôî
, *
vioC⁄ãxt
)

1166 
VIOPoﬁE¡ry
 *
íåy
 = 
vioC⁄ãxt
;

1167 
Re„ªn˚Block
 *
block
 = 
	`waôîAsRe„ªn˚Block
(
blockWaôî
);

1168 
	`∑ckRe„ªn˚Block
(
block
, 
íåy
->
buf„r
);

1170 
size_t
 
blockOff£t
 = (
block
 - block->
ªfCou¡s
->
blocks
);

1171 
PhysiˇlBlockNumbî
 
pbn
 = (
block
->
ªfCou¡s
->
‹igö
 + 
blockOff£t
);

1172 
block
->
¶abJou∫ÆLockToRñó£
 = block->
¶abJou∫ÆLock
;

1173 
íåy
->
∑ª¡
 = 
block
;

1180 
block
->
isDúty
 = 
Ál£
;

1184 
	`ªœxedAdd64
(&
block
->
ªfCou¡s
->
°©i°ics
->
blocksWrôãn
, 1);

1185 
íåy
->
vio
->
com∂ëi⁄
.
ˇŒbackThªadID


1186 
block
->
ªfCou¡s
->
¶ab
->
Æloˇt‹
->
thªadID
;

1187 
	`œunchWrôeMëad©aVIOWôhFlush
(
íåy
->
vio
, 
pbn
, 
föishRe„ªn˚BlockWrôe
,

1188 
h™dÀIOEº‹
, 
åue
, 
Ál£
);

1189 
	}
}

1199 
	$œunchRe„ªn˚BlockWrôe
(
Waôî
 *
blockWaôî
, *
c⁄ãxt
)

1201 
RefCou¡s
 *
ªfCou¡s
 = 
c⁄ãxt
;

1202 i‡(
	`isRódO∆y
(
ªfCou¡s
->
ªadO∆yC⁄ãxt
)) {

1206 
ªfCou¡s
->
a˘iveCou¡
++;

1207 
Re„ªn˚Block
 *
block
 = 
	`waôîAsRe„ªn˚Block
(
blockWaôî
);

1208 
block
->
isWrôög
 = 
åue
;

1209 
blockWaôî
->
ˇŒback
 = 
wrôeRe„ªn˚Block
;

1210 
ªsu…
 = 
	`acquúeVIO
(
ªfCou¡s
->
¶ab
->
Æloˇt‹
, 
blockWaôî
);

1211 i‡(
ªsu…
 !
VDO_SUCCESS
) {

1213 
ªfCou¡s
->
a˘iveCou¡
--;

1214 
	`íãrRefCou¡sRódO∆yMode
(
ªfCou¡s
, 
ªsu…
);

1216 
	}
}

1219 
	$ßveOlde°Re„ªn˚Block
(
RefCou¡s
 *
ªfCou¡s
)

1221 
	`nŸifyNextWaôî
(&
ªfCou¡s
->
dútyBlocks
, 
œunchRe„ªn˚BlockWrôe
,

1222 
ªfCou¡s
);

1223 
	}
}

1226 
	$ßveSevîÆRe„ªn˚Blocks
(
RefCou¡s
 *
ªfCou¡s
, 
size_t
 
ÊushDivis‹
)

1228 
BlockCou¡
 
dútyBlockCou¡
 = 
	`cou¡Waôîs
(&
ªfCou¡s
->
dútyBlocks
);

1229 i‡(
dútyBlockCou¡
 == 0) {

1233 
BlockCou¡
 
blocksToWrôe
 = 
dútyBlockCou¡
 / 
ÊushDivis‹
;

1235 i‡(
blocksToWrôe
 == 0) {

1236 
blocksToWrôe
 = 1;

1239 
BlockCou¡
 
wrôãn
 = 0; wrôã¿< 
blocksToWrôe
; written++) {

1240 
	`ßveOlde°Re„ªn˚Block
(
ªfCou¡s
);

1242 
	}
}

1245 
	$ßveDútyRe„ªn˚Blocks
(
RefCou¡s
 *
ªfCou¡s
)

1247 
	`nŸifyAŒWaôîs
(&
ªfCou¡s
->
dútyBlocks
, 
œunchRe„ªn˚BlockWrôe
,

1248 
ªfCou¡s
);

1249 
	`checkF‹IOCom∂ëe
(
ªfCou¡s
);

1250 
	}
}

1253 
	$ßveRe„ªn˚Blocks
(
RefCou¡s
 *
ªfCou¡s
,

1254 
VDOCom∂ëi⁄
 *
∑ª¡
,

1255 
VDOA˘i⁄
 *
ˇŒback
,

1256 
VDOA˘i⁄
 *
îr‹H™dÀr
,

1257 
ThªadID
 
thªadID
)

1259 
	`ASSERT_LOG_ONLY
(!
ªfCou¡s
->
hasIOWaôî
,

1261 
ªfCou¡s
->
hasIOWaôî
 = 
åue
;

1262 
VDOCom∂ëi⁄
 *
com∂ëi⁄
 = &
ªfCou¡s
->completion;

1263 
	`¥ï¨eCom∂ëi⁄
(
com∂ëi⁄
, 
ˇŒback
, 
îr‹H™dÀr
, 
thªadID
, 
∑ª¡
);

1264 
	`ßveDútyRe„ªn˚Blocks
(
ªfCou¡s
);

1265 
	}
}

1268 
	$dútyAŒRe„ªn˚Blocks
(
RefCou¡s
 *
ªfCou¡s
)

1270 
BlockCou¡
 
i
 = 0; i < 
ªfCou¡s
->
ª„ªn˚BlockCou¡
; i++) {

1271 
ªsu…
 = 
	`dútyBlock
(&
ªfCou¡s
->
blocks
[
i
]);

1272 i‡(
ªsu…
 !
VDO_SUCCESS
) {

1273  
ªsu…
;

1277  
VDO_SUCCESS
;

1278 
	}
}

1281 
	$ßveAŒRe„ªn˚Blocks
(
RefCou¡s
 *
ªfCou¡s
,

1282 
VDOCom∂ëi⁄
 *
∑ª¡
,

1283 
VDOA˘i⁄
 *
ˇŒback
,

1284 
VDOA˘i⁄
 *
îr‹H™dÀr
,

1285 
ThªadID
 
thªadID
)

1287 
	`ASSERT_LOG_ONLY
(!
ªfCou¡s
->
hasIOWaôî
,

1289 
ªfCou¡s
->
hasIOWaôî
 = 
åue
;

1290 
	`¥ï¨eCom∂ëi⁄
(&
ªfCou¡s
->
com∂ëi⁄
, 
ˇŒback
, 
îr‹H™dÀr
, 
thªadID
,

1291 
∑ª¡
);

1293 
ªsu…
 = 
	`dútyAŒRe„ªn˚Blocks
(
ªfCou¡s
);

1294 i‡(
ªsu…
 !
VDO_SUCCESS
) {

1295 
	`föishCom∂ëi⁄
(&
ªfCou¡s
->
com∂ëi⁄
, 
ªsu…
);

1299 
	`ßveDútyRe„ªn˚Blocks
(
ªfCou¡s
);

1300 
	}
}

1303 
	$˛o£Re„ªn˚Cou¡s
(
RefCou¡s
 *
ªfCou¡s
,

1304 
VDOCom∂ëi⁄
 *
∑ª¡
,

1305 
VDOA˘i⁄
 *
ˇŒback
,

1306 
VDOA˘i⁄
 *
îr‹H™dÀr
,

1307 
ThªadID
 
thªadID
)

1309 
	`ASSERT_LOG_ONLY
(!
ªfCou¡s
->
hasIOWaôî
,

1311 
ªfCou¡s
->
˛o£Reque°ed
 = 
åue
;

1312 
	`ßveRe„ªn˚Blocks
(
ªfCou¡s
, 
∑ª¡
, 
ˇŒback
, 
îr‹H™dÀr
, 
thªadID
);

1313 
	}
}

1320 
	$˛órProvisi⁄ÆRe„ªn˚s
(
Re„ªn˚Block
 *
block
)

1322 
Re„ªn˚Cou¡
 *
cou¡îs
 = 
	`gëRe„ªn˚Cou¡îsF‹Block
(
block
);

1323 
BlockCou¡
 
j
 = 0; j < 
COUNTS_PER_BLOCK
; j++) {

1324 i‡(
cou¡îs
[
j
] =
PROVISIONAL_REFERENCE_COUNT
) {

1325 
cou¡îs
[
j
] = 
EMPTY_REFERENCE_COUNT
;

1326 
block
->
ÆloˇãdCou¡
--;

1329 
	}
}

1337 
	$u≈ackRe„ªn˚Block
(
PackedRe„ªn˚Block
 *
∑cked
,

1338 
Re„ªn˚Block
 *
block
)

1340 
RefCou¡s
 *
ªfCou¡s
 = 
block
->refCounts;

1341 
Re„ªn˚Cou¡
 *
cou¡îs
 = 
	`gëRe„ªn˚Cou¡îsF‹Block
(
block
);

1342 
Se˘‹Cou¡
 
i
 = 0; i < 
SECTORS_PER_BLOCK
; i++) {

1343 
PackedRe„ªn˚Se˘‹
 *
£˘‹
 = &
∑cked
->
£˘‹s
[
i
];

1344 
	`u≈ackJou∫ÆPoöt
(&
£˘‹
->
commôPoöt
, &
block
->
commôPoöts
[
i
]);

1345 
	`mem˝y
(
cou¡îs
 + (
i
 * 
COUNTS_PER_SECTOR
), 
£˘‹
->
cou¡s
,

1346 ((
Re„ªn˚Cou¡
Ë* 
COUNTS_PER_SECTOR
));

1348 i‡(
	`bef‹eJou∫ÆPoöt
(&
ªfCou¡s
->
¶abJou∫ÆPoöt
,

1349 &
block
->
commôPoöts
[
i
])) {

1350 
ªfCou¡s
->
¶abJou∫ÆPoöt
 = 
block
->
commôPoöts
[
i
];

1353 i‡((
i
 > 0Ë&& !
	`¨eEquivÆítJou∫ÆPoöts
(&
block
->
commôPoöts
[0],

1354 &
block
->
commôPoöts
[
i
])) {

1355 
size_t
 
blockIndex
 = 
block
 - block->
ªfCou¡s
->
blocks
;

1356 
	`logW¨nög
("Torn write detected in sector %u ofÑeference block"

1357 " %zu o‡¶ab %" 
PRIu16
,

1358 
i
, 
blockIndex
, 
block
->
ªfCou¡s
->
¶ab
->
¶abNumbî
);

1362 
block
->
ÆloˇãdCou¡
 = 0;

1363 
BlockCou¡
 
i
 = 0; i < 
COUNTS_PER_BLOCK
; i++) {

1364 i‡(
cou¡îs
[
i
] !
EMPTY_REFERENCE_COUNT
) {

1365 
block
->
ÆloˇãdCou¡
++;

1368 
	}
}

1375 
	$föishRe„ªn˚BlockLﬂd
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

1377 
VIOPoﬁE¡ry
 *
íåy
 = 
com∂ëi⁄
->
∑ª¡
;

1378 
Re„ªn˚Block
 *
block
 = 
íåy
->
∑ª¡
;

1379 
	`u≈ackRe„ªn˚Block
((
PackedRe„ªn˚Block
 *Ë
íåy
->
buf„r
, 
block
);

1381 
RefCou¡s
 *
ªfCou¡s
 = 
block
->refCounts;

1382 
	`ªtu∫VIO
(
ªfCou¡s
->
¶ab
->
Æloˇt‹
, 
íåy
);

1383 
ªfCou¡s
->
a˘iveCou¡
--;

1384 
	`˛órProvisi⁄ÆRe„ªn˚s
(
block
);

1386 
ªfCou¡s
->
‰ìBlocks
 -
block
->
ÆloˇãdCou¡
;

1387 
	`checkF‹IOCom∂ëe
(
block
->
ªfCou¡s
);

1388 
	}
}

1396 
	$lﬂdRe„ªn˚Block
(
Waôî
 *
blockWaôî
, *
vioC⁄ãxt
)

1398 
VIOPoﬁE¡ry
 *
íåy
 = 
vioC⁄ãxt
;

1399 
Re„ªn˚Block
 *
block
 = 
	`waôîAsRe„ªn˚Block
(
blockWaôî
);

1400 
size_t
 
blockOff£t
 = (
block
 - block->
ªfCou¡s
->
blocks
);

1401 
PhysiˇlBlockNumbî
 
pbn
 = (
block
->
ªfCou¡s
->
‹igö
 + 
blockOff£t
);

1402 
íåy
->
∑ª¡
 = 
block
;

1406 
íåy
->
vio
->
com∂ëi⁄
.
ˇŒbackThªadID


1407 
block
->
ªfCou¡s
->
com∂ëi⁄
.
ˇŒbackThªadID
;

1408 
	`œunchRódMëad©aVIO
(
íåy
->
vio
, 
pbn
, 
föishRe„ªn˚BlockLﬂd
,

1409 
h™dÀIOEº‹
);

1410 
	}
}

1413 
	$lﬂdRe„ªn˚Blocks
(
RefCou¡s
 *
ªfCou¡s
,

1414 
VDOCom∂ëi⁄
 *
∑ª¡
,

1415 
VDOA˘i⁄
 *
ˇŒback
,

1416 
VDOA˘i⁄
 *
îr‹H™dÀr
,

1417 
ThªadID
 
thªadID
)

1419 
	`ASSERT_LOG_ONLY
(!
ªfCou¡s
->
hasIOWaôî
,

1422 
ªfCou¡s
->
hasIOWaôî
 = 
åue
;

1423 
ªfCou¡s
->
‰ìBlocks
 =ÑefCou¡s->
blockCou¡
;

1424 
	`¥ï¨eCom∂ëi⁄
(&
ªfCou¡s
->
com∂ëi⁄
, 
ˇŒback
, 
îr‹H™dÀr
, 
thªadID
,

1425 
∑ª¡
);

1426 
ªfCou¡s
->
a˘iveCou¡
 =ÑefCou¡s->
ª„ªn˚BlockCou¡
;

1427 
BlockCou¡
 
i
 = 0; i < 
ªfCou¡s
->
ª„ªn˚BlockCou¡
; i++) {

1428 
Waôî
 *
blockWaôî
 = &
ªfCou¡s
->
blocks
[
i
].
waôî
;

1429 
blockWaôî
->
ˇŒback
 = 
lﬂdRe„ªn˚Block
;

1430 
ªsu…
 = 
	`acquúeVIO
(
ªfCou¡s
->
¶ab
->
Æloˇt‹
, 
blockWaôî
);

1431 i‡(
ªsu…
 !
VDO_SUCCESS
) {

1433 
ªfCou¡s
->
a˘iveCou¡
 -‘efCou¡s->
ª„ªn˚BlockCou¡
 - 
i
);

1434 
	`íãrRefCou¡sRódO∆yMode
(
ªfCou¡s
, 
ªsu…
);

1438 
	}
}

1441 
	$acquúeDútyBlockLocks
(
RefCou¡s
 *
ªfCou¡s
)

1443 
ªsu…
 = 
	`dútyAŒRe„ªn˚Blocks
(
ªfCou¡s
);

1444 i‡(
ªsu…
 !
VDO_SUCCESS
) {

1445  
ªsu…
;

1448 
BlockCou¡
 
i
 = 0; i < 
ªfCou¡s
->
ª„ªn˚BlockCou¡
; i++) {

1449 
ªfCou¡s
->
blocks
[
i
].
¶abJou∫ÆLock
 = 1;

1452 
	`adju°SœbJou∫ÆBlockRe„ªn˚
(
ªfCou¡s
->
¶ab
->
jou∫Æ
, 1,

1453 
ªfCou¡s
->
ª„ªn˚BlockCou¡
);

1454  
VDO_SUCCESS
;

1455 
	}
}

1458 
	$dumpRefCou¡s
(c⁄° 
RefCou¡s
 *
ªfCou¡s
)

1461 
	`logInfo
("ÑefCou¡s: fªe=%" 
PRIu32
 "/%" PRIu32 " blocks=%" PRIu32

1462 " dúty=%zuá˘ive=%zu jou∫Æ@(%" 
PRIu64
 ",%" 
PRIu16
 ")%s",

1463 
ªfCou¡s
->
‰ìBlocks
,ÑefCou¡s->
blockCou¡
,

1464 
ªfCou¡s
->
ª„ªn˚BlockCou¡
,

1465 
	`cou¡Waôîs
(&
ªfCou¡s
->
dútyBlocks
),

1466 
ªfCou¡s
->
a˘iveCou¡
,

1467 
ªfCou¡s
->
¶abJou∫ÆPoöt
.
£quí˚Numbî
,

1468 
ªfCou¡s
->
¶abJou∫ÆPoöt
.
íåyCou¡
,

1469 (
ªfCou¡s
->
upd©ögSœbSumm¨y
 ? " updating" : ""));

1470 
	}
}

	@vdo/base/refCounts.h

22 #i‚de‡
REF_COUNTS_H


23 
	#REF_COUNTS_H


	)

25 
	~"com∂ëi⁄.h
"

26 
	~"jou∫ÆPoöt.h
"

27 
	~"ªadO∆yModeC⁄ãxt.h
"

28 
	~"¶ab.h
"

29 
	~"ty≥s.h
"

49 
	$makeRefCou¡s
(
PhysiˇlLayî
 *
œyî
,

50 
BlockCou¡
 
blockCou¡
,

51 
Sœb
 *
¶ab
,

52 
PhysiˇlBlockNumbî
 
‹igö
,

53 
RódO∆yModeC⁄ãxt
 *
ªadO∆yC⁄ãxt
,

54 
RefCou¡s
 **
ªfCou¡sPå
)

55 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

62 
	`‰ìRefCou¡s
(
RefCou¡s
 **
ªfCou¡sPå
);

71 
BlockCou¡
 
	$gëUƒe„ªn˚dBlockCou¡
(
RefCou¡s
 *
ªfCou¡s
)

72 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

83 
uöt8_t
 
	$gëAvaûabÀRe„ªn˚s
(
RefCou¡s
 *
ªfCou¡s
, 
PhysiˇlBlockNumbî
 
pbn
)

84 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

102 
	$adju°Re„ªn˚Cou¡
(
RefCou¡s
 *
ªfCou¡s
,

103 
Re„ªn˚O≥øti⁄
 
›î©i⁄
,

104 c⁄° 
Jou∫ÆPoöt
 *
¶abJou∫ÆPoöt
,

105 
boﬁ
 *
‰ìSètusCh™ged
)

106 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

117 
	$adju°Re„ªn˚Cou¡F‹Rebuûd
(
RefCou¡s
 *
ªfCou¡s
,

118 
PhysiˇlBlockNumbî
 
pbn
,

119 
Jou∫ÆO≥øti⁄
 
›î©i⁄
)

120 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

133 
	$ª∂ayRe„ªn˚Cou¡Ch™ge
(
RefCou¡s
 *
ªfCou¡s
,

134 c⁄° 
Jou∫ÆPoöt
 *
íåyPoöt
,

135 
SœbJou∫ÆE¡ry
 
íåy
)

136 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

147 
boﬁ
 
	$¨eEquivÆítRe„ªn˚Cou¡îs
(
RefCou¡s
 *
cou¡îA
, RefCou¡†*
cou¡îB
)

148 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

164 
	$ÆloˇãUƒe„ªn˚dBlock
(
RefCou¡s
 *
ªfCou¡s
,

165 
PhysiˇlBlockNumbî
 *
ÆloˇãdPå
)

166 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

177 
	$¥ovisi⁄ÆlyRe„ªn˚Block
(
RefCou¡s
 *
ªfCou¡s
,

178 
PhysiˇlBlockNumbî
 
pbn
,

179 
PBNLock
 *
lock
)

180 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

194 
BlockCou¡
 
	$cou¡Uƒe„ªn˚dBlocks
(
RefCou¡s
 *
ªfCou¡s
,

195 
PhysiˇlBlockNumbî
 
°¨tPBN
,

196 
PhysiˇlBlockNumbî
 
ídPBN
)

197 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

208 
BlockCou¡
 
	$gëSavedRe„ªn˚Cou¡Size
(
BlockCou¡
 
blockCou¡
)

209 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

220 
	$makeRe„ªn˚Cou¡sCom∂ëi⁄
(
BlockCou¡
 
ª„ªn˚Cou¡Blocks
,

221 
PhysiˇlLayî
 *
œyî
,

222 
VDOCom∂ëi⁄
 **
com∂ëi⁄På
)

223 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

231 
	`‰ìRe„ªn˚Cou¡sCom∂ëi⁄
(
VDOCom∂ëi⁄
 **
com∂ëi⁄På
);

240 
	`ßveSevîÆRe„ªn˚Blocks
(
RefCou¡s
 *
ªfCou¡s
, 
size_t
 
ÊushDivis‹
);

247 
	`ßveDútyRe„ªn˚Blocks
(
RefCou¡s
 *
ªfCou¡s
);

260 
	`ßveRe„ªn˚Blocks
(
RefCou¡s
 *
ªfCou¡s
,

261 
VDOCom∂ëi⁄
 *
∑ª¡
,

262 
VDOA˘i⁄
 *
ˇŒback
,

263 
VDOA˘i⁄
 *
îr‹H™dÀr
,

264 
ThªadID
 
thªadID
);

278 
	`ßveAŒRe„ªn˚Blocks
(
RefCou¡s
 *
ªfCou¡s
,

279 
VDOCom∂ëi⁄
 *
∑ª¡
,

280 
VDOA˘i⁄
 *
ˇŒback
,

281 
VDOA˘i⁄
 *
îr‹H™dÀr
,

282 
ThªadID
 
thªadID
);

294 
	`˛o£Re„ªn˚Cou¡s
(
RefCou¡s
 *
ªfCou¡s
,

295 
VDOCom∂ëi⁄
 *
∑ª¡
,

296 
VDOA˘i⁄
 *
ˇŒback
,

297 
VDOA˘i⁄
 *
îr‹H™dÀr
,

298 
ThªadID
 
thªadID
);

312 
	`lﬂdRe„ªn˚Blocks
(
RefCou¡s
 *
ªfCou¡s
,

313 
VDOCom∂ëi⁄
 *
∑ª¡
,

314 
VDOA˘i⁄
 *
ˇŒback
,

315 
VDOA˘i⁄
 *
îr‹H™dÀr
,

316 
ThªadID
 
thªadID
);

325 
	$dútyAŒRe„ªn˚Blocks
(
RefCou¡s
 *
ªfCou¡s
)

326 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

336 
	$acquúeDútyBlockLocks
(
RefCou¡s
 *
ªfCou¡s
)

337 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

344 
	`dumpRefCou¡s
(c⁄° 
RefCou¡s
 *
ªfCou¡s
);

	@vdo/base/refCountsInternals.h

22 #i‚de‡
REF_COUNTS_INTERNALS_H


23 
	#REF_COUNTS_INTERNALS_H


	)

25 
	~"ªfCou¡s.h
"

27 
	~"jou∫ÆPoöt.h
"

28 
	~"ª„ªn˚Block.h
"

29 
	~"¶ab.h
"

30 
	~"blockAŒoˇt‹I¡î«ls.h
"

31 
	~"waôQueue.h
"

36 
	eª„ªn˚Sètus
 {

37 
	mRS_FREE
,

38 
	mRS_SINGLE
,

39 
	mRS_SHARED
,

40 
	mRS_PROVISIONAL


41 } 
	tRe„ªn˚Sètus
;

46 
	s£¨chCurs‹
 {

48 
Re„ªn˚Block
 *
	mblock
;

50 
SœbBlockNumbî
 
	mödex
;

52 
SœbBlockNumbî
 
	mídIndex
;

55 
Re„ªn˚Block
 *
	mfú°Block
;

57 
Re„ªn˚Block
 *
	mœ°Block
;

58 } 
	tSórchCurs‹
;

69 
	sªfCou¡s
 {

70 
VDOCom∂ëi⁄
 
	mcom∂ëi⁄
;

73 
Sœb
 *
	m¶ab
;

76 
uöt32_t
 
	mblockCou¡
;

78 
uöt32_t
 
	m‰ìBlocks
;

80 
Re„ªn˚Cou¡
 *
	mcou¡îs
;

83 
SórchCurs‹
 
	m£¨chCurs‹
;

86 
WaôQueue
 
	mdútyBlocks
;

88 
size_t
 
	ma˘iveCou¡
;

91 
Waôî
 
	m¶abSumm¨yWaôî
;

93 
boﬁ
 
	mupd©ögSœbSumm¨y
;

95 
boﬁ
 
	mhasIOWaôî
;

97 
boﬁ
 
	m˛o£Reque°ed
;

100 
RódO∆yModeC⁄ãxt
 *
	mªadO∆yC⁄ãxt
;

102 
AtomicRefCou¡Sèti°ics
 *
	m°©i°ics
;

104 
PhysiˇlBlockNumbî
 
	m‹igö
;

106 
Jou∫ÆPoöt
 
	m¶abJou∫ÆPoöt
;

109 
uöt32_t
 
	mª„ªn˚BlockCou¡
;

111 
Re„ªn˚Block
 
	mblocks
[];

121 
__©åibuã__
((
w¨n_unu£d_ªsu…
))

122 
Re„ªn˚Sètus
 
ª„ªn˚Cou¡ToSètus
(
Re„ªn˚Cou¡
 
cou¡
);

131 
RefCou¡s
 *
	$asRefCou¡s
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

132 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

141 
Re„ªn˚Block
 *
	$gëRe„ªn˚Block
(
RefCou¡s
 *
ªfCou¡s
, 
SœbBlockNumbî
 
ödex
)

142 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

151 
Re„ªn˚Cou¡
 *
	$gëRe„ªn˚Cou¡îsF‹Block
(
Re„ªn˚Block
 *
block
)

152 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

161 
	`∑ckRe„ªn˚Block
(
Re„ªn˚Block
 *
block
, *
buf„r
);

173 
	$gëRe„ªn˚Sètus
(
RefCou¡s
 *
ªfCou¡s
,

174 
PhysiˇlBlockNumbî
 
pbn
,

175 
Re„ªn˚Sètus
 *
°©usPå
)

176 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

191 
boﬁ
 
	$födFªeBlock
(c⁄° 
RefCou¡s
 *
ªfCou¡s
,

192 
SœbBlockNumbî
 
°¨tIndex
,

193 
SœbBlockNumbî
 
ídIndex
,

194 
SœbBlockNumbî
 *
ödexPå
)

195 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

202 
	`ßveOlde°Re„ªn˚Block
(
RefCou¡s
 *
ªfCou¡s
);

209 
	`ª£tRe„ªn˚Cou¡s
(
RefCou¡s
 *
ªfCou¡s
);

	@vdo/base/referenceBlock.h

22 #i‚de‡
REFERENCE_BLOCK_H


23 
	#REFERENCE_BLOCK_H


	)

25 
	~"c⁄°™ts.h
"

26 
	~"jou∫ÆPoöt.h
"

27 
	~"ty≥s.h
"

28 
	~"waôQueue.h
"

33 
uöt8_t
 
	tRe„ªn˚Cou¡
;

39 
	mEMPTY_REFERENCE_COUNT
 = 0,

40 
	mMAXIMUM_REFERENCE_COUNT
 = 254,

41 
	mPROVISIONAL_REFERENCE_COUNT
 = 255,

45 
	mCOUNTS_PER_SECTOR
 = ((
VDO_SECTOR_SIZE
 - (
PackedJou∫ÆPoöt
))

46 / (
Re„ªn˚Cou¡
)),

47 
	mCOUNTS_PER_BLOCK
 = 
COUNTS_PER_SECTOR
 * 
SECTORS_PER_BLOCK
,

54 
PackedJou∫ÆPoöt
 
	mcommôPoöt
;

55 
Re„ªn˚Cou¡
 
	mcou¡s
[
COUNTS_PER_SECTOR
];

56 } 
	t__©åibuã__
((
	t∑cked
)Ë
	tPackedRe„ªn˚Se˘‹
;

59 
PackedRe„ªn˚Se˘‹
 
	m£˘‹s
[
SECTORS_PER_BLOCK
];

60 } 
	tPackedRe„ªn˚Block
;

69 
Waôî
 
	mwaôî
;

71 
RefCou¡s
 *
	mªfCou¡s
;

73 
BlockSize
 
	mÆloˇãdCou¡
;

75 
Sequí˚Numbî
 
	m¶abJou∫ÆLock
;

80 
Sequí˚Numbî
 
	m¶abJou∫ÆLockToRñó£
;

82 
Jou∫ÆPoöt
 
	mcommôPoöts
[
SECTORS_PER_BLOCK
];

84 
boﬁ
 
	misDúty
;

86 
boﬁ
 
	misWrôög
;

87 } 
	tRe„ªn˚Block
;

	@vdo/base/referenceCountRebuild.c

22 
	~"ª„ªn˚Cou¡Rebuûd.h
"

24 
	~"loggî.h
"

25 
	~"mem‹yAŒoc.h
"

27 
	~"blockM≠.h
"

28 
	~"blockM≠I¡î«ls.h
"

29 
	~"blockM≠Page.h
"

30 
	~"f‹e°.h
"

31 
	~"c⁄°™ts.h
"

32 
	~"numUtûs.h
"

33 
	~"ªfCou¡s.h
"

34 
	~"¶abDïŸ.h
"

35 
	~"vdoI¡î«l.h
"

36 
	~"vdoPageCache.h
"

46 
VDOCom∂ëi⁄
 
	mcom∂ëi⁄
;

48 
VDOCom∂ëi⁄
 
	msubTaskCom∂ëi⁄
;

50 
ThªadID
 
	mlogiˇlThªadID
;

52 
ThªadID
 
	madmöThªadID
;

54 
BlockM≠
 *
	mblockM≠
;

56 
SœbDïŸ
 *
	mdïŸ
;

58 
boﬁ
 
	mab‹ãd
;

60 
boﬁ
 
	mœunchög
;

62 
BlockCou¡
 *
	mlogiˇlBlocksU£d
;

64 
BlockCou¡
 *
	mblockM≠D©aBlocks
;

66 
PageCou¡
 
	m∑geToFëch
;

68 
PageCou¡
 
	mÀafPages
;

70 
BlockM≠SlŸ
 
	mœ°SlŸ
;

72 
PageCou¡
 
	mout°™dög
;

74 
PageCou¡
 
	m∑geCou¡
;

76 
VDOPageCom∂ëi⁄
 
	m∑geCom∂ëi⁄s
[];

77 } 
	tRebuûdCom∂ëi⁄
;

86 
__©åibuã__
((
w¨n_unu£d_ªsu…
))

87 
ölöe
 
RebuûdCom∂ëi⁄
 *
	$asRebuûdCom∂ëi⁄
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

89 
	`STATIC_ASSERT
(
	`off£tof
(
RebuûdCom∂ëi⁄
, 
com∂ëi⁄
) == 0);

90 
	`as£πCom∂ëi⁄Ty≥
(
com∂ëi⁄
->
ty≥
, 
REFERENCE_COUNT_REBUILD_COMPLETION
);

91  (
RebuûdCom∂ëi⁄
 *Ë
com∂ëi⁄
;

92 
	}
}

99 
	$‰ìRebuûdCom∂ëi⁄
(
VDOCom∂ëi⁄
 **
com∂ëi⁄På
)

101 
VDOCom∂ëi⁄
 *
com∂ëi⁄
 = *
com∂ëi⁄På
;

102 i‡(
com∂ëi⁄
 =
NULL
) {

106 
RebuûdCom∂ëi⁄
 *
ªbuûd
 = 
	`asRebuûdCom∂ëi⁄
(
com∂ëi⁄
);

107 
	`de°royEnqueuóbÀ
(&
ªbuûd
->
subTaskCom∂ëi⁄
);

108 
	`de°royEnqueuóbÀ
(
com∂ëi⁄
);

109 
	`FREE
(
ªbuûd
);

110 *
com∂ëi⁄På
 = 
NULL
;

111 
	}
}

119 
	$föishRebuûd
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

121 
ªsu…
 = 
com∂ëi⁄
->result;

122 
VDOCom∂ëi⁄
 *
∑ª¡
 = 
com∂ëi⁄
->parent;

123 
	`‰ìRebuûdCom∂ëi⁄
(&
com∂ëi⁄
);

124 
	`föishCom∂ëi⁄
(
∑ª¡
, 
ªsu…
);

125 
	}
}

139 
	$makeRebuûdCom∂ëi⁄
(
VDO
 *
vdo
,

140 
BlockCou¡
 *
logiˇlBlocksU£d
,

141 
BlockCou¡
 *
blockM≠D©aBlocks
,

142 
VDOCom∂ëi⁄
 *
∑ª¡
,

143 
RebuûdCom∂ëi⁄
 **
ªbuûdPå
)

145 
BlockM≠
 *
blockM≠
 = 
	`gëBlockM≠
(
vdo
);

146 
PageCou¡
 
∑geCou¡


147 
	`möPageCou¡
(
	`gëC⁄figuªdCacheSize
(
vdo
) >> 1,

148 
MAXIMUM_SIMULTANEOUS_BLOCK_MAP_RESTORATION_READS
);

150 
RebuûdCom∂ëi⁄
 *
ªbuûd
;

151 
ªsu…
 = 
	`ALLOCATE_EXTENDED
(
RebuûdCom∂ëi⁄
, 
∑geCou¡
,

152 
VDOPageCom∂ëi⁄
, 
__func__
, &
ªbuûd
);

153 i‡(
ªsu…
 !
UDS_SUCCESS
) {

154  
ªsu…
;

157 
ªsu…
 = 
	`öôülizeEnqueuóbÀCom∂ëi⁄
(&
ªbuûd
->
com∂ëi⁄
,

158 
REFERENCE_COUNT_REBUILD_COMPLETION
,

159 
vdo
->
œyî
);

160 i‡(
ªsu…
 !
VDO_SUCCESS
) {

161 
VDOCom∂ëi⁄
 *
com∂ëi⁄
 = &
ªbuûd
->completion;

162 
	`‰ìRebuûdCom∂ëi⁄
(&
com∂ëi⁄
);

163  
ªsu…
;

166 
ªsu…
 = 
	`öôülizeEnqueuóbÀCom∂ëi⁄
(&
ªbuûd
->
subTaskCom∂ëi⁄
,

167 
SUB_TASK_COMPLETION
, 
vdo
->
œyî
);

168 i‡(
ªsu…
 !
VDO_SUCCESS
) {

169 
VDOCom∂ëi⁄
 *
com∂ëi⁄
 = &
ªbuûd
->completion;

170 
	`‰ìRebuûdCom∂ëi⁄
(&
com∂ëi⁄
);

171  
ªsu…
;

174 
ªbuûd
->
blockM≠
 = blockMap;

175 
ªbuûd
->
dïŸ
 = 
vdo
->depot;

176 
ªbuûd
->
logiˇlBlocksU£d
 =ÜogicalBlocksUsed;

177 
ªbuûd
->
blockM≠D©aBlocks
 = blockMapDataBlocks;

178 
ªbuûd
->
∑geCou¡
 =ÖageCount;

179 
ªbuûd
->
ÀafPages
 = 
	`compuãBlockM≠PageCou¡
(
blockM≠
->
íåyCou¡
);

181 c⁄° 
ThªadC⁄fig
 *
thªadC⁄fig
 = 
	`gëThªadC⁄fig
(
vdo
);

182 
ªbuûd
->
logiˇlThªadID
 = 
	`gëLogiˇlZ⁄eThªad
(
thªadC⁄fig
, 0);

183 
ªbuûd
->
admöThªadID
 = 
	`gëAdmöThªad
(
thªadC⁄fig
);

185 
	`ASSERT_LOG_ONLY
((
	`gëCÆlbackThªadID
(Ë=
ªbuûd
->
logiˇlThªadID
),

186 "%†mu° bêˇŒed o¿logiˇ»thªad %u (nŸ %u)", 
__func__
,

187 
ªbuûd
->
logiˇlThªadID
, 
	`gëCÆlbackThªadID
());

188 
	`¥ï¨eCom∂ëi⁄
(&
ªbuûd
->
com∂ëi⁄
, 
föishRebuûd
, finishRebuild,

189 
ªbuûd
->
logiˇlThªadID
, 
∑ª¡
);

191 *
ªbuûdPå
 = 
ªbuûd
;

192  
VDO_SUCCESS
;

193 
	}
}

201 
	$ÊushBlockM≠Upd©es
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

203 
	`logInfo
("Flushing block map changes");

204 
	`¥ï¨eToFöishP¨ít
(
com∂ëi⁄
, com∂ëi⁄->
∑ª¡
);

205 
	`ÊushBlockM≠
(
	`asRebuûdCom∂ëi⁄
(
com∂ëi⁄
->
∑ª¡
)->
blockM≠
, completion);

206 
	}
}

216 
boﬁ
 
	$föishIfD⁄e
(
RebuûdCom∂ëi⁄
 *
ªbuûd
)

218 i‡(
ªbuûd
->
œunchög
 || (ªbuûd->
out°™dög
 > 0)) {

219  
Ál£
;

222 i‡(
ªbuûd
->
ab‹ãd
) {

223 
	`com∂ëeCom∂ëi⁄
(&
ªbuûd
->
com∂ëi⁄
);

224  
åue
;

227 i‡(
ªbuûd
->
∑geToFëch
 <Ñebuûd->
ÀafPages
) {

228  
Ál£
;

231 
	`¥ï¨eCom∂ëi⁄
(&
ªbuûd
->
subTaskCom∂ëi⁄
, 
ÊushBlockM≠Upd©es
,

232 
föishP¨ítCÆlback
, 
ªbuûd
->
admöThªadID
,Ñebuild);

233 
	`övokeCÆlback
(&
ªbuûd
->
subTaskCom∂ëi⁄
);

234  
åue
;

235 
	}
}

243 
	$ab‹tRebuûd
(
RebuûdCom∂ëi⁄
 *
ªbuûd
, 
ªsu…
)

245 
ªbuûd
->
ab‹ãd
 = 
åue
;

246 
	`£tCom∂ëi⁄Resu…
(&
ªbuûd
->
com∂ëi⁄
, 
ªsu…
);

247 
	}
}

254 
	$h™dÀPageLﬂdEº‹
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

256 
RebuûdCom∂ëi⁄
 *
ªbuûd
 = 
	`asRebuûdCom∂ëi⁄
(
com∂ëi⁄
->
∑ª¡
);

257 
ªbuûd
->
out°™dög
--;

258 
	`ab‹tRebuûd
(
ªbuûd
, 
com∂ëi⁄
->
ªsu…
);

259 
	`ªÀa£VDOPageCom∂ëi⁄
(
com∂ëi⁄
);

260 
	`föishIfD⁄e
(
ªbuûd
);

261 
	}
}

271 
	$ªbuûdRe„ªn˚Cou¡sFromPage
(
RebuûdCom∂ëi⁄
 *
ªbuûd
,

272 
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

274 
BlockM≠Page
 *
∑ge
 = 
	`dîe„ªn˚WrôabÀVDOPage
(
com∂ëi⁄
);

275 
ªsu…
 = 
	`ASSERT
(
∑ge
 !
NULL
, "pageávailable");

276 i‡(
ªsu…
 !
VDO_SUCCESS
) {

277  
ªsu…
;

280 i‡(!
∑ge
->
hódî
.
öôülized
) {

281  
VDO_SUCCESS
;

285 i‡(
∑ge
->
hódî
.
pbn
 =
ªbuûd
->
œ°SlŸ
.pbn) {

286 
SlŸNumbî
 
¶Ÿ
 = 
ªbuûd
->
œ°SlŸ
.slot;

287 
¶Ÿ
 < 
BLOCK_MAP_ENTRIES_PER_PAGE
; slot++) {

288 c⁄° 
BlockM≠E¡ry
 *
íåy
 = &
∑ge
->
íåõs
[
¶Ÿ
];

289 i‡(!
	`isUnm≠≥d
(
íåy
)) {

290 
	`ícodeBlockM≠E¡ry
(
∑ge
, 
¶Ÿ
, 
ZERO_BLOCK
, 
MAPPING_STATE_UNMAPPED
);

291 
	`ªque°VDOPageWrôe
(
com∂ëi⁄
);

297 
SlŸNumbî
 
¶Ÿ
 = 0; slŸ < 
BLOCK_MAP_ENTRIES_PER_PAGE
; slot++) {

298 c⁄° 
BlockM≠E¡ry
 *
íåy
 = &
∑ge
->
íåõs
[
¶Ÿ
];

299 i‡(
	`isInvÆid
(
íåy
)) {

301 
	`ícodeBlockM≠E¡ry
(
∑ge
, 
¶Ÿ
, 
ZERO_BLOCK
, 
MAPPING_STATE_UNMAPPED
);

302 
	`ªque°VDOPageWrôe
(
com∂ëi⁄
);

306 i‡(
	`isUnm≠≥d
(
íåy
)) {

310 (*
ªbuûd
->
logiˇlBlocksU£d
)++;

311 
PhysiˇlBlockNumbî
 
pbn
 = 
	`u≈ackOff£tPBN
(
íåy
, 
∑ge
->
hódî
.
íåyOff£t
);

312 i‡(
pbn
 =
ZERO_BLOCK
) {

316 i‡(!
	`isPhysiˇlD©aBlock
(
ªbuûd
->
dïŸ
, 
pbn
)) {

319 
	`ícodeBlockM≠E¡ry
(
∑ge
, 
¶Ÿ
, 
ZERO_BLOCK
, 
MAPPING_STATE_UNMAPPED
);

320 
	`ªque°VDOPageWrôe
(
com∂ëi⁄
);

324 
Sœb
 *
¶ab
 = 
	`gëSœb
(
ªbuûd
->
dïŸ
, 
pbn
);

325 
ªsu…
 = 
	`adju°Re„ªn˚Cou¡F‹Rebuûd
(
¶ab
->
ª„ªn˚Cou¡s
, 
pbn
,

326 
DATA_INCREMENT
);

327 i‡(
ªsu…
 !
VDO_SUCCESS
) {

328 
	`logEº‹WôhSåögEº‹
(
ªsu…
,

330 "PBN %" 
PRIu64
 ", slot %u mappedÅo PBN "

331 "%" 
PRIu64
, 
∑ge
->
hódî
.
pbn
, 
¶Ÿ
,Öbn);

332 
	`ícodeBlockM≠E¡ry
(
∑ge
, 
¶Ÿ
, 
ZERO_BLOCK
, 
MAPPING_STATE_UNMAPPED
);

333 
	`ªque°VDOPageWrôe
(
com∂ëi⁄
);

336  
VDO_SUCCESS
;

337 
	}
}

340 
„tchPage
(
RebuûdCom∂ëi⁄
 *
ªbuûd
, 
VDOCom∂ëi⁄
 *
com∂ëi⁄
);

348 
	$∑geLﬂded
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

350 
RebuûdCom∂ëi⁄
 *
ªbuûd
 = 
	`asRebuûdCom∂ëi⁄
(
com∂ëi⁄
->
∑ª¡
);

351 
ªbuûd
->
out°™dög
--;

353 
ªsu…
 = 
	`ªbuûdRe„ªn˚Cou¡sFromPage
(
ªbuûd
, 
com∂ëi⁄
);

354 i‡(
ªsu…
 !
VDO_SUCCESS
) {

355 
	`ab‹tRebuûd
(
ªbuûd
, 
ªsu…
);

358 
	`ªÀa£VDOPageCom∂ëi⁄
(
com∂ëi⁄
);

359 i‡(
	`föishIfD⁄e
(
ªbuûd
)) {

365 
	`„tchPage
(
ªbuûd
, 
com∂ëi⁄
);

366 
	}
}

374 
	$„tchPage
(
RebuûdCom∂ëi⁄
 *
ªbuûd
, 
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

376 
ªbuûd
->
∑geToFëch
 <Ñebuûd->
ÀafPages
) {

377 
PhysiˇlBlockNumbî
 
pbn
 = 
	`födBlockM≠PagePBN
(
ªbuûd
->
blockM≠
,

378 
ªbuûd
->
∑geToFëch
++);

379 i‡(
pbn
 =
ZERO_BLOCK
) {

383 i‡(!
	`isPhysiˇlD©aBlock
(
ªbuûd
->
dïŸ
, 
pbn
)) {

384 
	`ab‹tRebuûd
(
ªbuûd
, 
VDO_BAD_MAPPING
);

385 i‡(
	`föishIfD⁄e
(
ªbuûd
)) {

391 
	`öôVDOPageCom∂ëi⁄
(((
VDOPageCom∂ëi⁄
 *Ë
com∂ëi⁄
),

392 
ªbuûd
->
blockM≠
->
z⁄es
[0].
∑geCache
,

393 
pbn
, 
åue
, &
ªbuûd
->
com∂ëi⁄
,

394 
∑geLﬂded
, 
h™dÀPageLﬂdEº‹
);

395 
ªbuûd
->
out°™dög
++;

396 
	`gëVDOPageAsync
(
com∂ëi⁄
);

399 
	}
}

409 
	$ªbuûdFromLóves
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

411 
RebuûdCom∂ëi⁄
 *
ªbuûd
 = 
	`asRebuûdCom∂ëi⁄
(
com∂ëi⁄
->
∑ª¡
);

412 *
ªbuûd
->
logiˇlBlocksU£d
 = 0;

416 
ªbuûd
->
œ°SlŸ
 = (
BlockM≠SlŸ
) {

417 .
¶Ÿ
 = 
ªbuûd
->
blockM≠
->
íåyCou¡
 % 
BLOCK_MAP_ENTRIES_PER_PAGE
,

418 .
pbn
 = 
	`födBlockM≠PagePBN
(
ªbuûd
->
blockM≠
,Ñebuûd->
ÀafPages
 - 1),

422 
ªbuûd
->
œunchög
 = 
åue
;

423 
PageCou¡
 
i
 = 0; i < 
ªbuûd
->
∑geCou¡
; i++) {

424 
	`„tchPage
(
ªbuûd
, &ªbuûd->
∑geCom∂ëi⁄s
[
i
].
com∂ëi⁄
);

426 
ªbuûd
->
œunchög
 = 
Ál£
;

427 
	`föishIfD⁄e
(
ªbuûd
);

428 
	}
}

440 
	$¥o˚ssE¡ry
(
PhysiˇlBlockNumbî
 
pbn
, 
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

442 
RebuûdCom∂ëi⁄
 *
ªbuûd
 = 
	`asRebuûdCom∂ëi⁄
(
com∂ëi⁄
->
∑ª¡
);

443 i‡((
pbn
 =
ZERO_BLOCK
Ë|| !
	`isPhysiˇlD©aBlock
(
ªbuûd
->
dïŸ
,Öbn)) {

444  
	`logEº‹WôhSåögEº‹
(
VDO_BAD_CONFIGURATION
,

445 "PBN %" 
PRIu64
 " out ofÑange",

446 
pbn
);

449 
Sœb
 *
¶ab
 = 
	`gëSœb
(
ªbuûd
->
dïŸ
, 
pbn
);

450 
ªsu…
 = 
	`adju°Re„ªn˚Cou¡F‹Rebuûd
(
¶ab
->
ª„ªn˚Cou¡s
, 
pbn
,

451 
BLOCK_MAP_INCREMENT
);

452 i‡(
ªsu…
 !
VDO_SUCCESS
) {

453  
	`logEº‹WôhSåögEº‹
(
ªsu…
,

455 "block m≠ÅªêPBN %" 
PRIu64
,

456 
pbn
);

459 (*
ªbuûd
->
blockM≠D©aBlocks
)++;

460  
VDO_SUCCESS
;

461 
	}
}

464 
	$ªbuûdRe„ªn˚Cou¡s
(
VDO
 *
vdo
,

465 
VDOCom∂ëi⁄
 *
∑ª¡
,

466 
BlockCou¡
 *
logiˇlBlocksU£d
,

467 
BlockCou¡
 *
blockM≠D©aBlocks
)

469 
RebuûdCom∂ëi⁄
 *
ªbuûd
;

470 
ªsu…
 = 
	`makeRebuûdCom∂ëi⁄
(
vdo
, 
logiˇlBlocksU£d
,

471 
blockM≠D©aBlocks
, 
∑ª¡
, &
ªbuûd
);

472 i‡(
ªsu…
 !
VDO_SUCCESS
) {

473 
	`föishCom∂ëi⁄
(
∑ª¡
, 
ªsu…
);

479 
ªsu…
 = 
	`övÆid©eVDOPageCache
(
ªbuûd
->
blockM≠
->
z⁄es
[0].
∑geCache
);

480 i‡(
ªsu…
 !
VDO_SUCCESS
) {

481 
	`föishCom∂ëi⁄
(
∑ª¡
, 
ªsu…
);

486 *
ªbuûd
->
blockM≠D©aBlocks
 = 0;

487 
VDOCom∂ëi⁄
 *
com∂ëi⁄
 = &
ªbuûd
->
subTaskCom∂ëi⁄
;

488 
	`¥ï¨eCom∂ëi⁄
(
com∂ëi⁄
, 
ªbuûdFromLóves
, 
föishP¨ítCÆlback
,

489 
ªbuûd
->
logiˇlThªadID
,Ñebuild);

490 
	`åavî£F‹e°
(
ªbuûd
->
blockM≠
, 
¥o˚ssE¡ry
, 
com∂ëi⁄
);

491 
	}
}

	@vdo/base/referenceCountRebuild.h

22 #i‚de‡
REFERENCE_COUNT_REBUILD_H


23 
	#REFERENCE_COUNT_REBUILD_H


	)

25 
	~"ty≥s.h
"

37 
ªbuûdRe„ªn˚Cou¡s
(
VDO
 *
vdo
,

38 
VDOCom∂ëi⁄
 *
∑ª¡
,

39 
BlockCou¡
 *
logiˇlBlocksU£d
,

40 
BlockCou¡
 *
blockM≠D©aBlocks
);

	@vdo/base/referenceOperation.c

22 
	~"ª„ªn˚O≥øti⁄.h
"

24 
	~"physiˇlZ⁄e.h
"

25 
	~"ty≥s.h
"

28 
PBNLock
 *
	$ªtu∫PBNLock
(
Re„ªn˚O≥øti⁄
 
›î©i⁄
)

30  (
PBNLock
 *Ë
›î©i⁄
.
c⁄ãxt
;

31 
	}
}

34 
	$£tUpRe„ªn˚O≥øti⁄WôhLock
(
Jou∫ÆO≥øti⁄
 
ty≥
,

35 
PhysiˇlBlockNumbî
 
pbn
,

36 
BlockM≠pögSèã
 
°©e
,

37 
PBNLock
 *
lock
,

38 
Re„ªn˚O≥øti⁄
 *
›î©i⁄
)

40 *
›î©i⁄
 = (
Re„ªn˚O≥øti⁄
) {

41 .
ty≥
 =Åype,

42 .
pbn
 =Öbn,

43 .
°©e
 = state,

44 .
lockGëãr
 = 
ªtu∫PBNLock
,

45 .
c⁄ãxt
 = 
lock
,

47 
	}
}

50 
PBNLock
 *
	$lookUpPBNLock
(
Re„ªn˚O≥øti⁄
 
›î©i⁄
)

52  ((
›î©i⁄
.
c⁄ãxt
 =
NULL
)

53 ? 
NULL
 : 
	`gëPBNLock
(
›î©i⁄
.
c⁄ãxt
, o≥øti⁄.
pbn
));

54 
	}
}

57 
	$£tUpRe„ªn˚O≥øti⁄WôhZ⁄e
(
Jou∫ÆO≥øti⁄
 
ty≥
,

58 
PhysiˇlBlockNumbî
 
pbn
,

59 
BlockM≠pögSèã
 
°©e
,

60 
PhysiˇlZ⁄e
 *
z⁄e
,

61 
Re„ªn˚O≥øti⁄
 *
›î©i⁄
)

63 *
›î©i⁄
 = (
Re„ªn˚O≥øti⁄
) {

64 .
ty≥
 =Åype,

65 .
pbn
 =Öbn,

66 .
°©e
 = state,

67 .
lockGëãr
 = 
lookUpPBNLock
,

68 .
c⁄ãxt
 = 
z⁄e
,

70 
	}
}

	@vdo/base/referenceOperation.h

22 #i‚de‡
REFERENCE_OPERATION_H


23 
	#REFERENCE_OPERATION_H


	)

25 
	~"ty≥s.h
"

27 
ª„ªn˚O≥øti⁄
 
	tRe„ªn˚O≥øti⁄
;

37 
PBNLock
 *
	tPBNLockGëãr
(
	tRe„ªn˚O≥øti⁄
 
	t›î©i⁄
);

43 
	sª„ªn˚O≥øti⁄
 {

45 
Jou∫ÆO≥øti⁄
 
	mty≥
;

47 
PhysiˇlBlockNumbî
 
	mpbn
;

49 
BlockM≠pögSèã
 
	m°©e
;

51 
PBNLockGëãr
 *
	mlockGëãr
;

53 *
	mc⁄ãxt
;

64 
__©åibuã__
((
w¨n_unu£d_ªsu…
))

65 
ölöe


66 
PBNLock
 *
	$gëRe„ªn˚O≥øti⁄PBNLock
(
Re„ªn˚O≥øti⁄
 
›î©i⁄
)

68  ((
›î©i⁄
.
lockGëãr
 =
NULL
)

69 ? 
NULL
 : 
›î©i⁄
.
	`lockGëãr
(operation));

70 
	}
}

81 
£tUpRe„ªn˚O≥øti⁄WôhLock
(
Jou∫ÆO≥øti⁄
 
ty≥
,

82 
PhysiˇlBlockNumbî
 
pbn
,

83 
BlockM≠pögSèã
 
°©e
,

84 
PBNLock
 *
lock
,

85 
Re„ªn˚O≥øti⁄
 *
›î©i⁄
);

97 
£tUpRe„ªn˚O≥øti⁄WôhZ⁄e
(
Jou∫ÆO≥øti⁄
 
ty≥
,

98 
PhysiˇlBlockNumbî
 
pbn
,

99 
BlockM≠pögSèã
 
°©e
,

100 
PhysiˇlZ⁄e
 *
z⁄e
,

101 
Re„ªn˚O≥øti⁄
 *
›î©i⁄
);

	@vdo/base/releaseVersions.h

20 #i‚de‡
RELEASE_VERSIONS_H


21 
	#RELEASE_VERSIONS_H


	)

24 
	mOXYGEN_RELEASE_VERSION_NUMBER
 = 109583,

25 
	mFLUORINE_RELEASE_VERSION_NUMBER
 = 115838,

26 
	mNEON_RELEASE_VERSION_NUMBER
 = 120965,

27 
	mSODIUM_RELEASE_VERSION_NUMBER
 = 127441,

28 
	mHEAD_RELEASE_VERSION_NUMBER
 = 0,

29 
	mCURRENT_RELEASE_VERSION_NUMBER
 = 
HEAD_RELEASE_VERSION_NUMBER
,

	@vdo/base/ringNode.h

22 #i‚de‡
RING_NODE_H


23 
	#RING_NODE_H


	)

25 
	~"ty≥s.h
"

43 
rögNode
 
	tRögNode
;

45 
	srögNode
 {

46 
RögNode
 *
	m√xt
;

47 
RögNode
 *
	m¥ev
;

55 
ölöe
 
	$öôülizeRög
(
RögNode
 *
hód
)

57 
hód
->
√xt
 = hód->
¥ev
 = head;

58 
	}
}

67 
ölöe
 
boﬁ
 
	$isRögEm±y
(c⁄° 
RögNode
 *
hód
)

69  (
hód
->
√xt
 == head);

70 
	}
}

79 
ölöe
 
boﬁ
 
	$isRögSögÀt⁄
(c⁄° 
RögNode
 *
hód
)

81  (!
	`isRögEm±y
(
hód
Ë&& (hód->
¥ev
 =hód->
√xt
));

82 
	}
}

94 
ölöe
 
	$un•li˚RögChaö
(
RögNode
 *
fú°
,

95 
RögNode
 *
œ°
)

97 
fú°
->
¥ev
->
√xt
 = 
œ°
->next;

98 
œ°
->
√xt
->
¥ev
 = 
fú°
->prev;

99 
fú°
->
¥ev
 = 
œ°
;

100 
œ°
->
√xt
 = 
fú°
;

101 
	}
}

110 
ölöe
 
RögNode
 *
	$un•li˚RögNode
(
RögNode
 *
node
)

112 
	`un•li˚RögChaö
(
node
,Çode);

113  
node
;

114 
	}
}

130 
ölöe
 
	$•li˚RögChaöA·î
(
RögNode
 *
fú°
,

131 
RögNode
 *
œ°
,

132 
RögNode
 *
whîe
)

134 i‡(
œ°
->
√xt
 !
fú°
) {

135 
	`un•li˚RögChaö
(
fú°
, 
œ°
);

137 
œ°
->
√xt
 = 
whîe
->next;

138 
fú°
->
¥ev
 = 
whîe
;

139 
whîe
->
√xt
->
¥ev
 = 
œ°
;

140 
whîe
->
√xt
 = 
fú°
;

141 
	}
}

157 
ölöe
 
	$•li˚RögChaöBef‹e
(
RögNode
 *
fú°
,

158 
RögNode
 *
œ°
,

159 
RögNode
 *
whîe
)

161 i‡(
œ°
->
√xt
 !
fú°
) {

162 
	`un•li˚RögChaö
(
fú°
, 
œ°
);

164 
fú°
->
¥ev
 = 
whîe
->prev;

165 
œ°
->
√xt
 = 
whîe
;

166 
whîe
->
¥ev
->
√xt
 = 
fú°
;

167 
whîe
->
¥ev
 = 
œ°
;

168 
	}
}

176 
ölöe
 
	$pushRögNode
(
RögNode
 *
hód
, RögNodê*
node
)

178 
	`•li˚RögChaöBef‹e
(
node
,Çode, 
hód
);

179 
	}
}

189 
ölöe
 
RögNode
 *
	$p›RögNode
(
RögNode
 *
hód
)

191  (
	`isRögEm±y
(
hód
Ë? 
NULL
 : 
	`un•li˚RögNode
(hód->
¥ev
));

192 
	}
}

197 
ölöe
 
RögNode
 *
	$ch›RögNode
(
RögNode
 *
hód
)

199  (
	`isRögEm±y
(
hód
Ë? 
NULL
 : 
	`un•li˚RögNode
(hód->
√xt
));

200 
	}
}

	@vdo/base/slab.c

22 
	~"¶ab.h
"

24 
	~"loggî.h
"

25 
	~"mem‹yAŒoc.h
"

27 
	~"blockAŒoˇt‹I¡î«ls.h
"

28 
	~"c⁄°™ts.h
"

29 
	~"numUtûs.h
"

30 
	~"pbnLock.h
"

31 
	~"ªcovîyJou∫Æ.h
"

32 
	~"ªfCou¡s.h
"

33 
	~"¶abDïŸ.h
"

34 
	~"¶abJou∫Æ.h
"

35 
	~"¶abJou∫ÆI¡î«ls.h
"

36 
	~"¶abSumm¨y.h
"

39 
	$c⁄figuªSœb
(
BlockCou¡
 
¶abSize
,

40 
BlockCou¡
 
¶abJou∫ÆBlocks
,

41 
SœbC⁄fig
 *
¶abC⁄fig
)

43 i‡(
¶abJou∫ÆBlocks
 >
¶abSize
) {

44  
VDO_BAD_CONFIGURATION
;

52 
BlockCou¡
 
ªfBlocks


53 
	`gëSavedRe„ªn˚Cou¡Size
(
¶abSize
 - 
¶abJou∫ÆBlocks
);

54 
BlockCou¡
 
mëaBlocks
 = (
ªfBlocks
 + 
¶abJou∫ÆBlocks
);

57 i‡(
mëaBlocks
 >
¶abSize
) {

58  
VDO_BAD_CONFIGURATION
;

73 
BlockCou¡
 
d©aBlocks
 = 
¶abSize
 - 
mëaBlocks
;

74 i‡((
¶abSize
 < 1024Ë&& !
	`isPowîOfTwo
(
d©aBlocks
)) {

75 
d©aBlocks
 = (1 << 
	`logBa£Two
(dataBlocks));

82 
BlockCou¡
 
ÊushögThªshﬁd
 = ((
¶abJou∫ÆBlocks
 * 3) + 3) / 4;

88 
BlockCou¡
 
ªmaöög
 = 
¶abJou∫ÆBlocks
 - 
ÊushögThªshﬁd
;

89 
BlockCou¡
 
blockögThªshﬁd
 = 
ÊushögThªshﬁd
 + ((
ªmaöög
 * 5) / 7);

94 
BlockCou¡
 
möimÆExåaS∑˚


95 1 + (
MAXIMUM_USER_VIOS
 / 
SLAB_JOURNAL_FULL_ENTRIES_PER_BLOCK
);

96 
BlockCou¡
 
s¸ubbögThªshﬁd
 = 
blockögThªshﬁd
;

97 i‡(
¶abJou∫ÆBlocks
 > 
möimÆExåaS∑˚
) {

98 
s¸ubbögThªshﬁd
 = 
¶abJou∫ÆBlocks
 - 
möimÆExåaS∑˚
;

100 i‡(
blockögThªshﬁd
 > 
s¸ubbögThªshﬁd
) {

101 
blockögThªshﬁd
 = 
s¸ubbögThªshﬁd
;

104 *
¶abC⁄fig
 = (
SœbC⁄fig
) {

105 .
¶abBlocks
 = 
¶abSize
,

106 .
d©aBlocks
 = dataBlocks,

107 .
ª„ªn˚Cou¡Blocks
 = 
ªfBlocks
,

108 .
¶abJou∫ÆBlocks
 = slabJournalBlocks,

109 .
¶abJou∫ÆFlushögThªshﬁd
 = 
ÊushögThªshﬁd
,

110 .
¶abJou∫ÆBlockögThªshﬁd
 = 
blockögThªshﬁd
,

111 .
¶abJou∫ÆS¸ubbögThªshﬁd
 = 
s¸ubbögThªshﬁd


113  
VDO_SUCCESS
;

114 
	}
}

117 
PhysiˇlBlockNumbî
 
	$gëSœbJou∫ÆSèπBlock
(c⁄° 
SœbC⁄fig
 *
¶abC⁄fig
,

118 
PhysiˇlBlockNumbî
 
‹igö
)

120  
‹igö
 + 
¶abC⁄fig
->
d©aBlocks
 + sœbC⁄fig->
ª„ªn˚Cou¡Blocks
;

121 
	}
}

124 
	$makeSœb
(
PhysiˇlBlockNumbî
 
¶abOrigö
,

125 
BlockAŒoˇt‹
 *
Æloˇt‹
,

126 
PhysiˇlBlockNumbî
 
å™¶©i⁄
,

127 
RecovîyJou∫Æ
 *
ªcovîyJou∫Æ
,

128 
PhysiˇlLayî
 *
œyî
,

129 
SœbCou¡
 
¶abNumbî
,

130 
Sœb
 **
¶abPå
)

132 
Sœb
 *
¶ab
;

133 
ªsu…
 = 
	`ALLOCATE
(1, 
Sœb
, 
__func__
, &
¶ab
);

134 i‡(
ªsu…
 !
VDO_SUCCESS
) {

135  
ªsu…
;

138 c⁄° 
SœbC⁄fig
 *
¶abC⁄fig
 = 
	`gëSœbC⁄fig
(
Æloˇt‹
->
dïŸ
);

140 
¶ab
->
Æloˇt‹
 =állocator;

141 
¶ab
->
°¨t
 = 
¶abOrigö
;

142 
¶ab
->
íd
 = sœb->
°¨t
 + 
¶abC⁄fig
->
¶abBlocks
;

143 
¶ab
->
¶abNumbî
 = slabNumber;

144 
	`öôülizeRög
(&
¶ab
->
rögNode
);

146 
¶ab
->
ªfCou¡sOrigö
 = 
¶abOrigö
 + 
¶abC⁄fig
->
d©aBlocks
 + 
å™¶©i⁄
;

147 
¶ab
->
jou∫ÆOrigö
 = (
	`gëSœbJou∫ÆSèπBlock
(
¶abC⁄fig
, 
¶abOrigö
)

148 + 
å™¶©i⁄
);

150 
ªsu…
 = 
	`makeSœbJou∫Æ
(
Æloˇt‹
, 
¶ab
, 
œyî
, 
ªcovîyJou∫Æ
,

151 &
¶ab
->
jou∫Æ
);

152 i‡(
ªsu…
 !
VDO_SUCCESS
) {

153 
	`‰ìSœb
(&
¶ab
);

154  
ªsu…
;

157 *
¶abPå
 = 
¶ab
;

158  
VDO_SUCCESS
;

159 
	}
}

162 
	$ÆloˇãRefCou¡sF‹Sœb
(
PhysiˇlLayî
 *
œyî
, 
Sœb
 *
¶ab
)

164 
BlockAŒoˇt‹
 *
Æloˇt‹
 = 
¶ab
->allocator;

165 c⁄° 
SœbC⁄fig
 *
¶abC⁄fig
 = 
	`gëSœbC⁄fig
(
Æloˇt‹
->
dïŸ
);

167 
ªsu…
 = 
	`ASSERT
(
¶ab
->
ª„ªn˚Cou¡s
 =
NULL
,

169 
¶ab
->
¶abNumbî
);

170 i‡(
ªsu…
 !
VDO_SUCCESS
) {

171  
ªsu…
;

174 
ªsu…
 = 
	`makeRefCou¡s
(
œyî
, 
¶abC⁄fig
->
d©aBlocks
, 
¶ab
,

175 
¶ab
->
ªfCou¡sOrigö
,

176 
Æloˇt‹
->
ªadO∆yC⁄ãxt
,

177 &
¶ab
->
ª„ªn˚Cou¡s
);

178  
ªsu…
;

179 
	}
}

182 
	$‰ìSœb
(
Sœb
 **
¶abPå
)

184 
Sœb
 *
¶ab
 = *
¶abPå
;

185 i‡(
¶ab
 =
NULL
) {

189 
	`un•li˚RögNode
(&
¶ab
->
rögNode
);

190 
	`‰ìSœbJou∫Æ
(&
¶ab
->
jou∫Æ
);

191 
	`‰ìRefCou¡s
(&
¶ab
->
ª„ªn˚Cou¡s
);

192 
	`FREE
(
¶ab
);

193 *
¶abPå
 = 
NULL
;

194 
	}
}

197 
Z⁄eCou¡
 
	$gëSœbZ⁄eNumbî
(
Sœb
 *
¶ab
)

199  
¶ab
->
Æloˇt‹
->
z⁄eNumbî
;

200 
	}
}

203 
	$m¨kSœbRïœyög
(
Sœb
 *
¶ab
)

205 i‡(
¶ab
->
°©us
 =
SLAB_REBUILT
) {

206 
¶ab
->
°©us
 = 
SLAB_REPLAYING
;

208 
	}
}

211 
	$m¨kSœbUƒecovîed
(
Sœb
 *
¶ab
)

213 
¶ab
->
°©us
 = 
SLAB_REQUIRES_SCRUBBING
;

214 
	}
}

217 
BlockCou¡
 
	$gëSœbFªeBlockCou¡
(c⁄° 
Sœb
 *
¶ab
)

219  
	`gëUƒe„ªn˚dBlockCou¡
(
¶ab
->
ª„ªn˚Cou¡s
);

220 
	}
}

223 
	$modifySœbRe„ªn˚Cou¡
(
Sœb
 *
¶ab
,

224 c⁄° 
Jou∫ÆPoöt
 *
jou∫ÆPoöt
,

225 
Re„ªn˚O≥øti⁄
 
›î©i⁄
)

227 i‡(
¶ab
 =
NULL
) {

228  
VDO_SUCCESS
;

236 i‡(
	`isUƒecovîedSœb
(
¶ab
)) {

237 
Sequí˚Numbî
 
íåyLock
 = 
jou∫ÆPoöt
->
£quí˚Numbî
;

238 
	`adju°SœbJou∫ÆBlockRe„ªn˚
(
¶ab
->
jou∫Æ
, 
íåyLock
, -1);

239  
VDO_SUCCESS
;

242 
boﬁ
 
‰ìSètusCh™ged
;

243 
ªsu…
 = 
	`adju°Re„ªn˚Cou¡
(
¶ab
->
ª„ªn˚Cou¡s
, 
›î©i⁄
,

244 
jou∫ÆPoöt
, &
‰ìSètusCh™ged
);

245 i‡(
ªsu…
 !
VDO_SUCCESS
) {

246  
ªsu…
;

249 i‡(
‰ìSètusCh™ged
) {

250 
	`adju°FªeBlockCou¡
(
¶ab
, !
	`isIn¸emítO≥øti⁄
(
›î©i⁄
.
ty≥
));

253  
VDO_SUCCESS
;

254 
	}
}

257 
	$acquúeProvisi⁄ÆRe„ªn˚
(
Sœb
 *
¶ab
,

258 
PhysiˇlBlockNumbî
 
pbn
,

259 
PBNLock
 *
lock
)

261 i‡(
	`hasProvisi⁄ÆRe„ªn˚
(
lock
)) {

262  
VDO_SUCCESS
;

265 
ªsu…
 = 
	`¥ovisi⁄ÆlyRe„ªn˚Block
(
¶ab
->
ª„ªn˚Cou¡s
, 
pbn
, 
lock
);

266 i‡(
ªsu…
 !
VDO_SUCCESS
) {

267  
ªsu…
;

270 i‡(
	`hasProvisi⁄ÆRe„ªn˚
(
lock
)) {

271 
	`adju°FªeBlockCou¡
(
¶ab
, 
Ál£
);

274  
VDO_SUCCESS
;

275 
	}
}

278 
	$¶abBlockNumbîFromPBN
(
Sœb
 *
¶ab
,

279 
PhysiˇlBlockNumbî
 
physiˇlBlockNumbî
,

280 
SœbBlockNumbî
 *
¶abBlockNumbîPå
)

282 i‡(
physiˇlBlockNumbî
 < 
¶ab
->
°¨t
) {

283  
VDO_OUT_OF_RANGE
;

286 
uöt64_t
 
¶abBlockNumbî
 = 
physiˇlBlockNumbî
 - 
¶ab
->
°¨t
;

287 i‡(
¶abBlockNumbî
 >
	`gëSœbC⁄fig
(
¶ab
->
Æloˇt‹
->
dïŸ
)->
d©aBlocks
) {

288  
VDO_OUT_OF_RANGE
;

291 *
¶abBlockNumbîPå
 = 
¶abBlockNumbî
;

292  
VDO_SUCCESS
;

293 
	}
}

296 
boﬁ
 
	$shouldSaveFuŒyBuûtSœb
(c⁄° 
Sœb
 *
¶ab
)

300 
BlockCou¡
 
d©aBlocks
 = 
	`gëSœbC⁄fig
(
¶ab
->
Æloˇt‹
->
dïŸ
)->dataBlocks;

301  (
	`mu°LﬂdRefCou¡s
(
¶ab
->
Æloˇt‹
->
summ¨y
, sœb->
¶abNumbî
)

302 || (
	`gëSœbFªeBlockCou¡
(
¶ab
Ë!
d©aBlocks
)

303 || !
	`isSœbJou∫ÆBœnk
(
¶ab
->
jou∫Æ
));

304 
	}
}

307 c⁄° *
	$°©usToSåög
(
SœbRebuûdSètus
 
°©us
)

309 
°©us
) {

310 
SLAB_REBUILT
:

312 
SLAB_REQUIRES_SCRUBBING
:

314 
SLAB_REQUIRES_HIGH_PRIORITY_SCRUBBING
:

316 
SLAB_REBUILDING
:

318 
SLAB_REPLAYING
:

323 
	}
}

326 
	$dumpSœb
(c⁄° 
Sœb
 *
¶ab
)

328 i‡(
¶ab
->
ª„ªn˚Cou¡s
 !
NULL
) {

330 
	`logInfo
("¶ab %u: P%u, %" 
PRIu64
 " free",

331 
¶ab
->
¶abNumbî
, sœb->
¥i‹ôy
, 
	`gëSœbFªeBlockCou¡
(slab));

333 
	`logInfo
("¶ab %u: sètu†%s", 
¶ab
->
¶abNumbî
,

334 
	`°©usToSåög
(
¶ab
->
°©us
));

337 
	`dumpSœbJou∫Æ
(
¶ab
->
jou∫Æ
);

339 i‡(
¶ab
->
ª„ªn˚Cou¡s
 !
NULL
) {

340 
	`dumpRefCou¡s
(
¶ab
->
ª„ªn˚Cou¡s
);

342 
	`logInfo
("refCounts isÇull");

344 
	}
}

	@vdo/base/slab.h

22 #i‚de‡
VDO_SLAB_H


23 
	#VDO_SLAB_H


	)

25 
	~"≥rmas£π.h
"

27 
	~"fixedLayout.h
"

28 
	~"jou∫ÆPoöt.h
"

29 
	~"ª„ªn˚O≥øti⁄.h
"

30 
	~"rögNode.h
"

31 
	~"ty≥s.h
"

33 
uöt32_t
 
	tSœbBlockNumbî
;

36 
	mSLAB_REBUILT
 = 0,

37 
	mSLAB_REPLAYING
,

38 
	mSLAB_REQUIRES_SCRUBBING
,

39 
	mSLAB_REQUIRES_HIGH_PRIORITY_SCRUBBING
,

40 
	mSLAB_REBUILDING
,

41 } 
	tSœbRebuûdSètus
;

50 
	svdoSœb
 {

52 
RögNode
 
	mrögNode
;

55 
BlockAŒoˇt‹
 *
	mÆloˇt‹
;

58 
RefCou¡s
 *
	mª„ªn˚Cou¡s
;

60 
SœbJou∫Æ
 *
	mjou∫Æ
;

63 
SœbCou¡
 
	m¶abNumbî
;

65 
PhysiˇlBlockNumbî
 
	m°¨t
;

67 
PhysiˇlBlockNumbî
 
	míd
;

69 
PhysiˇlBlockNumbî
 
	mjou∫ÆOrigö
;

71 
PhysiˇlBlockNumbî
 
	mªfCou¡sOrigö
;

74 
SœbRebuûdSètus
 
	m°©us
;

76 
boﬁ
 
	mwasQueuedF‹S¸ubbög
;

79 
uöt8_t
 
	m¥i‹ôy
;

91 
	$c⁄figuªSœb
(
BlockCou¡
 
¶abSize
,

92 
BlockCou¡
 
¶abJou∫ÆBlocks
,

93 
SœbC⁄fig
 *
¶abC⁄fig
)

94 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

103 
ölöe
 
Sœb
 *
	$¶abFromRögNode
(
RögNode
 *
rögNode
)

105 
	`STATIC_ASSERT
(
	`off£tof
(
Sœb
, 
rögNode
) == 0);

106  (
Sœb
 *Ë
rögNode
;

107 
	}
}

116 
__©åibuã__
((
w¨n_unu£d_ªsu…
))

117 
PhysiˇlBlockNumbî
 
gëSœbJou∫ÆSèπBlock
(c⁄° 
SœbC⁄fig
 *
¶abC⁄fig
,

118 
PhysiˇlBlockNumbî
 
‹igö
);

137 
	$makeSœb
(
PhysiˇlBlockNumbî
 
¶abOrigö
,

138 
BlockAŒoˇt‹
 *
Æloˇt‹
,

139 
PhysiˇlBlockNumbî
 
å™¶©i⁄
,

140 
RecovîyJou∫Æ
 *
ªcovîyJou∫Æ
,

141 
PhysiˇlLayî
 *
œyî
,

142 
SœbCou¡
 
¶abNumbî
,

143 
Sœb
 **
¶abPå
)

144 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

154 
	$ÆloˇãRefCou¡sF‹Sœb
(
PhysiˇlLayî
 *
œyî
, 
Sœb
 *
¶ab
)

155 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

162 
	`‰ìSœb
(
Sœb
 **
¶abPå
);

171 
Z⁄eCou¡
 
	$gëSœbZ⁄eNumbî
(
Sœb
 *
¶ab
)

172 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

181 
ölöe
 
boﬁ
 
	$isUƒecovîedSœb
(c⁄° 
Sœb
 *
¶ab
)

183  (
¶ab
->
°©us
 !
SLAB_REBUILT
);

184 
	}
}

193 
ölöe
 
boﬁ
 
	$isRïœyögSœb
(c⁄° 
Sœb
 *
¶ab
)

195  (
¶ab
->
°©us
 =
SLAB_REPLAYING
);

196 
	}
}

205 
ölöe
 
boﬁ
 
	$¶abIsRebuûdög
(c⁄° 
Sœb
 *
¶ab
)

207  (
¶ab
->
°©us
 =
SLAB_REBUILDING
);

208 
	}
}

215 
m¨kSœbRïœyög
(
Sœb
 *
¶ab
);

222 
m¨kSœbUƒecovîed
(
Sœb
 *
¶ab
);

231 
BlockCou¡
 
	$gëSœbFªeBlockCou¡
(c⁄° 
Sœb
 *
¶ab
)

232 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

244 
	$modifySœbRe„ªn˚Cou¡
(
Sœb
 *
¶ab
,

245 c⁄° 
Jou∫ÆPoöt
 *
jou∫ÆPoöt
,

246 
Re„ªn˚O≥øti⁄
 
›î©i⁄
)

247 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

259 
	$acquúeProvisi⁄ÆRe„ªn˚
(
Sœb
 *
¶ab
,

260 
PhysiˇlBlockNumbî
 
pbn
,

261 
PBNLock
 *
lock
)

262 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

273 
	$¶abBlockNumbîFromPBN
(
Sœb
 *
¶ab
,

274 
PhysiˇlBlockNumbî
 
physiˇlBlockNumbî
,

275 
SœbBlockNumbî
 *
¶abBlockNumbîPå
)

276 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

286 
boﬁ
 
	$shouldSaveFuŒyBuûtSœb
(c⁄° 
Sœb
 *
¶ab
)

287 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

294 
	`dumpSœb
(c⁄° 
Sœb
 *
¶ab
);

	@vdo/base/slabCompletion.c

22 
	~"¶abCom∂ëi⁄.h
"

24 
	~"mem‹yAŒoc.h
"

26 
	~"blockAŒoˇt‹.h
"

27 
	~"exã¡.h
"

28 
	~"ªfCou¡sI¡î«ls.h
"

29 
	~"¶ab.h
"

30 
	~"¶abJou∫ÆI¡î«ls.h
"

31 
	~"ty≥s.h
"

46 
¶abCom∂ëi⁄
 
	tSœbCom∂ëi⁄
;

58 
	tSœbJou∫ÆPª∑ªr
(
	tSœbJou∫Æ
 *
	t¶abJou∫Æ
,

59 
	tVDOCom∂ëi⁄
 *
	t∑ª¡
,

60 
	tVDOA˘i⁄
 *
	tˇŒback
,

61 
	tVDOA˘i⁄
 *
	tîr‹H™dÀr
,

62 
	tThªadID
 
	tthªadID
);

72 
boﬁ
 
	tSœbSètusCheckî
(c⁄° 
	tSœb
 *
	t¶ab
);

83 
	tRe„ªn˚Cou¡IO
(
	tRefCou¡s
 *
	tªfCou¡s
,

84 
	tVDOCom∂ëi⁄
 *
	t∑ª¡
,

85 
	tVDOA˘i⁄
 *
	tˇŒback
,

86 
	tVDOA˘i⁄
 *
	tîr‹H™dÀr
,

87 
	tThªadID
 
	tthªadID
);

97 
	tRe„ªn˚Cou¡IOFöishî
(
	tSœb
 *
	t¶ab
,

98 
	tSœbCom∂ëi⁄
 *
	t¶abCom∂ëi⁄
);

100 
	s¶abCom∂ëi⁄
 {

101 
VDOCom∂ëi⁄
 
	mcom∂ëi⁄
;

102 
SœbSètusCheckî
 *
	m√edsRefCou¡IO
;

103 
Re„ªn˚Cou¡IO
 *
	mdoRefCou¡IO
;

104 
Re„ªn˚Cou¡IOFöishî
 *
	mªfCou¡sIOFöished
;

107 
SœbIãøt‹
 
	môî©‹
;

110 
SœbCou¡
 
	m¶absRemaöög
;

112 
ThªadID
 
	mthªadID
;

122 
__©åibuã__
((
w¨n_unu£d_ªsu…
))

123 
SœbCom∂ëi⁄
 *
	$asSœbCom∂ëi⁄
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

125 
	`STATIC_ASSERT
(
	`off£tof
(
SœbCom∂ëi⁄
, 
com∂ëi⁄
) == 0);

126 
	`as£πCom∂ëi⁄Ty≥
(
com∂ëi⁄
->
ty≥
, 
SLAB_COMPLETION
);

127  (
SœbCom∂ëi⁄
 *Ë
com∂ëi⁄
;

128 
	}
}

138 
	$föishRefCou¡sIO
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

140 
Sœb
 *
¶ab
 = 
	`asRefCou¡s
(
com∂ëi⁄
)->slab;

141 
SœbCom∂ëi⁄
 *
¶abCom∂ëi⁄
 = 
	`asSœbCom∂ëi⁄
(
com∂ëi⁄
->
∑ª¡
);

142 
¶abCom∂ëi⁄
->
	`ªfCou¡sIOFöished
(
¶ab
, slabCompletion);

143 
	}
}

150 
	$h™dÀRefCou¡sIOEº‹
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

152 
	`£tCom∂ëi⁄Resu…
(
com∂ëi⁄
->
∑ª¡
, com∂ëi⁄->
ªsu…
);

153 
	`föishRefCou¡sIO
(
com∂ëi⁄
);

154 
	}
}

162 
	$doRefCou¡IO
(
SœbCom∂ëi⁄
 *
¶abCom∂ëi⁄
, 
Sœb
 *
¶ab
)

164 i‡((
¶abCom∂ëi⁄
->
com∂ëi⁄
.
ªsu…
 !
VDO_SUCCESS
)

165 || !
¶abCom∂ëi⁄
->
	`√edsRefCou¡IO
(
¶ab
)) {

167 
¶abCom∂ëi⁄
->
	`ªfCou¡sIOFöished
(
¶ab
, slabCompletion);

171 
¶abCom∂ëi⁄
->
	`doRefCou¡IO
(
¶ab
->
ª„ªn˚Cou¡s
,

172 &
¶abCom∂ëi⁄
->
com∂ëi⁄
, 
föishRefCou¡sIO
,

173 
h™dÀRefCou¡sIOEº‹
,

174 
¶abCom∂ëi⁄
->
thªadID
);

175 
	}
}

183 
	$föishTaûBlockIO
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

185 
SœbCom∂ëi⁄
 *
¶abCom∂ëi⁄
 = 
	`asSœbCom∂ëi⁄
(
com∂ëi⁄
->
∑ª¡
);

186 
Sœb
 *
¶ab
 = 
	`asSœbJou∫Æ
(
com∂ëi⁄
)->slab;

187 
	`doRefCou¡IO
(
¶abCom∂ëi⁄
, 
¶ab
);

188 
	}
}

195 
	$h™dÀSœbJou∫ÆEº‹
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

197 
	`£tCom∂ëi⁄Resu…
(
com∂ëi⁄
->
∑ª¡
, com∂ëi⁄->
ªsu…
);

198 
	`föishTaûBlockIO
(
com∂ëi⁄
);

199 
	}
}

208 
	$œunchSœbIO
(
SœbCom∂ëi⁄
 *
¶abCom∂ëi⁄
,

209 
SœbJou∫ÆPª∑ªr
 *
¥ï¨eSœbJou∫Æ
)

211 
VDOCom∂ëi⁄
 *
com∂ëi⁄
 = &
¶abCom∂ëi⁄
->completion;

212 
¶abCom∂ëi⁄
->
thªadID
 = 
	`gëCÆlbackThªadID
();

213 
¶abCom∂ëi⁄
->
¶absRemaöög
 = 0;

214 
	`hasNextSœb
(&
¶abCom∂ëi⁄
->
ôî©‹
)) {

215 
Sœb
 *
¶ab
 = 
	`√xtSœb
(&
¶abCom∂ëi⁄
->
ôî©‹
);

216 
¶abCom∂ëi⁄
->
¶absRemaöög
++;

217 
	`un•li˚RögNode
(&
¶ab
->
rögNode
);

218 i‡(
¥ï¨eSœbJou∫Æ
 =
NULL
) {

219 
	`doRefCou¡IO
(
¶abCom∂ëi⁄
, 
¶ab
);

221 (*
¥ï¨eSœbJou∫Æ
)(
¶ab
->
jou∫Æ
, 
com∂ëi⁄
, 
föishTaûBlockIO
,

222 
h™dÀSœbJou∫ÆEº‹
, 
¶abCom∂ëi⁄
->
thªadID
);

225 
	}
}

228 
	$makeSœbCom∂ëi⁄
(
PhysiˇlLayî
 *
œyî
, 
VDOCom∂ëi⁄
 **
com∂ëi⁄På
)

230 
SœbCom∂ëi⁄
 *
¶abCom∂ëi⁄
;

231 
ªsu…
 = 
	`ALLOCATE
(1, 
SœbCom∂ëi⁄
, 
__func__
, &
¶abCom∂ëi⁄
);

232 i‡(
ªsu…
 !
VDO_SUCCESS
) {

233  
ªsu…
;

236 
ªsu…
 = 
	`öôülizeEnqueuóbÀCom∂ëi⁄
(&
¶abCom∂ëi⁄
->
com∂ëi⁄
,

237 
SLAB_COMPLETION
, 
œyî
);

238 i‡(
ªsu…
 !
VDO_SUCCESS
) {

239 
VDOCom∂ëi⁄
 *
com∂ëi⁄
 = &
¶abCom∂ëi⁄
->completion;

240 
	`‰ìSœbCom∂ëi⁄
(&
com∂ëi⁄
);

241  
ªsu…
;

244 *
com∂ëi⁄På
 = &
¶abCom∂ëi⁄
->
com∂ëi⁄
;

245  
VDO_SUCCESS
;

246 
	}
}

249 
	$‰ìSœbCom∂ëi⁄
(
VDOCom∂ëi⁄
 **
com∂ëi⁄På
)

251 i‡(*
com∂ëi⁄På
 =
NULL
) {

255 
SœbCom∂ëi⁄
 *
¶abCom∂ëi⁄
 = 
	`asSœbCom∂ëi⁄
(*
com∂ëi⁄På
);

256 
	`de°royEnqueuóbÀ
(&
¶abCom∂ëi⁄
->
com∂ëi⁄
);

257 
	`FREE
(
¶abCom∂ëi⁄
);

258 *
com∂ëi⁄På
 = 
NULL
;

259 
	}
}

270 
¶abFöished
(
Sœb
 *
¶ab
 
__©åibuã__
((
unu£d
)),

271 
SœbCom∂ëi⁄
 *
¶abCom∂ëi⁄
)

273 --
	g¶abCom∂ëi⁄
->
	g¶absRemaöög
;

274 i‡(!
hasNextSœb
(&
¶abCom∂ëi⁄
->
ôî©‹
)

275 && (
	g¶abCom∂ëi⁄
->
	g¶absRemaöög
 == 0)) {

276 
föishCom∂ëi⁄
(&
¶abCom∂ëi⁄
->
com∂ëi⁄
, 
VDO_SUCCESS
);

287 
boﬁ
 
	$shouldSaveRe„ªn˚Cou¡s
(c⁄° 
Sœb
 *
¶ab
)

290  !
	`isUƒecovîedSœb
(
¶ab
);

291 
	}
}

298 
	$nŸeSœbIsClo£d
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

300 
	`£tCom∂ëi⁄Resu…
(
com∂ëi⁄
->
∑ª¡
, com∂ëi⁄->
ªsu…
);

301 
	`¶abFöished
(
NULL
, 
	`asSœbCom∂ëi⁄
(
com∂ëi⁄
->
∑ª¡
));

302 
	}
}

312 
	$waôF‹Re„ªn˚Cou¡sClo£d
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

314 
VDOCom∂ëi⁄
 *
∑ª¡
 = 
com∂ëi⁄
->parent;

315 
	`£tCom∂ëi⁄Resu…
(
∑ª¡
, 
com∂ëi⁄
->
ªsu…
);

317 
Sœb
 *
¶ab
 = 
	`asSœbJou∫Æ
(
com∂ëi⁄
)->slab;

318 i‡(
¶ab
->
ª„ªn˚Cou¡s
 =
NULL
) {

321 
	`nŸeSœbIsClo£d
(
com∂ëi⁄
);

325 
	`˛o£Re„ªn˚Cou¡s
(
¶ab
->
ª„ªn˚Cou¡s
, 
∑ª¡
, 
nŸeSœbIsClo£d
,

326 
nŸeSœbIsClo£d
, 
com∂ëi⁄
->
ˇŒbackThªadID
);

327 
	}
}

337 
	$ª„ªn˚Cou¡sWrôãn
(
Sœb
 *
¶ab
, 
SœbCom∂ëi⁄
 *
¶abCom∂ëi⁄
)

339 
	`˛o£SœbJou∫Æ
(
¶ab
->
jou∫Æ
, &
¶abCom∂ëi⁄
->
com∂ëi⁄
,

340 
waôF‹Re„ªn˚Cou¡sClo£d
, waitForReferenceCountsClosed,

341 
¶abCom∂ëi⁄
->
thªadID
);

342 
	}
}

345 
	$ßveSœbs
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
, 
SœbIãøt‹
 
ôî©‹
)

347 
SœbCom∂ëi⁄
 *
¶abCom∂ëi⁄
 = 
	`asSœbCom∂ëi⁄
(
com∂ëi⁄
);

348 
¶abCom∂ëi⁄
->
ôî©‹
 = iterator;

349 
¶abCom∂ëi⁄
->
√edsRefCou¡IO
 = 
shouldSaveRe„ªn˚Cou¡s
;

350 
¶abCom∂ëi⁄
->
doRefCou¡IO
 = 
ßveRe„ªn˚Blocks
;

351 
¶abCom∂ëi⁄
->
ªfCou¡sIOFöished
 = 
ª„ªn˚Cou¡sWrôãn
;

352 
	`œunchSœbIO
(
¶abCom∂ëi⁄
, 
ÊushSœbJou∫Æ
);

353 
	}
}

356 
boﬁ
 
no
(c⁄° 
Sœb
 *
¶ab
 
__©åibuã__
((
unu£d
)))

358  
	gÁl£
;

362 
	$lﬂdSœbJou∫Æs
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
, 
SœbIãøt‹
 
ôî©‹
)

364 
SœbCom∂ëi⁄
 *
¶abCom∂ëi⁄
 = 
	`asSœbCom∂ëi⁄
(
com∂ëi⁄
);

365 
¶abCom∂ëi⁄
->
ôî©‹
 = iterator;

366 
¶abCom∂ëi⁄
->
√edsRefCou¡IO
 = 
no
;

367 
¶abCom∂ëi⁄
->
doRefCou¡IO
 = 
NULL
;

368 
¶abCom∂ëi⁄
->
ªfCou¡sIOFöished
 = 
¶abFöished
;

369 
	`œunchSœbIO
(
¶abCom∂ëi⁄
, 
decodeSœbJou∫Æ
);

370 
	}
}

373 
	$ÊushSœbJou∫Æs
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
, 
SœbIãøt‹
 
ôî©‹
)

375 
SœbCom∂ëi⁄
 *
¶abCom∂ëi⁄
 = 
	`asSœbCom∂ëi⁄
(
com∂ëi⁄
);

376 
¶abCom∂ëi⁄
->
ôî©‹
 = iterator;

377 
¶abCom∂ëi⁄
->
√edsRefCou¡IO
 = 
no
;

378 
¶abCom∂ëi⁄
->
doRefCou¡IO
 = 
NULL
;

379 
¶abCom∂ëi⁄
->
ªfCou¡sIOFöished
 = 
¶abFöished
;

380 
	`œunchSœbIO
(
¶abCom∂ëi⁄
, 
ÊushSœbJou∫Æ
);

381 
	}
}

386 
boﬁ
 
yes
(c⁄° 
Sœb
 *
¶ab
 
__©åibuã__
((
unu£d
)))

388  
	gåue
;

392 
	$ßveSœb
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
, 
Sœb
 *
¶ab
)

394 
SœbCom∂ëi⁄
 *
¶abCom∂ëi⁄
 = 
	`asSœbCom∂ëi⁄
(
com∂ëi⁄
);

395 
¶abCom∂ëi⁄
->
ôî©‹
 = 
	`ôî©eSœbs
(
NULL
, 0, 0, 0);

396 
¶abCom∂ëi⁄
->
¶absRemaöög
 = 1;

397 
¶abCom∂ëi⁄
->
√edsRefCou¡IO
 = 
yes
;

398 
¶abCom∂ëi⁄
->
doRefCou¡IO
 = 
ßveRe„ªn˚Blocks
;

399 
¶abCom∂ëi⁄
->
ªfCou¡sIOFöished
 = 
¶abFöished
;

400 
	`doRefCou¡IO
(
¶abCom∂ëi⁄
, 
¶ab
);

401 
	}
}

404 
	$lﬂdSœbFromLayî
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
, 
Sœb
 *
¶ab
)

406 
SœbCom∂ëi⁄
 *
¶abCom∂ëi⁄
 = 
	`asSœbCom∂ëi⁄
(
com∂ëi⁄
);

407 
¶abCom∂ëi⁄
->
ôî©‹
 = 
	`ôî©eSœbs
(
NULL
, 0, 0, 0);

408 
¶abCom∂ëi⁄
->
¶absRemaöög
 = 1;

409 
¶abCom∂ëi⁄
->
√edsRefCou¡IO
 = 
yes
;

410 
¶abCom∂ëi⁄
->
doRefCou¡IO
 = 
lﬂdRe„ªn˚Blocks
;

411 
¶abCom∂ëi⁄
->
ªfCou¡sIOFöished
 = 
¶abFöished
;

412 
	`doRefCou¡IO
(
¶abCom∂ëi⁄
, 
¶ab
);

413 
	}
}

416 
	$ßveFuŒyRebuûtSœbs
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
,

417 
SœbIãøt‹
 
¶abIãøt‹
)

419 
SœbCom∂ëi⁄
 *
¶abCom∂ëi⁄
 = 
	`asSœbCom∂ëi⁄
(
com∂ëi⁄
);

420 
¶abCom∂ëi⁄
->
ôî©‹
 = 
¶abIãøt‹
;

421 
¶abCom∂ëi⁄
->
√edsRefCou¡IO
 = 
shouldSaveFuŒyBuûtSœb
;

422 
¶abCom∂ëi⁄
->
doRefCou¡IO
 = 
ßveAŒRe„ªn˚Blocks
;

423 
¶abCom∂ëi⁄
->
ªfCou¡sIOFöished
 = 
¶abFöished
;

424 
	`œunchSœbIO
(
¶abCom∂ëi⁄
, 
NULL
);

425 
	}
}

	@vdo/base/slabCompletion.h

21 #i‚de‡
SLAB_COMPLETION_H


22 
	#SLAB_COMPLETION_H


	)

24 
	~"com∂ëi⁄.h
"

25 
	~"¶abIãøt‹.h
"

26 
	~"ty≥s.h
"

36 
	$makeSœbCom∂ëi⁄
(
PhysiˇlLayî
 *
œyî
, 
VDOCom∂ëi⁄
 **
com∂ëi⁄På
)

37 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

44 
	`‰ìSœbCom∂ëi⁄
(
VDOCom∂ëi⁄
 **
com∂ëi⁄På
);

52 
	`ßveSœbs
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
, 
SœbIãøt‹
 
¶abIãøt‹
);

60 
	`lﬂdSœbJou∫Æs
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
, 
SœbIãøt‹
 
¶abIãøt‹
);

68 
	`ÊushSœbJou∫Æs
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
, 
SœbIãøt‹
 
¶abIãøt‹
);

76 
	`ßveSœb
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
, 
Sœb
 *
¶ab
);

85 
	`lﬂdSœbFromLayî
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
, 
Sœb
 *
¶ab
);

93 
	`ßveFuŒyRebuûtSœbs
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
,

94 
SœbIãøt‹
 
¶abIãøt‹
);

	@vdo/base/slabDepot.c

22 
	~"¶abDïŸ.h
"

24 
	~"loggî.h
"

25 
	~"mem‹yAŒoc.h
"

27 
	~"blockAŒoˇt‹I¡î«ls.h
"

28 
	~"c⁄°™ts.h
"

29 
	~"hódî.h
"

30 
	~"numUtûs.h
"

31 
	~"ªfCou¡s.h
"

32 
	~"¶ab.h
"

33 
	~"¶abCom∂ëi⁄.h
"

34 
	~"¶abDïŸI¡î«ls.h
"

35 
	~"¶abJou∫Æ.h
"

36 
	~"¶abJou∫ÆEø£r.h
"

37 
	~"¶abIãøt‹.h
"

38 
	~"¶abSumm¨y.h
"

39 
	~"thªadC⁄fig.h
"

40 
	~"ty≥s.h
"

43 
SœbC⁄fig
 
	m¶abC⁄fig
;

44 
PhysiˇlBlockNumbî
 
	mfú°Block
;

45 
PhysiˇlBlockNumbî
 
	mœ°Block
;

46 
Z⁄eCou¡
 
	mz⁄eCou¡
;

47 } 
	t__©åibuã__
((
	t∑cked
)Ë
	tSœbDïŸSèã2_0
;

49 c⁄° 
Hódî
 
	gSLAB_DEPOT_HEADER_2_0
 = {

50 .
id
 = 
SLAB_DEPOT
,

51 .
	gvîsi⁄
 = {

52 .
maj‹Vîsi⁄
 = 2,

53 .
	gmö‹Vîsi⁄
 = 0,

55 .
	gsize
 = (
SœbDïŸSèã2_0
),

58 c⁄° 
Hódî
 *
	gCURRENT_SLAB_DEPOT_HEADER
 = &
SLAB_DEPOT_HEADER_2_0
;

67 
ölöe
 
SœbDïŸ
 *
	$asSœbDïŸ
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

69 
	`STATIC_ASSERT
(
	`off£tof
(
SœbDïŸ
, 
com∂ëi⁄
) == 0);

70 
	`as£πCom∂ëi⁄Ty≥
(
com∂ëi⁄
->
ty≥
, 
SLAB_DEPOT_COMPLETION
);

71  (
SœbDïŸ
 *Ë
com∂ëi⁄
;

72 
	}
}

75 
SœbCou¡
 
	$ˇlcuœãSœbCou¡
(
PhysiˇlBlockNumbî
 
fú°Block
,

76 
PhysiˇlBlockNumbî
 
œ°Block
,

77 
¶abSizeShi·
)

79 
BlockCou¡
 
d©aBlocks
 = 
œ°Block
 - 
fú°Block
;

80  (
SœbCou¡
Ë(
d©aBlocks
 >> 
¶abSizeShi·
);

81 
	}
}

90 
SœbIãøt‹
 
	$gëSœbIãøt‹
(
SœbDïŸ
 *
dïŸ
)

92  
	`ôî©eSœbs
(
dïŸ
->
¶abs
, dïŸ->
¶abCou¡
 - 1, 0, 1);

93 
	}
}

108 
	$ÆloˇãSœbs
(
SœbDïŸ
 *
dïŸ
,

109 
PhysiˇlLayî
 *
œyî
,

110 
SœbCou¡
 
¶abCou¡
)

112 
ªsu…
 = 
	`ALLOCATE
(
¶abCou¡
, 
Sœb
 *, "slabÖointerárray",

113 &
dïŸ
->
√wSœbs
);

114 i‡(
ªsu…
 !
VDO_SUCCESS
) {

115  
ªsu…
;

118 
boﬁ
 
ªsizög
 = 
Ál£
;

119 i‡(
dïŸ
->
¶abs
 !
NULL
) {

120 
	`mem˝y
(
dïŸ
->
√wSœbs
, dïŸ->
¶abs
, dïŸ->
¶abCou¡
 * (
Sœb
 *));

121 
dïŸ
->
√wSœbCou¡
 = dïŸ->
¶abCou¡
;

122 
ªsizög
 = 
åue
;

125 
BlockCou¡
 
¶abSize
 = 
	`gëSœbC⁄fig
(
dïŸ
)->
¶abBlocks
;

126 
PhysiˇlBlockNumbî
 
¶abOrigö


127 
dïŸ
->
fú°Block
 + (dïŸ->
¶abCou¡
 * 
¶abSize
);

130 
BlockCou¡
 
å™¶©i⁄
 = 
dïŸ
->
‹igö
 - dïŸ->
fú°Block
;

131 
dïŸ
->
√wSœbCou¡
 = dïŸ->
¶abCou¡
;

132 
dïŸ
->
√wSœbCou¡
 < 
¶abCou¡
; depot->newSlabCount++) {

133 
BlockAŒoˇt‹
 *
Æloˇt‹


134 
dïŸ
->
Æloˇt‹s
[dïŸ->
√wSœbCou¡
 % dïŸ->
z⁄eCou¡
];

135 
Sœb
 **
¶abPå
 = &
dïŸ
->
√wSœbs
[dïŸ->
√wSœbCou¡
];

136 
ªsu…
 = 
	`makeSœb
(
¶abOrigö
, 
Æloˇt‹
, 
å™¶©i⁄
, 
dïŸ
->
jou∫Æ
,

137 
œyî
, 
dïŸ
->
√wSœbCou¡
, 
¶abPå
);

138 i‡(
ªsu…
 !
VDO_SUCCESS
) {

139  
ªsu…
;

142 
¶abOrigö
 +
¶abSize
;

144 i‡(
ªsizög
) {

145 
ªsu…
 = 
	`ÆloˇãRefCou¡sF‹Sœb
(
œyî
, *
¶abPå
);

146 i‡(
ªsu…
 !
VDO_SUCCESS
) {

147  
ªsu…
;

151  
VDO_SUCCESS
;

152 
	}
}

155 
	$ab™d⁄NewSœbs
(
SœbDïŸ
 *
dïŸ
)

157 
SœbCou¡
 
i
 = 
dïŸ
->
¶abCou¡
; i < dïŸ->
√wSœbCou¡
; i++) {

158 
	`‰ìSœb
(&
dïŸ
->
√wSœbs
[
i
]);

160 
dïŸ
->
√wSœbCou¡
 = 0;

161 
	`FREE
(
dïŸ
->
√wSœbs
);

162 
dïŸ
->
√wSœbs
 = 
NULL
;

163 
dïŸ
->
√wSize
 = 0;

164 
	}
}

180 
	$ÆloˇãComp⁄íts
(
SœbDïŸ
 *
dïŸ
,

181 
N⁄˚
 
n⁄˚
,

182 c⁄° 
ThªadC⁄fig
 *
thªadC⁄fig
,

183 
BlockCou¡
 
vioPoﬁSize
,

184 
BlockCou¡
 
des¸ùt‹PoﬁSize
,

185 
PhysiˇlLayî
 *
œyî
,

186 
P¨tôi⁄
 *
summ¨yP¨tôi⁄
)

193 i‡(
œyî
->
¸óãMëad©aVIO
 =
NULL
) {

194  
VDO_SUCCESS
;

197 
ªsu…
 = 
	`öôülizeEnqueuóbÀCom∂ëi⁄
(&
dïŸ
->
com∂ëi⁄
,

198 
SLAB_DEPOT_COMPLETION
, 
œyî
);

199 i‡(
ªsu…
 !
VDO_SUCCESS
) {

200  
ªsu…
;

203 
ªsu…
 = 
	`öôülizeEnqueuóbÀCom∂ëi⁄
(&
dïŸ
->
a˘i⁄Com∂ëi⁄
,

204 
SUB_TASK_COMPLETION
, 
œyî
);

205 i‡(
ªsu…
 !
VDO_SUCCESS
) {

206  
ªsu…
;

209 
ªsu…
 = 
	`öôülizeEnqueuóbÀCom∂ëi⁄
(&
dïŸ
->
ßveCom∂ëi⁄
,

210 
SUB_TASK_COMPLETION
, 
œyî
);

211 i‡(
ªsu…
 !
VDO_SUCCESS
) {

212  
ªsu…
;

215 
ªsu…
 = 
	`öôülizeEnqueuóbÀCom∂ëi⁄
(&
dïŸ
->
subTaskCom∂ëi⁄
,

216 
SUB_TASK_COMPLETION
, 
œyî
);

217 i‡(
ªsu…
 !
VDO_SUCCESS
) {

218  
ªsu…
;

221 
dïŸ
->
ªcovîyJou∫ÆThªadID
 = 
	`gëJou∫ÆZ⁄eThªad
(
thªadC⁄fig
);

222 
dïŸ
->
‹igö
 = dïŸ->
fú°Block
;

224 
ªsu…
 = 
	`makeSœbSumm¨y
(
œyî
, 
summ¨yP¨tôi⁄
, 
thªadC⁄fig
,

225 
dïŸ
->
¶abSizeShi·
, dïŸ->
¶abC⁄fig
.
d©aBlocks
,

226 
dïŸ
->
ªadO∆yC⁄ãxt
, &dïŸ->
¶abSumm¨y
);

227 i‡(
ªsu…
 !
VDO_SUCCESS
) {

228  
ªsu…
;

231 
ªsu…
 = 
	`makeSœbCom∂ëi⁄
(
œyî
, &
dïŸ
->
¶abCom∂ëi⁄
);

232 i‡(
ªsu…
 !
VDO_SUCCESS
) {

233  
ªsu…
;

236 
SœbCou¡
 
¶abCou¡
 = 
	`ˇlcuœãSœbCou¡
(
dïŸ
->
fú°Block
, dïŸ->
œ°Block
,

237 
dïŸ
->
¶abSizeShi·
);

238 i‡(
thªadC⁄fig
->
physiˇlZ⁄eCou¡
 > 
¶abCou¡
) {

239  
	`logEº‹WôhSåögEº‹
(
VDO_BAD_CONFIGURATION
,

241 
thªadC⁄fig
->
physiˇlZ⁄eCou¡
, 
¶abCou¡
);

245 
Z⁄eCou¡
 
z⁄e
 = 0; z⁄ê< 
dïŸ
->
z⁄eCou¡
; zone++) {

246 
ThªadID
 
thªadID
 = 
	`gëPhysiˇlZ⁄eThªad
(
thªadC⁄fig
, 
z⁄e
);

247 
ªsu…
 = 
	`makeBlockAŒoˇt‹
(
dïŸ
, 
z⁄e
, 
thªadID
, 
n⁄˚
, 
vioPoﬁSize
,

248 
des¸ùt‹PoﬁSize
, 
œyî
,

249 
dïŸ
->
ªadO∆yC⁄ãxt
,

250 &
dïŸ
->
Æloˇt‹s
[
z⁄e
]);

251 i‡(
ªsu…
 !
VDO_SUCCESS
) {

252  
ªsu…
;

257 
ªsu…
 = 
	`ÆloˇãSœbs
(
dïŸ
, 
œyî
, 
¶abCou¡
);

258 i‡(
ªsu…
 !
VDO_SUCCESS
) {

259  
ªsu…
;

263 
SœbCou¡
 
i
 = 
dïŸ
->
¶abCou¡
; i < dïŸ->
√wSœbCou¡
; i++) {

264 
Sœb
 *
¶ab
 = 
dïŸ
->
√wSœbs
[
i
];

265 
	`ªgi°îSœbWôhAŒoˇt‹
(
¶ab
->
Æloˇt‹
, sœb, 
Ál£
);

266 
dïŸ
->
¶abCou¡
++;

269 
dïŸ
->
¶abs
 = dïŸ->
√wSœbs
;

270 
dïŸ
->
√wSœbs
 = 
NULL
;

271 
dïŸ
->
√wSœbCou¡
 = 0;

273  
VDO_SUCCESS
;

274 
	}
}

293 
__©åibuã__
((
w¨n_unu£d_ªsu…
))

294 
	$ÆloˇãDïŸ
(c⁄° 
SœbDïŸSèã2_0
 *
°©e
,

295 c⁄° 
ThªadC⁄fig
 *
thªadC⁄fig
,

296 
N⁄˚
 
n⁄˚
,

297 
BlockCou¡
 
vioPoﬁSize
,

298 
BlockCou¡
 
des¸ùt‹PoﬁSize
,

299 
PhysiˇlLayî
 *
œyî
,

300 
P¨tôi⁄
 *
summ¨yP¨tôi⁄
,

301 
RódO∆yModeC⁄ãxt
 *
ªadO∆yC⁄ãxt
,

302 
RecovîyJou∫Æ
 *
ªcovîyJou∫Æ
,

303 
SœbDïŸ
 **
dïŸPå
)

307 
BlockCou¡
 
¶abSize
 = 
°©e
->
¶abC⁄fig
.
¶abBlocks
;

308 i‡(!
	`isPowîOfTwo
(
¶abSize
)) {

309  
	`logEº‹WôhSåögEº‹
(
UDS_INVALID_ARGUMENT
,

312 
¶abSizeShi·
 = 
	`logBa£Two
(
¶abSize
);

314 
SœbDïŸ
 *
dïŸ
;

315 
ªsu…
 = 
	`ALLOCATE_EXTENDED
(
SœbDïŸ
, 
thªadC⁄fig
->
physiˇlZ⁄eCou¡
,

316 
BlockAŒoˇt‹
 *, 
__func__
, &
dïŸ
);

317 i‡(
ªsu…
 !
VDO_SUCCESS
) {

318  
ªsu…
;

321 
dïŸ
->
ﬁdZ⁄eCou¡
 = 
°©e
->
z⁄eCou¡
;

322 
dïŸ
->
z⁄eCou¡
 = 
thªadC⁄fig
->
physiˇlZ⁄eCou¡
;

323 
dïŸ
->
¶abC⁄fig
 = 
°©e
->slabConfig;

324 
dïŸ
->
ªadO∆yC⁄ãxt
 =ÑeadOnlyContext;

325 
dïŸ
->
fú°Block
 = 
°©e
->firstBlock;

326 
dïŸ
->
œ°Block
 = 
°©e
->lastBlock;

327 
dïŸ
->
¶abSizeShi·
 = slabSizeShift;

328 
dïŸ
->
jou∫Æ
 = 
ªcovîyJou∫Æ
;

330 
ªsu…
 = 
	`ÆloˇãComp⁄íts
(
dïŸ
, 
n⁄˚
, 
thªadC⁄fig
, 
vioPoﬁSize
,

331 
des¸ùt‹PoﬁSize
, 
œyî
, 
summ¨yP¨tôi⁄
);

332 i‡(
ªsu…
 !
VDO_SUCCESS
) {

333 
	`‰ìSœbDïŸ
(&
dïŸ
);

334  
ªsu…
;

337 *
dïŸPå
 = 
dïŸ
;

338  
VDO_SUCCESS
;

339 
	}
}

354 
	$c⁄figuªSèã
(
BlockCou¡
 
blockCou¡
,

355 
PhysiˇlBlockNumbî
 
fú°Block
,

356 
SœbC⁄fig
 
¶abC⁄fig
,

357 
Z⁄eCou¡
 
z⁄eCou¡
,

358 
SœbDïŸSèã2_0
 *
°©e
)

360 
BlockCou¡
 
¶abSize
 = 
¶abC⁄fig
.
¶abBlocks
;

361 
	`logDebug
("¶abDïŸ c⁄figuªSèã(blockCou¡=%" 
PRIu64


362 ", fú°Block=%" 
PRIu64
 ", slabSize=%" PRIu64 ", zoneCount=%u)",

363 
blockCou¡
, 
fú°Block
, 
¶abSize
, 
z⁄eCou¡
);

366 
size_t
 
¶abCou¡
 = (
blockCou¡
 / 
¶abSize
);

367 i‡(
¶abCou¡
 == 0) {

368  
VDO_NO_SPACE
;

371 i‡(
¶abCou¡
 > 
MAX_SLABS
) {

372  
VDO_TOO_MANY_SLABS
;

375 
BlockCou¡
 
tŸÆSœbBlocks
 = 
¶abCou¡
 * 
¶abC⁄fig
.
¶abBlocks
;

376 
BlockCou¡
 
tŸÆD©aBlocks
 = 
¶abCou¡
 * 
¶abC⁄fig
.
d©aBlocks
;

377 
PhysiˇlBlockNumbî
 
œ°Block
 = 
fú°Block
 + 
tŸÆSœbBlocks
;

379 *
°©e
 = (
SœbDïŸSèã2_0
) {

380 .
¶abC⁄fig
 = slabConfig,

381 .
fú°Block
 = firstBlock,

382 .
œ°Block
 =ÜastBlock,

383 .
z⁄eCou¡
 = zoneCount,

386 
	`logDebug
("¶abDïŸÜa°Block=%" 
PRIu64
 ",ÅotalDataBlocks=%" PRIu64

387 ", sœbCou¡=%zu,Üe·Ovî=%" 
PRIu64
,

388 
œ°Block
, 
tŸÆD©aBlocks
, 
¶abCou¡
,

389 
blockCou¡
 - (
œ°Block
 - 
fú°Block
));

391  
VDO_SUCCESS
;

392 
	}
}

395 
	$makeSœbDïŸ
(
BlockCou¡
 
blockCou¡
,

396 
PhysiˇlBlockNumbî
 
fú°Block
,

397 
SœbC⁄fig
 
¶abC⁄fig
,

398 c⁄° 
ThªadC⁄fig
 *
thªadC⁄fig
,

399 
N⁄˚
 
n⁄˚
,

400 
BlockCou¡
 
vioPoﬁSize
,

401 
BlockCou¡
 
des¸ùt‹PoﬁSize
,

402 
PhysiˇlLayî
 *
œyî
,

403 
P¨tôi⁄
 *
summ¨yP¨tôi⁄
,

404 
RódO∆yModeC⁄ãxt
 *
ªadO∆yC⁄ãxt
,

405 
RecovîyJou∫Æ
 *
ªcovîyJou∫Æ
,

406 
SœbDïŸ
 **
dïŸPå
)

408 
SœbDïŸSèã2_0
 
°©e
;

409 
ªsu…
 = 
	`c⁄figuªSèã
(
blockCou¡
, 
fú°Block
, 
¶abC⁄fig
, 0, &
°©e
);

410 i‡(
ªsu…
 !
VDO_SUCCESS
) {

411  
ªsu…
;

414 
SœbDïŸ
 *
dïŸ
 = 
NULL
;

415 
ªsu…
 = 
	`ÆloˇãDïŸ
(&
°©e
, 
thªadC⁄fig
, 
n⁄˚
, 
vioPoﬁSize
,

416 
des¸ùt‹PoﬁSize
, 
œyî
,

417 
summ¨yP¨tôi⁄
, 
ªadO∆yC⁄ãxt
, 
ªcovîyJou∫Æ
,

418 &
dïŸ
);

419 i‡(
ªsu…
 !
VDO_SUCCESS
) {

420  
ªsu…
;

423 *
dïŸPå
 = 
dïŸ
;

424  
VDO_SUCCESS
;

425 
	}
}

428 
	$‰ìSœbDïŸ
(
SœbDïŸ
 **
dïŸPå
)

430 
SœbDïŸ
 *
dïŸ
 = *
dïŸPå
;

431 i‡(
dïŸ
 =
NULL
) {

435 
	`ab™d⁄NewSœbs
(
dïŸ
);

437 
Z⁄eCou¡
 
z⁄e
 = 0; z⁄ê< 
dïŸ
->
z⁄eCou¡
; zone++) {

438 
	`‰ìBlockAŒoˇt‹
(&
dïŸ
->
Æloˇt‹s
[
z⁄e
]);

441 i‡(
dïŸ
->
¶abs
 !
NULL
) {

442 
SœbCou¡
 
i
 = 0; i < 
dïŸ
->
¶abCou¡
; i++) {

443 
	`‰ìSœb
(&
dïŸ
->
¶abs
[
i
]);

447 
	`FREE
(
dïŸ
->
¶abs
);

448 
	`‰ìSœbCom∂ëi⁄
(&
dïŸ
->
¶abCom∂ëi⁄
);

449 
	`‰ìSœbSumm¨y
(&
dïŸ
->
¶abSumm¨y
);

450 
	`de°royEnqueuóbÀ
(&
dïŸ
->
subTaskCom∂ëi⁄
);

451 
	`de°royEnqueuóbÀ
(&
dïŸ
->
ßveCom∂ëi⁄
);

452 
	`de°royEnqueuóbÀ
(&
dïŸ
->
a˘i⁄Com∂ëi⁄
);

453 
	`de°royEnqueuóbÀ
(&
dïŸ
->
com∂ëi⁄
);

454 
	`FREE
(
dïŸ
);

455 *
dïŸPå
 = 
NULL
;

456 
	}
}

459 
size_t
 
	$gëSœbDïŸEncodedSize
()

461  
ENCODED_HEADER_SIZE
 + (
SœbDïŸSèã2_0
);

462 
	}
}

465 
	$ícodeSœbDïŸ
(c⁄° 
SœbDïŸ
 *
dïŸ
, 
Buf„r
 *
buf„r
)

474 
Z⁄eCou¡
 
z⁄esToRec‹d
 = 
dïŸ
->
z⁄eCou¡
;

475 i‡(
dïŸ
->
z⁄eCou¡
 == 0) {

476 
z⁄esToRec‹d
 = 
dïŸ
->
ﬁdZ⁄eCou¡
;

479 
SœbDïŸSèã2_0
 
°©e
 = (SlabDepotState2_0) {

480 .
¶abC⁄fig
 = 
dïŸ
->slabConfig,

481 .
fú°Block
 = 
dïŸ
->firstBlock,

482 .
œ°Block
 = 
dïŸ
->lastBlock,

483 .
z⁄eCou¡
 = 
z⁄esToRec‹d
,

485  
	`ícodeWôhHódî
(
CURRENT_SLAB_DEPOT_HEADER
, &
°©e
, 
buf„r
);

486 
	}
}

489 
	$decodeSodiumSœbDïŸ
(
Buf„r
 *
buf„r
,

490 c⁄° 
ThªadC⁄fig
 *
thªadC⁄fig
,

491 
N⁄˚
 
n⁄˚
,

492 
PhysiˇlLayî
 *
œyî
,

493 
P¨tôi⁄
 *
summ¨yP¨tôi⁄
,

494 
RódO∆yModeC⁄ãxt
 *
ªadO∆yC⁄ãxt
,

495 
RecovîyJou∫Æ
 *
ªcovîyJou∫Æ
,

496 
SœbDïŸ
 **
dïŸPå
)

499  
	`decodeSœbDïŸ
(
buf„r
, 
thªadC⁄fig
, 
n⁄˚
, 
œyî
, 
summ¨yP¨tôi⁄
,

500 
ªadO∆yC⁄ãxt
, 
ªcovîyJou∫Æ
, 
dïŸPå
);

501 
	}
}

504 
	$decodeSœbDïŸ
(
Buf„r
 *
buf„r
,

505 c⁄° 
ThªadC⁄fig
 *
thªadC⁄fig
,

506 
N⁄˚
 
n⁄˚
,

507 
PhysiˇlLayî
 *
œyî
,

508 
P¨tôi⁄
 *
summ¨yP¨tôi⁄
,

509 
RódO∆yModeC⁄ãxt
 *
ªadO∆yC⁄ãxt
,

510 
RecovîyJou∫Æ
 *
ªcovîyJou∫Æ
,

511 
SœbDïŸ
 **
dïŸPå
)

513 
Hódî
 
hódî
;

514 
ªsu…
 = 
	`decodeHódî
(
buf„r
, &
hódî
);

515 i‡(
ªsu…
 !
VDO_SUCCESS
) {

516  
ªsu…
;

519 
ªsu…
 = 
	`vÆid©eHódî
(
CURRENT_SLAB_DEPOT_HEADER
, &
hódî
, 
åue
, 
__func__
);

520 i‡(
ªsu…
 !
VDO_SUCCESS
) {

521  
ªsu…
;

524 
SœbDïŸSèã2_0
 
°©e
;

525 
ªsu…
 = 
	`gëByãsFromBuf„r
(
buf„r
, (
°©e
), &state);

526 i‡(
ªsu…
 !
UDS_SUCCESS
) {

527  
ªsu…
;

530  
	`ÆloˇãDïŸ
(&
°©e
, 
thªadC⁄fig
, 
n⁄˚
, 
VIO_POOL_SIZE
,

531 
BLOCK_DESCRIPTOR_POOL_SIZE
, 
œyî
,

532 
summ¨yP¨tôi⁄
, 
ªadO∆yC⁄ãxt
, 
ªcovîyJou∫Æ
,

533 
dïŸPå
);

534 
	}
}

537 
	$ÆloˇãSœbRefCou¡s
(
SœbDïŸ
 *
dïŸ
, 
PhysiˇlLayî
 *
œyî
)

539 
SœbIãøt‹
 
ôî©‹
 = 
	`gëSœbIãøt‹
(
dïŸ
);

540 
	`hasNextSœb
(&
ôî©‹
)) {

541 
ªsu…
 = 
	`ÆloˇãRefCou¡sF‹Sœb
(
œyî
, 
	`√xtSœb
(&
ôî©‹
));

542 i‡(
ªsu…
 !
VDO_SUCCESS
) {

543  
ªsu…
;

547  
VDO_SUCCESS
;

548 
	}
}

551 
BlockAŒoˇt‹
 *
	$gëBlockAŒoˇt‹F‹Z⁄e
(
SœbDïŸ
 *
dïŸ
,

552 
Z⁄eCou¡
 
z⁄eNumbî
)

554  
dïŸ
->
Æloˇt‹s
[
z⁄eNumbî
];

555 
	}
}

558 
	$gëSœbNumbî
(c⁄° 
SœbDïŸ
 *
dïŸ
,

559 
PhysiˇlBlockNumbî
 
pbn
,

560 
SœbCou¡
 *
¶abNumbîPå
)

562 i‡(
pbn
 < 
dïŸ
->
fú°Block
) {

563  
VDO_OUT_OF_RANGE
;

566 
SœbCou¡
 
¶abNumbî
 = (
pbn
 - 
dïŸ
->
fú°Block
Ë>> dïŸ->
¶abSizeShi·
;

567 i‡(
¶abNumbî
 >
dïŸ
->
¶abCou¡
) {

568  
VDO_OUT_OF_RANGE
;

571 *
¶abNumbîPå
 = 
¶abNumbî
;

572  
VDO_SUCCESS
;

573 
	}
}

576 
Sœb
 *
	$gëSœb
(c⁄° 
SœbDïŸ
 *
dïŸ
, 
PhysiˇlBlockNumbî
 
pbn
)

578 i‡(
pbn
 =
ZERO_BLOCK
) {

579  
NULL
;

582 
SœbCou¡
 
¶abNumbî
;

583 
ªsu…
 = 
	`gëSœbNumbî
(
dïŸ
, 
pbn
, &
¶abNumbî
);

584 i‡(
ªsu…
 !
VDO_SUCCESS
) {

585 
	`íãrRódO∆yMode
(
dïŸ
->
ªadO∆yC⁄ãxt
, 
ªsu…
);

586  
NULL
;

589  
dïŸ
->
¶abs
[
¶abNumbî
];

591 
	}
}

594 
SœbJou∫Æ
 *
	$gëSœbJou∫Æ
(c⁄° 
SœbDïŸ
 *
dïŸ
, 
PhysiˇlBlockNumbî
 
pbn
)

596 
Sœb
 *
¶ab
 = 
	`gëSœb
(
dïŸ
, 
pbn
);

597  ((
¶ab
 !
NULL
Ë? sœb->
jou∫Æ
 : NULL);

598 
	}
}

601 
uöt8_t
 
	$gëIn¸emítLimô
(
SœbDïŸ
 *
dïŸ
, 
PhysiˇlBlockNumbî
 
pbn
)

603 
Sœb
 *
¶ab
 = 
	`gëSœb
(
dïŸ
, 
pbn
);

604 i‡((
¶ab
 =
NULL
Ë|| 
	`isUƒecovîedSœb
(slab)) {

608  
	`gëAvaûabÀRe„ªn˚s
(
¶ab
->
ª„ªn˚Cou¡s
, 
pbn
);

609 
	}
}

612 
boﬁ
 
	$isPhysiˇlD©aBlock
(c⁄° 
SœbDïŸ
 *
dïŸ
, 
PhysiˇlBlockNumbî
 
pbn
)

614 i‡(
pbn
 =
ZERO_BLOCK
) {

615  
åue
;

618 
SœbCou¡
 
¶abNumbî
;

619 i‡(
	`gëSœbNumbî
(
dïŸ
, 
pbn
, &
¶abNumbî
Ë!
VDO_SUCCESS
) {

620  
Ál£
;

623 
SœbBlockNumbî
 
sbn
;

624 
ªsu…
 = 
	`¶abBlockNumbîFromPBN
(
dïŸ
->
¶abs
[
¶abNumbî
], 
pbn
, &
sbn
);

625  (
ªsu…
 =
VDO_SUCCESS
);

626 
	}
}

629 
BlockCou¡
 
	$gëDïŸAŒoˇãdBlocks
(c⁄° 
SœbDïŸ
 *
dïŸ
)

631 
BlockCou¡
 
tŸÆ
 = 0;

632 
Z⁄eCou¡
 
z⁄e
 = 0; z⁄ê< 
dïŸ
->
z⁄eCou¡
; zone++) {

634 
tŸÆ
 +
	`gëAŒoˇãdBlocks
(
dïŸ
->
Æloˇt‹s
[
z⁄e
]);

636  
tŸÆ
;

637 
	}
}

640 
BlockCou¡
 
	$gëDïŸD©aBlocks
(c⁄° 
SœbDïŸ
 *
dïŸ
)

644  (
dïŸ
->
¶abCou¡
 * dïŸ->
¶abC⁄fig
.
d©aBlocks
);

645 
	}
}

648 
BlockCou¡
 
	$gëDïŸFªeBlocks
(c⁄° 
SœbDïŸ
 *
dïŸ
)

658 
BlockCou¡
 
Æloˇãd
 = 
	`gëDïŸAŒoˇãdBlocks
(
dïŸ
);

659 
	`mem‹yFí˚
();

660  (
	`gëDïŸD©aBlocks
(
dïŸ
Ë- 
Æloˇãd
);

661 
	}
}

664 
SœbCou¡
 
	$gëDïŸSœbCou¡
(c⁄° 
SœbDïŸ
 *
dïŸ
)

666  
dïŸ
->
¶abCou¡
;

667 
	}
}

670 
SœbCou¡
 
	$gëDïŸUƒecovîedSœbCou¡
(c⁄° 
SœbDïŸ
 *
dïŸ
)

672 
SœbCou¡
 
tŸÆ
 = 0;

673 
Z⁄eCou¡
 
z⁄e
 = 0; z⁄ê< 
dïŸ
->
z⁄eCou¡
; zone++) {

675 
tŸÆ
 +
	`gëUƒecovîedSœbCou¡
(
dïŸ
->
Æloˇt‹s
[
z⁄e
]);

677  
tŸÆ
;

678 
	}
}

681 
boﬁ
 
	$ab‹tLﬂdOnEº‹
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

683 i‡(
com∂ëi⁄
->
ªsu…
 =
VDO_SUCCESS
) {

684  
Ál£
;

687 
SœbDïŸ
 *
dïŸ
 = 
com∂ëi⁄
->
∑ª¡
;

688 
	`föishCom∂ëi⁄
(
dïŸ
->
¶abCom∂ëi⁄
, 
com∂ëi⁄
->
ªsu…
);

689  
åue
;

690 
	}
}

698 
	$föishLﬂdögSumm¨y
(
VDOCom∂ëi⁄
 *
summ¨yCom∂ëi⁄
)

700 i‡(
	`ab‹tLﬂdOnEº‹
(
summ¨yCom∂ëi⁄
)) {

704 
SœbDïŸ
 *
dïŸ
 = 
summ¨yCom∂ëi⁄
->
∑ª¡
;

705 
	`lﬂdSœbJou∫Æs
(
dïŸ
->
¶abCom∂ëi⁄
, 
	`gëSœbIãøt‹
(depot));

706 
	}
}

709 
	$lﬂdSœbDïŸ
(
SœbDïŸ
 *
dïŸ
, 
boﬁ
 
f‹m©DïŸ
, 
VDOCom∂ëi⁄
 *
∑ª¡
)

711 
ªsu…
 = 
	`ÆloˇãSœbRefCou¡s
(
dïŸ
, 
∑ª¡
->
œyî
);

712 i‡(
ªsu…
 !
VDO_SUCCESS
) {

713 
	`föishCom∂ëi⁄
(
∑ª¡
, 
ªsu…
);

717 i‡(
f‹m©DïŸ
) {

718 
	`lﬂdSœbSumm¨y
(
dïŸ
->
¶abSumm¨y
, dïŸ->
ﬁdZ⁄eCou¡
, 
∑ª¡
,

719 
föishP¨ítCÆlback
);

723 
	`¥ï¨eToFöishP¨ít
(
dïŸ
->
¶abCom∂ëi⁄
, 
∑ª¡
);

724 
	`lﬂdSœbSumm¨y
(
dïŸ
->
¶abSumm¨y
, dïŸ->
ﬁdZ⁄eCou¡
,

725 
dïŸ
, 
föishLﬂdögSumm¨y
);

726 
	}
}

735 
	$lﬂdSœbJou∫ÆsF‹Recovîy
(
VDOCom∂ëi⁄
 *
summ¨yCom∂ëi⁄
)

737 i‡(
	`ab‹tLﬂdOnEº‹
(
summ¨yCom∂ëi⁄
)) {

741 
SœbDïŸ
 *
dïŸ
 = 
summ¨yCom∂ëi⁄
->
∑ª¡
;

742 
	`lﬂdSœbJou∫Æs
(
dïŸ
->
¶abCom∂ëi⁄
, 
	`gëSœbIãøt‹
(depot));

743 
	}
}

746 
	$lﬂdSœbDïŸF‹Recovîy
(
SœbDïŸ
 *
dïŸ
, 
VDOCom∂ëi⁄
 *
∑ª¡
)

748 
	`¥ï¨eToFöishP¨ít
(
dïŸ
->
¶abCom∂ëi⁄
, 
∑ª¡
);

749 
	`lﬂdSœbSumm¨y
(
dïŸ
->
¶abSumm¨y
, dïŸ->
ﬁdZ⁄eCou¡
, depot,

750 
lﬂdSœbJou∫ÆsF‹Recovîy
);

751 
	}
}

760 
	$îa£SœbJou∫ÆsF‹Rebuûd
(
VDOCom∂ëi⁄
 *
summ¨yCom∂ëi⁄
)

762 i‡(
	`ab‹tLﬂdOnEº‹
(
summ¨yCom∂ëi⁄
)) {

766 
SœbDïŸ
 *
dïŸ
 = 
summ¨yCom∂ëi⁄
->
∑ª¡
;

767 
	`îa£SœbJou∫Æs
(
dïŸ
, 
	`gëSœbIãøt‹
(dïŸ), dïŸ->
¶abCom∂ëi⁄
);

768 
	}
}

771 
	$lﬂdSœbDïŸF‹Rebuûd
(
SœbDïŸ
 *
dïŸ
, 
VDOCom∂ëi⁄
 *
∑ª¡
)

773 
	`¥ï¨eToFöishP¨ít
(
dïŸ
->
¶abCom∂ëi⁄
, 
∑ª¡
);

774 
	`lﬂdSœbSumm¨y
(
dïŸ
->
¶abSumm¨y
, 0, dïŸ, 
îa£SœbJou∫ÆsF‹Rebuûd
);

775 
	}
}

782 
	$h™dÀAŒoˇt‹Eº‹
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

785 
	`£tCom∂ëi⁄Resu…
(
com∂ëi⁄
->
∑ª¡
, com∂ëi⁄->
ªsu…
);

788 
	`ª£tCom∂ëi⁄
(
com∂ëi⁄
);

789 
	`övokeCÆlback
(
com∂ëi⁄
);

790 
	}
}

797 
	$≠∂yToNextAŒoˇt‹
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

799 
SœbDïŸ
 *
dïŸ
 = 
	`asSœbDïŸ
(
com∂ëi⁄
);

800 
BlockAŒoˇt‹
 *
Æloˇt‹
 = 
dïŸ
->
Æloˇt‹s
[dïŸ->
a˘ögZ⁄e
];

801 
	`ASSERT_LOG_ONLY
((
	`gëCÆlbackThªadID
(Ë=
Æloˇt‹
->
thªadID
),

804 
dïŸ
->
a˘ögZ⁄e
++;

805 i‡(
dïŸ
->
a˘ögZ⁄e
 =dïŸ->
z⁄eCou¡
) {

808 
	`¥ï¨eToFöishP¨ít
(
com∂ëi⁄
, com∂ëi⁄->
∑ª¡
);

811 
	`¥ï¨eCom∂ëi⁄
(
com∂ëi⁄
, 
≠∂yToNextAŒoˇt‹
, 
h™dÀAŒoˇt‹Eº‹
,

812 
dïŸ
->
Æloˇt‹s
[dïŸ->
a˘ögZ⁄e
]->
thªadID
,

813 
com∂ëi⁄
->
∑ª¡
);

815 
dïŸ
->
	`a˘i⁄
(
Æloˇt‹
, 
com∂ëi⁄
, 
föishP¨ítCÆlback
,

816 
föishP¨ítCÆlback
);

817 
	}
}

828 
	$≠∂yToAŒAŒoˇt‹s
(
SœbDïŸ
 *
dïŸ
,

829 
AŒoˇt‹A˘i⁄
 *
a˘i⁄
,

830 
VDOCom∂ëi⁄
 *
∑ª¡
)

832 
dïŸ
->
a˘i⁄
 =áction;

833 
dïŸ
->
a˘ögZ⁄e
 = 0;

834 
	`¥ï¨eCom∂ëi⁄
(&
dïŸ
->
com∂ëi⁄
, 
≠∂yToNextAŒoˇt‹
,

835 
h™dÀAŒoˇt‹Eº‹
,

836 
dïŸ
->
Æloˇt‹s
[dïŸ->
a˘ögZ⁄e
]->
thªadID
, 
∑ª¡
);

837 
	`övokeCÆlback
(&
dïŸ
->
com∂ëi⁄
);

838 
	}
}

852 
	$œunchOnAŒAŒoˇt‹s
(
SœbDïŸ
 *
dïŸ
,

853 
AŒoˇt‹A˘i⁄
 *
a˘i⁄
,

854 *
∑ª¡
,

855 
VDOA˘i⁄
 *
ˇŒback
,

856 
VDOA˘i⁄
 *
îr‹H™dÀr
)

858 
	`¥ï¨eCom∂ëi⁄
(&
dïŸ
->
a˘i⁄Com∂ëi⁄
, 
ˇŒback
, 
îr‹H™dÀr
,

859 
	`gëCÆlbackThªadID
(), 
∑ª¡
);

860 
	`≠∂yToAŒAŒoˇt‹s
(
dïŸ
, 
a˘i⁄
, &dïŸ->
a˘i⁄Com∂ëi⁄
);

861 
	}
}

864 
	$¥ï¨eToAŒoˇã
(
SœbDïŸ
 *
dïŸ
,

865 
SœbDïŸLﬂdTy≥
 
lﬂdTy≥
,

866 
VDOCom∂ëi⁄
 *
∑ª¡
)

868 
dïŸ
->
lﬂdTy≥
 =ÜoadType;

869 
	`©omicSt‹e32
(&
dïŸ
->
z⁄esToS¸ub
, dïŸ->
z⁄eCou¡
);

870 
	`œunchOnAŒAŒoˇt‹s
(
dïŸ
, 
¥ï¨eAŒoˇt‹ToAŒoˇã
, 
∑ª¡
,

871 
föishP¨ítCÆlback
, finishParentCallback);

872 
	}
}

875 
	$ÊushDïŸSœbJou∫Æs
(
SœbDïŸ
 *
dïŸ
,

876 
VDOCom∂ëi⁄
 *
∑ª¡
,

877 
VDOA˘i⁄
 *
ˇŒback
,

878 
VDOA˘i⁄
 *
îr‹H™dÀr
)

880 
	`œunchOnAŒAŒoˇt‹s
(
dïŸ
, 
ÊushAŒoˇt‹SœbJou∫Æs
, 
∑ª¡
, 
ˇŒback
,

881 
îr‹H™dÀr
);

882 
	}
}

885 
	$upd©eSœbDïŸSize
(
SœbDïŸ
 *
dïŸ
, 
boﬁ
 
ªvîtög
)

887 
dïŸ
->
œ°Block
 = (
ªvîtög
 ? dïŸ->
ﬁdLa°Block
 : dïŸ->
√wLa°Block
);

888 
	}
}

891 
	$¥ï¨eToGrowSœbDïŸ
(
SœbDïŸ
 *
dïŸ
, 
BlockCou¡
 
√wSize
)

893 i‡(
dïŸ
->
√wSœbs
 !
NULL
) {

894 
	`ab™d⁄NewSœbs
(
dïŸ
);

897 i‡((
√wSize
 >> 
dïŸ
->
¶abSizeShi·
Ë<dïŸ->
¶abCou¡
) {

898  
VDO_INCREMENT_TOO_SMALL
;

902 
SœbDïŸSèã2_0
 
√wSèã
;

903 
ªsu…
 = 
	`c⁄figuªSèã
(
√wSize
, 
dïŸ
->
fú°Block
, dïŸ->
¶abC⁄fig
,

904 
dïŸ
->
z⁄eCou¡
, &
√wSèã
);

905 i‡(
ªsu…
 !
VDO_SUCCESS
) {

906  
ªsu…
;

909 
SœbCou¡
 
√wSœbCou¡
 = 
	`ˇlcuœãSœbCou¡
(
dïŸ
->
fú°Block
,

910 
√wSèã
.
œ°Block
,

911 
dïŸ
->
¶abSizeShi·
);

913 i‡(
√wSœbCou¡
 <
dïŸ
->
¶abCou¡
) {

914  
	`logEº‹WôhSåögEº‹
(
VDO_INCREMENT_TOO_SMALL
,

918 
ªsu…
 = 
	`ÆloˇãSœbs
(
dïŸ
, dïŸ->
com∂ëi⁄
.
œyî
, 
√wSœbCou¡
);

919 i‡(
ªsu…
 !
VDO_SUCCESS
) {

920 
	`ab™d⁄NewSœbs
(
dïŸ
);

921  
ªsu…
;

924 
dïŸ
->
√wSize
 =ÇewSize;

925 
dïŸ
->
ﬁdLa°Block
 = dïŸ->
œ°Block
;

926 
dïŸ
->
√wLa°Block
 = 
√wSèã
.
œ°Block
;

928  
VDO_SUCCESS
;

929 
	}
}

937 
	$föishRegi°øti⁄
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

939 
SœbDïŸ
 *
dïŸ
 = 
com∂ëi⁄
->
∑ª¡
;

940 
dïŸ
->
ªsizeSãpReque°ed
 = 
DEPOT_RESIZE_NONE
;

942 
dïŸ
->
¶abCou¡
 = dïŸ->
√wSœbCou¡
;

943 
	`FREE
(
dïŸ
->
¶abs
);

944 
dïŸ
->
¶abs
 = dïŸ->
√wSœbs
;

945 
dïŸ
->
√wSœbs
 = 
NULL
;

946 
dïŸ
->
√wSœbCou¡
 = 0;

949 
	`commôOlde°SœbJou∫ÆTaûBlocks
(
dïŸ
, dïŸ->
√wRñó£Reque°
);

950 
	`com∂ëeCom∂ëi⁄
(&
dïŸ
->
subTaskCom∂ëi⁄
);

951 
	}
}

958 
	$h™dÀRegi°øti⁄Eº‹
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

960 
SœbDïŸ
 *
dïŸ
 = 
com∂ëi⁄
->
∑ª¡
;

961 
dïŸ
->
ªsizeSãpReque°ed
 = 
DEPOT_RESIZE_NONE
;

962 
	`föishCom∂ëi⁄
(&
dïŸ
->
subTaskCom∂ëi⁄
, 
com∂ëi⁄
->
ªsu…
);

963 
	}
}

970 
	$ªgi°îNewSœbs
(
SœbDïŸ
 *
dïŸ
) {

971 
	`œunchOnAŒAŒoˇt‹s
(
dïŸ
, 
ªgi°îNewSœbsF‹AŒoˇt‹
, depot,

972 
föishRegi°øti⁄
, 
h™dÀRegi°øti⁄Eº‹
);

973 
	}
}

976 
	$u£NewSœbs
(
SœbDïŸ
 *
dïŸ
,

977 
VDOCom∂ëi⁄
 *
∑ª¡
,

978 
VDOA˘i⁄
 *
ˇŒback
,

979 
VDOA˘i⁄
 *
îr‹H™dÀr
)

981 
	`ASSERT_LOG_ONLY
(
dïŸ
->
√wSœbs
 !
NULL
, "Must haveÇew slabsÅo use");

982 
	`¥ï¨eCom∂ëi⁄
(&
dïŸ
->
subTaskCom∂ëi⁄
, 
ˇŒback
, 
îr‹H™dÀr
,

983 
∑ª¡
->
ˇŒbackThªadID
,Öarent);

984 
dïŸ
->
ªsizeSãpReque°ed
 = 
DEPOT_RESIZE_REGISTER_SLABS
;

985 i‡(!
dïŸ
->
lockRñó£A˘ive
) {

986 
	`ªgi°îNewSœbs
(
dïŸ
);

988 
	}
}

995 
	$föishSumm¨yO≥øti⁄
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

997 
SœbDïŸ
 *
dïŸ
 = 
com∂ëi⁄
->
∑ª¡
;

998 
dïŸ
->
ªsizeSãpReque°ed
 = 
DEPOT_RESIZE_NONE
;

1001 
	`commôOlde°SœbJou∫ÆTaûBlocks
(
dïŸ
, dïŸ->
√wRñó£Reque°
);

1002 
	`com∂ëeCom∂ëi⁄
(&
dïŸ
->
subTaskCom∂ëi⁄
);

1003 
	}
}

1010 
	$h™dÀSumm¨yEº‹
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

1012 
SœbDïŸ
 *
dïŸ
 = 
com∂ëi⁄
->
∑ª¡
;

1013 
dïŸ
->
ªsizeSãpReque°ed
 = 
DEPOT_RESIZE_NONE
;

1014 
	`föishCom∂ëi⁄
(&
dïŸ
->
subTaskCom∂ëi⁄
, 
com∂ëi⁄
->
ªsu…
);

1015 
	}
}

1022 
	$su•ídSumm¨y
(
SœbDïŸ
 *
dïŸ
)

1024 
	`œunchOnAŒAŒoˇt‹s
(
dïŸ
, 
su•ídSumm¨yZ⁄e
, depot,

1025 
föishSumm¨yO≥øti⁄
, 
h™dÀSumm¨yEº‹
);

1026 
	}
}

1029 
	$su•ídSœbSumm¨y
(
SœbDïŸ
 *
dïŸ
,

1030 
VDOCom∂ëi⁄
 *
∑ª¡
,

1031 
VDOA˘i⁄
 *
ˇŒback
,

1032 
VDOA˘i⁄
 *
îr‹H™dÀr
)

1034 
dïŸ
->
ªsizeSãpReque°ed
 = 
DEPOT_RESIZE_SUSPEND_SUMMARY
;

1035 
	`¥ï¨eCom∂ëi⁄
(&
dïŸ
->
subTaskCom∂ëi⁄
, 
ˇŒback
, 
îr‹H™dÀr
,

1036 
∑ª¡
->
ˇŒbackThªadID
,Öarent);

1037 i‡(!
dïŸ
->
lockRñó£A˘ive
) {

1038 
	`su•ídSumm¨y
(
dïŸ
);

1040 
	}
}

1047 
	$ªsumeSumm¨y
(
SœbDïŸ
 *
dïŸ
)

1049 
	`œunchOnAŒAŒoˇt‹s
(
dïŸ
, 
ªsumeSumm¨yZ⁄e
, depot,

1050 
föishSumm¨yO≥øti⁄
, 
h™dÀSumm¨yEº‹
);

1051 
	}
}

1054 
	$ªsumeSœbSumm¨y
(
SœbDïŸ
 *
dïŸ
,

1055 
VDOCom∂ëi⁄
 *
∑ª¡
,

1056 
VDOA˘i⁄
 *
ˇŒback
,

1057 
VDOA˘i⁄
 *
îr‹H™dÀr
)

1059 
dïŸ
->
ªsizeSãpReque°ed
 = 
DEPOT_RESIZE_RESUME_SUMMARY
;

1060 
	`¥ï¨eCom∂ëi⁄
(&
dïŸ
->
subTaskCom∂ëi⁄
, 
ˇŒback
, 
îr‹H™dÀr
,

1061 
∑ª¡
->
ˇŒbackThªadID
,Öarent);

1062 i‡(!
dïŸ
->
lockRñó£A˘ive
) {

1063 
	`ªsumeSumm¨y
(
dïŸ
);

1065 
	}
}

1068 
	$ßveSœbDïŸ
(
SœbDïŸ
 *
dïŸ
, 
boﬁ
 
˛o£
, 
VDOCom∂ëi⁄
 *
∑ª¡
)

1070 
	`ASSERT_LOG_ONLY
((
	`gëCÆlbackThªadID
(Ë=
dïŸ
->
ªcovîyJou∫ÆThªadID
),

1072 
dïŸ
->
ßveReque°ed
 = 
˛o£
;

1073 
	`¥ï¨eToFöishP¨ít
(&
dïŸ
->
ßveCom∂ëi⁄
, 
∑ª¡
);

1074 
AŒoˇt‹A˘i⁄
 *
a˘i⁄


1075 (
˛o£
 ? 
˛o£BlockAŒoˇt‹
 : 
ßveBlockAŒoˇt‹F‹FuŒRebuûd
);

1077 i‡(!
dïŸ
->
lockRñó£A˘ive
) {

1078 
	`≠∂yToAŒAŒoˇt‹s
(
dïŸ
, 
a˘i⁄
, &dïŸ->
ßveCom∂ëi⁄
);

1080 
	}
}

1089 
	$föishRñósögJou∫ÆLocks
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

1091 
SœbDïŸ
 *
dïŸ
 = 
com∂ëi⁄
->
∑ª¡
;

1092 
	`ASSERT_LOG_ONLY
((
	`gëCÆlbackThªadID
(Ë=
dïŸ
->
ªcovîyJou∫ÆThªadID
),

1095 
dïŸ
->
lockRñó£A˘ive
 = 
Ál£
;

1096 i‡(
dïŸ
->
ßveReque°ed
) {

1097 
	`≠∂yToAŒAŒoˇt‹s
(
dïŸ
, 
˛o£BlockAŒoˇt‹
, &dïŸ->
ßveCom∂ëi⁄
);

1101 i‡(
dïŸ
->
ªsizeSãpReque°ed
 =
DEPOT_RESIZE_REGISTER_SLABS
) {

1102 
	`ªgi°îNewSœbs
(
dïŸ
);

1106 i‡(
dïŸ
->
ªsizeSãpReque°ed
 =
DEPOT_RESIZE_RESUME_SUMMARY
) {

1107 
	`ªsumeSumm¨y
(
dïŸ
);

1111 i‡(
dïŸ
->
ªsizeSãpReque°ed
 =
DEPOT_RESIZE_SUSPEND_SUMMARY
) {

1112 
	`su•ídSumm¨y
(
dïŸ
);

1116 
	`commôOlde°SœbJou∫ÆTaûBlocks
(
dïŸ
, dïŸ->
√wRñó£Reque°
);

1117 
	}
}

1120 
	$commôOlde°SœbJou∫ÆTaûBlocks
(
SœbDïŸ
 *
dïŸ
,

1121 
Sequí˚Numbî
 
ªcovîyBlockNumbî
)

1123 i‡(
dïŸ
 =
NULL
) {

1127 
	`ASSERT_LOG_ONLY
((
	`gëCÆlbackThªadID
(Ë=
dïŸ
->
ªcovîyJou∫ÆThªadID
),

1130 i‡(
dïŸ
->
ßveReque°ed
) {

1134 
dïŸ
->
√wRñó£Reque°
 = 
ªcovîyBlockNumbî
;

1135 i‡(
dïŸ
->
lockRñó£A˘ive


1136 || (
dïŸ
->
ªsizeSãpReque°ed
 !
DEPOT_RESIZE_NONE
)

1137 || (
dïŸ
->
√wRñó£Reque°
 =dïŸ->
a˘iveRñó£Reque°
)) {

1141 
dïŸ
->
lockRñó£A˘ive
 = 
åue
;

1142 
dïŸ
->
a˘iveRñó£Reque°
 = dïŸ->
√wRñó£Reque°
;

1143 
	`œunchOnAŒAŒoˇt‹s
(
dïŸ
, 
ªÀa£TaûBlockLocks
, depot,

1144 
föishRñósögJou∫ÆLocks
,

1145 
föishRñósögJou∫ÆLocks
);

1146 
	}
}

1149 c⁄° 
SœbC⁄fig
 *
	$gëSœbC⁄fig
(c⁄° 
SœbDïŸ
 *
dïŸ
)

1151  &
dïŸ
->
¶abC⁄fig
;

1152 
	}
}

1155 
SœbSumm¨y
 *
	$gëSœbSumm¨y
(c⁄° 
SœbDïŸ
 *
dïŸ
)

1157  
dïŸ
->
¶abSumm¨y
;

1158 
	}
}

1161 
SœbSumm¨yZ⁄e
 *
	$gëSœbSumm¨yF‹Z⁄e
(c⁄° 
SœbDïŸ
 *
dïŸ
, 
Z⁄eCou¡
 
z⁄e
)

1163 i‡(
dïŸ
->
¶abSumm¨y
 =
NULL
) {

1164  
NULL
;

1166  
	`gëSumm¨yF‹Z⁄e
(
dïŸ
->
¶abSumm¨y
, 
z⁄e
);

1167 
	}
}

1170 
	$s¸ubAŒUƒecovîedSœbs
(
SœbDïŸ
 *
dïŸ
,

1171 *
∑ª¡
,

1172 
VDOA˘i⁄
 *
ˇŒback
,

1173 
VDOA˘i⁄
 *
îr‹H™dÀr
,

1174 
ThªadID
 
thªadID
,

1175 
VDOCom∂ëi⁄
 *
œunchP¨ít
)

1177 
	`¥ï¨eCom∂ëi⁄
(&
dïŸ
->
subTaskCom∂ëi⁄
, 
ˇŒback
, 
îr‹H™dÀr
,

1178 
thªadID
, 
∑ª¡
);

1179 
	`œunchOnAŒAŒoˇt‹s
(
dïŸ
, 
s¸ubAŒUƒecovîedSœbsInZ⁄e
, 
œunchP¨ít
,

1180 
föishP¨ítCÆlback
, finishParentCallback);

1181 
	}
}

1184 
	$nŸifyZ⁄eSt›≥dS¸ubbög
(
SœbDïŸ
 *
dïŸ
)

1187 
Z⁄eCou¡
 
z⁄esS¸ubbög
 = 
	`©omicLﬂd32
(&
dïŸ
->
z⁄esToS¸ub
);

1188 i‡(!
	`com∑ªAndSw≠32
(&
dïŸ
->
z⁄esToS¸ub
, 
z⁄esS¸ubbög
,

1189 
z⁄esS¸ubbög
 - 1)) {

1194 i‡(
z⁄esS¸ubbög
 == 1) {

1196 
	`com∂ëeCom∂ëi⁄
(&
dïŸ
->
subTaskCom∂ëi⁄
);

1201 
	}
}

1204 
boﬁ
 
	$hasUƒecovîedSœbs
(
SœbDïŸ
 *
dïŸ
)

1206  (
	`©omicLﬂd32
(&
dïŸ
->
z⁄esToS¸ub
) > 0);

1207 
	}
}

1210 
BlockCou¡
 
	$gëNewDïŸSize
(c⁄° 
SœbDïŸ
 *
dïŸ
)

1212  (
dïŸ
->
√wSœbs
 =
NULL
Ë? 0 : dïŸ->
√wSize
;

1213 
	}
}

1216 
boﬁ
 
	$¨eEquivÆítDïŸs
(
SœbDïŸ
 *
dïŸA
, SœbDïŸ *
dïŸB
)

1218 i‡((
dïŸA
->
fú°Block
 !
dïŸB
->firstBlock)

1219 || (
dïŸA
->
œ°Block
 !
dïŸB
->lastBlock)

1220 || (
dïŸA
->
¶abCou¡
 !
dïŸB
->slabCount)

1221 || (
dïŸA
->
¶abSizeShi·
 !
dïŸB
->slabSizeShift)

1222 || (
	`gëDïŸAŒoˇãdBlocks
(
dïŸA
)

1223 !
	`gëDïŸAŒoˇãdBlocks
(
dïŸB
))) {

1224  
Ál£
;

1227 
size_t
 
i
 = 0; i < 
dïŸA
->
¶abCou¡
; i++) {

1228 
Sœb
 *
¶abA
 = 
dïŸA
->
¶abs
[
i
];

1229 
Sœb
 *
¶abB
 = 
dïŸB
->
¶abs
[
i
];

1230 i‡((
¶abA
->
°¨t
 !
¶abB
->start)

1231 || (
¶abA
->
íd
 !
¶abB
->end)

1232 || !
	`¨eEquivÆítRe„ªn˚Cou¡îs
(
¶abA
->
ª„ªn˚Cou¡s
,

1233 
¶abB
->
ª„ªn˚Cou¡s
)) {

1234  
Ál£
;

1238  
åue
;

1239 
	}
}

1242 
	$ÆloˇãFromLa°Sœb
(
SœbDïŸ
 *
dïŸ
)

1244 
Z⁄eCou¡
 
z⁄e
 = 0; z⁄ê< 
dïŸ
->
z⁄eCou¡
; zone++) {

1245 
	`ÆloˇãFromAŒoˇt‹La°Sœb
(
dïŸ
->
Æloˇt‹s
[
z⁄e
]);

1247 
	}
}

1250 
BlockAŒoˇt‹Sèti°ics


1251 
	$gëDïŸBlockAŒoˇt‹Sèti°ics
(c⁄° 
SœbDïŸ
 *
dïŸ
)

1253 
BlockAŒoˇt‹Sèti°ics
 
tŸÆs
;

1254 
	`mem£t
(&
tŸÆs
, 0, (totals));

1256 
Z⁄eCou¡
 
z⁄e
 = 0; z⁄ê< 
dïŸ
->
z⁄eCou¡
; zone++) {

1257 
BlockAŒoˇt‹
 *
Æloˇt‹
 = 
dïŸ
->
Æloˇt‹s
[
z⁄e
];

1258 
BlockAŒoˇt‹Sèti°ics
 
°©s
 = 
	`gëBlockAŒoˇt‹Sèti°ics
(
Æloˇt‹
);

1259 
tŸÆs
.
¶abCou¡
 +
°©s
.slabCount;

1260 
tŸÆs
.
¶absO≥√d
 +
°©s
.slabsOpened;

1261 
tŸÆs
.
¶absRe›íed
 +
°©s
.slabsReopened;

1264  
tŸÆs
;

1265 
	}
}

1268 
RefCou¡sSèti°ics
 
	$gëDïŸRefCou¡sSèti°ics
(c⁄° 
SœbDïŸ
 *
dïŸ
)

1270 
RefCou¡sSèti°ics
 
dïŸSèts
;

1271 
	`mem£t
(&
dïŸSèts
, 0, (depotStats));

1273 
Z⁄eCou¡
 
z⁄e
 = 0; z⁄ê< 
dïŸ
->
z⁄eCou¡
; zone++) {

1274 
BlockAŒoˇt‹
 *
Æloˇt‹
 = 
dïŸ
->
Æloˇt‹s
[
z⁄e
];

1275 
RefCou¡sSèti°ics
 
°©s
 = 
	`gëRefCou¡sSèti°ics
(
Æloˇt‹
);

1276 
dïŸSèts
.
blocksWrôãn
 +
°©s
.blocksWritten;

1279  
dïŸSèts
;

1280 
	}
}

1283 
SœbJou∫ÆSèti°ics
 
	$gëDïŸSœbJou∫ÆSèti°ics
(c⁄° 
SœbDïŸ
 *
dïŸ
)

1285 
SœbJou∫ÆSèti°ics
 
dïŸSèts
;

1286 
	`mem£t
(&
dïŸSèts
, 0, (depotStats));

1288 
Z⁄eCou¡
 
z⁄e
 = 0; z⁄ê< 
dïŸ
->
z⁄eCou¡
; zone++) {

1289 
BlockAŒoˇt‹
 *
Æloˇt‹
 = 
dïŸ
->
Æloˇt‹s
[
z⁄e
];

1290 
SœbJou∫ÆSèti°ics
 
°©s
 = 
	`gëSœbJou∫ÆSèti°ics
(
Æloˇt‹
);

1291 
dïŸSèts
.
diskFuŒCou¡
 +
°©s
.diskFullCount;

1292 
dïŸSèts
.
ÊushCou¡
 +
°©s
.flushCount;

1293 
dïŸSèts
.
blockedCou¡
 +
°©s
.blockedCount;

1294 
dïŸSèts
.
blocksWrôãn
 +
°©s
.blocksWritten;

1295 
dïŸSèts
.
èûBusyCou¡
 +
°©s
.tailBusyCount;

1298  
dïŸSèts
;

1299 
	}
}

1302 
	$dumpSœbDïŸ
(c⁄° 
SœbDïŸ
 *
dïŸ
)

1304 
	`logInfo
("Slab Depot");

1305 
	`logInfo
(" z⁄eCou¡=%u oldZ⁄eCou¡=%u sœbCou¡=%" 
PRIu32


1306 "á˘iveRñó£Reque°=%" 
PRIu64
 "ÇewReleaseRequest=%" PRIu64,

1307 (Ë
dïŸ
->
z⁄eCou¡
, (ËdïŸ->
ﬁdZ⁄eCou¡
,

1308 
dïŸ
->
¶abCou¡
, dïŸ->
a˘iveRñó£Reque°
,

1309 
dïŸ
->
√wRñó£Reque°
);

1310 
	}
}

	@vdo/base/slabDepot.h

22 #i‚de‡
SLAB_DEPOT_H


23 
	#SLAB_DEPOT_H


	)

25 
	~"buf„r.h
"

27 
	~"com∂ëi⁄.h
"

28 
	~"fixedLayout.h
"

29 
	~"jou∫ÆPoöt.h
"

30 
	~"°©i°ics.h
"

31 
	~"ty≥s.h
"

32 
	~"waôQueue.h
"

49 
	mNORMAL_LOAD
,

50 
	mDEFER_LOAD
,

51 
	mNO_LOAD


52 } 
	tSœbDïŸLﬂdTy≥
;

63 
SœbCou¡
 
	$ˇlcuœãSœbCou¡
(
PhysiˇlBlockNumbî
 
fú°Block
,

64 
PhysiˇlBlockNumbî
 
œ°Block
,

65 
¶abSizeShi·
)

66 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

88 
	$makeSœbDïŸ
(
BlockCou¡
 
blockCou¡
,

89 
PhysiˇlBlockNumbî
 
fú°Block
,

90 
SœbC⁄fig
 
¶abC⁄fig
,

91 c⁄° 
ThªadC⁄fig
 *
thªadC⁄fig
,

92 
N⁄˚
 
n⁄˚
,

93 
BlockCou¡
 
vioPoﬁSize
,

94 
BlockCou¡
 
des¸ùt‹PoﬁSize
,

95 
PhysiˇlLayî
 *
œyî
,

96 
P¨tôi⁄
 *
summ¨yP¨tôi⁄
,

97 
RódO∆yModeC⁄ãxt
 *
ªadO∆yC⁄ãxt
,

98 
RecovîyJou∫Æ
 *
ªcovîyJou∫Æ
,

99 
SœbDïŸ
 **
dïŸPå
)

100 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

107 
	`‰ìSœbDïŸ
(
SœbDïŸ
 **
dïŸPå
);

114 
size_t
 
	$gëSœbDïŸEncodedSize
()

115 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

125 
	$ícodeSœbDïŸ
(c⁄° 
SœbDïŸ
 *
dïŸ
, 
Buf„r
 *
buf„r
)

126 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

142 
	$decodeSodiumSœbDïŸ
(
Buf„r
 *
buf„r
,

143 c⁄° 
ThªadC⁄fig
 *
thªadC⁄fig
,

144 
N⁄˚
 
n⁄˚
,

145 
PhysiˇlLayî
 *
œyî
,

146 
P¨tôi⁄
 *
summ¨yP¨tôi⁄
,

147 
RódO∆yModeC⁄ãxt
 *
ªadO∆yC⁄ãxt
,

148 
RecovîyJou∫Æ
 *
ªcovîyJou∫Æ
,

149 
SœbDïŸ
 **
dïŸPå
)

150 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

166 
	$decodeSœbDïŸ
(
Buf„r
 *
buf„r
,

167 c⁄° 
ThªadC⁄fig
 *
thªadC⁄fig
,

168 
N⁄˚
 
n⁄˚
,

169 
PhysiˇlLayî
 *
œyî
,

170 
P¨tôi⁄
 *
summ¨yP¨tôi⁄
,

171 
RódO∆yModeC⁄ãxt
 *
ªadO∆yC⁄ãxt
,

172 
RecovîyJou∫Æ
 *
ªcovîyJou∫Æ
,

173 
SœbDïŸ
 **
dïŸPå
)

174 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

185 
	$ÆloˇãSœbRefCou¡s
(
SœbDïŸ
 *
dïŸ
, 
PhysiˇlLayî
 *
œyî
)

186 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

196 
BlockAŒoˇt‹
 *
	$gëBlockAŒoˇt‹F‹Z⁄e
(
SœbDïŸ
 *
dïŸ
,

197 
Z⁄eCou¡
 
z⁄eNumbî
)

198 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

209 
	$gëSœbNumbî
(c⁄° 
SœbDïŸ
 *
dïŸ
,

210 
PhysiˇlBlockNumbî
 
pbn
,

211 
SœbCou¡
 *
¶abNumbîPå
)

212 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

225 
Sœb
 *
	$gëSœb
(c⁄° 
SœbDïŸ
 *
dïŸ
, 
PhysiˇlBlockNumbî
 
pbn
)

226 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

238 
SœbJou∫Æ
 *
	$gëSœbJou∫Æ
(c⁄° 
SœbDïŸ
 *
dïŸ
, 
PhysiˇlBlockNumbî
 
pbn
)

239 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

250 
uöt8_t
 
	$gëIn¸emítLimô
(
SœbDïŸ
 *
dïŸ
, 
PhysiˇlBlockNumbî
 
pbn
)

251 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

261 
boﬁ
 
	$isPhysiˇlD©aBlock
(c⁄° 
SœbDïŸ
 *
dïŸ
, 
PhysiˇlBlockNumbî
 
pbn
)

262 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

273 
BlockCou¡
 
	$gëDïŸAŒoˇãdBlocks
(c⁄° 
SœbDïŸ
 *
dïŸ
)

274 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

283 
BlockAŒoˇt‹Sèti°ics


284 
	$gëDïŸBlockAŒoˇt‹Sèti°ics
(c⁄° 
SœbDïŸ
 *
dïŸ
)

285 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

295 
BlockCou¡
 
	$gëDïŸD©aBlocks
(c⁄° 
SœbDïŸ
 *
dïŸ
)

296 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

307 
BlockCou¡
 
	$gëDïŸFªeBlocks
(c⁄° 
SœbDïŸ
 *
dïŸ
)

308 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

317 
SœbCou¡
 
	$gëDïŸSœbCou¡
(c⁄° 
SœbDïŸ
 *
dïŸ
)

318 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

329 
SœbCou¡
 
	$gëDïŸUƒecovîedSœbCou¡
(c⁄° 
SœbDïŸ
 *
dïŸ
)

330 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

339 
SœbJou∫ÆSèti°ics
 
	$gëDïŸSœbJou∫ÆSèti°ics
(c⁄° 
SœbDïŸ
 *
dïŸ
)

340 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

349 
RefCou¡sSèti°ics
 
	$gëDïŸRefCou¡sSèti°ics
(c⁄° 
SœbDïŸ
 *
dïŸ
)

350 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

362 
	`lﬂdSœbDïŸ
(
SœbDïŸ
 *
dïŸ
, 
boﬁ
 
f‹m©DïŸ
, 
VDOCom∂ëi⁄
 *
∑ª¡
);

372 
	`lﬂdSœbDïŸF‹Recovîy
(
SœbDïŸ
 *
dïŸ
, 
VDOCom∂ëi⁄
 *
∑ª¡
);

382 
	`lﬂdSœbDïŸF‹Rebuûd
(
SœbDïŸ
 *
dïŸ
, 
VDOCom∂ëi⁄
 *
∑ª¡
);

393 
	`¥ï¨eToAŒoˇã
(
SœbDïŸ
 *
dïŸ
,

394 
SœbDïŸLﬂdTy≥
 
lﬂdTy≥
,

395 
VDOCom∂ëi⁄
 *
∑ª¡
);

406 
	`ÊushDïŸSœbJou∫Æs
(
SœbDïŸ
 *
dïŸ
,

407 
VDOCom∂ëi⁄
 *
∑ª¡
,

408 
VDOA˘i⁄
 *
ˇŒback
,

409 
VDOA˘i⁄
 *
îr‹H™dÀr
);

418 
	`upd©eSœbDïŸSize
(
SœbDïŸ
 *
dïŸ
, 
boﬁ
 
ªvîtög
);

428 
	$¥ï¨eToGrowSœbDïŸ
(
SœbDïŸ
 *
dïŸ
, 
BlockCou¡
 
√wSize
)

429 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

439 
	`su•ídSœbSumm¨y
(
SœbDïŸ
 *
dïŸ
,

440 
VDOCom∂ëi⁄
 *
∑ª¡
,

441 
VDOA˘i⁄
 *
ˇŒback
,

442 
VDOA˘i⁄
 *
îr‹H™dÀr
);

452 
	`ªsumeSœbSumm¨y
(
SœbDïŸ
 *
dïŸ
,

453 
VDOCom∂ëi⁄
 *
∑ª¡
,

454 
VDOA˘i⁄
 *
ˇŒback
,

455 
VDOA˘i⁄
 *
îr‹H™dÀr
);

465 
	`u£NewSœbs
(
SœbDïŸ
 *
dïŸ
,

466 
VDOCom∂ëi⁄
 *
∑ª¡
,

467 
VDOA˘i⁄
 *
ˇŒback
,

468 
VDOA˘i⁄
 *
îr‹H™dÀr
);

475 
	`ab™d⁄NewSœbs
(
SœbDïŸ
 *
dïŸ
);

487 
	`ßveSœbDïŸ
(
SœbDïŸ
 *
dïŸ
, 
boﬁ
 
˛o£
, 
VDOCom∂ëi⁄
 *
∑ª¡
);

497 
	`commôOlde°SœbJou∫ÆTaûBlocks
(
SœbDïŸ
 *
dïŸ
,

498 
Sequí˚Numbî
 
ªcovîyBlockNumbî
);

507 c⁄° 
SœbC⁄fig
 *
	$gëSœbC⁄fig
(c⁄° 
SœbDïŸ
 *
dïŸ
)

508 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

517 
SœbSumm¨y
 *
	$gëSœbSumm¨y
(c⁄° 
SœbDïŸ
 *
dïŸ
)

518 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

528 
SœbSumm¨yZ⁄e
 *
	$gëSœbSumm¨yF‹Z⁄e
(c⁄° 
SœbDïŸ
 *
dïŸ
, 
Z⁄eCou¡
 
z⁄e
)

529 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

542 
	`s¸ubAŒUƒecovîedSœbs
(
SœbDïŸ
 *
dïŸ
,

543 *
∑ª¡
,

544 
VDOA˘i⁄
 *
ˇŒback
,

545 
VDOA˘i⁄
 *
îr‹H™dÀr
,

546 
ThªadID
 
thªadID
,

547 
VDOCom∂ëi⁄
 *
œunchP¨ít
);

556 
boﬁ
 
	`hasUƒecovîedSœbs
(
SœbDïŸ
 *
dïŸ
);

566 
BlockCou¡
 
	$gëNewDïŸSize
(c⁄° 
SœbDïŸ
 *
dïŸ
)

567 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

574 
	`dumpSœbDïŸ
(c⁄° 
SœbDïŸ
 *
dïŸ
);

	@vdo/base/slabDepotInternals.h

22 #i‚de‡
SLAB_DEPOT_INTERNALS_H


23 
	#SLAB_DEPOT_INTERNALS_H


	)

25 
	~"¶abDïŸ.h
"

27 
	~"utû/©omic.h
"

40 
	tAŒoˇt‹A˘i⁄
(
	tBlockAŒoˇt‹
 *
	tÆloˇt‹
,

41 
	tVDOCom∂ëi⁄
 *
	t∑ª¡
,

42 
	tVDOA˘i⁄
 *
	tˇŒback
,

43 
	tVDOA˘i⁄
 *
	tîr‹H™dÀr
);

46 
	mDEPOT_RESIZE_NONE
 = 0,

47 
	mDEPOT_RESIZE_REGISTER_SLABS
,

48 
	mDEPOT_RESIZE_RESUME_SUMMARY
,

49 
	mDEPOT_RESIZE_SUSPEND_SUMMARY
,

50 } 
	tDïŸResizeSãp
;

52 
	s¶abDïŸ
 {

53 
VDOCom∂ëi⁄
 
	mcom∂ëi⁄
;

54 
Z⁄eCou¡
 
	mz⁄eCou¡
;

55 
Z⁄eCou¡
 
	mﬁdZ⁄eCou¡
;

56 
SœbC⁄fig
 
	m¶abC⁄fig
;

57 
SœbSumm¨y
 *
	m¶abSumm¨y
;

58 
RódO∆yModeC⁄ãxt
 *
	mªadO∆yC⁄ãxt
;

60 
PhysiˇlBlockNumbî
 
	mfú°Block
;

61 
PhysiˇlBlockNumbî
 
	mœ°Block
;

62 
PhysiˇlBlockNumbî
 
	m‹igö
;

65 
	m¶abSizeShi·
;

68 
VDOCom∂ëi⁄
 *
	m¶abCom∂ëi⁄
;

71 
VDOCom∂ëi⁄
 
	ma˘i⁄Com∂ëi⁄
;

73 
AŒoˇt‹A˘i⁄
 *
	ma˘i⁄
;

75 
Z⁄eCou¡
 
	ma˘ögZ⁄e
;

78 
SœbDïŸLﬂdTy≥
 
	mlﬂdTy≥
;

84 
Sequí˚Numbî
 
	ma˘iveRñó£Reque°
;

85 
Sequí˚Numbî
 
	m√wRñó£Reque°
;

86 
boﬁ
 
	mlockRñó£A˘ive
;

87 
ThªadID
 
	mªcovîyJou∫ÆThªadID
;

90 
VDOCom∂ëi⁄
 
	mßveCom∂ëi⁄
;

91 
boﬁ
 
	mßveReque°ed
;

94 
VDOCom∂ëi⁄
 
	msubTaskCom∂ëi⁄
;

95 
Atomic32
 
	mz⁄esToS¸ub
;

98 
RecovîyJou∫Æ
 *
	mjou∫Æ
;

100 
DïŸResizeSãp
 
	mªsizeSãpReque°ed
;

103 
Sœb
 **
	m¶abs
;

105 
SœbCou¡
 
	m¶abCou¡
;

108 
Sœb
 **
	m√wSœbs
;

110 
SœbCou¡
 
	m√wSœbCou¡
;

112 
BlockCou¡
 
	m√wSize
;

115 
PhysiˇlBlockNumbî
 
	mﬁdLa°Block
;

117 
PhysiˇlBlockNumbî
 
	m√wLa°Block
;

120 
BlockAŒoˇt‹
 *
	mÆloˇt‹s
[];

128 
de°roySœb
(
Sœb
 *
¶ab
);

135 
ªgi°îSœbWôhDïŸ
(
Sœb
 *
¶ab
);

142 
nŸifyZ⁄eSt›≥dS¸ubbög
(
SœbDïŸ
 *
dïŸ
);

154 
boﬁ
 
	$¨eEquivÆítDïŸs
(
SœbDïŸ
 *
dïŸA
, SœbDïŸ *
dïŸB
)

155 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

162 
	`ÆloˇãFromLa°Sœb
(
SœbDïŸ
 *
dïŸ
);

	@vdo/base/slabIterator.h

22 #i‚de‡
SLAB_ITERATOR_H


23 
	#SLAB_ITERATOR_H


	)

25 
	~"¶ab.h
"

26 
	~"ty≥s.h
"

32 
Sœb
 **
	m¶abs
;

33 
Sœb
 *
	m√xt
;

34 
SœbCou¡
 
	míd
;

35 
SœbCou¡
 
	m°ride
;

36 } 
	tSœbIãøt‹
;

50 
ölöe
 
SœbIãøt‹
 
	$ôî©eSœbs
(
Sœb
 **
¶abs
,

51 
SœbCou¡
 
°¨t
,

52 
SœbCou¡
 
íd
,

53 
SœbCou¡
 
°ride
)

55  (
SœbIãøt‹
) {

56 .
¶abs
 = slabs,

57 .
√xt
 = (((
¶abs
 =
NULL
Ë|| (
°¨t
 < 
íd
)) ? NULL : slabs[start]),

58 .
íd
 =Énd,

59 .
°ride
 = stride,

61 
	}
}

71 
ölöe
 
boﬁ
 
	$hasNextSœb
(c⁄° 
SœbIãøt‹
 *
ôî©‹
)

73  (
ôî©‹
->
√xt
 !
NULL
);

74 
	}
}

84 
ölöe
 
Sœb
 *
	$√xtSœb
(
SœbIãøt‹
 *
ôî©‹
)

86 
Sœb
 *
¶ab
 = 
ôî©‹
->
√xt
;

87 i‡((
¶ab
 =
NULL
)

88 || (
¶ab
->
¶abNumbî
 < 
ôî©‹
->
íd
 + iãøt‹->
°ride
)) {

89 
ôî©‹
->
√xt
 = 
NULL
;

91 
ôî©‹
->
√xt
 = iãøt‹->
¶abs
[
¶ab
->
¶abNumbî
 - iãøt‹->
°ride
];

93  
¶ab
;

94 
	}
}

	@vdo/base/slabJournal.c

22 
	~"¶abJou∫ÆI¡î«ls.h
"

24 
	~"loggî.h
"

25 
	~"mem‹yAŒoc.h
"

26 
	~"°rögUtûs.h
"

28 
	~"blockAŒoˇt‹I¡î«ls.h
"

29 
	~"d©aVIO.h
"

30 
	~"ªcovîyJou∫Æ.h
"

31 
	~"ªfCou¡s.h
"

32 
	~"¶abDïŸ.h
"

33 
	~"¶abSumm¨y.h
"

36 
SœbJou∫Æ
 *
	$asSœbJou∫Æ
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

38 
	`STATIC_ASSERT
(
	`off£tof
(
SœbJou∫Æ
, 
com∂ëi⁄
) == 0);

39 
	`as£πCom∂ëi⁄Ty≥
(
com∂ëi⁄
->
ty≥
, 
SLAB_JOURNAL_COMPLETION
);

40  (
SœbJou∫Æ
 *Ë
com∂ëi⁄
;

41 
	}
}

50 
__©åibuã__
((
w¨n_unu£d_ªsu…
))

51 
ölöe
 
SœbJou∫Æ
 *
	$¶abJou∫ÆFromResour˚Waôî
(
Waôî
 *
waôî
)

53 i‡(
waôî
 =
NULL
) {

54  
NULL
;

56  (
SœbJou∫Æ
 *)

57 ((
uöçå_t
Ë
waôî
 - 
	`off£tof
(
SœbJou∫Æ
, 
ªsour˚Waôî
));

58 
	}
}

67 
__©åibuã__
((
w¨n_unu£d_ªsu…
))

68 
ölöe
 
SœbJou∫Æ
 *
	$¶abJou∫ÆFromFlushWaôî
(
Waôî
 *
waôî
)

70 i‡(
waôî
 =
NULL
) {

71  
NULL
;

73  (
SœbJou∫Æ
 *)

74 ((
uöçå_t
Ë
waôî
 - 
	`off£tof
(
SœbJou∫Æ
, 
ÊushWaôî
));

75 
	}
}

78 
SœbJou∫Æ
 *
	$¶abJou∫ÆFromDútyNode
(
RögNode
 *
node
)

80 i‡(
node
 =
NULL
) {

81  
NULL
;

83  (
SœbJou∫Æ
 *Ë((
uöçå_t
Ë
node
 - 
	`off£tof
(SœbJou∫Æ, 
dútyNode
));

84 
	}
}

93 
__©åibuã__
((
w¨n_unu£d_ªsu…
))

94 
ölöe
 
SœbJou∫Æ
 *
	$¶abJou∫ÆFromSœbSumm¨yWaôî
(
Waôî
 *
waôî
)

96 i‡(
waôî
 =
NULL
) {

97  
NULL
;

99  (
SœbJou∫Æ
 *)

100 ((
uöçå_t
Ë
waôî
 - 
	`off£tof
(
SœbJou∫Æ
, 
¶abSumm¨yWaôî
));

101 
	}
}

111 
__©åibuã__
((
w¨n_unu£d_ªsu…
))

112 
ölöe
 
PhysiˇlBlockNumbî
 
	$gëBlockNumbî
(
SœbJou∫Æ
 *
jou∫Æ
,

113 
Sequí˚Numbî
 
£quí˚
)

115 
TaûBlockOff£t
 
off£t
 = 
	`gëSœbJou∫ÆBlockOff£t
(
jou∫Æ
, 
£quí˚
);

116  (
jou∫Æ
->
¶ab
->
jou∫ÆOrigö
 + 
off£t
);

117 
	}
}

127 
__©åibuã__
((
w¨n_unu£d_ªsu…
))

128 
ölöe
 
Jou∫ÆLock
 *
	$gëLock
(
SœbJou∫Æ
 *
jou∫Æ
,

129 
Sequí˚Numbî
 
£quí˚Numbî
)

131 
TaûBlockOff£t
 
off£t
 = 
	`gëSœbJou∫ÆBlockOff£t
(
jou∫Æ
, 
£quí˚Numbî
);

132  &
jou∫Æ
->
locks
[
off£t
];

133 
	}
}

142 
__©åibuã__
((
w¨n_unu£d_ªsu…
))

143 
ölöe
 
boﬁ
 
	$isVDORódO∆y
(
SœbJou∫Æ
 *
jou∫Æ
)

145  
	`isRódO∆y
(
jou∫Æ
->
¶ab
->
Æloˇt‹
->
ªadO∆yC⁄ãxt
);

146 
	}
}

156 
__©åibuã__
((
w¨n_unu£d_ªsu…
))

157 
ölöe
 
boﬁ
 
	$mu°MakeE¡rõsToFlush
(
SœbJou∫Æ
 *
jou∫Æ
)

159  (!
	`¶abIsRebuûdög
(
jou∫Æ
->
¶ab
)

160 && 
	`hasWaôîs
(&
jou∫Æ
->
íåyWaôîs
));

161 
	}
}

170 
__©åibuã__
((
w¨n_unu£d_ªsu…
))

171 
ölöe
 
boﬁ
 
	$isRópög
(
SœbJou∫Æ
 *
jou∫Æ
)

173  (
jou∫Æ
->
hód
 !jou∫Æ->
uƒó∑bÀ
);

174 
	}
}

182 
ölöe
 
	$checkF‹FlushCom∂ëe
(
SœbJou∫Æ
 *
jou∫Æ
)

184 i‡((
jou∫Æ
->
ÊushSèã
 !
FLUSH_INITIATED
)

185 || 
	`mu°MakeE¡rõsToFlush
(
jou∫Æ
)

186 || 
	`isRópög
(
jou∫Æ
)

187 || 
jou∫Æ
->
waôögToCommô


188 || !
	`isRögEm±y
(&
jou∫Æ
->
uncommôãdBlocks
)

189 || 
jou∫Æ
->
upd©ögSœbSumm¨y
) {

193 
jou∫Æ
->
ÊushSèã
 = 
NOT_FLUSHING
;

194 
	`föishCom∂ëi⁄
(&
jou∫Æ
->
com∂ëi⁄
,

195 (
	`isVDORódO∆y
(
jou∫Æ
Ë? 
VDO_READ_ONLY
 : 
VDO_SUCCESS
));

197 
	}
}

204 
	$öôülizeTaûBlock
(
SœbJou∫Æ
 *
jou∫Æ
)

206 
SœbJou∫ÆBlockHódî
 *
hódî
 = &
jou∫Æ
->
block
->header;

207 
hódî
->
£quí˚Numbî
 = 
jou∫Æ
->
èû
;

208 
hódî
->
íåyCou¡
 = 0;

209 
hódî
->
hasBlockM≠In¸emíts
 = 
Ál£
;

210 
	}
}

217 
	$öôülizeJou∫ÆSèã
(
SœbJou∫Æ
 *
jou∫Æ
)

219 
jou∫Æ
->
uƒó∑bÀ
 = jou∫Æ->
hód
;

220 
jou∫Æ
->
ª≠Lock
 = 
	`gëLock
(jou∫Æ, jou∫Æ->
uƒó∑bÀ
);

221 
jou∫Æ
->
√xtCommô
 = jou∫Æ->
èû
;

222 
jou∫Æ
->
summ¨ized
 = jou∫Æ->
œ°Summ¨ized
 = jou∫Æ->
èû
;

223 
	`öôülizeTaûBlock
(
jou∫Æ
);

224 
	}
}

233 
__©åibuã__
((
w¨n_unu£d_ªsu…
))

234 
boﬁ
 
	$blockIsFuŒ
(
SœbJou∫Æ
 *
jou∫Æ
)

236 
Jou∫ÆE¡ryCou¡
 
cou¡
 = 
jou∫Æ
->
block
->
hódî
.
íåyCou¡
;

237  (
jou∫Æ
->
block
->
hódî
.
hasBlockM≠In¸emíts


238 ? (
jou∫Æ
->
fuŒE¡rõsPîBlock
 =
cou¡
)

239 : (
jou∫Æ
->
íåõsPîBlock
 =
cou¡
));

240 
	}
}

243 
addE¡rõs
(
SœbJou∫Æ
 *
jou∫Æ
);

244 
upd©eTaûBlockLoˇti⁄
(
SœbJou∫Æ
 *
jou∫Æ
);

245 
ªÀa£Jou∫ÆLocks
(
Waôî
 *
waôî
, *
c⁄ãxt
);

248 
	$makeSœbJou∫Æ
(
BlockAŒoˇt‹
 *
Æloˇt‹
,

249 
Sœb
 *
¶ab
,

250 
PhysiˇlLayî
 *
œyî
,

251 
RecovîyJou∫Æ
 *
ªcovîyJou∫Æ
,

252 
SœbJou∫Æ
 **
jou∫ÆPå
)

254 
SœbJou∫Æ
 *
jou∫Æ
;

255 c⁄° 
SœbC⁄fig
 *
¶abC⁄fig
 = 
	`gëSœbC⁄fig
(
Æloˇt‹
->
dïŸ
);

256 
ªsu…
 = 
	`ALLOCATE_EXTENDED
(
SœbJou∫Æ
, 
¶abC⁄fig
->
¶abJou∫ÆBlocks
,

257 
Jou∫ÆLock
, 
__func__
, &
jou∫Æ
);

258 i‡(
ªsu…
 !
VDO_SUCCESS
) {

259  
ªsu…
;

262 
jou∫Æ
->
¶ab
 = slab;

263 
jou∫Æ
->
size
 = 
¶abC⁄fig
->
¶abJou∫ÆBlocks
;

264 
jou∫Æ
->
ÊushögThªshﬁd
 = 
¶abC⁄fig
->
¶abJou∫ÆFlushögThªshﬁd
;

265 
jou∫Æ
->
blockögThªshﬁd
 = 
¶abC⁄fig
->
¶abJou∫ÆBlockögThªshﬁd
;

266 
jou∫Æ
->
s¸ubbögThªshﬁd
 = 
¶abC⁄fig
->
¶abJou∫ÆS¸ubbögThªshﬁd
;

267 
jou∫Æ
->
íåõsPîBlock
 = 
SLAB_JOURNAL_ENTRIES_PER_BLOCK
;

268 
jou∫Æ
->
fuŒE¡rõsPîBlock
 = 
SLAB_JOURNAL_FULL_ENTRIES_PER_BLOCK
;

269 
jou∫Æ
->
evíts
 = &
Æloˇt‹
->
¶abJou∫ÆSèti°ics
;

270 
jou∫Æ
->
ªcovîyJou∫Æ
 =ÑecoveryJournal;

271 
jou∫Æ
->
summ¨y
 = 
	`gëSœbSumm¨yZ⁄e
(
Æloˇt‹
);

272 
jou∫Æ
->
èû
 = 1;

273 
jou∫Æ
->
hód
 = 1;

275 
jou∫Æ
->
ÊushögDódlöe
 = jou∫Æ->
ÊushögThªshﬁd
;

278 i‡((
jou∫Æ
->
blockögThªshﬁd
 - jou∫Æ->
ÊushögThªshﬁd
) > 5) {

279 
jou∫Æ
->
ÊushögDódlöe
 = jou∫Æ->
blockögThªshﬁd
 - 5;

282 
jou∫Æ
->
¶abSumm¨yWaôî
.
ˇŒback
 = 
ªÀa£Jou∫ÆLocks
;

284 
ªsu…
 = 
	`ALLOCATE
(
VDO_BLOCK_SIZE
, , "PackedSlabJournalBlock",

285 (**Ë&
jou∫Æ
->
block
);

286 i‡(
ªsu…
 !
VDO_SUCCESS
) {

287 
	`‰ìSœbJou∫Æ
(&
jou∫Æ
);

288  
ªsu…
;

291 
ªsu…
 = 
	`öôülizeEnqueuóbÀCom∂ëi⁄
(&
jou∫Æ
->
com∂ëi⁄
,

292 
SLAB_JOURNAL_COMPLETION
, 
œyî
);

293 i‡(
ªsu…
 !
VDO_SUCCESS
) {

294 
	`‰ìSœbJou∫Æ
(&
jou∫Æ
);

295  
ªsu…
;

298 
	`öôülizeRög
(&
jou∫Æ
->
dútyNode
);

299 
	`öôülizeRög
(&
jou∫Æ
->
uncommôãdBlocks
);

301 
jou∫Æ
->
block
->
hódî
.
n⁄˚
 = 
¶ab
->
Æloˇt‹
->nonce;

302 
jou∫Æ
->
block
->
hódî
.
mëad©aTy≥
 = 
VDO_METADATA_SLAB_JOURNAL
;

303 
	`öôülizeJou∫ÆSèã
(
jou∫Æ
);

305 *
jou∫ÆPå
 = 
jou∫Æ
;

306  
VDO_SUCCESS
;

307 
	}
}

310 
	$‰ìSœbJou∫Æ
(
SœbJou∫Æ
 **
jou∫ÆPå
)

312 
SœbJou∫Æ
 *
jou∫Æ
 = *
jou∫ÆPå
;

313 i‡(
jou∫Æ
 =
NULL
) {

317 
	`de°royEnqueuóbÀ
(&
jou∫Æ
->
com∂ëi⁄
);

318 
	`FREE
(
jou∫Æ
->
block
);

319 
	`FREE
(
jou∫Æ
);

320 *
jou∫ÆPå
 = 
NULL
;

321 
	}
}

324 
boﬁ
 
	$isSœbJou∫ÆBœnk
(c⁄° 
SœbJou∫Æ
 *
jou∫Æ
)

326  ((
jou∫Æ
 !
NULL
)

327 && (
jou∫Æ
->
èû
 == 1)

328 && (
jou∫Æ
->
block
->
hódî
.
íåyCou¡
 == 0));

329 
	}
}

332 
boﬁ
 
	$isSœbJou∫ÆDúty
(c⁄° 
SœbJou∫Æ
 *
jou∫Æ
)

334  (
jou∫Æ
->
ªcovîyLock
 != 0);

335 
	}
}

343 
	$m¨kSœbJou∫ÆDúty
(
SœbJou∫Æ
 *
jou∫Æ
, 
Sequí˚Numbî
 
lock
)

345 
	`ASSERT_LOG_ONLY
(!
	`isSœbJou∫ÆDúty
(
jou∫Æ
), "slab journal was clean");

347 
jou∫Æ
->
ªcovîyLock
 = 
lock
;

348 
RögNode
 *
dútyRög
 = &
jou∫Æ
->
¶ab
->
Æloˇt‹
->
dútySœbJou∫Æs
;

349 
RögNode
 *
node
 = 
dútyRög
->
¥ev
;

350 
node
 !
dútyRög
) {

351 
SœbJou∫Æ
 *
dútyJou∫Æ
 = 
	`¶abJou∫ÆFromDútyNode
(
node
);

352 i‡(
dútyJou∫Æ
->
ªcovîyLock
 <
jou∫Æ
->recoveryLock) {

356 
node
 =Çode->
¥ev
;

359 
	`pushRögNode
(
node
->
√xt
, &
jou∫Æ
->
dútyNode
);

360 
	}
}

363 
	$m¨kSœbJou∫ÆCÀ™
(
SœbJou∫Æ
 *
jou∫Æ
)

365 
jou∫Æ
->
ªcovîyLock
 = 0;

366 
	`un•li˚RögNode
(&
jou∫Æ
->
dútyNode
);

367 
	}
}

373 
ab‹tWaôî
(
Waôî
 *
waôî
,

374 *
c⁄ãxt
 
__©åibuã__
((
unu£d
)))

376 
c⁄töueD©aVIO
(
waôîAsD©aVIO
(
waôî
), 
VDO_READ_ONLY
);

380 
	$ab‹tSœbJou∫ÆWaôîs
(
SœbJou∫Æ
 *
jou∫Æ
)

382 
	`ASSERT_LOG_ONLY
((
	`gëCÆlbackThªadID
()

383 =
jou∫Æ
->
¶ab
->
Æloˇt‹
->
thªadID
),

385 
	`nŸifyAŒWaôîs
(&
jou∫Æ
->
íåyWaôîs
, 
ab‹tWaôî
, journal);

386 
	`checkF‹FlushCom∂ëe
(
jou∫Æ
);

387 
	}
}

398 
	$íãrJou∫ÆRódO∆yMode
(
SœbJou∫Æ
 *
jou∫Æ
, 
îr‹Code
)

400 
	`íãrRódO∆yMode
(
jou∫Æ
->
¶ab
->
Æloˇt‹
->
ªadO∆yC⁄ãxt
, 
îr‹Code
);

401 
	`ab‹tSœbJou∫ÆWaôîs
(
jou∫Æ
);

402 
	}
}

410 
	$föishRópög
(
SœbJou∫Æ
 *
jou∫Æ
)

412 
jou∫Æ
->
hód
 = jou∫Æ->
uƒó∑bÀ
;

413 
	`addE¡rõs
(
jou∫Æ
);

414 
	`checkF‹FlushCom∂ëe
(
jou∫Æ
);

415 
	}
}

418 
ª≠SœbJou∫Æ
(
SœbJou∫Æ
 *
jou∫Æ
);

426 
	$com∂ëeRópög
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

428 
VIOPoﬁE¡ry
 *
íåy
 = 
com∂ëi⁄
->
∑ª¡
;

429 
SœbJou∫Æ
 *
jou∫Æ
 = 
íåy
->
∑ª¡
;

430 
	`ªtu∫VIO
(
jou∫Æ
->
¶ab
->
Æloˇt‹
, 
íåy
);

431 
	`föishRópög
(
jou∫Æ
);

432 
	`ª≠SœbJou∫Æ
(
jou∫Æ
);

433 
	}
}

440 
	$h™dÀFlushEº‹
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

442 
SœbJou∫Æ
 *
jou∫Æ
 = ((
VIOPoﬁE¡ry
 *Ë
com∂ëi⁄
->
∑ª¡
)->parent;

443 
	`íãrJou∫ÆRódO∆yMode
(
jou∫Æ
, 
com∂ëi⁄
->
ªsu…
);

444 
	`com∂ëeRópög
(
com∂ëi⁄
);

445 
	}
}

454 
	$ÊushF‹Rópög
(
Waôî
 *
waôî
, *
vioC⁄ãxt
)

456 
SœbJou∫Æ
 *
jou∫Æ
 = 
	`¶abJou∫ÆFromFlushWaôî
(
waôî
);

457 
VIOPoﬁE¡ry
 *
íåy
 = 
vioC⁄ãxt
;

458 
VIO
 *
vio
 = 
íåy
->vio;

460 
íåy
->
∑ª¡
 = 
jou∫Æ
;

461 
vio
->
com∂ëi⁄
.
ˇŒbackThªadID
 = 
jou∫Æ
->
¶ab
->
Æloˇt‹
->
thªadID
;

462 
	`œunchFlush
(
vio
, 
com∂ëeRópög
, 
h™dÀFlushEº‹
);

463 
	}
}

470 
	$ª≠SœbJou∫Æ
(
SœbJou∫Æ
 *
jou∫Æ
)

472 i‡(
	`isUƒecovîedSœb
(
jou∫Æ
->
¶ab
Ë|| jou∫Æ->
˛o£Reque°ed


473 || 
	`isVDORódO∆y
(
jou∫Æ
)) {

479 i‡(
	`isRópög
(
jou∫Æ
)) {

490 
boﬁ
 
ª≠ed
 = 
Ál£
;

491 (
jou∫Æ
->
uƒó∑bÀ
 < jou∫Æ->
èû
)

492 && (
jou∫Æ
->
ª≠Lock
->
cou¡
 == 0)) {

493 
ª≠ed
 = 
åue
;

494 
jou∫Æ
->
uƒó∑bÀ
++;

495 
jou∫Æ
->
ª≠Lock
++;

496 i‡(
jou∫Æ
->
ª≠Lock
 =&jou∫Æ->
locks
[jou∫Æ->
size
]) {

497 
jou∫Æ
->
ª≠Lock
 = &jou∫Æ->
locks
[0];

501 i‡(!
ª≠ed
) {

505 
PhysiˇlLayî
 *
œyî
 = 
jou∫Æ
->
com∂ëi⁄
.layer;

506 i‡(!
œyî
->
	`isFlushRequúed
(layer)) {

507 
	`föishRópög
(
jou∫Æ
);

523 
jou∫Æ
->
ÊushWaôî
.
ˇŒback
 = 
ÊushF‹Rópög
;

524 
ªsu…
 = 
	`acquúeVIO
(
jou∫Æ
->
¶ab
->
Æloˇt‹
, &jou∫Æ->
ÊushWaôî
);

525 i‡(
ªsu…
 !
VDO_SUCCESS
) {

526 
	`íãrJou∫ÆRódO∆yMode
(
jou∫Æ
, 
ªsu…
);

529 
	}
}

540 
	$ªÀa£Jou∫ÆLocks
(
Waôî
 *
waôî
, *
c⁄ãxt
)

542 
SœbJou∫Æ
 *
jou∫Æ
 = 
	`¶abJou∫ÆFromSœbSumm¨yWaôî
(
waôî
);

543 
ªsu…
 = *((*Ë
c⁄ãxt
);

544 i‡(
ªsu…
 !
VDO_SUCCESS
) {

545 
jou∫Æ
->
upd©ögSœbSumm¨y
 = 
Ál£
;

546 
	`logEº‹WôhSåögEº‹
(
ªsu…
, "Áûed sœb summ¨y upd©î %" 
PRIu64
,

547 
jou∫Æ
->
summ¨ized
);

548 
	`íãrJou∫ÆRódO∆yMode
(
jou∫Æ
, 
ªsu…
);

552 i‡(
jou∫Æ
->
∑πülWrôeInProgªss


553 && (
jou∫Æ
->
summ¨ized
 =jou∫Æ->
èû
)) {

554 
jou∫Æ
->
∑πülWrôeInProgªss
 = 
Ál£
;

555 
	`addE¡rõs
(
jou∫Æ
);

558 
Sequí˚Numbî
 
fú°
 = 
jou∫Æ
->
œ°Summ¨ized
;

559 
jou∫Æ
->
œ°Summ¨ized
 = jou∫Æ->
summ¨ized
;

560 
Sequí˚Numbî
 
i
 = 
jou∫Æ
->
summ¨ized
 - 1; i >
fú°
; i--) {

563 i‡(
jou∫Æ
->
ªcovîyJou∫Æ
 !
NULL
) {

564 
Z⁄eCou¡
 
z⁄eNumbî
 = 
jou∫Æ
->
¶ab
->
Æloˇt‹
->zoneNumber;

565 
	`ªÀa£RecovîyJou∫ÆBlockRe„ªn˚
(
jou∫Æ
->
ªcovîyJou∫Æ
,

566 
	`gëLock
(
jou∫Æ
, 
i
)->
ªcovîySèπ
,

567 
ZONE_TYPE_PHYSICAL
,

568 
z⁄eNumbî
);

574 
	`adju°SœbJou∫ÆBlockRe„ªn˚
(
jou∫Æ
, 
i
, -1);

577 
jou∫Æ
->
upd©ögSœbSumm¨y
 = 
Ál£
;

579 
	`ª≠SœbJou∫Æ
(
jou∫Æ
);

582 
	`upd©eTaûBlockLoˇti⁄
(
jou∫Æ
);

583 
	}
}

590 
	$upd©eTaûBlockLoˇti⁄
(
SœbJou∫Æ
 *
jou∫Æ
)

592 i‡(
jou∫Æ
->
upd©ögSœbSumm¨y
 || 
	`isVDORódO∆y
(journal)

593 || (
jou∫Æ
->
œ°Summ¨ized
 >jou∫Æ->
√xtCommô
)) {

594 
	`checkF‹FlushCom∂ëe
(
jou∫Æ
);

598 
BlockCou¡
 
‰ìBlockCou¡
;

599 i‡(
	`isUƒecovîedSœb
(
jou∫Æ
->
¶ab
)) {

600 
‰ìBlockCou¡
 = 
	`gëSumm¨izedFªeBlockCou¡
(
jou∫Æ
->
summ¨y
,

601 
jou∫Æ
->
¶ab
->
¶abNumbî
);

603 
‰ìBlockCou¡
 = 
	`gëSœbFªeBlockCou¡
(
jou∫Æ
->
¶ab
);

606 
jou∫Æ
->
summ¨ized
 = jou∫Æ->
√xtCommô
;

607 
jou∫Æ
->
upd©ögSœbSumm¨y
 = 
åue
;

616 
TaûBlockOff£t
 
blockOff£t


617 
	`gëSœbJou∫ÆBlockOff£t
(
jou∫Æ
, jou∫Æ->
summ¨ized
);

618 
	`upd©eSœbSumm¨yE¡ry
(
jou∫Æ
->
summ¨y
, &jou∫Æ->
¶abSumm¨yWaôî
,

619 
jou∫Æ
->
¶ab
->
¶abNumbî
, 
blockOff£t
,

620 (
jou∫Æ
->
hód
 > 1), 
Ál£
, 
‰ìBlockCou¡
);

621 
	}
}

624 
	$ª›íSœbJou∫Æ
(
SœbJou∫Æ
 *
jou∫Æ
)

626 
	`ASSERT_LOG_ONLY
(
jou∫Æ
->
block
->
hódî
.
íåyCou¡
 == 0,

628 
jou∫Æ
->
hód
 = jou∫Æ->
èû
;

629 
	`öôülizeJou∫ÆSèã
(
jou∫Æ
);

632 
Sequí˚Numbî
 
block
 = 1; block <
jou∫Æ
->
size
; block++) {

633 
	`ASSERT_LOG_ONLY
((
	`gëLock
(
jou∫Æ
, 
block
)->
cou¡
 == 0),

634 "S¸ubbed jou∫Æ'†block %" 
PRIu64
 " isÇotÜocked",

635 
block
);

638 
	`addE¡rõs
(
jou∫Æ
);

639 
	}
}

647 
	$com∂ëeWrôe
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

649 
wrôeResu…
 = 
com∂ëi⁄
->
ªsu…
;

650 
VIOPoﬁE¡ry
 *
íåy
 = 
com∂ëi⁄
->
∑ª¡
;

651 
BlockDes¸ùt‹
 *
des¸ùt‹
 = 
íåy
->
∑ª¡
;

652 
SœbJou∫Æ
 *
jou∫Æ
 = 
des¸ùt‹
->journal;

653 
	`ªtu∫VIO
(
jou∫Æ
->
¶ab
->
Æloˇt‹
, 
íåy
);

654 
	`ªœxedAdd64
(&
jou∫Æ
->
evíts
->
blocksWrôãn
, 1);

657 
	`un•li˚RögNode
(&
des¸ùt‹
->
rögNode
);

658 
Sequí˚Numbî
 
commôãd
 = 
des¸ùt‹
->
£quí˚Numbî
;

659 
	`ªtu∫BlockDes¸ùt‹
(
jou∫Æ
->
¶ab
->
Æloˇt‹
, 
des¸ùt‹
);

661 i‡(
wrôeResu…
 !
VDO_SUCCESS
) {

662 
	`logEº‹WôhSåögEº‹
(
wrôeResu…
,

663 "ˇ¬Ÿ wrôê¶ab jou∫Æ block %" 
PRIu64
,

664 
commôãd
);

665 
	`íãrJou∫ÆRódO∆yMode
(
jou∫Æ
, 
wrôeResu…
);

669 i‡(
	`isRögEm±y
(&
jou∫Æ
->
uncommôãdBlocks
)) {

671 
jou∫Æ
->
√xtCommô
 = jou∫Æ->
èû
;

674 
jou∫Æ
->
√xtCommô


675 
	`asBlockDes¸ùt‹
(
jou∫Æ
->
uncommôãdBlocks
.
√xt
)->
£quí˚Numbî
;

678 
	`upd©eTaûBlockLoˇti⁄
(
jou∫Æ
);

679 
	}
}

687 
	$wrôeSœbJou∫ÆVIO
(
Waôî
 *
waôî
, *
vioC⁄ãxt
)

689 
SœbJou∫Æ
 *
jou∫Æ
 = 
	`¶abJou∫ÆFromResour˚Waôî
(
waôî
);

690 
BlockDes¸ùt‹
 *
des¸ùt‹
 = 
jou∫Æ
->descriptor;

691 
VIOPoﬁE¡ry
 *
íåy
 = 
vioC⁄ãxt
;

692 
PackedSœbJou∫ÆBlock
 *
block
 = 
jou∫Æ
->block;

693 
SœbJou∫ÆBlockHódî
 *
hódî
 = &
block
->header;

694 
hódî
->
hód
 = 
jou∫Æ
->head;

695 
	`∑ckJou∫ÆPoöt
(&
jou∫Æ
->
ªcovîyPoöt
, &
hódî
->recoveryPoint);

697 
des¸ùt‹
->
£quí˚Numbî
 = 
hódî
->sequenceNumber;

698 
	`pushRögNode
(&
jou∫Æ
->
uncommôãdBlocks
, &
des¸ùt‹
->
rögNode
);

701 
	`mem˝y
(
íåy
->
buf„r
, (*Ë
block
, 
VDO_BLOCK_SIZE
);

703 
unu£dE¡rõs
 = 
jou∫Æ
->
íåõsPîBlock
 - 
hódî
->
íåyCou¡
;

704 
	`ASSERT_LOG_ONLY
(
unu£dE¡rõs
 >= 0, "Slab journal block isÇot overfull");

705 i‡(
unu£dE¡rõs
 > 0) {

708 
	`adju°SœbJou∫ÆBlockRe„ªn˚
(
jou∫Æ
, 
hódî
->
£quí˚Numbî
,

709 -
unu£dE¡rõs
);

710 
jou∫Æ
->
∑πülWrôeInProgªss
 = !
	`blockIsFuŒ
(journal);

713 
PhysiˇlBlockNumbî
 
blockNumbî


714 
	`gëBlockNumbî
(
jou∫Æ
, 
hódî
->
£quí˚Numbî
);

716 
íåy
->
∑ª¡
 = 
des¸ùt‹
;

717 
íåy
->
vio
->
com∂ëi⁄
.
ˇŒbackThªadID
 = 
jou∫Æ
->
¶ab
->
Æloˇt‹
->
thªadID
;

723 
	`œunchWrôeMëad©aVIO
(
íåy
->
vio
, 
blockNumbî
, 
com∂ëeWrôe
,

724 
com∂ëeWrôe
);

727 
jou∫Æ
->
èû
++;

728 
	`öôülizeTaûBlock
(
jou∫Æ
);

729 
jou∫Æ
->
waôögToCommô
 = 
Ál£
;

730 
jou∫Æ
->
des¸ùt‹
 = 
NULL
;

731 i‡(
jou∫Æ
->
waôögF‹S∑˚
) {

732 
jou∫Æ
->
waôögF‹S∑˚
 = 
Ál£
;

733 
	`com∂ëeCom∂ëi⁄
(&
jou∫Æ
->
com∂ëi⁄
);

736 
	`addE¡rõs
(
jou∫Æ
);

737 
	}
}

740 
	$wrôeSœbJou∫ÆBlock
(
Waôî
 *
waôî
, *
des¸ùt‹C⁄ãxt
)

742 
SœbJou∫Æ
 *
jou∫Æ
 = 
	`¶abJou∫ÆFromResour˚Waôî
(
waôî
);

743 
BlockDes¸ùt‹
 *
des¸ùt‹
 = 
des¸ùt‹C⁄ãxt
;

744 
jou∫Æ
->
des¸ùt‹
 = descriptor;

745 
des¸ùt‹
->
jou∫Æ
 = journal;

747 
jou∫Æ
->
ªsour˚Waôî
.
ˇŒback
 = 
wrôeSœbJou∫ÆVIO
;

748 
ªsu…
 = 
	`acquúeVIO
(
jou∫Æ
->
¶ab
->
Æloˇt‹
, &jou∫Æ->
ªsour˚Waôî
);

749 i‡(
ªsu…
 !
VDO_SUCCESS
) {

750 
	`ªtu∫BlockDes¸ùt‹
(
jou∫Æ
->
¶ab
->
Æloˇt‹
, 
des¸ùt‹
);

751 
jou∫Æ
->
des¸ùt‹
 = 
NULL
;

752 
jou∫Æ
->
waôögToCommô
 = 
Ál£
;

753 
	`íãrJou∫ÆRódO∆yMode
(
jou∫Æ
, 
ªsu…
);

756 
	}
}

759 
	$öôüãFlush
(
SœbJou∫Æ
 *
jou∫Æ
)

761 i‡(
jou∫Æ
->
ÊushSèã
 =
FLUSH_REQUESTED
) {

762 
jou∫Æ
->
ÊushSèã
 = 
FLUSH_INITIATED
;

764 
	}
}

767 
	$commôSœbJou∫ÆTaû
(
SœbJou∫Æ
 *
jou∫Æ
)

769 i‡((
jou∫Æ
->
block
->
hódî
.
íåyCou¡
 == 0)

770 && 
	`mu°MakeE¡rõsToFlush
(
jou∫Æ
)) {

776 
	`öôüãFlush
(
jou∫Æ
);

778 i‡(
	`isVDORódO∆y
(
jou∫Æ
)

779 || 
jou∫Æ
->
waôögToCommô


780 || (
jou∫Æ
->
block
->
hódî
.
íåyCou¡
 == 0)) {

791 
	`m¨kSœbJou∫ÆCÀ™
(
jou∫Æ
);

793 
jou∫Æ
->
waôögToCommô
 = 
åue
;

795 
jou∫Æ
->
ªsour˚Waôî
.
ˇŒback
 = 
wrôeSœbJou∫ÆBlock
;

796 
ªsu…
 = 
	`acquúeBlockDes¸ùt‹
(
jou∫Æ
->
¶ab
->
Æloˇt‹
,

797 &
jou∫Æ
->
ªsour˚Waôî
);

798 i‡(
ªsu…
 !
VDO_SUCCESS
) {

799 
jou∫Æ
->
waôögToCommô
 = 
Ál£
;

800 
	`íãrJou∫ÆRódO∆yMode
(
jou∫Æ
, 
ªsu…
);

803 
	}
}

806 
	$ícodeSœbJou∫ÆE¡ry
(
PackedSœbJou∫ÆBlock
 *
block
,

807 
SœbBlockNumbî
 
sbn
,

808 
Jou∫ÆO≥øti⁄
 
›î©i⁄
)

810 
SœbJou∫ÆBlockHódî
 *
hódî
 = &
block
->header;

811 
Jou∫ÆE¡ryCou¡
 
cou¡
 = 
hódî
->
íåyCou¡
;

812 
PackedSœbJou∫ÆE¡ry
 *
íåy
 = &
block
->
∑ylﬂd
.
íåõs
[
cou¡
];

813 
íåy
->
off£t
 = 
sbn
;

814 i‡(
›î©i⁄
 =
BLOCK_MAP_INCREMENT
) {

815 i‡(!
hódî
->
hasBlockM≠In¸emíts
) {

816 
	`mem£t
(
block
->
∑ylﬂd
.
fuŒE¡rõs
.
íåyTy≥s
, 0,

817 
SLAB_JOURNAL_ENTRY_TYPES_SIZE
);

818 
hódî
->
hasBlockM≠In¸emíts
 = 
åue
;

821 
íåy
->
ö¸emít
 = 
åue
;

822 
block
->
∑ylﬂd
.
fuŒE¡rõs
.
íåyTy≥s
[
cou¡
 / 8]

823 |((
byã
Ë1 << (
cou¡
 % 8));

825 
íåy
->
ö¸emít
 = (
›î©i⁄
 =
DATA_INCREMENT
);

828 
hódî
->
íåyCou¡
++;

829 
	}
}

832 
SœbJou∫ÆE¡ry
 
	$decodeSœbJou∫ÆE¡ry
(
PackedSœbJou∫ÆBlock
 *
block
,

833 
Jou∫ÆE¡ryCou¡
 
íåyCou¡
)

835 
PackedSœbJou∫ÆE¡ry
 
∑cked
 = 
block
->
∑ylﬂd
.
íåõs
[
íåyCou¡
];

836 
SœbJou∫ÆE¡ry
 
íåy
;

837 i‡(
block
->
hódî
.
hasBlockM≠In¸emíts


838 && ((
block
->
∑ylﬂd
.
fuŒE¡rõs
.
íåyTy≥s
[
íåyCou¡
 / 8]

839 & ((
byã
Ë1 << (
íåyCou¡
 % 8))) != 0)) {

840 
íåy
.
›î©i⁄
 = 
BLOCK_MAP_INCREMENT
;

842 
íåy
.
›î©i⁄
 = (
∑cked
.
ö¸emít
 ? 
DATA_INCREMENT
 : 
DATA_DECREMENT
);

845 
íåy
.
sbn
 = 
∑cked
.
off£t
;

846  
íåy
;

847 
	}
}

858 
	$addE¡ry
(
SœbJou∫Æ
 *
jou∫Æ
,

859 
PhysiˇlBlockNumbî
 
pbn
,

860 
Jou∫ÆO≥øti⁄
 
›î©i⁄
,

861 
Jou∫ÆPoöt
 *
ªcovîyPoöt
)

863 
ªsu…
 = 
	`ASSERT
(
	`bef‹eJou∫ÆPoöt
(&
jou∫Æ
->
ªcovîyPoöt
,

864 
ªcovîyPoöt
),

866 "ªcovîyÖoöt: %" 
PRIu64
 ".%u, "

867 "blockÑecovîyÖoöt: %" 
PRIu64
 ".%u",

868 
ªcovîyPoöt
->
£quí˚Numbî
,ÑecovîyPoöt->
íåyCou¡
,

869 
jou∫Æ
->
ªcovîyPoöt
.
£quí˚Numbî
,

870 
jou∫Æ
->
ªcovîyPoöt
.
íåyCou¡
);

871 i‡(
ªsu…
 !
VDO_SUCCESS
) {

872 
	`íãrJou∫ÆRódO∆yMode
(
jou∫Æ
, 
ªsu…
);

876 
PackedSœbJou∫ÆBlock
 *
block
 = 
jou∫Æ
->block;

877 i‡(
›î©i⁄
 =
BLOCK_MAP_INCREMENT
) {

878 
ªsu…
 = 
	`ASSERT_LOG_ONLY
((
block
->
hódî
.
íåyCou¡


879 < 
jou∫Æ
->
fuŒE¡rõsPîBlock
),

881 i‡(
ªsu…
 !
VDO_SUCCESS
) {

882 
	`íãrJou∫ÆRódO∆yMode
(
jou∫Æ
, 
ªsu…
);

887 
	`ícodeSœbJou∫ÆE¡ry
(
block
, 
pbn
 - 
jou∫Æ
->
¶ab
->
°¨t
, 
›î©i⁄
);

888 
	`∑ckJou∫ÆPoöt
(
ªcovîyPoöt
, &
block
->
hódî
.recoveryPoint);

889 
jou∫Æ
->
ªcovîyPoöt
 = *recoveryPoint;

890 i‡(
	`blockIsFuŒ
(
jou∫Æ
)) {

891 
	`commôSœbJou∫ÆTaû
(
jou∫Æ
);

893 
	}
}

896 
boﬁ
 
	$mayAddSœbJou∫ÆE¡ry
(
SœbJou∫Æ
 *
jou∫Æ
,

897 
Jou∫ÆO≥øti⁄
 
›î©i⁄
,

898 
VDOCom∂ëi⁄
 *
∑ª¡
)

900 i‡(!
jou∫Æ
->
waôögToCommô
) {

901 
SœbJou∫ÆBlockHódî
 *
hódî
 = &
jou∫Æ
->
block
->header;

902 i‡(
hódî
->
íåyCou¡
 < 
jou∫Æ
->
fuŒE¡rõsPîBlock
) {

903  
åue
;

906 i‡(!
hódî
->
hasBlockM≠In¸emíts
 && (
›î©i⁄
 !
BLOCK_MAP_INCREMENT
)) {

907  
åue
;

912 
	`commôSœbJou∫ÆTaû
(
jou∫Æ
);

913 i‡(!
jou∫Æ
->
waôögToCommô
) {

914  
åue
;

918 
jou∫Æ
->
waôögF‹S∑˚
 = 
åue
;

919 
	`¥ï¨eCom∂ëi⁄
(&
jou∫Æ
->
com∂ëi⁄
, 
föishP¨ítCÆlback
,

920 
föishP¨ítCÆlback
, 
∑ª¡
->
ˇŒbackThªadID
,Öarent);

921  
Ál£
;

922 
	}
}

925 
	$addSœbJou∫ÆE¡ryF‹Rebuûd
(
SœbJou∫Æ
 *
jou∫Æ
,

926 
PhysiˇlBlockNumbî
 
pbn
,

927 
Jou∫ÆO≥øti⁄
 
›î©i⁄
,

928 
Jou∫ÆPoöt
 *
ªcovîyPoöt
)

931 i‡(!
	`bef‹eJou∫ÆPoöt
(&
jou∫Æ
->
ªcovîyPoöt
,ÑecoveryPoint)) {

935 i‡((
jou∫Æ
->
èû
 - jou∫Æ->
hód
Ë>jou∫Æ->
size
) {

942 
jou∫Æ
->
hód
++;

943 
jou∫Æ
->
uƒó∑bÀ
++;

946 
	`m¨kSœbRïœyög
(
jou∫Æ
->
¶ab
);

947 
	`addE¡ry
(
jou∫Æ
, 
pbn
, 
›î©i⁄
, 
ªcovîyPoöt
);

948 
	}
}

957 
boﬁ
 
	$ªquúesFlushög
(c⁄° 
SœbJou∫Æ
 *
jou∫Æ
)

959 
BlockCou¡
 
jou∫ÆLígth
 = (
jou∫Æ
->
èû
 - jou∫Æ->
hód
);

960  (
jou∫ÆLígth
 >
jou∫Æ
->
ÊushögThªshﬁd
);

961 
	}
}

970 
boﬁ
 
	$ªquúesRópög
(c⁄° 
SœbJou∫Æ
 *
jou∫Æ
)

972 
BlockCou¡
 
jou∫ÆLígth
 = (
jou∫Æ
->
èû
 - jou∫Æ->
hód
);

973  (
jou∫ÆLígth
 >
jou∫Æ
->
blockögThªshﬁd
);

974 
	}
}

977 
boﬁ
 
	$ªquúesS¸ubbög
(c⁄° 
SœbJou∫Æ
 *
jou∫Æ
)

979 
BlockCou¡
 
jou∫ÆLígth
 = (
jou∫Æ
->
èû
 - jou∫Æ->
hód
);

980  (
jou∫ÆLígth
 >
jou∫Æ
->
s¸ubbögThªshﬁd
);

981 
	}
}

991 
	$addE¡ryFromWaôî
(
Waôî
 *
waôî
, *
c⁄ãxt
)

993 
D©aVIO
 *
d©aVIO
 = 
	`waôîAsD©aVIO
(
waôî
);

994 
SœbJou∫Æ
 *
jou∫Æ
 = (SœbJou∫Æ *Ë
c⁄ãxt
;

995 
PackedSœbJou∫ÆBlock
 *
block
 = 
jou∫Æ
->block;

996 
SœbJou∫ÆBlockHódî
 *
hódî
 = &
block
->header;

997 
Sequí˚Numbî
 
ªcovîyBlock
 = 
d©aVIO
->
ªcovîyJou∫ÆPoöt
.
£quí˚Numbî
;

999 i‡(
hódî
->
íåyCou¡
 == 0) {

1005 
	`gëLock
(
jou∫Æ
, 
hódî
->
£quí˚Numbî
)->
ªcovîySèπ
 = 
ªcovîyBlock
;

1006 i‡(
jou∫Æ
->
ªcovîyJou∫Æ
 !
NULL
) {

1007 
Z⁄eCou¡
 
z⁄eNumbî
 = 
jou∫Æ
->
¶ab
->
Æloˇt‹
->zoneNumber;

1008 
	`acquúeRecovîyJou∫ÆBlockRe„ªn˚
(
jou∫Æ
->
ªcovîyJou∫Æ
,

1009 
ªcovîyBlock
, 
ZONE_TYPE_PHYSICAL
,

1010 
z⁄eNumbî
);

1012 
	`m¨kSœbJou∫ÆDúty
(
jou∫Æ
, 
ªcovîyBlock
);

1016 i‡(
	`ªquúesFlushög
(
jou∫Æ
)) {

1017 
	`ªœxedAdd64
(&
jou∫Æ
->
evíts
->
ÊushCou¡
, 1);

1018 
BlockCou¡
 
jou∫ÆLígth
 = (
jou∫Æ
->
èû
 - jou∫Æ->
hód
);

1019 
BlockCou¡
 
blocksToDódlöe
 = 0;

1020 i‡(
jou∫ÆLígth
 <
jou∫Æ
->
ÊushögDódlöe
) {

1021 
blocksToDódlöe
 = 
jou∫Æ
->
ÊushögDódlöe
 - 
jou∫ÆLígth
;

1023 
	`ßveSevîÆRe„ªn˚Blocks
(
jou∫Æ
->
¶ab
->
ª„ªn˚Cou¡s
,

1024 
blocksToDódlöe
 + 1);

1028 
Jou∫ÆPoöt
 
¶abJou∫ÆPoöt
 = (JournalPoint) {

1029 .
£quí˚Numbî
 = 
hódî
->sequenceNumber,

1030 .
íåyCou¡
 = 
hódî
->entryCount,

1033 
	`addE¡ry
(
jou∫Æ
, 
d©aVIO
->
›î©i⁄
.
pbn
, d©aVIO->›î©i⁄.
ty≥
,

1034 &
d©aVIO
->
ªcovîyJou∫ÆPoöt
);

1038 
ªsu…
 = 
	`modifySœbRe„ªn˚Cou¡
(
jou∫Æ
->
¶ab
, &
¶abJou∫ÆPoöt
,

1039 
d©aVIO
->
›î©i⁄
);

1040 
	`c⁄töueD©aVIO
(
d©aVIO
, 
ªsu…
);

1041 
	}
}

1051 
ölöe
 
boﬁ
 
	$isNextE¡ryABlockM≠In¸emít
(
SœbJou∫Æ
 *
jou∫Æ
)

1053 
D©aVIO
 *
d©aVIO
 = 
	`waôîAsD©aVIO
(
	`gëFú°Waôî
(&
jou∫Æ
->
íåyWaôîs
));

1054  (
d©aVIO
->
›î©i⁄
.
ty≥
 =
BLOCK_MAP_INCREMENT
);

1055 
	}
}

1065 
	$addE¡rõs
(
SœbJou∫Æ
 *
jou∫Æ
)

1067 i‡(
jou∫Æ
->
addögE¡rõs
) {

1072 
jou∫Æ
->
addögE¡rõs
 = 
åue
;

1073 
	`hasWaôîs
(&
jou∫Æ
->
íåyWaôîs
)) {

1074 i‡(
jou∫Æ
->
∑πülWrôeInProgªss
 || 
	`¶abIsRebuûdög
(jou∫Æ->
¶ab
)) {

1080 
SœbJou∫ÆBlockHódî
 *
hódî
 = &
jou∫Æ
->
block
->header;

1081 i‡(
jou∫Æ
->
waôögToCommô
) {

1084 
	`ªœxedAdd64
(&
jou∫Æ
->
evíts
->
èûBusyCou¡
, 1);

1086 } i‡(
	`isNextE¡ryABlockM≠In¸emít
(
jou∫Æ
)

1087 && (
hódî
->
íåyCou¡
 >
jou∫Æ
->
fuŒE¡rõsPîBlock
)) {

1090 
	`commôSœbJou∫ÆTaû
(
jou∫Æ
);

1091 i‡(
jou∫Æ
->
waôögToCommô
) {

1092 
	`ªœxedAdd64
(&
jou∫Æ
->
evíts
->
èûBusyCou¡
, 1);

1098 i‡(
	`ªquúesRópög
(
jou∫Æ
)) {

1099 
	`ªœxedAdd64
(&
jou∫Æ
->
evíts
->
blockedCou¡
, 1);

1100 
	`ßveDútyRe„ªn˚Blocks
(
jou∫Æ
->
¶ab
->
ª„ªn˚Cou¡s
);

1104 i‡(
hódî
->
íåyCou¡
 == 0) {

1105 
Jou∫ÆLock
 *
lock
 = 
	`gëLock
(
jou∫Æ
, 
hódî
->
£quí˚Numbî
);

1108 i‡(
lock
->
cou¡
 > 0) {

1109 
	`ASSERT_LOG_ONLY
((
jou∫Æ
->
hód
 + jou∫Æ->
size
Ë=jou∫Æ->
èû
,

1117 
	`ASSERT_LOG_ONLY
((
jou∫Æ
->
blockögThªshﬁd
 >jou∫Æ->
size
),

1121 
	`ªœxedAdd64
(&
jou∫Æ
->
evíts
->
diskFuŒCou¡
, 1);

1122 
	`ßveDútyRe„ªn˚Blocks
(
jou∫Æ
->
¶ab
->
ª„ªn˚Cou¡s
);

1131 
lock
->
cou¡
 = 
jou∫Æ
->
íåõsPîBlock
 + 1;

1133 i‡(
hódî
->
£quí˚Numbî
 == 1) {

1142 
Sœb
 *
¶ab
 = 
jou∫Æ
->slab;

1143 
ªsu…
 = 
	`acquúeDútyBlockLocks
(
¶ab
->
ª„ªn˚Cou¡s
);

1144 i‡(
ªsu…
 !
VDO_SUCCESS
) {

1145 
	`íãrJou∫ÆRódO∆yMode
(
jou∫Æ
, 
ªsu…
);

1151 
	`nŸifyNextWaôî
(&
jou∫Æ
->
íåyWaôîs
, 
addE¡ryFromWaôî
, journal);

1154 
jou∫Æ
->
addögE¡rõs
 = 
Ál£
;

1156 i‡((
jou∫Æ
->
ÊushSèã
 =
FLUSH_REQUESTED
)

1157 && !
	`hasWaôîs
(&
jou∫Æ
->
íåyWaôîs
)) {

1158 
	`commôSœbJou∫ÆTaû
(
jou∫Æ
);

1160 
	}
}

1163 
	$addSœbJou∫ÆE¡ry
(
SœbJou∫Æ
 *
jou∫Æ
, 
D©aVIO
 *
d©aVIO
)

1165 i‡(
jou∫Æ
->
˛o£Reque°ed
) {

1166 
	`c⁄töueD©aVIO
(
d©aVIO
, 
VDO_SHUTTING_DOWN
);

1170 i‡(
	`isVDORódO∆y
(
jou∫Æ
)) {

1171 
	`c⁄töueD©aVIO
(
d©aVIO
, 
VDO_READ_ONLY
);

1175 
ªsu…
 = 
	`íqueueD©aVIO
(&
jou∫Æ
->
íåyWaôîs
, 
d©aVIO
,

1176 
	`THIS_LOCATION
("$F($j-$js)"));

1177 i‡(
ªsu…
 !
VDO_SUCCESS
) {

1178 
	`c⁄töueD©aVIO
(
d©aVIO
, 
ªsu…
);

1182 i‡(
	`isUƒecovîedSœb
(
jou∫Æ
->
¶ab
Ë&& 
	`ªquúesRópög
(journal)) {

1183 
	`ö¸ó£S¸ubbögPri‹ôy
(
jou∫Æ
->
¶ab
);

1186 
	`addE¡rõs
(
jou∫Æ
);

1187 
	}
}

1190 
	$adju°SœbJou∫ÆBlockRe„ªn˚
(
SœbJou∫Æ
 *
jou∫Æ
,

1191 
Sequí˚Numbî
 
£quí˚Numbî
,

1192 
adju°mít
)

1194 i‡(
£quí˚Numbî
 == 0) {

1198 i‡(
	`isRïœyögSœb
(
jou∫Æ
->
¶ab
)) {

1203 
	`ASSERT_LOG_ONLY
((
adju°mít
 != 0), "adjustment must beÇon-zero");

1204 
Jou∫ÆLock
 *
lock
 = 
	`gëLock
(
jou∫Æ
, 
£quí˚Numbî
);

1205 i‡(
adju°mít
 < 0) {

1206 
	`ASSERT_LOG_ONLY
((-
adju°mít
 <
lock
->
cou¡
),

1207 "de¸emíào‡lock cou¡ f‹ sœb jou∫Æ block %" 
PRIu64


1208 " mu°ÇŸ undîÊow", 
£quí˚Numbî
);

1211 
lock
->
cou¡
 +
adju°mít
;

1212 i‡(
lock
->
cou¡
 == 0) {

1213 
	`ª≠SœbJou∫Æ
(
jou∫Æ
);

1215 
	}
}

1218 
boﬁ
 
	$ªÀa£RecovîyJou∫ÆLock
(
SœbJou∫Æ
 *
jou∫Æ
,

1219 
Sequí˚Numbî
 
ªcovîyLock
)

1221 i‡(
ªcovîyLock
 > 
jou∫Æ
->recoveryLock) {

1222 
	`ASSERT_LOG_ONLY
((
ªcovîyLock
 < 
jou∫Æ
->recoveryLock),

1225  
Ál£
;

1228 i‡((
ªcovîyLock
 < 
jou∫Æ
->ªcovîyLockË|| 
	`isVDORódO∆y
(journal)) {

1229  
Ál£
;

1233 
	`commôSœbJou∫ÆTaû
(
jou∫Æ
);

1234  
åue
;

1235 
	}
}

1238 
	$˛o£SœbJou∫Æ
(
SœbJou∫Æ
 *
jou∫Æ
,

1239 
VDOCom∂ëi⁄
 *
∑ª¡
,

1240 
VDOA˘i⁄
 *
ˇŒback
,

1241 
VDOA˘i⁄
 *
îr‹H™dÀr
,

1242 
ThªadID
 
thªadID
)

1244 
	`ASSERT_LOG_ONLY
((!(
	`¶abIsRebuûdög
(
jou∫Æ
->
¶ab
)

1245 && 
	`hasWaôîs
(&
jou∫Æ
->
íåyWaôîs
))),

1247 
jou∫Æ
->
˛o£Reque°ed
 = 
åue
;

1248 
	`ÊushSœbJou∫Æ
(
jou∫Æ
, 
∑ª¡
, 
ˇŒback
, 
îr‹H™dÀr
, 
thªadID
);

1249 
	}
}

1252 
	$ÊushSœbJou∫Æ
(
SœbJou∫Æ
 *
jou∫Æ
,

1253 
VDOCom∂ëi⁄
 *
∑ª¡
,

1254 
VDOA˘i⁄
 *
ˇŒback
,

1255 
VDOA˘i⁄
 *
îr‹H™dÀr
,

1256 
ThªadID
 
thªadID
)

1258 
	`ASSERT_LOG_ONLY
((
	`gëCÆlbackThªadID
()

1259 =
jou∫Æ
->
¶ab
->
Æloˇt‹
->
thªadID
),

1261 
ªsu…
 = 
	`ASSERT
((
jou∫Æ
->
ÊushSèã
 =
NOT_FLUSHING
),

1263 i‡(
ªsu…
 !
VDO_SUCCESS
) {

1264 
	`föishCom∂ëi⁄
(
∑ª¡
, 
ªsu…
);

1268 
jou∫Æ
->
ÊushSèã
 = 
FLUSH_REQUESTED
;

1269 
	`¥ï¨eCom∂ëi⁄
(&
jou∫Æ
->
com∂ëi⁄
, 
ˇŒback
, 
îr‹H™dÀr
, 
thªadID
,

1270 
∑ª¡
);

1271 
	`commôSœbJou∫ÆTaû
(
jou∫Æ
);

1272 
	`checkF‹FlushCom∂ëe
(
jou∫Æ
);

1273 
	}
}

1281 
	$föishM™uÆIO
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

1283 
ªsu…
 = 
com∂ëi⁄
->result;

1284 
VIOPoﬁE¡ry
 *
íåy
 = 
com∂ëi⁄
->
∑ª¡
;

1285 
SœbJou∫Æ
 *
jou∫Æ
 = 
íåy
->
∑ª¡
;

1286 
	`ªtu∫VIO
(
jou∫Æ
->
¶ab
->
Æloˇt‹
, 
íåy
);

1287 
	`föishCom∂ëi⁄
(&
jou∫Æ
->
com∂ëi⁄
, 
ªsu…
);

1288 
	}
}

1296 
	$£tDecodedSèã
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

1298 
VIOPoﬁE¡ry
 *
íåy
 = 
com∂ëi⁄
->
∑ª¡
;

1299 
SœbJou∫Æ
 *
jou∫Æ
 = 
íåy
->
∑ª¡
;

1300 
SœbJou∫ÆBlockHódî
 *
hódî
 = 
íåy
->
buf„r
;

1301 i‡((
hódî
->
mëad©aTy≥
 !
VDO_METADATA_SLAB_JOURNAL
)

1302 || (
hódî
->
n⁄˚
 !
jou∫Æ
->
¶ab
->
Æloˇt‹
->nonce)) {

1303 
	`föishM™uÆIO
(
com∂ëi⁄
);

1307 
jou∫Æ
->
èû
 = 
hódî
->
£quí˚Numbî
 + 1;

1311 i‡(
	`gëSumm¨izedCÀ™löess
(
jou∫Æ
->
summ¨y
, jou∫Æ->
¶ab
->
¶abNumbî
)) {

1312 
jou∫Æ
->
hód
 = jou∫Æ->
èû
;

1314 
jou∫Æ
->
hód
 = 
hódî
->head;

1317 
	`öôülizeJou∫ÆSèã
(
jou∫Æ
);

1318 
	`u≈ackJou∫ÆPoöt
(&
hódî
->
ªcovîyPoöt
, &
jou∫Æ
->recoveryPoint);

1319 
	`föishM™uÆIO
(
com∂ëi⁄
);

1320 
	}
}

1330 
	$ªadSœbJou∫ÆTaû
(
Waôî
 *
waôî
, *
vioC⁄ãxt
)

1332 
SœbJou∫Æ
 *
jou∫Æ
 = 
	`¶abJou∫ÆFromResour˚Waôî
(
waôî
);

1333 
VIOPoﬁE¡ry
 *
íåy
 = 
vioC⁄ãxt
;

1334 
TaûBlockOff£t
 
œ°CommôPoöt


1335 
	`gëSumm¨izedTaûBlockOff£t
(
jou∫Æ
->
summ¨y
,

1336 
jou∫Æ
->
¶ab
->
¶abNumbî
);

1337 
íåy
->
∑ª¡
 = 
jou∫Æ
;

1339 i‡((
œ°CommôPoöt
 == 0)

1340 && !
	`mu°LﬂdRefCou¡s
(
jou∫Æ
->
summ¨y
, jou∫Æ->
¶ab
->
¶abNumbî
)) {

1346 
	`ASSERT_LOG_ONLY
(((
jou∫Æ
->
size
 < 16)

1347 || (
jou∫Æ
->
s¸ubbögThªshﬁd
 < (jou∫Æ->
size
 - 1))),

1350 
VDOCom∂ëi⁄
 *
com∂ëi⁄
 = 
	`vioAsCom∂ëi⁄
(
íåy
->
vio
);

1351 
	`ª£tCom∂ëi⁄
(
com∂ëi⁄
);

1352 
	`föishM™uÆIO
(
com∂ëi⁄
);

1358 
íåy
->
vio
->
com∂ëi⁄
.
ˇŒbackThªadID


1359 
jou∫Æ
->
com∂ëi⁄
.
ˇŒbackThªadID
;

1360 
TaûBlockOff£t
 
èûBlock
 = ((
œ°CommôPoöt
 == 0)

1361 ? (
TaûBlockOff£t
Ë(
jou∫Æ
->
size
 - 1)

1362 : (
œ°CommôPoöt
 - 1));

1363 
	`œunchRódMëad©aVIO
(
íåy
->
vio
, 
jou∫Æ
->
¶ab
->
jou∫ÆOrigö
 + 
èûBlock
,

1364 
£tDecodedSèã
, 
föishM™uÆIO
);

1365 
	}
}

1368 
	$decodeSœbJou∫Æ
(
SœbJou∫Æ
 *
jou∫Æ
,

1369 
VDOCom∂ëi⁄
 *
∑ª¡
,

1370 
VDOA˘i⁄
 *
ˇŒback
,

1371 
VDOA˘i⁄
 *
îr‹H™dÀr
,

1372 
ThªadID
 
thªadID
)

1374 
	`¥ï¨eCom∂ëi⁄
(&
jou∫Æ
->
com∂ëi⁄
, 
ˇŒback
, 
îr‹H™dÀr
, 
thªadID
,

1375 
∑ª¡
);

1376 
jou∫Æ
->
ªsour˚Waôî
.
ˇŒback
 = 
ªadSœbJou∫ÆTaû
;

1377 
ªsu…
 = 
	`acquúeVIO
(
jou∫Æ
->
¶ab
->
Æloˇt‹
, &jou∫Æ->
ªsour˚Waôî
);

1378 i‡(
ªsu…
 !
VDO_SUCCESS
) {

1379 
	`föishCom∂ëi⁄
(&
jou∫Æ
->
com∂ëi⁄
, 
ªsu…
);

1381 
	}
}

1384 
	$dumpSœbJou∫Æ
(c⁄° 
SœbJou∫Æ
 *
jou∫Æ
)

1386 
	`logInfo
(" slab journal:ÉntryWaiters=%zu waitingToCommit=%s"

1387 " upd©ögSœbSumm¨y=%†hód=%" 
PRIu64
 " unreapable=%" PRIu64

1388 "Åaû=%" 
PRIu64
 "ÇextCommit=%" PRIu64 " summarized=%" PRIu64

1389 "Üa°Summ¨ized=%" 
PRIu64
 "ÑecoveryJournalLock=%" PRIu64

1390 " dúty=%s", 
	`cou¡Waôîs
(&
jou∫Æ
->
íåyWaôîs
),

1391 
	`boﬁToSåög
(
jou∫Æ
->
waôögToCommô
),

1392 
	`boﬁToSåög
(
jou∫Æ
->
upd©ögSœbSumm¨y
),

1393 
jou∫Æ
->
hód
, jou∫Æ->
uƒó∑bÀ
, jou∫Æ->
èû
,

1394 
jou∫Æ
->
√xtCommô
, jou∫Æ->
summ¨ized
, jou∫Æ->
œ°Summ¨ized
,

1395 
jou∫Æ
->
ªcovîyLock
,

1396 
	`boﬁToSåög
(
	`isSœbJou∫ÆDúty
(
jou∫Æ
)));

1399 
	}
}

	@vdo/base/slabJournal.h

22 #i‚de‡
SLAB_JOURNAL_H


23 
	#SLAB_JOURNAL_H


	)

25 
	~"com∂ëi⁄.h
"

26 
	~"jou∫ÆPoöt.h
"

27 
	~"rögNode.h
"

28 
	~"ty≥s.h
"

37 
SœbJou∫Æ
 *
	$asSœbJou∫Æ
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

38 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

45 
size_t
 
	$gëSœbJou∫ÆE¡rõsPîBlock
()

46 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

56 
SœbJou∫Æ
 *
	$¶abJou∫ÆFromDútyNode
(
RögNode
 *
node
)

57 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

70 
	$makeSœbJou∫Æ
(
BlockAŒoˇt‹
 *
Æloˇt‹
,

71 
Sœb
 *
¶ab
,

72 
PhysiˇlLayî
 *
œyî
,

73 
RecovîyJou∫Æ
 *
ªcovîyJou∫Æ
,

74 
SœbJou∫Æ
 **
jou∫ÆPå
)

75 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

82 
	`‰ìSœbJou∫Æ
(
SœbJou∫Æ
 **
jou∫ÆPå
);

92 
boﬁ
 
	$isSœbJou∫ÆBœnk
(c⁄° 
SœbJou∫Æ
 *
jou∫Æ
)

93 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

103 
boﬁ
 
	$isSœbJou∫ÆDúty
(c⁄° 
SœbJou∫Æ
 *
jou∫Æ
)

104 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

111 
	`ab‹tSœbJou∫ÆWaôîs
(
SœbJou∫Æ
 *
jou∫Æ
);

118 
	`ª›íSœbJou∫Æ
(
SœbJou∫Æ
 *
jou∫Æ
);

131 
boﬁ
 
	`mayAddSœbJou∫ÆE¡ry
(
SœbJou∫Æ
 *
jou∫Æ
,

132 
Jou∫ÆO≥øti⁄
 
›î©i⁄
,

133 
VDOCom∂ëi⁄
 *
com∂ëi⁄
);

143 
	`addSœbJou∫ÆE¡ryF‹Rebuûd
(
SœbJou∫Æ
 *
jou∫Æ
,

144 
PhysiˇlBlockNumbî
 
pbn
,

145 
Jou∫ÆO≥øti⁄
 
›î©i⁄
,

146 
Jou∫ÆPoöt
 *
ªcovîyPoöt
);

154 
	`addSœbJou∫ÆE¡ry
(
SœbJou∫Æ
 *
jou∫Æ
, 
D©aVIO
 *
d©aVIO
);

164 
	`adju°SœbJou∫ÆBlockRe„ªn˚
(
SœbJou∫Æ
 *
jou∫Æ
,

165 
Sequí˚Numbî
 
£quí˚Numbî
,

166 
adju°mít
);

179 
boﬁ
 
	$ªÀa£RecovîyJou∫ÆLock
(
SœbJou∫Æ
 *
jou∫Æ
,

180 
Sequí˚Numbî
 
ªcovîyLock
)

181 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

188 
	`commôSœbJou∫ÆTaû
(
SœbJou∫Æ
 *
jou∫Æ
);

200 
	`˛o£SœbJou∫Æ
(
SœbJou∫Æ
 *
jou∫Æ
,

201 
VDOCom∂ëi⁄
 *
∑ª¡
,

202 
VDOA˘i⁄
 *
ˇŒback
,

203 
VDOA˘i⁄
 *
îr‹H™dÀr
,

204 
ThªadID
 
thªadID
);

218 
	`ÊushSœbJou∫Æ
(
SœbJou∫Æ
 *
jou∫Æ
,

219 
VDOCom∂ëi⁄
 *
∑ª¡
,

220 
VDOA˘i⁄
 *
ˇŒback
,

221 
VDOA˘i⁄
 *
îr‹H™dÀr
,

222 
ThªadID
 
thªadID
);

236 
	`decodeSœbJou∫Æ
(
SœbJou∫Æ
 *
jou∫Æ
,

237 
VDOCom∂ëi⁄
 *
∑ª¡
,

238 
VDOA˘i⁄
 *
ˇŒback
,

239 
VDOA˘i⁄
 *
îr‹H™dÀr
,

240 
ThªadID
 
thªadID
);

249 
boﬁ
 
	$ªquúesS¸ubbög
(c⁄° 
SœbJou∫Æ
 *
jou∫Æ
)

250 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

257 
	`dumpSœbJou∫Æ
(c⁄° 
SœbJou∫Æ
 *
jou∫Æ
);

	@vdo/base/slabJournalEraser.c

22 
	~"¶abJou∫ÆEø£r.h
"

24 
	~"mem‹yAŒoc.h
"

26 
	~"com∂ëi⁄.h
"

27 
	~"c⁄°™ts.h
"

28 
	~"exã¡.h
"

29 
	~"¶ab.h
"

30 
	~"¶abDïŸ.h
"

33 
VDOCom∂ëi⁄
 *
	m∑ª¡
;

34 
VDOExã¡
 *
	mexã¡
;

35 *
	mzîoBuf„r
;

36 
SœbIãøt‹
 
	m¶abs
;

37 } 
	tSœbJou∫ÆEø£r
;

45 
	$föishEøsög
(
SœbJou∫ÆEø£r
 *
îa£r
, 
ªsu…
)

47 
VDOCom∂ëi⁄
 *
∑ª¡
 = 
îa£r
->parent;

48 
	`‰ìExã¡
(&
îa£r
->
exã¡
);

49 
	`FREE
(
îa£r
->
zîoBuf„r
);

50 
	`FREE
(
îa£r
);

51 
	`föishCom∂ëi⁄
(
∑ª¡
, 
ªsu…
);

52 
	}
}

59 
	$h™dÀEøsögEº‹
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

61 
SœbJou∫ÆEø£r
 *
îa£r
 = 
com∂ëi⁄
->
∑ª¡
;

62 
	`föishEøsög
(
îa£r
,Éø£r->
exã¡
->
com∂ëi⁄
.
ªsu…
);

63 
	}
}

70 
	$îa£NextSœbJou∫Æ
(
VDOCom∂ëi⁄
 *
exã¡Com∂ëi⁄
)

72 
SœbJou∫ÆEø£r
 *
îa£r
 = 
exã¡Com∂ëi⁄
->
∑ª¡
;

74 i‡(!
	`hasNextSœb
(&
îa£r
->
¶abs
)) {

75 
	`föishEøsög
(
îa£r
, 
VDO_SUCCESS
);

79 
Sœb
 *
¶ab
 = 
	`√xtSœb
(&
îa£r
->
¶abs
);

80 
	`wrôeMëad©aExã¡
(
îa£r
->
exã¡
, 
¶ab
->
jou∫ÆOrigö
);

81 
	}
}

84 
	$îa£SœbJou∫Æs
(
SœbDïŸ
 *
dïŸ
,

85 
SœbIãøt‹
 
¶abs
,

86 
VDOCom∂ëi⁄
 *
∑ª¡
)

88 
SœbJou∫ÆEø£r
 *
îa£r
;

89 
ªsu…
 = 
	`ALLOCATE
(1, 
SœbJou∫ÆEø£r
, 
__func__
, &
îa£r
);

90 i‡(
ªsu…
 !
VDO_SUCCESS
) {

91 
	`föishCom∂ëi⁄
(
∑ª¡
, 
ªsu…
);

95 
îa£r
->
∑ª¡
 =Öarent;

96 
îa£r
->
¶abs
 = slabs;

98 
BlockCou¡
 
jou∫ÆSize
 = 
	`gëSœbC⁄fig
(
dïŸ
)->
¶abJou∫ÆBlocks
;

99 
ªsu…
 = 
	`ALLOCATE
(
jou∫ÆSize
 * 
VDO_BLOCK_SIZE
, , 
__func__
,

100 &
îa£r
->
zîoBuf„r
);

101 i‡(
ªsu…
 !
VDO_SUCCESS
) {

102 
	`föishEøsög
(
îa£r
, 
ªsu…
);

106 
ªsu…
 = 
	`¸óãExã¡
(
∑ª¡
->
œyî
, 
VIO_TYPE_SLAB_JOURNAL
,

107 
VIO_PRIORITY_METADATA
, 
jou∫ÆSize
, 
îa£r
->
zîoBuf„r
,

108 &
îa£r
->
exã¡
);

109 i‡(
ªsu…
 !
VDO_SUCCESS
) {

110 
	`föishEøsög
(
îa£r
, 
ªsu…
);

114 
VDOCom∂ëi⁄
 *
exã¡Com∂ëi⁄
 = &
îa£r
->
exã¡
->
com∂ëi⁄
;

115 
	`¥ï¨eCom∂ëi⁄
(
exã¡Com∂ëi⁄
, 
îa£NextSœbJou∫Æ
,

116 
h™dÀEøsögEº‹
, 
	`gëCÆlbackThªadID
(), 
îa£r
);

117 
	`îa£NextSœbJou∫Æ
(
exã¡Com∂ëi⁄
);

118 
	}
}

	@vdo/base/slabJournalEraser.h

22 #i‚de‡
SLAB_JOURNAL_ERASER_H


23 
	#SLAB_JOURNAL_ERASER_H


	)

25 
	~"¶abIãøt‹.h
"

26 
	~"ty≥s.h
"

35 
îa£SœbJou∫Æs
(
SœbDïŸ
 *
dïŸ
,

36 
SœbIãøt‹
 
¶abs
,

37 
VDOCom∂ëi⁄
 *
∑ª¡
);

	@vdo/base/slabJournalInternals.h

22 #i‚de‡
SLAB_JOURNAL_INTERNALS_H


23 
	#SLAB_JOURNAL_INTERNALS_H


	)

25 
	~"¶abJou∫Æ.h
"

27 
	~"blockAŒoˇt‹I¡î«ls.h
"

28 
	~"blockDes¸ùt‹.h
"

29 
	~"blockM≠E¡ry.h
"

30 
	~"jou∫ÆPoöt.h
"

31 
	~"¶ab.h
"

32 
	~"¶abSumm¨y.h
"

33 
	~"°©i°ics.h
"

34 
	~"waôQueue.h
"

45 
	s¶abJou∫ÆE¡ry
 {

46 
SœbBlockNumbî
 
	msbn
;

47 
Jou∫ÆO≥øti⁄
 
	m›î©i⁄
;

52 
uöt32_t
 
	moff£t
 : 23;

53 
uöt32_t
 
	mö¸emít
 : 1;

54 } 
	t__©åibuã__
((
	t∑cked
)Ë
	tPackedSœbJou∫ÆE¡ry
;

59 
Sequí˚Numbî
 
	mhód
;

61 
Sequí˚Numbî
 
	m£quí˚Numbî
;

63 
PackedJou∫ÆPoöt
 
	mªcovîyPoöt
;

65 
N⁄˚
 
	mn⁄˚
;

67 
VDOMëad©aTy≥
 
	mmëad©aTy≥
;

69 
boﬁ
 
	mhasBlockM≠In¸emíts
;

71 
Jou∫ÆE¡ryCou¡
 
	míåyCou¡
;

72 } 
	t__©åibuã__
((
	t∑cked
)Ë
	tSœbJou∫ÆBlockHódî
;

75 
	mSLAB_JOURNAL_PAYLOAD_SIZE
 = 
VDO_BLOCK_SIZE
 - (
SœbJou∫ÆBlockHódî
),

76 
	mSLAB_JOURNAL_FULL_ENTRIES_PER_BLOCK
 = (
SLAB_JOURNAL_PAYLOAD_SIZE
 * 8) / 25,

77 
	mSLAB_JOURNAL_ENTRY_TYPES_SIZE
 = ((
SLAB_JOURNAL_FULL_ENTRIES_PER_BLOCK
 - 1)

79 
	mSLAB_JOURNAL_ENTRIES_PER_BLOCK
 = (
SLAB_JOURNAL_PAYLOAD_SIZE


80 / (
PackedSœbJou∫ÆE¡ry
)),

86 
PackedSœbJou∫ÆE¡ry
 
	míåõs
[
SLAB_JOURNAL_FULL_ENTRIES_PER_BLOCK
];

88 
byã
 
	míåyTy≥s
[
SLAB_JOURNAL_ENTRY_TYPES_SIZE
];

89 } 
	t__©åibuã__
((
	t∑cked
)Ë
	tFuŒSœbJou∫ÆE¡rõs
;

93 
FuŒSœbJou∫ÆE¡rõs
 
	mfuŒE¡rõs
;

95 
PackedSœbJou∫ÆE¡ry
 
	míåõs
[
SLAB_JOURNAL_ENTRIES_PER_BLOCK
];

97 
byã
 
	m•a˚
[
SLAB_JOURNAL_PAYLOAD_SIZE
];

98 } 
	t__©åibuã__
((
	t∑cked
)Ë
	tSœbJou∫ÆPaylﬂd
;

101 
SœbJou∫ÆBlockHódî
 
	mhódî
;

102 
SœbJou∫ÆPaylﬂd
 
	m∑ylﬂd
;

103 } 
	t__©åibuã__
((
	t∑cked
)Ë
	tPackedSœbJou∫ÆBlock
;

106 
	mNOT_FLUSHING
,

107 
	mFLUSH_REQUESTED
,

108 
	mFLUSH_INITIATED
,

109 } 
	tFlushSèã
;

112 
uöt16_t
 
	mcou¡
;

113 
Sequí˚Numbî
 
	mªcovîySèπ
;

114 } 
	tJou∫ÆLock
;

116 
	s¶abJou∫Æ
 {

118 
VDOCom∂ëi⁄
 
	mcom∂ëi⁄
;

121 
Waôî
 
	mªsour˚Waôî
;

123 
Waôî
 
	m¶abSumm¨yWaôî
;

125 
Waôî
 
	mÊushWaôî
;

127 
WaôQueue
 
	míåyWaôîs
;

129 
Sœb
 *
	m¶ab
;

132 
FlushSèã
 
	mÊushSèã
;

134 
boﬁ
 
	m˛o£Reque°ed
;

136 
boﬁ
 
	mwaôögToCommô
;

138 
boﬁ
 
	mwaôögF‹S∑˚
;

140 
boﬁ
 
	mupd©ögSœbSumm¨y
;

142 
boﬁ
 
	maddögE¡rõs
;

144 
boﬁ
 
	m∑πülWrôeInProgªss
;

147 
Sequí˚Numbî
 
	mhód
;

149 
Sequí˚Numbî
 
	muƒó∑bÀ
;

151 
Sequí˚Numbî
 
	mèû
;

153 
Sequí˚Numbî
 
	m√xtCommô
;

155 
Sequí˚Numbî
 
	msumm¨ized
;

157 
Sequí˚Numbî
 
	mœ°Summ¨ized
;

160 
Sequí˚Numbî
 
	mªcovîyLock
;

162 
Jou∫ÆPoöt
 
	mªcovîyPoöt
;

168 
Jou∫ÆE¡ryCou¡
 
	míåõsPîBlock
;

173 
Jou∫ÆE¡ryCou¡
 
	mfuŒE¡rõsPîBlock
;

176 
RecovîyJou∫Æ
 *
	mªcovîyJou∫Æ
;

179 
SœbSumm¨yZ⁄e
 *
	msumm¨y
;

181 
AtomicSœbJou∫ÆSèti°ics
 *
	mevíts
;

183 
BlockDes¸ùt‹
 *
	mdes¸ùt‹
;

185 
RögNode
 
	muncommôãdBlocks
;

187 
PackedSœbJou∫ÆBlock
 *
	mblock
;

190 
BlockCou¡
 
	msize
;

192 
BlockCou¡
 
	mÊushögThªshﬁd
;

194 
BlockCou¡
 
	mÊushögDódlöe
;

196 
BlockCou¡
 
	mblockögThªshﬁd
;

198 
BlockCou¡
 
	ms¸ubbögThªshﬁd
;

201 
RögNode
 
	mdútyNode
;

204 
Jou∫ÆLock
 *
	mª≠Lock
;

206 
Jou∫ÆLock
 
	mlocks
[];

217 
__©åibuã__
((
w¨n_unu£d_ªsu…
))

218 
ölöe
 
TaûBlockOff£t


219 
	$gëSœbJou∫ÆBlockOff£t
(
SœbJou∫Æ
 *
jou∫Æ
, 
Sequí˚Numbî
 
£quí˚
)

221  (
£quí˚
 % 
jou∫Æ
->
size
);

222 
	}
}

231 
ícodeSœbJou∫ÆE¡ry
(
PackedSœbJou∫ÆBlock
 *
block
,

232 
SœbBlockNumbî
 
sbn
,

233 
Jou∫ÆO≥øti⁄
 
›î©i⁄
);

243 
SœbJou∫ÆE¡ry
 
	$decodeSœbJou∫ÆE¡ry
(
PackedSœbJou∫ÆBlock
 *
block
,

244 
Jou∫ÆE¡ryCou¡
 
íåyCou¡
)

245 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

	@vdo/base/slabRebuild.c

22 
	~"¶abRebuûd.h
"

24 
	~"loggî.h
"

25 
	~"mem‹yAŒoc.h
"

27 
	~"blockAŒoˇt‹I¡î«ls.h
"

28 
	~"exã¡.h
"

29 
	~"jou∫ÆPoöt.h
"

30 
	~"ªcovîyJou∫Æ.h
"

31 
	~"ªfCou¡sI¡î«ls.h
"

32 
	~"ªfCou¡s.h
"

33 
	~"¶abCom∂ëi⁄.h
"

34 
	~"¶abJou∫ÆI¡î«ls.h
"

35 
	~"¶abSumm¨y.h
"

39 
VDOCom∂ëi⁄
 
	mcom∂ëi⁄
;

41 
Sœb
 *
	m¶ab
;

43 
VDOExã¡
 *
	mexã¡
;

45 *
	mjou∫ÆD©a
;

46 } 
	tSœbRebuûdCom∂ëi⁄
;

55 
__©åibuã__
((
w¨n_unu£d_ªsu…
))

56 
ölöe
 
SœbRebuûdCom∂ëi⁄
 *

57 
	$asSœbRebuûdCom∂ëi⁄
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

59 i‡(
com∂ëi⁄
 =
NULL
) {

60  
NULL
;

62 
	`STATIC_ASSERT
(
	`off£tof
(
SœbRebuûdCom∂ëi⁄
, 
com∂ëi⁄
) == 0);

63 
	`as£πCom∂ëi⁄Ty≥
(
com∂ëi⁄
->
ty≥
, 
SLAB_REBUILD_COMPLETION
);

64  (
SœbRebuûdCom∂ëi⁄
 *Ë
com∂ëi⁄
;

65 
	}
}

68 
	$makeSœbRebuûdCom∂ëi⁄
(
PhysiˇlLayî
 *
œyî
,

69 
BlockCou¡
 
¶abJou∫ÆSize
,

70 
VDOCom∂ëi⁄
 **
com∂ëi⁄På
)

72 
SœbRebuûdCom∂ëi⁄
 *
ªbuûd
;

73 
ªsu…
 = 
	`ALLOCATE
(1, 
SœbRebuûdCom∂ëi⁄
, 
__func__
, &
ªbuûd
);

74 i‡(
ªsu…
 !
VDO_SUCCESS
) {

75  
ªsu…
;

78 
VDOCom∂ëi⁄
 *
com∂ëi⁄
 = &
ªbuûd
->completion;

79 
	`öôülizeCom∂ëi⁄
(
com∂ëi⁄
, 
SLAB_REBUILD_COMPLETION
, 
œyî
);

81 
size_t
 
buf„rSize
 = 
VDO_BLOCK_SIZE
 * 
¶abJou∫ÆSize
;

82 
ªsu…
 = 
	`ALLOCATE
(
buf„rSize
, , 
__func__
, &
ªbuûd
->
jou∫ÆD©a
);

83 i‡(
ªsu…
 !
VDO_SUCCESS
) {

84 
	`‰ìSœbRebuûdCom∂ëi⁄
(&
com∂ëi⁄
);

85  
ªsu…
;

88 
ªsu…
 = 
	`¸óãExã¡
(
œyî
, 
VIO_TYPE_SLAB_JOURNAL
, 
VIO_PRIORITY_METADATA
,

89 
¶abJou∫ÆSize
, 
ªbuûd
->
jou∫ÆD©a
,

90 &
ªbuûd
->
exã¡
);

91 i‡(
ªsu…
 !
VDO_SUCCESS
) {

92 
	`‰ìSœbRebuûdCom∂ëi⁄
(&
com∂ëi⁄
);

93  
ªsu…
;

96 *
com∂ëi⁄På
 = 
com∂ëi⁄
;

97  
VDO_SUCCESS
;

98 
	}
}

101 
	$‰ìSœbRebuûdCom∂ëi⁄
(
VDOCom∂ëi⁄
 **
com∂ëi⁄På
)

103 
SœbRebuûdCom∂ëi⁄
 *
ªbuûd
 = 
	`asSœbRebuûdCom∂ëi⁄
(*
com∂ëi⁄På
);

104 i‡(
ªbuûd
 =
NULL
) {

108 
	`‰ìExã¡
(&
ªbuûd
->
exã¡
);

109 
	`FREE
(
ªbuûd
->
jou∫ÆD©a
);

110 
	`FREE
(
ªbuûd
);

111 *
com∂ëi⁄På
 = 
NULL
;

112 
	}
}

119 
	$föishSœbRebuûd
(
SœbRebuûdCom∂ëi⁄
 *
ªbuûd
)

121 
Sœb
 *
¶ab
 = 
ªbuûd
->slab;

122 
¶ab
->
°©us
 = 
SLAB_REBUILT
;

123 
	`queueSœb
(
¶ab
);

124 
	`ª›íSœbJou∫Æ
(
¶ab
->
jou∫Æ
);

125 
	`föishCom∂ëi⁄
(&
ªbuûd
->
com∂ëi⁄
, 
VDO_SUCCESS
);

126 
	}
}

134 
	$föishSavögRe„ªn˚Cou¡sCÆlback
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

137 
SœbRebuûdCom∂ëi⁄
 *
ªbuûd
 = 
	`asSœbRebuûdCom∂ëi⁄
(
com∂ëi⁄
->
∑ª¡
);

138 
	`föishSœbRebuûd
(
ªbuûd
);

139 
	}
}

150 
	$≠∂yBlockE¡rõs
(
PackedSœbJou∫ÆBlock
 *
block
,

151 
Sequí˚Numbî
 
blockNumbî
,

152 
Sœb
 *
¶ab
)

154 
SœbJou∫ÆBlockHódî
 *
hódî
 = &
block
->header;

155 
Jou∫ÆPoöt
 
íåyPoöt
 = {

156 .
£quí˚Numbî
 = 
blockNumbî
,

157 .
íåyCou¡
 = 0,

160 
SœbBlockNumbî
 
maxSBN
 = 
¶ab
->
íd
 - sœb->
°¨t
;

161 
íåyPoöt
.
íåyCou¡
 < 
hódî
->entryCount) {

162 
SœbJou∫ÆE¡ry
 
íåy
 = 
	`decodeSœbJou∫ÆE¡ry
(
block
,

163 
íåyPoöt
.
íåyCou¡
);

164 i‡(
íåy
.
sbn
 > 
maxSBN
) {

166  
	`logEº‹WôhSåögEº‹
(
VDO_CORRUPT_JOURNAL
, "Slab journalÉntry"

167 " (%" 
PRIu64
 ", %u) had invalid offset"

169 
blockNumbî
, 
íåyPoöt
.
íåyCou¡
,

170 
íåy
.
sbn
, 
maxSBN
);

173 
ªsu…
 = 
	`ª∂ayRe„ªn˚Cou¡Ch™ge
(
¶ab
->
ª„ªn˚Cou¡s
, &
íåyPoöt
,

174 
íåy
);

175 i‡(
ªsu…
 !
VDO_SUCCESS
) {

176 
	`logEº‹WôhSåögEº‹
(
ªsu…
, "Sœb jou∫ÆÉ¡ry (%" 
PRIu64
 ", %u)"

177 " (%†o‡off£à%" 
PRIu32
 ") couldÇot be"

179 
blockNumbî
, 
íåyPoöt
.
íåyCou¡
,

180 
	`gëJou∫ÆO≥øti⁄Name
(
íåy
.
›î©i⁄
),

181 
íåy
.
sbn
, 
¶ab
->
¶abNumbî
);

182  
ªsu…
;

184 
íåyPoöt
.
íåyCou¡
++;

187  
VDO_SUCCESS
;

188 
	}
}

196 
	$≠∂yJou∫ÆE¡rõs
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

198 
SœbRebuûdCom∂ëi⁄
 *
ªbuûd
 = 
	`asSœbRebuûdCom∂ëi⁄
(
com∂ëi⁄
->
∑ª¡
);

199 
Sœb
 *
¶ab
 = 
ªbuûd
->slab;

200 
SœbJou∫Æ
 *
jou∫Æ
 = 
¶ab
->journal;

201 
RefCou¡s
 *
ª„ªn˚Cou¡s
 = 
¶ab
->referenceCounts;

204 
Sequí˚Numbî
 
èû
 = 
jou∫Æ
->tail;

205 
TaûBlockOff£t
 
ídIndex
 = 
	`gëSœbJou∫ÆBlockOff£t
(
jou∫Æ
, 
èû
 - 1);

206 *
ídD©a
 = 
ªbuûd
->
jou∫ÆD©a
 + (
ídIndex
 * 
VDO_BLOCK_SIZE
);

207 
PackedSœbJou∫ÆBlock
 *
ídBlock
 = (PackedSœbJou∫ÆBlock *Ë
ídD©a
;

209 
Sequí˚Numbî
 
hód
 = 
ídBlock
->
hódî
.head;

210 
TaûBlockOff£t
 
hódIndex
 = 
	`gëSœbJou∫ÆBlockOff£t
(
jou∫Æ
, 
hód
);

211 
BlockCou¡
 
ödex
 = 
hódIndex
;

213 
Jou∫ÆPoöt
 
ªfCou¡sPoöt
 = 
ª„ªn˚Cou¡s
->
¶abJou∫ÆPoöt
;

214 
Jou∫ÆPoöt
 
œ°E¡ryAµlõd
 = 
ªfCou¡sPoöt
;

215 
Sequí˚Numbî
 
£quí˚
 = 
hód
; sequí˚ < 
èû
; sequence++) {

216 *
blockD©a
 = 
ªbuûd
->
jou∫ÆD©a
 + (
ödex
 * 
VDO_BLOCK_SIZE
);

217 
PackedSœbJou∫ÆBlock
 *
block
 = (PackedSœbJou∫ÆBlock *Ë
blockD©a
;

218 
SœbJou∫ÆBlockHódî
 *
hódî
 = &
block
->header;

219 i‡((
hódî
->
n⁄˚
 !
¶ab
->
Æloˇt‹
->nonce)

220 || (
hódî
->
mëad©aTy≥
 !
VDO_METADATA_SLAB_JOURNAL
)

221 || (
hódî
->
£quí˚Numbî
 !
£quí˚
)

222 || (
hódî
->
íåyCou¡
 > 
jou∫Æ
->
íåõsPîBlock
)

223 || (
hódî
->
hasBlockM≠In¸emíts


224 && (
hódî
->
íåyCou¡
 > 
jou∫Æ
->
fuŒE¡rõsPîBlock
))) {

226 
	`logEº‹
("Slab journal block for slab %u was invalid",

227 
¶ab
->
¶abNumbî
);

228 
	`föishCom∂ëi⁄
(&
ªbuûd
->
com∂ëi⁄
, 
VDO_CORRUPT_JOURNAL
);

231 
ªsu…
 = 
	`≠∂yBlockE¡rõs
(
block
, 
£quí˚
, 
¶ab
);

232 i‡(
ªsu…
 !
VDO_SUCCESS
) {

233 
	`föishCom∂ëi⁄
(&
ªbuûd
->
com∂ëi⁄
, 
ªsu…
);

237 
œ°E¡ryAµlõd
.
£quí˚Numbî
 = 
£quí˚
;

238 
œ°E¡ryAµlõd
.
íåyCou¡
 = 
hódî
->entryCount - 1;

239 
ödex
++;

240 i‡(
ödex
 =
jou∫Æ
->
size
) {

241 
ödex
 = 0;

247 
ªsu…
 = 
	`ASSERT
(!
	`bef‹eJou∫ÆPoöt
(&
œ°E¡ryAµlõd
, &
ªfCou¡sPoöt
),

249 i‡(
ªsu…
 !
VDO_SUCCESS
) {

250 
	`föishCom∂ëi⁄
(&
ªbuûd
->
com∂ëi⁄
, 
ªsu…
);

255 i‡(!
	`mu°LﬂdRefCou¡s
(
jou∫Æ
->
summ¨y
, 
¶ab
->
¶abNumbî
)) {

256 
ªsu…
 = 
	`dútyAŒRe„ªn˚Blocks
(
ª„ªn˚Cou¡s
);

257 i‡(
ªsu…
 !
VDO_SUCCESS
) {

258 
	`föishCom∂ëi⁄
(&
ªbuûd
->
com∂ëi⁄
, 
ªsu…
);

264 
	`ßveRebuûtSœb
(
¶ab
, &
ªbuûd
->
com∂ëi⁄
,

265 
föishSavögRe„ªn˚Cou¡sCÆlback
,

266 
föishP¨ítCÆlback
);

267 
	}
}

275 
	$°¨tS¸ubbög
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

277 
SœbRebuûdCom∂ëi⁄
 *
ªbuûd
 = 
	`asSœbRebuûdCom∂ëi⁄
(
com∂ëi⁄
->
∑ª¡
);

278 
Sœb
 *
¶ab
 = 
ªbuûd
->slab;

279 i‡(
	`gëSumm¨izedCÀ™löess
(
¶ab
->
Æloˇt‹
->
summ¨y
, sœb->
¶abNumbî
)) {

280 
	`föishSœbRebuûd
(
ªbuûd
);

284 
	`¥ï¨eCom∂ëi⁄
(&
ªbuûd
->
exã¡
->
com∂ëi⁄
, 
≠∂yJou∫ÆE¡rõs
,

285 
föishP¨ítCÆlback
, 
com∂ëi⁄
->
ˇŒbackThªadID
,

286 
com∂ëi⁄
->
∑ª¡
);

287 
	`ªadMëad©aExã¡
(
ªbuûd
->
exã¡
,Ñebuûd->
¶ab
->
jou∫ÆOrigö
);

288 
	}
}

295 
	$ÊushSœbJou∫ÆF‹Rebuûd
(
SœbRebuûdCom∂ëi⁄
 *
ªbuûd
)

297 
	`ÊushSœbJou∫Æ
(
ªbuûd
->
¶ab
->
jou∫Æ
, &ªbuûd->
com∂ëi⁄
,

298 
°¨tS¸ubbög
, 
föishP¨ítCÆlback
,

299 
ªbuûd
->
com∂ëi⁄
.
ˇŒbackThªadID
);

300 
	}
}

307 
	$föishLﬂdögRe„ªn˚Blocks
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

309 
SœbRebuûdCom∂ëi⁄
 *
ªbuûd
 = 
	`asSœbRebuûdCom∂ëi⁄
(
com∂ëi⁄
->
∑ª¡
);

310 
	`ÊushSœbJou∫ÆF‹Rebuûd
(
ªbuûd
);

311 
	}
}

314 
	$s¸ubSœb
(
Sœb
 *
¶ab
, 
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

316 
SœbRebuûdCom∂ëi⁄
 *
ªbuûd
 = 
	`asSœbRebuûdCom∂ëi⁄
(
com∂ëi⁄
);

317 
ªbuûd
->
¶ab
 = slab;

318 
¶ab
->
°©us
 = 
SLAB_REBUILDING
;

320 i‡(
	`mu°LﬂdRefCou¡s
(
¶ab
->
Æloˇt‹
->
summ¨y
, sœb->
¶abNumbî
)) {

321 
	`lﬂdRe„ªn˚Blocks
(
¶ab
->
ª„ªn˚Cou¡s
, &
ªbuûd
->
com∂ëi⁄
,

322 
föishLﬂdögRe„ªn˚Blocks
, 
föishP¨ítCÆlback
,

323 
ªbuûd
->
com∂ëi⁄
.
ˇŒbackThªadID
);

327 
	`ÊushSœbJou∫ÆF‹Rebuûd
(
ªbuûd
);

328 
	}
}

	@vdo/base/slabRebuild.h

22 #i‚de‡
SLAB_REBUILD_H


23 
	#SLAB_REBUILD_H


	)

25 
	~"¶ab.h
"

36 
	$makeSœbRebuûdCom∂ëi⁄
(
PhysiˇlLayî
 *
œyî
,

37 
BlockCou¡
 
¶abJou∫ÆSize
,

38 
VDOCom∂ëi⁄
 **
com∂ëi⁄På
)

39 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

46 
	`‰ìSœbRebuûdCom∂ëi⁄
(
VDOCom∂ëi⁄
 **
com∂ëi⁄På
);

54 
	`s¸ubSœb
(
Sœb
 *
¶ab
, 
VDOCom∂ëi⁄
 *
com∂ëi⁄
);

	@vdo/base/slabScrubber.c

22 
	~"¶abS¸ubbîI¡î«ls.h
"

24 
	~"loggî.h
"

25 
	~"mem‹yAŒoc.h
"

27 
	~"blockAŒoˇt‹.h
"

28 
	~"ªadO∆yModeC⁄ãxt.h
"

29 
	~"¶abRebuûd.h
"

32 
	$makeSœbS¸ubbî
(
PhysiˇlLayî
 *
œyî
,

33 
BlockCou¡
 
¶abJou∫ÆSize
,

34 
RódO∆yModeC⁄ãxt
 *
ªadO∆yC⁄ãxt
,

35 
SœbS¸ubbî
 **
s¸ubbîPå
)

37 
SœbS¸ubbî
 *
s¸ubbî
;

38 
ªsu…
 = 
	`ALLOCATE
(1, 
SœbS¸ubbî
, 
__func__
, &
s¸ubbî
);

39 i‡(
ªsu…
 !
VDO_SUCCESS
) {

40  
ªsu…
;

43 
ªsu…
 = 
	`makeSœbRebuûdCom∂ëi⁄
(
œyî
, 
¶abJou∫ÆSize
,

44 &
s¸ubbî
->
¶abRebuûdCom∂ëi⁄
);

45 i‡(
ªsu…
 !
VDO_SUCCESS
) {

46 
	`‰ìSœbS¸ubbî
(&
s¸ubbî
);

47  
ªsu…
;

50 
	`öôülizeCom∂ëi⁄
(&
s¸ubbî
->
com∂ëi⁄
, 
SLAB_SCRUBBER_COMPLETION
, 
œyî
);

51 
	`öôülizeRög
(&
s¸ubbî
->
highPri‹ôySœbs
);

52 
	`öôülizeRög
(&
s¸ubbî
->
¶abs
);

53 
s¸ubbî
->
ªadO∆yC⁄ãxt
 =ÑeadOnlyContext;

54 *
s¸ubbîPå
 = 
s¸ubbî
;

55  
VDO_SUCCESS
;

56 
	}
}

59 
	$‰ìSœbS¸ubbî
(
SœbS¸ubbî
 **
s¸ubbîPå
)

61 i‡(*
s¸ubbîPå
 =
NULL
) {

65 
SœbS¸ubbî
 *
s¸ubbî
 = *
s¸ubbîPå
;

66 
	`‰ìSœbRebuûdCom∂ëi⁄
(&
s¸ubbî
->
¶abRebuûdCom∂ëi⁄
);

67 
	`FREE
(
s¸ubbî
);

68 *
s¸ubbîPå
 = 
NULL
;

69 
	}
}

72 
boﬁ
 
	$isS¸ubbög
(
SœbS¸ubbî
 *
s¸ubbî
)

74  
s¸ubbî
->
isS¸ubbög
;

75 
	}
}

84 
Sœb
 *
	$gëNextSœb
(
SœbS¸ubbî
 *
s¸ubbî
)

86 i‡(!
	`isRögEm±y
(&
s¸ubbî
->
highPri‹ôySœbs
)) {

87  
	`¶abFromRögNode
(
s¸ubbî
->
highPri‹ôySœbs
.
√xt
);

90 i‡(!
	`isRögEm±y
(&
s¸ubbî
->
¶abs
)) {

91  
	`¶abFromRögNode
(
s¸ubbî
->
¶abs
.
√xt
);

94  
NULL
;

95 
	}
}

98 
boﬁ
 
	$hasSœbsToS¸ub
(
SœbS¸ubbî
 *
s¸ubbî
)

100  (
	`gëNextSœb
(
s¸ubbî
Ë!
NULL
);

101 
	}
}

104 
SœbCou¡
 
	$gëS¸ubbîSœbCou¡
(c⁄° 
SœbS¸ubbî
 *
s¸ubbî
)

106  
	`ªœxedLﬂd64
(&
s¸ubbî
->
¶abCou¡
);

107 
	}
}

110 
	$ªgi°îSœbF‹S¸ubbög
(
SœbS¸ubbî
 *
s¸ubbî
,

111 
Sœb
 *
¶ab
,

112 
boﬁ
 
highPri‹ôy
)

114 
	`ASSERT_LOG_ONLY
((
¶ab
->
°©us
 !
SLAB_REBUILT
),

117 i‡(
¶ab
->
°©us
 !
SLAB_REQUIRES_SCRUBBING
) {

121 
	`un•li˚RögNode
(&
¶ab
->
rögNode
);

122 i‡(!
¶ab
->
wasQueuedF‹S¸ubbög
) {

123 
	`ªœxedAdd64
(&
s¸ubbî
->
¶abCou¡
, 1);

124 
¶ab
->
wasQueuedF‹S¸ubbög
 = 
åue
;

127 i‡(
highPri‹ôy
) {

128 
¶ab
->
°©us
 = 
SLAB_REQUIRES_HIGH_PRIORITY_SCRUBBING
;

129 
	`pushRögNode
(&
s¸ubbî
->
highPri‹ôySœbs
, &
¶ab
->
rögNode
);

133 
	`pushRögNode
(&
s¸ubbî
->
¶abs
, &
¶ab
->
rögNode
);

134 
	}
}

142 
	$föishS¸ubbög
(
SœbS¸ubbî
 *
s¸ubbî
)

144 
s¸ubbî
->
isS¸ubbög
 = 
Ál£
;

145 
s¸ubbî
->
highPri‹ôyO∆y
 = 
Ál£
;

146 
	`nŸifyAŒWaôîs
(&
s¸ubbî
->
waôîs
, 
NULL
, NULL);

147 i‡(!
	`hasSœbsToS¸ub
(
s¸ubbî
)) {

148 
	`‰ìSœbRebuûdCom∂ëi⁄
(&
s¸ubbî
->
¶abRebuûdCom∂ëi⁄
);

150 
	`com∂ëeCom∂ëi⁄
(&
s¸ubbî
->
com∂ëi⁄
);

151 
	}
}

154 
s¸ubNextSœb
(
SœbS¸ubbî
 *
s¸ubbî
);

162 
	$¶abS¸ubbed
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

164 
SœbS¸ubbî
 *
s¸ubbî
 = 
com∂ëi⁄
->
∑ª¡
;

165 
	`ªœxedAdd64
(&
s¸ubbî
->
¶abCou¡
, -1);

166 
	`nŸifyAŒWaôîs
(&
s¸ubbî
->
waôîs
, 
NULL
, NULL);

167 
	`s¸ubNextSœb
(
s¸ubbî
);

168 
	}
}

175 
	$s¸ubNextSœb
(
SœbS¸ubbî
 *
s¸ubbî
)

177 i‡(
	`isRódO∆y
(
s¸ubbî
->
ªadO∆yC⁄ãxt
)) {

178 
	`£tCom∂ëi⁄Resu…
(&
s¸ubbî
->
com∂ëi⁄
, 
VDO_READ_ONLY
);

179 
	`föishS¸ubbög
(
s¸ubbî
);

183 
Sœb
 *
¶ab
 = 
	`gëNextSœb
(
s¸ubbî
);

184 i‡(
s¸ubbî
->
°›S¸ubbög
 || (
¶ab
 =
NULL
)

185 || (
s¸ubbî
->
highPri‹ôyO∆y


186 && 
	`isRögEm±y
(&
s¸ubbî
->
highPri‹ôySœbs
))) {

187 
	`föishS¸ubbög
(
s¸ubbî
);

191 
	`un•li˚RögNode
(&
¶ab
->
rögNode
);

192 
	`ª£tCom∂ëi⁄
(
s¸ubbî
->
¶abRebuûdCom∂ëi⁄
);

193 
	`s¸ubSœb
(
¶ab
, 
s¸ubbî
->
¶abRebuûdCom∂ëi⁄
);

194 
	}
}

201 
	$h™dÀS¸ubbîEº‹
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

203 
SœbS¸ubbî
 *
s¸ubbî
 = 
com∂ëi⁄
->
∑ª¡
;

204 
	`íãrRódO∆yMode
(
s¸ubbî
->
ªadO∆yC⁄ãxt
, 
com∂ëi⁄
->
ªsu…
);

205 
	`£tCom∂ëi⁄Resu…
(&
s¸ubbî
->
com∂ëi⁄
, com∂ëi⁄->
ªsu…
);

206 
	`föishS¸ubbög
(
s¸ubbî
);

207 
	}
}

210 
	$s¸ubSœbs
(
SœbS¸ubbî
 *
s¸ubbî
,

211 *
∑ª¡
,

212 
VDOA˘i⁄
 *
ˇŒback
,

213 
VDOA˘i⁄
 *
îr‹H™dÀr
,

214 
ThªadID
 
thªadID
)

216 
s¸ubbî
->
isS¸ubbög
 = 
åue
;

217 
	`¥ï¨eCom∂ëi⁄
(&
s¸ubbî
->
com∂ëi⁄
, 
ˇŒback
, 
îr‹H™dÀr
, 
thªadID
,

218 
∑ª¡
);

219 i‡(!
	`hasSœbsToS¸ub
(
s¸ubbî
)) {

220 
	`föishS¸ubbög
(
s¸ubbî
);

224 
	`¥ï¨eCom∂ëi⁄
(
s¸ubbî
->
¶abRebuûdCom∂ëi⁄
, 
¶abS¸ubbed
,

225 
h™dÀS¸ubbîEº‹
, 
	`gëCÆlbackThªadID
(), 
s¸ubbî
);

226 
	`s¸ubNextSœb
(
s¸ubbî
);

227 
	}
}

230 
	$s¸ubHighPri‹ôySœbs
(
SœbS¸ubbî
 *
s¸ubbî
,

231 
boﬁ
 
s¸ubAtLó°O√
,

232 
VDOCom∂ëi⁄
 *
∑ª¡
,

233 
VDOA˘i⁄
 *
ˇŒback
,

234 
VDOA˘i⁄
 *
îr‹H™dÀr
)

236 i‡(
s¸ubAtLó°O√
 && 
	`isRögEm±y
(&
s¸ubbî
->
highPri‹ôySœbs
)) {

237 
Sœb
 *
¶ab
 = 
	`gëNextSœb
(
s¸ubbî
);

238 i‡(
¶ab
 !
NULL
) {

239 
	`ªgi°îSœbF‹S¸ubbög
(
s¸ubbî
, 
¶ab
, 
åue
);

242 
s¸ubbî
->
highPri‹ôyO∆y
 = 
åue
;

243 
	`s¸ubSœbs
(
s¸ubbî
, 
∑ª¡
, 
ˇŒback
, 
îr‹H™dÀr
, 
	`gëCÆlbackThªadID
());

244 
	}
}

247 
	$°›S¸ubbög
(
SœbS¸ubbî
 *
s¸ubbî
)

249 
s¸ubbî
->
°›S¸ubbög
 = 
åue
;

250 
	}
}

253 
	$íqueueCÀ™SœbWaôî
(
SœbS¸ubbî
 *
s¸ubbî
, 
Waôî
 *
waôî
)

255 i‡(!
s¸ubbî
->
isS¸ubbög
) {

256  (
	`isRódO∆y
(
s¸ubbî
->
ªadO∆yC⁄ãxt
)

257 ? 
VDO_READ_ONLY
 : 
VDO_NO_SPACE
);

260  
	`íqueueWaôî
(&
s¸ubbî
->
waôîs
, 
waôî
);

261 
	}
}

264 
	$dumpSœbS¸ubbî
(c⁄° 
SœbS¸ubbî
 *
s¸ubbî
)

266 
	`logInfo
("slabScrubber slabCount %u waiters %zu %s%s%s",

267 
	`gëS¸ubbîSœbCou¡
(
s¸ubbî
),

268 
	`cou¡Waôîs
(&
s¸ubbî
->
waôîs
),

269 
s¸ubbî
->
isS¸ubbög
 ? "isScrubbing " : "",

270 
s¸ubbî
->
°›S¸ubbög
 ? "stopScrubbing " : "",

271 
s¸ubbî
->
highPri‹ôyO∆y
 ? "highPriorityOnly " : "");

272 
	}
}

	@vdo/base/slabScrubber.h

22 #i‚de‡
SLAB_SCRUBBER_H


23 
	#SLAB_SCRUBBER_H


	)

25 
	~"com∂ëi⁄.h
"

26 
	~"ty≥s.h
"

27 
	~"waôQueue.h
"

39 
	$makeSœbS¸ubbî
(
PhysiˇlLayî
 *
œyî
,

40 
BlockCou¡
 
¶abJou∫ÆSize
,

41 
RódO∆yModeC⁄ãxt
 *
ªadO∆yC⁄ãxt
,

42 
SœbS¸ubbî
 **
s¸ubbîPå
)

43 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

50 
	`‰ìSœbS¸ubbî
(
SœbS¸ubbî
 **
s¸ubbîPå
);

59 
boﬁ
 
	$isS¸ubbög
(
SœbS¸ubbî
 *
s¸ubbî
)

60 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

69 
boﬁ
 
	$hasSœbsToS¸ub
(
SœbS¸ubbî
 *
s¸ubbî
)

70 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

80 
	`ªgi°îSœbF‹S¸ubbög
(
SœbS¸ubbî
 *
s¸ubbî
,

81 
Sœb
 *
¶ab
,

82 
boﬁ
 
highPri‹ôy
);

93 
	`s¸ubSœbs
(
SœbS¸ubbî
 *
s¸ubbî
,

94 *
∑ª¡
,

95 
VDOA˘i⁄
 *
ˇŒback
,

96 
VDOA˘i⁄
 *
îr‹H™dÀr
,

97 
ThªadID
 
thªadID
);

111 
	`s¸ubHighPri‹ôySœbs
(
SœbS¸ubbî
 *
s¸ubbî
,

112 
boﬁ
 
s¸ubAtLó°O√
,

113 
VDOCom∂ëi⁄
 *
∑ª¡
,

114 
VDOA˘i⁄
 *
ˇŒback
,

115 
VDOA˘i⁄
 *
îr‹H™dÀr
);

123 
	`°›S¸ubbög
(
SœbS¸ubbî
 *
s¸ubbî
);

134 
	`íqueueCÀ™SœbWaôî
(
SœbS¸ubbî
 *
s¸ubbî
, 
Waôî
 *
waôî
);

143 
SœbCou¡
 
	$gëS¸ubbîSœbCou¡
(c⁄° 
SœbS¸ubbî
 *
s¸ubbî
)

144 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

151 
	`dumpSœbS¸ubbî
(c⁄° 
SœbS¸ubbî
 *
s¸ubbî
);

	@vdo/base/slabScrubberInternals.h

22 #i‚de‡
SLAB_SCRUBBER_INTERNALS_H


23 
	#SLAB_SCRUBBER_INTERNALS_H


	)

25 
	~"utû/©omic.h
"

27 
	~"¶abS¸ubbî.h
"

29 
	~"rögNode.h
"

31 
	s¶abS¸ubbî
 {

32 
VDOCom∂ëi⁄
 
	mcom∂ëi⁄
;

34 
RögNode
 
	mhighPri‹ôySœbs
;

36 
RögNode
 
	m¶abs
;

38 
WaôQueue
 
	mwaôîs
;

42 
Atomic64
 
	m¶abCou¡
;

45 
boﬁ
 
	misS¸ubbög
;

47 
boﬁ
 
	m°›S¸ubbög
;

49 
boﬁ
 
	mhighPri‹ôyO∆y
;

51 
VDOCom∂ëi⁄
 *
	m¶abRebuûdCom∂ëi⁄
;

53 
RódO∆yModeC⁄ãxt
 *
	mªadO∆yC⁄ãxt
;

	@vdo/base/slabSummary.c

22 
	~"¶abSumm¨y.h
"

24 
	~"mem‹yAŒoc.h
"

26 
	~"c⁄°™ts.h
"

27 
	~"exã¡.h
"

28 
	~"ªadO∆yModeC⁄ãxt.h
"

29 
	~"¶abDïŸ.h
"

30 
	~"¶abSumm¨yI¡î«ls.h
"

31 
	~"thªadC⁄fig.h
"

32 
	~"ty≥s.h
"

37 
BlockCou¡
 
	$gëSœbSumm¨yZ⁄eSize
(
BlockSize
 
blockSize
)

39 
SœbCou¡
 
íåõsPîBlock
 = 
blockSize
 / (
SœbSumm¨yE¡ry
);

40 
BlockCou¡
 
blocksNìded
 = 
MAX_SLABS
 / 
íåõsPîBlock
;

41  
blocksNìded
;

42 
	}
}

45 
BlockCou¡
 
	$gëSœbSumm¨ySize
(
BlockSize
 
blockSize
)

47  
	`gëSœbSumm¨yZ⁄eSize
(
blockSize
Ë* 
MAX_PHYSICAL_ZONES
;

48 
	}
}

70 
__©åibuã__
((
w¨n_unu£d_ªsu…
))

71 
uöt8_t
 
	$compuãFuŒ√ssHöt
(
SœbSumm¨y
 *
summ¨y
, 
BlockCou¡
 
‰ìBlocks
)

73 
	`ASSERT_LOG_ONLY
((
‰ìBlocks
 < (1 << 23)),

76 i‡(
‰ìBlocks
 == 0) {

80 
BlockCou¡
 
höt
 = 
‰ìBlocks
 >> 
summ¨y
->
hötShi·
;

81  ((
höt
 == 0) ? 1 : hint);

82 
	}
}

94 
__©åibuã__
((
w¨n_unu£d_ªsu…
))

95 
BlockCou¡
 
	$gëAµroxim©eFªeBlocks
(
SœbSumm¨y
 *
summ¨y
,

96 
uöt8_t
 
‰ìBlockHöt
)

98  ((
BlockCou¡
Ë
‰ìBlockHöt
Ë<< 
summ¨y
->
hötShi·
;

99 
	}
}

104 
föishUpd©ögSœbSumm¨yBlock
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
);

105 
h™dÀWrôeEº‹
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
);

106 
œunchWrôe
(
SœbSumm¨yBlock
 *
summ¨yBlock
);

120 
	$öôülizeSœbSumm¨yBlock
(
PhysiˇlLayî
 *
œyî
,

121 
SœbSumm¨yZ⁄e
 *
summ¨yZ⁄e
,

122 
ThªadID
 
thªadID
,

123 
SœbSumm¨yE¡ry
 *
íåõs
,

124 
PhysiˇlBlockNumbî
 
pbn
,

125 
SœbSumm¨yBlock
 *
¶abSumm¨yBlock
)

127 
ªsu…
 = 
	`ALLOCATE
(
VDO_BLOCK_SIZE
, , 
__func__
,

128 &
¶abSumm¨yBlock
->
outgoögE¡rõs
);

129 i‡(
ªsu…
 !
VDO_SUCCESS
) {

130  
ªsu…
;

133 
ªsu…
 = 
	`¸óãVIO
(
œyî
, 
VIO_TYPE_SLAB_SUMMARY
, 
VIO_PRIORITY_METADATA
,

134 
¶abSumm¨yBlock
, sœbSumm¨yBlock->
outgoögE¡rõs
,

135 &
¶abSumm¨yBlock
->
vio
);

136 i‡(
ªsu…
 !
VDO_SUCCESS
) {

137  
ªsu…
;

140 
¶abSumm¨yBlock
->
vio
->
com∂ëi⁄
.
ˇŒbackThªadID
 = 
thªadID
;

141 
¶abSumm¨yBlock
->
z⁄e
 = 
summ¨yZ⁄e
;

142 
¶abSumm¨yBlock
->
íåõs
 =Éntries;

143 
¶abSumm¨yBlock
->
pbn
 =Öbn;

144  
VDO_SUCCESS
;

145 
	}
}

160 
	$makeSœbSumm¨yZ⁄e
(
SœbSumm¨y
 *
summ¨y
,

161 
PhysiˇlLayî
 *
œyî
,

162 
Z⁄eCou¡
 
z⁄eNumbî
,

163 
ThªadID
 
thªadID
,

164 
PhysiˇlBlockNumbî
 
pbn
,

165 
SœbSumm¨yE¡ry
 *
íåõs
)

167 
ªsu…
 = 
	`ALLOCATE_EXTENDED
(
SœbSumm¨yZ⁄e
, 
summ¨y
->
blocksPîZ⁄e
,

168 
SœbSumm¨yBlock
, 
__func__
,

169 &
summ¨y
->
z⁄es
[
z⁄eNumbî
]);

170 i‡(
ªsu…
 !
VDO_SUCCESS
) {

171  
ªsu…
;

174 
SœbSumm¨yZ⁄e
 *
summ¨yZ⁄e
 = 
summ¨y
->
z⁄es
[
z⁄eNumbî
];

175 
summ¨yZ⁄e
->
summ¨y
 = summary;

176 
summ¨yZ⁄e
->
z⁄eNumbî
 = zoneNumber;

177 
summ¨yZ⁄e
->
íåõs
 =Éntries;

179 i‡(
œyî
->
¸óãMëad©aVIO
 =
NULL
) {

182  
VDO_SUCCESS
;

186 
BlockCou¡
 
i
 = 0; i < 
summ¨y
->
blocksPîZ⁄e
; i++, 
pbn
++) {

187 
ªsu…
 = 
	`öôülizeSœbSumm¨yBlock
(
œyî
, 
summ¨yZ⁄e
, 
thªadID
, 
íåõs
,

188 
pbn
, &
summ¨yZ⁄e
->
summ¨yBlocks
[
i
]);

189 i‡(
ªsu…
 !
VDO_SUCCESS
) {

190  
ªsu…
;

192 
íåõs
 +
summ¨y
->
íåõsPîBlock
;

195  
VDO_SUCCESS
;

196 
	}
}

199 
	$makeSœbSumm¨y
(
PhysiˇlLayî
 *
œyî
,

200 
P¨tôi⁄
 *
∑πôi⁄
,

201 c⁄° 
ThªadC⁄fig
 *
thªadC⁄fig
,

202 
¶abSizeShi·
,

203 
BlockCou¡
 
maximumFªeBlocksPîSœb
,

204 
RódO∆yModeC⁄ãxt
 *
ªadO∆yC⁄ãxt
,

205 
SœbSumm¨y
 **
¶abSumm¨yPå
)

207 
BlockCou¡
 
blocksPîZ⁄e
 = 
	`gëSœbSumm¨yZ⁄eSize
(
VDO_BLOCK_SIZE
);

208 
SœbCou¡
 
íåõsPîBlock
 = 
MAX_SLABS
 / 
blocksPîZ⁄e
;

209 
ªsu…
 = 
	`ASSERT
((
íåõsPîBlock
 * 
blocksPîZ⁄e
Ë=
MAX_SLABS
,

211 i‡(
ªsu…
 !
VDO_SUCCESS
) {

212  
ªsu…
;

215 i‡(
∑πôi⁄
 =
NULL
) {

217  
VDO_SUCCESS
;

220 
SœbSumm¨y
 *
summ¨y
;

221 
ªsu…
 = 
	`ALLOCATE_EXTENDED
(
SœbSumm¨y
, 
thªadC⁄fig
->
physiˇlZ⁄eCou¡
,

222 
SœbSumm¨yZ⁄e
 *, 
__func__
, &
summ¨y
);

223 i‡(
ªsu…
 !
VDO_SUCCESS
) {

224  
ªsu…
;

227 
summ¨y
->
z⁄eCou¡
 = 
thªadC⁄fig
->
physiˇlZ⁄eCou¡
;

228 
summ¨y
->
ªadO∆yC⁄ãxt
 =ÑeadOnlyContext;

229 
summ¨y
->
hötShi·
 = (
¶abSizeShi·
 > 6) ? (slabSizeShift - 6) : 0;

230 
summ¨y
->
blocksPîZ⁄e
 = blocksPerZone;

231 
summ¨y
->
íåõsPîBlock
 =ÉntriesPerBlock;

232 
	`öôülizeCom∂ëi⁄
(&
summ¨y
->
com∂ëi⁄
, 
SLAB_SUMMARY_COMPLETION
,

233 
œyî
);

235 
size_t
 
tŸÆE¡rõs
 = 
MAX_SLABS
 * 
MAX_PHYSICAL_ZONES
;

236 
size_t
 
íåyByãs
 = 
tŸÆE¡rõs
 * (
SœbSumm¨yE¡ry
);

237 
ªsu…
 = 
œyî
->
	`ÆloˇãIOBuf„r
÷ayî, 
íåyByãs
, "summaryÉntries",

238 (**Ë&
summ¨y
->
íåõs
);

239 i‡(
ªsu…
 !
VDO_SUCCESS
) {

240 
	`‰ìSœbSumm¨y
(&
summ¨y
);

241  
ªsu…
;

245 
uöt8_t
 
höt
 = 
	`compuãFuŒ√ssHöt
(
summ¨y
, 
maximumFªeBlocksPîSœb
);

246 
size_t
 
i
 = 0; i < 
tŸÆE¡rõs
; i++) {

249 
summ¨y
->
íåõs
[
i
] = (
SœbSumm¨yE¡ry
) {

250 .
èûBlockOff£t
 = 0,

251 .
fuŒ√ssHöt
 = 
höt
,

252 .
lﬂdRefCou¡s
 = 
Ál£
,

253 .
isDúty
 = 
Ál£
,

257 
	`£tSœbSumm¨yOrigö
(
summ¨y
, 
∑πôi⁄
);

258 
PhysiˇlBlockNumbî
 
pbn
 = 
summ¨y
->
‹igö
;

259 
Z⁄eCou¡
 
z⁄e
 = 0; z⁄ê< 
summ¨y
->
z⁄eCou¡
; zone++) {

260 
ªsu…
 = 
	`makeSœbSumm¨yZ⁄e
(
summ¨y
, 
œyî
, 
z⁄e
,

261 
	`gëPhysiˇlZ⁄eThªad
(
thªadC⁄fig
, 
z⁄e
),

262 
pbn
, 
summ¨y
->
íåõs
 + (
MAX_SLABS
 * 
z⁄e
));

263 i‡(
ªsu…
 !
VDO_SUCCESS
) {

264 
	`‰ìSœbSumm¨y
(&
summ¨y
);

265  
ªsu…
;

267 
pbn
 +
blocksPîZ⁄e
;

270 *
¶abSumm¨yPå
 = 
summ¨y
;

271  
VDO_SUCCESS
;

272 
	}
}

275 
	$‰ìSœbSumm¨y
(
SœbSumm¨y
 **
¶abSumm¨yPå
)

277 i‡(*
¶abSumm¨yPå
 =
NULL
) {

281 
SœbSumm¨y
 *
summ¨y
 = *
¶abSumm¨yPå
;

282 
Z⁄eCou¡
 
z⁄e
 = 0; z⁄ê< 
summ¨y
->
z⁄eCou¡
; zone++) {

283 
SœbSumm¨yZ⁄e
 *
summ¨yZ⁄e
 = 
summ¨y
->
z⁄es
[
z⁄e
];

284 i‡(
summ¨yZ⁄e
 !
NULL
) {

285 
BlockCou¡
 
i
 = 0; i < 
summ¨y
->
blocksPîZ⁄e
; i++) {

286 
	`‰ìVIO
(&
summ¨yZ⁄e
->
summ¨yBlocks
[
i
].
vio
);

287 
	`FREE
(
summ¨yZ⁄e
->
summ¨yBlocks
[
i
].
outgoögE¡rõs
);

289 
	`FREE
(
summ¨yZ⁄e
);

292 
	`FREE
(
summ¨y
->
íåõs
);

293 
	`FREE
(
summ¨y
);

294 *
¶abSumm¨yPå
 = 
NULL
;

295 
	}
}

298 
SœbSumm¨yZ⁄e
 *
	$gëSumm¨yF‹Z⁄e
(
SœbSumm¨y
 *
summ¨y
, 
Z⁄eCou¡
 
z⁄e
)

300  
summ¨y
->
z⁄es
[
z⁄e
];

301 
	}
}

310 
	$checkF‹SaveCom∂ëe
(
SœbSumm¨yZ⁄e
 *
summ¨yZ⁄e
)

312 i‡(
summ¨yZ⁄e
->
ßveWaôî
 =
NULL
) {

316 
BlockCou¡
 
i
 = 0; i < 
summ¨yZ⁄e
->
summ¨y
->
blocksPîZ⁄e
; i++) {

317 
SœbSumm¨yBlock
 *
block
 = &
summ¨yZ⁄e
->
summ¨yBlocks
[
i
];

318 i‡(
block
->
cuºíéyWrôög
 || block->
√edsWrôög
) {

323 i‡(
summ¨yZ⁄e
->
≥ndögA˘i⁄
 =
SUSPEND_REQUESTED
) {

325 
summ¨yZ⁄e
->
≥ndögA˘i⁄
 = 
NONE_REQUESTED
;

326 
summ¨yZ⁄e
->
su•íded
 = 
åue
;

329 
VDOCom∂ëi⁄
 *
ßveWaôî
 = 
summ¨yZ⁄e
->saveWaiter;

330 
summ¨yZ⁄e
->
ßveWaôî
 = 
NULL
;

331 
	`föishCom∂ëi⁄
(
ßveWaôî
,

332 (
	`isRódO∆y
(
summ¨yZ⁄e
->
summ¨y
->
ªadO∆yC⁄ãxt
)

333 ? 
VDO_READ_ONLY
 : 
VDO_SUCCESS
));

334 
	}
}

344 
	$nŸifyWaôîs
(
SœbSumm¨yZ⁄e
 *
summ¨yZ⁄e
, 
WaôQueue
 *
queue
)

346 
ªsu…
 = (
	`isRódO∆y
(
summ¨yZ⁄e
->
summ¨y
->
ªadO∆yC⁄ãxt
)

347 ? 
VDO_READ_ONLY
 : 
VDO_SUCCESS
);

348 
	`nŸifyAŒWaôîs
(
queue
, 
NULL
, &
ªsu…
);

349 
	}
}

356 
	$föishUpd©ögSœbSumm¨yBlock
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

358 
SœbSumm¨yBlock
 *
block
 = 
com∂ëi⁄
->
∑ª¡
;

359 
	`nŸifyWaôîs
(
block
->
z⁄e
, &block->
cuºítUpd©eWaôîs
);

360 
	`©omicAdd64
(&
block
->
z⁄e
->
summ¨y
->
°©i°ics
.
blocksWrôãn
, 1);

361 
block
->
cuºíéyWrôög
 = 
Ál£
;

362 i‡(
block
->
√edsWrôög
) {

363 
	`œunchWrôe
(
block
);

367 
	`checkF‹SaveCom∂ëe
(
block
->
z⁄e
);

368 
	}
}

376 
	$föishUnwrôabÀBlock
(
SœbSumm¨yBlock
 *
block
)

378 
	`nŸifyWaôîs
(
block
->
z⁄e
, &block->
cuºítUpd©eWaôîs
);

379 
	`nŸifyWaôîs
(
block
->
z⁄e
, &block->
√xtUpd©eWaôîs
);

380 
block
->
cuºíéyWrôög
 = 
Ál£
;

381 
block
->
√edsWrôög
 = 
Ál£
;

382 
	`checkF‹SaveCom∂ëe
(
block
->
z⁄e
);

383 
	}
}

390 
	$h™dÀWrôeEº‹
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

392 
SœbSumm¨yBlock
 *
block
 = 
com∂ëi⁄
->
∑ª¡
;

393 
	`íãrRódO∆yMode
(
block
->
z⁄e
->
summ¨y
->
ªadO∆yC⁄ãxt
, 
com∂ëi⁄
->
ªsu…
);

394 
	`föishUnwrôabÀBlock
(
block
);

395 
	}
}

403 
	$œunchWrôe
(
SœbSumm¨yBlock
 *
block
)

405 i‡(
block
->
z⁄e
->
su•íded
 || block->
cuºíéyWrôög


406 || !
block
->
√edsWrôög
) {

410 
block
->
√edsWrôög
 = 
Ál£
;

412 i‡(
	`isRódO∆y
(
block
->
z⁄e
->
summ¨y
->
ªadO∆yC⁄ãxt
)) {

413 
	`föishUnwrôabÀBlock
(
block
);

417 
	`å™s„rAŒWaôîs
(&
block
->
√xtUpd©eWaôîs
, &block->
cuºítUpd©eWaôîs
);

419 
block
->
cuºíéyWrôög
 = 
åue
;

421 
SœbCou¡
 
íåõsPîBlock
 = 
block
->
z⁄e
->
summ¨y
->entriesPerBlock;

422 
	`mem˝y
(
block
->
outgoögE¡rõs
, block->
íåõs
,

423 (
SœbSumm¨yE¡ry
Ë* 
íåõsPîBlock
);

427 
	`œunchWrôeMëad©aVIOWôhFlush
(
block
->
vio
, block->
pbn
,

428 
föishUpd©ögSœbSumm¨yBlock
,

429 
h™dÀWrôeEº‹
, 
åue
, 
Ál£
);

430 
	}
}

438 
	$œunchWrôeOfAŒBlocks
(
SœbSumm¨yZ⁄e
 *
summ¨yZ⁄e
,

439 
boﬁ
 
f‹˚Wrôe
)

441 
SœbSumm¨y
 *
summ¨y
 = 
summ¨yZ⁄e
->summary;

442 
BlockCou¡
 
blocksPîZ⁄e
 = 
summ¨y
->blocksPerZone;

443 
PhysiˇlBlockNumbî
 
pbn


444 (
summ¨y
->
‹igö
 + (
summ¨yZ⁄e
->
z⁄eNumbî
 * 
blocksPîZ⁄e
));

448 
BlockCou¡
 
i
 = 0; i < 
blocksPîZ⁄e
; i++) {

449 
SœbSumm¨yBlock
 *
block
 = &
summ¨yZ⁄e
->
summ¨yBlocks
[
i
];

451 
block
->
pbn
 =Öbn++;

452 i‡(
f‹˚Wrôe
) {

453 
block
->
√edsWrôög
 = 
åue
;

457 
BlockCou¡
 
i
 = 0; i < 
blocksPîZ⁄e
; i++) {

458 
	`œunchWrôe
(&
summ¨yZ⁄e
->
summ¨yBlocks
[
i
]);

460 
	}
}

463 
	$ßveSœbSumm¨yZ⁄e
(
SœbSumm¨yZ⁄e
 *
summ¨yZ⁄e
, 
VDOCom∂ëi⁄
 *
∑ª¡
)

465 
summ¨yZ⁄e
->
ßveWaôî
 = 
∑ª¡
;

467 
	`œunchWrôeOfAŒBlocks
(
summ¨yZ⁄e
, 
åue
);

468 
	}
}

471 
	$su•ídSœbSumm¨yZ⁄e
(
SœbSumm¨yZ⁄e
 *
summ¨yZ⁄e
,

472 
VDOCom∂ëi⁄
 *
∑ª¡
)

474 
summ¨yZ⁄e
->
≥ndögA˘i⁄
 = 
SUSPEND_REQUESTED
;

475 
	`ßveSœbSumm¨yZ⁄e
(
summ¨yZ⁄e
, 
∑ª¡
);

476 
	}
}

479 
	$ªsumeSœbSumm¨yZ⁄e
(
SœbSumm¨yZ⁄e
 *
summ¨yZ⁄e
,

480 
VDOCom∂ëi⁄
 *
∑ª¡
)

482 
summ¨yZ⁄e
->
su•íded
 = 
Ál£
;

483 
	`œunchWrôeOfAŒBlocks
(
summ¨yZ⁄e
, 
Ál£
);

484 
	`föishCom∂ëi⁄
(
∑ª¡
, 
VDO_SUCCESS
);

485 
	}
}

488 
	$˛o£SœbSumm¨yZ⁄e
(
SœbSumm¨yZ⁄e
 *
summ¨yZ⁄e
, 
VDOCom∂ëi⁄
 *
∑ª¡
)

490 
summ¨yZ⁄e
->
ßveWaôî
 = 
∑ª¡
;

491 
summ¨yZ⁄e
->
≥ndögA˘i⁄
 = 
CLOSE_REQUESTED
;

492 
	`checkF‹SaveCom∂ëe
(
summ¨yZ⁄e
);

493 
	}
}

507 
SœbSumm¨yBlock
 *
	$gëSumm¨yBlockF‹Sœb
(
SœbSumm¨yZ⁄e
 *
summ¨yZ⁄e
,

508 
SœbCou¡
 
¶abNumbî
)

510 
SœbCou¡
 
íåõsPîBlock
 = 
summ¨yZ⁄e
->
summ¨y
->entriesPerBlock;

511  &
summ¨yZ⁄e
->
summ¨yBlocks
[
¶abNumbî
 / 
íåõsPîBlock
];

512 
	}
}

515 
	$upd©eSœbSumm¨yE¡ry
(
SœbSumm¨yZ⁄e
 *
summ¨yZ⁄e
,

516 
Waôî
 *
waôî
,

517 
SœbCou¡
 
¶abNumbî
,

518 
TaûBlockOff£t
 
èûBlockOff£t
,

519 
boﬁ
 
lﬂdRefCou¡s
,

520 
boﬁ
 
isCÀ™
,

521 
BlockCou¡
 
‰ìBlocks
)

523 
ªsu…
;

524 i‡(
	`isRódO∆y
(
summ¨yZ⁄e
->
summ¨y
->
ªadO∆yC⁄ãxt
)) {

525 
ªsu…
 = 
VDO_READ_ONLY
;

526 
waôî
->
	`ˇŒback
(waôî, &
ªsu…
);

530 i‡(
summ¨yZ⁄e
->
≥ndögA˘i⁄
 =
CLOSE_REQUESTED
) {

531 
ªsu…
 = 
VDO_COMPONENT_BUSY
;

532 
waôî
->
	`ˇŒback
(waôî, &
ªsu…
);

536 
SœbSumm¨yBlock
 *
block
 = 
	`gëSumm¨yBlockF‹Sœb
(
summ¨yZ⁄e
, 
¶abNumbî
);

537 
block
->
√edsWrôög
 = 
åue
;

538 
SœbSumm¨yE¡ry
 *
íåy
 = &
summ¨yZ⁄e
->
íåõs
[
¶abNumbî
];

539 
íåy
->
èûBlockOff£t
 =ÅailBlockOffset;

540 
íåy
->
lﬂdRefCou¡s
 = (entry->loadRefCounts ||ÜoadRefCounts);

541 
íåy
->
isDúty
 = !
isCÀ™
;

542 
íåy
->
fuŒ√ssHöt


543 
	`compuãFuŒ√ssHöt
(
summ¨yZ⁄e
->
summ¨y
, 
‰ìBlocks
);

545 
ªsu…
 = 
	`íqueueWaôî
(&
block
->
√xtUpd©eWaôîs
, 
waôî
);

546 i‡(
ªsu…
 !
VDO_SUCCESS
) {

547 
waôî
->
	`ˇŒback
(waôî, &
ªsu…
);

551 
	`œunchWrôe
(
block
);

552 
	}
}

555 
TaûBlockOff£t
 
	$gëSumm¨izedTaûBlockOff£t
(
SœbSumm¨yZ⁄e
 *
summ¨yZ⁄e
,

556 
SœbCou¡
 
¶abNumbî
)

558  
summ¨yZ⁄e
->
íåõs
[
¶abNumbî
].
èûBlockOff£t
;

559 
	}
}

562 
boﬁ
 
	$mu°LﬂdRefCou¡s
(
SœbSumm¨yZ⁄e
 *
summ¨yZ⁄e
, 
SœbCou¡
 
¶abNumbî
)

564  
summ¨yZ⁄e
->
íåõs
[
¶abNumbî
].
lﬂdRefCou¡s
;

565 
	}
}

568 
boﬁ
 
	$gëSumm¨izedCÀ™löess
(
SœbSumm¨yZ⁄e
 *
summ¨yZ⁄e
,

569 
SœbCou¡
 
¶abNumbî
)

571  !
summ¨yZ⁄e
->
íåõs
[
¶abNumbî
].
isDúty
;

572 
	}
}

575 
BlockCou¡
 
	$gëSumm¨izedFªeBlockCou¡
(
SœbSumm¨yZ⁄e
 *
summ¨yZ⁄e
,

576 
SœbCou¡
 
¶abNumbî
)

578 
SœbSumm¨yE¡ry
 *
íåy
 = &
summ¨yZ⁄e
->
íåõs
[
¶abNumbî
];

579  
	`gëAµroxim©eFªeBlocks
(
summ¨yZ⁄e
->
summ¨y
, 
íåy
->
fuŒ√ssHöt
);

580 
	}
}

583 
	$gëSumm¨izedRefCou¡sSèã
(
SœbSumm¨yZ⁄e
 *
summ¨yZ⁄e
,

584 
SœbCou¡
 
¶abNumbî
,

585 
size_t
 *
‰ìBlockHöt
,

586 
boﬁ
 *
isCÀ™
)

588 
SœbSumm¨yE¡ry
 *
íåy
 = &
summ¨yZ⁄e
->
íåõs
[
¶abNumbî
];

589 *
‰ìBlockHöt
 = 
íåy
->
fuŒ√ssHöt
;

590 *
isCÀ™
 = !
íåy
->
isDúty
;

591 
	}
}

594 
	$gëSumm¨izedSœbSètu£s
(
SœbSumm¨yZ⁄e
 *
summ¨yZ⁄e
,

595 
SœbCou¡
 
¶abCou¡
,

596 
SœbSètus
 *
°©u£s
)

598 
SœbCou¡
 
i
 = 0; i < 
¶abCou¡
; i++) {

599 
°©u£s
[
i
] = (
SœbSètus
) {

600 .
¶abNumbî
 = 
i
,

601 .
isCÀ™
 = !
summ¨yZ⁄e
->
íåõs
[
i
].
isDúty
,

602 .
em±öess
 = 
summ¨yZ⁄e
->
íåõs
[
i
].
fuŒ√ssHöt


605 
	}
}

610 
	$£tSœbSumm¨yOrigö
(
SœbSumm¨y
 *
summ¨y
, 
P¨tôi⁄
 *
∑πôi⁄
)

612 
summ¨y
->
‹igö
 = 
	`gëFixedLayoutP¨tôi⁄Off£t
(
∑πôi⁄
);

613 
	}
}

623 
	$föishComböögZ⁄es
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

625 
SœbSumm¨y
 *
summ¨y
 = 
com∂ëi⁄
->
∑ª¡
;

626 
ªsu…
 = 
com∂ëi⁄
->result;

627 
VDOExã¡
 *
exã¡
 = 
	`asVDOExã¡
(
com∂ëi⁄
);

628 
	`‰ìExã¡
(&
exã¡
);

629 
	`föishCom∂ëi⁄
(&
summ¨y
->
com∂ëi⁄
, 
ªsu…
);

630 
	}
}

633 
	$comböeZ⁄es
(
SœbSumm¨y
 *
summ¨y
)

637 
Z⁄eCou¡
 
z⁄e
 = 0;

638 i‡(
summ¨y
->
z⁄esToComböe
 > 1) {

639 
SœbCou¡
 
íåyNumbî
 = 0;É¡ryNumbî < 
MAX_SLABS
;ÉntryNumber++) {

640 i‡(
z⁄e
 != 0) {

641 
	`mem˝y
(
summ¨y
->
íåõs
 + 
íåyNumbî
,

642 
summ¨y
->
íåõs
 + (
z⁄e
 * 
MAX_SLABS
Ë+ 
íåyNumbî
,

643 (
SœbSumm¨yE¡ry
));

645 
z⁄e
++;

646 i‡(
z⁄e
 =
summ¨y
->
z⁄esToComböe
) {

647 
z⁄e
 = 0;

653 
z⁄e
 = 1; z⁄ê< 
MAX_PHYSICAL_ZONES
; zone++) {

654 
	`mem˝y
(
summ¨y
->
íåõs
 + (
z⁄e
 * 
MAX_SLABS
), summary->entries,

655 
MAX_SLABS
 * (
SœbSumm¨yE¡ry
));

657 
	}
}

667 
	$föishLﬂdögSumm¨y
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

669 
SœbSumm¨y
 *
summ¨y
 = 
com∂ëi⁄
->
∑ª¡
;

670 
ªsu…
 = 
com∂ëi⁄
->result;

671 
VDOExã¡
 *
exã¡
 = 
	`asVDOExã¡
(
com∂ëi⁄
);

672 i‡(
ªsu…
 !
VDO_SUCCESS
) {

673 
	`‰ìExã¡
(&
exã¡
);

674 
	`föishCom∂ëi⁄
(&
summ¨y
->
com∂ëi⁄
, 
ªsu…
);

679 
	`comböeZ⁄es
(
summ¨y
);

682 
PhysiˇlBlockNumbî
 
pbn
 = 
summ¨y
->
z⁄es
[0]->
summ¨yBlocks
[0].pbn;

683 
exã¡
->
com∂ëi⁄
.
ˇŒback
 = 
föishComböögZ⁄es
;

684 
	`wrôeMëad©aExã¡
(
exã¡
, 
pbn
);

685 
	}
}

688 
	$lﬂdSœbSumm¨y
(
SœbSumm¨y
 *
summ¨y
,

689 
Z⁄eCou¡
 
z⁄esToComböe
,

690 *
∑ª¡
,

691 
VDOA˘i⁄
 *
ˇŒback
)

693 
	`ª£tCom∂ëi⁄
(&
summ¨y
->
com∂ëi⁄
);

694 
summ¨y
->
com∂ëi⁄
.
∑ª¡
 =Öarent;

695 
summ¨y
->
com∂ëi⁄
.
ˇŒback
 = callback;

696 
summ¨y
->
z⁄esToComböe
 = zonesToCombine;

698 
VDOExã¡
 *
exã¡
;

699 
BlockCou¡
 
blocks
 = 
summ¨y
->
blocksPîZ⁄e
 * 
MAX_PHYSICAL_ZONES
;

700 
ªsu…
 = 
	`¸óãExã¡
(
summ¨y
->
com∂ëi⁄
.
œyî
,

701 
VIO_TYPE_SLAB_SUMMARY
,

702 
VIO_PRIORITY_METADATA
, 
blocks
,

703 (*Ë
summ¨y
->
íåõs
, &
exã¡
);

704 i‡(
ªsu…
 !
VDO_SUCCESS
) {

705 
	`föishCom∂ëi⁄
(&
summ¨y
->
com∂ëi⁄
, 
ªsu…
);

709 
PhysiˇlBlockNumbî
 
pbn
 = 
summ¨y
->
z⁄es
[0]->
summ¨yBlocks
[0].pbn;

710 i‡(
z⁄esToComböe
 == 0) {

711 
	`¥ï¨eCom∂ëi⁄
(&
exã¡
->
com∂ëi⁄
, 
föishComböögZ⁄es
,

712 
föishComböögZ⁄es
, 0, 
summ¨y
);

713 
	`wrôeMëad©aExã¡
(
exã¡
, 
pbn
);

717 
	`¥ï¨eCom∂ëi⁄
(&
exã¡
->
com∂ëi⁄
, 
föishLﬂdögSumm¨y
,

718 
föishLﬂdögSumm¨y
, 0, 
summ¨y
);

719 
	`ªadMëad©aExã¡
(
exã¡
, 
pbn
);

720 
	}
}

723 
SœbSumm¨ySèti°ics
 
	$gëSœbSumm¨ySèti°ics
(c⁄° 
SœbSumm¨y
 *
summ¨y
)

725 c⁄° 
AtomicSœbSumm¨ySèti°ics
 *
©oms
 = &
summ¨y
->
°©i°ics
;

726  (
SœbSumm¨ySèti°ics
) {

727 .
blocksWrôãn
 = 
	`©omicLﬂd64
(&
©oms
->blocksWritten),

729 
	}
}

	@vdo/base/slabSummary.h

22 #i‚de‡
SLAB_SUMMARY_H


23 
	#SLAB_SUMMARY_H


	)

25 
	~"com∂ëi⁄.h
"

26 
	~"fixedLayout.h
"

27 
	~"¶ab.h
"

28 
	~"°©i°ics.h
"

29 
	~"ty≥s.h
"

30 
	~"waôQueue.h
"

58 
uöt8_t
 
	tTaûBlockOff£t
;

64 
	s¶abSètus
 {

65 
SœbCou¡
 
	m¶abNumbî
;

66 
boﬁ
 
	misCÀ™
;

67 
uöt8_t
 
	mem±öess
;

68 } 
	tSœbSètus
;

77 
BlockCou¡
 
	$gëSœbSumm¨ySize
(
BlockSize
 
blockSize
)

78 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

95 
	$makeSœbSumm¨y
(
PhysiˇlLayî
 *
œyî
,

96 
P¨tôi⁄
 *
∑πôi⁄
,

97 c⁄° 
ThªadC⁄fig
 *
thªadC⁄fig
,

98 
¶abSizeShi·
,

99 
BlockCou¡
 
maximumFªeBlocksPîSœb
,

100 
RódO∆yModeC⁄ãxt
 *
ªadO∆yC⁄ãxt
,

101 
SœbSumm¨y
 **
¶abSumm¨yPå
)

102 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

109 
	`‰ìSœbSumm¨y
(
SœbSumm¨y
 **
¶abSumm¨yPå
);

119 
SœbSumm¨yZ⁄e
 *
	$gëSumm¨yF‹Z⁄e
(
SœbSumm¨y
 *
summ¨y
, 
Z⁄eCou¡
 
z⁄e
)

120 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

128 
	`su•ídSœbSumm¨yZ⁄e
(
SœbSumm¨yZ⁄e
 *
summ¨yZ⁄e
,

129 
VDOCom∂ëi⁄
 *
∑ª¡
);

137 
	`ªsumeSœbSumm¨yZ⁄e
(
SœbSumm¨yZ⁄e
 *
summ¨yZ⁄e
,

138 
VDOCom∂ëi⁄
 *
∑ª¡
);

146 
	`ßveSœbSumm¨yZ⁄e
(
SœbSumm¨yZ⁄e
 *
summ¨yZ⁄e
, 
VDOCom∂ëi⁄
 *
∑ª¡
);

154 
	`˛o£SœbSumm¨yZ⁄e
(
SœbSumm¨yZ⁄e
 *
summ¨yZ⁄e
, 
VDOCom∂ëi⁄
 *
∑ª¡
);

168 
	`upd©eSœbSumm¨yE¡ry
(
SœbSumm¨yZ⁄e
 *
summ¨yZ⁄e
,

169 
Waôî
 *
waôî
,

170 
SœbCou¡
 
¶abNumbî
,

171 
TaûBlockOff£t
 
èûBlockOff£t
,

172 
boﬁ
 
lﬂdRefCou¡s
,

173 
boﬁ
 
isCÀ™
,

174 
BlockCou¡
 
‰ìBlocks
);

184 
TaûBlockOff£t
 
	$gëSumm¨izedTaûBlockOff£t
(
SœbSumm¨yZ⁄e
 *
summ¨yZ⁄e
,

185 
SœbCou¡
 
¶abNumbî
)

186 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

196 
boﬁ
 
	$mu°LﬂdRefCou¡s
(
SœbSumm¨yZ⁄e
 *
summ¨yZ⁄e
, 
SœbCou¡
 
¶abNumbî
)

197 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

207 
boﬁ
 
	$gëSumm¨izedCÀ™löess
(
SœbSumm¨yZ⁄e
 *
summ¨yZ⁄e
,

208 
SœbCou¡
 
¶abNumbî
)

209 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

219 
BlockCou¡
 
	$gëSumm¨izedFªeBlockCou¡
(
SœbSumm¨yZ⁄e
 *
summ¨yZ⁄e
,

220 
SœbCou¡
 
¶abNumbî
)

221 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

232 
	`gëSumm¨izedRefCou¡sSèã
(
SœbSumm¨yZ⁄e
 *
summ¨yZ⁄e
,

233 
SœbCou¡
 
¶abNumbî
,

234 
size_t
 *
‰ìBlockHöt
,

235 
boﬁ
 *
isCÀ™
);

244 
	`gëSumm¨izedSœbSètu£s
(
SœbSumm¨yZ⁄e
 *
summ¨yZ⁄e
,

245 
SœbCou¡
 
¶abCou¡
,

246 
SœbSètus
 *
°©u£s
);

254 
	`£tSœbSumm¨yOrigö
(
SœbSumm¨y
 *
summ¨y
, 
P¨tôi⁄
 *
∑πôi⁄
);

268 
	`lﬂdSœbSumm¨y
(
SœbSumm¨y
 *
summ¨y
,

269 
Z⁄eCou¡
 
z⁄esToComböe
,

270 *
∑ª¡
,

271 
VDOA˘i⁄
 *
ˇŒback
);

280 
SœbSumm¨ySèti°ics
 
	$gëSœbSumm¨ySèti°ics
(c⁄° 
SœbSumm¨y
 *
summ¨y
)

281 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

	@vdo/base/slabSummaryInternals.h

22 #i‚de‡
SLAB_SUMMARY_INTERNALS_H


23 
	#SLAB_SUMMARY_INTERNALS_H


	)

25 
	~"utû/©omic.h
"

27 
	~"¶abSumm¨y.h
"

29 
	s¶abSumm¨yE¡ry
 {

31 
TaûBlockOff£t
 
	mèûBlockOff£t
;

33 
	mfuŒ√ssHöt
 : 6;

35 
	mlﬂdRefCou¡s
 : 1;

37 
	misDúty
 : 1;

38 } 
	t__©åibuã__
((
	t∑cked
)Ë
	tSœbSumm¨yE¡ry
;

40 
	s¶abSumm¨yBlock
 {

42 
SœbSumm¨yZ⁄e
 *
	mz⁄e
;

44 
boﬁ
 
	mcuºíéyWrôög
;

46 
boﬁ
 
	m√edsWrôög
;

48 
WaôQueue
 
	mcuºítUpd©eWaôîs
;

50 
WaôQueue
 
	m√xtUpd©eWaôîs
;

52 
PhysiˇlBlockNumbî
 
	mpbn
;

54 
SœbSumm¨yE¡ry
 *
	míåõs
;

56 
VIO
 *
	mvio
;

58 *
	moutgoögE¡rõs
;

59 } 
	tSœbSumm¨yBlock
;

66 
	s©omicSœbSumm¨ySèti°ics
 {

68 
Atomic64
 
	mblocksWrôãn
;

69 } 
	tAtomicSœbSumm¨ySèti°ics
;

76 
	mNONE_REQUESTED
 = 0,

77 
	mCLOSE_REQUESTED
,

78 
	mSUSPEND_REQUESTED
,

79 } 
	tReque°edA˘i⁄
;

81 
	s¶abSumm¨yZ⁄e
 {

83 
SœbSumm¨y
 *
	msumm¨y
;

85 
Z⁄eCou¡
 
	mz⁄eNumbî
;

87 
VDOCom∂ëi⁄
 *
	mßveWaôî
;

89 
Reque°edA˘i⁄
 
	m≥ndögA˘i⁄
;

91 
boﬁ
 
	msu•íded
;

93 
SœbSumm¨yE¡ry
 *
	míåõs
;

95 
SœbSumm¨yBlock
 
	msumm¨yBlocks
[];

98 
	s¶abSumm¨y
 {

100 
VDOCom∂ëi⁄
 
	mcom∂ëi⁄
;

102 
RódO∆yModeC⁄ãxt
 *
	mªadO∆yC⁄ãxt
;

104 
AtomicSœbSumm¨ySèti°ics
 
	m°©i°ics
;

106 
PhysiˇlBlockNumbî
 
	m‹igö
;

108 
	mhötShi·
;

110 
BlockCou¡
 
	mblocksPîZ⁄e
;

112 
SœbCou¡
 
	míåõsPîBlock
;

114 
SœbSumm¨yE¡ry
 *
	míåõs
;

116 
Z⁄eCou¡
 
	mz⁄esToComböe
;

118 
Z⁄eCou¡
 
	mz⁄eCou¡
;

120 
SœbSumm¨yZ⁄e
 *
	mz⁄es
[];

129 
comböeZ⁄es
(
SœbSumm¨y
 *
summ¨y
);

	@vdo/base/statistics.h

20 #i‚de‡
STATISTICS_H


21 
	#STATISTICS_H


	)

23 
	~"hódî.h
"

24 
	~"ty≥s.h
"

27 
	mSTATISTICS_VERSION
 = 24,

32 
uöt64_t
 
	m¶abCou¡
;

34 
uöt64_t
 
	m¶absO≥√d
;

36 
uöt64_t
 
	m¶absRe›íed
;

37 } 
	tBlockAŒoˇt‹Sèti°ics
;

48 
uöt64_t
 
	m°¨ãd
;

50 
uöt64_t
 
	mwrôãn
;

52 
uöt64_t
 
	mcommôãd
;

53 } 
	tCommôSèti°ics
;

58 
uöt64_t
 
	mdiskFuŒ
;

60 
uöt64_t
 
	m¶abJou∫ÆCommôsReque°ed
;

62 
CommôSèti°ics
 
	míåõs
;

64 
CommôSèti°ics
 
	mblocks
;

65 } 
	tRecovîyJou∫ÆSèti°ics
;

70 
uöt64_t
 
	mcom¥es£dFøgmítsWrôãn
;

72 
uöt64_t
 
	mcom¥es£dBlocksWrôãn
;

74 
uöt64_t
 
	mcom¥es£dFøgmítsInPackî
;

75 } 
	tPackîSèti°ics
;

80 
uöt64_t
 
	mdiskFuŒCou¡
;

82 
uöt64_t
 
	mÊushCou¡
;

84 
uöt64_t
 
	mblockedCou¡
;

86 
uöt64_t
 
	mblocksWrôãn
;

88 
uöt64_t
 
	mèûBusyCou¡
;

89 } 
	tSœbJou∫ÆSèti°ics
;

94 
uöt64_t
 
	mblocksWrôãn
;

95 } 
	tSœbSumm¨ySèti°ics
;

100 
uöt64_t
 
	mblocksWrôãn
;

101 } 
	tRefCou¡sSèti°ics
;

106 
uöt32_t
 
	mdútyPages
;

108 
uöt32_t
 
	m˛ónPages
;

110 
uöt32_t
 
	m‰ìPages
;

112 
uöt32_t
 
	mÁûedPages
;

114 
uöt32_t
 
	möcomögPages
;

116 
uöt32_t
 
	moutgoögPages
;

118 
uöt32_t
 
	mˇchePªssuª
;

120 
uöt64_t
 
	mªadCou¡
;

122 
uöt64_t
 
	mwrôeCou¡
;

124 
uöt64_t
 
	mÁûedRóds
;

126 
uöt64_t
 
	mÁûedWrôes
;

128 
uöt64_t
 
	mª˛aimed
;

130 
uöt64_t
 
	mªadOutgoög
;

132 
uöt64_t
 
	mfoundInCache
;

134 
uöt64_t
 
	mdisˇrdRequúed
;

136 
uöt64_t
 
	mwaôF‹Page
;

138 
uöt64_t
 
	m„tchRequúed
;

140 
uöt64_t
 
	m∑gesLﬂded
;

142 
uöt64_t
 
	m∑gesSaved
;

144 
uöt64_t
 
	mÊushCou¡
;

145 } 
	tBlockM≠Sèti°ics
;

150 
uöt64_t
 
	mövÆidAdvi˚PBNCou¡
;

152 
uöt64_t
 
	mövÆidRﬁlovîPBNCou¡
;

154 
uöt64_t
 
	mdedu≥DódlockAvoid™˚Cou¡
;

156 
uöt64_t
 
	mnoS∑˚Eº‹Cou¡
;

158 
uöt64_t
 
	mªadO∆yEº‹Cou¡
;

159 } 
	tEº‹Sèti°ics
;

162 
	svdoSèti°ics
 {

163 
uöt32_t
 
	mvîsi⁄
;

164 
uöt32_t
 
	mªÀa£Vîsi⁄
;

166 
uöt64_t
 
	md©aBlocksU£d
;

168 
uöt64_t
 
	movîhódBlocksU£d
;

170 
uöt64_t
 
	mlogiˇlBlocksU£d
;

172 
BlockCou¡
 
	mphysiˇlBlocks
;

174 
BlockCou¡
 
	mlogiˇlBlocks
;

176 
uöt64_t
 
	mblockM≠CacheSize
;

178 
	mwrôePﬁicy
[15];

180 
uöt64_t
 
	mblockSize
;

182 
uöt64_t
 
	mcom∂ëeRecovîõs
;

184 
uöt64_t
 
	mªadO∆yRecovîõs
;

186 
	mmode
[15];

188 
boﬁ
 
	möRecovîyMode
;

190 
uöt8_t
 
	mªcovîyPî˚¡age
;

192 
PackîSèti°ics
 
	m∑ckî
;

194 
BlockAŒoˇt‹Sèti°ics
 
	mÆloˇt‹
;

196 
RecovîyJou∫ÆSèti°ics
 
	mjou∫Æ
;

198 
SœbJou∫ÆSèti°ics
 
	m¶abJou∫Æ
;

200 
SœbSumm¨ySèti°ics
 
	m¶abSumm¨y
;

202 
RefCou¡sSèti°ics
 
	mªfCou¡s
;

204 
BlockM≠Sèti°ics
 
	mblockM≠
;

206 
Eº‹Sèti°ics
 
	mîr‹s
;

214 
ölöe
 c⁄° *
	$gëVDOSèti°icsProcFûe
() {

216 
	}
}

	@vdo/base/statusCodes.c

22 
	~"°©usCodes.h
"

24 
	~"comm⁄.h
"

25 
	~"îr‹s.h
"

26 
	~"loggî.h
"

27 
	~"≥rmas£π.h
"

28 
	~"thªadOn˚.h
"

30 c⁄° 
îr‹Info
 
	gvdoSètusLi°
[] = {

66 #i‚de‡
__KERNEL__


67 
On˚Sèã
 
	gvdoSètusCodesRegi°îed
 = 
ONCE_STATE_INITIALIZER
;

68 
	g°©usCodeRegi°øti⁄Resu…
;

71 
	$doSètusCodeRegi°øti⁄
()

73 
	`STATIC_ASSERT
((
VDO_STATUS_CODE_LAST
 - 
VDO_STATUS_CODE_BASE
)

74 =
	`COUNT_OF
(
vdoSètusLi°
));

76 
ªsu…
 = 
	`ªgi°îEº‹Block
("VDO Status",

77 
VDO_STATUS_CODE_BASE
,

78 
VDO_STATUS_CODE_BLOCK_END
,

79 
vdoSètusLi°
,

80 (
vdoSètusLi°
));

88 i‡(
ªsu…
 =
UDS_DUPLICATE_NAME
) {

89 
ªsu…
 = 
UDS_SUCCESS
;

92 
°©usCodeRegi°øti⁄Resu…


93 (
ªsu…
 =
UDS_SUCCESS
Ë? 
VDO_SUCCESS
 :Ñesult;

94 
	}
}

98 
	$ªgi°îSètusCodes
()

100 #ifde‡
__KERNEL__


101  
VDO_SUCCESS
;

103 
	`≥rf‹mOn˚
(&
vdoSètusCodesRegi°îed
, 
doSètusCodeRegi°øti⁄
);

104  
°©usCodeRegi°øti⁄Resu…
;

106 
	}
}

	@vdo/base/statusCodes.h

22 #i‚de‡
STATUS_CODES_H


23 
	#STATUS_CODES_H


	)

25 
	~"îr‹s.h
"

28 
	mUDS_BLOCK_SIZE
 = 
UDS_ERROR_CODE_BLOCK_END
 - 
UDS_ERROR_CODE_BASE
,

29 
	mVDO_BLOCK_START
 = 
UDS_ERROR_CODE_BLOCK_END
,

30 
	mVDO_BLOCK_END
 = 
VDO_BLOCK_START
 + 
UDS_BLOCK_SIZE
,

31 
	mPRP_BLOCK_START
 = 
VDO_BLOCK_END
,

32 
	mPRP_BLOCK_END
 = 
PRP_BLOCK_START
 + 
UDS_BLOCK_SIZE
,

38 
	evdoSètusCodes
 {

40 
	mVDO_SUCCESS
 = 0,

42 
	mVDO_STATUS_CODE_BASE
 = 
VDO_BLOCK_START
,

44 
	mVDO_NOT_IMPLEMENTED
 = 
VDO_STATUS_CODE_BASE
,

46 
	mVDO_OUT_OF_RANGE
,

48 
	mVDO_REF_COUNT_INVALID
,

50 
	mVDO_NO_SPACE
,

52 
	mVDO_UNEXPECTED_EOF
,

54 
	mVDO_BAD_CONFIGURATION
,

56 
	mVDO_SOCKET_ERROR
,

58 
	mVDO_BAD_ALIGNMENT
,

60 
	mVDO_COMPONENT_BUSY
,

62 
	mVDO_BAD_PAGE
,

64 
	mVDO_UNSUPPORTED_VERSION
,

66 
	mVDO_INCORRECT_COMPONENT
,

68 
	mVDO_PARAMETER_MISMATCH
,

70 
	mVDO_BLOCK_SIZE_TOO_SMALL
,

72 
	mVDO_UNKNOWN_PARTITION
,

74 
	mVDO_PARTITION_EXISTS
,

76 
	mVDO_NOT_CLEAN
,

78 
	mVDO_INCREMENT_TOO_SMALL
,

80 
	mVDO_CHECKSUM_MISMATCH
,

82 
	mVDO_RECOVERY_JOURNAL_FULL
,

84 
	mVDO_LOCK_ERROR
,

86 
	mVDO_READ_ONLY
,

88 
	mVDO_SHUTTING_DOWN
,

90 
	mVDO_CORRUPT_JOURNAL
,

92 
	mVDO_TOO_MANY_SLABS
,

94 
	mVDO_INVALID_FRAGMENT
,

96 
	mVDO_RETRY_AFTER_REBUILD
,

98 
	mVDO_UNKNOWN_COMMAND
,

100 
	mVDO_COMMAND_ERROR
,

102 
	mVDO_CANNOT_DETERMINE_SIZE
,

104 
	mVDO_BAD_MAPPING
,

106 
	mVDO_READ_CACHE_BUSY
,

108 
	mVDO_BIO_CREATION_FAILED
,

110 
	mVDO_STATUS_CODE_LAST
,

111 
	mVDO_STATUS_CODE_BLOCK_END
 = 
VDO_BLOCK_END


114 c⁄° 
îr‹Info
 
vdoSètusLi°
[];

121 
ªgi°îSètusCodes
();

	@vdo/base/superBlock.c

22 
	~"su≥rBlock.h
"

24 
	~"buf„r.h
"

25 
	~"loggî.h
"

26 
	~"mem‹yAŒoc.h
"

27 
	~"≥rmas£π.h
"

29 
	~"com∂ëi⁄.h
"

30 
	~"c⁄°™ts.h
"

31 
	~"hódî.h
"

32 
	~"ªÀa£Vîsi⁄s.h
"

33 
	~"°©usCodes.h
"

34 
	~"ty≥s.h
"

35 
	~"vio.h
"

37 
	ssu≥rBlock
 {

39 
VDOCom∂ëi⁄
 *
	m∑ª¡
;

41 
VIO
 *
	mvio
;

43 
Buf„r
 *
	mcomp⁄ítBuf„r
;

45 
byã
 *
	mícodedSu≥rBlock
;

47 
Rñó£Vîsi⁄Numbî
 
	mlﬂdedRñó£Vîsi⁄
;

51 
	mSUPER_BLOCK_FIXED_SIZE


52 
ENCODED_HEADER_SIZE
 + (
Rñó£Vîsi⁄Numbî
Ë+ 
CHECKSUM_SIZE
,

53 
	mMAX_COMPONENT_DATA_SIZE
 = 
VDO_SECTOR_SIZE
 - 
SUPER_BLOCK_FIXED_SIZE
,

56 c⁄° 
Hódî
 
	gSUPER_BLOCK_HEADER_12_0
 = {

57 .
id
 = 
SUPER_BLOCK
,

58 .
	gvîsi⁄
 = {

59 .
maj‹Vîsi⁄
 = 12,

60 .
	gmö‹Vîsi⁄
 = 0,

64 .
	gsize
 = 
SUPER_BLOCK_FIXED_SIZE
 - 
ENCODED_HEADER_SIZE
,

67 c⁄° 
Hódî
 *
	gCURRENT_SUPER_BLOCK_HEADER


68 &
SUPER_BLOCK_HEADER_12_0
;

79 
__©åibuã__
((
w¨n_unu£d_ªsu…
))

80 
	$ÆloˇãSu≥rBlock
(
PhysiˇlLayî
 *
œyî
, 
Su≥rBlock
 **
su≥rBlockPå
)

82 
ªsu…
 = 
	`ALLOCATE
(1, 
Su≥rBlock
, 
__func__
, 
su≥rBlockPå
);

83 i‡(
ªsu…
 !
UDS_SUCCESS
) {

84  
ªsu…
;

87 
Su≥rBlock
 *
su≥rBlock
 = *
su≥rBlockPå
;

88 
ªsu…
 = 
	`makeBuf„r
(
MAX_COMPONENT_DATA_SIZE
, &
su≥rBlock
->
comp⁄ítBuf„r
);

89 i‡(
ªsu…
 !
UDS_SUCCESS
) {

90  
ªsu…
;

93 
ªsu…
 = 
œyî
->
	`ÆloˇãIOBuf„r
÷ayî, 
VDO_BLOCK_SIZE
,

95 (**Ë&
su≥rBlock
->
ícodedSu≥rBlock
);

96 i‡(
ªsu…
 !
UDS_SUCCESS
) {

97  
ªsu…
;

100 i‡(
œyî
->
¸óãMëad©aVIO
 =
NULL
) {

101  
VDO_SUCCESS
;

104  
	`¸óãVIO
(
œyî
, 
VIO_TYPE_SUPER_BLOCK
, 
VIO_PRIORITY_METADATA
,

105 
su≥rBlock
, (*Ësu≥rBlock->
ícodedSu≥rBlock
,

106 &
su≥rBlock
->
vio
);

107 
	}
}

110 
	$makeSu≥rBlock
(
PhysiˇlLayî
 *
œyî
, 
Su≥rBlock
 **
su≥rBlockPå
)

112 
Su≥rBlock
 *
su≥rBlock
;

113 
ªsu…
 = 
	`ÆloˇãSu≥rBlock
(
œyî
, &
su≥rBlock
);

114 i‡(
ªsu…
 !
VDO_SUCCESS
) {

115 
	`‰ìSu≥rBlock
(&
su≥rBlock
);

116  
ªsu…
;

119 *
su≥rBlockPå
 = 
su≥rBlock
;

120  
VDO_SUCCESS
;

121 
	}
}

124 
	$‰ìSu≥rBlock
(
Su≥rBlock
 **
su≥rBlockPå
)

126 i‡(*
su≥rBlockPå
 =
NULL
) {

130 
Su≥rBlock
 *
su≥rBlock
 = *
su≥rBlockPå
;

131 
	`‰ìBuf„r
(&
su≥rBlock
->
comp⁄ítBuf„r
);

132 
	`‰ìVIO
(&
su≥rBlock
->
vio
);

133 
	`FREE
(
su≥rBlock
->
ícodedSu≥rBlock
);

134 
	`FREE
(
su≥rBlock
);

135 *
su≥rBlockPå
 = 
NULL
;

136 
	}
}

149 
size_t
 
	$putByãsAt
(
byã
 *
de°ö©i⁄
,

150 c⁄° *
sour˚
,

151 
size_t
 
Àngth
,

152 
size_t
 
off£t
)

154 
	`mem˝y
(
de°ö©i⁄
 + 
off£t
, 
sour˚
, 
Àngth
);

155  
off£t
 + 
Àngth
;

156 
	}
}

166 
__©åibuã__
((
w¨n_unu£d_ªsu…
))

167 
	$ícodeSu≥rBlock
(
PhysiˇlLayî
 *
œyî
, 
Su≥rBlock
 *
su≥rBlock
)

169 
size_t
 
comp⁄ítD©aSize
 = 
	`c⁄ã¡Lígth
(
su≥rBlock
->
comp⁄ítBuf„r
);

170 
Hódî
 
hódî
 = *
CURRENT_SUPER_BLOCK_HEADER
;

171 
hódî
.
size


172 (
Rñó£Vîsi⁄Numbî
Ë+ 
comp⁄ítD©aSize
 + 
CHECKSUM_SIZE
;

175 
size_t
 
off£t
 = 
	`putByãsAt
(
su≥rBlock
->
ícodedSu≥rBlock
, &
hódî
,

176 
ENCODED_HEADER_SIZE
, 0);

179 
Rñó£Vîsi⁄Numbî
 
vîsi⁄
 = 
CURRENT_RELEASE_VERSION_NUMBER
;

180 
off£t
 = 
	`putByãsAt
(
su≥rBlock
->
ícodedSu≥rBlock
, &
vîsi⁄
,

181 (
Rñó£Vîsi⁄Numbî
), 
off£t
);

184 
ªsu…
 = 
	`gëByãsFromBuf„r
(
su≥rBlock
->
comp⁄ítBuf„r
,

185 
comp⁄ítD©aSize
,

186 
su≥rBlock
->
ícodedSu≥rBlock
 + 
off£t
);

187 i‡(
ªsu…
 !
VDO_SUCCESS
) {

188  
ªsu…
;

191 
off£t
 +
comp⁄ítD©aSize
;

194 
CRC32Checksum
 
checksum
 = 
œyî
->
	`upd©eCRC32
(
INITIAL_CHECKSUM
,

195 
su≥rBlock
->
ícodedSu≥rBlock
,

196 
off£t
);

197 
	`putByãsAt
(
su≥rBlock
->
ícodedSu≥rBlock
, &
checksum
,

198 (
CRC32Checksum
), 
off£t
);

199  
VDO_SUCCESS
;

200 
	}
}

203 
	$ßveSu≥rBlock
(
PhysiˇlLayî
 *
œyî
, 
Su≥rBlock
 *
su≥rBlock
)

205 
ªsu…
 = 
	`ícodeSu≥rBlock
(
œyî
, 
su≥rBlock
);

206 i‡(
ªsu…
 !
VDO_SUCCESS
) {

207  
ªsu…
;

210  
œyî
->
	`wrôî
÷ayî,Üayî->
	`gëD©aRegi⁄Off£t
(layer), 1,

211 (*Ë
su≥rBlock
->
ícodedSu≥rBlock
, 
NULL
);

212 
	}
}

220 
	$föishSu≥rBlockP¨ít
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

222 
Su≥rBlock
 *
su≥rBlock
 = 
com∂ëi⁄
->
∑ª¡
;

223 
VDOCom∂ëi⁄
 *
∑ª¡
 = 
su≥rBlock
->parent;

224 
su≥rBlock
->
∑ª¡
 = 
NULL
;

225 
	`föishCom∂ëi⁄
(
∑ª¡
, 
com∂ëi⁄
->
ªsu…
);

226 
	}
}

229 
	$ßveSu≥rBlockAsync
(
Su≥rBlock
 *
su≥rBlock
, 
VDOCom∂ëi⁄
 *
∑ª¡
)

231 i‡(
su≥rBlock
->
∑ª¡
 !
NULL
) {

232 
	`föishCom∂ëi⁄
(
∑ª¡
, 
VDO_COMPONENT_BUSY
);

236 
PhysiˇlLayî
 *
œyî
 = 
∑ª¡
->layer;

237 
ªsu…
 = 
	`ícodeSu≥rBlock
(
œyî
, 
su≥rBlock
);

238 i‡(
ªsu…
 !
VDO_SUCCESS
) {

239 
	`föishCom∂ëi⁄
(
∑ª¡
, 
ªsu…
);

243 
su≥rBlock
->
∑ª¡
 =Öarent;

244 
su≥rBlock
->
vio
->
com∂ëi⁄
.
ˇŒbackThªadID
 = 
∑ª¡
->callbackThreadID;

245 
	`œunchWrôeMëad©aVIOWôhFlush
(
su≥rBlock
->
vio
,

246 
œyî
->
	`gëD©aRegi⁄Off£t
(layer),

247 
föishSu≥rBlockP¨ít
,

248 
föishSu≥rBlockP¨ít
, 
åue
,Årue);

249 
	}
}

262 
size_t
 
	$gëByãsFrom
(*
de°ö©i⁄
,

263 c⁄° 
byã
 *
sour˚
,

264 
size_t
 
Àngth
,

265 
size_t
 
off£t
)

267 
	`mem˝y
(
de°ö©i⁄
, 
sour˚
 + 
off£t
, 
Àngth
);

268  
off£t
 + 
Àngth
;

269 
	}
}

279 
__©åibuã__
((
w¨n_unu£d_ªsu…
))

280 
	$decodeSu≥rBlock
(
PhysiˇlLayî
 *
œyî
, 
Su≥rBlock
 *
su≥rBlock
)

282 
Hódî
 
hódî
;

283 
size_t
 
off£t
 = 
	`gëByãsFrom
(&
hódî
, 
su≥rBlock
->
ícodedSu≥rBlock
,

284 
ENCODED_HEADER_SIZE
, 0);

286 
ªsu…
 = 
	`vÆid©eHódî
(
CURRENT_SUPER_BLOCK_HEADER
, &
hódî
,

287 
Ál£
, 
__func__
);

288 i‡(
ªsu…
 !
VDO_SUCCESS
) {

289  
ªsu…
;

294 i‡(
VDO_BLOCK_SIZE
 < (
hódî
.
size
 + 
ENCODED_HEADER_SIZE
)) {

295  
VDO_BLOCK_SIZE_TOO_SMALL
;

300 
off£t
 = 
	`gëByãsFrom
(&
su≥rBlock
->
lﬂdedRñó£Vîsi⁄
,

301 
su≥rBlock
->
ícodedSu≥rBlock
,

302 (
Rñó£Vîsi⁄Numbî
), 
off£t
);

304 
size_t
 
comp⁄ítD©aSize


305 
hódî
.
size
 - (
SUPER_BLOCK_FIXED_SIZE
 - 
ENCODED_HEADER_SIZE
);

306 
ªsu…
 = 
	`putByãs
(
su≥rBlock
->
comp⁄ítBuf„r
, 
comp⁄ítD©aSize
,

307 
su≥rBlock
->
ícodedSu≥rBlock
 + 
off£t
);

308 i‡(
ªsu…
 !
VDO_SUCCESS
) {

309  
ªsu…
;

311 
off£t
 +
comp⁄ítD©aSize
;

313 
CRC32Checksum
 
checksum
 = 
œyî
->
	`upd©eCRC32
(
INITIAL_CHECKSUM
,

314 
su≥rBlock
->
ícodedSu≥rBlock
,

315 
off£t
);

316 
CRC32Checksum
 
ßvedChecksum
;

317 
	`gëByãsFrom
(&
ßvedChecksum
, 
su≥rBlock
->
ícodedSu≥rBlock
,

318 (
CRC32Checksum
), 
off£t
);

319 i‡(
checksum
 !
ßvedChecksum
) {

320 
ªsu…
 = 
	`skùF‹w¨d
(
su≥rBlock
->
comp⁄ítBuf„r
,

321 
	`c⁄ã¡Lígth
(
su≥rBlock
->
comp⁄ítBuf„r
));

322 i‡(
ªsu…
 !
UDS_SUCCESS
) {

323 
	`logEº‹WôhSåögEº‹
(
ªsu…
, "Impossible bufferÉrror");

325  
VDO_CHECKSUM_MISMATCH
;

328  
VDO_SUCCESS
;

329 
	}
}

332 
	$lﬂdSu≥rBlock
(
PhysiˇlLayî
 *
œyî
, 
Su≥rBlock
 **
su≥rBlockPå
)

334 
Su≥rBlock
 *
su≥rBlock
 = 
NULL
;

335 
ªsu…
 = 
	`ÆloˇãSu≥rBlock
(
œyî
, &
su≥rBlock
);

336 i‡(
ªsu…
 !
VDO_SUCCESS
) {

337 
	`‰ìSu≥rBlock
(&
su≥rBlock
);

338  
ªsu…
;

341 
ªsu…
 = 
œyî
->
	`ªadî
÷ayî,Üayî->
	`gëD©aRegi⁄Off£t
(layer), 1,

342 (*Ë
su≥rBlock
->
ícodedSu≥rBlock
, 
NULL
);

343 i‡(
ªsu…
 !
VDO_SUCCESS
) {

344 
	`‰ìSu≥rBlock
(&
su≥rBlock
);

345  
ªsu…
;

348 
ªsu…
 = 
	`decodeSu≥rBlock
(
œyî
, 
su≥rBlock
);

349 i‡(
ªsu…
 !
VDO_SUCCESS
) {

350 
	`‰ìSu≥rBlock
(&
su≥rBlock
);

351  
ªsu…
;

354 *
su≥rBlockPå
 = 
su≥rBlock
;

355  
ªsu…
;

356 
	}
}

364 
	$föishRódögSu≥rBlock
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

366 
Su≥rBlock
 *
su≥rBlock
 = 
com∂ëi⁄
->
∑ª¡
;

367 
VDOCom∂ëi⁄
 *
∑ª¡
 = 
su≥rBlock
->parent;

368 
su≥rBlock
->
∑ª¡
 = 
NULL
;

369 
	`föishCom∂ëi⁄
(
∑ª¡
, 
	`decodeSu≥rBlock
(
com∂ëi⁄
->
œyî
, 
su≥rBlock
));

370 
	}
}

373 
	$lﬂdSu≥rBlockAsync
(
VDOCom∂ëi⁄
 *
∑ª¡
, 
Su≥rBlock
 **
su≥rBlockPå
)

375 
PhysiˇlLayî
 *
œyî
 = 
∑ª¡
->layer;

376 
Su≥rBlock
 *
su≥rBlock
 = 
NULL
;

377 
ªsu…
 = 
	`ÆloˇãSu≥rBlock
(
œyî
, &
su≥rBlock
);

378 i‡(
ªsu…
 !
VDO_SUCCESS
) {

379 
	`‰ìSu≥rBlock
(&
su≥rBlock
);

380 
	`föishCom∂ëi⁄
(
∑ª¡
, 
ªsu…
);

384 *
su≥rBlockPå
 = 
su≥rBlock
;

386 
su≥rBlock
->
∑ª¡
 =Öarent;

387 
su≥rBlock
->
vio
->
com∂ëi⁄
.
ˇŒbackThªadID
 = 
∑ª¡
->callbackThreadID;

388 
	`œunchRódMëad©aVIO
(
su≥rBlock
->
vio
, 
œyî
->
	`gëD©aRegi⁄Off£t
(layer),

389 
föishRódögSu≥rBlock
, 
föishSu≥rBlockP¨ít
);

390 
	}
}

393 
Buf„r
 *
	$gëComp⁄ítBuf„r
(
Su≥rBlock
 *
su≥rBlock
)

395  
su≥rBlock
->
comp⁄ítBuf„r
;

396 
	}
}

399 
Rñó£Vîsi⁄Numbî
 
	$gëLﬂdedRñó£Vîsi⁄
(c⁄° 
Su≥rBlock
 *
su≥rBlock
)

401  
su≥rBlock
->
lﬂdedRñó£Vîsi⁄
;

402 
	}
}

405 
size_t
 
	$gëFixedSu≥rBlockSize
()

407  
SUPER_BLOCK_FIXED_SIZE
;

408 
	}
}

	@vdo/base/superBlock.h

22 #i‚de‡
SUPER_BLOCK_H


23 
	#SUPER_BLOCK_H


	)

25 
	~"buf„r.h
"

27 
	~"com∂ëi⁄.h
"

28 
	~"ty≥s.h
"

30 
su≥rBlock
 
	tSu≥rBlock
;

39 
uöt32_t
 
	tRñó£Vîsi⁄Numbî
;

49 
	$makeSu≥rBlock
(
PhysiˇlLayî
 *
œyî
, 
Su≥rBlock
 **
su≥rBlockPå
)

50 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

57 
	`‰ìSu≥rBlock
(
Su≥rBlock
 **
su≥rBlockPå
);

67 
	$ßveSu≥rBlock
(
PhysiˇlLayî
 *
œyî
, 
Su≥rBlock
 *
su≥rBlock
)

68 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

76 
	`ßveSu≥rBlockAsync
(
Su≥rBlock
 *
su≥rBlock
, 
VDOCom∂ëi⁄
 *
∑ª¡
);

86 
	$lﬂdSu≥rBlock
(
PhysiˇlLayî
 *
œyî
, 
Su≥rBlock
 **
su≥rBlockPå
)

87 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

98 
	`lﬂdSu≥rBlockAsync
(
VDOCom∂ëi⁄
 *
∑ª¡
, 
Su≥rBlock
 **
su≥rBlockPå
);

107 
Buf„r
 *
	$gëComp⁄ítBuf„r
(
Su≥rBlock
 *
su≥rBlock
)

108 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

118 
Rñó£Vîsi⁄Numbî
 
	$gëLﬂdedRñó£Vîsi⁄
(c⁄° 
Su≥rBlock
 *
su≥rBlock
)

119 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

127 
size_t
 
	$gëFixedSu≥rBlockSize
()

128 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

	@vdo/base/threadConfig.c

22 
	~"thªadC⁄fig.h
"

24 
	~"loggî.h
"

25 
	~"mem‹yAŒoc.h
"

27 
	~"c⁄°™ts.h
"

28 
	~"ty≥s.h
"

31 
	$ÆloˇãThªadC⁄fig
(
Z⁄eCou¡
 
logiˇlZ⁄eCou¡
,

32 
Z⁄eCou¡
 
physiˇlZ⁄eCou¡
,

33 
Z⁄eCou¡
 
hashZ⁄eCou¡
,

34 
Z⁄eCou¡
 
ba£ThªadCou¡
,

35 
ThªadC⁄fig
 **
c⁄figPå
)

37 
ThªadC⁄fig
 *
c⁄fig
;

38 
ªsu…
 = 
	`ALLOCATE
(1, 
ThªadC⁄fig
, "thªad c⁄fig", &
c⁄fig
);

39 i‡(
ªsu…
 !
VDO_SUCCESS
) {

40  
ªsu…
;

43 
ªsu…
 = 
	`ALLOCATE
(
logiˇlZ⁄eCou¡
, 
ThªadID
, "logicalÅhreadárray",

44 &
c⁄fig
->
logiˇlThªads
);

45 i‡(
ªsu…
 !
VDO_SUCCESS
) {

46 
	`‰ìThªadC⁄fig
(&
c⁄fig
);

47  
ªsu…
;

50 
ªsu…
 = 
	`ALLOCATE
(
physiˇlZ⁄eCou¡
, 
ThªadID
, "physicalÅhreadárray",

51 &
c⁄fig
->
physiˇlThªads
);

52 i‡(
ªsu…
 !
VDO_SUCCESS
) {

53 
	`‰ìThªadC⁄fig
(&
c⁄fig
);

54  
ªsu…
;

57 
ªsu…
 = 
	`ALLOCATE
(
hashZ⁄eCou¡
, 
ThªadID
, "hashÅhreadárray",

58 &
c⁄fig
->
hashZ⁄eThªads
);

59 i‡(
ªsu…
 !
VDO_SUCCESS
) {

60 
	`‰ìThªadC⁄fig
(&
c⁄fig
);

61  
ªsu…
;

64 
c⁄fig
->
logiˇlZ⁄eCou¡
 =ÜogicalZoneCount;

65 
c⁄fig
->
physiˇlZ⁄eCou¡
 =ÖhysicalZoneCount;

66 
c⁄fig
->
hashZ⁄eCou¡
 = hashZoneCount;

67 
c⁄fig
->
ba£ThªadCou¡
 = baseThreadCount;

69 *
c⁄figPå
 = 
c⁄fig
;

70  
VDO_SUCCESS
;

71 
	}
}

74 
	$assignThªadIDs
(
ThªadID
 
thªadIDs
[],

75 
Z⁄eCou¡
 
cou¡
,

76 
ThªadID
 *
idPå
)

78 
Z⁄eCou¡
 
z⁄e
 = 0; z⁄ê< 
cou¡
; zone++) {

79 
thªadIDs
[
z⁄e
] = (*
idPå
)++;

81 
	}
}

84 
	$makeThªadC⁄fig
(
Z⁄eCou¡
 
logiˇlZ⁄eCou¡
,

85 
Z⁄eCou¡
 
physiˇlZ⁄eCou¡
,

86 
Z⁄eCou¡
 
hashZ⁄eCou¡
,

87 
ThªadC⁄fig
 **
c⁄figPå
)

89 i‡((
logiˇlZ⁄eCou¡
 == 0)

90 && (
physiˇlZ⁄eCou¡
 == 0)

91 && (
hashZ⁄eCou¡
 == 0)) {

92  
	`makeO√ThªadC⁄fig
(
c⁄figPå
);

95 i‡(
physiˇlZ⁄eCou¡
 > 
MAX_PHYSICAL_ZONES
) {

96  
	`logEº‹WôhSåögEº‹
(
VDO_BAD_CONFIGURATION
,

99 
physiˇlZ⁄eCou¡
, 
MAX_PHYSICAL_ZONES
);

102 
ThªadC⁄fig
 *
c⁄fig
;

103 
ThªadCou¡
 
tŸÆ
 = 
logiˇlZ⁄eCou¡
 + 
physiˇlZ⁄eCou¡
 + 
hashZ⁄eCou¡
 + 2;

104 
ªsu…
 = 
	`ÆloˇãThªadC⁄fig
(
logiˇlZ⁄eCou¡
, 
physiˇlZ⁄eCou¡
,

105 
hashZ⁄eCou¡
, 
tŸÆ
, &
c⁄fig
);

106 i‡(
ªsu…
 !
VDO_SUCCESS
) {

107  
ªsu…
;

110 
ThªadID
 
id
 = 0;

111 
c⁄fig
->
admöThªad
 = 
id
;

112 
c⁄fig
->
jou∫ÆThªad
 = 
id
++;

113 
c⁄fig
->
∑ckîThªad
 = 
id
++;

114 
	`assignThªadIDs
(
c⁄fig
->
logiˇlThªads
, 
logiˇlZ⁄eCou¡
, &
id
);

115 
	`assignThªadIDs
(
c⁄fig
->
physiˇlThªads
, 
physiˇlZ⁄eCou¡
, &
id
);

116 
	`assignThªadIDs
(
c⁄fig
->
hashZ⁄eThªads
, 
hashZ⁄eCou¡
, &
id
);

118 
	`ASSERT_LOG_ONLY
(
id
 =
tŸÆ
, "correctÇumber ofÅhread IDsássigned");

120 *
c⁄figPå
 = 
c⁄fig
;

121  
VDO_SUCCESS
;

122 
	}
}

125 
	$makeZîoThªadC⁄fig
(
ThªadC⁄fig
 **
c⁄figPå
)

127 
ThªadC⁄fig
 *
c⁄fig
;

128 
ªsu…
 = 
	`ALLOCATE
(1, 
ThªadC⁄fig
, 
__func__
, &
c⁄fig
);

129 i‡(
ªsu…
 !
VDO_SUCCESS
) {

130  
ªsu…
;

133 
c⁄fig
->
logiˇlZ⁄eCou¡
 = 0;

134 
c⁄fig
->
physiˇlZ⁄eCou¡
 = 0;

135 
c⁄fig
->
hashZ⁄eCou¡
 = 0;

136 
c⁄fig
->
ba£ThªadCou¡
 = 0;

137 *
c⁄figPå
 = 
c⁄fig
;

138  
VDO_SUCCESS
;

139 
	}
}

142 
	$makeO√ThªadC⁄fig
(
ThªadC⁄fig
 **
c⁄figPå
)

144 
ThªadC⁄fig
 *
c⁄fig
;

145 
ªsu…
 = 
	`ÆloˇãThªadC⁄fig
(1, 1, 1, 1, &
c⁄fig
);

146 i‡(
ªsu…
 !
VDO_SUCCESS
) {

147  
ªsu…
;

150 
c⁄fig
->
logiˇlThªads
[0] = 0;

151 
c⁄fig
->
physiˇlThªads
[0] = 0;

152 
c⁄fig
->
hashZ⁄eThªads
[0] = 0;

153 *
c⁄figPå
 = 
c⁄fig
;

154  
VDO_SUCCESS
;

155 
	}
}

158 
	$c›yThªadC⁄fig
(c⁄° 
ThªadC⁄fig
 *
ﬁdC⁄fig
, ThªadC⁄fig **
c⁄figPå
)

160 
ThªadC⁄fig
 *
c⁄fig
;

161 
ªsu…
 = 
	`ÆloˇãThªadC⁄fig
(
ﬁdC⁄fig
->
logiˇlZ⁄eCou¡
,

162 
ﬁdC⁄fig
->
physiˇlZ⁄eCou¡
,

163 
ﬁdC⁄fig
->
hashZ⁄eCou¡
,

164 
ﬁdC⁄fig
->
ba£ThªadCou¡
,

165 &
c⁄fig
);

166 i‡(
ªsu…
 !
VDO_SUCCESS
) {

167  
ªsu…
;

170 
c⁄fig
->
admöThªad
 = 
ﬁdC⁄fig
->adminThread;

171 
c⁄fig
->
jou∫ÆThªad
 = 
ﬁdC⁄fig
->journalThread;

172 
c⁄fig
->
∑ckîThªad
 = 
ﬁdC⁄fig
->packerThread;

173 
Z⁄eCou¡
 
i
 = 0; i < 
c⁄fig
->
logiˇlZ⁄eCou¡
; i++) {

174 
c⁄fig
->
logiˇlThªads
[
i
] = 
ﬁdC⁄fig
->logicalThreads[i];

176 
Z⁄eCou¡
 
i
 = 0; i < 
c⁄fig
->
physiˇlZ⁄eCou¡
; i++) {

177 
c⁄fig
->
physiˇlThªads
[
i
] = 
ﬁdC⁄fig
->physicalThreads[i];

179 
Z⁄eCou¡
 
i
 = 0; i < 
c⁄fig
->
hashZ⁄eCou¡
; i++) {

180 
c⁄fig
->
hashZ⁄eThªads
[
i
] = 
ﬁdC⁄fig
->hashZoneThreads[i];

183 *
c⁄figPå
 = 
c⁄fig
;

184  
VDO_SUCCESS
;

185 
	}
}

188 
	$‰ìThªadC⁄fig
(
ThªadC⁄fig
 **
c⁄figPå
)

190 i‡(*
c⁄figPå
 =
NULL
) {

194 
ThªadC⁄fig
 *
c⁄fig
 = *
c⁄figPå
;

195 *
c⁄figPå
 = 
NULL
;

197 
	`FREE
(
c⁄fig
->
logiˇlThªads
);

198 
	`FREE
(
c⁄fig
->
physiˇlThªads
);

199 
	`FREE
(
c⁄fig
->
hashZ⁄eThªads
);

200 
	`FREE
(
c⁄fig
);

201 
	}
}

204 
boﬁ
 
	$gëZ⁄eThªadName
(c⁄° 
ThªadID
 
thªadIDs
[],

205 
Z⁄eCou¡
 
cou¡
,

206 
ThªadID
 
id
,

207 c⁄° *
¥efix
,

208 *
buf„r
,

209 
size_t
 
buf„rLígth
)

211 i‡(
id
 >
thªadIDs
[0]) {

212 
ThªadID
 
ödex
 = 
id
 - 
thªadIDs
[0];

213 i‡(
ödex
 < 
cou¡
) {

214 
	`¢¥ötf
(
buf„r
, 
buf„rLígth
, "%s%d", 
¥efix
, 
ödex
);

215  
åue
;

218  
Ál£
;

219 
	}
}

222 
	$gëVDOThªadName
(c⁄° 
ThªadC⁄fig
 *
thªadC⁄fig
,

223 
ThªadID
 
thªadID
,

224 *
buf„r
,

225 
size_t
 
buf„rLígth
)

227 i‡(
thªadC⁄fig
->
ba£ThªadCou¡
 == 1) {

229 
	`¢¥ötf
(
buf„r
, 
buf„rLígth
, "reqQ");

232 i‡(
thªadID
 =
thªadC⁄fig
->
jou∫ÆThªad
) {

233 
	`¢¥ötf
(
buf„r
, 
buf„rLígth
, "journalQ");

235 } i‡(
thªadID
 =
thªadC⁄fig
->
admöThªad
) {

237 
	`¢¥ötf
(
buf„r
, 
buf„rLígth
, "adminQ");

239 } i‡(
thªadID
 =
thªadC⁄fig
->
∑ckîThªad
) {

240 
	`¢¥ötf
(
buf„r
, 
buf„rLígth
, "packerQ");

243 i‡(
	`gëZ⁄eThªadName
(
thªadC⁄fig
->
logiˇlThªads
,

244 
thªadC⁄fig
->
logiˇlZ⁄eCou¡
,

245 
thªadID
, "logQ", 
buf„r
, 
buf„rLígth
)) {

248 i‡(
	`gëZ⁄eThªadName
(
thªadC⁄fig
->
physiˇlThªads
,

249 
thªadC⁄fig
->
physiˇlZ⁄eCou¡
,

250 
thªadID
, "physQ", 
buf„r
, 
buf„rLígth
)) {

253 i‡(
	`gëZ⁄eThªadName
(
thªadC⁄fig
->
hashZ⁄eThªads
,

254 
thªadC⁄fig
->
hashZ⁄eCou¡
,

255 
thªadID
, "hashQ", 
buf„r
, 
buf„rLígth
)) {

260 
	`¢¥ötf
(
buf„r
, 
buf„rLígth
, "ªqQ%d", 
thªadID
);

261 
	}
}

	@vdo/base/threadConfig.h

22 #i‚de‡
THREAD_CONFIG_H


23 
	#THREAD_CONFIG_H


	)

25 
	~"≥rmas£π.h
"

27 
	~"ty≥s.h
"

29 
	sthªadC⁄fig
 {

30 
Z⁄eCou¡
 
	mlogiˇlZ⁄eCou¡
;

31 
Z⁄eCou¡
 
	mphysiˇlZ⁄eCou¡
;

32 
Z⁄eCou¡
 
	mhashZ⁄eCou¡
;

33 
ThªadCou¡
 
	mba£ThªadCou¡
;

34 
ThªadID
 
	madmöThªad
;

35 
ThªadID
 
	mjou∫ÆThªad
;

36 
ThªadID
 
	m∑ckîThªad
;

37 
ThªadID
 *
	mlogiˇlThªads
;

38 
ThªadID
 *
	mphysiˇlThªads
;

39 
ThªadID
 *
	mhashZ⁄eThªads
;

55 
	$makeThªadC⁄fig
(
Z⁄eCou¡
 
logiˇlZ⁄eCou¡
,

56 
Z⁄eCou¡
 
physiˇlZ⁄eCou¡
,

57 
Z⁄eCou¡
 
hashZ⁄eCou¡
,

58 
ThªadC⁄fig
 **
c⁄figPå
)

59 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

70 
	`makeZîoThªadC⁄fig
(
ThªadC⁄fig
 **
c⁄figPå
);

79 
	$makeO√ThªadC⁄fig
(
ThªadC⁄fig
 **
c⁄figPå
)

80 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

90 
	$c›yThªadC⁄fig
(c⁄° 
ThªadC⁄fig
 *
ﬁdC⁄fig
, ThªadC⁄fig **
c⁄figPå
)

91 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

98 
	`‰ìThªadC⁄fig
(
ThªadC⁄fig
 **
c⁄figPå
);

108 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
))

109 
ölöe
 
ThªadID
 
	$gëLogiˇlZ⁄eThªad
(c⁄° 
ThªadC⁄fig
 *
thªadC⁄fig
,

110 
Z⁄eCou¡
 
logiˇlZ⁄e
)

112 
	`ASSERT_LOG_ONLY
((
logiˇlZ⁄e
 <
thªadC⁄fig
->
logiˇlZ⁄eCou¡
),

114  
thªadC⁄fig
->
logiˇlThªads
[
logiˇlZ⁄e
];

115 
	}
}

125 
__©åibuã__
((
w¨n_unu£d_ªsu…
))

126 
ölöe
 
ThªadID
 
	$gëPhysiˇlZ⁄eThªad
(c⁄° 
ThªadC⁄fig
 *
thªadC⁄fig
,

127 
Z⁄eCou¡
 
physiˇlZ⁄e
)

129 
	`ASSERT_LOG_ONLY
((
physiˇlZ⁄e
 <
thªadC⁄fig
->
physiˇlZ⁄eCou¡
),

131  
thªadC⁄fig
->
physiˇlThªads
[
physiˇlZ⁄e
];

132 
	}
}

142 
__©åibuã__
((
w¨n_unu£d_ªsu…
))

143 
ölöe
 
ThªadID
 
	$gëHashZ⁄eThªad
(c⁄° 
ThªadC⁄fig
 *
thªadC⁄fig
,

144 
Z⁄eCou¡
 
hashZ⁄e
)

146 
	`ASSERT_LOG_ONLY
((
hashZ⁄e
 <
thªadC⁄fig
->
hashZ⁄eCou¡
),

148  
thªadC⁄fig
->
hashZ⁄eThªads
[
hashZ⁄e
];

149 
	}
}

158 
__©åibuã__
((
w¨n_unu£d_ªsu…
))

159 
ölöe
 
ThªadID
 
	$gëJou∫ÆZ⁄eThªad
(c⁄° 
ThªadC⁄fig
 *
thªadC⁄fig
)

161  
thªadC⁄fig
->
jou∫ÆThªad
;

162 
	}
}

171 
__©åibuã__
((
w¨n_unu£d_ªsu…
))

172 
ölöe
 
ThªadID
 
	$gëPackîZ⁄eThªad
(c⁄° 
ThªadC⁄fig
 *
thªadC⁄fig
)

174  
thªadC⁄fig
->
∑ckîThªad
;

175 
	}
}

184 
__©åibuã__
((
w¨n_unu£d_ªsu…
))

185 
ölöe
 
ThªadID
 
	$gëAdmöThªad
(c⁄° 
ThªadC⁄fig
 *
thªadC⁄fig
)

187  
thªadC⁄fig
->
admöThªad
;

188 
	}
}

201 
gëVDOThªadName
(c⁄° 
ThªadC⁄fig
 *
thªadC⁄fig
,

202 
ThªadID
 
thªadID
,

203 *
buf„r
,

204 
size_t
 
buf„rLígth
);

	@vdo/base/threadData.c

22 
	~"thªadD©a.h
"

24 
	~"loggî.h
"

25 
	~"mem‹yAŒoc.h
"

26 
	~"≥rmas£π.h
"

28 
	~"blockAŒoˇt‹.h
"

29 
	~"ªcovîyJou∫Æ.h
"

30 
	~"¶abDïŸ.h
"

31 
	~"vdoI¡î«l.h
"

34 
	mALLOCATIONS_PER_ZONE
 = 128,

38 
VDOCom∂ëi⁄
 
	mcom∂ëi⁄
;

39 
VDO
 *
	mvdo
;

40 } 
	tWaôCom∂ëi⁄
;

49 
ölöe
 
WaôCom∂ëi⁄
 *
	$asWaôCom∂ëi⁄
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

51 
	`STATIC_ASSERT
(
	`off£tof
(
WaôCom∂ëi⁄
, 
com∂ëi⁄
) == 0);

52 
	`as£πCom∂ëi⁄Ty≥
(
com∂ëi⁄
->
ty≥
, 
WAIT_FOR_READ_ONLY_MODE_COMPLETION
);

53  (
WaôCom∂ëi⁄
 *Ë
com∂ëi⁄
;

54 
	}
}

63 
ThªadD©a
 *
	$asThªadD©a
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

65 
	`STATIC_ASSERT
(
	`off£tof
(
ThªadD©a
, 
com∂ëi⁄
) == 0);

66 
	`as£πCom∂ëi⁄Ty≥
(
com∂ëi⁄
->
ty≥
, 
READ_ONLY_MODE_COMPLETION
);

67  (
ThªadD©a
 *Ë
com∂ëi⁄
;

68 
	}
}

71 
	$öôülizeThªadD©a
(
ThªadD©a
 *
thªadD©a
,

72 
ThªadID
 
thªadID
,

73 
boﬁ
 
isRódO∆y
,

74 c⁄° 
ThªadC⁄fig
 *
thªadC⁄fig
,

75 
PhysiˇlLayî
 *
œyî
)

77 
thªadD©a
->
thªadID
 =ÅhreadID;

78 
thªadD©a
->
isRódO∆y
 = isReadOnly;

79 
thªadD©a
->
mayE¡îRódO∆yMode
 = 
åue
;

80 
thªadD©a
->
thªadC⁄fig
 =ÅhreadConfig;

81 
thªadD©a
->
√xtAŒoˇti⁄Z⁄e


82 
thªadID
 % 
thªadC⁄fig
->
physiˇlZ⁄eCou¡
;

83  
	`öôülizeEnqueuóbÀCom∂ëi⁄
(&
thªadD©a
->
com∂ëi⁄
,

84 
READ_ONLY_MODE_COMPLETION
, 
œyî
);

85 
	}
}

88 
	$unöôülizeThªadD©a
(
ThªadD©a
 *
thªadD©a
)

90 
	`de°royEnqueuóbÀ
(&
thªadD©a
->
com∂ëi⁄
);

91 
	}
}

94 
PhysiˇlZ⁄e
 *
	$gëNextAŒoˇti⁄Z⁄e
(
VDO
 *
vdo
, 
ThªadID
 
thªadID
)

96 
ThªadD©a
 *
thªadD©a
 = &
vdo
->thªadD©a[
thªadID
];

97 c⁄° 
ThªadC⁄fig
 *
thªadC⁄fig
 = 
thªadD©a
->threadConfig;

98 i‡(
thªadC⁄fig
->
physiˇlZ⁄eCou¡
 > 1) {

99 i‡(
thªadD©a
->
Æloˇti⁄Cou¡
 < 
ALLOCATIONS_PER_ZONE
) {

100 
thªadD©a
->
Æloˇti⁄Cou¡
++;

102 
thªadD©a
->
Æloˇti⁄Cou¡
 = 1;

103 
thªadD©a
->
√xtAŒoˇti⁄Z⁄e
++;

104 i‡(
thªadD©a
->
√xtAŒoˇti⁄Z⁄e
 =
thªadC⁄fig
->
physiˇlZ⁄eCou¡
) {

105 
thªadD©a
->
√xtAŒoˇti⁄Z⁄e
 = 0;

110  
vdo
->
physiˇlZ⁄es
[
thªadD©a
->
√xtAŒoˇti⁄Z⁄e
];

111 
	}
}

122 
	$waôU¡ûThªadNŸE¡îögRódO∆yMode
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

124 
WaôCom∂ëi⁄
 *
waôCom∂ëi⁄
 = 
	`asWaôCom∂ëi⁄
(
com∂ëi⁄
);

125 
VDO
 *
vdo
 = 
waôCom∂ëi⁄
->vdo;

126 
ThªadD©a
 *
thªadD©a
 = &
vdo
->thªadD©a[
com∂ëi⁄
->
ˇŒbackThªadID
];

128 i‡(
thªadD©a
->
isE¡îögRódO∆yMode


129 || (
thªadD©a
->
su≥rBlockAc˚ssSèã
 =
READING_SUPER_BLOCK
)) {

130 
thªadD©a
->
su≥rBlockIdÀWaôî
 = 
com∂ëi⁄
;

134 
thªadD©a
->
mayE¡îRódO∆yMode
 = 
Ál£
;

135 
ThªadID
 
√xtThªad
 = 
thªadD©a
->
thªadID
 + 1;

136 i‡(
√xtThªad
 =
	`gëThªadC⁄fig
(
vdo
)->
ba£ThªadCou¡
) {

137 
VDOCom∂ëi⁄
 *
∑ª¡
 = 
com∂ëi⁄
->parent;

138 
	`de°royEnqueuóbÀ
(
com∂ëi⁄
);

139 
	`FREE
(
com∂ëi⁄
);

140 
	`com∂ëeCom∂ëi⁄
(
∑ª¡
);

144 
	`œunchCÆlback
(
com∂ëi⁄
, 
waôU¡ûThªadNŸE¡îögRódO∆yMode
,

145 
√xtThªad
);

146 
	}
}

149 
	$waôU¡ûNŸE¡îögRódO∆yMode
(
VDO
 *
vdo
, 
VDOCom∂ëi⁄
 *
∑ª¡
)

151 i‡(
vdo
->
thªadD©a
 =
NULL
) {

152 
	`föishCom∂ëi⁄
(
∑ª¡
, 
VDO_SUCCESS
);

156 
WaôCom∂ëi⁄
 *
com∂ëi⁄
;

157 
ªsu…
 = 
	`ALLOCATE
(1, 
WaôCom∂ëi⁄
, 
__func__
, &
com∂ëi⁄
);

158 i‡(
ªsu…
 !
VDO_SUCCESS
) {

159 
	`föishCom∂ëi⁄
(
∑ª¡
, 
ªsu…
);

163 
com∂ëi⁄
->
vdo
 = vdo;

164 
ªsu…
 = 
	`öôülizeEnqueuóbÀCom∂ëi⁄
(&
com∂ëi⁄
->completion,

165 
WAIT_FOR_READ_ONLY_MODE_COMPLETION
,

166 
vdo
->
œyî
);

167 i‡(
ªsu…
 !
VDO_SUCCESS
) {

168 
	`föishCom∂ëi⁄
(
∑ª¡
, 
ªsu…
);

172 
	`œunchCÆlbackWôhP¨ít
(&
com∂ëi⁄
->completion,

173 
waôU¡ûThªadNŸE¡îögRódO∆yMode
, 0, 
∑ª¡
);

174 
	}
}

181 
	$föishE¡îögRódO∆yMode
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

183 
ThªadD©a
 *
thªadD©a
 = 
	`asThªadD©a
(
com∂ëi⁄
);

184 
thªadD©a
->
isE¡îögRódO∆yMode
 = 
Ál£
;

185 
thªadD©a
->
su≥rBlockAc˚ssSèã
 = 
NOT_ACCESSING_SUPER_BLOCK
;

187 
VDOCom∂ëi⁄
 *
waôî
 = 
thªadD©a
->
su≥rBlockIdÀWaôî
;

188 i‡(
waôî
 !
NULL
) {

189 
thªadD©a
->
su≥rBlockIdÀWaôî
 = 
NULL
;

190 
	`waôU¡ûThªadNŸE¡îögRódO∆yMode
(
waôî
);

192 
	}
}

199 
	$makeThªadRódO∆y
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

201 
VDO
 *
vdo
 = 
com∂ëi⁄
->
∑ª¡
;

202 
ThªadD©a
 *
thªadD©a
 = &
vdo
->thªadD©a[
com∂ëi⁄
->
ˇŒbackThªadID
];

203 
thªadD©a
->
isRódO∆y
 = 
åue
;

207 c⁄° 
ThªadC⁄fig
 *
thªadC⁄fig
 = 
	`gëThªadC⁄fig
(
vdo
);

208 i‡(
thªadD©a
->
thªadID
 =
thªadC⁄fig
->
jou∫ÆThªad
) {

209 
	`nŸifyRecovîyJou∫ÆOfRódO∆yMode
(
vdo
->
ªcovîyJou∫Æ
);

211 
Z⁄eCou¡
 
z
 = 0; z < 
thªadC⁄fig
->
physiˇlZ⁄eCou¡
; z++) {

212 i‡(
thªadD©a
->
thªadID
 =
	`gëPhysiˇlZ⁄eThªad
(
thªadC⁄fig
, 
z
)) {

213 
BlockAŒoˇt‹
 *
Æloˇt‹
 = 
	`gëBlockAŒoˇt‹F‹Z⁄e
(
vdo
->
dïŸ
, 
z
);

214 
	`nŸifyBlockAŒoˇt‹OfRódO∆yMode
(
Æloˇt‹
);

218 
ThªadID
 
√xtThªad
 = 
thªadD©a
->
thªadID
 + 1;

219 i‡(
√xtThªad
 =
	`gëThªadC⁄fig
(
vdo
)->
ba£ThªadCou¡
) {

220 
ThªadD©a
 *
ow√r
 = 
	`asThªadD©a
(
com∂ëi⁄
);

221 
	`œunchCÆlback
(
com∂ëi⁄
, 
föishE¡îögRódO∆yMode
, 
ow√r
->
thªadID
);

225 
	`œunchCÆlback
(
com∂ëi⁄
, 
makeThªadRódO∆y
, 
√xtThªad
);

226 
	}
}

234 
	$ªadO∆ySèãSaved
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

236 
	`ª£tCom∂ëi⁄
(
com∂ëi⁄
);

237 
	`makeThªadRódO∆y
(
com∂ëi⁄
);

238 
	}
}

246 
	$h™dÀSaveEº‹
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

248 
	`logEº‹WôhSåögEº‹
(
com∂ëi⁄
->
ªsu…
,

251 
	`ªadO∆ySèãSaved
(
com∂ëi⁄
);

252 
	}
}

262 
	$£tRódO∆ySèã
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
, 
boﬁ
 
ßveSu≥rBlock
)

264 
	`ASSERT_LOG_ONLY
((
	`gëCÆlbackThªadID
() == 0),

266 
ThªadD©a
 *
thªadD©a
 = 
	`asThªadD©a
(
com∂ëi⁄
);

267 
VDO
 *
vdo
 = 
com∂ëi⁄
->
∑ª¡
;

268 i‡(
vdo
->
°©e
 =
VDO_READ_ONLY_MODE
) {

270 
	`œunchCÆlback
(
com∂ëi⁄
, 
föishE¡îögRódO∆yMode
,

271 
thªadD©a
->
thªadID
);

276 
	`logEº‹WôhSåögEº‹
(
thªadD©a
->
ªadO∆yEº‹
,

278 
vdo
->
°©e
 = 
VDO_READ_ONLY_MODE
;

280 
ThªadD©a
 *
admöThªadD©a
 = &
vdo
->
thªadD©a
[0];

281 i‡(
admöThªadD©a
->
su≥rBlockAc˚ssSèã
 !
NOT_ACCESSING_SUPER_BLOCK
) {

282 
admöThªadD©a
->
ªadO∆yModeWaôî
 = 
com∂ëi⁄
;

286 i‡(!
ßveSu≥rBlock
) {

287 
	`makeThªadRódO∆y
(
com∂ëi⁄
);

291 
admöThªadD©a
->
su≥rBlockAc˚ssSèã
 = 
WRITING_SUPER_BLOCK
;

292 
com∂ëi⁄
->
ˇŒback
 = 
ªadO∆ySèãSaved
;

293 
com∂ëi⁄
->
îr‹H™dÀr
 = 
h™dÀSaveEº‹
;

294 
	`ßveVDOComp⁄ítsAsync
(
vdo
, 
com∂ëi⁄
);

295 
	}
}

303 
	$£tRódO∆ySèãNoSave
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

305 
	`£tRódO∆ySèã
(
com∂ëi⁄
, 
Ál£
);

306 
	}
}

314 
	$£tRódO∆ySèãAndSave
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

316 
	`£tRódO∆ySèã
(
com∂ëi⁄
, 
åue
);

317 
	}
}

320 
	$makeVDORódO∆y
(
VDO
 *
vdo
, 
îr‹Code
, 
boﬁ
 
ßveSu≥rBlock
)

322 
ThªadD©a
 *
thªadD©a
 = 
	`gëThªadD©a
(
vdo
);

323 i‡(
thªadD©a
->
isRódO∆y
) {

327 
thªadD©a
->
isRódO∆y
 = 
åue
;

328 i‡(
thªadD©a
->
mayE¡îRódO∆yMode
 =
Ál£
) {

332 
thªadD©a
->
isE¡îögRódO∆yMode
 = 
åue
;

333 
thªadD©a
->
ªadO∆yEº‹
 = 
îr‹Code
;

334 i‡(
ßveSu≥rBlock
) {

335 
	`œunchCÆlbackWôhP¨ít
(&
thªadD©a
->
com∂ëi⁄
, 
£tRódO∆ySèãAndSave
,

336 0, 
vdo
);

338 
	`œunchCÆlbackWôhP¨ít
(&
thªadD©a
->
com∂ëi⁄
, 
£tRódO∆ySèãNoSave
,

339 0, 
vdo
);

341 
	}
}

	@vdo/base/threadData.h

22 #i‚de‡
THREAD_DATA_H


23 
	#THREAD_DATA_H


	)

25 
	~"com∂ëi⁄.h
"

28 
	mNOT_ACCESSING_SUPER_BLOCK
 = 0,

29 
	mREADING_SUPER_BLOCK
,

30 
	mWRITING_SUPER_BLOCK
,

31 } 
	tSu≥rBlockAc˚ssSèã
;

36 
	sthªadD©a
 {

38 
VDOCom∂ëi⁄
 
	mcom∂ëi⁄
;

40 
ThªadID
 
	mthªadID
;

42 c⁄° 
ThªadC⁄fig
 *
	mthªadC⁄fig
;

44 
Z⁄eCou¡
 
	m√xtAŒoˇti⁄Z⁄e
;

46 
BlockCou¡
 
	mÆloˇti⁄Cou¡
;

48 
boﬁ
 
	misRódO∆y
;

50 
boﬁ
 
	misE¡îögRódO∆yMode
;

52 
boﬁ
 
	mmayE¡îRódO∆yMode
;

54 
	mªadO∆yEº‹
;

56 
Su≥rBlockAc˚ssSèã
 
	msu≥rBlockAc˚ssSèã
;

58 
VDOCom∂ëi⁄
 *
	msu≥rBlockIdÀWaôî
;

60 
VDOCom∂ëi⁄
 *
	mªadO∆yModeWaôî
;

75 
	$öôülizeThªadD©a
(
ThªadD©a
 *
thªadD©a
,

76 
ThªadID
 
thªadID
,

77 
boﬁ
 
isRódO∆y
,

78 c⁄° 
ThªadC⁄fig
 *
thªadC⁄fig
,

79 
PhysiˇlLayî
 *
œyî
)

80 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

87 
	`unöôülizeThªadD©a
(
ThªadD©a
 *
thªadD©a
);

97 
PhysiˇlZ⁄e
 *
	$gëNextAŒoˇti⁄Z⁄e
(
VDO
 *
vdo
, 
ThªadID
 
thªadID
)

98 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

107 
	`waôU¡ûNŸE¡îögRódO∆yMode
(
VDO
 *
vdo
, 
VDOCom∂ëi⁄
 *
waôî
);

118 
	`makeVDORódO∆y
(
VDO
 *
vdo
, 
îr‹Code
, 
boﬁ
 
ßveSu≥rBlock
);

	@vdo/base/trace.c

22 
	~"åa˚.h
"

24 
	~"loggî.h
"

25 
	~"°rögUtûs.h
"

26 
	~"timeUtûs.h
"

28 
TRACE_LOCATION_SECTION
 
Tø˚Loˇti⁄Rec‹d
 
	gba£Tø˚Loˇti⁄
[] = {

30 .
fun˘i⁄
 = "<none>",

31 .
	glöe
 = 0,

36 
	$addTø˚Rec‹d
(
Tø˚
 *
åa˚
, 
Tø˚Loˇti⁄
 
loˇti⁄
)

38 i‡(
åa˚
->
u£d
 < 
NUM_TRACE_RECORDS
) {

39 
Tø˚Rec‹d
 *
ªc‹d
 = &
åa˚
->
ªc‹ds
[åa˚->
u£d
];

40 
åa˚
->
u£d
++;

42 
ªc‹d
->
whí
 = 
	`nowU£c
();

43 
ªc‹d
->
tid
 = 
	`gëThªadId
();

44 
ªc‹d
->
loˇti⁄
 =Üoˇti⁄ - 
ba£Tø˚Loˇti⁄
;

46 
	}
}

56 
	$f‹m©Tø˚
(
Tø˚
 *
åa˚
,

57 *
buf„r
,

58 
size_t
 
buf„rLígth
,

59 
size_t
 *
msgLí
)

61 i‡(
åa˚
 =
NULL
) {

64 
	`mem£t
(
buf„r
, 0, 
buf„rLígth
);

65 *
buf
 = 
buf„r
;

66 *
buf„rEnd
 = 
buf„r
 + 
buf„rLígth
 - 1;

67 i‡(
åa˚
->
u£d
 > 0) {

68 
Tø˚Rec‹d
 *
ªc‹d
 = &
åa˚
->
ªc‹ds
[0];

69 
Tø˚Loˇti⁄Rec‹d
 *
loˇti⁄
 = 
ba£Tø˚Loˇti⁄
 + 
ªc‹d
->location;

70 
	`¢¥ötf
(
buf
, 
buf„rEnd
 - buf, "Tø˚[%s@%" 
PRIu64
 ".%06" PRIu64,

71 
loˇti⁄
->
fun˘i⁄
, 
ªc‹d
->
whí
 / 1000000,

72 
ªc‹d
->
whí
 % 1000000);

73 
buf
 +
	`°æí
(buf);

75 
i
 = 1; i < 
åa˚
->
u£d
; i++) {

76 
Tø˚Rec‹d
 *
¥ev
 = 
ªc‹d
;

77 
ªc‹d
++;

79 
	`¢¥ötf
(
buf
, 
buf„rEnd
 - buf, ",");

80 
buf
 +
	`°æí
(buf);

82 
loˇti⁄
 = 
ba£Tø˚Loˇti⁄
 + 
ªc‹d
->location;

83 
timeDiff
 = 
ªc‹d
->
whí
 - 
¥ev
->when;

84 
	`¢¥ötf
(
buf
, 
buf„rEnd
 - buf, "%s+%lu",

85 
loˇti⁄
->
fun˘i⁄
, 
timeDiff
);

86 
buf
 +
	`°æí
(buf);

88 i‡(
buf„rLígth
 > 7) {

89 i‡(
buf„r
[
buf„rLígth
-5] != '\0') {

91 
	`°r˝y
(
buf„r
+
buf„rLígth
-5, "...]");

93 
	`°r˝y
(
buf
, "]");

97 *
msgLí
 = (
buf
 - 
buf„r
);

98 
	}
}

	@vdo/base/trace.h

22 #i‚de‡
TRACE_H


23 
	#TRACE_H


	)

25 #i‚de‡
__KERNEL__


26 
	~"˝u.h
"

29 
	~"thªads.h
"

82 c⁄° 
	t__©åibuã__
((
	tÆig√d
(16))Ë
	tåa˚Loˇti⁄Rec‹d
 {

83 c⁄° *
fun˘i⁄
;

84 
löe
;

85 c⁄° *
des¸ùti⁄
;

86 
	}
} 
	tTø˚Loˇti⁄Rec‹d
;

93 
öt32_t
 
	tTø˚Loˇti⁄Numbî
;

96 
Tø˚Loˇti⁄Rec‹d
 *
	tTø˚Loˇti⁄
;

117 
	#TRACE_LOCATION_SECTION
 \

118 
	`__©åibuã__
((
	`£˘i⁄
(".kvdo_åa˚_loˇti⁄s")))

	)

120 
TRACE_LOCATION_SECTION
 
Tø˚Loˇti⁄Rec‹d
 
ba£Tø˚Loˇti⁄
[];

122 
	#TRACE_JOIN2
(
a
,
b
Ëa##
	)
b

123 
	#TRACE_JOIN
(
a
,
b
Ë
	`TRACE_JOIN2
◊,b)

	)

124 
	#THIS_LOCATION
(
DESCRIPTION
) \

125 
__exãnsi⁄__
 \

127 
TRACE_LOCATION_SECTION
 \

128 
Tø˚Loˇti⁄Rec‹d
 
	`TRACE_JOIN
(
loc
,
__LINE__
) = { \

129 .
fun˘i⁄
 = 
__func__
, \

130 .
löe
 = 
__LINE__
, \

131 .
des¸ùti⁄
 = 
DESCRIPTION
, \

133 &
	`TRACE_JOIN
(
loc
,
__LINE__
); \

134 })

	)

136 
	såa˚Rec‹d
 {

137 
uöt64_t
 
	mwhí
;

138 
pid_t
 
	mtid
;

139 
Tø˚Loˇti⁄Numbî
 
	mloˇti⁄
;

140 } 
	tTø˚Rec‹d
;

142 íum { 
	mNUM_TRACE_RECORDS
 = 71 };

144 
	såa˚
 {

145 
	mu£d
;

146 
Tø˚Rec‹d
 
	mªc‹ds
[
NUM_TRACE_RECORDS
];

147 } 
	tTø˚
;

155 
addTø˚Rec‹d
(
Tø˚
 *
åa˚
, 
Tø˚Loˇti⁄
 
loˇti⁄
);

165 
f‹m©Tø˚
(
Tø˚
 *
åa˚
,

166 *
buf„r
,

167 
size_t
 
buf„rLígth
,

168 
size_t
 *
msgLí
);

	@vdo/base/types.h

22 #i‚de‡
TYPES_H


23 
	#TYPES_H


	)

25 
	~"blockM≠pögSèã.h
"

26 
	~"comm⁄.h
"

27 
	~"°©usCodes.h
"

32 
uöt64_t
 
	tBlockCou¡
;

37 
uöt16_t
 
	tBlockSize
;

42 
uöt8_t
 
	tCom¥es£dFøgmítCou¡
;

47 
uöt32_t
 
	tCRC32Checksum
;

52 
uöt64_t
 
	tHóπbótCou¡
;

57 
uöt8_t
 
	tHeight
;

62 
uöt64_t
 
	tLogiˇlBlockNumbî
;

67 
uöt64_t
 
	tN⁄˚
;

72 
uöt32_t
 
	tPageCou¡
;

77 
uöt32_t
 
	tPageNumbî
;

82 
uöt32_t
 
	tPageSize
;

88 
uöt64_t
 
	tPhysiˇlBlockNumbî
;

93 
uöt8_t
 
	tRoŸCou¡
;

98 
uöt8_t
 
	tSe˘‹Cou¡
;

103 
uöt64_t
 
	tSequí˚Numbî
;

108 
uöt16_t
 
	tSœbCou¡
;

113 
uöt16_t
 
	tSlŸNumbî
;

118 
uöt16_t
 
	tVIOCou¡
;

123 
thªadC⁄fig
 
	tThªadC⁄fig
;

128 
uöt8_t
 
	tThªadCou¡
;

135 
uöt8_t
 
	tThªadID
;

141 c⁄° 
ThªadID
 
	gINVALID_THREAD_ID
 = (ThreadID) -1;

146 
uöt8_t
 
	tZ⁄eCou¡
;

151 
__©åibuã__
((
	t∑cked
)Ë
	tvioO≥øti⁄
 {

152 
	gVIO_UNSPECIFIED_OPERATION
 = 0,

153 
	gVIO_READ
 = 1,

154 
	gVIO_WRITE
 = 2,

155 
	gVIO_READ_MODIFY_WRITE
 = 
VIO_READ
 | 
VIO_WRITE
,

156 
	gVIO_READ_WRITE_MASK
 = 
VIO_READ_MODIFY_WRITE
,

157 
	gVIO_FLUSH_BEFORE
 = 4,

158 
	gVIO_FLUSH_AFTER
 = 8,

159 } 
	tVIOO≥øti⁄
;

164 
__©åibuã__
((
	t∑cked
)) {

165 
	gVIO_TYPE_UNINITIALIZED
 = 0,

166 
	gVIO_TYPE_DATA
,

167 
	gVIO_TYPE_BLOCK_ALLOCATOR
,

168 
	gVIO_TYPE_BLOCK_MAP
,

169 
	gVIO_TYPE_BLOCK_MAP_INTERIOR
,

170 
	gVIO_TYPE_COMPRESSED_BLOCK
,

171 
	gVIO_TYPE_PARTITION_COPY
,

172 
	gVIO_TYPE_RECOVERY_JOURNAL
,

173 
	gVIO_TYPE_SLAB_JOURNAL
,

174 
	gVIO_TYPE_SLAB_SUMMARY
,

175 
	gVIO_TYPE_SUPER_BLOCK
,

176 
	gVIO_TYPE_TEST
,

177 } 
	tVIOTy≥
;

183 
__©åibuã__
((
	t∑cked
)) {

184 
	gDATA_DECREMENT
 = 0,

185 
	gDATA_INCREMENT
 = 1,

186 
	gBLOCK_MAP_DECREMENT
 = 2,

187 
	gBLOCK_MAP_INCREMENT
 = 3,

188 } 
	tJou∫ÆO≥øti⁄
;

193 
__©åibuã__
((
	t∑cked
)) {

194 
	gBLOCK_MAP_PARTITION
 = 0,

195 
	gBLOCK_ALLOCATOR_PARTITION
 = 1,

196 
	gRECOVERY_JOURNAL_PARTITION
 = 2,

197 
	gSLAB_SUMMARY_PARTITION
 = 3,

198 } 
	tP¨tôi⁄ID
;

205 
ölöe
 
boﬁ
 
	$isD©aVIOTy≥
(
VIOTy≥
 
vioTy≥
)

207  (
vioTy≥
 =
VIO_TYPE_DATA
);

208 
	}
}

215 
ölöe
 
boﬁ
 
	$isCom¥es£dWrôeVIOTy≥
(
VIOTy≥
 
vioTy≥
)

217  (
vioTy≥
 =
VIO_TYPE_COMPRESSED_BLOCK
);

218 
	}
}

225 
ölöe
 
boﬁ
 
	$isMëad©aVIOTy≥
(
VIOTy≥
 
vioTy≥
)

227  ((
vioTy≥
 !
VIO_TYPE_UNINITIALIZED
)

228 && !
	`isD©aVIOTy≥
(
vioTy≥
)

229 && !
	`isCom¥es£dWrôeVIOTy≥
(
vioTy≥
));

230 
	}
}

235 
__©åibuã__
((
	t∑cked
)Ë
	tvioPri‹ôy
 {

236 
	gVIO_PRIORITY_LOW
 = 0,

237 
	gVIO_PRIORITY_DATA
 = 
VIO_PRIORITY_LOW
,

238 
	gVIO_PRIORITY_COMPRESSED_DATA
 = 
VIO_PRIORITY_DATA
,

239 
	gVIO_PRIORITY_METADATA
,

240 
	gVIO_PRIORITY_HIGH
,

241 } 
	tVIOPri‹ôy
;

246 
__©åibuã__
((
	t∑cked
)) {

247 
	gVDO_METADATA_RECOVERY_JOURNAL
 = 1,

248 
	gVDO_METADATA_SLAB_JOURNAL
,

249 } 
	tVDOMëad©aTy≥
;

255 
	mWRITE_POLICY_SYNC
,

258 
	mWRITE_POLICY_ASYNC
,

261 } 
	tWrôePﬁicy
;

264 
	mZONE_TYPE_JOURNAL
,

265 
	mZONE_TYPE_LOGICAL
,

266 
	mZONE_TYPE_PHYSICAL
,

267 } 
	tZ⁄eTy≥
;

273 
PhysiˇlBlockNumbî
 
	mpbn
;

274 
SlŸNumbî
 
	m¶Ÿ
;

275 } 
	tBlockM≠SlŸ
;

281 
PageNumbî
 
	m∑geIndex
;

282 
BlockM≠SlŸ
 
	mblockM≠SlŸ
;

283 } 
	tBlockM≠TªeSlŸ
;

289 
	s¶abC⁄fig
 {

290 
BlockCou¡
 
	m¶abBlocks
;

291 
BlockCou¡
 
	md©aBlocks
;

292 
BlockCou¡
 
	mª„ªn˚Cou¡Blocks
;

293 
BlockCou¡
 
	m¶abJou∫ÆBlocks
;

298 
BlockCou¡
 
	m¶abJou∫ÆFlushögThªshﬁd
;

303 
BlockCou¡
 
	m¶abJou∫ÆBlockögThªshﬁd
;

308 
BlockCou¡
 
	m¶abJou∫ÆS¸ubbögThªshﬁd
;

309 } 
	t__©åibuã__
((
	t∑cked
)Ë
	tSœbC⁄fig
;

315 
	mVDO_DIRTY
 = 0,

316 
	mVDO_NEW
,

317 
	mVDO_CLEAN
,

318 
	mVDO_READ_ONLY_MODE
,

319 
	mVDO_FORCE_REBUILD
,

320 
	mVDO_RECOVERING
,

321 
	mVDO_REPLAYING
,

322 
	mVDO_REBUILD_FOR_UPGRADE
,

323 } 
	tVDOSèã
;

328 
	svdoC⁄fig
 {

329 
BlockCou¡
 
	mlogiˇlBlocks
;

330 
BlockCou¡
 
	mphysiˇlBlocks
;

331 
BlockCou¡
 
	m¶abSize
;

332 
BlockCou¡
 
	mªcovîyJou∫ÆSize
;

333 
BlockCou¡
 
	m¶abJou∫ÆBlocks
;

334 } 
	t__©åibuã__
((
	t∑cked
)Ë
	tVDOC⁄fig
;

339 
	svdoLﬂdC⁄fig
 {

341 
ThªadC⁄fig
 *
	mthªadC⁄fig
;

343 
PageCou¡
 
	mˇcheSize
;

345 
WrôePﬁicy
 
	mwrôePﬁicy
;

347 
BlockCou¡
 
	mmaximumAge
;

348 } 
	tVDOLﬂdC⁄fig
;

353 
admöCom∂ëi⁄
 
	tAdmöCom∂ëi⁄
;

354 
ÆloˇtögVIO
 
	tAŒoˇtögVIO
;

355 
blockAŒoˇt‹
 
	tBlockAŒoˇt‹
;

356 
blockM≠
 
	tBlockM≠
;

357 
blockM≠Tªe
 
	tBlockM≠Tªe
;

358 
blockM≠TªeZ⁄e
 
	tBlockM≠TªeZ⁄e
;

359 
blockM≠Z⁄e
 
	tBlockM≠Z⁄e
;

360 
d©aVIO
 
	tD©aVIO
;

361 
Êushî
 
	tFlushî
;

362 
f‹e°
 
	tF‹e°
;

363 
hashLock
 
	tHashLock
;

364 
hashZ⁄e
 
	tHashZ⁄e
;

365 
öputBö
 
	tI≈utBö
;

366 
lbnLock
 
	tLBNLock
;

367 
lockCou¡î
 
	tLockCou¡î
;

368 
logiˇlZ⁄e
 
	tLogiˇlZ⁄e
;

369 
obje˘Poﬁ
 
	tObje˘Poﬁ
;

370 
pbnLock
 
	tPBNLock
;

371 
physiˇlLayî
 
	tPhysiˇlLayî
;

372 
physiˇlZ⁄e
 
	tPhysiˇlZ⁄e
;

373 
ªcovîyJou∫Æ
 
	tRecovîyJou∫Æ
;

374 
ªadO∆yModeC⁄ãxt
 
	tRódO∆yModeC⁄ãxt
;

375 
ªfCou¡s
 
	tRefCou¡s
;

376 
vdoSœb
 
	tSœb
;

377 
¶abDïŸ
 
	tSœbDïŸ
;

378 
¶abJou∫Æ
 
	tSœbJou∫Æ
;

379 
¶abJou∫ÆE¡ry
 
	tSœbJou∫ÆE¡ry
;

380 
¶abS¸ubbî
 
	tSœbS¸ubbî
;

381 
¶abSumm¨y
 
	tSœbSumm¨y
;

382 
¶abSumm¨yZ⁄e
 
	tSœbSumm¨yZ⁄e
;

383 
thªadD©a
 
	tThªadD©a
;

384 
vdo
 
	tVDO
;

385 
vdoCom∂ëi⁄
 
	tVDOCom∂ëi⁄
;

386 
vdoExã¡
 
	tVDOExã¡
;

387 
vdoFlush
 
	tVDOFlush
;

388 
vdoLayout
 
	tVDOLayout
;

389 
vdoSèti°ics
 
	tVDOSèti°ics
;

390 
vio
 
	tVIO
;

393 
PhysiˇlBlockNumbî
 
	mpbn
;

394 
BlockM≠pögSèã
 
	m°©e
;

395 } 
	tD©aLoˇti⁄
;

398 
PhysiˇlBlockNumbî
 
	mpbn
;

399 
BlockM≠pögSèã
 
	m°©e
;

400 
PhysiˇlZ⁄e
 *
	mz⁄e
;

401 } 
	tZ⁄edPBN
;

409 
	tVDOExã¡CÆlback
(
	tVDOExã¡
 *
	texã¡
);

416 
	tAsyncO≥øti⁄
(
	tVIO
 *
	tvio
);

423 
	tCom¥es£dWrôî
(
	tAŒoˇtögVIO
 *
	tÆloˇtögVIO
);

430 
	tAsyncD©aO≥øti⁄
(
	tD©aVIO
 *
	td©aVIO
);

436 
	síqueuóbÀ
 {

437 
VDOCom∂ëi⁄
 *
	mcom∂ëi⁄
;

438 } 
	tEnqueuóbÀ
;

441 
	mADMIN_STATE_NORMAL_OPERATION
 = 0,

442 
	mADMIN_STATE_CLOSE_REQUESTED
,

443 
	mADMIN_STATE_CLOSING
,

444 
	mADMIN_STATE_CLOSED
,

445 
	mADMIN_STATE_SUSPENDED
,

446 } 
	tAdmöSèã
;

449 
ölöe
 
boﬁ
 
	$isClosög
(
AdmöSèã
 
°©e
)

451  ((
°©e
 >
ADMIN_STATE_CLOSE_REQUESTED
)

452 && (
°©e
 <
ADMIN_STATE_CLOSED
));

453 
	}
}

	@vdo/base/upgrade.c

22 
	~"upgøde.h
"

24 
	~"loggî.h
"

25 
	~"mem‹yAŒoc.h
"

26 
	~"≥rmas£π.h
"

28 
	~"blockM≠.h
"

29 
	~"ªcovîyJou∫Æ.h
"

30 
	~"ªÀa£Vîsi⁄s.h
"

31 
	~"¶abDïŸ.h
"

32 
	~"°©usCodes.h
"

33 
	~"su≥rBlock.h
"

34 
	~"vdoI¡î«l.h
"

37 c⁄° 
Vîsi⁄Numbî
 
	gSODIUM_MASTER_VERSION_67_0
 = {

38 .
maj‹Vîsi⁄
 = 67,

39 .
	gmö‹Vîsi⁄
 = 0,

43 c⁄° 
Vîsi⁄Numbî
 
	gSODIUM_COMPONENT_DATA_41_0
 = {

44 .
maj‹Vîsi⁄
 = 41,

45 .
	gmö‹Vîsi⁄
 = 0,

52 
VDOSèã
 
	m°©e
;

53 
uöt64_t
 
	mcom∂ëeRecovîõs
;

54 
uöt64_t
 
	mªadO∆yRecovîõs
;

55 
VDOC⁄fig
 
	mc⁄fig
;

56 
N⁄˚
 
	mn⁄˚
;

57 } 
	t__©åibuã__
((
	t∑cked
)Ë
	tSodiumComp⁄ít41_0
;

67 
boﬁ
 
	$isCuºítRñó£Vîsi⁄
(
VDO
 *
vdo
)

69 
Rñó£Vîsi⁄Numbî
 
lﬂdedVîsi⁄


70 
	`gëLﬂdedRñó£Vîsi⁄
(
vdo
->
su≥rBlock
);

72  (
lﬂdedVîsi⁄
 =
CURRENT_RELEASE_VERSION_NUMBER
);

73 
	}
}

83 
	$vÆid©eSodiumVîsi⁄
(
VDO
 *
vdo
)

85 
ªsu…
 = 
	`decodeVDOVîsi⁄
(
vdo
);

86 i‡(
ªsu…
 !
VDO_SUCCESS
) {

87  
ªsu…
;

90 i‡(
	`isCuºítRñó£Vîsi⁄
(
vdo
)) {

91  
VDO_SUCCESS
;

94 
Rñó£Vîsi⁄Numbî
 
lﬂdedVîsi⁄


95 
	`gëLﬂdedRñó£Vîsi⁄
(
vdo
->
su≥rBlock
);

96  
	`logEº‹WôhSåögEº‹
(
VDO_UNSUPPORTED_VERSION
,

98 " c™nŸ bêupgøded", 
lﬂdedVîsi⁄
,

99 
vdo
->
lﬂdVîsi⁄
.
maj‹Vîsi⁄
,

100 
vdo
->
lﬂdVîsi⁄
.
mö‹Vîsi⁄
);

101 
	}
}

111 
	$decodeSodium41_0Comp⁄ít
(
Buf„r
 *
buf„r
,

112 
SodiumComp⁄ít41_0
 *
comp⁄ít
)

114  
	`gëByãsFromBuf„r
(
buf„r
, (*
comp⁄ít
), component);

115 
	}
}

125 
__©åibuã__
((
w¨n_unu£d_ªsu…
))

126 
	$decodeSodiumComp⁄ít
(
VDO
 *
vdo
)

128 
Buf„r
 *
buf„r
 = 
	`gëComp⁄ítBuf„r
(
vdo
->
su≥rBlock
);

129 
Vîsi⁄Numbî
 
vîsi⁄
;

130 
ªsu…
 = 
	`gëByãsFromBuf„r
(
buf„r
, (
Vîsi⁄Numbî
), &
vîsi⁄
);

131 i‡(
ªsu…
 !
VDO_SUCCESS
) {

132  
ªsu…
;

135 
SodiumComp⁄ít41_0
 
comp⁄ít
;

136 i‡(
	`¨eSameVîsi⁄
(&
SODIUM_COMPONENT_DATA_41_0
, &
vîsi⁄
)) {

137 
ªsu…
 = 
	`decodeSodium41_0Comp⁄ít
(
buf„r
, &
comp⁄ít
);

139  
	`logEº‹WôhSåögEº‹
(
VDO_UNSUPPORTED_VERSION
,

142 
vîsi⁄
.
maj‹Vîsi⁄
,

143 
vîsi⁄
.
mö‹Vîsi⁄
);

145 i‡(
ªsu…
 !
VDO_SUCCESS
) {

146  
ªsu…
;

150 
vdo
->
°©e
 = 
comp⁄ít
.state;

151 
vdo
->
lﬂdSèã
 = 
comp⁄ít
.
°©e
;

152 
vdo
->
com∂ëeRecovîõs
 = 
comp⁄ít
.completeRecoveries;

153 
vdo
->
ªadO∆yRecovîõs
 = 
comp⁄ít
.readOnlyRecoveries;

154 
vdo
->
c⁄fig
 = 
comp⁄ít
.config;

155 
vdo
->
n⁄˚
 = 
comp⁄ít
.nonce;

157 
	`logInfo
("Converted VDO component data version %d.%d",

158 
vîsi⁄
.
maj‹Vîsi⁄
, vîsi⁄.
mö‹Vîsi⁄
);

159  
VDO_SUCCESS
;

160 
	}
}

163 
__©åibuã__
((
w¨n_unu£d_ªsu…
))

164 
	$föishSodiumDecode
(
VDO
 *
vdo
)

166 
Buf„r
 *
buf„r
 = 
	`gëComp⁄ítBuf„r
(
vdo
->
su≥rBlock
);

167 c⁄° 
ThªadC⁄fig
 *
thªadC⁄fig
 = 
	`gëThªadC⁄fig
(
vdo
);

168 
ªsu…
 = 
	`makeRecovîyJou∫Æ
(
vdo
->
n⁄˚
, vdo->
œyî
,

169 
	`gëVDOP¨tôi⁄
(
vdo
->
œyout
,

170 
RECOVERY_JOURNAL_PARTITION
),

171 
vdo
->
com∂ëeRecovîõs
,

172 
vdo
->
c⁄fig
.
ªcovîyJou∫ÆSize
,

173 
RECOVERY_JOURNAL_TAIL_BUFFER_SIZE
,

174 &
vdo
->
ªadO∆yC⁄ãxt
, 
thªadC⁄fig
,

175 &
vdo
->
ªcovîyJou∫Æ
);

176 i‡(
ªsu…
 !
VDO_SUCCESS
) {

177  
ªsu…
;

180 
ªsu…
 = 
	`decodeSodiumRecovîyJou∫Æ
(
vdo
->
ªcovîyJou∫Æ
, 
buf„r
);

181 i‡(
ªsu…
 !
VDO_SUCCESS
) {

182  
ªsu…
;

185 
ªsu…
 = 
	`decodeSodiumSœbDïŸ
(
buf„r
, 
thªadC⁄fig
, 
vdo
->
n⁄˚
, vdo->
œyî
,

186 
	`gëVDOP¨tôi⁄
(
vdo
->
œyout
,

187 
SLAB_SUMMARY_PARTITION
),

188 &
vdo
->
ªadO∆yC⁄ãxt
, vdo->
ªcovîyJou∫Æ
,

189 &
vdo
->
dïŸ
);

190 i‡(
ªsu…
 !
VDO_SUCCESS
) {

191  
ªsu…
;

194 
ªsu…
 = 
	`decodeSodiumBlockM≠
(
buf„r
, 
vdo
->
c⁄fig
.
logiˇlBlocks
,

195 
thªadC⁄fig
, &
vdo
->
blockM≠
);

196 i‡(
ªsu…
 !
VDO_SUCCESS
) {

197  
ªsu…
;

200 
	`ASSERT_LOG_ONLY
((
	`c⁄ã¡Lígth
(
buf„r
) == 0),

202  
VDO_SUCCESS
;

203 
	}
}

206 
	$upgødePri‹VDO
(
PhysiˇlLayî
 *
œyî
)

208 
VDO
 *
vdo
;

209 
ªsu…
 = 
	`makeVDO
(
œyî
, &
vdo
);

210 i‡(
ªsu…
 !
VDO_SUCCESS
) {

211  
ªsu…
;

214 
ªsu…
 = 
	`lﬂdSu≥rBlock
(
vdo
->
œyî
, &vdo->
su≥rBlock
);

215 i‡(
ªsu…
 !
VDO_SUCCESS
) {

216 
	`‰ìVDO
(&
vdo
);

217  
	`logEº‹WôhSåögEº‹
(
ªsu…
, "CouldÇotÜoad VDO super block");

221 
ªsu…
 = 
	`vÆid©eSodiumVîsi⁄
(
vdo
);

222 i‡(
ªsu…
 !
VDO_SUCCESS
) {

223 
	`‰ìVDO
(&
vdo
);

224  
ªsu…
;

227 i‡(
	`isCuºítRñó£Vîsi⁄
(
vdo
)) {

228 
	`logInfo
("VDOálready up-to-date");

229 
	`‰ìVDO
(&
vdo
);

230  
VDO_SUCCESS
;

233 
ªsu…
 = 
	`decodeSodiumComp⁄ít
(
vdo
);

234 i‡(
ªsu…
 !
VDO_SUCCESS
) {

235 
	`‰ìVDO
(&
vdo
);

236  
ªsu…
;

239 i‡(
	`ªquúesRebuûd
(
vdo
)) {

241 
	`‰ìVDO
(&
vdo
);

242  
	`logEº‹WôhSåögEº‹
(
VDO_UNSUPPORTED_VERSION
,

246 
ªsu…
 = 
	`decodeVDOLayout
(
	`gëComp⁄ítBuf„r
(
vdo
->
su≥rBlock
), &vdo->
œyout
);

247 i‡(
ªsu…
 !
VDO_SUCCESS
) {

248 
	`‰ìVDO
(&
vdo
);

249  
ªsu…
;

252 c⁄° 
ThªadC⁄fig
 *
thªadC⁄fig
 = 
	`gëThªadC⁄fig
(
vdo
);

253 
ªsu…
 = 
	`ALLOCATE
(
thªadC⁄fig
->
ba£ThªadCou¡
, 
ThªadD©a
, 
__func__
,

254 &
vdo
->
thªadD©a
);

255 i‡(
ªsu…
 !
VDO_SUCCESS
) {

256 
	`‰ìVDO
(&
vdo
);

257  
ªsu…
;

260 
ThªadCou¡
 
thªad
 = 0;Åhªad < 
thªadC⁄fig
->
ba£ThªadCou¡
;

261 
thªad
++) {

262 
ªsu…
 = 
	`öôülizeThªadD©a
(&
vdo
->
thªadD©a
[
thªad
],Åhread,

263 (
vdo
->
°©e
 =
VDO_READ_ONLY_MODE
),

264 
thªadC⁄fig
, 
vdo
->
œyî
);

265 i‡(
ªsu…
 !
VDO_SUCCESS
) {

266 
	`‰ìVDO
(&
vdo
);

267  
ªsu…
;

271 
ªsu…
 = 
	`föishSodiumDecode
(
vdo
);

272 i‡(
ªsu…
 !
VDO_SUCCESS
) {

273 
	`‰ìVDO
(&
vdo
);

274  
ªsu…
;

278 
ªsu…
 = 
	`ßveVDOComp⁄íts
(
vdo
);

279 i‡(
ªsu…
 !
VDO_SUCCESS
) {

280 
	`‰ìVDO
(&
vdo
);

281  
ªsu…
;

284 
	`logInfo
("Successfully saved upgraded VDO");

285 
	`‰ìVDO
(&
vdo
);

287  
ªsu…
;

288 
	}
}

	@vdo/base/upgrade.h

22 #i‚de‡
UPGRADE_H


23 
	#UPGRADE_H


	)

25 
	~"ty≥s.h
"

34 
	$upgødePri‹VDO
(
PhysiˇlLayî
 *
œyî
)

35 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

	@vdo/base/vdo.c

27 
	~"vdoI¡î«l.h
"

29 
	~"buf„r.h
"

30 
	~"loggî.h
"

31 
	~"mem‹yAŒoc.h
"

33 
	~"admöCom∂ëi⁄.h
"

34 
	~"blockM≠.h
"

35 
	~"exã¡.h
"

36 
	~"hashZ⁄e.h
"

37 
	~"hódî.h
"

38 
	~"logiˇlZ⁄e.h
"

39 
	~"numUtûs.h
"

40 
	~"∑ckî.h
"

41 
	~"physiˇlZ⁄e.h
"

42 
	~"ªcovîyJou∫Æ.h
"

43 
	~"ªÀa£Vîsi⁄s.h
"

44 
	~"¶abDïŸ.h
"

45 
	~"¶abSumm¨y.h
"

46 
	~"°©i°ics.h
"

47 
	~"°©usCodes.h
"

48 
	~"thªadC⁄fig.h
"

49 
	~"vdoLayout.h
"

50 
	~"vioWrôe.h
"

60 c⁄° 
Vîsi⁄Numbî
 
	gVDO_MASTER_VERSION_67_0
 = {

61 .
maj‹Vîsi⁄
 = 67,

62 .
	gmö‹Vîsi⁄
 = 0,

65 c⁄° 
Vîsi⁄Numbî
 *
	gCURRENT_VDO_MASTER_VERSION


66 &
VDO_MASTER_VERSION_67_0
;

73 c⁄° 
Vîsi⁄Numbî
 
	gVDO_COMPONENT_DATA_41_0
 = {

74 .
maj‹Vîsi⁄
 = 41,

75 .
	gmö‹Vîsi⁄
 = 0,

78 c⁄° 
Vîsi⁄Numbî
 *
	gCURRENT_VDO_COMPONENT_DATA_VERSION


79 &
VDO_COMPONENT_DATA_41_0
;

86 
VDOSèã
 
	m°©e
;

87 
uöt64_t
 
	mcom∂ëeRecovîõs
;

88 
uöt64_t
 
	mªadO∆yRecovîõs
;

89 
VDOC⁄fig
 
	mc⁄fig
;

90 
N⁄˚
 
	mn⁄˚
;

91 } 
	t__©åibuã__
((
	t∑cked
)Ë
	tVDOComp⁄ít41_0
;

96 
boﬁ
 
	$isRódO∆yVDO
(*
c⁄ãxt
)

98  
	`gëThªadD©a
((
VDO
 *Ë
c⁄ãxt
)->
isRódO∆y
;

99 
	}
}

104 
	$íãrRódO∆yModeFromC⁄ãxt
(*
c⁄ãxt
, 
îr‹Code
)

106 
	`makeVDORódO∆y
((
VDO
 *Ë
c⁄ãxt
, 
îr‹Code
, 
åue
);

107 
	}
}

110 
	$ÆloˇãVDO
(
PhysiˇlLayî
 *
œyî
, 
VDO
 **
vdoPå
)

112 
ªsu…
 = 
	`ªgi°îSètusCodes
();

113 i‡(
ªsu…
 !
VDO_SUCCESS
) {

114  
ªsu…
;

117 
VDO
 *
vdo
;

118 
ªsu…
 = 
	`ALLOCATE
(1, 
VDO
, 
__func__
, &
vdo
);

119 i‡(
ªsu…
 !
UDS_SUCCESS
) {

120  
ªsu…
;

123 
vdo
->
œyî
 =Üayer;

124 
vdo
->
ªadO∆yC⁄ãxt
 = (
RódO∆yModeC⁄ãxt
) {

125 .
c⁄ãxt
 = 
vdo
,

126 .
isRódO∆y
 = 
isRódO∆yVDO
,

127 .
íãrRódO∆yMode
 = 
íãrRódO∆yModeFromC⁄ãxt
,

130 i‡(
œyî
->
¸óãEnqueuóbÀ
 !
NULL
) {

131 
ªsu…
 = 
	`makeAdmöCom∂ëi⁄
(
œyî
, &
vdo
->
admöCom∂ëi⁄
);

132 i‡(
ªsu…
 !
VDO_SUCCESS
) {

133 
	`‰ìVDO
(&
vdo
);

134  
ªsu…
;

138 *
vdoPå
 = 
vdo
;

139  
VDO_SUCCESS
;

140 
	}
}

143 
	$makeVDO
(
PhysiˇlLayî
 *
œyî
, 
VDO
 **
vdoPå
)

145 
VDO
 *
vdo
;

146 
ªsu…
 = 
	`ÆloˇãVDO
(
œyî
, &
vdo
);

147 i‡(
ªsu…
 !
VDO_SUCCESS
) {

148  
ªsu…
;

151 
ªsu…
 = 
	`makeZîoThªadC⁄fig
(&
vdo
->
lﬂdC⁄fig
.
thªadC⁄fig
);

152 i‡(
ªsu…
 !
VDO_SUCCESS
) {

153 
	`‰ìVDO
(&
vdo
);

154  
ªsu…
;

157 *
vdoPå
 = 
vdo
;

158  
VDO_SUCCESS
;

159 
	}
}

162 
	$de°royVDO
(
VDO
 *
vdo
)

164 
	`‰ìFlushî
(&
vdo
->
Êushî
);

165 
	`‰ìPackî
(&
vdo
->
∑ckî
);

166 
	`‰ìRecovîyJou∫Æ
(&
vdo
->
ªcovîyJou∫Æ
);

167 
	`‰ìSœbDïŸ
(&
vdo
->
dïŸ
);

168 
	`‰ìVDOLayout
(&
vdo
->
œyout
);

169 
	`‰ìSu≥rBlock
(&
vdo
->
su≥rBlock
);

170 
	`‰ìBlockM≠
(&
vdo
->
blockM≠
);

172 c⁄° 
ThªadC⁄fig
 *
thªadC⁄fig
 = 
	`gëThªadC⁄fig
(
vdo
);

173 i‡(
vdo
->
hashZ⁄es
 !
NULL
) {

174 
Z⁄eCou¡
 
z⁄e
 = 0; z⁄ê< 
thªadC⁄fig
->
hashZ⁄eCou¡
; zone++) {

175 
	`‰ìHashZ⁄e
(&
vdo
->
hashZ⁄es
[
z⁄e
]);

178 
	`FREE
(
vdo
->
hashZ⁄es
);

179 
vdo
->
hashZ⁄es
 = 
NULL
;

181 i‡(
vdo
->
logiˇlZ⁄es
 !
NULL
) {

182 
Z⁄eCou¡
 
z⁄e
 = 0; z⁄ê< 
thªadC⁄fig
->
logiˇlZ⁄eCou¡
; zone++) {

183 
	`‰ìLogiˇlZ⁄e
(&
vdo
->
logiˇlZ⁄es
[
z⁄e
]);

186 
	`FREE
(
vdo
->
logiˇlZ⁄es
);

187 
vdo
->
logiˇlZ⁄es
 = 
NULL
;

189 i‡(
vdo
->
physiˇlZ⁄es
 !
NULL
) {

190 
Z⁄eCou¡
 
z⁄e
 = 0; z⁄ê< 
thªadC⁄fig
->
physiˇlZ⁄eCou¡
; zone++) {

191 
	`‰ìPhysiˇlZ⁄e
(&
vdo
->
physiˇlZ⁄es
[
z⁄e
]);

194 
	`FREE
(
vdo
->
physiˇlZ⁄es
);

195 
vdo
->
physiˇlZ⁄es
 = 
NULL
;

197 i‡(
vdo
->
thªadD©a
 !
NULL
) {

198 
ThªadID
 
thªad
 = 0;Åhªad < 
thªadC⁄fig
->
ba£ThªadCou¡
;

199 
thªad
++) {

200 
	`unöôülizeThªadD©a
(&
vdo
->
thªadD©a
[
thªad
]);

202 
	`FREE
(
vdo
->
thªadD©a
);

203 
vdo
->
thªadD©a
 = 
NULL
;

206 
	`‰ìAdmöCom∂ëi⁄
(&
vdo
->
admöCom∂ëi⁄
);

207 
	`‰ìThªadC⁄fig
(&
vdo
->
lﬂdC⁄fig
.
thªadC⁄fig
);

208 
	}
}

211 
	$‰ìVDO
(
VDO
 **
vdoPå
)

213 i‡(*
vdoPå
 =
NULL
) {

217 
	`de°royVDO
(*
vdoPå
);

218 
	`FREE
(*
vdoPå
);

219 *
vdoPå
 = 
NULL
;

220 
	}
}

223 
size_t
 
	$vdoComp⁄ítSåu˘uªSize
()

225  (
VDOComp⁄ít41_0
);

226 
	}
}

229 
size_t
 
	$gëComp⁄ítD©aSize
(
VDO
 *
vdo
)

231  ((
Vîsi⁄Numbî
)

232 + (
Vîsi⁄Numbî
)

233 + 
	`vdoComp⁄ítSåu˘uªSize
()

234 + 
	`gëVDOLayoutEncodedSize
(
vdo
->
œyout
)

235 + 
	`gëRecovîyJou∫ÆEncodedSize
()

236 + 
	`gëSœbDïŸEncodedSize
()

237 + 
	`gëBlockM≠EncodedSize
());

238 
	}
}

247 
__©åibuã__
((
w¨n_unu£d_ªsu…
))

248 
	$ícodeMa°îVîsi⁄
(
Buf„r
 *
buf„r
)

250  
	`putByãs
(
buf„r
, (
Vîsi⁄Numbî
), 
CURRENT_VDO_MASTER_VERSION
);

251 
	}
}

261 
__©åibuã__
((
w¨n_unu£d_ªsu…
))

262 
	$ícodeVDOComp⁄ít
(c⁄° 
VDO
 *
vdo
, 
Buf„r
 *
buf„r
)

264 
ªsu…
 = 
	`putByãs
(
buf„r
, (
Vîsi⁄Numbî
),

265 
CURRENT_VDO_COMPONENT_DATA_VERSION
);

266 i‡(
ªsu…
 !
VDO_SUCCESS
) {

267  
ªsu…
;

270 
VDOComp⁄ít41_0
 
comp⁄ít
 = {

271 .
°©e
 = 
vdo
->state,

272 .
com∂ëeRecovîõs
 = 
vdo
->completeRecoveries,

273 .
ªadO∆yRecovîõs
 = 
vdo
->readOnlyRecoveries,

274 .
c⁄fig
 = 
vdo
->config,

275 .
n⁄˚
 = 
vdo
->nonce,

277  
	`putByãs
(
buf„r
, (
comp⁄ít
), &component);

278 
	}
}

281 
	$ícodeVDO
(
VDO
 *
vdo
)

283 
Buf„r
 *
buf„r
 = 
	`gëComp⁄ítBuf„r
(
vdo
->
su≥rBlock
);

284 
	`com∑˘Buf„r
(
buf„r
);

286 
ªsu…
 = 
	`ícodeMa°îVîsi⁄
(
buf„r
);

287 i‡(
ªsu…
 !
VDO_SUCCESS
) {

288  
ªsu…
;

291 
ªsu…
 = 
	`ícodeVDOComp⁄ít
(
vdo
, 
buf„r
);

292 i‡(
ªsu…
 !
VDO_SUCCESS
) {

293  
ªsu…
;

296 
ªsu…
 = 
	`ícodeVDOLayout
(
vdo
->
œyout
, 
buf„r
);

297 i‡(
ªsu…
 !
VDO_SUCCESS
) {

298  
ªsu…
;

301 
ªsu…
 = 
	`ícodeRecovîyJou∫Æ
(
vdo
->
ªcovîyJou∫Æ
, 
buf„r
);

302 i‡(
ªsu…
 !
VDO_SUCCESS
) {

303  
ªsu…
;

306 
ªsu…
 = 
	`ícodeSœbDïŸ
(
vdo
->
dïŸ
, 
buf„r
);

307 i‡(
ªsu…
 !
VDO_SUCCESS
) {

308  
ªsu…
;

311 
ªsu…
 = 
	`ícodeBlockM≠
(
vdo
->
blockM≠
, 
buf„r
);

312 i‡(
ªsu…
 !
VDO_SUCCESS
) {

313  
ªsu…
;

316 
	`ASSERT_LOG_ONLY
((
	`c⁄ã¡Lígth
(
buf„r
Ë=
	`gëComp⁄ítD©aSize
(
vdo
)),

318  
VDO_SUCCESS
;

319 
	}
}

322 
	$ßveVDOComp⁄íts
(
VDO
 *
vdo
)

324 
ªsu…
 = 
	`ícodeVDO
(
vdo
);

325 i‡(
ªsu…
 !
VDO_SUCCESS
) {

326  
ªsu…
;

329  
	`ßveSu≥rBlock
(
vdo
->
œyî
, vdo->
su≥rBlock
);

330 
	}
}

333 
	$ßveVDOComp⁄ítsAsync
(
VDO
 *
vdo
, 
VDOCom∂ëi⁄
 *
∑ª¡
)

335 
ªsu…
 = 
	`ícodeVDO
(
vdo
);

336 i‡(
ªsu…
 !
VDO_SUCCESS
) {

337 
	`föishCom∂ëi⁄
(
∑ª¡
, 
ªsu…
);

341 
	`ßveSu≥rBlockAsync
(
vdo
->
su≥rBlock
, 
∑ª¡
);

342 
	}
}

345 
	$ßveRec⁄figuªdVDO
(
VDO
 *
vdo
)

347 
Buf„r
 *
buf„r
 = 
	`gëComp⁄ítBuf„r
(
vdo
->
su≥rBlock
);

348 
size_t
 
comp⁄ítsSize
 = 
	`c⁄ã¡Lígth
(
buf„r
);

350 
byã
 *
comp⁄íts
;

351 
ªsu…
 = 
	`c›yByãs
(
buf„r
, 
comp⁄ítsSize
, &
comp⁄íts
);

352 i‡(
ªsu…
 !
VDO_SUCCESS
) {

353  
ªsu…
;

356 
	`com∑˘Buf„r
(
buf„r
);

357 
ªsu…
 = 
	`ícodeMa°îVîsi⁄
(
buf„r
);

358 i‡(
ªsu…
 !
VDO_SUCCESS
) {

359 
	`FREE
(
comp⁄íts
);

360  
ªsu…
;

363 
ªsu…
 = 
	`ícodeVDOComp⁄ít
(
vdo
, 
buf„r
);

364 i‡(
ªsu…
 !
VDO_SUCCESS
) {

365 
	`FREE
(
comp⁄íts
);

366  
ªsu…
;

369 
ªsu…
 = 
	`putByãs
(
buf„r
, 
comp⁄ítsSize
, 
comp⁄íts
);

370 
	`FREE
(
comp⁄íts
);

371 i‡(
ªsu…
 !
VDO_SUCCESS
) {

372  
ªsu…
;

375  
	`ßveSu≥rBlock
(
vdo
->
œyî
, vdo->
su≥rBlock
);

376 
	}
}

379 
boﬁ
 
	$upgødeRequúed
(c⁄° 
VDO
 *
vdo
)

381 
Rñó£Vîsi⁄Numbî
 
ªÀa£
 = 
	`gëLﬂdedRñó£Vîsi⁄
(
vdo
->
su≥rBlock
);

382 i‡(
ªÀa£
 !
CURRENT_RELEASE_VERSION_NUMBER
) {

383  
åue
;

385  
	`isUpgødabÀVîsi⁄
(
CURRENT_VDO_MASTER_VERSION
, &
vdo
->
lﬂdVîsi⁄
);

386 
	}
}

389 
	$decodeVDOVîsi⁄
(
VDO
 *
vdo
)

391  
	`gëByãsFromBuf„r
(
	`gëComp⁄ítBuf„r
(
vdo
->
su≥rBlock
),

392 (
Vîsi⁄Numbî
),

393 &
vdo
->
lﬂdVîsi⁄
);

394 
	}
}

397 
	$vÆid©eVDOVîsi⁄
(
VDO
 *
vdo
)

399 
ªsu…
 = 
	`decodeVDOVîsi⁄
(
vdo
);

400 i‡(
ªsu…
 !
VDO_SUCCESS
) {

401  
ªsu…
;

404 
Rñó£Vîsi⁄Numbî
 
lﬂdedVîsi⁄


405 
	`gëLﬂdedRñó£Vîsi⁄
(
vdo
->
su≥rBlock
);

406 i‡(
lﬂdedVîsi⁄
 !
CURRENT_RELEASE_VERSION_NUMBER
) {

407  
	`logEº‹WôhSåögEº‹
(
VDO_UNSUPPORTED_VERSION
,

409 
lﬂdedVîsi⁄
);

412  
	`vÆid©eVîsi⁄
(
CURRENT_VDO_MASTER_VERSION
, &
vdo
->
lﬂdVîsi⁄
,

414 
	}
}

417 
	$decodeVDOComp⁄ít
(
VDO
 *
vdo
)

419 
Buf„r
 *
buf„r
 = 
	`gëComp⁄ítBuf„r
(
vdo
->
su≥rBlock
);

421 
Vîsi⁄Numbî
 
vîsi⁄
;

422 
ªsu…
 = 
	`gëByãsFromBuf„r
(
buf„r
, (
Vîsi⁄Numbî
), &
vîsi⁄
);

423 i‡(
ªsu…
 !
VDO_SUCCESS
) {

424  
ªsu…
;

427 c⁄° 
Vîsi⁄Numbî
 *
cuºítVîsi⁄
 = 
CURRENT_VDO_COMPONENT_DATA_VERSION
;

428 i‡(!
	`¨eSameVîsi⁄
(
cuºítVîsi⁄
, &
vîsi⁄
)) {

429  
	`logEº‹WôhSåögEº‹
(
VDO_UNSUPPORTED_VERSION
,

432 
cuºítVîsi⁄
->
maj‹Vîsi⁄
,

433 
cuºítVîsi⁄
->
mö‹Vîsi⁄
,

434 
vîsi⁄
.
maj‹Vîsi⁄
,

435 
vîsi⁄
.
mö‹Vîsi⁄
);

438 
VDOComp⁄ít41_0
 
comp⁄ít
;

439 
ªsu…
 = 
	`gëByãsFromBuf„r
(
buf„r
, (
comp⁄ít
), &component);

440 i‡(
ªsu…
 !
VDO_SUCCESS
) {

441  
ªsu…
;

445 
vdo
->
°©e
 = 
comp⁄ít
.state;

446 
vdo
->
lﬂdSèã
 = 
comp⁄ít
.
°©e
;

447 
vdo
->
com∂ëeRecovîõs
 = 
comp⁄ít
.completeRecoveries;

448 
vdo
->
ªadO∆yRecovîõs
 = 
comp⁄ít
.readOnlyRecoveries;

449 
vdo
->
c⁄fig
 = 
comp⁄ít
.config;

450 
vdo
->
n⁄˚
 = 
comp⁄ít
.nonce;

451  
VDO_SUCCESS
;

452 
	}
}

455 
	$vÆid©eVDOC⁄fig
(c⁄° 
VDOC⁄fig
 *
c⁄fig
, 
BlockCou¡
 
blockCou¡
)

457 
ªsu…
 = 
	`ASSERT
(
c⁄fig
->
¶abSize
 > 0, "slab size unspecified");

458 i‡(
ªsu…
 !
UDS_SUCCESS
) {

459  
ªsu…
;

462 
ªsu…
 = 
	`ASSERT
(
	`isPowîOfTwo
(
c⁄fig
->
¶abSize
),

464 i‡(
ªsu…
 !
UDS_SUCCESS
) {

465  
ªsu…
;

468 
ªsu…
 = 
	`ASSERT
(
c⁄fig
->
¶abSize
 <(1 << 
MAX_SLAB_BITS
),

470 
MAX_SLAB_BITS
);

471 i‡(
ªsu…
 !
VDO_SUCCESS
) {

472  
ªsu…
;

475 
ªsu…
 = 
	`ASSERT
(
c⁄fig
->
¶abJou∫ÆBlocks
 >
MINIMUM_SLAB_JOURNAL_BLOCKS
,

477 i‡(
ªsu…
 !
UDS_SUCCESS
) {

478  
ªsu…
;

481 
ªsu…
 = 
	`ASSERT
(
c⁄fig
->
¶abJou∫ÆBlocks
 <c⁄fig->
¶abSize
,

483 i‡(
ªsu…
 !
UDS_SUCCESS
) {

484  
ªsu…
;

487 
SœbC⁄fig
 
¶abC⁄fig
;

488 
ªsu…
 = 
	`c⁄figuªSœb
(
c⁄fig
->
¶abSize
, c⁄fig->
¶abJou∫ÆBlocks
,

489 &
¶abC⁄fig
);

490 i‡(
ªsu…
 !
VDO_SUCCESS
) {

491  
ªsu…
;

494 
ªsu…
 = 
	`ASSERT
((
¶abC⁄fig
.
d©aBlocks
 >= 1),

496 i‡(
ªsu…
 !
UDS_SUCCESS
) {

497  
ªsu…
;

500 
ªsu…
 = 
	`ASSERT
(
c⁄fig
->
physiˇlBlocks
 > 0, "physical blocks unspecified");

501 i‡(
ªsu…
 !
UDS_SUCCESS
) {

502  
ªsu…
;

505 
ªsu…
 = 
	`ASSERT
(
c⁄fig
->
physiˇlBlocks
 <
MAXIMUM_PHYSICAL_BLOCKS
,

506 "physiˇ»block cou¡ %" 
PRIu64
 "Éxceeds maximum %" PRIu64,

507 
c⁄fig
->
physiˇlBlocks
, 
MAXIMUM_PHYSICAL_BLOCKS
);

508 i‡(
ªsu…
 !
UDS_SUCCESS
) {

509  
VDO_OUT_OF_RANGE
;

512 
ªsu…
 = 
	`ASSERT
(
c⁄fig
->
physiˇlBlocks
 <
blockCou¡
,

513 "Physiˇ»sizê%" 
PRIu64
 " in super block greaterÅhan"

514 " st‹agêsizê%" 
PRIu64
, 
c⁄fig
->
physiˇlBlocks
,

515 
blockCou¡
);

516 i‡(
ªsu…
 !
UDS_SUCCESS
) {

517  
VDO_PARAMETER_MISMATCH
;

520 
ªsu…
 = 
	`ASSERT
(
c⁄fig
->
logiˇlBlocks
 > 0, "logical blocks unspecified");

521 i‡(
ªsu…
 !
UDS_SUCCESS
) {

522  
ªsu…
;

525 
ªsu…
 = 
	`ASSERT
(
c⁄fig
->
logiˇlBlocks
 <
MAXIMUM_LOGICAL_BLOCKS
,

527 i‡(
ªsu…
 !
UDS_SUCCESS
) {

528  
ªsu…
;

531 
ªsu…
 = 
	`ASSERT
(
c⁄fig
->
ªcovîyJou∫ÆSize
 > 0,

533 i‡(
ªsu…
 !
UDS_SUCCESS
) {

534  
ªsu…
;

537 
ªsu…
 = 
	`ASSERT
(
	`isPowîOfTwo
(
c⁄fig
->
ªcovîyJou∫ÆSize
),

539 i‡(
ªsu…
 !
UDS_SUCCESS
) {

540  
ªsu…
;

543  
ªsu…
;

544 
	}
}

547 
ThªadD©a
 *
	$gëThªadD©a
(c⁄° 
VDO
 *
vdo
)

549  &
vdo
->
thªadD©a
[
	`gëCÆlbackThªadID
()];

550 
	}
}

553 
boﬁ
 
	$öRódO∆yMode
(c⁄° 
VDO
 *
vdo
)

555  (
vdo
->
°©e
 =
VDO_READ_ONLY_MODE
);

556 
	}
}

559 
boﬁ
 
	$isCÀ™
(c⁄° 
VDO
 *
vdo
)

561  ((
vdo
->
°©e
 =
VDO_CLEAN
Ë|| (vdo->°©ê=
VDO_NEW
));

562 
	}
}

565 
boﬁ
 
	$wasCÀ™
(c⁄° 
VDO
 *
vdo
)

567  ((
vdo
->
lﬂdSèã
 =
VDO_CLEAN
Ë|| (vdo->lﬂdSèã =
VDO_NEW
));

568 
	}
}

571 
boﬁ
 
	$wasNew
(c⁄° 
VDO
 *
vdo
)

573  (
vdo
->
lﬂdSèã
 =
VDO_NEW
);

574 
	}
}

577 
boﬁ
 
	$ªquúesRódO∆yRebuûd
(c⁄° 
VDO
 *
vdo
)

579  ((
vdo
->
lﬂdSèã
 =
VDO_FORCE_REBUILD
)

580 || (
vdo
->
lﬂdSèã
 =
VDO_REBUILD_FOR_UPGRADE
));

581 
	}
}

584 
boﬁ
 
	$ªquúesRebuûd
(c⁄° 
VDO
 *
vdo
)

586  ((
vdo
->
°©e
 =
VDO_DIRTY
)

587 || (
vdo
->
°©e
 =
VDO_FORCE_REBUILD
)

588 || (
vdo
->
°©e
 =
VDO_REPLAYING
)

589 || (
vdo
->
°©e
 =
VDO_REBUILD_FOR_UPGRADE
));

590 
	}
}

593 
boﬁ
 
	$ªquúesRecovîy
(c⁄° 
VDO
 *
vdo
)

595  ((
vdo
->
lﬂdSèã
 =
VDO_DIRTY
Ë|| (vdo->lﬂdSèã =
VDO_REPLAYING
)

596 || (
vdo
->
lﬂdSèã
 =
VDO_RECOVERING
));

597 
	}
}

600 
boﬁ
 
	$isRïœyög
(c⁄° 
VDO
 *
vdo
)

602  (
vdo
->
°©e
 =
VDO_REPLAYING
);

603 
	}
}

606 
boﬁ
 
	$öRecovîyMode
(c⁄° 
VDO
 *
vdo
)

608  (
vdo
->
°©e
 =
VDO_RECOVERING
);

609 
	}
}

612 
	$íãrRecovîyMode
(
VDO
 *
vdo
)

614 
	`as£πOnAdmöThªad
(
vdo
, 
__func__
);

616 i‡(
	`isRódO∆yVDO
(
vdo
)) {

620 
	`logInfo
("EnteringÑecovery mode");

621 
vdo
->
°©e
 = 
VDO_RECOVERING
;

622 
	}
}

625 
	$ÀaveRecovîyMode
(
VDO
 *
vdo
)

627 
	`as£πOnAdmöThªad
(
vdo
, 
__func__
);

633 i‡(
vdo
->
˛o£Reque°ed
 || 
	`isRódO∆yVDO
(vdo)) {

637 
	`ASSERT_LOG_ONLY
(
	`öRecovîyMode
(
vdo
), "VDO is inÑecovery mode");

638 
	`logInfo
("ExitingÑecovery mode");

639 
vdo
->
°©e
 = 
VDO_DIRTY
;

640 
	}
}

643 
bót
(
VDO
 *
vdo
 
__©åibuã__
((
unu£d
)),

644 
ThªadID
 
id
 
__©åibuã__
((
unu£d
)))

650 
boﬁ
 
	$£tVDOCom¥essög
(
VDO
 *
vdo
, 
boﬁ
 
íabÀCom¥essi⁄
)

652 
boﬁ
 
°©eCh™ged
 = 
	`com∑ªAndSw≠Boﬁ
(&
vdo
->
com¥essög
, !
íabÀCom¥essi⁄
,

653 
íabÀCom¥essi⁄
);

654 i‡(
°©eCh™ged
 && !
íabÀCom¥essi⁄
) {

657 
	`ÊushPackî
(
vdo
->
∑ckî
);

660 
	`logInfo
("com¥essi⁄ i†%s", (
íabÀCom¥essi⁄
 ? "enabled" : "disabled"));

661  (
°©eCh™ged
 ? !
íabÀCom¥essi⁄
 :ÉnableCompression);

662 
	}
}

665 
boﬁ
 
	$gëVDOCom¥essög
(
VDO
 *
vdo
)

667  
	`©omicLﬂdBoﬁ
(&
vdo
->
com¥essög
);

668 
	}
}

671 
size_t
 
	$gëBlockM≠CacheSize
(c⁄° 
VDO
 *
vdo
)

673  ((
size_t
Ë
vdo
->
lﬂdC⁄fig
.
ˇcheSize
Ë* 
VDO_BLOCK_SIZE
;

674 
	}
}

683 c⁄° *
	$des¸ibeVDOSèã
(
VDOSèã
 
°©e
)

686 
°©e
) {

687 
VDO_RECOVERING
:

690 
VDO_READ_ONLY_MODE
:

696 
	}
}

705 
Eº‹Sèti°ics
 
	$gëVDOEº‹Sèti°ics
(c⁄° 
VDO
 *
vdo
)

712 c⁄° 
AtomicEº‹Sèti°ics
 *
©oms
 = &
vdo
->
îr‹Sèts
;

713  (
Eº‹Sèti°ics
) {

714 .
övÆidAdvi˚PBNCou¡
 = 
	`ªœxedLﬂd64
(&
©oms
->invalidAdvicePBNCount),

715 .
övÆidRﬁlovîPBNCou¡
 = 
	`ªœxedLﬂd64
(&
©oms
->invalidRolloverPBNCount),

716 .
dedu≥DódlockAvoid™˚Cou¡


717 
	`ªœxedLﬂd64
(&
©oms
->
dedu≥DódlockAvoid™˚Cou¡
),

718 .
noS∑˚Eº‹Cou¡
 = 
	`ªœxedLﬂd64
(&
©oms
->noSpaceErrorCount),

719 .
ªadO∆yEº‹Cou¡
 = 
	`ªœxedLﬂd64
(&
©oms
->readOnlyErrorCount),

721 
	}
}

724 
	$gëVDOSèti°ics
(c⁄° 
VDO
 *
vdo
, 
VDOSèti°ics
 *
°©s
)

728 
RecovîyJou∫Æ
 *
jou∫Æ
 = 
vdo
->
ªcovîyJou∫Æ
;

729 
SœbDïŸ
 *
dïŸ
 = 
vdo
->depot;

732 
°©s
->
vîsi⁄
 = 
STATISTICS_VERSION
;

733 
°©s
->
ªÀa£Vîsi⁄
 = 
CURRENT_RELEASE_VERSION_NUMBER
;

734 
°©s
->
logiˇlBlocks
 = 
vdo
->
c⁄fig
.logicalBlocks;

735 
°©s
->
physiˇlBlocks
 = 
vdo
->
c⁄fig
.physicalBlocks;

736 
°©s
->
blockSize
 = 
VDO_BLOCK_SIZE
;

737 
°©s
->
com∂ëeRecovîõs
 = 
vdo
->completeRecoveries;

738 
°©s
->
ªadO∆yRecovîõs
 = 
vdo
->readOnlyRecoveries;

739 
°©s
->
blockM≠CacheSize
 = 
	`gëBlockM≠CacheSize
(
vdo
);

740 
	`¢¥ötf
(
°©s
->
wrôePﬁicy
, (stats->writePolicy), "%s",

741 ((
	`gëWrôePﬁicy
(
vdo
Ë=
WRITE_POLICY_ASYNC
) ? "async" : "sync"));

744 
°©s
->
d©aBlocksU£d
 = 
	`gëPhysiˇlBlocksAŒoˇãd
(
vdo
);

745 
°©s
->
ovîhódBlocksU£d
 = 
	`gëPhysiˇlBlocksOvîhód
(
vdo
);

746 
°©s
->
logiˇlBlocksU£d
 = 
	`gëJou∫ÆLogiˇlBlocksU£d
(
jou∫Æ
);

747 
°©s
->
Æloˇt‹
 = 
	`gëDïŸBlockAŒoˇt‹Sèti°ics
(
dïŸ
);

748 
°©s
->
jou∫Æ
 = 
	`gëRecovîyJou∫ÆSèti°ics
(journal);

749 
°©s
->
∑ckî
 = 
	`gëPackîSèti°ics
(
vdo
->packer);

750 
°©s
->
¶abJou∫Æ
 = 
	`gëDïŸSœbJou∫ÆSèti°ics
(
dïŸ
);

751 
°©s
->
¶abSumm¨y
 = 
	`gëSœbSumm¨ySèti°ics
(
	`gëSœbSumm¨y
(
dïŸ
));

752 
°©s
->
ªfCou¡s
 = 
	`gëDïŸRefCou¡sSèti°ics
(
dïŸ
);

753 
°©s
->
blockM≠
 = 
	`gëBlockM≠Sèti°ics
(
vdo
->blockMap);

754 
°©s
->
îr‹s
 = 
	`gëVDOEº‹Sèti°ics
(
vdo
);

755 
SœbCou¡
 
¶abTŸÆ
 = 
	`gëDïŸSœbCou¡
(
dïŸ
);

756 
°©s
->
ªcovîyPî˚¡age


757 (
¶abTŸÆ
 - 
	`gëDïŸUƒecovîedSœbCou¡
(
dïŸ
)) * 100 / slabTotal;

760 
VDOSèã
 
°©e
 = *((c⁄° vﬁ©ûêVDOSèã *Ë&
vdo
->state);

761 
°©s
->
öRecovîyMode
 = (
°©e
 =
VDO_RECOVERING
);

762 
	`¢¥ötf
(
°©s
->
mode
, (°©s->mode), "%s", 
	`des¸ibeVDOSèã
(
°©e
));

763 
	}
}

766 
BlockCou¡
 
	$gëPhysiˇlBlocksAŒoˇãd
(c⁄° 
VDO
 *
vdo
)

768  (
	`gëDïŸAŒoˇãdBlocks
(
vdo
->
dïŸ
)

769 - 
	`gëJou∫ÆBlockM≠D©aBlocksU£d
(
vdo
->
ªcovîyJou∫Æ
));

770 
	}
}

773 
BlockCou¡
 
	$gëPhysiˇlBlocksFªe
(c⁄° 
VDO
 *
vdo
)

775  
	`gëDïŸFªeBlocks
(
vdo
->
dïŸ
);

776 
	}
}

779 
BlockCou¡
 
	$gëPhysiˇlBlocksOvîhód
(c⁄° 
VDO
 *
vdo
)

783  (
vdo
->
c⁄fig
.
physiˇlBlocks


784 - 
	`gëDïŸD©aBlocks
(
vdo
->
dïŸ
)

785 + 
	`gëJou∫ÆBlockM≠D©aBlocksU£d
(
vdo
->
ªcovîyJou∫Æ
));

786 
	}
}

789 
BlockCou¡
 
	$gëTŸÆBlockM≠Blocks
(c⁄° 
VDO
 *
vdo
)

791  (
	`gëNumbîOfFixedBlockM≠Pages
(
vdo
->
blockM≠
)

792 + 
	`gëJou∫ÆBlockM≠D©aBlocksU£d
(
vdo
->
ªcovîyJou∫Æ
));

793 
	}
}

796 
WrôePﬁicy
 
	$gëWrôePﬁicy
(c⁄° 
VDO
 *
vdo
)

798  
vdo
->
lﬂdC⁄fig
.
wrôePﬁicy
;

799 
	}
}

802 
	$£tWrôePﬁicy
(
VDO
 *
vdo
, 
WrôePﬁicy
 
√w
)

804 
vdo
->
lﬂdC⁄fig
.
wrôePﬁicy
 = 
√w
;

805 
	}
}

808 c⁄° 
VDOLﬂdC⁄fig
 *
	$gëVDOLﬂdC⁄fig
(c⁄° 
VDO
 *
vdo
)

810  &
vdo
->
lﬂdC⁄fig
;

811 
	}
}

814 c⁄° 
ThªadC⁄fig
 *
	$gëThªadC⁄fig
(c⁄° 
VDO
 *
vdo
)

816  
vdo
->
lﬂdC⁄fig
.
thªadC⁄fig
;

817 
	}
}

820 
BlockCou¡
 
	$gëC⁄figuªdBlockM≠MaximumAge
(c⁄° 
VDO
 *
vdo
)

822  
vdo
->
lﬂdC⁄fig
.
maximumAge
;

823 
	}
}

826 
PageCou¡
 
	$gëC⁄figuªdCacheSize
(c⁄° 
VDO
 *
vdo
)

828  
vdo
->
lﬂdC⁄fig
.
ˇcheSize
;

829 
	}
}

832 
BlockM≠
 *
	$gëBlockM≠
(c⁄° 
VDO
 *
vdo
)

834  
vdo
->
blockM≠
;

835 
	}
}

838 
SœbDïŸ
 *
	$gëSœbDïŸ
(
VDO
 *
vdo
)

840  
vdo
->
dïŸ
;

841 
	}
}

844 
RecovîyJou∫Æ
 *
	$gëRecovîyJou∫Æ
(
VDO
 *
vdo
)

846  
vdo
->
ªcovîyJou∫Æ
;

847 
	}
}

850 
	$dumpVDOSètus
(c⁄° 
VDO
 *
vdo
)

852 
	`dumpFlushî
(
vdo
->
Êushî
);

853 
	`dumpRecovîyJou∫ÆSèti°ics
(
vdo
->
ªcovîyJou∫Æ
);

854 
	`dumpPackî
(
vdo
->
∑ckî
);

855 
	`dumpSœbDïŸ
(
vdo
->
dïŸ
);

857 c⁄° 
ThªadC⁄fig
 *
thªadC⁄fig
 = 
	`gëThªadC⁄fig
(
vdo
);

858 
Z⁄eCou¡
 
z⁄e
 = 0; z⁄ê< 
thªadC⁄fig
->
logiˇlZ⁄eCou¡
; zone++) {

859 
	`dumpLogiˇlZ⁄e
(
vdo
->
logiˇlZ⁄es
[
z⁄e
]);

862 
Z⁄eCou¡
 
z⁄e
 = 0; z⁄ê< 
thªadC⁄fig
->
physiˇlZ⁄eCou¡
; zone++) {

863 
	`dumpPhysiˇlZ⁄e
(
vdo
->
physiˇlZ⁄es
[
z⁄e
]);

865 
	}
}

868 
	$£tVDOTøcögFœgs
(
VDO
 *
vdo
, 
boﬁ
 
vioTøcög
)

870 
vdo
->
vioTø˚Rec‹dög
 = 
vioTøcög
;

871 
	}
}

874 
boﬁ
 
	$vdoVIOTøcögE«bÀd
(c⁄° 
VDO
 *
vdo
)

876  ((
vdo
 !
NULL
Ë&& vdo->
vioTø˚Rec‹dög
);

877 
	}
}

880 
	$as£πOnAdmöThªad
(
VDO
 *
vdo
, c⁄° *
«me
)

882 
	`ASSERT_LOG_ONLY
((
	`gëCÆlbackThªadID
()

883 =
	`gëAdmöThªad
(
	`gëThªadC⁄fig
(
vdo
))),

884 "%†ˇŒed o¿admöÅhªad", 
«me
);

885 
	}
}

888 
	$as£πOnLogiˇlZ⁄eThªad
(c⁄° 
VDO
 *
vdo
,

889 
Z⁄eCou¡
 
logiˇlZ⁄e
,

890 c⁄° *
«me
)

892 
	`ASSERT_LOG_ONLY
((
	`gëCÆlbackThªadID
()

893 =
	`gëLogiˇlZ⁄eThªad
(
	`gëThªadC⁄fig
(
vdo
), 
logiˇlZ⁄e
)),

894 "%†ˇŒed o¿logiˇ»thªad", 
«me
);

895 
	}
}

898 
HashZ⁄e
 *
	$£À˘HashZ⁄e
(c⁄° 
VDO
 *
vdo
, c⁄° 
UdsChunkName
 *
«me
)

907 
uöt32_t
 
hash
 = 
«me
->name[0];

916  
vdo
->
hashZ⁄es
[(
hash
 * 
	`gëThªadC⁄fig
(vdo)->
hashZ⁄eCou¡
) >> 8];

917 
	}
}

920 
	$gëPhysiˇlZ⁄e
(c⁄° 
VDO
 *
vdo
,

921 
PhysiˇlBlockNumbî
 
pbn
,

922 
PhysiˇlZ⁄e
 **
z⁄ePå
)

924 i‡(
pbn
 =
ZERO_BLOCK
) {

925 *
z⁄ePå
 = 
NULL
;

926  
VDO_SUCCESS
;

931 i‡(!
	`isPhysiˇlD©aBlock
(
vdo
->
dïŸ
, 
pbn
)) {

932  
VDO_OUT_OF_RANGE
;

936 
Sœb
 *
¶ab
 = 
	`gëSœb
(
vdo
->
dïŸ
, 
pbn
);

937 
ªsu…
 = 
	`ASSERT
(
¶ab
 !
NULL
, "getSlab must succeed onáll valid PBNs");

938 i‡(
ªsu…
 !
VDO_SUCCESS
) {

939  
ªsu…
;

942 *
z⁄ePå
 = 
vdo
->
physiˇlZ⁄es
[
	`gëSœbZ⁄eNumbî
(
¶ab
)];

943  
VDO_SUCCESS
;

944 
	}
}

947 
Z⁄edPBN
 
	$vÆid©eDedu≥Advi˚
(
VDO
 *
vdo
,

948 c⁄° 
D©aLoˇti⁄
 *
advi˚
,

949 
LogiˇlBlockNumbî
 
lbn
)

951 
Z⁄edPBN
 
noAdvi˚
 = { .
pbn
 = 
ZERO_BLOCK
 };

952 i‡(
advi˚
 =
NULL
) {

953  
noAdvi˚
;

957 i‡((
advi˚
->
°©e
 =
MAPPING_STATE_UNMAPPED
)

958 || (
advi˚
->
pbn
 =
ZERO_BLOCK
)) {

959 
	`logDebug
("InvÆidádvi˚ from dedu∂iˇti⁄ sîvî:Öb¿%" 
PRIu64
 ", "

960 "°©ê%u. Givög u∞⁄ dedu∂iˇti⁄ o‡logiˇ»block %" 
PRIu64
,

961 
advi˚
->
pbn
,ádvi˚->
°©e
, 
lbn
);

962 
	`©omicAdd64
(&
vdo
->
îr‹Sèts
.
övÆidAdvi˚PBNCou¡
, 1);

963  
noAdvi˚
;

966 
PhysiˇlZ⁄e
 *
z⁄e
;

967 
ªsu…
 = 
	`gëPhysiˇlZ⁄e
(
vdo
, 
advi˚
->
pbn
, &
z⁄e
);

968 i‡((
ªsu…
 !
VDO_SUCCESS
Ë|| (
z⁄e
 =
NULL
)) {

969 
	`logDebug
("InvalidÖhysical blockÇumber from deduplication server: %"

970 
PRIu64
 ", giving up on deduplication ofÜogical block %" PRIu64,

971 
advi˚
->
pbn
, 
lbn
);

972 
	`©omicAdd64
(&
vdo
->
îr‹Sèts
.
övÆidAdvi˚PBNCou¡
, 1);

973  
noAdvi˚
;

976  (
Z⁄edPBN
) {

977 .
pbn
 = 
advi˚
->pbn,

978 .
°©e
 = 
advi˚
->state,

979 .
z⁄e
 = zone,

981 
	}
}

	@vdo/base/vdo.h

22 #i‚de‡
VDO_H


23 
	#VDO_H


	)

25 
	~"ty≥s.h
"

35 
	$ÆloˇãVDO
(
PhysiˇlLayî
 *
œyî
, 
VDO
 **
vdoPå
)

36 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

46 
	$makeVDO
(
PhysiˇlLayî
 *
œyî
, 
VDO
 **
vdoPå
)

47 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

54 
	`de°royVDO
(
VDO
 *
vdo
);

61 
	`‰ìVDO
(
VDO
 **
vdoPå
);

70 
	`bót
(
VDO
 *
vdo
, 
ThªadID
 
id
);

80 
boﬁ
 
	`£tVDOCom¥essög
(
VDO
 *
vdo
, boﬁ 
íabÀCom¥essi⁄
);

89 
boﬁ
 
	`gëVDOCom¥essög
(
VDO
 *
vdo
);

97 
	`gëVDOSèti°ics
(c⁄° 
VDO
 *
vdo
, 
VDOSèti°ics
 *
°©s
);

106 
BlockCou¡
 
	$gëPhysiˇlBlocksAŒoˇãd
(c⁄° 
VDO
 *
vdo
)

107 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

116 
BlockCou¡
 
	$gëPhysiˇlBlocksFªe
(c⁄° 
VDO
 *
vdo
)

117 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

126 
BlockCou¡
 
	$gëPhysiˇlBlocksOvîhód
(c⁄° 
VDO
 *
vdo
)

127 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

136 
BlockCou¡
 
	$gëTŸÆBlockM≠Blocks
(c⁄° 
VDO
 *
vdo
)

137 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

146 
WrôePﬁicy
 
	`gëWrôePﬁicy
(c⁄° 
VDO
 *
vdo
);

154 
	`£tWrôePﬁicy
(
VDO
 *
vdo
, 
WrôePﬁicy
 
√w
);

163 c⁄° 
VDOLﬂdC⁄fig
 *
	$gëVDOLﬂdC⁄fig
(c⁄° 
VDO
 *
vdo
)

164 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

173 c⁄° 
ThªadC⁄fig
 *
	$gëThªadC⁄fig
(c⁄° 
VDO
 *
vdo
)

174 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

183 
BlockCou¡
 
	$gëC⁄figuªdBlockM≠MaximumAge
(c⁄° 
VDO
 *
vdo
)

184 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

193 
PageCou¡
 
	$gëC⁄figuªdCacheSize
(c⁄° 
VDO
 *
vdo
)

194 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

211 
Z⁄edPBN
 
	$vÆid©eDedu≥Advi˚
(
VDO
 *
vdo
,

212 c⁄° 
D©aLoˇti⁄
 *
advi˚
,

213 
LogiˇlBlockNumbî
 
lbn
)

214 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

223 
	`dumpVDOSètus
(c⁄° 
VDO
 *
vdo
);

231 
	`£tVDOTøcögFœgs
(
VDO
 *
vdo
, 
boﬁ
 
vioTøcög
);

240 
boﬁ
 
	`vdoVIOTøcögE«bÀd
(c⁄° 
VDO
 *
vdo
);

249 
boﬁ
 
	`vdoExã¡TøcögE«bÀd
(c⁄° 
VDO
 *
vdo
);

	@vdo/base/vdoClose.c

22 
	~"vdoClo£.h
"

24 
	~"loggî.h
"

26 
	~"admöCom∂ëi⁄.h
"

27 
	~"blockM≠.h
"

28 
	~"com∂ëi⁄.h
"

29 
	~"logiˇlZ⁄e.h
"

30 
	~"ªcovîyJou∫Æ.h
"

31 
	~"¶abDïŸ.h
"

32 
	~"¶abSumm¨y.h
"

33 
	~"thªadC⁄fig.h
"

34 
	~"vdoI¡î«l.h
"

44 
ölöe
 
VDO
 *
	$vdoFromClo£SubTask
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

46  
	`vdoFromAdmöSubTask
(
com∂ëi⁄
, 
ADMIN_OPERATION_CLOSE
);

47 
	}
}

55 
	$h™dÀSubTaskEº‹
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

57 
	`logEº‹WôhSåögEº‹
(
com∂ëi⁄
->
ªsu…
, "Error closing VDO");

58 
	`£tCom∂ëi⁄Resu…
(
com∂ëi⁄
->
∑ª¡
, com∂ëi⁄->
ªsu…
);

59 
	`ª£tCom∂ëi⁄
(
com∂ëi⁄
);

60 
	`com∂ëeCom∂ëi⁄
(
com∂ëi⁄
);

61 
	}
}

71 
	$¥ï¨eSubTask
(
VDO
 *
vdo
, 
VDOA˘i⁄
 *
ˇŒback
, 
ThªadID
 
thªadID
)

73 
	`¥ï¨eAdmöSubTaskOnThªad
(
vdo
, 
ˇŒback
, 
h™dÀSubTaskEº‹
, 
thªadID
);

74 
	}
}

82 
	$wrôeSu≥rBlockF‹Clo£
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

84 
VDO
 *
vdo
 = 
	`vdoFromClo£SubTask
(
com∂ëi⁄
);

85 
	`¥ï¨eToFöishP¨ít
(
com∂ëi⁄
, com∂ëi⁄->
∑ª¡
);

86 
VDOCom∂ëi⁄
 *
∑ª¡
 = (VDOCom∂ëi⁄ *Ë
com∂ëi⁄
->parent;

87 i‡(
∑ª¡
->
ªsu…
 !
VDO_SUCCESS
) {

89 
	`com∂ëeCom∂ëi⁄
(
com∂ëi⁄
);

93 
vdo
->
°©e
) {

94 
VDO_DIRTY
:

95 
VDO_NEW
:

96 
VDO_CLEAN
:

97 
vdo
->
°©e
 = 
VDO_CLEAN
;

100 
VDO_READ_ONLY_MODE
:

101 
VDO_FORCE_REBUILD
:

102 
VDO_RECOVERING
:

103 
VDO_REBUILD_FOR_UPGRADE
:

106 
VDO_REPLAYING
:

108 
	`föishCom∂ëi⁄
(
com∂ëi⁄
, 
UDS_BAD_STATE
);

112 
	`ßveVDOComp⁄ítsAsync
(
vdo
, 
com∂ëi⁄
);

113 
	}
}

122 
	$waôF‹RódO∆yMode
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

124 
VDO
 *
vdo
 = 
	`vdoFromClo£SubTask
(
com∂ëi⁄
);

125 
	`¥ï¨eSubTask
(
vdo
, 
wrôeSu≥rBlockF‹Clo£
,

126 
	`gëAdmöThªad
(
	`gëThªadC⁄fig
(
vdo
)));

127 
	`waôU¡ûNŸE¡îögRódO∆yMode
(
vdo
, 
com∂ëi⁄
);

128 
	}
}

137 
	$ßveDïŸ
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

139 
VDO
 *
vdo
 = 
	`vdoFromClo£SubTask
(
com∂ëi⁄
);

140 
	`¥ï¨eSubTask
(
vdo
, 
waôF‹RódO∆yMode
,

141 
	`gëAdmöThªad
(
	`gëThªadC⁄fig
(
vdo
)));

142 
	`ßveSœbDïŸ
(
vdo
->
dïŸ
, 
åue
, 
com∂ëi⁄
);

143 
	}
}

151 
	$˛o£Jou∫Æ
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

153 
VDO
 *
vdo
 = 
	`vdoFromClo£SubTask
(
com∂ëi⁄
);

154 
	`¥ï¨eSubTask
(
vdo
, 
ßveDïŸ
, 
	`gëAdmöThªad
(
	`gëThªadC⁄fig
(vdo)));

155 
	`˛o£RecovîyJou∫Æ
(
vdo
->
ªcovîyJou∫Æ
, 
com∂ëi⁄
);

156 
	}
}

164 
	$˛o£M≠
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

166 
VDO
 *
vdo
 = 
	`vdoFromClo£SubTask
(
com∂ëi⁄
);

167 
	`¥ï¨eSubTask
(
vdo
, 
˛o£Jou∫Æ
,

168 
	`gëJou∫ÆZ⁄eThªad
(
	`gëThªadC⁄fig
(
vdo
)));

169 
	`˛o£BlockM≠
(
vdo
->
blockM≠
, 
com∂ëi⁄
);

170 
	}
}

178 
	$˛o£LogiˇlZ⁄es
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

180 
VDO
 *
vdo
 = 
	`vdoFromClo£SubTask
(
com∂ëi⁄
);

181 
	`¥ï¨eSubTask
(
vdo
, 
˛o£M≠
, 
	`gëAdmöThªad
(
	`gëThªadC⁄fig
(vdo)));

182 
	`˛o£LogiˇlZ⁄e
(
vdo
->
logiˇlZ⁄es
[0], 
com∂ëi⁄
);

183 
	}
}

190 
	$˛o£Com¥essi⁄Packî
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

192 
VDO
 *
vdo
 = 
	`vdoFromClo£SubTask
(
com∂ëi⁄
);

193 
	`¥ï¨eSubTask
(
vdo
, 
˛o£LogiˇlZ⁄es
,

194 
	`gëLogiˇlZ⁄eThªad
(
	`gëThªadC⁄fig
(
vdo
), 0));

195 
	`˛o£Packî
(
vdo
->
∑ckî
, 
com∂ëi⁄
);

196 
	}
}

203 
	$˛o£CÆlback
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

205 
VDO
 *
vdo
 = 
	`vdoFromClo£SubTask
(
com∂ëi⁄
);

206 
	`as£πOnAdmöThªad
(
vdo
, 
__func__
);

207 
vdo
->
˛o£Reque°ed
 = 
åue
;

208 i‡(!
vdo
->
˛o£Requúed
) {

209 
	`föishP¨ítCÆlback
(
com∂ëi⁄
);

213 
	`¥ï¨eSubTask
(
vdo
, 
˛o£Com¥essi⁄Packî
,

214 
	`gëPackîZ⁄eThªad
(
	`gëThªadC⁄fig
(
vdo
)));

215 
	`waôU¡ûNŸE¡îögRódO∆yMode
(
vdo
, 
com∂ëi⁄
);

216 
	}
}

219 
	$≥rf‹mVDOClo£
(
VDO
 *
vdo
)

221  
	`≥rf‹mAdmöO≥øti⁄
(
vdo
, 
ADMIN_OPERATION_CLOSE
, 
˛o£CÆlback
);

222 
	}
}

	@vdo/base/vdoClose.h

22 #i‚de‡
VDO_CLOSE_H


23 
	#VDO_CLOSE_H


	)

25 
	~"ty≥s.h
"

35 
≥rf‹mVDOClo£
(
VDO
 *
vdo
);

	@vdo/base/vdoDebug.c

22 
	~"vdoDebug.h
"

24 
	~"loggî.h
"

25 
	~"°rögUtûs.h
"

26 
	~"vdoI¡î«l.h
"

28 c⁄° 
	gxLogDebugMesßge
[] = "x-log-debug-message";

31 
	$öôülizeVDOComm™dCom∂ëi⁄
(
VDOComm™dCom∂ëi⁄
 *
comm™d
,

32 
VDO
 *
vdo
,

33 
¨gc
,

34 **
¨gv
)

36 *
comm™d
 = (
VDOComm™dCom∂ëi⁄
) {

37 .
vdo
 = vdo,

38 .
¨gc
 =árgc,

39 .
¨gv
 =árgv,

41 
	`öôülizeCom∂ëi⁄
(&
comm™d
->
com∂ëi⁄
, 
VDO_COMMAND_COMPLETION
,

42 
vdo
->
œyî
);

43  
	`öôülizeEnqueuóbÀCom∂ëi⁄
(&
comm™d
->
subCom∂ëi⁄
,

44 
VDO_COMMAND_SUB_COMPLETION
,

45 
vdo
->
œyî
);

46 
	}
}

49 
	$de°royVDOComm™dCom∂ëi⁄
(
VDOComm™dCom∂ëi⁄
 *
comm™d
)

51 i‡(
comm™d
 =
NULL
) {

52  
VDO_SUCCESS
;

55 
	`de°royEnqueuóbÀ
(&
comm™d
->
subCom∂ëi⁄
);

56  
comm™d
->
com∂ëi⁄
.
ªsu…
;

57 
	}
}

60 
ölöe
 
VDOComm™dCom∂ëi⁄
 *

61 
	$asVDOComm™dCom∂ëi⁄
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

63 i‡(
com∂ëi⁄
->
ty≥
 =
VDO_COMMAND_COMPLETION
) {

64  (
VDOComm™dCom∂ëi⁄
 *)

65 ((
uöçå_t
Ë
com∂ëi⁄
 - 
	`off£tof
(
VDOComm™dCom∂ëi⁄
, completion));

66 } i‡(
com∂ëi⁄
->
ty≥
 =
VDO_COMMAND_SUB_COMPLETION
) {

67  (
VDOComm™dCom∂ëi⁄
 *)

68 ((
uöçå_t
Ë
com∂ëi⁄
 - 
	`off£tof
(
VDOComm™dCom∂ëi⁄
, 
subCom∂ëi⁄
));

70 
	`ASSERT_LOG_ONLY
(((
com∂ëi⁄
->
ty≥
 =
VDO_COMMAND_COMPLETION
) ||

71 (
com∂ëi⁄
->
ty≥
 =
VDO_COMMAND_SUB_COMPLETION
)),

74 
	`gëCom∂ëi⁄Ty≥Name
(
com∂ëi⁄
->
ty≥
));

75  
NULL
;

77 
	}
}

80 
	$logDebugMesßge
(
VDOComm™dCom∂ëi⁄
 *
cmd
)

82 
buf„r
[256];

84 *
buf
 = 
buf„r
;

85 *
íd
 = 
buf„r
 + (buffer);

87 
i
 = 1; i < 
cmd
->
¨gc
; ++i) {

88 
buf
 = 
	`≠≥ndToBuf„r
(buf, 
íd
, " %s", 
cmd
->
¨gv
[
i
]);

90 i‡(
buf
 =
íd
) {

91 
	`°r˝y
(
buf
 - 4, "...");

93 
	`logInfo
("debug mesßge:%s", 
buf„r
);

94 
	`föishCom∂ëi⁄
(&
cmd
->
com∂ëi⁄
, 
VDO_SUCCESS
);

95 
	}
}

98 
	$execuãVDOExãndedComm™d
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

100 
VDOComm™dCom∂ëi⁄
 *
cmd
 = 
	`asVDOComm™dCom∂ëi⁄
(
com∂ëi⁄
);

102 i‡((
cmd
->
vdo
 =
NULL
Ë|| (cmd->
¨gc
 == 0)) {

103 
	`föishCom∂ëi⁄
(&
cmd
->
com∂ëi⁄
, 
VDO_COMMAND_ERROR
);

106 i‡(
	`°rcmp
(
cmd
->
¨gv
[0], 
xLogDebugMesßge
) == 0) {

107 
	`logDebugMesßge
(
cmd
);

109 
	`föishCom∂ëi⁄
(&
cmd
->
com∂ëi⁄
, 
VDO_UNKNOWN_COMMAND
);

111 
	}
}

	@vdo/base/vdoDebug.h

22 #i‚de‡
VDO_DEBUG_H


23 
	#VDO_DEBUG_H


	)

25 
	~"com∂ëi⁄.h
"

26 
	~"vdo.h
"

39 
	svdoComm™dCom∂ëi⁄
 {

40 
VDOCom∂ëi⁄
 
	mcom∂ëi⁄
;

41 
VDOCom∂ëi⁄
 
	msubCom∂ëi⁄
;

42 
VDO
 *
	mvdo
;

43 
	m¨gc
;

44 **
	m¨gv
;

45 } 
	tVDOComm™dCom∂ëi⁄
;

57 
öôülizeVDOComm™dCom∂ëi⁄
(
VDOComm™dCom∂ëi⁄
 *
comm™d
,

58 
VDO
 *
vdo
,

59 
¨gc
,

60 **
¨gv
);

69 
de°royVDOComm™dCom∂ëi⁄
(
VDOComm™dCom∂ëi⁄
 *
comm™d
);

76 
execuãVDOExãndedComm™d
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
);

	@vdo/base/vdoInternal.h

22 #i‚de‡
VDO_INTERNAL_H


23 
	#VDO_INTERNAL_H


	)

25 
	~"vdo.h
"

27 
	~"utû/©omic.h
"

29 
	~"hódî.h
"

30 
	~"∑ckî.h
"

31 
	~"ªadO∆yModeC⁄ãxtI¡î«ls.h
"

32 
	~"°©i°ics.h
"

33 
	~"su≥rBlock.h
"

34 
	~"thªadD©a.h
"

35 
	~"uds.h
"

36 
	~"vdoLayout.h
"

42 
	s©omicEº‹Sèti°ics
 {

44 
Atomic64
 
	mövÆidAdvi˚PBNCou¡
;

45 
Atomic64
 
	mövÆidRﬁlovîPBNCou¡
;

46 
Atomic64
 
	mdedu≥DódlockAvoid™˚Cou¡
;

47 
Atomic64
 
	mnoS∑˚Eº‹Cou¡
;

48 
Atomic64
 
	mªadO∆yEº‹Cou¡
;

49 } 
	tAtomicEº‹Sèti°ics
;

51 
	svdo
 {

53 
VDOSèã
 
	m°©e
;

55 
RódO∆yModeC⁄ãxt
 
	mªadO∆yC⁄ãxt
;

57 
uöt64_t
 
	mcom∂ëeRecovîõs
;

59 
uöt64_t
 
	mªadO∆yRecovîõs
;

61 
VDOC⁄fig
 
	mc⁄fig
;

63 
VDOLﬂdC⁄fig
 
	mlﬂdC⁄fig
;

65 
N⁄˚
 
	mn⁄˚
;

68 
Su≥rBlock
 *
	msu≥rBlock
;

71 
PhysiˇlLayî
 *
	mœyî
;

74 
VDOLayout
 *
	mœyout
;

77 
BlockM≠
 *
	mblockM≠
;

80 
RecovîyJou∫Æ
 *
	mªcovîyJou∫Æ
;

83 
SœbDïŸ
 *
	mdïŸ
;

86 
Packî
 *
	m∑ckî
;

88 
AtomicBoﬁ
 
	mcom¥essög
;

91 
Flushî
 *
	mÊushî
;

94 
Vîsi⁄Numbî
 
	mlﬂdVîsi⁄
;

96 
VDOSèã
 
	mlﬂdSèã
;

98 
boﬁ
 
	mvioTø˚Rec‹dög
;

101 
ThªadD©a
 *
	mthªadD©a
;

104 
LogiˇlZ⁄e
 **
	mlogiˇlZ⁄es
;

107 
PhysiˇlZ⁄e
 **
	mphysiˇlZ⁄es
;

110 
HashZ⁄e
 **
	mhashZ⁄es
;

113 
AdmöCom∂ëi⁄
 *
	madmöCom∂ëi⁄
;

116 
boﬁ
 
	m˛o£Requúed
;

119 
boﬁ
 
	m˛o£Reque°ed
;

122 
AtomicEº‹Sèti°ics
 
	mîr‹Sèts
;

132 
size_t
 
	$gëComp⁄ítD©aSize
(
VDO
 *
vdo
)

133 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

142 
	$ßveVDOComp⁄íts
(
VDO
 *
vdo
)

143 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

153 
	`ßveVDOComp⁄ítsAsync
(
VDO
 *
vdo
, 
VDOCom∂ëi⁄
 *
∑ª¡
);

164 
	$ßveRec⁄figuªdVDO
(
VDO
 *
vdo
)

165 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

174 
boﬁ
 
	$upgødeRequúed
(c⁄° 
VDO
 *
vdo
)

175 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

181 
	$decodeVDOVîsi⁄
(
VDO
 *
vdo
)

182 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

192 
	$vÆid©eVDOVîsi⁄
(
VDO
 *
vdo
)

193 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

203 
	$decodeVDOComp⁄ít
(
VDO
 *
vdo
)

204 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

214 
	$vÆid©eVDOC⁄fig
(c⁄° 
VDOC⁄fig
 *
c⁄fig
, 
BlockCou¡
 
blockCou¡
)

215 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

222 
ThªadD©a
 *
	$gëThªadD©a
(c⁄° 
VDO
 *
vdo
)

223 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

232 
BlockM≠
 *
	$gëBlockM≠
(c⁄° 
VDO
 *
vdo
)

233 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

242 
SœbDïŸ
 *
	$gëSœbDïŸ
(
VDO
 *
vdo
)

243 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

252 
RecovîyJou∫Æ
 *
	$gëRecovîyJou∫Æ
(
VDO
 *
vdo
)

253 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

262 
boﬁ
 
	$öRódO∆yMode
(c⁄° 
VDO
 *
vdo
)

263 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

272 
boﬁ
 
	$isCÀ™
(c⁄° 
VDO
 *
vdo
)

273 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

282 
boﬁ
 
	$wasCÀ™
(c⁄° 
VDO
 *
vdo
)

283 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

292 
boﬁ
 
	$wasNew
(c⁄° 
VDO
 *
vdo
)

293 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

302 
boﬁ
 
	$ªquúesRódO∆yRebuûd
(c⁄° 
VDO
 *
vdo
)

303 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

312 
boﬁ
 
	$ªquúesRebuûd
(c⁄° 
VDO
 *
vdo
)

313 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

322 
boﬁ
 
	$ªquúesRecovîy
(c⁄° 
VDO
 *
vdo
)

323 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

334 
boﬁ
 
	$isRïœyög
(c⁄° 
VDO
 *
vdo
)

335 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

344 
boﬁ
 
	$öRecovîyMode
(c⁄° 
VDO
 *
vdo
)

345 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

352 
	`íãrRecovîyMode
(
VDO
 *
vdo
);

359 
	`ÀaveRecovîyMode
(
VDO
 *
vdo
);

368 
	`as£πOnAdmöThªad
(
VDO
 *
vdo
, c⁄° *
«me
);

377 
	`as£πOnLogiˇlZ⁄eThªad
(c⁄° 
VDO
 *
vdo
,

378 
Z⁄eCou¡
 
logiˇlZ⁄e
,

379 c⁄° *
«me
);

389 
HashZ⁄e
 *
	$£À˘HashZ⁄e
(c⁄° 
VDO
 *
vdo
, c⁄° 
UdsChunkName
 *
«me
)

390 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

407 
	$gëPhysiˇlZ⁄e
(c⁄° 
VDO
 *
vdo
,

408 
PhysiˇlBlockNumbî
 
pbn
,

409 
PhysiˇlZ⁄e
 **
z⁄ePå
)

410 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

418 
size_t
 
	$vdoComp⁄ítSåu˘uªSize
()

419 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

424 
	`sh¨eBlock
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
);

	@vdo/base/vdoLayout.c

22 
	~"vdoLayout.h
"

23 
	~"vdoLayoutI¡î«ls.h
"

25 
	~"loggî.h
"

26 
	~"mem‹yAŒoc.h
"

28 
	~"blockM≠.h
"

29 
	~"∑πôi⁄C›y.h
"

30 
	~"¶ab.h
"

31 
	~"¶abSumm¨y.h
"

32 
	~"ty≥s.h
"

33 
	~"vdoI¡î«l.h
"

35 
	~"°©usCodes.h
"

37 c⁄° 
P¨tôi⁄ID
 
	gREQUIRED_PARTITIONS
[] = {

38 
BLOCK_MAP_PARTITION
,

39 
BLOCK_ALLOCATOR_PARTITION
,

40 
RECOVERY_JOURNAL_PARTITION
,

41 
SLAB_SUMMARY_PARTITION
,

44 c⁄° 
uöt8_t
 
	gREQUIRED_PARTITION_COUNT
 = 4;

58 
__©åibuã__
((
w¨n_unu£d_ªsu…
))

59 
	$makeVDOFixedLayout
(
BlockCou¡
 
physiˇlBlocks
,

60 
PhysiˇlBlockNumbî
 
°¨tögOff£t
,

61 
BlockCou¡
 
blockM≠Blocks
,

62 
BlockCou¡
 
jou∫ÆBlocks
,

63 
BlockCou¡
 
summ¨yBlocks
,

64 
FixedLayout
 **
œyoutPå
)

66 
FixedLayout
 *
œyout
;

67 
ªsu…
 = 
	`makeFixedLayout
(
physiˇlBlocks
 - 
°¨tögOff£t
,

68 
°¨tögOff£t
, &
œyout
);

69 i‡(
ªsu…
 !
VDO_SUCCESS
) {

70  
ªsu…
;

73 
ªsu…
 = 
	`makeFixedLayoutP¨tôi⁄
(
œyout
, 
BLOCK_MAP_PARTITION
,

74 
blockM≠Blocks
, 
FROM_BEGINNING
, 0);

75 i‡(
ªsu…
 !
VDO_SUCCESS
) {

76 
	`‰ìFixedLayout
(&
œyout
);

77  
ªsu…
;

80 
ªsu…
 = 
	`makeFixedLayoutP¨tôi⁄
(
œyout
, 
SLAB_SUMMARY_PARTITION
,

81 
summ¨yBlocks
, 
FROM_END
, 0);

82 i‡(
ªsu…
 !
VDO_SUCCESS
) {

83 
	`‰ìFixedLayout
(&
œyout
);

84  
ªsu…
;

87 
ªsu…
 = 
	`makeFixedLayoutP¨tôi⁄
(
œyout
, 
RECOVERY_JOURNAL_PARTITION
,

88 
jou∫ÆBlocks
, 
FROM_END
, 0);

89 i‡(
ªsu…
 !
VDO_SUCCESS
) {

90 
	`‰ìFixedLayout
(&
œyout
);

91  
ªsu…
;

100 
ªsu…
 = 
	`makeFixedLayoutP¨tôi⁄
(
œyout
, 
BLOCK_ALLOCATOR_PARTITION
,

101 
ALL_FREE_BLOCKS
, 
FROM_BEGINNING
,

102 
blockM≠Blocks
);

103 i‡(
ªsu…
 !
VDO_SUCCESS
) {

104 
	`‰ìFixedLayout
(&
œyout
);

105  
ªsu…
;

108 *
œyoutPå
 = 
œyout
;

109  
VDO_SUCCESS
;

110 
	}
}

120 
__©åibuã__
((
w¨n_unu£d_ªsu…
))

121 
BlockCou¡
 
	$gëP¨tôi⁄Off£t
(
VDOLayout
 *
œyout
,

122 
P¨tôi⁄ID
 
∑πôi⁄ID
)

124  
	`gëFixedLayoutP¨tôi⁄Off£t
(
	`gëVDOP¨tôi⁄
(
œyout
, 
∑πôi⁄ID
));

125 
	}
}

128 
	$makeVDOLayout
(
BlockCou¡
 
physiˇlBlocks
,

129 
PhysiˇlBlockNumbî
 
°¨tögOff£t
,

130 
BlockCou¡
 
blockM≠Blocks
,

131 
BlockCou¡
 
jou∫ÆBlocks
,

132 
BlockCou¡
 
summ¨yBlocks
,

133 
VDOLayout
 **
vdoLayoutPå
)

135 
VDOLayout
 *
vdoLayout
;

136 
ªsu…
 = 
	`ALLOCATE
(1, 
VDOLayout
, 
__func__
, &
vdoLayout
);

137 i‡(
ªsu…
 !
VDO_SUCCESS
) {

138  
ªsu…
;

141 
ªsu…
 = 
	`makeVDOFixedLayout
(
physiˇlBlocks
, 
°¨tögOff£t
, 
blockM≠Blocks
,

142 
jou∫ÆBlocks
, 
summ¨yBlocks
, &
vdoLayout
->
œyout
);

143 i‡(
ªsu…
 !
VDO_SUCCESS
) {

144 
	`‰ìVDOLayout
(&
vdoLayout
);

147 
vdoLayout
->
°¨tögOff£t
 = startingOffset;

149 *
vdoLayoutPå
 = 
vdoLayout
;

150  
VDO_SUCCESS
;

151 
	}
}

154 
	$decodeVDOLayout
(
Buf„r
 *
buf„r
, 
VDOLayout
 **
vdoLayoutPå
)

156 
VDOLayout
 *
vdoLayout
;

157 
ªsu…
 = 
	`ALLOCATE
(1, 
VDOLayout
, 
__func__
, &
vdoLayout
);

158 i‡(
ªsu…
 !
VDO_SUCCESS
) {

159  
ªsu…
;

162 
ªsu…
 = 
	`decodeFixedLayout
(
buf„r
, &
vdoLayout
->
œyout
);

163 i‡(
ªsu…
 !
VDO_SUCCESS
) {

164 
	`‰ìVDOLayout
(&
vdoLayout
);

165  
ªsu…
;

169 
P¨tôi⁄
 *
∑πôi⁄
;

170 
uöt8_t
 
i
 = 0; i < 
REQUIRED_PARTITION_COUNT
; i++) {

171 
ªsu…
 = 
	`gëP¨tôi⁄
(
vdoLayout
->
œyout
, 
REQUIRED_PARTITIONS
[
i
],

172 &
∑πôi⁄
);

173 i‡(
ªsu…
 !
VDO_SUCCESS
) {

174 
	`‰ìVDOLayout
(&
vdoLayout
);

175  
	`logEº‹WôhSåögEº‹
(
ªsu…
,

177 " %u", 
REQUIRED_PARTITIONS
[
i
]);

182 
vdoLayout
->
°¨tögOff£t


183 
	`gëP¨tôi⁄Off£t
(
vdoLayout
, 
BLOCK_MAP_PARTITION
);

185 *
vdoLayoutPå
 = 
vdoLayout
;

186  
VDO_SUCCESS
;

187 
	}
}

190 
	$‰ìVDOLayout
(
VDOLayout
 **
vdoLayoutPå
)

192 
VDOLayout
 *
vdoLayout
 = *
vdoLayoutPå
;

193 i‡(
vdoLayout
 =
NULL
) {

197 
	`‰ìFixedLayout
(&
vdoLayout
->
√xtLayout
);

198 
	`‰ìFixedLayout
(&
vdoLayout
->
œyout
);

199 
	`‰ìFixedLayout
(&
vdoLayout
->
¥eviousLayout
);

200 
	`FREE
(
vdoLayout
);

201 *
vdoLayoutPå
 = 
NULL
;

202 
	}
}

213 
__©åibuã__
((
w¨n_unu£d_ªsu…
))

214 
P¨tôi⁄
 *
	$ªåõveP¨tôi⁄
(
FixedLayout
 *
œyout
, 
P¨tôi⁄ID
 
id
)

216 
P¨tôi⁄
 *
∑πôi⁄
;

217 
ªsu…
 = 
	`gëP¨tôi⁄
(
œyout
, 
id
, &
∑πôi⁄
);

218 
	`ASSERT_LOG_ONLY
(
ªsu…
 =
VDO_SUCCESS
, "VDOLayout hasÉxpectedÖartition");

219  
∑πôi⁄
;

220 
	}
}

223 
P¨tôi⁄
 *
	$gëVDOP¨tôi⁄
(
VDOLayout
 *
vdoLayout
, 
P¨tôi⁄ID
 
id
)

225  
	`ªåõveP¨tôi⁄
(
vdoLayout
->
œyout
, 
id
);

226 
	}
}

237 
__©åibuã__
((
w¨n_unu£d_ªsu…
))

238 
P¨tôi⁄
 *
	$gëP¨tôi⁄FromNextLayout
(
VDOLayout
 *
vdoLayout
,

239 
P¨tôi⁄ID
 
id
)

241 
	`ASSERT_LOG_ONLY
(
vdoLayout
->
√xtLayout
 !
NULL
,

243  
	`ªåõveP¨tôi⁄
(
vdoLayout
->
√xtLayout
, 
id
);

244 
	}
}

254 
__©åibuã__
((
w¨n_unu£d_ªsu…
))

255 
BlockCou¡
 
	$gëP¨tôi⁄Size
(
VDOLayout
 *
œyout
, 
P¨tôi⁄ID
 
∑πôi⁄ID
)

257  
	`gëFixedLayoutP¨tôi⁄Size
(
	`gëVDOP¨tôi⁄
(
œyout
, 
∑πôi⁄ID
));

258 
	}
}

261 
	$¥ï¨eToGrowVDOLayout
(
VDOLayout
 *
vdoLayout
,

262 
BlockCou¡
 
ﬁdPhysiˇlBlocks
,

263 
BlockCou¡
 
√wPhysiˇlBlocks
)

265 i‡(
	`gëNextVDOLayoutSize
(
vdoLayout
Ë=
√wPhysiˇlBlocks
) {

267  
VDO_SUCCESS
;

271 
	`‰ìFixedLayout
(&
vdoLayout
->
√xtLayout
);

275 
ªsu…
 = 
	`makeVDOFixedLayout
(
√wPhysiˇlBlocks
,

276 
vdoLayout
->
°¨tögOff£t
,

277 
	`gëP¨tôi⁄Size
(
vdoLayout
,

278 
BLOCK_MAP_PARTITION
),

279 
	`gëP¨tôi⁄Size
(
vdoLayout
,

280 
RECOVERY_JOURNAL_PARTITION
),

281 
	`gëP¨tôi⁄Size
(
vdoLayout
,

282 
SLAB_SUMMARY_PARTITION
),

283 &
vdoLayout
->
√xtLayout
);

284 i‡(
ªsu…
 !
VDO_SUCCESS
) {

285  
ªsu…
;

289 
P¨tôi⁄
 *
¶abSumm¨yP¨tôi⁄


290 
	`gëP¨tôi⁄FromNextLayout
(
vdoLayout
, 
SLAB_SUMMARY_PARTITION
);

291 
P¨tôi⁄
 *
ªcovîyJou∫ÆP¨tôi⁄


292 
	`gëP¨tôi⁄FromNextLayout
(
vdoLayout
, 
RECOVERY_JOURNAL_PARTITION
);

293 
BlockCou¡
 
möNewSize


294 (
ﬁdPhysiˇlBlocks


295 + 
	`gëFixedLayoutP¨tôi⁄Size
(
¶abSumm¨yP¨tôi⁄
)

296 + 
	`gëFixedLayoutP¨tôi⁄Size
(
ªcovîyJou∫ÆP¨tôi⁄
));

297 i‡(
möNewSize
 > 
√wPhysiˇlBlocks
) {

299 
	`‰ìFixedLayout
(&
vdoLayout
->
√xtLayout
);

300  
VDO_INCREMENT_TOO_SMALL
;

303  
VDO_SUCCESS
;

304 
	}
}

315 
__©åibuã__
((
w¨n_unu£d_ªsu…
))

316 
BlockCou¡
 
	$gëVDOSize
(
FixedLayout
 *
œyout
, 
BlockCou¡
 
°¨tögOff£t
)

320  
	`gëTŸÆFixedLayoutSize
(
œyout
Ë+ 
°¨tögOff£t
;

321 
	}
}

324 
BlockCou¡
 
	$gëNextVDOLayoutSize
(
VDOLayout
 *
vdoLayout
)

326  ((
vdoLayout
->
√xtLayout
 =
NULL
)

327 ? 0 : 
	`gëVDOSize
(
vdoLayout
->
√xtLayout
, vdoLayout->
°¨tögOff£t
));

328 
	}
}

331 
BlockCou¡
 
	$gëNextBlockAŒoˇt‹P¨tôi⁄Size
(
VDOLayout
 *
vdoLayout
)

333 i‡(
vdoLayout
->
√xtLayout
 =
NULL
) {

337 
P¨tôi⁄
 *
∑πôi⁄
 = 
	`gëP¨tôi⁄FromNextLayout
(
vdoLayout
,

338 
BLOCK_ALLOCATOR_PARTITION
);

339  
	`gëFixedLayoutP¨tôi⁄Size
(
∑πôi⁄
);

340 
	}
}

343 
BlockCou¡
 
	$growVDOLayout
(
VDOLayout
 *
vdoLayout
)

345 
	`ASSERT_LOG_ONLY
(
vdoLayout
->
√xtLayout
 !
NULL
,

347 
vdoLayout
->
¥eviousLayout
 = vdoLayout->
œyout
;

348 
vdoLayout
->
œyout
 = vdoLayout->
√xtLayout
;

349 
vdoLayout
->
√xtLayout
 = 
NULL
;

351  
	`gëVDOSize
(
vdoLayout
->
œyout
, vdoLayout->
°¨tögOff£t
);

352 
	}
}

355 
BlockCou¡
 
	$ªvîtVDOLayout
(
VDOLayout
 *
vdoLayout
)

357 i‡((
vdoLayout
->
¥eviousLayout
 !
NULL
)

358 && (
vdoLayout
->
¥eviousLayout
 !vdoLayout->
œyout
)) {

360 
	`‰ìFixedLayout
(&
vdoLayout
->
œyout
);

361 
vdoLayout
->
œyout
 = vdoLayout->
¥eviousLayout
;

362 
vdoLayout
->
¥eviousLayout
 = 
NULL
;

365  
	`gëVDOSize
(
vdoLayout
->
œyout
, vdoLayout->
°¨tögOff£t
);

366 
	}
}

369 
	$föishVDOLayoutGrowth
(
VDOLayout
 *
vdoLayout
)

371 i‡(
vdoLayout
->
œyout
 !vdoLayout->
¥eviousLayout
) {

372 
	`‰ìFixedLayout
(&
vdoLayout
->
¥eviousLayout
);

375 i‡(
vdoLayout
->
œyout
 !vdoLayout->
√xtLayout
) {

376 
	`‰ìFixedLayout
(&
vdoLayout
->
√xtLayout
);

378 
	}
}

381 
	$c›yP¨tôi⁄
(
VDOLayout
 *
œyout
,

382 
P¨tôi⁄ID
 
∑πôi⁄ID
,

383 
VDOCom∂ëi⁄
 *
∑ª¡
)

385 
	`c›yP¨tôi⁄Async
(
∑ª¡
->
œyî
, 
	`gëVDOP¨tôi⁄
(
œyout
, 
∑πôi⁄ID
),

386 
	`gëP¨tôi⁄FromNextLayout
(
œyout
, 
∑πôi⁄ID
), 
∑ª¡
);

387 
	}
}

390 
size_t
 
	$gëVDOLayoutEncodedSize
(c⁄° 
VDOLayout
 *
vdoLayout
)

392  
	`gëFixedLayoutEncodedSize
(
vdoLayout
->
œyout
);

393 
	}
}

396 
	$ícodeVDOLayout
(c⁄° 
VDOLayout
 *
vdoLayout
, 
Buf„r
 *
buf„r
)

398  
	`ícodeFixedLayout
(
vdoLayout
->
œyout
, 
buf„r
);

399 
	}
}

	@vdo/base/vdoLayout.h

34 #i‚de‡
VDO_LAYOUT_H


35 
	#VDO_LAYOUT_H


	)

37 
	~"fixedLayout.h
"

38 
	~"ty≥s.h
"

52 
	$makeVDOLayout
(
BlockCou¡
 
physiˇlBlocks
,

53 
PhysiˇlBlockNumbî
 
°¨tögOff£t
,

54 
BlockCou¡
 
blockM≠Blocks
,

55 
BlockCou¡
 
jou∫ÆBlocks
,

56 
BlockCou¡
 
summ¨yBlocks
,

57 
VDOLayout
 **
vdoLayoutPå
)

58 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

68 
	$decodeVDOLayout
(
Buf„r
 *
buf„r
, 
VDOLayout
 **
vdoLayoutPå
)

69 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

76 
	`‰ìVDOLayout
(
VDOLayout
 **
vdoLayoutPå
);

87 
P¨tôi⁄
 *
	$gëVDOP¨tôi⁄
(
VDOLayout
 *
vdoLayout
, 
P¨tôi⁄ID
 
id
)

88 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

99 
	$¥ï¨eToGrowVDOLayout
(
VDOLayout
 *
vdoLayout
,

100 
BlockCou¡
 
ﬁdPhysiˇlBlocks
,

101 
BlockCou¡
 
√wPhysiˇlBlocks
)

102 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

112 
BlockCou¡
 
	$gëNextVDOLayoutSize
(
VDOLayout
 *
vdoLayout
)

113 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

123 
BlockCou¡
 
	$gëNextBlockAŒoˇt‹P¨tôi⁄Size
(
VDOLayout
 *
vdoLayout
)

124 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

133 
BlockCou¡
 
	$growVDOLayout
(
VDOLayout
 *
vdoLayout
)

134 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

143 
BlockCou¡
 
	$ªvîtVDOLayout
(
VDOLayout
 *
vdoLayout
)

144 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

151 
	`föishVDOLayoutGrowth
(
VDOLayout
 *
vdoLayout
);

161 
	`c›yP¨tôi⁄
(
VDOLayout
 *
œyout
,

162 
P¨tôi⁄ID
 
∑πôi⁄ID
,

163 
VDOCom∂ëi⁄
 *
∑ª¡
);

172 
size_t
 
	$gëVDOLayoutEncodedSize
(c⁄° 
VDOLayout
 *
vdoLayout
)

173 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

183 
	$ícodeVDOLayout
(c⁄° 
VDOLayout
 *
vdoLayout
, 
Buf„r
 *
buf„r
)

184 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

	@vdo/base/vdoLayoutInternals.h

22 #i‚de‡
VDO_LAYOUT_INTERNALS_H


23 
	#VDO_LAYOUT_INTERNALS_H


	)

25 
	~"fixedLayout.h
"

26 
	~"ty≥s.h
"

28 
	svdoLayout
 {

30 
FixedLayout
 *
	mœyout
;

32 
FixedLayout
 *
	m√xtLayout
;

34 
FixedLayout
 *
	m¥eviousLayout
;

36 
PhysiˇlBlockNumbî
 
	m°¨tögOff£t
;

	@vdo/base/vdoLoad.c

22 
	~"vdoLﬂd.h
"

24 
	~"loggî.h
"

25 
	~"mem‹yAŒoc.h
"

27 
	~"admöCom∂ëi⁄.h
"

28 
	~"blockM≠.h
"

29 
	~"com∂ëi⁄.h
"

30 
	~"c⁄°™ts.h
"

31 
	~"hashZ⁄e.h
"

32 
	~"hódî.h
"

33 
	~"logiˇlZ⁄e.h
"

34 
	~"physiˇlZ⁄e.h
"

35 
	~"ªadO∆yRebuûd.h
"

36 
	~"ªcovîyJou∫Æ.h
"

37 
	~"ªÀa£Vîsi⁄s.h
"

38 
	~"¶abDïŸ.h
"

39 
	~"¶abSumm¨y.h
"

40 
	~"thªadC⁄fig.h
"

41 
	~"ty≥s.h
"

42 
	~"vdoI¡î«l.h
"

43 
	~"vdoRecovîy.h
"

53 
ölöe
 
VDO
 *
	$vdoFromLﬂdSubTask
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

55  
	`vdoFromAdmöSubTask
(
com∂ëi⁄
, 
ADMIN_OPERATION_LOAD
);

56 
	}
}

64 
	$föishAb‹tög
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

66 
VDO
 *
vdo
 = 
	`vdoFromLﬂdSubTask
(
com∂ëi⁄
);

67 
vdo
->
˛o£Requúed
 = 
Ál£
;

68 
	`föishP¨ítCÆlback
(
com∂ëi⁄
);

69 
	}
}

76 
	$˛o£RecovîyJou∫ÆF‹Ab‹t
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

78 
VDO
 *
vdo
 = 
	`vdoFromLﬂdSubTask
(
com∂ëi⁄
);

79 
	`¥ï¨eAdmöSubTask
(
vdo
, 
föishAb‹tög
, finishAborting);

80 
	`˛o£RecovîyJou∫Æ
(
vdo
->
ªcovîyJou∫Æ
, 
com∂ëi⁄
);

81 
	}
}

89 
	$ab‹tLﬂd
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

91 
VDO
 *
vdo
 = 
	`vdoFromLﬂdSubTask
(
com∂ëi⁄
);

92 
	`logEº‹WôhSåögEº‹
(
com∂ëi⁄
->
ªsu…
, "abortingÜoad");

93 i‡(
vdo
->
thªadD©a
 =
NULL
) {

95 
	`föishP¨ítCÆlback
(
com∂ëi⁄
);

100 
	`£tCom∂ëi⁄Resu…
(
com∂ëi⁄
->
∑ª¡
, com∂ëi⁄->
ªsu…
);

101 i‡(
vdo
->
ªcovîyJou∫Æ
 =
NULL
) {

102 
	`¥ï¨eAdmöSubTask
(
vdo
, 
föishAb‹tög
, finishAborting);

104 
	`¥ï¨eAdmöSubTaskOnThªad
(
vdo
, 
˛o£RecovîyJou∫ÆF‹Ab‹t
,

105 
˛o£RecovîyJou∫ÆF‹Ab‹t
,

106 
	`gëJou∫ÆZ⁄eThªad
(
	`gëThªadC⁄fig
(
vdo
)));

109 
	`waôU¡ûNŸE¡îögRódO∆yMode
(
vdo
, 
com∂ëi⁄
);

110 
	}
}

117 
	$waôF‹RódO∆yMode
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

119 
	`¥ï¨eToFöishP¨ít
(
com∂ëi⁄
, com∂ëi⁄->
∑ª¡
);

120 
	`£tCom∂ëi⁄Resu…
(
com∂ëi⁄
, 
VDO_READ_ONLY
);

121 
	`waôU¡ûNŸE¡îögRódO∆yMode
(
	`vdoFromLﬂdSubTask
(
com∂ëi⁄
), completion);

122 
	}
}

131 
	$c⁄töueLﬂdRódO∆y
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

133 
VDO
 *
vdo
 = 
	`vdoFromLﬂdSubTask
(
com∂ëi⁄
);

134 
	`logEº‹WôhSåögEº‹
(
com∂ëi⁄
->
ªsu…
,

136 
	`makeVDORódO∆y
(
vdo
, 
com∂ëi⁄
->
ªsu…
, 
åue
);

137 
	`waôF‹RódO∆yMode
(
com∂ëi⁄
);

138 
	}
}

146 
	$föishS¸ubbögSœbs
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

148 
VDO
 *
vdo
 = 
com∂ëi⁄
->
∑ª¡
;

149 
	`as£πOnAdmöThªad
(
vdo
, 
__func__
);

150 i‡(
	`öRecovîyMode
(
vdo
)) {

151 
	`ÀaveRecovîyMode
(
vdo
);

153 
	}
}

161 
	$h™dÀS¸ubAŒEº‹
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

163 
VDO
 *
vdo
 = 
com∂ëi⁄
->
∑ª¡
;

164 
	`íãrRódO∆yMode
(&
vdo
->
ªadO∆yC⁄ãxt
, 
com∂ëi⁄
->
ªsu…
);

165 
	}
}

173 
	$s¸ubSœbs
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

175 
VDO
 *
vdo
 = 
	`vdoFromLﬂdSubTask
(
com∂ëi⁄
);

176 i‡(!
	`hasUƒecovîedSœbs
(
vdo
->
dïŸ
)) {

177 
	`föishP¨ítCÆlback
(
com∂ëi⁄
);

181 i‡(
	`ªquúesRecovîy
(
vdo
)) {

182 
	`íãrRecovîyMode
(
vdo
);

185 
	`¥ï¨eAdmöSubTask
(
vdo
, 
föishP¨ítCÆlback
, 
c⁄töueLﬂdRódO∆y
);

186 
	`s¸ubAŒUƒecovîedSœbs
(
vdo
->
dïŸ
, vdo, 
föishS¸ubbögSœbs
,

187 
h™dÀS¸ubAŒEº‹
, 0, 
com∂ëi⁄
);

188 
	}
}

196 
	$h™dÀS¸ubbögEº‹
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

198 
VDO
 *
vdo
 = 
	`vdoFromLﬂdSubTask
(
com∂ëi⁄
);

199 
	`íãrRódO∆yMode
(&
vdo
->
ªadO∆yC⁄ãxt
, 
com∂ëi⁄
->
ªsu…
);

200 
	`waôF‹RódO∆yMode
(
com∂ëi⁄
);

201 
	}
}

210 
	$¥ï¨eToComeO∆öe
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

212 
VDO
 *
vdo
 = 
	`vdoFromLﬂdSubTask
(
com∂ëi⁄
);

213 
SœbDïŸLﬂdTy≥
 
lﬂdTy≥
 = 
NORMAL_LOAD
;

214 i‡(
	`ªquúesRódO∆yRebuûd
(
vdo
)) {

215 
lﬂdTy≥
 = 
NO_LOAD
;

216 } i‡(
	`ªquúesRecovîy
(
vdo
)) {

217 
lﬂdTy≥
 = 
DEFER_LOAD
;

220 
	`öôülizeBlockM≠FromJou∫Æ
(
vdo
->
blockM≠
, vdo->
ªcovîyJou∫Æ
);

222 
	`¥ï¨eAdmöSubTask
(
vdo
, 
s¸ubSœbs
, 
h™dÀS¸ubbögEº‹
);

223 
	`¥ï¨eToAŒoˇã
(
vdo
->
dïŸ
, 
lﬂdTy≥
, 
com∂ëi⁄
);

224 
	}
}

232 
	$makeDúty
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

234 
VDO
 *
vdo
 = 
	`vdoFromLﬂdSubTask
(
com∂ëi⁄
);

235 i‡(
	`isRódO∆y
(&
vdo
->
ªadO∆yC⁄ãxt
)) {

236 
	`föishCom∂ëi⁄
(
com∂ëi⁄
->
∑ª¡
, 
VDO_READ_ONLY
);

240 
vdo
->
°©e
 = 
VDO_DIRTY
;

241 
	`¥ï¨eAdmöSubTask
(
vdo
, 
¥ï¨eToComeO∆öe
, 
c⁄töueLﬂdRódO∆y
);

242 
	`ßveVDOComp⁄ítsAsync
(
vdo
, 
com∂ëi⁄
);

243 
	}
}

246 
__©åibuã__
((
w¨n_unu£d_ªsu…
))

247 
	$°¨tVDODecode
(
VDO
 *
vdo
, 
boﬁ
 
vÆid©eC⁄fig
)

249 
ªsu…
 = 
	`vÆid©eVDOVîsi⁄
(
vdo
);

250 i‡(
ªsu…
 !
VDO_SUCCESS
) {

251  
ªsu…
;

254 
ªsu…
 = 
	`decodeVDOComp⁄ít
(
vdo
);

255 i‡(
ªsu…
 !
VDO_SUCCESS
) {

256  
ªsu…
;

259 i‡(!
vÆid©eC⁄fig
) {

260  
VDO_SUCCESS
;

263 
BlockCou¡
 
blockCou¡
 = 
vdo
->
œyî
->
	`gëBlockCou¡
(vdo->layer);

264  
	`vÆid©eVDOC⁄fig
(&
vdo
->
c⁄fig
, 
blockCou¡
);

265 
	}
}

268 
__©åibuã__
((
w¨n_unu£d_ªsu…
))

269 
	$föishVDODecode
(
VDO
 *
vdo
)

271 
Buf„r
 *
buf„r
 = 
	`gëComp⁄ítBuf„r
(
vdo
->
su≥rBlock
);

272 c⁄° 
ThªadC⁄fig
 *
thªadC⁄fig
 = 
	`gëThªadC⁄fig
(
vdo
);

273 
ªsu…
 = 
	`makeRecovîyJou∫Æ
(
vdo
->
n⁄˚
, vdo->
œyî
,

274 
	`gëVDOP¨tôi⁄
(
vdo
->
œyout
,

275 
RECOVERY_JOURNAL_PARTITION
),

276 
vdo
->
com∂ëeRecovîõs
,

277 
vdo
->
c⁄fig
.
ªcovîyJou∫ÆSize
,

278 
RECOVERY_JOURNAL_TAIL_BUFFER_SIZE
,

279 &
vdo
->
ªadO∆yC⁄ãxt
, 
thªadC⁄fig
,

280 &
vdo
->
ªcovîyJou∫Æ
);

281 i‡(
ªsu…
 !
VDO_SUCCESS
) {

282  
ªsu…
;

285 
ªsu…
 = 
	`decodeRecovîyJou∫Æ
(
vdo
->
ªcovîyJou∫Æ
, 
buf„r
);

286 i‡(
ªsu…
 !
VDO_SUCCESS
) {

287  
ªsu…
;

290 
ªsu…
 = 
	`decodeSœbDïŸ
(
buf„r
, 
thªadC⁄fig
, 
vdo
->
n⁄˚
, vdo->
œyî
,

291 
	`gëVDOP¨tôi⁄
(
vdo
->
œyout
,

292 
SLAB_SUMMARY_PARTITION
),

293 &
vdo
->
ªadO∆yC⁄ãxt
, vdo->
ªcovîyJou∫Æ
,

294 &
vdo
->
dïŸ
);

295 i‡(
ªsu…
 !
VDO_SUCCESS
) {

296  
ªsu…
;

299 
ªsu…
 = 
	`decodeBlockM≠
(
buf„r
, 
vdo
->
c⁄fig
.
logiˇlBlocks
, 
thªadC⁄fig
,

300 &
vdo
->
blockM≠
);

301 i‡(
ªsu…
 !
VDO_SUCCESS
) {

302  
ªsu…
;

305 
	`ASSERT_LOG_ONLY
((
	`c⁄ã¡Lígth
(
buf„r
) == 0),

307  
VDO_SUCCESS
;

308 
	}
}

322 
__©åibuã__
((
w¨n_unu£d_ªsu…
))

323 
	$decodeVDO
(
VDO
 *
vdo
, 
boﬁ
 
vÆid©eC⁄fig
)

325 
ªsu…
 = 
	`°¨tVDODecode
(
vdo
, 
vÆid©eC⁄fig
);

326 i‡(
ªsu…
 !
VDO_SUCCESS
) {

327  
ªsu…
;

330 i‡(
	`upgødeRequúed
(
vdo
)) {

331 i‡(
	`ªquúesRebuûd
(
vdo
)) {

333 
ªsu…
 = 
VDO_UNSUPPORTED_VERSION
;

334 
	`logEº‹WôhSåögEº‹
(
ªsu…
, "Cannot upgradeá dirty VDO.");

335  
ªsu…
;

341 
ªsu…
 = 
	`decodeVDOLayout
(
	`gëComp⁄ítBuf„r
(
vdo
->
su≥rBlock
), &vdo->
œyout
);

342 i‡(
ªsu…
 !
VDO_SUCCESS
) {

343  
ªsu…
;

346 c⁄° 
ThªadC⁄fig
 *
thªadC⁄fig
 = 
	`gëThªadC⁄fig
(
vdo
);

347 
ªsu…
 = 
	`ALLOCATE
(
thªadC⁄fig
->
ba£ThªadCou¡
, 
ThªadD©a
, 
__func__
,

348 &
vdo
->
thªadD©a
);

349 i‡(
ªsu…
 !
VDO_SUCCESS
) {

350  
ªsu…
;

353 
ThªadCou¡
 
thªad
 = 0;Åhªad < 
thªadC⁄fig
->
ba£ThªadCou¡
;

354 
thªad
++) {

355 
ªsu…
 = 
	`öôülizeThªadD©a
(&
vdo
->
thªadD©a
[
thªad
],Åhread,

356 (
vdo
->
°©e
 =
VDO_READ_ONLY_MODE
),

357 
thªadC⁄fig
, 
vdo
->
œyî
);

358 i‡(
ªsu…
 !
VDO_SUCCESS
) {

359  
ªsu…
;

363 
ªsu…
 = 
	`föishVDODecode
(
vdo
);

364 i‡(
ªsu…
 !
VDO_SUCCESS
) {

365  
ªsu…
;

368 
ªsu…
 = 
	`makeFlushî
(
vdo
);

369 i‡(
ªsu…
 !
VDO_SUCCESS
) {

370  
ªsu…
;

373 
BlockCou¡
 
maximumAge
 = 
	`gëC⁄figuªdBlockM≠MaximumAge
(
vdo
);

374 
BlockCou¡
 
jou∫ÆLígth


375 
	`gëRecovîyJou∫ÆLígth
(
vdo
->
c⁄fig
.
ªcovîyJou∫ÆSize
);

376 i‡((
maximumAge
 > (
jou∫ÆLígth
 / 2)) || (maximumAge < 1)) {

377  
VDO_BAD_CONFIGURATION
;

379 
ªsu…
 = 
	`makeBlockM≠Caches
(
vdo
->
blockM≠
, vdo->
œyî
,

380 &
vdo
->
ªadO∆yC⁄ãxt
, vdo->
ªcovîyJou∫Æ
,

381 
vdo
->
n⁄˚
, 
	`gëC⁄figuªdCacheSize
(vdo),

382 
maximumAge
);

383 i‡(
ªsu…
 !
VDO_SUCCESS
) {

384  
ªsu…
;

388 
	`›íRecovîyJou∫Æ
(
vdo
->
ªcovîyJou∫Æ
, vdo->
dïŸ
, vdo->
blockM≠
);

390 
ªsu…
 = 
	`ALLOCATE
(
thªadC⁄fig
->
hashZ⁄eCou¡
, 
HashZ⁄e
 *, 
__func__
,

391 &
vdo
->
hashZ⁄es
);

392 i‡(
ªsu…
 !
VDO_SUCCESS
) {

393  
ªsu…
;

396 
Z⁄eCou¡
 
z⁄e
 = 0; z⁄ê< 
thªadC⁄fig
->
hashZ⁄eCou¡
; zone++) {

397 
ªsu…
 = 
	`makeHashZ⁄e
(
vdo
, 
z⁄e
, &vdo->
hashZ⁄es
[zone]);

398 i‡(
ªsu…
 !
VDO_SUCCESS
) {

399  
ªsu…
;

403 
ªsu…
 = 
	`ALLOCATE
(
thªadC⁄fig
->
logiˇlZ⁄eCou¡
, 
LogiˇlZ⁄e
 *, 
__func__
,

404 &
vdo
->
logiˇlZ⁄es
);

405 i‡(
ªsu…
 !
VDO_SUCCESS
) {

406  
ªsu…
;

411 
LogiˇlZ⁄e
 *
logiˇlZ⁄e
 = 
NULL
;

412 
ödex
 = 
thªadC⁄fig
->
logiˇlZ⁄eCou¡
 - 1; index >= 0; index--) {

413 
ªsu…
 = 
	`makeLogiˇlZ⁄e
(
vdo
, 
ödex
, 
logiˇlZ⁄e
, &logicalZone);

414 i‡(
ªsu…
 !
VDO_SUCCESS
) {

415  
ªsu…
;

417 
vdo
->
logiˇlZ⁄es
[
ödex
] = 
logiˇlZ⁄e
;

420 
ªsu…
 = 
	`ALLOCATE
(
thªadC⁄fig
->
physiˇlZ⁄eCou¡
, 
PhysiˇlZ⁄e
 *, 
__func__
,

421 &
vdo
->
physiˇlZ⁄es
);

422 i‡(
ªsu…
 !
VDO_SUCCESS
) {

423  
ªsu…
;

426 
Z⁄eCou¡
 
z⁄e
 = 0; z⁄ê< 
thªadC⁄fig
->
physiˇlZ⁄eCou¡
; zone++) {

427 
ªsu…
 = 
	`makePhysiˇlZ⁄e
(
vdo
, 
z⁄e
, &vdo->
physiˇlZ⁄es
[zone]);

428 i‡(
ªsu…
 !
VDO_SUCCESS
) {

429  
ªsu…
;

433  
	`makePackî
(
vdo
->
œyî
, 
DEFAULT_PACKER_INPUT_BINS
,

434 
DEFAULT_PACKER_OUTPUT_BINS
, 
thªadC⁄fig
, &
vdo
->
∑ckî
);

435 
	}
}

443 
	$lﬂdVDOComp⁄íts
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

445 
VDO
 *
vdo
 = 
	`vdoFromLﬂdSubTask
(
com∂ëi⁄
);

446 
ªsu…
 = 
	`decodeVDO
(
vdo
, 
åue
);

447 i‡(
ªsu…
 !
VDO_SUCCESS
) {

448 
	`ª£tCom∂ëi⁄
(
com∂ëi⁄
);

449 
	`föishCom∂ëi⁄
(
com∂ëi⁄
, 
ªsu…
);

453 
vdo
->
˛o£Requúed
 = 
åue
;

454 i‡(
	`isRódO∆y
(&
vdo
->
ªadO∆yC⁄ãxt
)) {

457 
	`föishCom∂ëi⁄
(
com∂ëi⁄
->
∑ª¡
, 
VDO_READ_ONLY
);

461 i‡(
	`ªquúesRebuûd
(
vdo
)) {

462 i‡(
	`ªquúesRódO∆yRebuûd
(
vdo
)) {

463 
	`¥ï¨eAdmöSubTask
(
vdo
, 
makeDúty
, 
ab‹tLﬂd
);

464 
	`œunchRebuûd
(
vdo
, 
com∂ëi⁄
);

466 
	`¥ï¨eAdmöSubTask
(
vdo
, 
makeDúty
, 
c⁄töueLﬂdRódO∆y
);

467 
	`œunchRecovîy
(
vdo
, 
com∂ëi⁄
);

472 
	`¥ï¨eAdmöSubTask
(
vdo
, 
makeDúty
, 
c⁄töueLﬂdRódO∆y
);

473 
	`lﬂdSœbDïŸ
(
vdo
->
dïŸ
, 
	`wasNew
(vdo), 
com∂ëi⁄
);

474 
	}
}

481 
	$lﬂdCÆlback
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

483 
VDO
 *
vdo
 = 
	`vdoFromLﬂdSubTask
(
com∂ëi⁄
);

484 
	`as£πOnAdmöThªad
(
vdo
, 
__func__
);

485 
	`¥ï¨eAdmöSubTask
(
vdo
, 
lﬂdVDOComp⁄íts
, 
ab‹tLﬂd
);

486 
	`lﬂdSu≥rBlockAsync
(
com∂ëi⁄
, &
vdo
->
su≥rBlock
);

487 
	}
}

490 
	$≥rf‹mVDOLﬂd
(
VDO
 *
vdo
, c⁄° 
VDOLﬂdC⁄fig
 *
lﬂdC⁄fig
)

492 
vdo
->
lﬂdC⁄fig
 = *loadConfig;

493 
ªsu…
 = 
	`c›yThªadC⁄fig
(
lﬂdC⁄fig
->
thªadC⁄fig
,

494 &
vdo
->
lﬂdC⁄fig
.
thªadC⁄fig
);

495 i‡(
ªsu…
 !
VDO_SUCCESS
) {

496  
ªsu…
;

499  
	`≥rf‹mAdmöO≥øti⁄
(
vdo
, 
ADMIN_OPERATION_LOAD
, 
lﬂdCÆlback
);

500 
	}
}

503 
__©åibuã__
((
w¨n_unu£d_ªsu…
))

504 
	$decodeSynchr⁄ousVDO
(
VDO
 *
vdo
, 
boﬁ
 
vÆid©eC⁄fig
)

506 
ªsu…
 = 
	`°¨tVDODecode
(
vdo
, 
vÆid©eC⁄fig
);

507 i‡(
ªsu…
 !
VDO_SUCCESS
) {

508  
ªsu…
;

511 i‡(
	`upgødeRequúed
(
vdo
)) {

512  
VDO_UNSUPPORTED_VERSION
;

515 
ªsu…
 = 
	`decodeVDOLayout
(
	`gëComp⁄ítBuf„r
(
vdo
->
su≥rBlock
), &vdo->
œyout
);

516 i‡(
ªsu…
 !
VDO_SUCCESS
) {

517  
ªsu…
;

520  
	`föishVDODecode
(
vdo
);

521 
	}
}

524 
	$lﬂdVDO
(
PhysiˇlLayî
 *
œyî
,

525 
boﬁ
 
vÆid©eC⁄fig
,

526 
VDODecodî
 *
decodî
,

527 
VDO
 **
vdoPå
)

529 
VDO
 *
vdo
;

530 
ªsu…
 = 
	`makeVDO
(
œyî
, &
vdo
);

531 i‡(
ªsu…
 !
VDO_SUCCESS
) {

532  
ªsu…
;

535 
ªsu…
 = 
	`lﬂdSu≥rBlock
(
œyî
, &
vdo
->
su≥rBlock
);

536 i‡(
ªsu…
 !
VDO_SUCCESS
) {

537 
	`‰ìVDO
(&
vdo
);

538  
ªsu…
;

541 
ªsu…
 = ((
decodî
 =
NULL
)

542 ? 
	`decodeSynchr⁄ousVDO
(
vdo
, 
vÆid©eC⁄fig
)

543 : 
	`decodî
(
vdo
, 
vÆid©eC⁄fig
));

544 i‡(
ªsu…
 !
VDO_SUCCESS
) {

545 
	`‰ìVDO
(&
vdo
);

546  
ªsu…
;

549 *
vdoPå
 = 
vdo
;

550  
VDO_SUCCESS
;

551 
	}
}

	@vdo/base/vdoLoad.h

22 #i‚de‡
VDO_LOAD_H


23 
	#VDO_LOAD_H


	)

25 
	~"ty≥s.h
"

37 
	tVDODecodî
(
	tVDO
 *
	tvdo
, 
	tboﬁ
 
	tvÆid©eC⁄fig
);

48 
	$≥rf‹mVDOLﬂd
(
VDO
 *
vdo
, c⁄° 
VDOLﬂdC⁄fig
 *
lﬂdC⁄fig
)

49 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

62 
	$lﬂdVDO
(
PhysiˇlLayî
 *
œyî
,

63 
boﬁ
 
vÆid©eC⁄fig
,

64 
VDODecodî
 *
decodî
,

65 
VDO
 **
vdoPå
)

66 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

	@vdo/base/vdoPageCache.c

22 
	~"vdoPageCacheI¡î«ls.h
"

24 
	~"îr‹s.h
"

25 
	~"loggî.h
"

26 
	~"mem‹yAŒoc.h
"

27 
	~"≥rmas£π.h
"

29 
	~"c⁄°™ts.h
"

30 
	~"exã¡.h
"

31 
	~"numUtûs.h
"

32 
	~"°©usCodes.h
"

33 
	~"ty≥s.h
"

34 
	~"vio.h
"

37 
	mLOG_INTERVAL
 = 4000,

38 
	mDISPLAY_INTERVAL
 = 100000,

42 *
	$gëPageBuf„r
(
PageInfo
 *
öfo
)

44 
VDOPageCache
 *
ˇche
 = 
öfo
->cache;

45  &
ˇche
->
∑ges
[(
öfo
 - cache->
öfos
Ë* 
VDO_BLOCK_SIZE
];

46 
	}
}

56 
__©åibuã__
((
w¨n_unu£d_ªsu…
))

57 
	$ÆloˇãCacheComp⁄íts
(
VDOPageCache
 *
ˇche
)

59 
ªsu…
 = 
	`ALLOCATE
(
ˇche
->
∑geCou¡
, 
PageInfo
, "page infos",

60 &
ˇche
->
öfos
);

61 i‡(
ªsu…
 !
UDS_SUCCESS
) {

62  
ªsu…
;

65 
uöt64_t
 
size
 = 
ˇche
->
∑geCou¡
 * (uöt64_tË
VDO_BLOCK_SIZE
;

66 
ªsu…
 = 
	`ÆloˇãMem‹y
(
size
, 
VDO_BLOCK_SIZE
, "ˇchê∑ges", &
ˇche
->
∑ges
);

67 i‡(
ªsu…
 !
UDS_SUCCESS
) {

68  
ªsu…
;

71  
	`makeI¡M≠
(
ˇche
->
∑geCou¡
, 0, &ˇche->
∑geM≠
);

72 
	}
}

82 
	$öôülizeInfo
(
VDOPageCache
 *
ˇche
, 
ThªadID
 
thªadID
)

84 
	`öôülizeRög
(&
ˇche
->
‰ìLi°
);

85 
PageInfo
 *
öfo
 = 
ˇche
->
öfos
; infÿ< cache->öfo†+ cache->
∑geCou¡
;

86 ++
öfo
) {

87 
öfo
->
ˇche
 = cache;

88 
öfo
->
°©e
 = 
PS_FREE
;

89 
öfo
->
pbn
 = 
NO_PAGE
;

91 i‡(
ˇche
->
œyî
->
¸óãMëad©aVIO
 !
NULL
) {

92 
ªsu…
 = 
	`¸óãVIO
(
ˇche
->
œyî
, 
VIO_TYPE_BLOCK_MAP
,

93 
VIO_PRIORITY_METADATA
, 
öfo
, 
	`gëPageBuf„r
(info),

94 &
öfo
->
vio
);

95 i‡(
ªsu…
 !
VDO_SUCCESS
) {

96  
ªsu…
;

100 
öfo
->
vio
->
com∂ëi⁄
.
ˇŒbackThªadID
 = 
thªadID
;

103 
	`öôülizeRög
(&
öfo
->
li°Node
);

104 
	`pushRögNode
(&
ˇche
->
‰ìLi°
, &
öfo
->
li°Node
);

105 
	`öôülizeRög
(&
öfo
->
ÃuNode
);

108 
	`ªœxedSt‹e64
(&
ˇche
->
°©s
.
cou¡s
.
‰ìPages
, cache->
∑geCou¡
);

109  
VDO_SUCCESS
;

110 
	}
}

113 
wrôeDútyPagesCÆlback
(
RögNode
 *
node
, *
c⁄ãxt
);

116 
	$makeVDOPageCache
(
ThªadID
 
thªadID
,

117 
PhysiˇlLayî
 *
œyî
,

118 
RódO∆yModeC⁄ãxt
 *
ªadO∆yC⁄ãxt
,

119 
PageCou¡
 
∑geCou¡
,

120 
VDOPageRódFun˘i⁄
 *
ªadHook
,

121 
VDOPageWrôeFun˘i⁄
 *
wrôeHook
,

122 *
fun˘i⁄C⁄ãxt
,

123 
BlockCou¡
 
maximumAge
,

124 
VDOPageCache
 **
ˇchePå
)

126 
VDOPageCache
 *
ˇche
;

127 
ªsu…
 = 
	`ALLOCATE
(1, 
VDOPageCache
, "∑gêˇche", &
ˇche
);

128 i‡(
ªsu…
 !
UDS_SUCCESS
) {

129  
ªsu…
;

132 
ˇche
->
thªadID
 =ÅhreadID;

133 
ˇche
->
œyî
 =Üayer;

134 
ˇche
->
ªadO∆yC⁄ãxt
 =ÑeadOnlyContext;

135 
ˇche
->
∑geCou¡
 =ÖageCount;

136 
ˇche
->
ªadHook
 =ÑeadHook;

137 
ˇche
->
wrôeHook
 = writeHook;

138 
ˇche
->
c⁄ãxt
 = 
fun˘i⁄C⁄ãxt
;

140 
ªsu…
 = 
	`ÆloˇãCacheComp⁄íts
(
ˇche
);

141 i‡(
ªsu…
 !
VDO_SUCCESS
) {

142 
	`‰ìVDOPageCache
(&
ˇche
);

143  
ªsu…
;

146 
ªsu…
 = 
	`öôülizeInfo
(
ˇche
, 
thªadID
);

147 i‡(
ªsu…
 !
VDO_SUCCESS
) {

148 
	`‰ìVDOPageCache
(&
ˇche
);

149  
ªsu…
;

152 
ªsu…
 = 
	`makeDútyLi°s
(
maximumAge
, 
wrôeDútyPagesCÆlback
, 
ˇche
,

153 &
ˇche
->
dútyLi°s
);

154 i‡(
ªsu…
 !
VDO_SUCCESS
) {

155 
	`‰ìVDOPageCache
(&
ˇche
);

156  
ªsu…
;

160 
	`öôülizeRög
(&
ˇche
->
ÃuLi°
);

161 
	`öôülizeRög
(&
ˇche
->
outgoögLi°
);

163 *
ˇchePå
 = 
ˇche
;

164  
VDO_SUCCESS
;

165 
	}
}

168 
	$‰ìVDOPageCache
(
VDOPageCache
 **
ˇchePå
)

170 
VDOPageCache
 *
ˇche
 = *
ˇchePå
;

171 i‡(
ˇche
 =
NULL
) {

175 i‡(
ˇche
->
öfos
 !
NULL
) {

176 
PageInfo
 *
öfo
 = 
ˇche
->
öfos
; infÿ< cache->öfo†+ cache->
∑geCou¡
;

177 ++
öfo
) {

178 
	`‰ìVIO
(&
öfo
->
vio
);

182 
	`‰ìDútyLi°s
(&
ˇche
->
dútyLi°s
);

183 
	`‰ìI¡M≠
(&
ˇche
->
∑geM≠
);

184 
	`FREE
(
ˇche
->
öfos
);

185 
	`FREE
(
ˇche
->
∑ges
);

186 
	`FREE
(
ˇche
);

187 *
ˇchePå
 = 
NULL
;

188 
	}
}

191 
	$£tVDOPageCacheInôülPîiod
(
VDOPageCache
 *
ˇche
, 
Sequí˚Numbî
 
≥riod
)

193 
	`£tCuºítPîiod
(
ˇche
->
dútyLi°s
, 
≥riod
);

194 
	}
}

197 
	$£tVDOPageCacheRebuûdMode
(
VDOPageCache
 *
ˇche
, 
boﬁ
 
ªbuûdög
)

199 
ˇche
->
ªbuûdög
 =Ñebuilding;

200 
	}
}

208 
ölöe
 
	$as£πOnCacheThªad
(
VDOPageCache
 *
ˇche
,

209 c⁄° *
fun˘i⁄Name
)

211 
ThªadID
 
thªadID
 = 
	`gëCÆlbackThªadID
();

212 
	`ASSERT_LOG_ONLY
((
thªadID
 =
ˇche
->threadID),

214 
fun˘i⁄Name
, 
ˇche
->
thªadID
,ÅhreadID);

215 
	}
}

222 
	$ªp‹tCachePªssuª
(
VDOPageCache
 *
ˇche
)

224 
	`ªœxedAdd64
(&
ˇche
->
°©s
.
ˇchePªssuª
, 1);

225 i‡(
ˇche
->
waôîCou¡
 > cache->
∑geCou¡
) {

226 i‡((
ˇche
->
¥essuªRï‹t
 % 
LOG_INTERVAL
) == 0) {

227 
	`logInfo
("∑gêˇchê¥essuª %" 
PRIu64
,

228 
	`ªœxedLﬂd64
(&
ˇche
->
°©s
.
ˇchePªssuª
));

231 i‡(++
ˇche
->
¥essuªRï‹t
 >
DISPLAY_INTERVAL
) {

232 
ˇche
->
¥essuªRï‹t
 = 0;

235 
	}
}

238 c⁄° *
	$vpcPageSèãName
(
PageSèã
 
°©e
)

240 c⁄° *
°©eNames
[] = {

248 
	`STATIC_ASSERT
(
	`COUNT_OF
(
°©eNames
Ë=
PAGE_STATE_COUNT
);

250 
ªsu…
 = 
	`ASSERT
(((Ë
°©e
 >0Ë&& (°©ê< 
	`COUNT_OF
(
°©eNames
)),

251 "Unknow¿PageSèã vÆuê%d", 
°©e
);

252 i‡(
ªsu…
 =
UDS_SUCCESS
) {

253  
°©eNames
[
°©e
];

256 
	}
}

264 
	$upd©eCou¡î
(
PageInfo
 *
öfo
, 
öt32_t
 
dñè
)

266 
VDOPageCache
 *
ˇche
 = 
öfo
->cache;

267 
öfo
->
°©e
) {

268 
PS_FREE
:

269 
	`ªœxedAdd64
(&
ˇche
->
°©s
.
cou¡s
.
‰ìPages
, 
dñè
);

272 
PS_INCOMING
:

273 
	`ªœxedAdd64
(&
ˇche
->
°©s
.
cou¡s
.
öcomögPages
, 
dñè
);

276 
PS_OUTGOING
:

277 
	`ªœxedAdd64
(&
ˇche
->
°©s
.
cou¡s
.
outgoögPages
, 
dñè
);

280 
PS_FAILED
:

281 
	`ªœxedAdd64
(&
ˇche
->
°©s
.
cou¡s
.
ÁûedPages
, 
dñè
);

284 
PS_RESIDENT
:

285 
	`ªœxedAdd64
(&
ˇche
->
°©s
.
cou¡s
.
˛ónPages
, 
dñè
);

288 
PS_DIRTY
:

289 
	`ªœxedAdd64
(&
ˇche
->
°©s
.
cou¡s
.
dútyPages
, 
dñè
);

295 
	}
}

300 
	$upd©eLru
(
PageInfo
 *
öfo
)

302 
VDOPageCache
 *
ˇche
 = 
öfo
->cache;

304 i‡(
ˇche
->
ÃuLi°
.
¥ev
 !&
öfo
->
ÃuNode
) {

305 
	`pushRögNode
(&
ˇche
->
ÃuLi°
, &
öfo
->
ÃuNode
);

307 
	}
}

316 
	$£tInfoSèã
(
PageInfo
 *
öfo
, 
PageSèã
 
√wSèã
)

318 i‡(
√wSèã
 =
öfo
->
°©e
) {

322 
	`upd©eCou¡î
(
öfo
, -1);

323 
öfo
->
°©e
 = 
√wSèã
;

324 
	`upd©eCou¡î
(
öfo
, 1);

326 
öfo
->
°©e
) {

327 
PS_FREE
:

328 
PS_FAILED
:

329 
	`pushRögNode
(&
öfo
->
ˇche
->
‰ìLi°
, &öfo->
li°Node
);

332 
PS_OUTGOING
:

333 
	`pushRögNode
(&
öfo
->
ˇche
->
outgoögLi°
, &öfo->
li°Node
);

336 
PS_DIRTY
:

340 
	`un•li˚RögNode
(&
öfo
->
li°Node
);

342 
	}
}

350 
__©åibuã__
((
w¨n_unu£d_ªsu…
))

351 
	$£tInfoPBN
(
PageInfo
 *
öfo
, 
PhysiˇlBlockNumbî
 
pbn
)

353 
VDOPageCache
 *
ˇche
 = 
öfo
->cache;

356 
ªsu…
 = 
	`ASSERT
((
pbn
 =
NO_PAGE
Ë|| (
öfo
->pbn == NO_PAGE),

358 i‡(
ªsu…
 !
VDO_SUCCESS
) {

359  
ªsu…
;

362 i‡(
öfo
->
pbn
 !
NO_PAGE
) {

363 
	`ötM≠Remove
(
ˇche
->
∑geM≠
, 
öfo
->
pbn
);

366 
öfo
->
pbn
 =Öbn;

368 i‡(
pbn
 !
NO_PAGE
) {

369 
ªsu…
 = 
	`ötM≠Put
(
ˇche
->
∑geM≠
, 
pbn
, 
öfo
, 
åue
, 
NULL
);

370 i‡(
ªsu…
 !
UDS_SUCCESS
) {

371  
ªsu…
;

374  
VDO_SUCCESS
;

375 
	}
}

380 
	$ª£tPageInfo
(
PageInfo
 *
öfo
)

382 
ªsu…
 = 
	`ASSERT
(
öfo
->
busy
 == 0, "VDO Page mustÇot be busy");

383 i‡(
ªsu…
 !
UDS_SUCCESS
) {

384  
ªsu…
;

387 
ªsu…
 = 
	`ASSERT
(!
	`hasWaôîs
(&
öfo
->
waôög
),

389 i‡(
ªsu…
 !
UDS_SUCCESS
) {

390  
ªsu…
;

393 
ªsu…
 = 
	`£tInfoPBN
(
öfo
, 
NO_PAGE
);

394 
	`£tInfoSèã
(
öfo
, 
PS_FREE
);

395 
	`un•li˚RögNode
(&
öfo
->
ÃuNode
);

396  
ªsu…
;

397 
	}
}

406 
__©åibuã__
((
w¨n_unu£d_ªsu…
))

407 
PageInfo
 *
	$födFªePage
(
VDOPageCache
 *
ˇche
)

409 i‡(
ˇche
->
‰ìLi°
.
√xt
 == &cache->freeList) {

410  
NULL
;

412 
PageInfo
 *
öfo
 = 
	`∑geInfoFromLi°Node
(
ˇche
->
‰ìLi°
.
√xt
);

413 
	`un•li˚RögNode
(&
öfo
->
li°Node
);

414  
öfo
;

415 
	}
}

418 
PageInfo
 *
	$vpcFödPage
(
VDOPageCache
 *
ˇche
, 
PhysiˇlBlockNumbî
 
pbn
)

420 i‡((
ˇche
->
œ°Found
 !
NULL
)

421 && (
ˇche
->
œ°Found
->
pbn
 ==Öbn)) {

422  
ˇche
->
œ°Found
;

424 
ˇche
->
œ°Found
 = 
	`ötM≠Gë
(ˇche->
∑geM≠
, 
pbn
);

425  
ˇche
->
œ°Found
;

426 
	}
}

443 
__©åibuã__
((
w¨n_unu£d_ªsu…
))

444 
PageInfo
 *
	$£À˘LRUPage
(
VDOPageCache
 *
ˇche
)

446 
PageInfoNode
 *
Ãu
 = 
ˇche
->
ÃuLi°
.
√xt
;

447 
Ãu
 !&
ˇche
->
ÃuLi°
;

448 
Ãu
 =Üru->
√xt
) {

449 
PageInfo
 *
öfo
 = 
	`∑geInfoFromLRUNode
(
Ãu
);

450 i‡((
öfo
->
busy
 =0Ë&& !
	`isInFlight
(info)) {

451  
öfo
;

455  
NULL
;

456 
	}
}

459 
AtomicPageCacheSèti°ics
 *
	$gëVDOPageCacheSèti°ics
(
VDOPageCache
 *
ˇche
)

461  &
ˇche
->
°©s
;

462 
	}
}

472 
	$com∂ëeWôhPage
(
PageInfo
 *
öfo
, 
VDOPageCom∂ëi⁄
 *
vdoPageComp
)

474 
boﬁ
 
avaûabÀ
 = 
vdoPageComp
->
wrôabÀ
 ? 
	`isPª£¡
(
öfo
Ë: 
	`isVÆid
(info);

475 i‡(!
avaûabÀ
) {

476 
	`logEº‹WôhSåögEº‹
(
VDO_BAD_PAGE
,

477 "Reque°ed cachê∑gê%" 
PRIu64
 " in state %s is"

479 
öfo
->
pbn
, 
	`vpcPageSèãName
(öfo->
°©e
),

480 
vdoPageComp
->
wrôabÀ
 ? "present" : "valid");

481 
	`föishCom∂ëi⁄
(&
vdoPageComp
->
com∂ëi⁄
, 
VDO_BAD_PAGE
);

485 
vdoPageComp
->
öfo
 = info;

486 
vdoPageComp
->
ªady
 = 
åue
;

487 
	`föishCom∂ëi⁄
(&
vdoPageComp
->
com∂ëi⁄
, 
VDO_SUCCESS
);

488 
	}
}

496 
	$com∂ëeWaôîWôhEº‹
(
Waôî
 *
waôî
, *
ªsu…På
)

498 *
ªsu…
 = 
ªsu…På
;

499 
VDOPageCom∂ëi⁄
 *
com∂ëi⁄
 = 
	`∑geCom∂ëi⁄FromWaôî
(
waôî
);

500 
	`föishCom∂ëi⁄
(&
com∂ëi⁄
->com∂ëi⁄, *
ªsu…
);

501 
	}
}

511 
	$di°ribuãEº‹OvîQueue
(
ªsu…
, 
WaôQueue
 *
queue
)

513 
	`nŸifyAŒWaôîs
(
queue
, 
com∂ëeWaôîWôhEº‹
, &
ªsu…
);

514 
	}
}

522 
	$com∂ëeWaôîWôhPage
(
Waôî
 *
waôî
, *
∑geInfo
)

524 
PageInfo
 *
öfo
 = 
∑geInfo
;

525 
VDOPageCom∂ëi⁄
 *
com∂ëi⁄
 = 
	`∑geCom∂ëi⁄FromWaôî
(
waôî
);

526 
	`com∂ëeWôhPage
(
öfo
, 
com∂ëi⁄
);

527 
	}
}

540 
	$di°ribuãPageOvîQueue
(
PageInfo
 *
öfo
, 
WaôQueue
 *
queue
)

542 
	`upd©eLru
(
öfo
);

544 
size_t
 
∑ges
 = 
	`cou¡Waôîs
(
queue
);

551 
öfo
->
busy
 +
∑ges
;

553 
	`nŸifyAŒWaôîs
(
queue
, 
com∂ëeWaôîWôhPage
, 
öfo
);

554  
∑ges
;

555 
	}
}

567 
	$£tPîsi°ítEº‹
(
VDOPageCache
 *
ˇche
,

568 c⁄° *
c⁄ãxt
,

569 
ªsu…
)

572 i‡(
ªsu…
 !
VDO_READ_ONLY
) {

573 
	`logEº‹WôhSåögEº‹
(
ªsu…
,

575 
c⁄ãxt
);

576 
	`íãrRódO∆yMode
(
ˇche
->
ªadO∆yC⁄ãxt
, 
ªsu…
);

579 
	`as£πOnCacheThªad
(
ˇche
, 
__func__
);

581 
	`di°ribuãEº‹OvîQueue
(
ªsu…
, &
ˇche
->
‰ìWaôîs
);

582 
ˇche
->
waôîCou¡
 = 0;

584 
PageInfo
 *
öfo
 = 
ˇche
->
öfos
;

585 
öfo
 < 
ˇche
->
öfos
 + cache->
∑geCou¡
;

586 ++
öfo
) {

587 
	`di°ribuãEº‹OvîQueue
(
ªsu…
, &
öfo
->
waôög
);

589 
	}
}

592 
	$öôVDOPageCom∂ëi⁄
(
VDOPageCom∂ëi⁄
 *
∑geCom∂ëi⁄
,

593 
VDOPageCache
 *
ˇche
,

594 
PhysiˇlBlockNumbî
 
pbn
,

595 
boﬁ
 
wrôabÀ
,

596 *
∑ª¡
,

597 
VDOA˘i⁄
 *
ˇŒback
,

598 
VDOA˘i⁄
 *
îr‹H™dÀr
)

600 
	`ASSERT_LOG_ONLY
((
∑geCom∂ëi⁄
->
waôî
.
√xtWaôî
 =
NULL
),

603 *
∑geCom∂ëi⁄
 = (
VDOPageCom∂ëi⁄
) {

604 .
pbn
 =Öbn,

605 .
wrôabÀ
 = writable,

606 .
ˇche
 = cache,

609 
VDOCom∂ëi⁄
 *
com∂ëi⁄
 = &
∑geCom∂ëi⁄
->completion;

610 
	`öôülizeCom∂ëi⁄
(
com∂ëi⁄
, 
VDO_PAGE_COMPLETION
, 
ˇche
->
œyî
);

611 
	`¥ï¨eCom∂ëi⁄
(
com∂ëi⁄
, 
ˇŒback
, 
îr‹H™dÀr
, 
ˇche
->
thªadID
,

612 
∑ª¡
);

613 
	}
}

624 
__©åibuã__
((
w¨n_unu£d_ªsu…
))

625 
VDOPageCom∂ëi⁄
 *
	$vÆid©eCom∂ëedPage
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
,

626 
boﬁ
 
wrôabÀ
)

628 
VDOPageCom∂ëi⁄
 *
vpc
 = 
	`asVDOPageCom∂ëi⁄
(
com∂ëi⁄
);

630 
ªsu…
 = 
	`ASSERT
(
vpc
->
ªady
, "VDO Page completionÇotÑeady");

631 i‡(
ªsu…
 !
UDS_SUCCESS
) {

632  
NULL
;

635 
ªsu…
 = 
	`ASSERT
(
vpc
->
öfo
 !
NULL
, "VDO Page Completion must be complete");

636 i‡(
ªsu…
 !
UDS_SUCCESS
) {

637  
NULL
;

640 
ªsu…
 = 
	`ASSERT
(
vpc
->
öfo
->
pbn
 == vpc->pbn,

642 i‡(
ªsu…
 !
UDS_SUCCESS
) {

643  
NULL
;

646 
ªsu…
 = 
	`ASSERT
(
	`isVÆid
(
vpc
->
öfo
),

648 i‡(
ªsu…
 !
UDS_SUCCESS
) {

649  
NULL
;

652 i‡(
wrôabÀ
) {

653 
ªsu…
 = 
	`ASSERT
(
vpc
->
wrôabÀ
, "VDO Page Completion is writable");

654 i‡(
ªsu…
 !
UDS_SUCCESS
) {

655  
NULL
;

659  
vpc
;

660 
	}
}

668 
	$checkF‹IOCom∂ëe
(
VDOPageCache
 *
ˇche
)

670 i‡((
ˇche
->
out°™dögRóds
 + cache->
out°™dögWrôes
) > 0) {

674 
VDOCom∂ëi⁄
 *
∑ª¡
 = 
ˇche
->
ÊushCom∂ëi⁄
;

675 i‡(
∑ª¡
 !
NULL
) {

676 
ˇche
->
ÊushCom∂ëi⁄
 = 
NULL
;

677 
ªsu…


678 
	`isRódO∆y
(
ˇche
->
ªadO∆yC⁄ãxt
Ë? 
VDO_READ_ONLY
 : 
VDO_SUCCESS
;

679 
	`föishCom∂ëi⁄
(
∑ª¡
, 
ªsu…
);

681 
	}
}

689 
	$∑geIsLﬂded
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

691 
PageInfo
 *
öfo
 = 
com∂ëi⁄
->
∑ª¡
;

692 
VDOPageCache
 *
ˇche
 = 
öfo
->cache;

693 
	`as£πOnCacheThªad
(
ˇche
, 
__func__
);

695 
ˇche
->
out°™dögRóds
--;

696 
	`£tInfoSèã
(
öfo
, 
PS_RESIDENT
);

697 
	`di°ribuãPageOvîQueue
(
öfo
, &öfo->
waôög
);

698 
	`checkF‹IOCom∂ëe
(
ˇche
);

699 
	}
}

706 
	$h™dÀLﬂdEº‹
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

708 
ªsu…
 = 
com∂ëi⁄
->result;

709 
PageInfo
 *
öfo
 = 
com∂ëi⁄
->
∑ª¡
;

710 
VDOPageCache
 *
ˇche
 = 
öfo
->cache;

711 
	`as£πOnCacheThªad
(
ˇche
, 
__func__
);

713 
ˇche
->
out°™dögRóds
--;

714 
	`íãrRódO∆yMode
(
ˇche
->
ªadO∆yC⁄ãxt
, 
ªsu…
);

715 
	`ªœxedAdd64
(&
ˇche
->
°©s
.
ÁûedRóds
, 1);

716 
	`£tInfoSèã
(
öfo
, 
PS_FAILED
);

717 
	`di°ribuãEº‹OvîQueue
(
ªsu…
, &
öfo
->
waôög
);

718 
	`ª£tPageInfo
(
öfo
);

719 
	`checkF‹IOCom∂ëe
(
ˇche
);

720 
	}
}

728 
	$runRódHook
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

730 
PageInfo
 *
öfo
 = 
com∂ëi⁄
->
∑ª¡
;

731 
com∂ëi⁄
->
ˇŒback
 = 
∑geIsLﬂded
;

732 
	`ª£tCom∂ëi⁄
(
com∂ëi⁄
);

733 
	`c⁄töueCom∂ëi⁄
(
com∂ëi⁄
, 
öfo
->
ˇche
->
	`ªadHook
(
	`gëPageBuf„r
(info),

734 
öfo
->
pbn
,

735 
öfo
->
ˇche
->
c⁄ãxt
));

736 
	}
}

743 
	$h™dÀRebuûdRódEº‹
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

745 
PageInfo
 *
öfo
 = 
com∂ëi⁄
->
∑ª¡
;

746 
VDOPageCache
 *
ˇche
 = 
öfo
->cache;

747 
	`as£πOnCacheThªad
(
ˇche
, 
__func__
);

751 
	`ªœxedAdd64
(&
ˇche
->
°©s
.
ÁûedRóds
, 1);

752 
	`mem£t
(
	`gëPageBuf„r
(
öfo
), 0, 
VDO_BLOCK_SIZE
);

753 
	`ª£tCom∂ëi⁄
(
com∂ëi⁄
);

754 i‡(
ˇche
->
ªadHook
 !
NULL
) {

755 
	`runRódHook
(
com∂ëi⁄
);

757 
	`∑geIsLﬂded
(
com∂ëi⁄
);

759 
	}
}

769 
__©åibuã__
((
w¨n_unu£d_ªsu…
))

770 
	$œunchPageLﬂd
(
PageInfo
 *
öfo
, 
PhysiˇlBlockNumbî
 
pbn
)

772 
ªsu…
 = 
	`£tInfoPBN
(
öfo
, 
pbn
);

773 i‡(
ªsu…
 !
VDO_SUCCESS
) {

774  
ªsu…
;

777 
ªsu…
 = 
	`ASSERT
((
öfo
->
busy
 == 0), "Page isÇot busy beforeÜoading.");

778 i‡(
ªsu…
 !
VDO_SUCCESS
) {

779  
ªsu…
;

782 
	`£tInfoSèã
(
öfo
, 
PS_INCOMING
);

783 
VDOPageCache
 *
ˇche
 = 
öfo
->cache;

784 
ˇche
->
out°™dögRóds
++;

785 
	`ªœxedAdd64
(&
ˇche
->
°©s
.
∑gesLﬂded
, 1);

786 
	`œunchRódMëad©aVIO
(
öfo
->
vio
, 
pbn
,

787 (
ˇche
->
ªadHook
 !
NULL
Ë? 
runRódHook
 : 
∑geIsLﬂded
,

788 (
ˇche
->
ªbuûdög


789 ? 
h™dÀRebuûdRódEº‹
 : 
h™dÀLﬂdEº‹
));

790  
VDO_SUCCESS
;

791 
	}
}

794 
wrôePages
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
);

801 
	$h™dÀFlushEº‹
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

803 
VDOPageCache
 *
ˇche
 = ((
PageInfo
 *Ë
com∂ëi⁄
->
∑ª¡
)->cache;

804 
	`£tPîsi°ítEº‹
(
ˇche
, "Êush faûed", 
com∂ëi⁄
->
ªsu…
);

805 
	`wrôePages
(
com∂ëi⁄
);

806 
	}
}

813 
	$ßvePages
(
VDOPageCache
 *
ˇche
)

815 i‡((
ˇche
->
∑gesInFlush
 > 0Ë|| (ˇche->
∑gesToFlush
 == 0)) {

819 
PageInfo
 *
öfo
 = 
	`∑geInfoFromLi°Node
(
ˇche
->
outgoögLi°
.
√xt
);

820 
ˇche
->
∑gesInFlush
 = cache->
∑gesToFlush
;

821 
ˇche
->
∑gesToFlush
 = 0;

822 
	`ªœxedAdd64
(&
ˇche
->
°©s
.
ÊushCou¡
, 1);

824 
VIO
 *
vio
 = 
öfo
->vio;

825 
PhysiˇlLayî
 *
œyî
 = 
vio
->
com∂ëi⁄
.layer;

826 i‡(
œyî
->
	`isFlushRequúed
(layer)) {

827 
	`œunchFlush
(
vio
, 
wrôePages
, 
h™dÀFlushEº‹
);

831 
	`wrôePages
(&
vio
->
com∂ëi⁄
);

832 
	}
}

840 
	$scheduÀPageSave
(
PageInfo
 *
öfo
)

842 i‡(
öfo
->
busy
 > 0) {

843 
öfo
->
wrôeSètus
 = 
WRITE_STATUS_DEFERRED
;

847 
öfo
->
ˇche
->
∑gesToFlush
++;

848 
öfo
->
ˇche
->
out°™dögWrôes
++;

849 
	`£tInfoSèã
(
öfo
, 
PS_OUTGOING
);

850 
	}
}

853 
	$wrôeDútyPagesCÆlback
(
RögNode
 *
expúed
, *
c⁄ãxt
)

855 !
	`isRögEm±y
(
expúed
)) {

856 
	`scheduÀPageSave
(
	`∑geInfoFromLi°Node
(
	`ch›RögNode
(
expúed
)));

859 
	`ßvePages
((
VDOPageCache
 *Ë
c⁄ãxt
);

860 
	}
}

868 
	$œunchPageSave
(
PageInfo
 *
öfo
)

870 
	`scheduÀPageSave
(
öfo
);

871 
	`ßvePages
(
öfo
->
ˇche
);

872 
	}
}

883 
boﬁ
 
	$com∂ëi⁄NìdsPage
(
Waôî
 *
waôî
, *
c⁄ãxt
)

885 
PhysiˇlBlockNumbî
 *
pbn
 = 
c⁄ãxt
;

886  (
	`∑geCom∂ëi⁄FromWaôî
(
waôî
)->
pbn
 == *pbn);

887 
	}
}

893 
	$ÆloˇãFªePage
(
PageInfo
 *
öfo
)

895 
VDOPageCache
 *
ˇche
 = 
öfo
->cache;

896 
	`as£πOnCacheThªad
(
ˇche
, 
__func__
);

898 i‡(!
	`hasWaôîs
(&
ˇche
->
‰ìWaôîs
)) {

899 i‡(
	`ªœxedLﬂd64
(&
ˇche
->
°©s
.
ˇchePªssuª
) > 0) {

900 
	`logInfo
("page cacheÖressureÑelieved");

901 
	`ªœxedSt‹e64
(&
ˇche
->
°©s
.
ˇchePªssuª
, 0);

906 
ªsu…
 = 
	`ª£tPageInfo
(
öfo
);

907 i‡(
ªsu…
 !
VDO_SUCCESS
) {

908 
	`£tPîsi°ítEº‹
(
ˇche
, "ˇ¬ŸÑe£à∑gêöfo", 
ªsu…
);

912 
Waôî
 *
ﬁde°Waôî
 = 
	`gëFú°Waôî
(&
ˇche
->
‰ìWaôîs
);

913 
PhysiˇlBlockNumbî
 
pbn
 = 
	`∑geCom∂ëi⁄FromWaôî
(
ﬁde°Waôî
)->pbn;

917 
	`dequeueM©chögWaôîs
(&
ˇche
->
‰ìWaôîs
, 
com∂ëi⁄NìdsPage
,

918 &
pbn
, &
öfo
->
waôög
);

919 
ˇche
->
waôîCou¡
 -
	`cou¡Waôîs
(&
öfo
->
waôög
);

921 
ªsu…
 = 
	`œunchPageLﬂd
(
öfo
, 
pbn
);

922 i‡(
ªsu…
 !
VDO_SUCCESS
) {

923 
	`di°ribuãEº‹OvîQueue
(
ªsu…
, &
öfo
->
waôög
);

925 
	}
}

940 
	$disˇrdAPage
(
VDOPageCache
 *
ˇche
)

942 
PageInfo
 *
öfo
 = 
	`£À˘LRUPage
(
ˇche
);

943 i‡(
öfo
 =
NULL
) {

944 
	`ªp‹tCachePªssuª
(
ˇche
);

948 i‡(!
	`isDúty
(
öfo
)) {

949 
	`ÆloˇãFªePage
(
öfo
);

953 
	`ASSERT_LOG_ONLY
(!
	`isInFlight
(
öfo
),

956 ++
ˇche
->
disˇrdCou¡
;

957 
öfo
->
wrôeSètus
 = 
WRITE_STATUS_DISCARD
;

958 
	`œunchPageSave
(
öfo
);

959 
	}
}

967 
	$disˇrdPageF‹Com∂ëi⁄
(
VDOPageCom∂ëi⁄
 *
vdoPageComp
)

969 
VDOPageCache
 *
ˇche
 = 
vdoPageComp
->cache;

971 ++
ˇche
->
waôîCou¡
;

973 
ªsu…
 = 
	`íqueueWaôî
(&
ˇche
->
‰ìWaôîs
, &
vdoPageComp
->
waôî
);

974 i‡(
ªsu…
 !
VDO_SUCCESS
) {

975 
	`£tPîsi°ítEº‹
(
ˇche
, "ˇ¬ŸÉnqueuêwaôî", 
ªsu…
);

978 
	`disˇrdAPage
(
ˇche
);

979 
	}
}

986 
	$disˇrdPageIfNìded
(
VDOPageCache
 *
ˇche
)

988 i‡(
ˇche
->
waôîCou¡
 > cache->
disˇrdCou¡
) {

989 
	`disˇrdAPage
(
ˇche
);

991 
	}
}

994 
	$adv™˚VDOPageCachePîiod
(
VDOPageCache
 *
ˇche
, 
Sequí˚Numbî
 
≥riod
)

996 
	`as£πOnCacheThªad
(
ˇche
, 
__func__
);

997 
	`adv™˚Pîiod
(
ˇche
->
dútyLi°s
, 
≥riod
);

998 
	}
}

1007 
boﬁ
 
	$wrôeHasFöished
(
PageInfo
 *
öfo
)

1009 
	`as£πOnCacheThªad
(
öfo
->
ˇche
, 
__func__
);

1010 
öfo
->
ˇche
->
out°™dögWrôes
--;

1012 
boﬁ
 
wasDisˇrd
 = (
öfo
->
wrôeSètus
 =
WRITE_STATUS_DISCARD
);

1013 
öfo
->
wrôeSètus
 = 
WRITE_STATUS_NORMAL
;

1014  
wasDisˇrd
;

1015 
	}
}

1022 
	$h™dÀPageWrôeEº‹
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

1024 
ªsu…
 = 
com∂ëi⁄
->result;

1025 
PageInfo
 *
öfo
 = 
com∂ëi⁄
->
∑ª¡
;

1028 i‡(
ªsu…
 !
VDO_READ_ONLY
) {

1029 
	`logEº‹
("ÁûedÅÿwrôêblock m≠Öagê%" 
PRIu64
, 
öfo
->
pbn
);

1032 
	`£tInfoSèã
(
öfo
, 
PS_DIRTY
);

1033 
	`ªœxedAdd64
(&
öfo
->
ˇche
->
°©s
.
ÁûedWrôes
, 1);

1034 
	`£tPîsi°ítEº‹
(
öfo
->
ˇche
, "ˇ¬Ÿ wrôê∑ge", 
ªsu…
);

1036 i‡(!
	`wrôeHasFöished
(
öfo
)) {

1037 
	`disˇrdPageIfNìded
(
öfo
->
ˇche
);

1040 
	`checkF‹IOCom∂ëe
(
öfo
->
ˇche
);

1041 
	}
}

1049 
	$∑geIsWrôãnOut
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

1051 
PageInfo
 *
öfo
 = 
com∂ëi⁄
->
∑ª¡
;

1052 
VDOPageCache
 *
ˇche
 = 
öfo
->cache;

1054 i‡(
ˇche
->
wrôeHook
 !
NULL
) {

1055 
boﬁ
 
ªwrôe
 = 
ˇche
->
	`wrôeHook
(
	`gëPageBuf„r
(
öfo
), cache->
c⁄ãxt
);

1056 i‡(
ªwrôe
) {

1057 
	`œunchWrôeMëad©aVIOWôhFlush
(
öfo
->
vio
, info->
pbn
, 
∑geIsWrôãnOut
,

1058 
h™dÀPageWrôeEº‹
, 
åue
, 
Ál£
);

1063 
boﬁ
 
wasDisˇrd
 = 
	`wrôeHasFöished
(
öfo
);

1064 
boﬁ
 
ª˛aimed
 = (!
wasDisˇrd
 || (
öfo
->
busy
 > 0)

1065 || 
	`hasWaôîs
(&
öfo
->
waôög
));

1067 
	`£tInfoSèã
(
öfo
, 
PS_RESIDENT
);

1069 
uöt32_t
 
ª˛am©i⁄s
 = 
	`di°ribuãPageOvîQueue
(
öfo
, &öfo->
waôög
);

1070 
	`ªœxedAdd64
(&
ˇche
->
°©s
.
ª˛aimed
, 
ª˛am©i⁄s
);

1072 i‡(
wasDisˇrd
) {

1073 
ˇche
->
disˇrdCou¡
--;

1076 i‡(
ª˛aimed
) {

1077 
	`disˇrdPageIfNìded
(
ˇche
);

1079 
	`ÆloˇãFªePage
(
öfo
);

1082 
	`checkF‹IOCom∂ëe
(
ˇche
);

1083 
	}
}

1091 
	$wrôePages
(
VDOCom∂ëi⁄
 *
ÊushCom∂ëi⁄
)

1093 
VDOPageCache
 *
ˇche
 = ((
PageInfo
 *Ë
ÊushCom∂ëi⁄
->
∑ª¡
)->cache;

1094 
ˇche
->
∑gesInFlush
 > 0) {

1095 
ˇche
->
∑gesInFlush
--;

1096 
PageInfo
 *
öfo
 = 
	`∑geInfoFromLi°Node
(
	`ch›RögNode
(&
ˇche
->
outgoögLi°
));

1097 i‡(
	`isRódO∆y
(
öfo
->
ˇche
->
ªadO∆yC⁄ãxt
)) {

1098 
VDOCom∂ëi⁄
 *
com∂ëi⁄
 = &
öfo
->
vio
->completion;

1099 
	`ª£tCom∂ëi⁄
(
com∂ëi⁄
);

1100 
com∂ëi⁄
->
ˇŒback
 = 
∑geIsWrôãnOut
;

1101 
com∂ëi⁄
->
îr‹H™dÀr
 = 
h™dÀPageWrôeEº‹
;

1102 
	`föishCom∂ëi⁄
(
com∂ëi⁄
, 
VDO_READ_ONLY
);

1105 
	`ªœxedAdd64
(&
öfo
->
ˇche
->
°©s
.
∑gesSaved
, 1);

1106 
	`œunchWrôeMëad©aVIO
(
öfo
->
vio
, info->
pbn
, 
∑geIsWrôãnOut
,

1107 
h™dÀPageWrôeEº‹
);

1110 
	`ßvePages
(
ˇche
);

1111 
	}
}

1114 
	$ªÀa£VDOPageCom∂ëi⁄
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

1116 i‡(
com∂ëi⁄
 =
NULL
) {

1120 
PageInfo
 *
disˇrdInfo
 = 
NULL
;

1121 
VDOPageCom∂ëi⁄
 *
∑geCom∂ëi⁄
;

1122 i‡(
com∂ëi⁄
->
ªsu…
 =
VDO_SUCCESS
) {

1123 
∑geCom∂ëi⁄
 = 
	`vÆid©eCom∂ëedPage
(
com∂ëi⁄
, 
Ál£
);

1124 i‡(--
∑geCom∂ëi⁄
->
öfo
->
busy
 == 0) {

1125 
disˇrdInfo
 = 
∑geCom∂ëi⁄
->
öfo
;

1129 
∑geCom∂ëi⁄
 = 
	`asVDOPageCom∂ëi⁄
(
com∂ëi⁄
);

1131 
	`ASSERT_LOG_ONLY
((
∑geCom∂ëi⁄
->
waôî
.
√xtWaôî
 =
NULL
),

1134 
VDOPageCache
 *
ˇche
 = 
∑geCom∂ëi⁄
->cache;

1135 
	`as£πOnCacheThªad
(
ˇche
, 
__func__
);

1136 
	`mem£t
(
∑geCom∂ëi⁄
, 0, (
VDOPageCom∂ëi⁄
));

1138 i‡(
disˇrdInfo
 !
NULL
) {

1139 i‡(
disˇrdInfo
->
wrôeSètus
 =
WRITE_STATUS_DEFERRED
) {

1140 
disˇrdInfo
->
wrôeSètus
 = 
WRITE_STATUS_NORMAL
;

1141 
	`œunchPageSave
(
disˇrdInfo
);

1145 
	`disˇrdPageIfNìded
(
ˇche
);

1147 
	}
}

1155 
	$lﬂdPageF‹Com∂ëi⁄
(
PageInfo
 *
öfo
,

1156 
VDOPageCom∂ëi⁄
 *
vdoPageComp
)

1158 
ªsu…
 = 
	`íqueueWaôî
(&
öfo
->
waôög
, &
vdoPageComp
->
waôî
);

1159 i‡(
ªsu…
 !
VDO_SUCCESS
) {

1160 
	`föishCom∂ëi⁄
(&
vdoPageComp
->
com∂ëi⁄
, 
ªsu…
);

1164 
ªsu…
 = 
	`œunchPageLﬂd
(
öfo
, 
vdoPageComp
->
pbn
);

1165 i‡(
ªsu…
 !
VDO_SUCCESS
) {

1166 
	`di°ribuãEº‹OvîQueue
(
ªsu…
, &
öfo
->
waôög
);

1168 
	}
}

1171 
	$gëVDOPageAsync
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

1173 
VDOPageCom∂ëi⁄
 *
vdoPageComp
 = 
	`asVDOPageCom∂ëi⁄
(
com∂ëi⁄
);

1174 
VDOPageCache
 *
ˇche
 = 
vdoPageComp
->cache;

1175 
	`as£πOnCacheThªad
(
ˇche
, 
__func__
);

1177 i‡(
vdoPageComp
->
wrôabÀ
 && 
	`isRódO∆y
(
ˇche
->
ªadO∆yC⁄ãxt
)) {

1178 
	`föishCom∂ëi⁄
(
com∂ëi⁄
, 
VDO_READ_ONLY
);

1182 i‡(
vdoPageComp
->
wrôabÀ
) {

1183 
	`ªœxedAdd64
(&
ˇche
->
°©s
.
wrôeCou¡
, 1);

1185 
	`ªœxedAdd64
(&
ˇche
->
°©s
.
ªadCou¡
, 1);

1188 
PageInfo
 *
öfo
 = 
	`vpcFödPage
(
ˇche
, 
vdoPageComp
->
pbn
);

1189 i‡(
öfo
 !
NULL
) {

1191 i‡((
öfo
->
wrôeSètus
 =
WRITE_STATUS_DEFERRED
Ë|| 
	`isIncomög
(info)

1192 || (
	`isOutgoög
(
öfo
Ë&& 
vdoPageComp
->
wrôabÀ
)) {

1194 
	`ªœxedAdd64
(&
ˇche
->
°©s
.
waôF‹Page
, 1);

1195 
ªsu…
 = 
	`íqueueWaôî
(&
öfo
->
waôög
, &
vdoPageComp
->
waôî
);

1196 i‡(
ªsu…
 !
VDO_SUCCESS
) {

1197 
	`föishCom∂ëi⁄
(&
vdoPageComp
->
com∂ëi⁄
, 
ªsu…
);

1203 i‡(
	`isVÆid
(
öfo
)) {

1205 
	`ªœxedAdd64
(&
ˇche
->
°©s
.
foundInCache
, 1);

1206 i‡(!
	`isPª£¡
(
öfo
)) {

1207 
	`ªœxedAdd64
(&
ˇche
->
°©s
.
ªadOutgoög
, 1);

1209 
	`upd©eLru
(
öfo
);

1210 ++
öfo
->
busy
;

1211 
	`com∂ëeWôhPage
(
öfo
, 
vdoPageComp
);

1215 
	`ASSERT_LOG_ONLY
(
Ál£
, "Info found iná usable state.");

1219 
öfo
 = 
	`födFªePage
(
ˇche
);

1220 i‡(
öfo
 !
NULL
) {

1221 
	`ªœxedAdd64
(&
ˇche
->
°©s
.
„tchRequúed
, 1);

1222 
	`lﬂdPageF‹Com∂ëi⁄
(
öfo
, 
vdoPageComp
);

1227 
	`ªœxedAdd64
(&
ˇche
->
°©s
.
disˇrdRequúed
, 1);

1228 
	`disˇrdPageF‹Com∂ëi⁄
(
vdoPageComp
);

1229 
	}
}

1232 
	$m¨kCom∂ëedVDOPageDúty
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
,

1233 
Sequí˚Numbî
 
ﬁdDútyPîiod
,

1234 
Sequí˚Numbî
 
√wDútyPîiod
)

1236 
VDOPageCom∂ëi⁄
 *
vdoPageComp
 = 
	`vÆid©eCom∂ëedPage
(
com∂ëi⁄
, 
åue
);

1237 i‡(
vdoPageComp
 =
NULL
) {

1241 
PageInfo
 *
öfo
 = 
vdoPageComp
->info;

1242 
	`£tInfoSèã
(
öfo
, 
PS_DIRTY
);

1243 
	`addToDútyLi°s
(
öfo
->
ˇche
->
dútyLi°s
, &öfo->
li°Node
, 
ﬁdDútyPîiod
,

1244 
√wDútyPîiod
);

1245 
	}
}

1248 
	$ªque°VDOPageWrôe
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

1250 
VDOPageCom∂ëi⁄
 *
vdoPageComp
 = 
	`vÆid©eCom∂ëedPage
(
com∂ëi⁄
, 
åue
);

1251 i‡(
vdoPageComp
 =
NULL
) {

1255 
PageInfo
 *
öfo
 = 
vdoPageComp
->info;

1256 
	`£tInfoSèã
(
öfo
, 
PS_DIRTY
);

1257 
	`œunchPageSave
(
öfo
);

1258 
	}
}

1261 c⁄° *
	$dîe„ªn˚RódabÀVDOPage
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

1263 
VDOPageCom∂ëi⁄
 *
vdoPageComp
 = 
	`vÆid©eCom∂ëedPage
(
com∂ëi⁄
, 
Ál£
);

1265 i‡(
vdoPageComp
 =
NULL
) {

1266  
NULL
;

1269  
	`gëPageBuf„r
(
vdoPageComp
->
öfo
);

1270 
	}
}

1273 *
	$dîe„ªn˚WrôabÀVDOPage
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

1275 
VDOPageCom∂ëi⁄
 *
vdoPageComp
 = 
	`vÆid©eCom∂ëedPage
(
com∂ëi⁄
, 
åue
);

1277 i‡(
vdoPageComp
 =
NULL
) {

1278  
NULL
;

1281  
	`gëPageBuf„r
(
vdoPageComp
->
öfo
);

1282 
	}
}

1285 
	$ÊushVDOPageCacheAsync
(
VDOPageCache
 *
ˇche
, 
VDOCom∂ëi⁄
 *
∑ª¡
)

1287 
	`as£πOnCacheThªad
(
ˇche
, 
__func__
);

1288 i‡(
ˇche
->
ÊushCom∂ëi⁄
 !
NULL
) {

1289 
	`logW¨nög
("async cache operationálready inÖrogress, can't flush");

1290 
	`föishCom∂ëi⁄
(
∑ª¡
, 
VDO_COMPONENT_BUSY
);

1294 
PageInfo
 *
öfo
 = 
ˇche
->
öfos
; infÿ< cache->öfo†+ cache->
∑geCou¡
;

1295 ++
öfo
) {

1296 i‡(
öfo
->
busy
 > 0) {

1297 
	`logW¨nög
("unexpected busyÖage %lu during cache flush",

1298 
öfo
 - 
ˇche
->
öfos
);

1299 
	`föishCom∂ëi⁄
(
∑ª¡
, 
VDO_COMPONENT_BUSY
);

1305 
	`ÊushDútyLi°s
(
ˇche
->
dútyLi°s
);

1306 
ˇche
->
ÊushCom∂ëi⁄
 = 
∑ª¡
;

1307 
	`ßvePages
(
ˇche
);

1308 
	`checkF‹IOCom∂ëe
(
ˇche
);

1309 
	}
}

1312 
	$övÆid©eVDOPageCache
(
VDOPageCache
 *
ˇche
)

1314 
	`as£πOnCacheThªad
(
ˇche
, 
__func__
);

1317 
PageInfo
 *
öfo
 = 
ˇche
->
öfos
;

1318 
öfo
 < 
ˇche
->
öfos
 + cache->
∑geCou¡
;

1319 
öfo
++) {

1320 
ªsu…
 = 
	`ASSERT
(!
	`isDúty
(
öfo
), "cache must haveÇo dirtyÖages");

1321 i‡(
ªsu…
 !
VDO_SUCCESS
) {

1322  
ªsu…
;

1327 
	`‰ìI¡M≠
(&
ˇche
->
∑geM≠
);

1328  
	`makeI¡M≠
(
ˇche
->
∑geCou¡
, 0, &ˇche->
∑geM≠
);

1329 
	}
}

1332 
	$syncVDOPageCacheAsync
(
VDOPageCache
 *
ˇche
, 
VDOCom∂ëi⁄
 *
∑ª¡
)

1334 
	`as£πOnCacheThªad
(
ˇche
, 
__func__
);

1336 i‡(
ˇche
->
ÊushCom∂ëi⁄
 !
NULL
) {

1337 
	`logW¨nög
("async cache operationálready inÖrogress, can't sync");

1338 
	`föishCom∂ëi⁄
(
∑ª¡
, 
VDO_COMPONENT_BUSY
);

1342 
ˇche
->
ÊushCom∂ëi⁄
 = 
∑ª¡
;

1343 
	`checkF‹IOCom∂ëe
(
ˇche
);

1344 
	}
}

	@vdo/base/vdoPageCache.h

22 #i‚de‡
VDO_PAGE_CACHE_H


23 
	#VDO_PAGE_CACHE_H


	)

25 
	~"utû/©omic.h
"

27 
	~"com∂ëi⁄.h
"

28 
	~"ty≥s.h
"

29 
	~"waôQueue.h
"

34 
∑geInfo
 
	tPageInfo
;

40 
vdoPageCache
 
	tVDOPageCache
;

45 
uöt32_t
 
	tVDOPageGíî©i⁄
;

52 
Atomic64
 
	m‰ìPages
;

54 
Atomic64
 
	m˛ónPages
;

56 
Atomic64
 
	mdútyPages
;

58 
Atomic64
 
	möcomögPages
;

60 
Atomic64
 
	moutgoögPages
;

62 
Atomic64
 
	mÁûedPages
;

63 } 
	tAtomicPageSèãCou¡s
;

70 
AtomicPageSèãCou¡s
 
	mcou¡s
;

72 
Atomic64
 
	mˇchePªssuª
;

74 
Atomic64
 
	mªadCou¡
;

76 
Atomic64
 
	mwrôeCou¡
;

78 
Atomic64
 
	mÁûedRóds
;

80 
Atomic64
 
	mÁûedWrôes
;

82 
Atomic64
 
	mª˛aimed
;

84 
Atomic64
 
	mªadOutgoög
;

86 
Atomic64
 
	mfoundInCache
;

88 
Atomic64
 
	mdisˇrdRequúed
;

90 
Atomic64
 
	mwaôF‹Page
;

92 
Atomic64
 
	m„tchRequúed
;

94 
Atomic64
 
	m∑gesLﬂded
;

96 
Atomic64
 
	m∑gesSaved
;

98 
Atomic64
 
	mÊushCou¡
;

99 } 
	tAtomicPageCacheSèti°ics
;

113 
	tVDOPageRódFun˘i⁄
(*
	tøwPage
,

114 
	tPhysiˇlBlockNumbî
 
	tpbn
,

115 *
	tc⁄ãxt
);

127 
boﬁ
 
	tVDOPageWrôeFun˘i⁄
(*
	tøwPage
, *
	tc⁄ãxt
);

147 
	$makeVDOPageCache
(
ThªadID
 
thªadID
,

148 
PhysiˇlLayî
 *
œyî
,

149 
RódO∆yModeC⁄ãxt
 *
ªadO∆yC⁄ãxt
,

150 
PageCou¡
 
∑geCou¡
,

151 
VDOPageRódFun˘i⁄
 *
ªadHook
,

152 
VDOPageWrôeFun˘i⁄
 *
wrôeHook
,

153 *
fun˘i⁄C⁄ãxt
,

154 
BlockCou¡
 
maximumAge
,

155 
VDOPageCache
 **
ˇchePå
)

156 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

163 
	`‰ìVDOPageCache
(
VDOPageCache
 **
ˇchePå
);

171 
	`£tVDOPageCacheInôülPîiod
(
VDOPageCache
 *
ˇche
, 
Sequí˚Numbî
 
≥riod
);

180 
	`£tVDOPageCacheRebuûdMode
(
VDOPageCache
 *
ˇche
, 
boﬁ
 
ªbuûdög
);

188 
	`adv™˚VDOPageCachePîiod
(
VDOPageCache
 *
ˇche
, 
Sequí˚Numbî
 
≥riod
);

201 
	`wrôeVDOPageCachePages
(
VDOPageCache
 *
ˇche
,

202 
size_t
 
b©ches
,

203 
size_t
 
tŸÆ
);

213 
	`rŸ©eVDOPageCacheEøs
(
VDOPageCache
 *
ˇche
);

223 
VDOCom∂ëi⁄
 
com∂ëi⁄
;

225 
VDOPageCache
 *
ˇche
;

227 
Waôî
 
waôî
;

229 
PhysiˇlBlockNumbî
 
pbn
;

231 
boﬁ
 
wrôabÀ
;

233 
boﬁ
 
ªady
;

235 
PageInfo
 *
öfo
;

236 } 
	tVDOPageCom∂ëi⁄
;

254 
	`öôVDOPageCom∂ëi⁄
(
VDOPageCom∂ëi⁄
 *
∑geCom∂ëi⁄
,

255 
VDOPageCache
 *
ˇche
,

256 
PhysiˇlBlockNumbî
 
pbn
,

257 
boﬁ
 
wrôabÀ
,

258 *
∑ª¡
,

259 
VDOA˘i⁄
 *
ˇŒback
,

260 
VDOA˘i⁄
 *
îr‹H™dÀr
);

272 
	`ªÀa£VDOPageCom∂ëi⁄
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
);

286 
	`gëVDOPageAsync
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
);

296 
	`m¨kCom∂ëedVDOPageDúty
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
,

297 
Sequí˚Numbî
 
ﬁdDútyPîiod
,

298 
Sequí˚Numbî
 
√wDútyPîiod
);

305 
	`ªque°VDOPageWrôe
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
);

315 c⁄° *
	`dîe„ªn˚RódabÀVDOPage
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
);

325 *
	`dîe„ªn˚WrôabÀVDOPage
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
);

334 
	`ÊushVDOPageCacheAsync
(
VDOPageCache
 *
ˇche
, 
VDOCom∂ëi⁄
 *
∑ª¡
);

344 
	$övÆid©eVDOPageCache
(
VDOPageCache
 *
ˇche
)

345 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

356 
AtomicPageCacheSèti°ics
 *
	$gëVDOPageCacheSèti°ics
(
VDOPageCache
 *
ˇche
)

357 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

	@vdo/base/vdoPageCacheInternals.h

22 #i‚de‡
VDO_PAGE_CACHE_INTERNALS_H


23 
	#VDO_PAGE_CACHE_INTERNALS_H


	)

25 
	~"vdoPageCache.h
"

27 #i‚de‡
__KERNEL__


28 
	~<°döt.h
>

31 
	~"com∂ëi⁄.h
"

32 
	~"dútyLi°s.h
"

33 
	~"ötM≠.h
"

34 
	~"physiˇlLayî.h
"

35 
	~"ªadO∆yModeC⁄ãxt.h
"

36 
	~"rögNode.h
"

38 
	~"≥rmas£π.h
"

40 c⁄° 
PhysiˇlBlockNumbî
 
	gNO_PAGE
 = 0xFFFFFFFFFFFFFFFF;

45 
RögNode
 
	tPageInfoNode
;

50 
	svdoPageCache
 {

52 
PhysiˇlLayî
 *
	mœyî
;

54 
ThªadID
 
	mthªadID
;

56 
RódO∆yModeC⁄ãxt
 *
	mªadO∆yC⁄ãxt
;

58 
PageCou¡
 
	m∑geCou¡
;

60 
VDOPageRódFun˘i⁄
 *
	mªadHook
;

62 
VDOPageWrôeFun˘i⁄
 *
	mwrôeHook
;

64 *
	mc⁄ãxt
;

66 
PageCou¡
 
	m∑gesInB©ch
;

68 
boﬁ
 
	mªbuûdög
;

71 
PageInfo
 *
	möfos
;

73 *
	m∑ges
;

75 
PageInfo
 *
	mœ°Found
;

77 
I¡M≠
 *
	m∑geM≠
;

79 
PageInfoNode
 
	mÃuLi°
;

81 
DútyLi°s
 *
	mdútyLi°s
;

83 
PageInfoNode
 
	m‰ìLi°
;

85 
PageInfoNode
 
	moutgoögLi°
;

87 
PageCou¡
 
	mout°™dögRóds
;

89 
PageCou¡
 
	mout°™dögWrôes
;

91 
PageCou¡
 
	m∑gesInFlush
;

93 
PageCou¡
 
	m∑gesToFlush
;

95 
	mdisˇrdCou¡
;

97 
	mwaôîCou¡
;

99 
WaôQueue
 
	m‰ìWaôîs
;

101 
uöt64_t
 
	m√xtW¨nög
;

103 
AtomicPageCacheSèti°ics
 
	m°©s
;

105 
uöt32_t
 
	m¥essuªRï‹t
;

107 vﬁ©ûê
boﬁ
 
	mdumpMe
;

109 
VDOCom∂ëi⁄
 *
	mÊushCom∂ëi⁄
;

122 
	e∑geSèã
 {

124 
	mPS_FREE
,

126 
	mPS_INCOMING
,

128 
	mPS_FAILED
,

130 
	mPS_RESIDENT
,

132 
	mPS_DIRTY
,

134 
	mPS_OUTGOING
,

136 
	mPAGE_STATE_COUNT
,

137 } 
	tPageSèã
;

143 
	mWRITE_STATUS_NORMAL
,

144 
	mWRITE_STATUS_DISCARD
,

145 
	mWRITE_STATUS_DEFERRED
,

146 } 
	tWrôeSètus
;

151 
	s∑geInfo
 {

153 
VDOPageCache
 *
	mˇche
;

155 
PageSèã
 
	m°©e
;

157 
PhysiˇlBlockNumbî
 
	mpbn
;

159 
uöt16_t
 
	mbusy
;

161 
WrôeSètus
 
	mwrôeSètus
;

163 
WaôQueue
 
	mwaôög
;

165 
PageInfoNode
 
	mli°Node
;

167 
PageInfoNode
 
	mÃuNode
;

169 
VIO
 *
	mvio
;

175 
ölöe
 
PageInfo
 *
	$∑geInfoFromLi°Node
(
PageInfoNode
 *
node
)

177 i‡(
node
 =
NULL
) {

178  
NULL
;

180  (
PageInfo
 *Ë((
uöçå_t
Ë
node
 - 
	`off£tof
(PageInfo, 
li°Node
));

181 
	}
}

184 
ölöe
 
PageInfo
 *
	$∑geInfoFromLRUNode
(
PageInfoNode
 *
node
)

186 i‡(
node
 =
NULL
) {

187  
NULL
;

189  (
PageInfo
 *Ë((
uöçå_t
Ë
node
 - 
	`off£tof
(PageInfo, 
ÃuNode
));

190 
	}
}

195 
ölöe
 
boﬁ
 
	$isFªe
(c⁄° 
PageInfo
 *
öfo
)

197  
öfo
->
°©e
 =
PS_FREE
;

198 
	}
}

201 
ölöe
 
boﬁ
 
	$isAvaûabÀ
(c⁄° 
PageInfo
 *
öfo
)

203  (
öfo
->
°©e
 =
PS_FREE
Ë|| (öfo->°©ê=
PS_FAILED
);

204 
	}
}

207 
ölöe
 
boﬁ
 
	$isPª£¡
(c⁄° 
PageInfo
 *
öfo
)

209  (
öfo
->
°©e
 =
PS_RESIDENT
Ë|| (öfo->°©ê=
PS_DIRTY
);

210 
	}
}

213 
ölöe
 
boﬁ
 
	$isDúty
(c⁄° 
PageInfo
 *
öfo
)

215  
öfo
->
°©e
 =
PS_DIRTY
;

216 
	}
}

219 
ölöe
 
boﬁ
 
	$isResidít
(c⁄° 
PageInfo
 *
öfo
)

221  
öfo
->
°©e
 =
PS_RESIDENT
;

222 
	}
}

225 
ölöe
 
boﬁ
 
	$isInFlight
(c⁄° 
PageInfo
 *
öfo
)

227  (
öfo
->
°©e
 =
PS_INCOMING
Ë|| (öfo->°©ê=
PS_OUTGOING
);

228 
	}
}

231 
ölöe
 
boﬁ
 
	$isIncomög
(c⁄° 
PageInfo
 *
öfo
)

233  
öfo
->
°©e
 =
PS_INCOMING
;

234 
	}
}

237 
ölöe
 
boﬁ
 
	$isOutgoög
(c⁄° 
PageInfo
 *
öfo
)

239  
öfo
->
°©e
 =
PS_OUTGOING
;

240 
	}
}

243 
ölöe
 
boﬁ
 
	$isVÆid
(c⁄° 
PageInfo
 *
öfo
)

245  
	`isPª£¡
(
öfo
Ë|| 
	`isOutgoög
(info);

246 
	}
}

251 
ölöe
 
VDOPageCom∂ëi⁄
 *
	$asVDOPageCom∂ëi⁄
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

253 
	`STATIC_ASSERT
(
	`off£tof
(
VDOPageCom∂ëi⁄
, 
com∂ëi⁄
) == 0);

254 
	`as£πCom∂ëi⁄Ty≥
(
com∂ëi⁄
->
ty≥
, 
VDO_PAGE_COMPLETION
);

255  (
VDOPageCom∂ëi⁄
 *Ë
com∂ëi⁄
;

256 
	}
}

259 
ölöe


260 
VDOPageCom∂ëi⁄
 *
	$∑geCom∂ëi⁄FromWaôî
(
Waôî
 *
waôî
)

262 i‡(
waôî
 =
NULL
) {

263  
NULL
;

266 
VDOPageCom∂ëi⁄
 *
com∂ëi⁄
 = (VDOPageCompletion *)

267 ((
uöçå_t
Ë
waôî
 - 
	`off£tof
(
VDOPageCom∂ëi⁄
, waiter));

268 
	`as£πCom∂ëi⁄Ty≥
(
com∂ëi⁄
->com∂ëi⁄.
ty≥
, 
VDO_PAGE_COMPLETION
);

269  
com∂ëi⁄
;

270 
	}
}

285 
PageInfo
 *
	$vpcFödPage
(
VDOPageCache
 *
ˇche
, 
PhysiˇlBlockNumbî
 
pbn
)

286 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

298 c⁄° *
	$vpcPageSèãName
(
PageSèã
 
°©e
)

299 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

309 
	`syncVDOPageCacheAsync
(
VDOPageCache
 *
ˇche
, 
VDOCom∂ëi⁄
 *
∑ª¡
);

	@vdo/base/vdoRecovery.c

22 
	~"vdoRecovîyI¡î«ls.h
"

24 
	~"loggî.h
"

25 
	~"mem‹yAŒoc.h
"

27 
	~"blockM≠I¡î«ls.h
"

28 
	~"blockM≠Page.h
"

29 
	~"blockM≠Recovîy.h
"

30 
	~"com∂ëi⁄.h
"

31 
	~"numUtûs.h
"

32 
	~"ªcovîyJou∫ÆI¡î«ls.h
"

33 
	~"ªcovîyUtûs.h
"

34 
	~"rögNode.h
"

35 
	~"¶abDïŸ.h
"

36 
	~"¶abJou∫Æ.h
"

37 
	~"vdoI¡î«l.h
"

41 
	mINT_MAP_CAPACITY
 = 
MAXIMUM_USER_VIOS
 * 2,

43 
	mMAXIMUM_SYNTHESIZED_DECREFS
 = 
MAXIMUM_USER_VIOS
,

46 
	smissögDe¸ef
 {

48 
RögNode
 
	mrögNode
;

50 
RecovîyCom∂ëi⁄
 *
	mªcovîy
;

52 
BlockM≠SlŸ
 
	m¶Ÿ
;

54 
BlockM≠E¡ry
 
	m≥nu…im©eM≠pög
;

56 
VDOPageCom∂ëi⁄
 
	m∑geCom∂ëi⁄
;

57 } 
	tMissögDe¸ef
;

66 
__©åibuã__
((
w¨n_unu£d_ªsu…
))

67 
ölöe
 
MissögDe¸ef
 *
	$asMissögDe¸ef
(
RögNode
 *
rögNode
)

69 
	`STATIC_ASSERT
(
	`off£tof
(
MissögDe¸ef
, 
rögNode
) == 0);

70  (
MissögDe¸ef
 *Ë
rögNode
;

71 
	}
}

81 
	$makeMissögDe¸ef
(
RecovîyCom∂ëi⁄
 *
ªcovîy
,

82 
MissögDe¸ef
 **
de¸efPå
)

84 
MissögDe¸ef
 *
de¸ef
;

85 
ªsu…
 = 
	`ALLOCATE
(1, 
MissögDe¸ef
, 
__func__
, &
de¸ef
);

86 i‡(
ªsu…
 !
VDO_SUCCESS
) {

87  
ªsu…
;

89 
de¸ef
->
ªcovîy
 =Ñecovery;

90 
	`öôülizeRög
(&
de¸ef
->
rögNode
);

91 *
de¸efPå
 = 
de¸ef
;

92  
VDO_SUCCESS
;

93 
	}
}

100 
	$‰ìMissögDe¸ef
(
MissögDe¸ef
 **
de¸efPå
)

102 
MissögDe¸ef
 *
de¸ef
 = *
de¸efPå
;

103 i‡(
de¸ef
 =
NULL
) {

107 
	`FREE
(
de¸ef
);

108 *
de¸efPå
 = 
NULL
;

109 
	}
}

118 
uöt64_t
 
	$¶ŸAsNumbî
(
BlockM≠SlŸ
 
¶Ÿ
)

120  (((
uöt64_t
Ë
¶Ÿ
.
pbn
 << 10) + slot.slot);

121 
	}
}

129 
	$ö¸emítRecovîyPoöt
(
RecovîyPoöt
 *
poöt
,

130 
RecovîyJou∫Æ
 *
jou∫Æ
)

132 
poöt
->
íåyCou¡
++;

133 i‡((
poöt
->
£˘‹Cou¡
 =(
SECTORS_PER_BLOCK
 - 1))

134 && (
poöt
->
íåyCou¡
 =
jou∫Æ
->
œ°Se˘‹E¡rõs
)) {

135 
poöt
->
£quí˚Numbî
++;

136 
poöt
->
£˘‹Cou¡
 = 1;

137 
poöt
->
íåyCou¡
 = 0;

140 i‡(
poöt
->
íåyCou¡
 =
jou∫Æ
->
íåõsPîSe˘‹
) {

141 
poöt
->
£˘‹Cou¡
++;

142 
poöt
->
íåyCou¡
 = 0;

145 
	}
}

153 
	$de¸emítRecovîyPoöt
(
RecovîyPoöt
 *
poöt
,

154 
RecovîyJou∫Æ
 *
jou∫Æ
)

156 i‡((
poöt
->
£˘‹Cou¡
 <1Ë&& (poöt->
íåyCou¡
 == 0)) {

157 
poöt
->
£quí˚Numbî
--;

158 
poöt
->
£˘‹Cou¡
 = 
SECTORS_PER_BLOCK
 - 1;

159 
poöt
->
íåyCou¡
 = 
jou∫Æ
->
œ°Se˘‹E¡rõs
 - 1;

163 i‡(
poöt
->
íåyCou¡
 == 0) {

164 
poöt
->
£˘‹Cou¡
--;

165 
poöt
->
íåyCou¡
 = 
jou∫Æ
->
íåõsPîSe˘‹
 - 1;

169 
poöt
->
íåyCou¡
--;

170 
	}
}

180 
__©åibuã__
((
w¨n_unu£d_ªsu…
))

181 
boﬁ
 
	$bef‹eRecovîyPoöt
(c⁄° 
RecovîyPoöt
 *
fú°
,

182 c⁄° 
RecovîyPoöt
 *
£c⁄d
)

184 i‡(
fú°
->
£quí˚Numbî
 < 
£c⁄d
->sequenceNumber) {

185  
åue
;

188 i‡(
fú°
->
£quí˚Numbî
 > 
£c⁄d
->sequenceNumber) {

189  
Ál£
;

192 i‡(
fú°
->
£˘‹Cou¡
 < 
£c⁄d
->sectorCount) {

193  
åue
;

196  ((
fú°
->
£˘‹Cou¡
 =
£c⁄d
->sectorCount)

197 && (
fú°
->
íåyCou¡
 < 
£c⁄d
->entryCount));

198 
	}
}

201 
	$makeRecovîyCom∂ëi⁄
(
VDO
 *
vdo
, 
RecovîyCom∂ëi⁄
 **
ªcovîyPå
)

203 
RecovîyCom∂ëi⁄
 *
ªcovîy
;

204 
ªsu…
 = 
	`ALLOCATE
(1, 
RecovîyCom∂ëi⁄
, 
__func__
, &
ªcovîy
);

205 i‡(
ªsu…
 !
VDO_SUCCESS
) {

206  
ªsu…
;

209 
ªsu…
 = 
	`öôülizeEnqueuóbÀCom∂ëi⁄
(&
ªcovîy
->
com∂ëi⁄
,

210 
RECOVERY_COMPLETION
, 
vdo
->
œyî
);

211 i‡(
ªsu…
 !
VDO_SUCCESS
) {

212 
	`‰ìRecovîyCom∂ëi⁄
(&
ªcovîy
);

213  
ªsu…
;

216 
ªsu…
 = 
	`öôülizeEnqueuóbÀCom∂ëi⁄
(&
ªcovîy
->
subTaskCom∂ëi⁄
,

217 
SUB_TASK_COMPLETION
, 
vdo
->
œyî
);

218 i‡(
ªsu…
 !
VDO_SUCCESS
) {

219 
	`‰ìRecovîyCom∂ëi⁄
(&
ªcovîy
);

220  
ªsu…
;

223 
ªsu…
 = 
	`makeI¡M≠
(
INT_MAP_CAPACITY
, 0, &
ªcovîy
->
¶ŸE¡ryM≠
);

224 i‡(
ªsu…
 !
VDO_SUCCESS
) {

225 
	`‰ìRecovîyCom∂ëi⁄
(&
ªcovîy
);

226  
ªsu…
;

229 
	`öôülizeRög
(&
ªcovîy
->
öcom∂ëeDe¸efs
);

230 
	`öôülizeRög
(&
ªcovîy
->
com∂ëeDe¸efs
);

231 
ªcovîy
->
vdo
 = vdo;

232 *
ªcovîyPå
 = 
ªcovîy
;

233  
VDO_SUCCESS
;

234 
	}
}

237 
	$‰ìRecovîyCom∂ëi⁄
(
RecovîyCom∂ëi⁄
 **
ªcovîyPå
)

239 
RecovîyCom∂ëi⁄
 *
ªcovîy
 = *
ªcovîyPå
;

240 i‡(
ªcovîy
 =
NULL
) {

244 
MissögDe¸ef
 *
cuºítDe¸ef
;

245 !
	`isRögEm±y
(&
ªcovîy
->
öcom∂ëeDe¸efs
)) {

246 
cuºítDe¸ef
 = 
	`asMissögDe¸ef
(
	`p›RögNode
(&
ªcovîy
->
öcom∂ëeDe¸efs
));

247 
	`‰ìMissögDe¸ef
(&
cuºítDe¸ef
);

250 !
	`isRögEm±y
(&
ªcovîy
->
com∂ëeDe¸efs
)) {

251 
cuºítDe¸ef
 = 
	`asMissögDe¸ef
(
	`p›RögNode
(&
ªcovîy
->
com∂ëeDe¸efs
));

252 
	`‰ìMissögDe¸ef
(&
cuºítDe¸ef
);

255 
	`‰ìI¡M≠
(&
ªcovîy
->
¶ŸE¡ryM≠
);

256 
	`FREE
(
ªcovîy
->
jou∫ÆD©a
);

257 
	`FREE
(
ªcovîy
->
íåõs
);

258 
	`de°royEnqueuóbÀ
(&
ªcovîy
->
subTaskCom∂ëi⁄
);

259 
	`de°royEnqueuóbÀ
(&
ªcovîy
->
com∂ëi⁄
);

260 
	`FREE
(
ªcovîy
);

261 *
ªcovîyPå
 = 
NULL
;

262 
	}
}

269 
	$föishRecovîy
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

271 
VDOCom∂ëi⁄
 *
∑ª¡
 = 
com∂ëi⁄
->parent;

272 
RecovîyCom∂ëi⁄
 *
ªcovîy
 = 
	`asRecovîyCom∂ëi⁄
(
com∂ëi⁄
);

273 
VDO
 *
vdo
 = 
ªcovîy
->vdo;

274 
uöt64_t
 
ªcovîyCou¡
 = ++
vdo
->
com∂ëeRecovîõs
;

275 
	`öôülizeRecovîyJou∫ÆPo°Recovîy
(
vdo
->
ªcovîyJou∫Æ
,

276 
ªcovîyCou¡
, 
ªcovîy
->
highe°Taû
);

277 
	`‰ìRecovîyCom∂ëi⁄
(&
ªcovîy
);

278 
	`logInfo
("Rebuild complete.");

282 
ªsu…
 = 
	`ÆloˇãSœbRefCou¡s
(
vdo
->
dïŸ
, vdo->
œyî
);

283 
	`föishCom∂ëi⁄
(
∑ª¡
, 
ªsu…
);

284 
	}
}

291 
	$ab‹tRecovîy
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

293 
VDOCom∂ëi⁄
 *
∑ª¡
 = 
com∂ëi⁄
->parent;

294 
ªsu…
 = 
com∂ëi⁄
->result;

295 
RecovîyCom∂ëi⁄
 *
ªcovîy
 = 
	`asRecovîyCom∂ëi⁄
(
com∂ëi⁄
);

296 
	`‰ìRecovîyCom∂ëi⁄
(&
ªcovîy
);

297 
	`logW¨nög
("Recoveryáborted");

298 
	`föishCom∂ëi⁄
(
∑ª¡
, 
ªsu…
);

299 
	}
}

309 
__©åibuã__
((
w¨n_unu£d_ªsu…
))

310 
boﬁ
 
	$ab‹tRecovîyOnEº‹
(
ªsu…
, 
RecovîyCom∂ëi⁄
 *
ªcovîy
)

312 i‡(
ªsu…
 =
VDO_SUCCESS
) {

313  
Ál£
;

316 
	`föishCom∂ëi⁄
(&
ªcovîy
->
com∂ëi⁄
, 
ªsu…
);

317  
åue
;

318 
	}
}

329 
RecovîyJou∫ÆE¡ry
 *
	$gëE¡ry
(
RecovîyCom∂ëi⁄
 *
ªcovîy
,

330 
RecovîyPoöt
 *
poöt
)

332 
RecovîyJou∫Æ
 *
jou∫Æ
 = 
ªcovîy
->
vdo
->
ªcovîyJou∫Æ
;

333 
PhysiˇlBlockNumbî
 
blockNumbî


334 
	`gëRecovîyJou∫ÆBlockNumbî
(
jou∫Æ
, 
poöt
->
£quí˚Numbî
);

335 
off_t
 
£˘‹Off£t


336 (
blockNumbî
 * 
VDO_BLOCK_SIZE
Ë+ (
poöt
->
£˘‹Cou¡
 * 
VDO_SECTOR_SIZE
);

337 
PackedJou∫ÆSe˘‹
 *
£˘‹


338 (
PackedJou∫ÆSe˘‹
 *Ë&
ªcovîy
->
jou∫ÆD©a
[
£˘‹Off£t
];

339  &
£˘‹
->
íåõs
[
poöt
->
íåyCou¡
];

340 
	}
}

350 
	$exåa˘Jou∫ÆE¡rõs
(
RecovîyCom∂ëi⁄
 *
ªcovîy
)

352 
VDO
 *
vdo
 = 
ªcovîy
->vdo;

353 
RecovîyJou∫Æ
 *
jou∫Æ
 = 
vdo
->
ªcovîyJou∫Æ
;

357 
ªsu…
 = 
	`ALLOCATE
(
ªcovîy
->
ö¸efCou¡
, 
NumbîedBlockM≠pög
, 
__func__
,

358 &
ªcovîy
->
íåõs
);

359 i‡(
ªsu…
 !
VDO_SUCCESS
) {

360  
ªsu…
;

363 
BlockM≠SlŸ
 
¶Ÿ
;

364 
Jou∫ÆO≥øti⁄
 
›î©i⁄
;

365 
RecovîyPoöt
 
ªcovîyPoöt
 = (RecoveryPoint) {

366 .
£quí˚Numbî
 = 
ªcovîy
->
blockM≠Hód
,

367 .
£˘‹Cou¡
 = 1,

368 .
íåyCou¡
 = 0,

370 
	`bef‹eRecovîyPoöt
(&
ªcovîyPoöt
, &
ªcovîy
->
èûRecovîyPoöt
)) {

371 
RecovîyJou∫ÆE¡ry
 *
íåy
 = 
	`gëE¡ry
(
ªcovîy
, &
ªcovîyPoöt
);

372 
ªsu…
 = 
	`decodeRecovîyJou∫ÆE¡ry
(
vdo
, 
íåy
, &
›î©i⁄
, &
¶Ÿ
, 
NULL
);

373 i‡(
ªsu…
 !
VDO_SUCCESS
) {

374 
	`íãrRódO∆yMode
(
jou∫Æ
->
ªadO∆yC⁄ãxt
, 
ªsu…
);

375  
ªsu…
;

378 i‡(
	`isIn¸emítO≥øti⁄
(
›î©i⁄
)) {

379 
ªcovîy
->
íåõs
[ªcovîy->
íåyCou¡
] = (
NumbîedBlockM≠pög
) {

380 .
blockM≠SlŸ
 = 
¶Ÿ
,

381 .
blockM≠E¡ry
 = 
íåy
->blockMapEntry,

382 .
numbî
 = 
ªcovîy
->
íåyCou¡
,

384 
ªcovîy
->
íåyCou¡
++;

387 
	`ö¸emítRecovîyPoöt
(&
ªcovîyPoöt
, 
jou∫Æ
);

390 
ªsu…
 = 
	`ASSERT
((
ªcovîy
->
íåyCou¡
 <ªcovîy->
ö¸efCou¡
),

392 i‡(
ªsu…
 !
VDO_SUCCESS
) {

393 
	`íãrRódO∆yMode
(
jou∫Æ
->
ªadO∆yC⁄ãxt
, 
ªsu…
);

396  
ªsu…
;

397 
	}
}

405 
	$œunchBlockM≠Recovîy
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

407 
RecovîyCom∂ëi⁄
 *
ªcovîy
 = 
	`asRecovîyCom∂ëi⁄
(
com∂ëi⁄
->
∑ª¡
);

408 
VDO
 *
vdo
 = 
ªcovîy
->vdo;

409 
	`as£πOnLogiˇlZ⁄eThªad
(
vdo
, 0, 
__func__
);

412 
ªsu…
 = 
	`exåa˘Jou∫ÆE¡rõs
(
ªcovîy
);

413 i‡(
	`ab‹tRecovîyOnEº‹
(
ªsu…
, 
ªcovîy
)) {

417 
	`¥ï¨eToFöishP¨ít
(
com∂ëi⁄
, &
ªcovîy
->completion);

418 
	`ªcovîBlockM≠
(
vdo
, 
ªcovîy
->
íåyCou¡
,Ñecovîy->
íåõs
, 
com∂ëi⁄
);

419 
	}
}

427 
	$°¨tSu≥rBlockSave
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

429 
RecovîyCom∂ëi⁄
 *
ªcovîy
 = 
	`asRecovîyCom∂ëi⁄
(
com∂ëi⁄
->
∑ª¡
);

430 
VDO
 *
vdo
 = 
ªcovîy
->vdo;

431 
	`as£πOnAdmöThªad
(
vdo
, 
__func__
);

433 
	`logInfo
("SavingÑecoveryÖrogress");

434 
vdo
->
°©e
 = 
VDO_REPLAYING
;

438 
	`¥ï¨eCom∂ëi⁄
(
com∂ëi⁄
, 
œunchBlockM≠Recovîy
, 
föishP¨ítCÆlback
,

439 
	`gëLogiˇlZ⁄eThªad
(
	`gëThªadC⁄fig
(
vdo
), 0),

440 
com∂ëi⁄
->
∑ª¡
);

441 
	`ßveVDOComp⁄ítsAsync
(
vdo
, 
com∂ëi⁄
);

442 
	}
}

449 
	$addSy¡hesizedE¡rõs
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

451 
RecovîyCom∂ëi⁄
 *
ªcovîy
 = 
	`asRecovîyCom∂ëi⁄
(
com∂ëi⁄
->
∑ª¡
);

452 
VDO
 *
vdo
 = 
ªcovîy
->vdo;

454 
	`as£πOnAdmöThªad
(
vdo
, 
__func__
);

457 
	`¥ï¨eCom∂ëi⁄
(
com∂ëi⁄
, 
addSy¡hesizedE¡rõs
,áddSynthesizedEntries,

458 
com∂ëi⁄
->
ˇŒbackThªadID
, &
ªcovîy
->completion);

460 
MissögDe¸ef
 *
cuºítDe¸ef
;

461 !
	`isRögEm±y
(&
ªcovîy
->
com∂ëeDe¸efs
)) {

462 
cuºítDe¸ef
 = 
	`asMissögDe¸ef
(
ªcovîy
->
com∂ëeDe¸efs
.
¥ev
);

463 
BlockM≠E¡ry
 *
≥nu…im©eM≠pög
 = &
cuºítDe¸ef
->penultimateMapping;

464 
PhysiˇlBlockNumbî
 
pbn
 = 
	`u≈ackPBN
(
≥nu…im©eM≠pög
);

465 i‡(
	`isInvÆid
(
≥nu…im©eM≠pög
)

466 || !
	`isPhysiˇlD©aBlock
(
vdo
->
dïŸ
, 
pbn
)) {

468 
ªsu…
 = 
	`logEº‹WôhSåögEº‹
(
VDO_BAD_MAPPING
,

470 
PRIu64
 " wôh sèã %u", 
pbn
,

471 
≥nu…im©eM≠pög
->
m≠pögSèã
);

472 
	`íãrRódO∆yMode
(&
vdo
->
ªadO∆yC⁄ãxt
, 
ªsu…
);

473 
	`föishCom∂ëi⁄
(&
ªcovîy
->
com∂ëi⁄
, 
ªsu…
);

477 i‡(
pbn
 =
ZERO_BLOCK
) {

478 
BlockM≠pögSèã
 
ﬁdM≠pögSèã
 = 
≥nu…im©eM≠pög
->
m≠pögSèã
;

479 i‡(
ﬁdM≠pögSèã
 !
MAPPING_STATE_UNMAPPED
) {

480 
ªcovîy
->
logiˇlBlocksU£d
--;

483 
	`p›RögNode
(&
ªcovîy
->
com∂ëeDe¸efs
);

484 
	`‰ìMissögDe¸ef
(&
cuºítDe¸ef
);

488 
SœbJou∫Æ
 *
¶abJou∫Æ
 = 
	`gëSœbJou∫Æ
(
vdo
->
dïŸ
, 
pbn
);

489 i‡(!
	`mayAddSœbJou∫ÆE¡ry
(
¶abJou∫Æ
, 
DATA_DECREMENT
, 
com∂ëi⁄
)) {

493 
	`p›RögNode
(&
ªcovîy
->
com∂ëeDe¸efs
);

494 
BlockM≠pögSèã
 
ﬁdM≠pögSèã
 = 
≥nu…im©eM≠pög
->
m≠pögSèã
;

495 i‡(
ﬁdM≠pögSèã
 !
MAPPING_STATE_UNMAPPED
) {

496 
ªcovîy
->
logiˇlBlocksU£d
--;

499 
	`addSœbJou∫ÆE¡ryF‹Rebuûd
(
¶abJou∫Æ
, 
pbn
, 
DATA_DECREMENT
,

500 &
ªcovîy
->
√xtJou∫ÆPoöt
);

510 
ªcovîy
->
√xtJou∫ÆPoöt
.
íåyCou¡
++;

511 
	`‰ìMissögDe¸ef
(&
cuºítDe¸ef
);

514 
	`logInfo
("Synthesized %zu missing journalÉntries",

515 
ªcovîy
->
missögDe¸efCou¡
);

516 
vdo
->
ªcovîyJou∫Æ
->
logiˇlBlocksU£d
 = 
ªcovîy
->logicalBlocksUsed;

517 
vdo
->
ªcovîyJou∫Æ
->
blockM≠D©aBlocks
 = 
ªcovîy
->blockMapDataBlocks;

519 
	`¥ï¨eCom∂ëi⁄
(
com∂ëi⁄
, 
°¨tSu≥rBlockSave
, 
föishP¨ítCÆlback
,

520 
com∂ëi⁄
->
ˇŒbackThªadID
, com∂ëi⁄->
∑ª¡
);

521 
	`ÊushDïŸSœbJou∫Æs
(
vdo
->
dïŸ
, 
com∂ëi⁄
, 
föishP¨ítCÆlback
,

522 
föishP¨ítCÆlback
);

523 
	}
}

534 
	$compuãUßges
(
RecovîyCom∂ëi⁄
 *
ªcovîy
)

536 
RecovîyJou∫Æ
 *
jou∫Æ
 = 
ªcovîy
->
vdo
->
ªcovîyJou∫Æ
;

537 
PackedJou∫ÆHódî
 *
èûHódî


538 
	`gëJou∫ÆBlockHódî
(
jou∫Æ
, 
ªcovîy
->
jou∫ÆD©a
,Ñecovîy->
èû
);

539 
ªcovîy
->
logiˇlBlocksU£d
 = 
èûHódî
->logicalBlocksUsed;

540 
ªcovîy
->
blockM≠D©aBlocks
 = 
èûHódî
->blockMapDataBlocks;

542 
Jou∫ÆO≥øti⁄
 
›î©i⁄
;

543 
BlockM≠SlŸ
 
unu£d
;

544 
RecovîyPoöt
 
ªcovîyPoöt
 = (RecoveryPoint) {

545 .
£quí˚Numbî
 = 
ªcovîy
->
èû
,

546 .
£˘‹Cou¡
 = 1,

547 .
íåyCou¡
 = 0,

549 
	`bef‹eRecovîyPoöt
(&
ªcovîyPoöt
, &
ªcovîy
->
èûRecovîyPoöt
)) {

550 
RecovîyJou∫ÆE¡ry
 *
íåy
 = 
	`gëE¡ry
(
ªcovîy
, &
ªcovîyPoöt
);

551 
	`decodeO≥øti⁄AndBlockM≠SlŸ
(
íåy
, &
›î©i⁄
, &
unu£d
);

552 i‡(
íåy
->
blockM≠E¡ry
.
m≠pögSèã
 !
MAPPING_STATE_UNMAPPED
) {

553 
›î©i⁄
) {

554 
DATA_INCREMENT
:

555 
ªcovîy
->
logiˇlBlocksU£d
++;

558 
DATA_DECREMENT
:

559 
ªcovîy
->
logiˇlBlocksU£d
--;

562 
BLOCK_MAP_INCREMENT
:

563 
ªcovîy
->
blockM≠D©aBlocks
++;

567  
	`logEº‹WôhSåögEº‹
(
VDO_CORRUPT_JOURNAL
,

569 "£quí˚Çumbî %" 
PRIu64


572 
ªcovîyPoöt
.
£quí˚Numbî
,

573 
ªcovîyPoöt
.
£˘‹Cou¡
,

574 
ªcovîyPoöt
.
íåyCou¡
,

575 
›î©i⁄
);

579 
	`ö¸emítRecovîyPoöt
(&
ªcovîyPoöt
, 
jou∫Æ
);

582  
VDO_SUCCESS
;

583 
	}
}

590 
	$≠∂ySy¡hesizedDe¸efs
(
RecovîyCom∂ëi⁄
 *
ªcovîy
)

592 i‡(
	`ab‹tRecovîyOnEº‹
(
ªcovîy
->
com∂ëi⁄
.
ªsu…
,Ñecovery)) {

596 
	`logInfo
("Recreating missing journalÉntries");

597 
ªsu…
 = 
	`compuãUßges
(
ªcovîy
);

598 i‡(
	`ab‹tRecovîyOnEº‹
(
ªsu…
, 
ªcovîy
)) {

602 
ªcovîy
->
√xtJou∫ÆPoöt
 = (
Jou∫ÆPoöt
) {

603 .
£quí˚Numbî
 = 
ªcovîy
->
èû
,

604 .
íåyCou¡
 = 
ªcovîy
->
vdo
->
ªcovîyJou∫Æ
->
íåõsPîBlock
,

606 
	`œunchCÆlbackWôhP¨ít
(&
ªcovîy
->
subTaskCom∂ëi⁄
, 
addSy¡hesizedE¡rõs
,

607 
	`gëAdmöThªad
(
	`gëThªadC⁄fig
(
ªcovîy
->
vdo
)),

608 &
ªcovîy
->
com∂ëi⁄
);

609 
	}
}

616 
	$¥o˚ssFëchedPage
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

618 
MissögDe¸ef
 *
cuºítDe¸ef
 = 
com∂ëi⁄
->
∑ª¡
;

619 
RecovîyCom∂ëi⁄
 *
ªcovîy
 = 
cuºítDe¸ef
->recovery;

620 
	`as£πOnLogiˇlZ⁄eThªad
(
ªcovîy
->
vdo
, 0, 
__func__
);

622 i‡(
com∂ëi⁄
->
ªsu…
 !
VDO_SUCCESS
) {

623 
	`£tCom∂ëi⁄Resu…
(&
ªcovîy
->
com∂ëi⁄
, com∂ëi⁄->
ªsu…
);

625 c⁄° 
BlockM≠Page
 *
∑ge
 = 
	`dîe„ªn˚RódabÀVDOPage
(
com∂ëi⁄
);

626 
cuºítDe¸ef
->
≥nu…im©eM≠pög


627 
∑ge
->
íåõs
[
cuºítDe¸ef
->
¶Ÿ
.slot];

630 
	`ªÀa£VDOPageCom∂ëi⁄
(
com∂ëi⁄
);

631 
ªcovîy
->
out°™dög
--;

632 i‡(
ªcovîy
->
out°™dög
 == 0) {

633 
	`≠∂ySy¡hesizedDe¸efs
(
ªcovîy
);

635 
	}
}

642 
	$födPBNsFromBlockM≠
(
RecovîyCom∂ëi⁄
 *
ªcovîy
)

644 
	`as£πOnLogiˇlZ⁄eThªad
(
ªcovîy
->
vdo
, 0, 
__func__
);

647 
BlockM≠
 *
blockM≠
 = 
	`gëBlockM≠
(
ªcovîy
->
vdo
);

648 
BlockM≠Z⁄e
 *
z⁄e
 = 
	`gëBlockM≠Z⁄e
(
blockM≠
, 0);

649 
RögNode
 *
cuºítRögNode
 = 
ªcovîy
->
öcom∂ëeDe¸efs
.
√xt
;

650 
MissögDe¸ef
 *
cuºítDe¸ef
;

652 
cuºítRögNode
 !&
ªcovîy
->
öcom∂ëeDe¸efs
) {

653 
cuºítDe¸ef
 = 
	`asMissögDe¸ef
(
cuºítRögNode
);

654 
	`öôVDOPageCom∂ëi⁄
(&
cuºítDe¸ef
->
∑geCom∂ëi⁄
, 
z⁄e
->
∑geCache
,

655 
cuºítDe¸ef
->
¶Ÿ
.
pbn
, 
Ál£
, currentDecref,

656 
¥o˚ssFëchedPage
,ÖrocessFetchedPage);

657 
ªcovîy
->
out°™dög
++;

658 
cuºítRögNode
 = cuºítRögNode->
√xt
;

662 i‡(
ªcovîy
->
out°™dög
 == 0) {

663 
	`≠∂ySy¡hesizedDe¸efs
(
ªcovîy
);

668 !
	`isRögEm±y
(&
ªcovîy
->
öcom∂ëeDe¸efs
)) {

669 
cuºítDe¸ef
 = 
	`asMissögDe¸ef
(
	`p›RögNode
(&
ªcovîy
->
öcom∂ëeDe¸efs
));

670 
	`pushRögNode
(&
ªcovîy
->
com∂ëeDe¸efs
, &
cuºítDe¸ef
->
rögNode
);

671 
	`gëVDOPageAsync
(&
cuºítDe¸ef
->
∑geCom∂ëi⁄
.
com∂ëi⁄
);

673 
	}
}

692 
	$födMissögDe¸efs
(
RecovîyCom∂ëi⁄
 *
ªcovîy
)

694 
I¡M≠
 *
¶ŸE¡ryM≠
 = 
ªcovîy
->slotEntryMap;

697 
MissögDe¸ef
 
foundDe¸ef
;

701 
Sequí˚Numbî
 
hód
 = 
	`möSequí˚Numbî
(
ªcovîy
->
blockM≠Hód
,

702 
ªcovîy
->
¶abJou∫ÆHód
);

703 
RecovîyPoöt
 
hódPoöt
 = (RecoveryPoint) {

704 .
£quí˚Numbî
 = 
hód
,

705 .
£˘‹Cou¡
 = 1,

706 .
íåyCou¡
 = 0,

709 
BlockM≠SlŸ
 
¶Ÿ
;

710 
Jou∫ÆO≥øti⁄
 
›î©i⁄
;

711 
RecovîyPoöt
 
ªcovîyPoöt
 = 
ªcovîy
->
èûRecovîyPoöt
;

712 
	`bef‹eRecovîyPoöt
(&
hódPoöt
, &
ªcovîyPoöt
)) {

713 
	`de¸emítRecovîyPoöt
(&
ªcovîyPoöt
, 
ªcovîy
->
vdo
->
ªcovîyJou∫Æ
);

714 
RecovîyJou∫ÆE¡ry
 *
íåy
 = 
	`gëE¡ry
(
ªcovîy
, &
ªcovîyPoöt
);

715 
	`decodeO≥øti⁄AndBlockM≠SlŸ
(
íåy
, &
›î©i⁄
, &
¶Ÿ
);

717 i‡(!
	`isIn¸emítO≥øti⁄
(
›î©i⁄
)) {

720 
ªsu…
 = 
	`ötM≠Put
(
¶ŸE¡ryM≠
, 
	`¶ŸAsNumbî
(
¶Ÿ
), &
foundDe¸ef
,

721 
Ál£
, 
NULL
);

722 i‡(
ªsu…
 !
VDO_SUCCESS
) {

723  
ªsu…
;

728 
ªcovîy
->
ö¸efCou¡
++;

730 
MissögDe¸ef
 *
de¸ef
 = 
	`ötM≠Remove
(
¶ŸE¡ryM≠
, 
	`¶ŸAsNumbî
(
¶Ÿ
));

731 i‡(
›î©i⁄
 =
BLOCK_MAP_INCREMENT
) {

732 i‡(
de¸ef
 !
NULL
) {

733  
	`logEº‹WôhSåögEº‹
(
VDO_CORRUPT_JOURNAL
,

735 
PRIu64
,

736 
	`u≈ackPBN
(&
íåy
->
blockM≠E¡ry
));

742 i‡(
de¸ef
 =&
foundDe¸ef
) {

748 i‡(
de¸ef
 =
NULL
) {

750 
ªsu…
 = 
	`makeMissögDe¸ef
(
ªcovîy
, &
de¸ef
);

751 i‡(
ªsu…
 !
VDO_SUCCESS
) {

752  
ªsu…
;

754 
ªcovîy
->
missögDe¸efCou¡
++;

755 
	`pushRögNode
(&
ªcovîy
->
öcom∂ëeDe¸efs
, &
de¸ef
->
rögNode
);

756 
de¸ef
->
¶Ÿ
 = slot;

757 
ªsu…
 = 
	`ötM≠Put
(
¶ŸE¡ryM≠
, 
	`¶ŸAsNumbî
(
¶Ÿ
), 
de¸ef
, 
Ál£
,

758 
NULL
);

759 i‡(
ªsu…
 !
VDO_SUCCESS
) {

760  
ªsu…
;

771 
de¸ef
->
≥nu…im©eM≠pög
 = 
íåy
->
blockM≠E¡ry
;

772 
	`pushRögNode
(&
ªcovîy
->
com∂ëeDe¸efs
, &
de¸ef
->
rögNode
);

775  
VDO_SUCCESS
;

776 
	}
}

779 
	$addSœbJou∫ÆE¡rõs
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

781 
RecovîyCom∂ëi⁄
 *
ªcovîy
 = 
	`asRecovîyCom∂ëi⁄
(
com∂ëi⁄
->
∑ª¡
);

782 
VDO
 *
vdo
 = 
ªcovîy
->vdo;

783 
RecovîyJou∫Æ
 *
jou∫Æ
 = 
vdo
->
ªcovîyJou∫Æ
;

786 
	`as£πOnLogiˇlZ⁄eThªad
(
vdo
, 0, 
__func__
);

789 
	`¥ï¨eCom∂ëi⁄
(
com∂ëi⁄
, 
addSœbJou∫ÆE¡rõs
,áddSlabJournalEntries,

790 
com∂ëi⁄
->
ˇŒbackThªadID
, &
ªcovîy
->completion);

792 
	`bef‹eRecovîyPoöt
(&
ªcovîy
->
√xtRecovîyPoöt
,

793 &
ªcovîy
->
èûRecovîyPoöt
)) {

794 
Jou∫ÆO≥øti⁄
 
›î©i⁄
;

795 
BlockM≠SlŸ
 
¶Ÿ
;

796 
PhysiˇlBlockNumbî
 
pbn
;

797 
RecovîyJou∫ÆE¡ry
 *
íåy
 = 
	`gëE¡ry
(
ªcovîy
,

798 &
ªcovîy
->
√xtRecovîyPoöt
);

799 
ªsu…
 = 
	`decodeRecovîyJou∫ÆE¡ry
(
vdo
, 
íåy
, &
›î©i⁄
, &
¶Ÿ
,

800 &
pbn
);

801 i‡(
ªsu…
 !
VDO_SUCCESS
) {

802 
	`íãrRódO∆yMode
(
jou∫Æ
->
ªadO∆yC⁄ãxt
, 
ªsu…
);

803 
	`föishCom∂ëi⁄
(&
ªcovîy
->
com∂ëi⁄
, 
ªsu…
);

807 i‡(
pbn
 =
ZERO_BLOCK
) {

808 
	`ö¸emítRecovîyPoöt
(&
ªcovîy
->
√xtRecovîyPoöt
, 
jou∫Æ
);

809 
	`adv™˚Jou∫ÆPoöt
(&
ªcovîy
->
√xtJou∫ÆPoöt
,

810 
jou∫Æ
->
íåõsPîBlock
);

814 
SœbJou∫Æ
 *
¶abJou∫Æ
 = 
	`gëSœbJou∫Æ
(
vdo
->
dïŸ
, 
pbn
);

815 i‡(!
	`mayAddSœbJou∫ÆE¡ry
(
¶abJou∫Æ
, 
›î©i⁄
, 
com∂ëi⁄
)) {

819 
	`addSœbJou∫ÆE¡ryF‹Rebuûd
(
¶abJou∫Æ
, 
pbn
, 
›î©i⁄
,

820 &
ªcovîy
->
√xtJou∫ÆPoöt
);

821 
	`ö¸emítRecovîyPoöt
(&
ªcovîy
->
√xtRecovîyPoöt
, 
jou∫Æ
);

822 
	`adv™˚Jou∫ÆPoöt
(&
ªcovîy
->
√xtJou∫ÆPoöt
, 
jou∫Æ
->
íåõsPîBlock
);

823 
ªcovîy
->
íåõsAddedToSœbJou∫Æs
++;

826 
	`logInfo
("Replayed %zu journalÉntries into slab journals",

827 
ªcovîy
->
íåõsAddedToSœbJou∫Æs
);

828 
ªsu…
 = 
	`födMissögDe¸efs
(
ªcovîy
);

829 i‡(
	`ab‹tRecovîyOnEº‹
(
ªsu…
, 
ªcovîy
)) {

833 
	`födPBNsFromBlockM≠
(
ªcovîy
);

834 
	}
}

843 
boﬁ
 
	$födC⁄tiguousR™ge
(
RecovîyCom∂ëi⁄
 *
ªcovîy
)

845 
RecovîyJou∫Æ
 *
jou∫Æ
 = 
ªcovîy
->
vdo
->
ªcovîyJou∫Æ
;

846 
Sequí˚Numbî
 
hód


847 
	`möSequí˚Numbî
(
ªcovîy
->
blockM≠Hód
,Ñecovîy->
¶abJou∫ÆHód
);

849 
boﬁ
 
foundE¡rõs
 = 
Ál£
;

850 
Sequí˚Numbî
 
i
 = 
hód
; i <
ªcovîy
->
highe°Taû
; i++) {

851 
ªcovîy
->
èû
 = 
i
;

852 
ªcovîy
->
èûRecovîyPoöt
 = (
RecovîyPoöt
) {

853 .
£quí˚Numbî
 = 
i
,

854 .
£˘‹Cou¡
 = 0,

855 .
íåyCou¡
 = 0,

858 
PackedJou∫ÆHódî
 *
hódî


859 
	`gëJou∫ÆBlockHódî
(
jou∫Æ
, 
ªcovîy
->
jou∫ÆD©a
, 
i
);

860 i‡(!
	`isExa˘RecovîyJou∫ÆBlock
(
jou∫Æ
, 
hódî
, 
i
)

861 || (
hódî
->
íåyCou¡
 > 
jou∫Æ
->
íåõsPîBlock
)) {

866 
Jou∫ÆE¡ryCou¡
 
blockE¡rõs
 = 
hódî
->
íåyCou¡
;

868 
uöt8_t
 
j
 = 1; j < 
SECTORS_PER_BLOCK
; j++) {

869 
PackedJou∫ÆSe˘‹
 *
£˘‹
 = 
	`gëJou∫ÆBlockSe˘‹
(
hódî
, 
j
);

872 i‡(!
	`isVÆidRecovîyJou∫ÆSe˘‹
(
hódî
, 
£˘‹
)) {

876 
Jou∫ÆE¡ryCou¡
 
£˘‹E¡rõs
 = 
	`möBlock
(
£˘‹
->
íåyCou¡
,

877 
blockE¡rõs
);

878 i‡(
£˘‹E¡rõs
 > 0) {

879 
foundE¡rõs
 = 
åue
;

880 
ªcovîy
->
èûRecovîyPoöt
.
£˘‹Cou¡
++;

881 
ªcovîy
->
èûRecovîyPoöt
.
íåyCou¡
 = 
£˘‹E¡rõs
;

882 
blockE¡rõs
 -
£˘‹E¡rõs
;

886 i‡((
£˘‹E¡rõs
 < 
jou∫Æ
->
íåõsPîSe˘‹
)

887 || (
blockE¡rõs
 == 0)) {

893 i‡((
hódî
->
íåyCou¡
 !
jou∫Æ
->
íåõsPîBlock
)

894 || (
blockE¡rõs
 > 0 )) {

900 i‡(
foundE¡rõs
 && (
ªcovîy
->
èûRecovîyPoöt
.
£˘‹Cou¡
 == 0)) {

901 
ªcovîy
->
èû
--;

904  
foundE¡rõs
;

905 
	}
}

912 
	$cou¡In¸emítE¡rõs
(
RecovîyCom∂ëi⁄
 *
ªcovîy
)

914 
VDO
 *
vdo
 = 
ªcovîy
->vdo;

915 
RecovîyJou∫Æ
 *
jou∫Æ
 = 
vdo
->
ªcovîyJou∫Æ
;

917 
RecovîyPoöt
 
ªcovîyPoöt
 = (RecoveryPoint) {

918 .
£quí˚Numbî
 = 
ªcovîy
->
blockM≠Hód
,

919 .
£˘‹Cou¡
 = 1,

920 .
íåyCou¡
 = 0,

922 
	`bef‹eRecovîyPoöt
(&
ªcovîyPoöt
, &
ªcovîy
->
èûRecovîyPoöt
)) {

923 
Jou∫ÆO≥øti⁄
 
›î©i⁄
;

924 
BlockM≠SlŸ
 
¶Ÿ
;

925 
ªsu…
 = 
	`decodeRecovîyJou∫ÆE¡ry
(
vdo
,

926 
	`gëE¡ry
(
ªcovîy
, &
ªcovîyPoöt
),

927 &
›î©i⁄
, &
¶Ÿ
, 
NULL
);

928 i‡(
ªsu…
 !
VDO_SUCCESS
) {

929 
	`íãrRódO∆yMode
(
jou∫Æ
->
ªadO∆yC⁄ãxt
, 
ªsu…
);

930  
ªsu…
;

932 i‡(
	`isIn¸emítO≥øti⁄
(
›î©i⁄
)) {

933 
ªcovîy
->
ö¸efCou¡
++;

935 
	`ö¸emítRecovîyPoöt
(&
ªcovîyPoöt
, 
jou∫Æ
);

938  
VDO_SUCCESS
;

939 
	}
}

948 
	$≠∂yJou∫ÆE¡rõs
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

950 
RecovîyCom∂ëi⁄
 *
ªcovîy
 = 
	`asRecovîyCom∂ëi⁄
(
com∂ëi⁄
->
∑ª¡
);

951 
VDO
 *
vdo
 = 
ªcovîy
->vdo;

952 
RecovîyJou∫Æ
 *
jou∫Æ
 = 
vdo
->
ªcovîyJou∫Æ
;

953 
	`logInfo
("FinishedÑeadingÑecovery journal");

954 
boﬁ
 
foundE¡rõs
 = 
	`födHódAndTaû
(
jou∫Æ
, 
ªcovîy
->
jou∫ÆD©a
,

955 &
ªcovîy
->
highe°Taû
,

956 &
ªcovîy
->
blockM≠Hód
,

957 &
ªcovîy
->
¶abJou∫ÆHód
);

958 i‡(
foundE¡rõs
) {

959 
foundE¡rõs
 = 
	`födC⁄tiguousR™ge
(
ªcovîy
);

963 i‡((
ªcovîy
->
blockM≠Hód
 >Ñecovîy->
èû
)

964 || (
ªcovîy
->
¶abJou∫ÆHód
 >Ñecovîy->
èû
)) {

965 
ªsu…
 = 
	`logEº‹WôhSåögEº‹
(
VDO_CORRUPT_JOURNAL
,

967 "block m≠ hód: %" 
PRIu64


968 ", sœb jou∫Æ hód: %" 
PRIu64


969 ",Åaû: %" 
PRIu64
,

970 
ªcovîy
->
blockM≠Hód
,

971 
ªcovîy
->
¶abJou∫ÆHód
,

972 
ªcovîy
->
èû
);

973 
	`föishCom∂ëi⁄
(&
ªcovîy
->
com∂ëi⁄
, 
ªsu…
);

977 i‡(!
foundE¡rõs
) {

979 
	`logInfo
("Replaying 0ÑecoveryÉntries into block map");

980 
	`föishCom∂ëi⁄
(&
ªcovîy
->
com∂ëi⁄
, 
VDO_SUCCESS
);

984 
	`logInfo
("Highest-numberedÑecovery journal block has sequenceÇumber"

985 " %" 
PRIu64
 ",ándÅhe highest-numbered usable block is %"

986 
PRIu64
, 
ªcovîy
->
highe°Taû
,Ñecovîy->
èû
);

988 i‡(
	`isRïœyög
(
vdo
)) {

991 
ªsu…
 = 
	`cou¡In¸emítE¡rõs
(
ªcovîy
);

992 i‡(
ªsu…
 !
VDO_SUCCESS
) {

993 
	`föishCom∂ëi⁄
(&
ªcovîy
->
com∂ëi⁄
, 
ªsu…
);

998 
	`œunchCÆlbackWôhP¨ít
(&
ªcovîy
->
subTaskCom∂ëi⁄
,

999 
œunchBlockM≠Recovîy
,

1000 
	`gëLogiˇlZ⁄eThªad
(
	`gëThªadC⁄fig
(
vdo
), 0),

1001 &
ªcovîy
->
com∂ëi⁄
);

1005 
	`logInfo
("ReplayingÉntries into slab journals");

1006 
ªcovîy
->
√xtRecovîyPoöt
 = (
RecovîyPoöt
) {

1007 .
£quí˚Numbî
 = 
ªcovîy
->
¶abJou∫ÆHód
,

1008 .
£˘‹Cou¡
 = 1,

1009 .
íåyCou¡
 = 0,

1012 
ªcovîy
->
√xtJou∫ÆPoöt
 = (
Jou∫ÆPoöt
) {

1013 .
£quí˚Numbî
 = 
ªcovîy
->
¶abJou∫ÆHód
,

1014 .
íåyCou¡
 = 0,

1018 
	`œunchCÆlbackWôhP¨ít
(&
ªcovîy
->
subTaskCom∂ëi⁄
, 
addSœbJou∫ÆE¡rõs
,

1019 
	`gëCÆlbackThªadID
(), &
ªcovîy
->
com∂ëi⁄
);

1020 
	}
}

1027 
	$lﬂdJou∫Æ
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

1029 
RecovîyCom∂ëi⁄
 *
ªcovîy
 = 
	`asRecovîyCom∂ëi⁄
(
com∂ëi⁄
->
∑ª¡
);

1030 
VDO
 *
vdo
 = 
ªcovîy
->vdo;

1031 
	`as£πOnLogiˇlZ⁄eThªad
(
vdo
, 0, 
__func__
);

1033 
	`¥ï¨eCom∂ëi⁄
(
com∂ëi⁄
, 
≠∂yJou∫ÆE¡rõs
, 
föishP¨ítCÆlback
,

1034 
	`gëLogiˇlZ⁄eThªad
(
	`gëThªadC⁄fig
(
vdo
), 0),

1035 
com∂ëi⁄
->
∑ª¡
);

1036 
	`lﬂdJou∫ÆAsync
(
vdo
->
ªcovîyJou∫Æ
, 
com∂ëi⁄
, &
ªcovîy
->
jou∫ÆD©a
);

1037 
	}
}

1040 
	$œunchRecovîy
(
VDO
 *
vdo
, 
VDOCom∂ëi⁄
 *
∑ª¡
)

1043 
	`logW¨nög
("Device was dirty,ÑebuildingÑeference counts");

1045 
RecovîyCom∂ëi⁄
 *
ªcovîy
;

1046 
ªsu…
 = 
	`makeRecovîyCom∂ëi⁄
(
vdo
, &
ªcovîy
);

1047 i‡(
ªsu…
 !
VDO_SUCCESS
) {

1048 
	`föishCom∂ëi⁄
(
∑ª¡
, 
ªsu…
);

1052 
VDOCom∂ëi⁄
 *
com∂ëi⁄
 = &
ªcovîy
->completion;

1053 
	`¥ï¨eCom∂ëi⁄
(
com∂ëi⁄
, 
föishRecovîy
, 
ab‹tRecovîy
,

1054 
∑ª¡
->
ˇŒbackThªadID
,Öarent);

1056 
VDOCom∂ëi⁄
 *
subTaskCom∂ëi⁄
 = &
ªcovîy
->subTaskCompletion;

1057 
	`¥ï¨eCom∂ëi⁄
(
subTaskCom∂ëi⁄
, 
lﬂdJou∫Æ
, 
föishP¨ítCÆlback
,

1058 
	`gëLogiˇlZ⁄eThªad
(
	`gëThªadC⁄fig
(
vdo
), 0),

1059 
com∂ëi⁄
);

1060 
	`lﬂdSœbDïŸF‹Recovîy
(
vdo
->
dïŸ
, 
subTaskCom∂ëi⁄
);

1061 
	}
}

	@vdo/base/vdoRecovery.h

22 #i‚de‡
VDO_RECOVERY_H


23 
	#VDO_RECOVERY_H


	)

25 
	~"com∂ëi⁄.h
"

26 
	~"vdo.h
"

37 
œunchRecovîy
(
VDO
 *
vdo
, 
VDOCom∂ëi⁄
 *
∑ª¡
);

	@vdo/base/vdoRecoveryInternals.h

22 #i‚de‡
VDO_RECOVERY_INTERNALS_H


23 
	#VDO_RECOVERY_INTERNALS_H


	)

25 
	~"vdoRecovîy.h
"

27 
	~"blockM≠Recovîy.h
"

28 
	~"ötM≠.h
"

29 
	~"jou∫ÆPoöt.h
"

30 
	~"rögNode.h
"

31 
	~"ty≥s.h
"

38 
Sequí˚Numbî
 
	m£quí˚Numbî
;

39 
uöt8_t
 
	m£˘‹Cou¡
;

40 
Jou∫ÆE¡ryCou¡
 
	míåyCou¡
;

41 } 
	tRecovîyPoöt
;

45 
VDOCom∂ëi⁄
 
	mcom∂ëi⁄
;

47 
VDOCom∂ëi⁄
 
	msubTaskCom∂ëi⁄
;

49 
VDO
 *
	mvdo
;

51 *
	mjou∫ÆD©a
;

53 
size_t
 
	mö¸efCou¡
;

56 
NumbîedBlockM≠pög
 *
	míåõs
;

58 
size_t
 
	míåyCou¡
;

60 
Sequí˚Numbî
 
	mblockM≠Hód
;

62 
Sequí˚Numbî
 
	m¶abJou∫ÆHód
;

64 
Sequí˚Numbî
 
	mèû
;

69 
Sequí˚Numbî
 
	mhighe°Taû
;

72 
RecovîyPoöt
 
	mèûRecovîyPoöt
;

74 
RecovîyPoöt
 
	m√xtRecovîyPoöt
;

76 
BlockCou¡
 
	mlogiˇlBlocksU£d
;

78 
BlockCou¡
 
	mblockM≠D©aBlocks
;

80 
Jou∫ÆPoöt
 
	m√xtJou∫ÆPoöt
;

82 
size_t
 
	míåõsAddedToSœbJou∫Æs
;

87 
I¡M≠
 *
	m¶ŸE¡ryM≠
;

89 
RögNode
 
	möcom∂ëeDe¸efs
;

91 
RögNode
 
	mcom∂ëeDe¸efs
;

93 
PageCou¡
 
	mout°™dög
;

95 
size_t
 
	mmissögDe¸efCou¡
;

96 } 
	tRecovîyCom∂ëi⁄
;

105 
__©åibuã__
((
w¨n_unu£d_ªsu…
))

106 
ölöe
 
RecovîyCom∂ëi⁄
 *

107 
	$asRecovîyCom∂ëi⁄
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

109 
	`STATIC_ASSERT
(
	`off£tof
(
RecovîyCom∂ëi⁄
, 
com∂ëi⁄
) == 0);

110 
	`as£πCom∂ëi⁄Ty≥
(
com∂ëi⁄
->
ty≥
, 
RECOVERY_COMPLETION
);

111  (
RecovîyCom∂ëi⁄
 *Ë
com∂ëi⁄
;

112 
	}
}

122 
	$makeRecovîyCom∂ëi⁄
(
VDO
 *
vdo
, 
RecovîyCom∂ëi⁄
 **
ªcovîyPå
)

123 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

130 
	`‰ìRecovîyCom∂ëi⁄
(
RecovîyCom∂ëi⁄
 **
ªcovîyPå
);

138 
	`addSœbJou∫ÆE¡rõs
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
);

	@vdo/base/vdoResize.c

22 
	~"vdoResize.h
"

24 
	~"loggî.h
"

26 
	~"admöCom∂ëi⁄.h
"

27 
	~"com∂ëi⁄.h
"

28 
	~"ªcovîyJou∫Æ.h
"

29 
	~"¶abDïŸ.h
"

30 
	~"¶abSumm¨y.h
"

31 
	~"vdoI¡î«l.h
"

32 
	~"vdoLayout.h
"

42 
ölöe
 
VDO
 *
	$vdoFromGrowPhysiˇlSubTask
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

44  
	`vdoFromAdmöSubTask
(
com∂ëi⁄
, 
ADMIN_OPERATION_GROW_PHYSICAL
);

45 
	}
}

53 
	$h™dÀUƒecovîabÀEº‹
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

56 
VDO
 *
vdo
 = 
	`vdoFromGrowPhysiˇlSubTask
(
com∂ëi⁄
);

57 
	`íãrRódO∆yMode
(&
vdo
->
ªadO∆yC⁄ãxt
, 
com∂ëi⁄
->
ªsu…
);

58 
	`föishP¨ítCÆlback
(
com∂ëi⁄
);

59 
	}
}

67 
	$ªsumeSumm¨yF‹Revît
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

69 
VDO
 *
vdo
 = 
	`vdoFromGrowPhysiˇlSubTask
(
com∂ëi⁄
);

70 
	`¥ï¨eAdmöSubTask
(
vdo
, 
föishP¨ítCÆlback
, 
h™dÀUƒecovîabÀEº‹
);

71 
	`ªsumeSœbSumm¨y
(
vdo
->
dïŸ
, 
com∂ëi⁄
, 
föishP¨ítCÆlback
,

72 
föishP¨ítCÆlback
);

73 
	}
}

81 
	$ab‹tResize
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

83 
VDO
 *
vdo
 = 
	`vdoFromGrowPhysiˇlSubTask
(
com∂ëi⁄
);

84 
SœbDïŸ
 *
dïŸ
 = 
vdo
->depot;

87 
	`£tCom∂ëi⁄Resu…
(
com∂ëi⁄
->
∑ª¡
, com∂ëi⁄->
ªsu…
);

90 
vdo
->
c⁄fig
.
physiˇlBlocks
 = 
	`ªvîtVDOLayout
(vdo->
œyout
);

91 
	`upd©eSœbDïŸSize
(
dïŸ
, 
åue
);

92 
	`ab™d⁄NewSœbs
(
dïŸ
);

93 
	`¥ï¨eAdmöSubTask
(
vdo
, 
ªsumeSumm¨yF‹Revît
, 
h™dÀUƒecovîabÀEº‹
);

94 
	`ßveVDOComp⁄ítsAsync
(
vdo
, 
com∂ëi⁄
);

95 
	}
}

103 
	$föishVDOResize
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

105 
VDO
 *
vdo
 = 
	`vdoFromGrowPhysiˇlSubTask
(
com∂ëi⁄
);

106 
	`£tRecovîyJou∫ÆP¨tôi⁄
(
vdo
->
ªcovîyJou∫Æ
,

107 
	`gëVDOP¨tôi⁄
(
vdo
->
œyout
,

108 
RECOVERY_JOURNAL_PARTITION
));

109 
	`com∂ëeCom∂ëi⁄
(
com∂ëi⁄
->
∑ª¡
);

110 
	}
}

118 
	$ªsumeSumm¨y
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

120 
VDO
 *
vdo
 = 
	`vdoFromGrowPhysiˇlSubTask
(
com∂ëi⁄
);

121 
	`£tSœbSumm¨yOrigö
(
	`gëSœbSumm¨y
(
vdo
->
dïŸ
),

122 
	`gëVDOP¨tôi⁄
(
vdo
->
œyout
, 
SLAB_SUMMARY_PARTITION
));

123 
	`¥ï¨eAdmöSubTask
(
vdo
, 
föishVDOResize
, 
h™dÀUƒecovîabÀEº‹
);

124 
	`ªsumeSœbSumm¨y
(
vdo
->
dïŸ
, 
com∂ëi⁄
, 
föishP¨ítCÆlback
,

125 
föishP¨ítCÆlback
);

126 
	}
}

134 
	$addNewSœbs
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

136 
VDO
 *
vdo
 = 
	`vdoFromGrowPhysiˇlSubTask
(
com∂ëi⁄
);

137 
	`¥ï¨eAdmöSubTask
(
vdo
, 
ªsumeSumm¨y
, 
h™dÀUƒecovîabÀEº‹
);

138 
	`u£NewSœbs
(
vdo
->
dïŸ
, 
com∂ëi⁄
, 
föishP¨ítCÆlback
,

139 
föishP¨ítCÆlback
);

140 
	}
}

148 
	$upd©eVDOComp⁄ítsF‹Resize
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

150 
VDO
 *
vdo
 = 
	`vdoFromGrowPhysiˇlSubTask
(
com∂ëi⁄
);

153 
vdo
->
c⁄fig
.
physiˇlBlocks
 = 
	`growVDOLayout
(vdo->
œyout
);

154 
	`upd©eSœbDïŸSize
(
vdo
->
dïŸ
, 
Ál£
);

155 
	`¥ï¨eAdmöSubTask
(
vdo
, 
addNewSœbs
, 
ab‹tResize
);

156 
	`ßveVDOComp⁄ítsAsync
(
vdo
, 
com∂ëi⁄
);

157 
	}
}

165 
	$c›ySu•ídedSumm¨y
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

167 
VDO
 *
vdo
 = 
	`vdoFromGrowPhysiˇlSubTask
(
com∂ëi⁄
);

168 
	`¥ï¨eAdmöSubTask
(
vdo
, 
upd©eVDOComp⁄ítsF‹Resize
, 
ab‹tResize
);

169 
	`c›yP¨tôi⁄
(
vdo
->
œyout
, 
SLAB_SUMMARY_PARTITION
, 
com∂ëi⁄
);

170 
	}
}

178 
	$su•ídSumm¨y
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

182 
VDO
 *
vdo
 = 
	`vdoFromGrowPhysiˇlSubTask
(
com∂ëi⁄
);

183 
	`¥ï¨eAdmöSubTask
(
vdo
, 
c›ySu•ídedSumm¨y
, 
ab‹tResize
);

184 
	`su•ídSœbSumm¨y
(
vdo
->
dïŸ
, 
com∂ëi⁄
, 
föishP¨ítCÆlback
,

185 
föishP¨ítCÆlback
);

186 
	}
}

193 
	$growPhysiˇlCÆlback
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

195 
VDO
 *
vdo
 = 
	`vdoFromGrowPhysiˇlSubTask
(
com∂ëi⁄
);

196 
	`as£πOnAdmöThªad
(
vdo
, 
__func__
);

199 i‡(
	`isRódO∆y
(&
vdo
->
ªadO∆yC⁄ãxt
)) {

200 
	`föishCom∂ëi⁄
(
com∂ëi⁄
->
∑ª¡
, 
VDO_READ_ONLY
);

205 i‡(
	`öRecovîyMode
(
vdo
)) {

206 
	`föishCom∂ëi⁄
(
com∂ëi⁄
->
∑ª¡
, 
VDO_RETRY_AFTER_REBUILD
);

211 
	`¥ï¨eAdmöSubTask
(
vdo
, 
su•ídSumm¨y
, 
föishP¨ítCÆlback
);

212 
	`c›yP¨tôi⁄
(
vdo
->
œyout
, 
RECOVERY_JOURNAL_PARTITION
, 
com∂ëi⁄
);

213 
	}
}

216 
	$≥rf‹mGrowPhysiˇl
(
VDO
 *
vdo
, 
BlockCou¡
 
√wPhysiˇlBlocks
)

218 i‡((
vdo
->
c⁄fig
.
physiˇlBlocks
 =
√wPhysiˇlBlocks
)

219 && (
	`gëNextVDOLayoutSize
(
vdo
->
œyout
) == 0)) {

220  
VDO_SUCCESS
;

223 i‡(
√wPhysiˇlBlocks
 !
	`gëNextVDOLayoutSize
(
vdo
->
œyout
)) {

229 
	`föishVDOLayoutGrowth
(
vdo
->
œyout
);

230 
	`ab™d⁄NewSœbs
(
vdo
->
dïŸ
);

231  
VDO_PARAMETER_MISMATCH
;

235 
BlockCou¡
 
√wDïŸSize
 = 
	`gëNextBlockAŒoˇt‹P¨tôi⁄Size
(
vdo
->
œyout
);

236 
BlockCou¡
 
¥ï¨edDïŸSize
 = 
	`gëNewDïŸSize
(
vdo
->
dïŸ
);

237 i‡(
¥ï¨edDïŸSize
 !
√wDïŸSize
) {

238  
VDO_PARAMETER_MISMATCH
;

241 
ªsu…
 = 
	`≥rf‹mAdmöO≥øti⁄
(
vdo
, 
ADMIN_OPERATION_GROW_PHYSICAL
,

242 
growPhysiˇlCÆlback
);

243 
	`föishVDOLayoutGrowth
(
vdo
->
œyout
);

244  
ªsu…
;

245 
	}
}

248 
	$¥ï¨eToGrowPhysiˇl
(
VDO
 *
vdo
, 
BlockCou¡
 
√wPhysiˇlBlocks
)

250 i‡(
√wPhysiˇlBlocks
 < 
vdo
->
c⁄fig
.
physiˇlBlocks
) {

251  
	`logEº‹WôhSåögEº‹
(
VDO_NOT_IMPLEMENTED
,

256 i‡(
√wPhysiˇlBlocks
 =
vdo
->
c⁄fig
.
physiˇlBlocks
) {

257 
	`föishVDOLayoutGrowth
(
vdo
->
œyout
);

258 
	`ab™d⁄NewSœbs
(
vdo
->
dïŸ
);

259  
VDO_SUCCESS
;

262 
ªsu…
 = 
	`¥ï¨eToGrowVDOLayout
(
vdo
->
œyout
, vdo->
c⁄fig
.
physiˇlBlocks
,

263 
√wPhysiˇlBlocks
);

264 i‡(
ªsu…
 !
VDO_SUCCESS
) {

265  
ªsu…
;

268 
BlockCou¡
 
√wDïŸSize
 = 
	`gëNextBlockAŒoˇt‹P¨tôi⁄Size
(
vdo
->
œyout
);

269 
ªsu…
 = 
	`¥ï¨eToGrowSœbDïŸ
(
vdo
->
dïŸ
, 
√wDïŸSize
);

270 i‡(
ªsu…
 !
VDO_SUCCESS
) {

271 
	`föishVDOLayoutGrowth
(
vdo
->
œyout
);

272  
ªsu…
;

275  
VDO_SUCCESS
;

276 
	}
}

	@vdo/base/vdoResize.h

22 #i‚de‡
VDO_RESIZE_H


23 
	#VDO_RESIZE_H


	)

25 
	~"ty≥s.h
"

36 
	$makeResizeVDOCom∂ëi⁄
(
VDO
 *
vdo
,

37 
BlockCou¡
 
√wPhysiˇlBlocks
,

38 
VDOCom∂ëi⁄
 **
com∂ëi⁄På
)

39 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

47 
	`‰ìResizeVDOCom∂ëi⁄
(
VDOCom∂ëi⁄
 **
com∂ëi⁄På
);

58 
	`≥rf‹mGrowPhysiˇl
(
VDO
 *
vdo
, 
BlockCou¡
 
√wPhysiˇlBlocks
);

66 
	$¥ï¨eToGrowPhysiˇl
(
VDO
 *
vdo
, 
BlockCou¡
 
√wPhysiˇlBlocks
)

67 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

	@vdo/base/vdoResizeLogical.c

22 
	~"vdoResizeLogiˇl.h
"

24 
	~"loggî.h
"

26 
	~"admöCom∂ëi⁄.h
"

27 
	~"blockM≠.h
"

28 
	~"com∂ëi⁄.h
"

29 
	~"vdoI¡î«l.h
"

39 
ölöe
 
VDO
 *
	$vdoFromGrowLogiˇlSubTask
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

41  
	`vdoFromAdmöSubTask
(
com∂ëi⁄
, 
ADMIN_OPERATION_GROW_LOGICAL
);

42 
	}
}

52 
	$ªsizeBlockM≠
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

54 
	`¥ï¨eToFöishP¨ít
(
com∂ëi⁄
, com∂ëi⁄->
∑ª¡
);

55 
	`growBlockM≠
(
	`gëBlockM≠
(
	`vdoFromGrowLogiˇlSubTask
(
com∂ëi⁄
)),

56 
com∂ëi⁄
);

57 
	}
}

65 
	$h™dÀSaveEº‹
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

67 
VDO
 *
vdo
 = 
	`vdoFromGrowLogiˇlSubTask
(
com∂ëi⁄
);

68 
BlockM≠
 *
blockM≠
 = 
	`gëBlockM≠
(
vdo
);

69 
	`ab™d⁄BlockM≠Growth
(
blockM≠
);

70 
vdo
->
c⁄fig
.
logiˇlBlocks
 = 
	`gëNumbîOfBlockM≠E¡rõs
(
blockM≠
);

71 
	`föishP¨ítCÆlback
(
com∂ëi⁄
);

72 
	}
}

79 
	$growLogiˇlCÆlback
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

81 
VDO
 *
vdo
 = 
	`vdoFromGrowLogiˇlSubTask
(
com∂ëi⁄
);

82 
	`as£πOnAdmöThªad
(
vdo
, 
__func__
);

85 i‡(
	`isRódO∆y
(&
vdo
->
ªadO∆yC⁄ãxt
)) {

86 
	`ab™d⁄BlockM≠Growth
(
	`gëBlockM≠
(
vdo
));

87 
	`logEº‹WôhSåögEº‹
(
VDO_READ_ONLY
,

89 
	`föishCom∂ëi⁄
(
com∂ëi⁄
->
∑ª¡
, 
VDO_READ_ONLY
);

93 
vdo
->
c⁄fig
.
logiˇlBlocks
 = 
	`gëNewE¡ryCou¡
(
	`gëBlockM≠
(vdo));

94 
	`¥ï¨eAdmöSubTask
(
vdo
, 
ªsizeBlockM≠
, 
h™dÀSaveEº‹
);

95 
	`ßveVDOComp⁄ítsAsync
(
vdo
, 
com∂ëi⁄
);

96 
	}
}

99 
	$≥rf‹mGrowLogiˇl
(
VDO
 *
vdo
, 
BlockCou¡
 
√wLogiˇlBlocks
)

101 i‡(
	`gëNewE¡ryCou¡
(
	`gëBlockM≠
(
vdo
)Ë!
√wLogiˇlBlocks
) {

102  
VDO_PARAMETER_MISMATCH
;

105  
	`≥rf‹mAdmöO≥øti⁄
(
vdo
, 
ADMIN_OPERATION_GROW_LOGICAL
,

106 
growLogiˇlCÆlback
);

107 
	}
}

110 
	$¥ï¨eToGrowLogiˇl
(
VDO
 *
vdo
, 
BlockCou¡
 
√wLogiˇlBlocks
)

112 i‡(
√wLogiˇlBlocks
 < 
vdo
->
c⁄fig
.
logiˇlBlocks
) {

113  
	`logEº‹WôhSåögEº‹
(
VDO_PARAMETER_MISMATCH
,

115 "cuºíàvÆuêo‡%" 
PRIu64
,

116 
vdo
->
c⁄fig
.
logiˇlBlocks
);

119 i‡(
√wLogiˇlBlocks
 =
vdo
->
c⁄fig
.
logiˇlBlocks
) {

120  
	`logEº‹WôhSåögEº‹
(
VDO_PARAMETER_MISMATCH
,

122 "cuºíàvÆuêo‡%" 
PRIu64
,

123 
vdo
->
c⁄fig
.
logiˇlBlocks
);

126  
	`¥ï¨eToGrowBlockM≠
(
	`gëBlockM≠
(
vdo
), 
√wLogiˇlBlocks
);

127 
	}
}

	@vdo/base/vdoResizeLogical.h

22 #i‚de‡
VDO_RESIZE_LOGICAL_H


23 
	#VDO_RESIZE_LOGICAL_H


	)

25 
	~"ty≥s.h
"

36 
≥rf‹mGrowLogiˇl
(
VDO
 *
vdo
, 
BlockCou¡
 
√wLogiˇlBlocks
);

47 
¥ï¨eToGrowLogiˇl
(
VDO
 *
vdo
, 
BlockCou¡
 
√wLogiˇlBlocks
);

	@vdo/base/vio.c

22 
	~"vio.h
"

24 
	~"loggî.h
"

26 
	~"d©aVIO.h
"

27 
	~"vdoI¡î«l.h
"

30 
	$‰ìVIO
(
VIO
 **
vioPå
)

32 
VIO
 *
vio
 = *
vioPå
;

33 i‡(
vio
 =
NULL
) {

37 
vio
->
com∂ëi⁄
.
œyî
->
	`‰ìVIO
(
vioPå
);

38 
	}
}

41 
	$öôülizeVIO
(
VIO
 *
vio
,

42 
VIOTy≥
 
ty≥
,

43 
VIOPri‹ôy
 
¥i‹ôy
,

44 
VDOCom∂ëi⁄
 *
∑ª¡
,

45 
VDO
 *
vdo
,

46 
PhysiˇlLayî
 *
œyî
)

48 
vio
->
vdo
 = vdo;

49 
vio
->
ty≥
 =Åype;

50 
vio
->
¥i‹ôy
 =Öriority;

52 
VDOCom∂ëi⁄
 *
com∂ëi⁄
 = 
	`vioAsCom∂ëi⁄
(
vio
);

53 
	`öôülizeCom∂ëi⁄
(
com∂ëi⁄
, 
VIO_COMPLETION
, 
œyî
);

54 
com∂ëi⁄
->
∑ª¡
 =Öarent;

55 
	}
}

58 
	$vioD⁄eCÆlback
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

60 
VIO
 *
vio
 = 
	`asVIO
(
com∂ëi⁄
);

61 
com∂ëi⁄
->
ˇŒback
 = 
vio
->callback;

62 
com∂ëi⁄
->
îr‹H™dÀr
 = 
vio
->errorHandler;

63 
	`com∂ëeCom∂ëi⁄
(
com∂ëi⁄
);

64 
	}
}

67 c⁄° *
	$gëVIORódWrôeFœv‹
(c⁄° 
VIO
 *
vio
)

69 i‡(
	`isRódVIO
(
vio
)) {

72  (
	`isWrôeVIO
(
vio
) ? "write" : "read-modify-write");

73 
	}
}

76 
	$upd©eVIOEº‹Sèts
(
VIO
 *
vio
)

78 
	`vioAsCom∂ëi⁄
(
vio
)->
ªsu…
) {

79 
VDO_READ_ONLY
:

80 
	`©omicAdd64
(&
vio
->
vdo
->
îr‹Sèts
.
ªadO∆yEº‹Cou¡
, 1);

81  
LOG_DEBUG
;

83 
VDO_NO_SPACE
:

84 
	`©omicAdd64
(&
vio
->
vdo
->
îr‹Sèts
.
noS∑˚Eº‹Cou¡
, 1);

85  
LOG_DEBUG
;

88  
LOG_ERR
;

90 
	}
}

97 
	$h™dÀMëad©aIOEº‹
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

99 
VIO
 *
vio
 = 
	`asVIO
(
com∂ëi⁄
);

100 
	`logWôhSåögEº‹
(
	`upd©eVIOEº‹Sèts
(
vio
), 
com∂ëi⁄
->
ªsu…
,

102 
PRIu64
 " withÉrror",

103 
	`gëVIORódWrôeFœv‹
(
vio
), vio->
ty≥
, vio->
physiˇl
);

104 
	`vioD⁄eCÆlback
(
com∂ëi⁄
);

105 
	}
}

108 
	$œunchMëad©aVIO
(
VIO
 *
vio
,

109 
PhysiˇlBlockNumbî
 
physiˇl
,

110 
VDOA˘i⁄
 *
ˇŒback
,

111 
VDOA˘i⁄
 *
îr‹H™dÀr
,

112 
VIOO≥øti⁄
 
›î©i⁄
)

114 
vio
->
›î©i⁄
 = operation;

115 
vio
->
physiˇl
 =Öhysical;

116 
vio
->
ˇŒback
 = callback;

117 
vio
->
îr‹H™dÀr
 =ÉrrorHandler;

119 
VDOCom∂ëi⁄
 *
com∂ëi⁄
 = 
	`vioAsCom∂ëi⁄
(
vio
);

120 
	`ª£tCom∂ëi⁄
(
com∂ëi⁄
);

121 
com∂ëi⁄
->
ˇŒback
 = 
vioD⁄eCÆlback
;

122 
com∂ëi⁄
->
îr‹H™dÀr
 = 
h™dÀMëad©aIOEº‹
;

124 i‡(
	`isRódVIO
(
vio
)) {

125 
com∂ëi⁄
->
œyî
->
	`ªadMëad©a
(
vio
);

127 
com∂ëi⁄
->
œyî
->
	`wrôeMëad©a
(
vio
);

129 
	}
}

136 
	$h™dÀFlushEº‹
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

138 
	`logEº‹WôhSåögEº‹
(
com∂ëi⁄
->
ªsu…
, "Error flushingÜayer");

139 
com∂ëi⁄
->
îr‹H™dÀr
 = 
	`asVIO
(completion)->errorHandler;

140 
	`com∂ëeCom∂ëi⁄
(
com∂ëi⁄
);

141 
	}
}

144 
	$œunchFlush
(
VIO
 *
vio
, 
VDOA˘i⁄
 *
ˇŒback
, VDOA˘i⁄ *
îr‹H™dÀr
)

146 
VDOCom∂ëi⁄
 *
com∂ëi⁄
 = 
	`vioAsCom∂ëi⁄
(
vio
);

147 
	`ª£tCom∂ëi⁄
(
com∂ëi⁄
);

148 
com∂ëi⁄
->
ˇŒback
 = callback;

149 
com∂ëi⁄
->
îr‹H™dÀr
 = 
h™dÀFlushEº‹
;

150 
vio
->
îr‹H™dÀr
 =ÉrrorHandler;

151 
vio
->
›î©i⁄
 = 
VIO_FLUSH_BEFORE
;

152 
vio
->
physiˇl
 = 
ZERO_BLOCK
;

154 
PhysiˇlLayî
 *
œyî
 = 
com∂ëi⁄
->layer;

155 i‡(!
œyî
->
	`isFlushRequúed
(layer)) {

156 
	`föishCom∂ëi⁄
(
com∂ëi⁄
, 
VDO_SUCCESS
);

160 
œyî
->
	`Êush
(
vio
);

161 
	}
}

	@vdo/base/vio.h

22 #i‚de‡
VIO_H


23 
	#VIO_H


	)

25 
	~"com∂ëi⁄.h
"

26 
	~"åa˚.h
"

27 
	~"ty≥s.h
"

28 
	~"vdo.h
"

34 
	svio
 {

36 
VDOCom∂ëi⁄
 
	mcom∂ëi⁄
;

39 
VDOA˘i⁄
 *
	mˇŒback
;

40 
VDOA˘i⁄
 *
	mîr‹H™dÀr
;

43 
VDO
 *
	mvdo
;

46 
PhysiˇlBlockNumbî
 
	mphysiˇl
;

49 
VIOO≥øti⁄
 
	m›î©i⁄
;

52 
VIOPri‹ôy
 
	m¥i‹ôy
;

55 
VIOTy≥
 
	mty≥
;

58 
Tø˚
 *
	måa˚
;

68 
ölöe
 
VIO
 *
	$asVIO
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

70 
	`STATIC_ASSERT
(
	`off£tof
(
VIO
, 
com∂ëi⁄
) == 0);

71 
	`as£πCom∂ëi⁄Ty≥
(
com∂ëi⁄
->
ty≥
, 
VIO_COMPLETION
);

72  (
VIO
 *Ë
com∂ëi⁄
;

73 
	}
}

82 
ölöe
 
VDOCom∂ëi⁄
 *
	$vioAsCom∂ëi⁄
(
VIO
 *
vio
)

84  &
vio
->
com∂ëi⁄
;

85 
	}
}

99 
ölöe
 
	$¸óãVIO
(
PhysiˇlLayî
 *
œyî
,

100 
VIOTy≥
 
vioTy≥
,

101 
VIOPri‹ôy
 
¥i‹ôy
,

102 *
∑ª¡
,

103 *
d©a
,

104 
VIO
 **
vioPå
)

106  
œyî
->
	`¸óãMëad©aVIO
÷ayî, 
vioTy≥
, 
¥i‹ôy
, 
∑ª¡
, 
d©a
,

107 
vioPå
);

108 
	}
}

115 
‰ìVIO
(
VIO
 **
vioPå
);

128 
öôülizeVIO
(
VIO
 *
vio
,

129 
VIOTy≥
 
ty≥
,

130 
VIOPri‹ôy
 
¥i‹ôy
,

131 
VDOCom∂ëi⁄
 *
∑ª¡
,

132 
VDO
 *
vdo
,

133 
PhysiˇlLayî
 *
œyî
);

142 
vioD⁄eCÆlback
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
);

151 c⁄° *
gëVIORódWrôeFœv‹
(c⁄° 
VIO
 *
vio
);

160 
upd©eVIOEº‹Sèts
(
VIO
 *
vio
);

168 
ölöe
 
	$vioAddTø˚Rec‹d
(
VIO
 *
vio
, 
Tø˚Loˇti⁄
 
loˇti⁄
)

170 i‡(
	`u∆ikñy
(
vio
->
åa˚
 !
NULL
)) {

171 
	`addTø˚Rec‹d
(
vio
->
åa˚
, 
loˇti⁄
);

173 
	}
}

180 
ölöe
 
boﬁ
 
	$isD©aVIO
(
VIO
 *
vio
)

182  
	`isD©aVIOTy≥
(
vio
->
ty≥
);

183 
	}
}

190 
ölöe
 
boﬁ
 
	$isCom¥es£dWrôeVIO
(
VIO
 *
vio
)

192  
	`isCom¥es£dWrôeVIOTy≥
(
vio
->
ty≥
);

193 
	}
}

200 
ölöe
 
boﬁ
 
	$isMëad©aVIO
(
VIO
 *
vio
)

202  
	`isMëad©aVIOTy≥
(
vio
->
ty≥
);

203 
	}
}

212 
ölöe
 
boﬁ
 
	$isRódVIO
(c⁄° 
VIO
 *
vio
)

214  ((
vio
->
›î©i⁄
 & 
VIO_READ_WRITE_MASK
Ë=
VIO_READ
);

215 
	}
}

224 
ölöe
 
boﬁ
 
	$isRódModifyWrôeVIO
(c⁄° 
VIO
 *
vio
)

226  ((
vio
->
›î©i⁄
 & 
VIO_READ_WRITE_MASK
Ë=
VIO_READ_MODIFY_WRITE
);

227 
	}
}

236 
ölöe
 
boﬁ
 
	$isWrôeVIO
(c⁄° 
VIO
 *
vio
)

238  ((
vio
->
›î©i⁄
 & 
VIO_READ_WRITE_MASK
Ë=
VIO_WRITE
);

239 
	}
}

248 
ölöe
 
boﬁ
 
	$vioRequúesFlushBef‹e
(c⁄° 
VIO
 *
vio
)

250  ((
vio
->
›î©i⁄
 & 
VIO_FLUSH_BEFORE
) == VIO_FLUSH_BEFORE);

251 
	}
}

260 
ölöe
 
boﬁ
 
	$vioRequúesFlushA·î
(c⁄° 
VIO
 *
vio
)

262  ((
vio
->
›î©i⁄
 & 
VIO_FLUSH_AFTER
) == VIO_FLUSH_AFTER);

263 
	}
}

274 
œunchMëad©aVIO
(
VIO
 *
vio
,

275 
PhysiˇlBlockNumbî
 
physiˇl
,

276 
VDOA˘i⁄
 *
ˇŒback
,

277 
VDOA˘i⁄
 *
îr‹H™dÀr
,

278 
VIOO≥øti⁄
 
›î©i⁄
);

288 
ölöe
 
	$œunchRódMëad©aVIO
(
VIO
 *
vio
,

289 
PhysiˇlBlockNumbî
 
physiˇl
,

290 
VDOA˘i⁄
 *
ˇŒback
,

291 
VDOA˘i⁄
 *
îr‹H™dÀr
)

293 
	`œunchMëad©aVIO
(
vio
, 
physiˇl
, 
ˇŒback
, 
îr‹H™dÀr
, 
VIO_READ
);

294 
	}
}

304 
ölöe
 
	$œunchWrôeMëad©aVIO
(
VIO
 *
vio
,

305 
PhysiˇlBlockNumbî
 
physiˇl
,

306 
VDOA˘i⁄
 *
ˇŒback
,

307 
VDOA˘i⁄
 *
îr‹H™dÀr
)

309 
	`œunchMëad©aVIO
(
vio
, 
physiˇl
, 
ˇŒback
, 
îr‹H™dÀr
, 
VIO_WRITE
);

310 
	}
}

324 
ölöe


325 
	$œunchWrôeMëad©aVIOWôhFlush
(
VIO
 *
vio
,

326 
PhysiˇlBlockNumbî
 
physiˇl
,

327 
VDOA˘i⁄
 *
ˇŒback
,

328 
VDOA˘i⁄
 *
îr‹H™dÀr
,

329 
boﬁ
 
ÊushBef‹e
,

330 
boﬁ
 
ÊushA·î
)

332 
	`œunchMëad©aVIO
(
vio
, 
physiˇl
, 
ˇŒback
, 
îr‹H™dÀr
,

333 (
VIO_WRITE


334 | (
ÊushBef‹e
 ? 
VIO_FLUSH_BEFORE
 : 0)

335 | (
ÊushA·î
 ? 
VIO_FLUSH_AFTER
 : 0)));

336 
	}
}

347 
œunchFlush
(
VIO
 *
vio
, 
VDOA˘i⁄
 *
ˇŒback
, VDOA˘i⁄ *
îr‹H™dÀr
);

	@vdo/base/vioPool.c

22 
	~"vioPoﬁ.h
"

24 
	~"loggî.h
"

25 
	~"mem‹yAŒoc.h
"

26 
	~"≥rmas£π.h
"

28 
	~"c⁄°™ts.h
"

29 
	~"vio.h
"

30 
	~"ty≥s.h
"

33 
size_t
 
	mpoﬁSize
;

34 *
	mbuf„r
;

35 
VIOPoﬁE¡ry
 
	míåõs
[];

36 } 
	tVIOPoﬁE¡rõs
;

39 
ölöe
 
VIOPoﬁE¡ry
 *
	$asVIOPoﬁE¡ry
(
RögNode
 *
node
)

41 
	`STATIC_ASSERT
(
	`off£tof
(
VIOPoﬁE¡ry
, 
node
) == 0);

42  (
VIOPoﬁE¡ry
 *Ë
node
;

43 
	}
}

46 
	$makeVIOPoﬁ
(
PhysiˇlLayî
 *
œyî
,

47 
size_t
 
poﬁSize
,

48 
VIOC⁄°ru˘‹
 *
vioC⁄°ru˘‹
,

49 *
c⁄ãxt
,

50 
Obje˘Poﬁ
 **
poﬁPå
)

52 
VIOPoﬁE¡rõs
 *
vioPoﬁE¡rõs
;

53 
ªsu…
 = 
	`ALLOCATE_EXTENDED
(
VIOPoﬁE¡rõs
, 
poﬁSize
, 
VIOPoﬁE¡ry
,

54 
__func__
, &
vioPoﬁE¡rõs
);

55 i‡(
ªsu…
 !
VDO_SUCCESS
) {

56  
ªsu…
;

59 
ªsu…
 = 
	`ALLOCATE
(
poﬁSize
 * 
VDO_BLOCK_SIZE
, , "VIOÖool buffer",

60 &
vioPoﬁE¡rõs
->
buf„r
);

61 i‡(
ªsu…
 !
VDO_SUCCESS
) {

62 
	`FREE
(
vioPoﬁE¡rõs
);

63  
ªsu…
;

66 
Obje˘Poﬁ
 *
poﬁ
;

67 
ªsu…
 = 
	`makeObje˘Poﬁ
(
vioPoﬁE¡rõs
, &
poﬁ
);

68 i‡(
ªsu…
 !
VDO_SUCCESS
) {

69 
	`FREE
(
vioPoﬁE¡rõs
->
buf„r
);

70 
	`FREE
(
vioPoﬁE¡rõs
);

71  
ªsu…
;

74 *
±r
 = 
vioPoﬁE¡rõs
->
buf„r
;

75 
size_t
 
i
 = 0; i < 
poﬁSize
; i++) {

76 
VIOPoﬁE¡ry
 *
íåy
 = &
vioPoﬁE¡rõs
->
íåõs
[
i
];

77 
íåy
->
buf„r
 = 
±r
;

78 
íåy
->
c⁄ãxt
 = context;

79 
ªsu…
 = 
	`vioC⁄°ru˘‹
(
œyî
, 
íåy
, 
±r
, &íåy->
vio
);

80 i‡(
ªsu…
 !
VDO_SUCCESS
) {

81 
	`‰ìVIOPoﬁ
(&
poﬁ
);

82  
ªsu…
;

84 
±r
 +
VDO_BLOCK_SIZE
;

85 
	`addE¡ryToObje˘Poﬁ
(
poﬁ
, &
íåy
->
node
);

88 
vioPoﬁE¡rõs
->
poﬁSize
 =ÖoolSize;

90 *
poﬁPå
 = 
poﬁ
;

91  
VDO_SUCCESS
;

92 
	}
}

95 
	$‰ìVIOPoﬁ
(
Obje˘Poﬁ
 **
poﬁPå
)

97 i‡(*
poﬁPå
 =
NULL
) {

102 
Obje˘Poﬁ
 *
poﬁ
 = *
poﬁPå
;

103 
VIOPoﬁE¡ry
 *
íåy
;

104 (
íåy
 = 
	`asVIOPoﬁE¡ry
(
	`ªmoveE¡ryFromObje˘Poﬁ
(
poﬁ
))Ë!
NULL
) {

105 
	`‰ìVIO
(&
íåy
->
vio
);

108 
VIOPoﬁE¡rõs
 *
vioPoﬁE¡rõs
 = 
	`gëObje˘PoﬁE¡ryD©a
(
poﬁ
);

110 
size_t
 
i
 = 0; i < 
vioPoﬁE¡rõs
->
poﬁSize
; i++) {

111 
VIOPoﬁE¡ry
 *
íåy
 = &
vioPoﬁE¡rõs
->
íåõs
[
i
];

112 
	`ASSERT_LOG_ONLY
(
	`isRögEm±y
(&
íåy
->
node
), "VIO PoolÉntry still in use:"

113 " VIO i†ö u£ f‹Öhysiˇ»block %" 
PRIu64


115 
íåy
->
vio
->
physiˇl
,

116 
íåy
->
vio
->
›î©i⁄
);

119 
	`‰ìObje˘Poﬁ
(&
poﬁ
);

120 
	`FREE
(
vioPoﬁE¡rõs
->
buf„r
);

121 
	`FREE
(
vioPoﬁE¡rõs
);

122 *
poﬁPå
 = 
NULL
;

123 
	}
}

126 
	$ªtu∫VIOToPoﬁ
(
Obje˘Poﬁ
 *
poﬁ
, 
VIOPoﬁE¡ry
 *
íåy
)

128 
íåy
->
vio
->
com∂ëi⁄
.
îr‹H™dÀr
 = 
NULL
;

129 
	`ªtu∫E¡ryToObje˘Poﬁ
(
poﬁ
, &
íåy
->
node
);

130 
	}
}

	@vdo/base/vioPool.h

22 #i‚de‡
VIO_POOL_H


23 
	#VIO_POOL_H


	)

25 
	~"≥rmas£π.h
"

27 
	~"com∂ëi⁄.h
"

28 
	~"obje˘Poﬁ.h
"

29 
	~"ty≥s.h
"

30 
	~"waôQueue.h
"

41 
RögNode
 
	mnode
;

42 
VIO
 *
	mvio
;

43 *
	mbuf„r
;

44 *
	m∑ª¡
;

45 *
	mc⁄ãxt
;

46 } 
	tVIOPoﬁE¡ry
;

56 
	tVIOC⁄°ru˘‹
(
	tPhysiˇlLayî
 *
	tœyî
,

57 *
	t∑ª¡
,

58 *
	tbuf„r
,

59 
	tVIO
 **
	tvioPå
);

72 
	$makeVIOPoﬁ
(
PhysiˇlLayî
 *
œyî
,

73 
size_t
 
poﬁSize
,

74 
VIOC⁄°ru˘‹
 *
vioC⁄°ru˘‹
,

75 *
c⁄ãxt
,

76 
Obje˘Poﬁ
 **
poﬁPå
)

77 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

84 
	`‰ìVIOPoﬁ
(
Obje˘Poﬁ
 **
poﬁPå
);

94 
ölöe
 
	$acquúeVIOFromPoﬁ
(
Obje˘Poﬁ
 *
poﬁ
, 
Waôî
 *
waôî
)

96  
	`acquúeE¡ryFromObje˘Poﬁ
(
poﬁ
, 
waôî
);

97 
	}
}

105 
ªtu∫VIOToPoﬁ
(
Obje˘Poﬁ
 *
poﬁ
, 
VIOPoﬁE¡ry
 *
íåy
);

	@vdo/base/vioRead.c

22 
	~"vioRód.h
"

24 
	~"loggî.h
"

26 
	~"blockM≠.h
"

27 
	~"d©aVIO.h
"

28 
	~"vdoI¡î«l.h
"

29 
	~"vioWrôe.h
"

37 
	$modifyF‹P¨tülWrôe
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

39 
D©aVIO
 *
d©aVIO
 = 
	`asD©aVIO
(
com∂ëi⁄
);

40 
	`as£πInLogiˇlZ⁄e
(
d©aVIO
);

42 i‡(
com∂ëi⁄
->
ªsu…
 !
VDO_SUCCESS
) {

43 
	`com∂ëeD©aVIO
(
com∂ëi⁄
);

47 
com∂ëi⁄
->
œyî
->
	`≠∂yP¨tülWrôe
(
d©aVIO
);

48 
	`d©aVIOAsVIO
(
d©aVIO
)->
›î©i⁄
 = 
VIO_WRITE
;

49 
d©aVIO
->
isP¨tülWrôe
 = 
åue
;

50 
	`œunchWrôeD©aVIO
(
d©aVIO
);

51 
	}
}

59 
	$ªadBlock
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

61 i‡(
com∂ëi⁄
->
ªsu…
 !
VDO_SUCCESS
) {

62 
	`com∂ëeD©aVIO
(
com∂ëi⁄
);

66 
D©aVIO
 *
d©aVIO
 = 
	`asD©aVIO
(
com∂ëi⁄
);

67 
VIO
 *
vio
 = 
	`asVIO
(
com∂ëi⁄
);

68 
com∂ëi⁄
->
ˇŒback


69 (
	`isRódVIO
(
vio
Ë? 
com∂ëeD©aVIO
 : 
modifyF‹P¨tülWrôe
);

71 i‡(
d©aVIO
->
m≠≥d
.
pbn
 =
ZERO_BLOCK
) {

72 
com∂ëi⁄
->
œyî
->
	`zîoD©aVIO
(
d©aVIO
);

73 
	`övokeCÆlback
(
com∂ëi⁄
);

77 
vio
->
physiˇl
 = 
d©aVIO
->
m≠≥d
.
pbn
;

78 
d©aVIO
->
œ°AsyncO≥øti⁄
 = 
READ_DATA
;

79 
com∂ëi⁄
->
œyî
->
	`ªadD©a
(
d©aVIO
);

80 
	}
}

88 
	$ªadBlockM≠pög
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

90 i‡(
com∂ëi⁄
->
ªsu…
 !
VDO_SUCCESS
) {

91 
	`com∂ëeD©aVIO
(
com∂ëi⁄
);

95 
D©aVIO
 *
d©aVIO
 = 
	`asD©aVIO
(
com∂ëi⁄
);

96 
	`as£πInLogiˇlZ⁄e
(
d©aVIO
);

97 
	`£tLogiˇlCÆlback
(
d©aVIO
, 
ªadBlock
, 
	`THIS_LOCATION
("$F;cb=readBlock"));

98 
d©aVIO
->
œ°AsyncO≥øti⁄
 = 
GET_MAPPED_BLOCK
;

99 
	`gëM≠≥dBlockAsync
(
d©aVIO
);

100 
	}
}

103 
	$œunchRódD©aVIO
(
D©aVIO
 *
d©aVIO
)

105 
	`as£πInLogiˇlZ⁄e
(
d©aVIO
);

106 
d©aVIO
->
œ°AsyncO≥øti⁄
 = 
FIND_BLOCK_MAP_SLOT
;

108 
	`födBlockM≠SlŸAsync
(
d©aVIO
, 
ªadBlockM≠pög
,

109 
	`gëLogiˇlZ⁄eThªadID
(
d©aVIO
->
logiˇl
.
z⁄e
));

110 
	}
}

118 
	$ªÀa£LogiˇlLock
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

120 
D©aVIO
 *
d©aVIO
 = 
	`asD©aVIO
(
com∂ëi⁄
);

121 
	`as£πInLogiˇlZ⁄e
(
d©aVIO
);

122 
	`ªÀa£LogiˇlBlockLock
(
d©aVIO
);

123 
	`vioD⁄eCÆlback
(
com∂ëi⁄
);

124 
	}
}

131 
	$˛ónupRódD©aVIO
(
D©aVIO
 *
d©aVIO
)

133 
	`œunchLogiˇlCÆlback
(
d©aVIO
, 
ªÀa£LogiˇlLock
,

134 
	`THIS_LOCATION
("$F;cb=releaseLL"));

135 
	}
}

	@vdo/base/vioRead.h

22 #i‚de‡
VIO_READ_H


23 
	#VIO_READ_H


	)

25 
	~"ty≥s.h
"

34 
œunchRódD©aVIO
(
D©aVIO
 *
d©aVIO
);

41 
˛ónupRódD©aVIO
(
D©aVIO
 *
d©aVIO
);

	@vdo/base/vioWrite.c

186 
	~"vioWrôe.h
"

188 
	~"loggî.h
"

189 
	~"utû/©omic.h
"

191 
	~"ÆloˇtögVIO.h
"

192 
	~"blockM≠.h
"

193 
	~"com¥essi⁄Sèã.h
"

194 
	~"d©aVIO.h
"

195 
	~"hashLock.h
"

196 
	~"ªcovîyJou∫Æ.h
"

197 
	~"ª„ªn˚O≥øti⁄.h
"

198 
	~"¶ab.h
"

199 
	~"¶abDïŸ.h
"

200 
	~"¶abJou∫Æ.h
"

201 
	~"vdoI¡î«l.h
"

202 
	~"vioRód.h
"

207 
	ed©aVIOCÀ™upSège
 {

208 
	mVIO_RELEASE_DUPLICATE
 = 0,

209 
	mVIO_RELEASE_COMPRESSED_BLOCK
,

210 
	mVIO_RELEASE_ALLOCATED
,

211 
	mVIO_RELEASE_RECOVERY_LOCKS
,

212 
	mVIO_RELEASE_HASH_LOCK
,

213 
	mVIO_RELEASE_LOGICAL
,

214 
	mVIO_CLEANUP_DONE


215 } 
	tD©aVIOCÀ™upSège
;

221 
	mNOT_READ_ONLY
,

222 
	mREAD_ONLY_IF_ASYNC
,

223 
	mREAD_ONLY
,

224 } 
	tRódO∆yA˘i⁄
;

227 
≥rf‹mCÀ™upSège
(
D©aVIO
 *
d©aVIO
, 
D©aVIOCÀ™upSège
 
°age
);

228 
wrôeBlock
(
D©aVIO
 *
d©aVIO
);

238 
ölöe
 
boﬁ
 
	$isAsync
(
D©aVIO
 *
d©aVIO
)

240  (
	`gëWrôePﬁicy
(
	`gëVDOFromD©aVIO
(
d©aVIO
)Ë=
WRITE_POLICY_ASYNC
);

241 
	}
}

244 
	$ªÀa£PBNRódLock
(
D©aVIO
 *
d©aVIO
)

246 
	`©omicSt‹e64
(&
d©aVIO
->
du∂iˇãPBN
, 
ZERO_BLOCK
);

247 i‡(!
	`isPBNLocked
(
d©aVIO
->
du∂iˇãLock
)) {

248 
	`ASSERT_LOG_ONLY
(
d©aVIO
->
du∂iˇãLock
 =
NULL
,

250 
	`ASSERT_LOG_ONLY
(!
	`hasWaôîs
(&
d©aVIO
->
lockRëryWaôîs
),

255 
	`as£πInDu∂iˇãZ⁄e
(
d©aVIO
);

256 
	`ªÀa£PBNLock
(
d©aVIO
->
du∂iˇã
.
z⁄e
, d©aVIO->du∂iˇã.
pbn
,

257 &
d©aVIO
->
du∂iˇãLock
);

258 
	`ASSERT_LOG_ONLY
(!
	`hasWaôîs
(&
d©aVIO
->
lockRëryWaôîs
),

260 
	}
}

267 
	$ªÀa£Du∂iˇãLock
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

269 
D©aVIO
 *
d©aVIO
 = 
	`asD©aVIO
(
com∂ëi⁄
);

270 
	`as£πInDu∂iˇãZ⁄e
(
d©aVIO
);

271 
	`ªÀa£PBNRódLock
(
d©aVIO
);

272 
	`≥rf‹mCÀ™upSège
(
d©aVIO
, 
VIO_RELEASE_COMPRESSED_BLOCK
);

273 
	}
}

280 
	$ªÀa£Com¥es£dBlock
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

282 
D©aVIO
 *
d©aVIO
 = 
	`asD©aVIO
(
com∂ëi⁄
);

283 
	`as£πInNewM≠≥dZ⁄e
(
d©aVIO
);

284 
	`com∂ëeFøgmít
(
d©aVIO
);

285 
	`≥rf‹mCÀ™upSège
(
d©aVIO
, 
VIO_RELEASE_ALLOCATED
);

286 
	}
}

294 
	$ªÀa£AŒoˇãdLock
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

296 
D©aVIO
 *
d©aVIO
 = 
	`asD©aVIO
(
com∂ëi⁄
);

297 
	`as£πInAŒoˇãdZ⁄e
(
d©aVIO
);

298 
	`ªÀa£PBNWrôeLock
(
	`d©aVIOAsAŒoˇtögVIO
(
d©aVIO
));

299 
	`≥rf‹mCÀ™upSège
(
d©aVIO
, 
VIO_RELEASE_RECOVERY_LOCKS
);

300 
	}
}

308 
	$ªÀa£LogiˇlLock
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

310 
D©aVIO
 *
d©aVIO
 = 
	`asD©aVIO
(
com∂ëi⁄
);

311 
	`as£πInLogiˇlZ⁄e
(
d©aVIO
);

312 
	`ªÀa£LogiˇlBlockLock
(
d©aVIO
);

313 
	`ªÀa£FlushGíî©i⁄Lock
(
d©aVIO
);

314 
	`≥rf‹mCÀ™upSège
(
d©aVIO
, 
VIO_CLEANUP_DONE
);

315 
	}
}

322 
	$˛ónHashLock
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

324 
D©aVIO
 *
d©aVIO
 = 
	`asD©aVIO
(
com∂ëi⁄
);

325 
	`as£πInHashZ⁄e
(
d©aVIO
);

326 
	`ªÀa£HashLock
(
d©aVIO
);

327 
	`≥rf‹mCÀ™upSège
(
d©aVIO
, 
VIO_RELEASE_LOGICAL
);

328 
	}
}

336 
	$föishCÀ™up
(
D©aVIO
 *
d©aVIO
)

338 
	`ASSERT_LOG_ONLY
(
	`d©aVIOAsAŒoˇtögVIO
(
d©aVIO
)->
wrôeLock
 =
NULL
,

340 
	`ASSERT_LOG_ONLY
(
d©aVIO
->
du∂iˇãLock
 =
NULL
,

342 
	`ASSERT_LOG_ONLY
(!
	`hasWaôîs
(&
d©aVIO
->
lockRëryWaôîs
),

344 
	`vioD⁄eCÆlback
(
	`d©aVIOAsCom∂ëi⁄
(
d©aVIO
));

345 
	}
}

353 
	$≥rf‹mCÀ™upSège
(
D©aVIO
 *
d©aVIO
, 
D©aVIOCÀ™upSège
 
°age
)

355 
°age
) {

356 
VIO_RELEASE_DUPLICATE
:

357 i‡(
	`isPBNLocked
(
d©aVIO
->
du∂iˇãLock
)) {

358 
	`œunchDu∂iˇãZ⁄eCÆlback
(
d©aVIO
, 
ªÀa£Du∂iˇãLock
,

359 
	`THIS_LOCATION
("$F;cb=releaseDupLock"));

364 
VIO_RELEASE_COMPRESSED_BLOCK
:

365 i‡(
d©aVIO
->
com¥essi⁄
.
wrôî
 !
NULL
) {

366 
	`œunchNewM≠≥dZ⁄eCÆlback
(
d©aVIO
, 
ªÀa£Com¥es£dBlock
,

367 
	`THIS_LOCATION
("$F;cb=releaseCompressedBlock")

373 
VIO_RELEASE_ALLOCATED
:

374 i‡(
	`hasAŒoˇti⁄
(
d©aVIO
)) {

375 
	`œunchAŒoˇãdZ⁄eCÆlback
(
d©aVIO
, 
ªÀa£AŒoˇãdLock
,

376 
	`THIS_LOCATION
("$F;cb=releaseAllocLock"));

381 
VIO_RELEASE_RECOVERY_LOCKS
:

382 i‡((
d©aVIO
->
ªcovîySequí˚Numbî
 > 0)

383 && !
	`isRódO∆y
(&
	`d©aVIOAsVIO
(
d©aVIO
)->
vdo
->
ªadO∆yC⁄ãxt
)

384 && (
	`d©aVIOAsCom∂ëi⁄
(
d©aVIO
)->
ªsu…
 !
VDO_READ_ONLY
)) {

385 
	`logW¨nög
("VDOÇotÑead-only when cleaning DataVIO with RJÜock");

389 
VIO_RELEASE_HASH_LOCK
:

390 i‡(
d©aVIO
->
hashLock
 !
NULL
) {

391 
	`œunchHashZ⁄eCÆlback
(
d©aVIO
, 
˛ónHashLock
,

392 
	`THIS_LOCATION
("$F;cb=cleanHashLock"));

397 
VIO_RELEASE_LOGICAL
:

398 i‡(!
	`isCom¥es£dWrôeD©aVIO
(
d©aVIO
)) {

399 
	`œunchLogiˇlCÆlback
(
d©aVIO
, 
ªÀa£LogiˇlLock
,

400 
	`THIS_LOCATION
("$F;cb=releaseLL"));

406 
	`föishCÀ™up
(
d©aVIO
);

408 
	}
}

417 
	$föishWrôeD©aVIOWôhEº‹
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

419 
D©aVIO
 *
d©aVIO
 = 
	`asD©aVIO
(
com∂ëi⁄
);

420 
	`as£πInHashZ⁄e
(
d©aVIO
);

421 
	`c⁄töueHashLockOnEº‹
(
d©aVIO
);

422 
	}
}

435 
boﬁ
 
	$ab‹tOnEº‹
(
ªsu…
,

436 
D©aVIO
 *
d©aVIO
,

437 
RódO∆yA˘i⁄
 
ªadO∆yA˘i⁄
)

439 i‡(
ªsu…
 =
VDO_SUCCESS
) {

440  
Ál£
;

443 
boﬁ
 
ªadO∆y


444 ((
ªsu…
 =
VDO_READ_ONLY
)

445 || (
ªadO∆yA˘i⁄
 =
READ_ONLY
)

446 || ((
ªadO∆yA˘i⁄
 =
READ_ONLY_IF_ASYNC
Ë&& 
	`isAsync
(
d©aVIO
)));

448 i‡(
ªadO∆y
) {

449 i‡(
ªsu…
 !
VDO_READ_ONLY
) {

450 
	`logEº‹WôhSåögEº‹
(
ªsu…
, "PreparingÅoÉnterÑead-only mode:"

451 " D©aVIO f‹ LBN %" 
PRIu64
 " (becoming mapped"

452 "Åÿ%" 
PRIu64
 ",Öreviously mapped"

453 "Åÿ%" 
PRIu64
 ",állocated %" PRIu64 ") is"

455 " o≥øti⁄ %s", 
d©aVIO
->
logiˇl
.
lbn
,

456 
d©aVIO
->
√wM≠≥d
.
pbn
, d©aVIO->
m≠≥d
.pbn,

457 
	`gëD©aVIOAŒoˇti⁄
(
d©aVIO
),

458 
	`gëO≥øti⁄Name
(
d©aVIO
));

460 
	`íãrRódO∆yMode
(&
	`gëVDOFromD©aVIO
(
d©aVIO
)->
ªadO∆yC⁄ãxt
, 
ªsu…
);

463 i‡(
d©aVIO
->
hashLock
 !
NULL
) {

464 
	`œunchHashZ⁄eCÆlback
(
d©aVIO
, 
föishWrôeD©aVIOWôhEº‹
,

465 
	`THIS_LOCATION
(
NULL
));

467 
	`föishD©aVIO
(
d©aVIO
, 
ªsu…
);

469  
åue
;

470 
	}
}

482 
	$föishWrôeD©aVIO
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

484 
D©aVIO
 *
d©aVIO
 = 
	`asD©aVIO
(
com∂ëi⁄
);

485 
	`as£πInHashZ⁄e
(
d©aVIO
);

486 i‡(
	`ab‹tOnEº‹
(
com∂ëi⁄
->
ªsu…
, 
d©aVIO
, 
READ_ONLY_IF_ASYNC
)) {

489 
	`c⁄töueHashLock
(
d©aVIO
);

490 
	}
}

497 
	$ab‹tDedu∂iˇti⁄
(
D©aVIO
 *
d©aVIO
)

499 i‡(!
	`hasAŒoˇti⁄
(
d©aVIO
)) {

502 
	`föishD©aVIO
(
d©aVIO
, 
VDO_NO_SPACE
);

506 i‡(
	`isAsync
(
d©aVIO
)) {

509 
	`wrôeBlock
(
d©aVIO
);

513 i‡(
d©aVIO
->
hashLock
 =
NULL
) {

516 
	`föishD©aVIO
(
d©aVIO
, 
VDO_SUCCESS
);

525 
	`œunchHashZ⁄eCÆlback
(
d©aVIO
, 
föishWrôeD©aVIO
, 
	`THIS_LOCATION
(
NULL
));

526 
	}
}

535 
	$upd©eBlockM≠F‹Dedu≥
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

537 
D©aVIO
 *
d©aVIO
 = 
	`asD©aVIO
(
com∂ëi⁄
);

538 
	`as£πInLogiˇlZ⁄e
(
d©aVIO
);

539 i‡(
	`ab‹tOnEº‹
(
com∂ëi⁄
->
ªsu…
, 
d©aVIO
, 
READ_ONLY
)) {

543 i‡(
d©aVIO
->
hashLock
 !
NULL
) {

544 
	`£tHashZ⁄eCÆlback
(
d©aVIO
, 
föishWrôeD©aVIO
, 
	`THIS_LOCATION
(
NULL
));

546 
com∂ëi⁄
->
ˇŒback
 = 
com∂ëeD©aVIO
;

548 
d©aVIO
->
œ°AsyncO≥øti⁄
 = 
PUT_MAPPED_BLOCK_FOR_DEDUPE
;

549 
	`putM≠≥dBlockAsync
(
d©aVIO
);

550 
	}
}

558 
	$jou∫ÆIn¸emít
(
D©aVIO
 *
d©aVIO
, 
PBNLock
 *
lock
)

560 
	`£tUpRe„ªn˚O≥øti⁄WôhLock
(
DATA_INCREMENT
, 
d©aVIO
->
√wM≠≥d
.
pbn
,

561 
d©aVIO
->
√wM≠≥d
.
°©e
, 
lock
,

562 &
d©aVIO
->
›î©i⁄
);

563 
	`addRecovîyJou∫ÆE¡ry
(
	`gëVDOFromD©aVIO
(
d©aVIO
)->
ªcovîyJou∫Æ
,

564 
d©aVIO
);

565 
	}
}

572 
	$jou∫ÆDe¸emít
(
D©aVIO
 *
d©aVIO
)

574 
	`£tUpRe„ªn˚O≥øti⁄WôhZ⁄e
(
DATA_DECREMENT
, 
d©aVIO
->
m≠≥d
.
pbn
,

575 
d©aVIO
->
m≠≥d
.
°©e
, d©aVIO->m≠≥d.
z⁄e
,

576 &
d©aVIO
->
›î©i⁄
);

577 
	`addRecovîyJou∫ÆE¡ry
(
	`gëVDOFromD©aVIO
(
d©aVIO
)->
ªcovîyJou∫Æ
,

578 
d©aVIO
);

579 
	}
}

586 
	$upd©eRe„ªn˚Cou¡
(
D©aVIO
 *
d©aVIO
)

588 
SœbDïŸ
 *
dïŸ
 = 
	`gëVDOFromD©aVIO
(
d©aVIO
)->depot;

589 
PhysiˇlBlockNumbî
 
pbn
 = 
d©aVIO
->
›î©i⁄
.pbn;

590 
ªsu…
 = 
	`ASSERT
(
	`isPhysiˇlD©aBlock
(
dïŸ
, 
pbn
),

591 "Addög sœb jou∫ÆÉ¡ry f‹ impossibÀ PBN %" 
PRIu64


592 "f‹ LBN %" 
PRIu64
, 
pbn
, 
d©aVIO
->
logiˇl
.
lbn
);

593 i‡(
	`ab‹tOnEº‹
(
ªsu…
, 
d©aVIO
, 
READ_ONLY
)) {

597 
	`addSœbJou∫ÆE¡ry
(
	`gëSœbJou∫Æ
(
dïŸ
, 
pbn
), 
d©aVIO
);

598 
	}
}

606 
	$de¸emítF‹Dedu≥
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

608 
D©aVIO
 *
d©aVIO
 = 
	`asD©aVIO
(
com∂ëi⁄
);

609 
	`as£πInM≠≥dZ⁄e
(
d©aVIO
);

610 i‡(
	`ab‹tOnEº‹
(
com∂ëi⁄
->
ªsu…
, 
d©aVIO
, 
READ_ONLY
)) {

614 
AŒoˇtögVIO
 *
ÆloˇtögVIO
 = 
	`d©aVIOAsAŒoˇtögVIO
(
d©aVIO
);

615 i‡(
ÆloˇtögVIO
->
Æloˇti⁄
 =
d©aVIO
->
m≠≥d
.
pbn
) {

621 
	`ªÀa£PBNWrôeLock
(
ÆloˇtögVIO
);

624 
	`£tLogiˇlCÆlback
(
d©aVIO
, 
upd©eBlockM≠F‹Dedu≥
,

625 
	`THIS_LOCATION
("$F;js=dec"));

626 
d©aVIO
->
œ°AsyncO≥øti⁄
 = 
JOURNAL_DECREMENT_FOR_DEDUPE
;

627 
	`upd©eRe„ªn˚Cou¡
(
d©aVIO
);

628 
	}
}

637 
	$jou∫ÆUnm≠pögF‹Dedu≥
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

639 
D©aVIO
 *
d©aVIO
 = 
	`asD©aVIO
(
com∂ëi⁄
);

640 
	`as£πInJou∫ÆZ⁄e
(
d©aVIO
);

641 i‡(
	`ab‹tOnEº‹
(
com∂ëi⁄
->
ªsu…
, 
d©aVIO
, 
READ_ONLY
)) {

645 i‡(
d©aVIO
->
m≠≥d
.
pbn
 =
ZERO_BLOCK
) {

646 
	`£tLogiˇlCÆlback
(
d©aVIO
, 
upd©eBlockM≠F‹Dedu≥
,

647 
	`THIS_LOCATION
("$F;j=dedupe;js=unmap;cb=updateBM"));

649 
	`£tM≠≥dZ⁄eCÆlback
(
d©aVIO
, 
de¸emítF‹Dedu≥
,

650 
	`THIS_LOCATION
("$F;j=dedupe;js=unmap;cb=decDedupe"));

652 
d©aVIO
->
œ°AsyncO≥øti⁄
 = 
JOURNAL_UNMAPPING_FOR_DEDUPE
;

653 
	`jou∫ÆDe¸emít
(
d©aVIO
);

654 
	}
}

664 
	$ªadOldBlockM≠pögF‹Dedu≥
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

666 
D©aVIO
 *
d©aVIO
 = 
	`asD©aVIO
(
com∂ëi⁄
);

667 
	`as£πInLogiˇlZ⁄e
(
d©aVIO
);

668 i‡(
	`ab‹tOnEº‹
(
com∂ëi⁄
->
ªsu…
, 
d©aVIO
, 
READ_ONLY
)) {

672 
d©aVIO
->
œ°AsyncO≥øti⁄
 = 
GET_MAPPED_BLOCK_FOR_DEDUPE
;

673 
	`£tJou∫ÆCÆlback
(
d©aVIO
, 
jou∫ÆUnm≠pögF‹Dedu≥
,

674 
	`THIS_LOCATION
("$F;cb=journalUnmapDedupe"));

675 
	`gëM≠≥dBlockAsync
(
d©aVIO
);

676 
	}
}

685 
	$ªÀa£Com¥es£dD©aVIO
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

687 
D©aVIO
 *
d©aVIO
 = 
	`asD©aVIO
(
com∂ëi⁄
);

688 
	`as£πInNewM≠≥dZ⁄e
(
d©aVIO
);

689 
	`com∂ëeFøgmít
(
d©aVIO
);

690 i‡(
	`isAsync
(
d©aVIO
Ë|| !
	`hasAŒoˇti⁄
(dataVIO)) {

691 
	`œunchLogiˇlCÆlback
(
d©aVIO
, 
ªadOldBlockM≠pögF‹Dedu≥
,

692 
	`THIS_LOCATION
("$F;cb=readOldBlockMappingForDedupe"));

694 
	`œunchJou∫ÆCÆlback
(
d©aVIO
, 
jou∫ÆUnm≠pögF‹Dedu≥
,

695 
	`THIS_LOCATION
("$F;cb=journalUnmappingForDedupe"));

697 
	}
}

705 
	$ö¸emítF‹Com¥essi⁄
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

707 
D©aVIO
 *
d©aVIO
 = 
	`asD©aVIO
(
com∂ëi⁄
);

708 
	`as£πInNewM≠≥dZ⁄e
(
d©aVIO
);

709 i‡(
	`ab‹tOnEº‹
(
com∂ëi⁄
->
ªsu…
, 
d©aVIO
, 
READ_ONLY
)) {

713 
	`ASSERT_LOG_ONLY
(
	`isCom¥es£d
(
d©aVIO
->
√wM≠≥d
.
°©e
),

715 "which wa†nŸ com¥es£d (logiˇ»block %" 
PRIu64
 ")",

716 
d©aVIO
->
logiˇl
.
lbn
);

717 
	`£tNewM≠≥dZ⁄eCÆlback
(
d©aVIO
, 
ªÀa£Com¥es£dD©aVIO
,

718 
	`THIS_LOCATION
("$F;cb=releaseCompressedDataVIO"));

719 
d©aVIO
->
œ°AsyncO≥øti⁄
 = 
JOURNAL_INCREMENT_FOR_COMPRESSION
;

720 
	`upd©eRe„ªn˚Cou¡
(
d©aVIO
);

721 
	}
}

728 
	$addRecovîyJou∫ÆE¡ryF‹Com¥essi⁄
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

730 
D©aVIO
 *
d©aVIO
 = 
	`asD©aVIO
(
com∂ëi⁄
);

731 
	`as£πInJou∫ÆZ⁄e
(
d©aVIO
);

732 i‡(
	`ab‹tOnEº‹
(
com∂ëi⁄
->
ªsu…
, 
d©aVIO
, 
READ_ONLY_IF_ASYNC
)) {

736 
	`£tNewM≠≥dZ⁄eCÆlback
(
d©aVIO
, 
ö¸emítF‹Com¥essi⁄
,

737 
	`THIS_LOCATION
("$F($dup);js=map/$dup;"

739 
d©aVIO
->
œ°AsyncO≥øti⁄
 = 
JOURNAL_MAPPING_FOR_COMPRESSION
;

740 
	`jou∫ÆIn¸emít
(
d©aVIO
, d©aVIO->
com¥essi⁄
.
wrôî
->
wrôeLock
);

741 
	}
}

749 
	$upd©eAlbúeoF‹Com¥essi⁄
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

751 
D©aVIO
 *
d©aVIO
 = 
	`asD©aVIO
(
com∂ëi⁄
);

753 i‡(
	`ab‹tOnEº‹
(
com∂ëi⁄
->
ªsu…
, 
d©aVIO
, 
READ_ONLY_IF_ASYNC
)) {

757 i‡(!
	`isCom¥es£d
(
d©aVIO
->
√wM≠≥d
.
°©e
)) {

758 
	`ab‹tDedu∂iˇti⁄
(
d©aVIO
);

771 
d©aVIO
->
œ°AsyncO≥øti⁄
 = 
UPDATE_ALBIREO_FOR_COMPRESSION
;

772 
	`£tJou∫ÆCÆlback
(
d©aVIO
, 
addRecovîyJou∫ÆE¡ryF‹Com¥essi⁄
,

773 
	`THIS_LOCATION
("$F;dup=update(compress)"));

774 
com∂ëi⁄
->
œyî
->
	`upd©eAlbúeo
(
d©aVIO
);

775 
	}
}

783 
	$∑ckCom¥es£dD©a
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

785 
D©aVIO
 *
d©aVIO
 = 
	`asD©aVIO
(
com∂ëi⁄
);

786 
	`as£πInPackîZ⁄e
(
d©aVIO
);

791 i‡(!
	`mayPackD©aVIO
(
d©aVIO
)) {

792 
	`ab‹tDedu∂iˇti⁄
(
d©aVIO
);

796 
d©aVIO
->
œ°AsyncO≥øti⁄
 = 
PACK_COMPRESSED_BLOCK
;

797 
com∂ëi⁄
->
ˇŒback
 = 
upd©eAlbúeoF‹Com¥essi⁄
;

798 
	`©ãm±Packög
(
d©aVIO
);

799 
	}
}

802 
	$com¥essD©a
(
D©aVIO
 *
d©aVIO
)

804 
	`ASSERT_LOG_ONLY
(!
d©aVIO
->
isDu∂iˇã
,

806 i‡(!
	`mayCom¥essD©aVIO
(
d©aVIO
)) {

807 
	`ab‹tDedu∂iˇti⁄
(
d©aVIO
);

811 
d©aVIO
->
œ°AsyncO≥øti⁄
 = 
COMPRESS_DATA
;

812 
	`£tPackîCÆlback
(
d©aVIO
, 
∑ckCom¥es£dD©a
, 
	`THIS_LOCATION
("$F;cb=pack"));

813 
	`d©aVIOAsCom∂ëi⁄
(
d©aVIO
)->
œyî
->
	`com¥essD©aVIO
(dataVIO);

814 
	}
}

822 
	$com¥essD©aCÆlback
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

824 
	`com¥essD©a
(
	`asD©aVIO
(
com∂ëi⁄
));

825 
	}
}

835 
	$föishRﬁlovî
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

837 
D©aVIO
 *
d©aVIO
 = 
	`asD©aVIO
(
com∂ëi⁄
);

838 
	`as£πInDu∂iˇãZ⁄e
(
d©aVIO
);

839 
d©aVIO
->
isDu∂iˇã
 = 
Ál£
;

840 i‡(!
d©aVIO
->
rﬁÀdOvî
) {

841 
	`©omicSt‹e64
(&
d©aVIO
->
du∂iˇãPBN
, 
ZERO_BLOCK
);

843 
	`ªÀa£PBNRódLock
(
d©aVIO
);

844 
	`com¥essD©a
(
d©aVIO
);

845 
	}
}

852 
	$upd©eAlbúeoF‹Rﬁlovî
(
D©aVIO
 *
d©aVIO
)

854 
VDOCom∂ëi⁄
 *
com∂ëi⁄
 = 
	`d©aVIOAsCom∂ëi⁄
(
d©aVIO
);

855 i‡(!
	`hasAŒoˇti⁄
(
d©aVIO
)) {

862 
	`föishRﬁlovî
(
com∂ëi⁄
);

868 
	`©omicSt‹e64
(&
d©aVIO
->
du∂iˇãPBN
, 
ZERO_BLOCK
);

869 
d©aVIO
->
rﬁÀdOvî
 = 
åue
;

870 
d©aVIO
->
œ°AsyncO≥øti⁄
 = 
UPDATE_ALBIREO_FOR_ROLLOVER
;

871 
	`£tDu∂iˇãZ⁄eCÆlback
(
d©aVIO
, 
föishRﬁlovî
, 
	`THIS_LOCATION
(
NULL
));

872 
com∂ëi⁄
->
œyî
->
	`upd©eAlbúeo
(
d©aVIO
);

873 
	}
}

881 
	$ö¸emítF‹Dedu≥
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

883 
D©aVIO
 *
d©aVIO
 = 
	`asD©aVIO
(
com∂ëi⁄
);

884 
	`as£πInNewM≠≥dZ⁄e
(
d©aVIO
);

885 i‡(
	`ab‹tOnEº‹
(
com∂ëi⁄
->
ªsu…
, 
d©aVIO
, 
READ_ONLY
)) {

889 
	`ASSERT_LOG_ONLY
(
d©aVIO
->
isDu∂iˇã
,

891 "which wa†nŸá du∂iˇã (logiˇ»block %" 
PRIu64
 ")",

892 
d©aVIO
->
logiˇl
.
lbn
);

899 i‡(
	`isAsync
(
d©aVIO
Ë|| !
	`hasAŒoˇti⁄
(dataVIO)) {

900 
	`£tLogiˇlCÆlback
(
d©aVIO
, 
ªadOldBlockM≠pögF‹Dedu≥
,

901 
	`THIS_LOCATION
("$F;cb=readOldBlockMappingForDedupe"));

903 
	`£tJou∫ÆCÆlback
(
d©aVIO
, 
jou∫ÆUnm≠pögF‹Dedu≥
,

904 
	`THIS_LOCATION
("$F;cb=journalUnmappingForDedupe"));

906 
d©aVIO
->
œ°AsyncO≥øti⁄
 = 
JOURNAL_INCREMENT_FOR_DEDUPE
;

907 
	`upd©eRe„ªn˚Cou¡
(
d©aVIO
);

908 
	}
}

916 
	$addRecovîyJou∫ÆE¡ryF‹Dedu≥
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

918 
D©aVIO
 *
d©aVIO
 = 
	`asD©aVIO
(
com∂ëi⁄
);

919 
	`as£πInJou∫ÆZ⁄e
(
d©aVIO
);

920 i‡(
	`ab‹tOnEº‹
(
com∂ëi⁄
->
ªsu…
, 
d©aVIO
, 
READ_ONLY_IF_ASYNC
)) {

924 
	`£tNewM≠≥dZ⁄eCÆlback
(
d©aVIO
, 
ö¸emítF‹Dedu≥
,

925 
	`THIS_LOCATION
("$F($dup);js=map/$dup;"

927 
d©aVIO
->
œ°AsyncO≥øti⁄
 = 
JOURNAL_MAPPING_FOR_DEDUPE
;

928 
	`jou∫ÆIn¸emít
(
d©aVIO
, 
	`gëDu∂iˇãLock
(dataVIO));

929 
	}
}

938 
	$sh¨eBlock
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

940 
D©aVIO
 *
d©aVIO
 = 
	`asD©aVIO
(
com∂ëi⁄
);

941 
	`as£πInDu∂iˇãZ⁄e
(
d©aVIO
);

942 i‡(
	`ab‹tOnEº‹
(
com∂ëi⁄
->
ªsu…
, 
d©aVIO
, 
READ_ONLY_IF_ASYNC
)) {

946 i‡(!
d©aVIO
->
isDu∂iˇã
) {

947 
	`ªÀa£PBNRódLock
(
d©aVIO
);

948 
	`com¥essD©a
(
d©aVIO
);

952 
SœbDïŸ
 *
dïŸ
 = 
	`gëVDOFromD©aVIO
(
d©aVIO
)->depot;

953 i‡(
	`gëIn¸emítLimô
(
dïŸ
, 
d©aVIO
->
du∂iˇã
.
pbn
) == 0) {

956 
	`upd©eAlbúeoF‹Rﬁlovî
(
d©aVIO
);

960 
d©aVIO
->
√wM≠≥d
 = d©aVIO->
du∂iˇã
;

961 
	`œunchJou∫ÆCÆlback
(
d©aVIO
, 
addRecovîyJou∫ÆE¡ryF‹Dedu≥
,

962 
	`THIS_LOCATION
("$F;cb=addJournalEntryDup"));

963 
	}
}

970 
	$ab‹tPBNRódLock
(
D©aVIO
 *
d©aVIO
)

972 
	`ASSERT_LOG_ONLY
(
d©aVIO
->
du∂iˇãLock
 =
NULL
,

975 
	`©omicSt‹e64
(&
d©aVIO
->
du∂iˇãPBN
, 
ZERO_BLOCK
);

976 
d©aVIO
->
isDu∂iˇã
 = 
Ál£
;

984 
Waôî
 *
waôî
 = 
	`dequeueNextWaôî
(&
d©aVIO
->
lockRëryWaôîs
);

985 i‡(
waôî
 !
NULL
) {

987 
D©aVIO
 *
√xtD©aVIO
 = 
	`waôîAsD©aVIO
(
waôî
);

988 
	`å™s„rAŒWaôîs
(&
d©aVIO
->
lockRëryWaôîs
,

989 &
√xtD©aVIO
->
lockRëryWaôîs
);

990 
	`d©aVIOAsCom∂ëi⁄
(
√xtD©aVIO
)->
ªqueue
 = 
åue
;

991 
	`œunchDu∂iˇãZ⁄eCÆlback
(
√xtD©aVIO
, 
acquúePBNRódLock
,

992 
	`THIS_LOCATION
("$F;cb=acquirePBNRL"));

994 
	}
}

1004 
boﬁ
 
	$ab‹tOnPBNLockEº‹
(
D©aVIO
 *
d©aVIO
, 
ªsu…
)

1006 i‡(
ªsu…
 =
VDO_SUCCESS
) {

1007  
Ál£
;

1010 
	`ab‹tPBNRódLock
(
d©aVIO
);

1011  
	`ab‹tOnEº‹
(
ªsu…
, 
d©aVIO
, 
READ_ONLY_IF_ASYNC
);

1012 
	}
}

1015 
	$waôOnPBNRódLock
(
D©aVIO
 *
d©aVIO
, 
PBNLock
 *
lock
)

1017 
d©aVIO
->
œ°AsyncO≥øti⁄
 = 
ACQUIRE_PBN_READ_LOCK
;

1018 
ªsu…
 = 
	`íqueueD©aVIO
(&
lock
->
waôîs
, 
d©aVIO
, 
	`THIS_LOCATION
(
NULL
));

1019 
	`ab‹tOnPBNLockEº‹
(
d©aVIO
, 
ªsu…
);

1020 
	}
}

1027 
	$ab‹tPBNRódLockAndCom¥ess
(
D©aVIO
 *
d©aVIO
)

1029 
	`ab‹tPBNRódLock
(
d©aVIO
);

1030 
	`com¥essD©a
(
d©aVIO
);

1031 
	}
}

1034 
	$waôOnPBNWrôeLock
(
D©aVIO
 *
d©aVIO
, 
PBNLock
 *
lock
)

1036 
D©aVIO
 *
lockHﬁdî
 = 
	`lockHﬁdîAsD©aVIO
(
lock
);

1037 
PhysiˇlLayî
 *
œyî
 = 
	`d©aVIOAsCom∂ëi⁄
(
d©aVIO
)->layer;

1038 i‡(!
œyî
->
	`com∑ªD©aVIOs
(
d©aVIO
, 
lockHﬁdî
)) {

1039 
	`ab‹tPBNRódLockAndCom¥ess
(
d©aVIO
);

1043 
PhysiˇlBlockNumbî
 
lockHﬁdîDu∂iˇãPBN


1044 
	`©omicLﬂd64
(&
lockHﬁdî
->
du∂iˇãPBN
);

1045 i‡(
lockHﬁdîDu∂iˇãPBN
 !
ZERO_BLOCK
) {

1083 
VDO
 *
vdo
 = 
	`gëVDOFromD©aVIO
(
d©aVIO
);

1084 
	`©omicAdd64
(&
vdo
->
îr‹Sèts
.
dedu≥DódlockAvoid™˚Cou¡
, 1);

1085 
	`logDebug
("Deadlockávoidance mechanismÅriggered, continuing DataVIO"

1087 
	`ab‹tPBNRódLockAndCom¥ess
(
d©aVIO
);

1104 
d©aVIO
->
du∂iˇã
.
°©e
 = 
MAPPING_STATE_UNCOMPRESSED
;

1107 
d©aVIO
->
œ°AsyncO≥øti⁄
 = 
ACQUIRE_PBN_READ_LOCK
;

1108 
ªsu…
 = 
	`íqueueD©aVIO
(&
lock
->
waôîs
, 
d©aVIO
, 
	`THIS_LOCATION
(
NULL
));

1109 i‡(
	`ab‹tOnPBNLockEº‹
(
d©aVIO
, 
ªsu…
)) {

1115 i‡(
	`ˇn˚lCom¥essi⁄
(
lockHﬁdî
)) {

1116 
d©aVIO
->
com¥essi⁄
.
lockHﬁdî
 =ÜockHolder;

1117 
	`œunchPackîCÆlback
(
d©aVIO
, 
ªmoveLockHﬁdîFromPackî
,

1118 
	`THIS_LOCATION
("$F;cb=removeLockHolderFromPacker"));

1120 
	}
}

1123 
	$waôOnPBNCom¥es£dWrôeLock
(
D©aVIO
 *
d©aVIO
, 
PBNLock
 *
lock
)

1132 i‡(
	`isCom¥es£d
(
d©aVIO
->
du∂iˇã
.
°©e
)) {

1133 
d©aVIO
->
œ°AsyncO≥øti⁄
 = 
ACQUIRE_PBN_READ_LOCK
;

1134 
ªsu…
 = 
	`íqueueD©aVIO
(&
lock
->
waôîs
, 
d©aVIO
, 
	`THIS_LOCATION
(
NULL
));

1135 
	`ab‹tOnPBNLockEº‹
(
d©aVIO
, 
ªsu…
);

1137 
	`ab‹tPBNRódLockAndCom¥ess
(
d©aVIO
);

1139 
	}
}

1142 
waôOnPBNBlockM≠WrôeLock
(
D©aVIO
 *
d©aVIO
,

1143 
PBNLock
 *
lock
 
__©åibuã__
((
unu£d
)))

1147 
ab‹tPBNRódLock
(
d©aVIO
);

1148 
VDOCom∂ëi⁄
 *
	gcom∂ëi⁄
 = 
d©aVIOAsCom∂ëi⁄
(
d©aVIO
);

1149 
	gcom∂ëi⁄
->
	gˇŒback
 = 
com¥essD©aCÆlback
;

1150 
	gd©aVIO
->
	gœ°AsyncO≥øti⁄
 = 
UPDATE_ALBIREO_FOR_NON_BLOCK_MAP_DEDUPE
;

1151 
	gcom∂ëi⁄
->
	gœyî
->
upd©eAlbúeo
(
d©aVIO
);

1155 
	$acquúePBNRódLock
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

1157 
D©aVIO
 *
d©aVIO
 = 
	`asD©aVIO
(
com∂ëi⁄
);

1158 
PhysiˇlZ⁄e
 *
z⁄e
 = 
d©aVIO
->
du∂iˇã
.zone;

1159 
	`as£πInDu∂iˇãZ⁄e
(
d©aVIO
);

1161 
	`ASSERT_LOG_ONLY
(!
	`isPBNLocked
(
d©aVIO
->
du∂iˇãLock
),

1163 
	`ASSERT_LOG_ONLY
(
d©aVIO
->
du∂iˇãLock
 =
NULL
,

1166 
SœbDïŸ
 *
dïŸ
 = 
	`gëVDOFromD©aVIO
(
d©aVIO
)->depot;

1167 
Sœb
 *
¶ab
 = 
	`gëSœb
(
dïŸ
, 
d©aVIO
->
du∂iˇã
.
pbn
);

1168 i‡(
	`isUƒecovîedSœb
(
¶ab
)) {

1171 
	`ab‹tPBNRódLockAndCom¥ess
(
d©aVIO
);

1175 
PBNLock
 *
lock
;

1176 
ªsu…
 = 
	`©ãm±PBNLock
(
z⁄e
, 
d©aVIO
->
du∂iˇã
.
pbn
,

1177 
VIO_READ_LOCK
, &
lock
);

1178 i‡(
	`ab‹tOnPBNLockEº‹
(
d©aVIO
, 
ªsu…
)) {

1182 i‡(
lock
->
hﬁdî
 !
NULL
) {

1183 
	`waôOnPBNLock
(
d©aVIO
, 
lock
);

1188 
lock
->
hﬁdî
 = 
	`d©aVIOAsAŒoˇtögVIO
(
d©aVIO
);

1189 
d©aVIO
->
du∂iˇãLock
 = 
lock
;

1193 
	`å™s„rAŒWaôîs
(&
d©aVIO
->
lockRëryWaôîs
,

1194 &
d©aVIO
->
du∂iˇãLock
->
waôîs
);

1197 
ªsu…
 = 
	`acquúeProvisi⁄ÆRe„ªn˚
(
¶ab
, 
d©aVIO
->
du∂iˇã
.
pbn
, 
lock
);

1198 i‡(
ªsu…
 !
VDO_SUCCESS
) {

1199 
	`logW¨nögWôhSåögEº‹
(
ªsu…
,

1202 
d©aVIO
->
isDu∂iˇã
 = 
Ál£
;

1203 
	`ªÀa£PBNRódLock
(
d©aVIO
);

1204 
	`com¥essD©a
(
d©aVIO
);

1208 
	`£tDu∂iˇãZ⁄eCÆlback
(
d©aVIO
, 
sh¨eBlock
,

1209 
	`THIS_LOCATION
("$F;cb=shareBlock"));

1210 
d©aVIO
->
œ°AsyncO≥øti⁄
 = 
VERIFY_DEDUPLICATION
;

1211 
com∂ëi⁄
->
œyî
->
	`vîifyDu∂iˇti⁄
(
d©aVIO
);

1212 
	}
}

1215 
	$vîifyAdvi˚
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

1217 
D©aVIO
 *
d©aVIO
 = 
	`asD©aVIO
(
com∂ëi⁄
);

1219 i‡(
	`ab‹tOnEº‹
(
com∂ëi⁄
->
ªsu…
, 
d©aVIO
, 
READ_ONLY_IF_ASYNC
)) {

1223 i‡(!
d©aVIO
->
isDu∂iˇã
) {

1224 
	`com¥essD©a
(
d©aVIO
);

1229 i‡(
d©aVIO
->
√wM≠≥d
.
pbn
 =d©aVIO->
du∂iˇã
.pbn) {

1230 
d©aVIO
->
isDu∂iˇã
 = 
Ál£
;

1231 
	`com¥essD©a
(
d©aVIO
);

1235 
	`œunchDu∂iˇãZ⁄eCÆlback
(
d©aVIO
, 
acquúePBNRódLock
,

1236 
	`THIS_LOCATION
("$F;cb=acquirePBNRL"));

1237 
	}
}

1247 
	$lockHashInZ⁄e
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

1249 
D©aVIO
 *
d©aVIO
 = 
	`asD©aVIO
(
com∂ëi⁄
);

1250 
	`as£πInHashZ⁄e
(
d©aVIO
);

1252 i‡(
	`ab‹tOnEº‹
(
com∂ëi⁄
->
ªsu…
, 
d©aVIO
, 
READ_ONLY
)) {

1256 
ªsu…
 = 
	`acquúeHashLock
(
d©aVIO
);

1257 i‡(
	`ab‹tOnEº‹
(
ªsu…
, 
d©aVIO
, 
READ_ONLY
)) {

1261 i‡(
d©aVIO
->
hashLock
 =
NULL
) {

1264 
	`com¥essD©a
(
d©aVIO
);

1268 
	`íãrHashLock
(
d©aVIO
);

1269 
	}
}

1279 
	$ªsﬁveHashZ⁄e
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

1281 
D©aVIO
 *
d©aVIO
 = 
	`asD©aVIO
(
com∂ëi⁄
);

1283 i‡(
	`ab‹tOnEº‹
(
com∂ëi⁄
->
ªsu…
, 
d©aVIO
, 
READ_ONLY
)) {

1287 
	`ASSERT_LOG_ONLY
(!
d©aVIO
->
isZîoBlock
, "zero blocks shouldÇot be hashed");

1288 
	`ASSERT_LOG_ONLY
(!
d©aVIO
->
chunkNameSë
, "blocks shouldÇot be hashedÅwice");

1292 
d©aVIO
->
chunkNameSë
 = 
åue
;

1294 
d©aVIO
->
hashZ⁄e


1295 
	`£À˘HashZ⁄e
(
	`gëVDOFromD©aVIO
(
d©aVIO
), &d©aVIO->
chunkName
);

1296 
d©aVIO
->
œ°AsyncO≥øti⁄
 = 
ACQUIRE_HASH_LOCK
;

1297 
	`œunchHashZ⁄eCÆlback
(
d©aVIO
, 
lockHashInZ⁄e
, 
	`THIS_LOCATION
(
NULL
));

1298 
	}
}

1308 
	$¥ï¨eF‹Dedu≥
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

1310 
D©aVIO
 *
d©aVIO
 = 
	`asD©aVIO
(
com∂ëi⁄
);

1312 
	`d©aVIOAddTø˚Rec‹d
(
d©aVIO
, 
	`THIS_LOCATION
(
NULL
));

1313 i‡(
	`ab‹tOnEº‹
(
com∂ëi⁄
->
ªsu…
, 
d©aVIO
, 
READ_ONLY
)) {

1317 i‡(!
	`isAsync
(
d©aVIO
)) {

1320 
d©aVIO
->
m≠≥d
 = d©aVIO->
√wM≠≥d
;

1323 
	`ASSERT_LOG_ONLY
(!
d©aVIO
->
isZîoBlock
,

1328 
d©aVIO
->
œ°AsyncO≥øti⁄
 = 
HASH_DATA
;

1331 
	`£tAŒoˇãdZ⁄eCÆlback
(
d©aVIO
, 
ªsﬁveHashZ⁄e
, 
	`THIS_LOCATION
(
NULL
));

1332 
com∂ëi⁄
->
œyî
->
	`hashD©a
(
d©aVIO
);

1333 
	}
}

1342 
	$upd©eBlockM≠F‹Wrôe
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

1344 
D©aVIO
 *
d©aVIO
 = 
	`asD©aVIO
(
com∂ëi⁄
);

1345 
	`as£πInLogiˇlZ⁄e
(
d©aVIO
);

1346 
	`d©aVIOAddTø˚Rec‹d
(
d©aVIO
, 
	`THIS_LOCATION
(
NULL
));

1347 i‡(
	`ab‹tOnEº‹
(
com∂ëi⁄
->
ªsu…
, 
d©aVIO
, 
READ_ONLY
)) {

1351 i‡(
d©aVIO
->
isZîoBlock
 || 
	`isTrimD©aVIO
(dataVIO)) {

1352 
com∂ëi⁄
->
ˇŒback
 = 
com∂ëeD©aVIO
;

1353 } i‡(!
	`isAsync
(
d©aVIO
)) {

1356 
com∂ëi⁄
->
ˇŒback
 = 
¥ï¨eF‹Dedu≥
;

1357 } i‡(
d©aVIO
->
hashLock
 !
NULL
) {

1360 
	`£tHashZ⁄eCÆlback
(
d©aVIO
, 
föishWrôeD©aVIO
, 
	`THIS_LOCATION
(
NULL
));

1363 
com∂ëi⁄
->
ˇŒback
 = 
com∂ëeD©aVIO
;

1366 
d©aVIO
->
œ°AsyncO≥øti⁄
 = 
PUT_MAPPED_BLOCK
;

1367 
	`putM≠≥dBlockAsync
(
d©aVIO
);

1368 
	}
}

1376 
	$de¸emítF‹Wrôe
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

1378 
D©aVIO
 *
d©aVIO
 = 
	`asD©aVIO
(
com∂ëi⁄
);

1379 
	`as£πInM≠≥dZ⁄e
(
d©aVIO
);

1380 i‡(
	`ab‹tOnEº‹
(
com∂ëi⁄
->
ªsu…
, 
d©aVIO
, 
READ_ONLY
)) {

1384 
d©aVIO
->
œ°AsyncO≥øti⁄
 = 
JOURNAL_DECREMENT_FOR_WRITE
;

1385 
	`£tLogiˇlCÆlback
(
d©aVIO
, 
upd©eBlockM≠F‹Wrôe
, 
	`THIS_LOCATION
(
NULL
));

1386 
	`upd©eRe„ªn˚Cou¡
(
d©aVIO
);

1387 
	}
}

1395 
	$jou∫ÆUnm≠pögF‹Wrôe
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

1397 
D©aVIO
 *
d©aVIO
 = 
	`asD©aVIO
(
com∂ëi⁄
);

1398 
	`as£πInJou∫ÆZ⁄e
(
d©aVIO
);

1399 i‡(
	`ab‹tOnEº‹
(
com∂ëi⁄
->
ªsu…
, 
d©aVIO
, 
READ_ONLY
)) {

1403 i‡(
d©aVIO
->
m≠≥d
.
pbn
 =
ZERO_BLOCK
) {

1404 
	`£tLogiˇlCÆlback
(
d©aVIO
, 
upd©eBlockM≠F‹Wrôe
,

1405 
	`THIS_LOCATION
("$F;js=unmap;cb=updateBMwrite"));

1407 
	`£tM≠≥dZ⁄eCÆlback
(
d©aVIO
, 
de¸emítF‹Wrôe
,

1408 
	`THIS_LOCATION
("$F;js=unmap;cb=decWrite"));

1410 
d©aVIO
->
œ°AsyncO≥øti⁄
 = 
JOURNAL_UNMAPPING_FOR_WRITE
;

1411 
	`jou∫ÆDe¸emít
(
d©aVIO
);

1412 
	}
}

1422 
	$ªadOldBlockM≠pögF‹Wrôe
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

1424 
D©aVIO
 *
d©aVIO
 = 
	`asD©aVIO
(
com∂ëi⁄
);

1425 
	`as£πInLogiˇlZ⁄e
(
d©aVIO
);

1426 i‡(
	`ab‹tOnEº‹
(
com∂ëi⁄
->
ªsu…
, 
d©aVIO
, 
READ_ONLY
)) {

1430 
	`£tJou∫ÆCÆlback
(
d©aVIO
, 
jou∫ÆUnm≠pögF‹Wrôe
,

1431 
	`THIS_LOCATION
("$F;cb=journalUnmapWrite"));

1432 
d©aVIO
->
œ°AsyncO≥øti⁄
 = 
GET_MAPPED_BLOCK_FOR_WRITE
;

1433 
	`gëM≠≥dBlockAsync
(
d©aVIO
);

1434 
	}
}

1441 
	$acknowÀdgeWrôe
(
D©aVIO
 *
d©aVIO
)

1443 
	`ASSERT_LOG_ONLY
(
d©aVIO
->
hasFlushGíî©i⁄Lock
,

1445 
d©aVIO
->
œ°AsyncO≥øti⁄
 = 
ACKNOWLEDGE_WRITE
;

1446 
	`d©aVIOAsCom∂ëi⁄
(
d©aVIO
)->
œyî
->
	`acknowÀdgeD©aVIO
(dataVIO);

1447 
	}
}

1456 
	$acknowÀdgeWrôeCÆlback
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

1458 
D©aVIO
 *
d©aVIO
 = 
	`asD©aVIO
(
com∂ëi⁄
);

1459 i‡(
	`ab‹tOnEº‹
(
com∂ëi⁄
->
ªsu…
, 
d©aVIO
, 
READ_ONLY
)) {

1463 
	`£tLogiˇlCÆlback
(
d©aVIO
, 
ªadOldBlockM≠pögF‹Wrôe
,

1464 
	`THIS_LOCATION
(
NULL
));

1465 
	`acknowÀdgeWrôe
(
d©aVIO
);

1466 
	}
}

1469 
VDOA˘i⁄
 *
	$gëWrôeIn¸emítCÆlback
(
D©aVIO
 *
d©aVIO
)

1471  (
	`isAsync
(
d©aVIO
)

1472 ? 
ªadOldBlockM≠pögF‹Wrôe
 : 
acknowÀdgeWrôeCÆlback
);

1473 
	}
}

1481 
	$ö¸emítF‹Wrôe
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

1483 
D©aVIO
 *
d©aVIO
 = 
	`asD©aVIO
(
com∂ëi⁄
);

1484 
	`as£πInAŒoˇãdZ⁄e
(
d©aVIO
);

1485 i‡(
	`ab‹tOnEº‹
(
com∂ëi⁄
->
ªsu…
, 
d©aVIO
, 
READ_ONLY_IF_ASYNC
)) {

1489 
d©aVIO
->
œ°AsyncO≥øti⁄
 = 
JOURNAL_INCREMENT_FOR_WRITE
;

1490 
	`£tLogiˇlCÆlback
(
d©aVIO
, 
	`gëWrôeIn¸emítCÆlback
(dataVIO),

1491 
	`THIS_LOCATION
(
NULL
));

1492 
	`upd©eRe„ªn˚Cou¡
(
d©aVIO
);

1493 
	}
}

1502 
	$föishBlockWrôe
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

1504 
D©aVIO
 *
d©aVIO
 = 
	`asD©aVIO
(
com∂ëi⁄
);

1505 
	`as£πInJou∫ÆZ⁄e
(
d©aVIO
);

1506 i‡(
	`ab‹tOnEº‹
(
com∂ëi⁄
->
ªsu…
, 
d©aVIO
, 
READ_ONLY_IF_ASYNC
)) {

1510 i‡(
d©aVIO
->
√wM≠≥d
.
pbn
 =
ZERO_BLOCK
) {

1511 
	`£tLogiˇlCÆlback
(
d©aVIO
, 
	`gëWrôeIn¸emítCÆlback
(dataVIO),

1512 
	`THIS_LOCATION
("$F;js=writeZero"));

1514 
	`£tAŒoˇãdZ⁄eCÆlback
(
d©aVIO
, 
ö¸emítF‹Wrôe
,

1515 
	`THIS_LOCATION
("$F;js=mapWrite"));

1517 
d©aVIO
->
œ°AsyncO≥øti⁄
 = 
JOURNAL_MAPPING_FOR_WRITE
;

1518 
	`jou∫ÆIn¸emít
(
d©aVIO
, 
	`d©aVIOAsAŒoˇtögVIO
(d©aVIO)->
wrôeLock
);

1519 
	}
}

1526 
	$wrôeBlock
(
D©aVIO
 *
d©aVIO
)

1528 
d©aVIO
->
œ°AsyncO≥øti⁄
 = 
WRITE_DATA
;

1529 
	`£tJou∫ÆCÆlback
(
d©aVIO
, 
föishBlockWrôe
,

1530 
	`THIS_LOCATION
("$F(data);cb=finishWrite"));

1531 
	`d©aVIOAsCom∂ëi⁄
(
d©aVIO
)->
œyî
->
	`wrôeD©a
(dataVIO);

1532 
	}
}

1542 
	$c⁄töueWrôeA·îAŒoˇti⁄
(
AŒoˇtögVIO
 *
ÆloˇtögVIO
)

1544 
D©aVIO
 *
d©aVIO
 = 
	`ÆloˇtögVIOAsD©aVIO
(
ÆloˇtögVIO
);

1545 i‡(
	`ab‹tOnEº‹
(
	`d©aVIOAsCom∂ëi⁄
(
d©aVIO
)->
ªsu…
, dataVIO,

1546 
NOT_READ_ONLY
)) {

1550 i‡(!
	`hasAŒoˇti⁄
(
d©aVIO
)) {

1551 
	`¥ï¨eF‹Dedu≥
(
	`d©aVIOAsCom∂ëi⁄
(
d©aVIO
));

1555 
	`©omicSt‹eBoﬁ
(&
d©aVIO
->
hasAŒoˇti⁄
, 
åue
);

1556 
d©aVIO
->
√wM≠≥d
 = (
Z⁄edPBN
) {

1557 .
z⁄e
 = 
ÆloˇtögVIO
->zone,

1558 .
pbn
 = 
ÆloˇtögVIO
->
Æloˇti⁄
,

1559 .
°©e
 = 
MAPPING_STATE_UNCOMPRESSED
,

1562 i‡(
	`isAsync
(
d©aVIO
)) {

1565 
	`£tAŒoˇãdZ⁄eCÆlback
(
d©aVIO
, 
¥ï¨eF‹Dedu≥
, 
	`THIS_LOCATION
(
NULL
));

1566 
	`acknowÀdgeWrôe
(
d©aVIO
);

1568 
	`wrôeBlock
(
d©aVIO
);

1570 
	}
}

1578 
	$c⁄töueWrôeWôhBlockM≠SlŸ
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

1580 
D©aVIO
 *
d©aVIO
 = 
	`asD©aVIO
(
com∂ëi⁄
);

1582 i‡(
	`ab‹tOnEº‹
(
com∂ëi⁄
->
ªsu…
, 
d©aVIO
, 
NOT_READ_ONLY
)) {

1586 i‡(
d©aVIO
->
åìLock
.
åìSlŸs
[0].
blockM≠SlŸ
.
pbn
 =
ZERO_BLOCK
) {

1587 
ªsu…
 = 
	`ASSERT
(
	`isTrimD©aVIO
(
d©aVIO
),

1589 i‡(
	`ab‹tOnEº‹
(
ªsu…
, 
d©aVIO
, 
READ_ONLY
)) {

1595 
	`föishD©aVIO
(
d©aVIO
, 
VDO_SUCCESS
);

1599 i‡(
d©aVIO
->
isZîoBlock
 || 
	`isTrimD©aVIO
(dataVIO)) {

1602 
d©aVIO
->
√wM≠≥d
.
pbn
 = 
ZERO_BLOCK
;

1603 
	`œunchJou∫ÆCÆlback
(
d©aVIO
, 
föishBlockWrôe
,

1604 
	`THIS_LOCATION
("$F;cb=finishWrite"));

1608 
	`ÆloˇãD©aBlock
(
	`d©aVIOAsAŒoˇtögVIO
(
d©aVIO
), 
VIO_WRITE_LOCK
,

1609 
c⁄töueWrôeA·îAŒoˇti⁄
);

1610 
	}
}

1613 
	$œunchWrôeD©aVIO
(
D©aVIO
 *
d©aVIO
)

1615 i‡(
	`isRódO∆y
(&
	`d©aVIOAsVIO
(
d©aVIO
)->
vdo
->
ªadO∆yC⁄ãxt
)) {

1616 
	`föishD©aVIO
(
d©aVIO
, 
VDO_READ_ONLY
);

1621 
ªsu…
 = 
	`acquúeFlushGíî©i⁄Lock
(
d©aVIO
);

1622 i‡(
	`ab‹tOnEº‹
(
ªsu…
, 
d©aVIO
, 
NOT_READ_ONLY
)) {

1627 
d©aVIO
->
œ°AsyncO≥øti⁄
 = 
FIND_BLOCK_MAP_SLOT
;

1628 
	`födBlockM≠SlŸAsync
(
d©aVIO
, 
c⁄töueWrôeWôhBlockM≠SlŸ
,

1629 
	`gëLogiˇlZ⁄eThªadID
(
d©aVIO
->
logiˇl
.
z⁄e
));

1630 
	}
}

1633 
	$˛ónupWrôeD©aVIO
(
D©aVIO
 *
d©aVIO
)

1635 
	`≥rf‹mCÀ™upSège
(
d©aVIO
, 
VIO_RELEASE_DUPLICATE
);

1636 
	}
}

	@vdo/base/vioWrite.h

22 #i‚de‡
VIO_WRITE_H


23 
	#VIO_WRITE_H


	)

25 
	~"ty≥s.h
"

33 
waôOnPBNRódLock
(
D©aVIO
 *
d©aVIO
, 
PBNLock
 *
lock
);

43 
waôOnPBNWrôeLock
(
D©aVIO
 *
d©aVIO
, 
PBNLock
 *
lock
);

53 
waôOnPBNCom¥es£dWrôeLock
(
D©aVIO
 *
d©aVIO
, 
PBNLock
 *
lock
);

63 
waôOnPBNBlockM≠WrôeLock
(
D©aVIO
 *
d©aVIO
,

64 
PBNLock
 *
lock
 
__©åibuã__
((
unu£d
)));

78 
acquúePBNRódLock
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
);

86 
ªÀa£PBNRódLock
(
D©aVIO
 *
d©aVIO
);

95 
œunchWrôeD©aVIO
(
D©aVIO
 *
d©aVIO
);

102 
˛ónupWrôeD©aVIO
(
D©aVIO
 *
d©aVIO
);

110 
vîifyAdvi˚
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
);

118 
com¥essD©a
(
D©aVIO
 *
d©aVIO
);

	@vdo/base/volumeGeometry.c

22 
	~"vﬁumeGeomëry.h
"

24 
	~"buf„r.h
"

25 
	~"loggî.h
"

26 
	~"mem‹yAŒoc.h
"

27 
	~"≥rmas£π.h
"

29 
	~"c⁄°™ts.h
"

30 
	~"hódî.h
"

31 
	~"physiˇlLayî.h
"

32 
	~"ªÀa£Vîsi⁄s.h
"

33 
	~"°©usCodes.h
"

34 
	~"su≥rBlock.h
"

35 
	~"ty≥s.h
"

37 íum { 
	mGEOMETRY_BLOCK_LOCATION
 = 0 };

39 c⁄° 
Hódî
 
	gGEOMETRY_BLOCK_HEADER_1_0
 = {

40 .
id
 = 
GEOMETRY_BLOCK
,

41 .
	gvîsi⁄
 = {

42 .
maj‹Vîsi⁄
 = 1,

43 .
	gmö‹Vîsi⁄
 = 0,

46 .
	gsize
 = (
ENCODED_HEADER_SIZE
 + (
Rñó£Vîsi⁄Numbî
)

47 + (
VﬁumeGeomëry
Ë+ (
CRC32Checksum
)),

50 c⁄° 
Hódî
 *
	gCURRENT_GEOMETRY_BLOCK_HEADER


51 &
GEOMETRY_BLOCK_HEADER_1_0
;

54 
Hódî
 
	mhódî
;

55 
Rñó£Vîsi⁄Numbî
 
	mvîsi⁄
;

56 
VﬁumeGeomëry
 
	mgeomëry
;

57 
CRC32Checksum
 
	mchecksum
;

58 } 
	t__©åibuã__
((
	t∑cked
)Ë
	tGeomëryBlock
;

61 
	$lﬂdVﬁumeGeomëry
(
PhysiˇlLayî
 *
œyî
, 
VﬁumeGeomëry
 **
geomëryPå
)

63 
ªsu…
 = 
	`ASSERT
(
œyî
->
ªadî
 !
NULL
, "Layer must haveá syncÑeader");

64 i‡(
ªsu…
 !
VDO_SUCCESS
) {

65  
ªsu…
;

68 *
block
;

69 
ªsu…
 = 
œyî
->
	`ÆloˇãIOBuf„r
÷ayî, 
VDO_BLOCK_SIZE
, "geometry block",

70 &
block
);

71 i‡(
ªsu…
 !
VDO_SUCCESS
) {

72  
ªsu…
;

75 
ªsu…
 = 
œyî
->
	`ªadî
÷ayî, 
GEOMETRY_BLOCK_LOCATION
, 1, 
block
, 
NULL
);

76 i‡(
ªsu…
 !
VDO_SUCCESS
) {

77 
	`FREE
(
block
);

78  
ªsu…
;

81 
GeomëryBlock
 *
geomëryBlock
 = (GeomëryBlock *Ë
block
;

83 
ªsu…
 = 
	`vÆid©eHódî
(
CURRENT_GEOMETRY_BLOCK_HEADER
,

84 &
geomëryBlock
->
hódî
, 
åue
, 
__func__
);

85 i‡(
ªsu…
 !
VDO_SUCCESS
) {

86 
	`FREE
(
block
);

87  
ªsu…
;

91 i‡(
geomëryBlock
->
vîsi⁄
 !
CURRENT_RELEASE_VERSION_NUMBER
) {

92 
	`logEº‹WôhSåögEº‹
(
VDO_UNSUPPORTED_VERSION
,

94 
geomëryBlock
->
vîsi⁄
);

95 
	`FREE
(
block
);

96  
VDO_UNSUPPORTED_VERSION
;

99 
VﬁumeGeomëry
 *
geomëry
;

100 
ªsu…
 = 
	`ALLOCATE
(1, 
VﬁumeGeomëry
, "geomëry", &
geomëry
);

101 i‡(
ªsu…
 !
VDO_SUCCESS
) {

102 
	`FREE
(
block
);

103  
ªsu…
;

106 
	`mem˝y
(
geomëry
, &
geomëryBlock
->geomëry, (
VﬁumeGeomëry
));

108 
size_t
 
checksummedByãs
 = (
GeomëryBlock
Ë- (
CRC32Checksum
);

109 
CRC32Checksum
 
checksum
 = 
œyî
->
	`upd©eCRC32
(
INITIAL_CHECKSUM
,

110 (
byã
 *Ë
block
,

111 
checksummedByãs
);

112 i‡(
checksum
 !
geomëryBlock
->checksum) {

113 
	`FREE
(
geomëry
);

114 
	`FREE
(
block
);

115  
VDO_CHECKSUM_MISMATCH
;

118 *
geomëryPå
 = 
geomëry
;

119 
	`FREE
(
block
);

120  
VDO_SUCCESS
;

121 
	}
}

124 
	$wrôeVﬁumeGeomëry
(
PhysiˇlLayî
 *
œyî
,

125 
N⁄˚
 
n⁄˚
,

126 
BlockCou¡
 
ödexSize
)

128 *
block
;

129 
ªsu…
 = 
œyî
->
	`ÆloˇãIOBuf„r
÷ayî, 
VDO_BLOCK_SIZE
, "geometry block",

130 &
block
);

131 i‡(
ªsu…
 !
VDO_SUCCESS
) {

132  
ªsu…
;

135 
GeomëryBlock
 *
geomëryBlock
 = (GeomëryBlock *Ë
block
;

137 
geomëryBlock
->
hódî
 = *
CURRENT_GEOMETRY_BLOCK_HEADER
;

138 
geomëryBlock
->
vîsi⁄
 = 
CURRENT_RELEASE_VERSION_NUMBER
;

140 
geomëryBlock
->
geomëry
.
n⁄˚
 =Çonce;

141 
geomëryBlock
->
geomëry
.
∑πôi⁄s
[
INDEX_REGION
] = (
VﬁumeP¨tôi⁄
) {

142 .
id
 = 
INDEX_REGION
,

143 .
°¨tBlock
 = 1,

145 
geomëryBlock
->
geomëry
.
∑πôi⁄s
[
DATA_REGION
] = (
VﬁumeP¨tôi⁄
) {

146 .
id
 = 
DATA_REGION
,

147 .
°¨tBlock
 = 1 + 
ödexSize
,

151 
size_t
 
checksummedByãs
 = (
GeomëryBlock
Ë- (
CRC32Checksum
);

152 
geomëryBlock
->
checksum
 = 
œyî
->
	`upd©eCRC32
(
INITIAL_CHECKSUM
,

153 (
byã
 *Ë
block
,

154 
checksummedByãs
);

157 
ªsu…
 = 
œyî
->
	`wrôî
÷ayî, 
GEOMETRY_BLOCK_LOCATION
, 1, 
block
, 
NULL
);

158 
	`FREE
(
block
);

159  
ªsu…
;

160 
	}
}

	@vdo/base/volumeGeometry.h

22 #i‚de‡
VOLUME_GEOMETRY_H


23 
	#VOLUME_GEOMETRY_H


	)

25 
	~"ty≥s.h
"

28 
	mINDEX_REGION
 = 0,

29 
	mDATA_REGION
 = 1,

30 
	mVOLUME_REGION_COUNT
,

31 } 
	tVﬁumeP¨tôi⁄ID
;

35 
VﬁumeP¨tôi⁄ID
 
	mid
;

40 
PhysiˇlBlockNumbî
 
	m°¨tBlock
;

41 } 
	t__©åibuã__
((
	t∑cked
)Ë
	tVﬁumeP¨tôi⁄
;

45 
N⁄˚
 
	mn⁄˚
;

47 
VﬁumeP¨tôi⁄
 
	m∑πôi⁄s
[
VOLUME_REGION_COUNT
];

48 } 
	t__©åibuã__
((
	t∑cked
)Ë
	tVﬁumeGeomëry
;

56 
	$lﬂdVﬁumeGeomëry
(
PhysiˇlLayî
 *
œyî
, 
VﬁumeGeomëry
 **
geomëryPå
)

57 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

68 
	$wrôeVﬁumeGeomëry
(
PhysiˇlLayî
 *
œyî
,

69 
N⁄˚
 
n⁄˚
,

70 
BlockCou¡
 
ödexSize
)

71 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

	@vdo/base/waitQueue.c

22 
	~"waôQueue.h
"

24 
	~"≥rmas£π.h
"

26 
	~"°©usCodes.h
"

29 
	$íqueueWaôî
(
WaôQueue
 *
queue
, 
Waôî
 *
waôî
)

31 
ªsu…
 = 
	`ASSERT
((
waôî
->
√xtWaôî
 =
NULL
),

33 i‡(
ªsu…
 !
VDO_SUCCESS
) {

34  
ªsu…
;

37 i‡(
queue
->
œ°Waôî
 =
NULL
) {

40 
waôî
->
√xtWaôî
 = waiter;

43 
waôî
->
√xtWaôî
 = 
queue
->
œ°Waôî
->nextWaiter;

44 
queue
->
œ°Waôî
->
√xtWaôî
 = 
waôî
;

47 
queue
->
œ°Waôî
 = 
waôî
;

48 
queue
->
queueLígth
 += 1;

49  
VDO_SUCCESS
;

50 
	}
}

53 
	$å™s„rAŒWaôîs
(
WaôQueue
 *
‰omQueue
, WaôQueuê*
toQueue
)

56 i‡(!
	`hasWaôîs
(
‰omQueue
)) {

60 i‡(
	`hasWaôîs
(
toQueue
)) {

63 
Waôî
 *
‰omHód
 = 
‰omQueue
->
œ°Waôî
->
√xtWaôî
;

64 
Waôî
 *
toHód
 = 
toQueue
->
œ°Waôî
->
√xtWaôî
;

65 
toQueue
->
œ°Waôî
->
√xtWaôî
 = 
‰omHód
;

66 
‰omQueue
->
œ°Waôî
->
√xtWaôî
 = 
toHód
;

69 
toQueue
->
œ°Waôî
 = 
‰omQueue
->lastWaiter;

70 
toQueue
->
queueLígth
 +
‰omQueue
->queueLength;

71 
	`öôülizeWaôQueue
(
‰omQueue
);

72 
	}
}

75 
	$nŸifyAŒWaôîs
(
WaôQueue
 *
queue
,

76 
WaôîCÆlback
 *
ˇŒback
,

77 *
c⁄ãxt
)

81 
WaôQueue
 
waôîs
;

82 
	`öôülizeWaôQueue
(&
waôîs
);

83 
	`å™s„rAŒWaôîs
(
queue
, &
waôîs
);

86 
	`nŸifyNextWaôî
(&
waôîs
, 
ˇŒback
, 
c⁄ãxt
)) {

89 
	}
}

92 
Waôî
 *
	$gëFú°Waôî
(c⁄° 
WaôQueue
 *
queue
)

94 
Waôî
 *
œ°Waôî
 = 
queue
->lastWaiter;

95 i‡(
œ°Waôî
 =
NULL
) {

97  
NULL
;

101  
œ°Waôî
->
√xtWaôî
;

102 
	}
}

105 
	$dequeueM©chögWaôîs
(
WaôQueue
 *
queue
,

106 
WaôîM©ch
 *
m©chMëhod
,

107 *
m©chC⁄ãxt
,

108 
WaôQueue
 *
m©chedQueue
)

110 
WaôQueue
 
m©chedWaôîs
;

111 
	`öôülizeWaôQueue
(&
m©chedWaôîs
);

113 
WaôQueue
 
ôî©i⁄Queue
;

114 
	`öôülizeWaôQueue
(&
ôî©i⁄Queue
);

115 
	`å™s„rAŒWaôîs
(
queue
, &
ôî©i⁄Queue
);

116 
	`hasWaôîs
(&
ôî©i⁄Queue
)) {

117 
Waôî
 *
waôî
 = 
	`dequeueNextWaôî
(&
ôî©i⁄Queue
);

118 
ªsu…
 = 
VDO_SUCCESS
;

119 i‡(!
	`m©chMëhod
(
waôî
, 
m©chC⁄ãxt
)) {

120 
ªsu…
 = 
	`íqueueWaôî
(
queue
, 
waôî
);

122 
ªsu…
 = 
	`íqueueWaôî
(&
m©chedWaôîs
, 
waôî
);

124 i‡(
ªsu…
 !
VDO_SUCCESS
) {

125 
	`å™s„rAŒWaôîs
(&
m©chedWaôîs
, 
queue
);

126 
	`å™s„rAŒWaôîs
(&
ôî©i⁄Queue
, 
queue
);

127  
ªsu…
;

131 
	`å™s„rAŒWaôîs
(&
m©chedWaôîs
, 
m©chedQueue
);

132  
VDO_SUCCESS
;

133 
	}
}

136 
Waôî
 *
	$dequeueNextWaôî
(
WaôQueue
 *
queue
)

138 
Waôî
 *
fú°Waôî
 = 
	`gëFú°Waôî
(
queue
);

139 i‡(
fú°Waôî
 =
NULL
) {

140  
NULL
;

143 
Waôî
 *
œ°Waôî
 = 
queue
->lastWaiter;

144 i‡(
fú°Waôî
 =
œ°Waôî
) {

146 
queue
->
œ°Waôî
 = 
NULL
;

150 
œ°Waôî
->
√xtWaôî
 = 
fú°Waôî
->nextWaiter;

154 
fú°Waôî
->
√xtWaôî
 = 
NULL
;

155 
queue
->
queueLígth
 -= 1;

156  
fú°Waôî
;

157 
	}
}

160 
boﬁ
 
	$nŸifyNextWaôî
(
WaôQueue
 *
queue
,

161 
WaôîCÆlback
 *
ˇŒback
,

162 *
c⁄ãxt
)

164 
Waôî
 *
waôî
 = 
	`dequeueNextWaôî
(
queue
);

165 i‡(
waôî
 =
NULL
) {

166  
Ál£
;

169 i‡(
ˇŒback
 =
NULL
) {

170 
ˇŒback
 = 
waôî
->callback;

172 (*
ˇŒback
)(
waôî
, 
c⁄ãxt
);

173  
åue
;

174 
	}
}

177 c⁄° 
Waôî
 *
	$gëNextWaôî
(c⁄° 
WaôQueue
 *
queue
, c⁄° 
Waôî
 *
waôî
)

179 
Waôî
 *
fú°Waôî
 = 
	`gëFú°Waôî
(
queue
);

180 i‡(
waôî
 =
NULL
) {

181  
fú°Waôî
;

183  ((
waôî
->
√xtWaôî
 !
fú°Waôî
Ë? waôî->√xtWaôî : 
NULL
);

184 
	}
}

	@vdo/base/waitQueue.h

22 #i‚de‡
WAIT_QUEUE_H


23 
	#WAIT_QUEUE_H


	)

25 
	~"comm⁄.h
"

44 
waôî
 
	tWaôî
;

48 
Waôî
 *
	mœ°Waôî
;

50 
size_t
 
	mqueueLígth
;

51 } 
	tWaôQueue
;

57 
	tWaôîCÆlback
(
	tWaôî
 *
	twaôî
, *
	tc⁄ãxt
);

64 
boﬁ
 
	tWaôîM©ch
(
	tWaôî
 *
	twaôî
, *
	tc⁄ãxt
);

69 
	swaôî
 {

74 
waôî
 *
	m√xtWaôî
;

77 
WaôîCÆlback
 *
	mˇŒback
;

87 
ölöe
 
boﬁ
 
	$isWaôög
(
Waôî
 *
waôî
)

89  (
waôî
->
√xtWaôî
 !
NULL
);

90 
	}
}

97 
ölöe
 
	$öôülizeWaôQueue
(
WaôQueue
 *
queue
)

99 *
queue
 = (
WaôQueue
) {

100 .
œ°Waôî
 = 
NULL
,

101 .
queueLígth
 = 0,

103 
	}
}

112 
__©åibuã__
((
w¨n_unu£d_ªsu…
))

113 
ölöe
 
boﬁ
 
	$hasWaôîs
(c⁄° 
WaôQueue
 *
queue
)

115  (
queue
->
œ°Waôî
 !
NULL
);

116 
	}
}

127 
	$íqueueWaôî
(
WaôQueue
 *
queue
, 
Waôî
 *
waôî
)

128 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

141 
	`nŸifyAŒWaôîs
(
WaôQueue
 *
queue
,

142 
WaôîCÆlback
 *
ˇŒback
,

143 *
c⁄ãxt
);

156 
boﬁ
 
	`nŸifyNextWaôî
(
WaôQueue
 *
queue
,

157 
WaôîCÆlback
 *
ˇŒback
,

158 *
c⁄ãxt
);

168 
	`å™s„rAŒWaôîs
(
WaôQueue
 *
‰omQueue
, WaôQueuê*
toQueue
);

178 
Waôî
 *
	`gëFú°Waôî
(c⁄° 
WaôQueue
 *
queue
);

191 
	`dequeueM©chögWaôîs
(
WaôQueue
 *
queue
,

192 
WaôîM©ch
 *
m©chMëhod
,

193 *
m©chC⁄ãxt
,

194 
WaôQueue
 *
m©chedQueue
);

206 
Waôî
 *
	`dequeueNextWaôî
(
WaôQueue
 *
queue
);

215 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
))

216 
ölöe
 
size_t
 
	$cou¡Waôîs
(c⁄° 
WaôQueue
 *
queue
)

218  
queue
->
queueLígth
;

219 
	}
}

229 c⁄° 
Waôî
 *
	$gëNextWaôî
(c⁄° 
WaôQueue
 *
queue
, c⁄° 
Waôî
 *
waôî
)

230 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

	@vdo/kernel/batchProcessor.c

22 
	~"b©chPro˚ss‹.h
"

24 
	~"mem‹yAŒoc.h
"

26 
	~"c⁄°™ts.h
"

28 
	~"kî√lLayî.h
"

65 
	eb©chPro˚ss‹Sèã
 {

66 
	mBATCH_PROCESSOR_IDLE
,

67 
	mBATCH_PROCESSOR_ENQUEUED
,

68 } 
	tB©chPro˚ss‹Sèã
;

70 
	sb©chPro˚ss‹
 {

71 
•ölock_t
 
	mc⁄sumîLock
;

72 
Fu¬ñQueue
 *
	mqueue
;

73 
KvdoW‹kIãm
 
	mw‹kIãm
;

74 
©omic_t
 
	m°©e
;

75 
B©chPro˚ss‹CÆlback
 
	mˇŒback
;

76 *
	m˛osuª
;

77 
Kî√lLayî
 *
	mœyî
;

80 
scheduÀB©chPro˚ssög
(
B©chPro˚ss‹
 *
b©ch
);

90 
	$b©chPro˚ss‹W‹k
(
KvdoW‹kIãm
 *
ôem
)

92 
B©chPro˚ss‹
 *
b©ch
 = 
	`c⁄èöî_of
(
ôem
, B©chPro˚ss‹, 
w‹kIãm
);

93 
	`•ö_lock
(&
b©ch
->
c⁄sumîLock
);

94 
	`fu¬ñQueuePìk
(
b©ch
->
queue
Ë!
NULL
) {

95 
b©ch
->
	`ˇŒback
(b©ch, b©ch->
˛osuª
);

97 
	`©omic_£t
(&
b©ch
->
°©e
, 
BATCH_PROCESSOR_IDLE
);

98 
	`mem‹yFí˚
();

99 
boﬁ
 
√edRescheduÀ
 = (
	`fu¬ñQueuePìk
(
b©ch
->
queue
Ë!
NULL
);

100 
	`•ö_u∆ock
(&
b©ch
->
c⁄sumîLock
);

101 i‡(
√edRescheduÀ
) {

102 
	`scheduÀB©chPro˚ssög
(
b©ch
);

104 
	}
}

116 
	$scheduÀB©chPro˚ssög
(
B©chPro˚ss‹
 *
b©ch
)

139 
B©chPro˚ss‹Sèã
 
ﬁdSèã


140 
	`©omic_cmpxchg
(&
b©ch
->
°©e
, 
BATCH_PROCESSOR_IDLE
,

141 
BATCH_PROCESSOR_ENQUEUED
);

142 
boﬁ
 
doScheduÀ
 = (
ﬁdSèã
 =
BATCH_PROCESSOR_IDLE
);

143 i‡(
doScheduÀ
) {

144 
	`íqueueCPUW‹kQueue
(
b©ch
->
œyî
, &b©ch->
w‹kIãm
);

146 
	}
}

149 
	$makeB©chPro˚ss‹
(
Kî√lLayî
 *
œyî
,

150 
B©chPro˚ss‹CÆlback
 
ˇŒback
,

151 *
˛osuª
,

152 
B©chPro˚ss‹
 **
b©chPå
)

154 
B©chPro˚ss‹
 *
b©ch
;

156 
ªsu…
 = 
	`ALLOCATE
(1, 
B©chPro˚ss‹
, "b©chPro˚ss‹", &
b©ch
);

157 i‡(
ªsu…
 !
UDS_SUCCESS
) {

158  
ªsu…
;

160 
ªsu…
 = 
	`makeFu¬ñQueue
(&
b©ch
->
queue
);

161 i‡(
ªsu…
 !
UDS_SUCCESS
) {

162 
	`FREE
(
b©ch
);

163  
ªsu…
;

166 
	`•ö_lock_öô
(&
b©ch
->
c⁄sumîLock
);

167 
	`£tupW‹kIãm
(&
b©ch
->
w‹kIãm
, 
b©chPro˚ss‹W‹k
,

168 (
KvdoW‹kFun˘i⁄
Ë
ˇŒback
, 
CPU_Q_ACTION_COMPLETE_KVIO
);

169 
	`©omic_£t
(&
b©ch
->
°©e
, 
BATCH_PROCESSOR_IDLE
);

170 
b©ch
->
ˇŒback
 = callback;

171 
b©ch
->
˛osuª
 = closure;

172 
b©ch
->
œyî
 =Üayer;

174 *
b©chPå
 = 
b©ch
;

175  
UDS_SUCCESS
;

176 
	}
}

179 
	$addToB©chPro˚ss‹
(
B©chPro˚ss‹
 *
b©ch
, 
KvdoW‹kIãm
 *
ôem
)

181 
	`fu¬ñQueuePut
(
b©ch
->
queue
, &
ôem
->
w‹kQueueE¡ryLök
);

182 
	`scheduÀB©chPro˚ssög
(
b©ch
);

183 
	}
}

186 
KvdoW‹kIãm
 *
	$√xtB©chIãm
(
B©chPro˚ss‹
 *
b©ch
)

188 
Fu¬ñQueueE¡ry
 *
fqE¡ry
 = 
	`fu¬ñQueuePﬁl
(
b©ch
->
queue
);

189 i‡(
fqE¡ry
 =
NULL
) {

190  
NULL
;

193  
	`c⁄èöî_of
(
fqE¡ry
, 
KvdoW‹kIãm
, 
w‹kQueueE¡ryLök
);

194 
	}
}

197 
	$c⁄dReschedB©chPro˚ss‹
(
B©chPro˚ss‹
 *
b©ch
)

199 
	`c⁄d_ªsched_lock
(&
b©ch
->
c⁄sumîLock
);

200 
	}
}

203 
	$‰ìB©chPro˚ss‹
(
B©chPro˚ss‹
 **
b©chPå
)

205 
B©chPro˚ss‹
 *
b©ch
 = *
b©chPå
;

206 i‡(
b©ch
) {

207 
	`mem‹yFí˚
();

208 
	`BUG_ON
(
	`©omic_ªad
(&
b©ch
->
°©e
Ë=
BATCH_PROCESSOR_ENQUEUED
);

209 
	`‰ìFu¬ñQueue
(
b©ch
->
queue
);

210 
	`FREE
(
b©ch
);

211 *
b©chPå
 = 
NULL
;

213 
	}
}

	@vdo/kernel/batchProcessor.h

22 #i‚de‡
BATCHPROCESSOR_H


23 
	#BATCHPROCESSOR_H


	)

25 
	~"fu¬ñQueue.h
"

26 
	~"kî√lTy≥s.h
"

45 
b©chPro˚ss‹
 
	tB©chPro˚ss‹
;

47 (*
	tB©chPro˚ss‹CÆlback
)(
	tB©chPro˚ss‹
 *
	tb©ch
, *
	t˛osuª
);

59 
	`makeB©chPro˚ss‹
(
Kî√lLayî
 *
œyî
,

60 
B©chPro˚ss‹CÆlback
 
ˇŒback
,

61 *
˛osuª
,

62 
B©chPro˚ss‹
 **
b©chPå
);

73 
	`addToB©chPro˚ss‹
(
B©chPro˚ss‹
 *
b©ch
, 
KvdoW‹kIãm
 *
ôem
);

82 
KvdoW‹kIãm
 *
	$√xtB©chIãm
(
B©chPro˚ss‹
 *
b©ch
)

83 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

90 
	`‰ìB©chPro˚ss‹
(
B©chPro˚ss‹
 **
b©chPå
);

101 
	`c⁄dReschedB©chPro˚ss‹
(
B©chPro˚ss‹
 *
b©ch
);

	@vdo/kernel/bio.c

22 
	~"bio.h
"

24 
	~"loggî.h
"

25 
	~"mem‹yAŒoc.h
"

26 
	~"numîic.h
"

28 
	~"Êush.h
"

29 
	~"ªcovîyJou∫Æ.h
"

31 
	~"bioIãøt‹.h
"

32 
	~"ªadCache.h
"

41 *
	$gëBuf„rF‹Biovec
(
bio_vec
 *
biovec
)

43  (
	`∑ge_addªss
(
biovec
->
bv_∑ge
Ë+ biovec->
bv_off£t
);

44 
	}
}

47 
	$bioC›yD©aIn
(
BIO
 *
bio
, *
d©aPå
)

49 
bio_vec
 *
biovec
;

50 
BioIãøt‹
 
ôî
 = 
	`¸óãBioIãøt‹
(
bio
);

51 (
biovec
 = 
	`gëNextBiovec
(&
ôî
)Ë!
NULL
;

52 
	`adv™˚BioIãøt‹
(&
ôî
)) {

53 
	`mem˝y
(
d©aPå
, 
	`gëBuf„rF‹Biovec
(
biovec
), biovec->
bv_Àn
);

54 
d©aPå
 +
biovec
->
bv_Àn
;

56 
	}
}

59 
	$bioC›yD©aOut
(
BIO
 *
bio
, *
d©aPå
)

61 
bio_vec
 *
biovec
;

62 
BioIãøt‹
 
ôî
 = 
	`¸óãBioIãøt‹
(
bio
);

63 (
biovec
 = 
	`gëNextBiovec
(&
ôî
)Ë!
NULL
;

64 
	`adv™˚BioIãøt‹
(&
ôî
)) {

65 
	`mem˝y
(
	`gëBuf„rF‹Biovec
(
biovec
), 
d©aPå
, biovec->
bv_Àn
);

66 
d©aPå
 +
biovec
->
bv_Àn
;

68 
	}
}

71 
	$‰ìBio
(
BIO
 *
bio
, 
Kî√lLayî
 *
œyî
)

73 
	`ªc‹dBioFªe
();

74 #i‡
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(3,7,0)

75 
	`bio_‰ì
(
bio
, 
œyî
->
bio£t
);

77 
	`bio_put
(
bio
);

79 
	}
}

82 
	$cou¡Bios
(
AtomicBioSèts
 *
bioSèts
, 
BIO
 *
bio
)

84 i‡(
	`isWrôeBio
(
bio
)) {

85 
	`©omic64_öc
(&
bioSèts
->
wrôe
);

87 
	`©omic64_öc
(&
bioSèts
->
ªad
);

89 i‡(
	`isDisˇrdBio
(
bio
)) {

90 
	`©omic64_öc
(&
bioSèts
->
disˇrd
);

92 i‡(
	`isFlushBio
(
bio
)) {

93 
	`©omic64_öc
(&
bioSèts
->
Êush
);

95 i‡(
	`isFUABio
(
bio
)) {

96 
	`©omic64_öc
(&
bioSèts
->
fua
);

98 
	}
}

108 
ölöe
 
boﬁ
 
	$isAŒZîos
(c⁄° *
buf„r
, 
Àngth
)

115 i‡(
	`likñy
(
Àngth
 >(
uöt64_t
))) {

116 i‡(
	`GET_UNALIGNED
(
uöt64_t
, 
buf„r
) != 0) {

117  
Ál£
;

120 
w‹dCou¡
 = 
Àngth
 / (
uöt64_t
);

123 
chunkCou¡
 = 
w‹dCou¡
 / 8;

124 
chunkCou¡
-- > 0) {

125 
uöt64_t
 
w‹d0
 = 
	`GET_UNALIGNED
(uöt64_t, 
buf„r
);

126 
uöt64_t
 
w‹d1
 = 
	`GET_UNALIGNED
(uöt64_t, 
buf„r
 + 1 * (uint64_t));

127 
uöt64_t
 
w‹d2
 = 
	`GET_UNALIGNED
(uöt64_t, 
buf„r
 + 2 * (uint64_t));

128 
uöt64_t
 
w‹d3
 = 
	`GET_UNALIGNED
(uöt64_t, 
buf„r
 + 3 * (uint64_t));

129 
uöt64_t
 
w‹d4
 = 
	`GET_UNALIGNED
(uöt64_t, 
buf„r
 + 4 * (uint64_t));

130 
uöt64_t
 
w‹d5
 = 
	`GET_UNALIGNED
(uöt64_t, 
buf„r
 + 5 * (uint64_t));

131 
uöt64_t
 
w‹d6
 = 
	`GET_UNALIGNED
(uöt64_t, 
buf„r
 + 6 * (uint64_t));

132 
uöt64_t
 
w‹d7
 = 
	`GET_UNALIGNED
(uöt64_t, 
buf„r
 + 7 * (uint64_t));

133 
uöt64_t
 
‹
 = (
w‹d0
 | 
w‹d1
 | 
w‹d2
 | 
w‹d3


134 | 
w‹d4
 | 
w‹d5
 | 
w‹d6
 | 
w‹d7
);

136 
__asm__
 
	`__vﬁ©ûe__
 ("" : : "g" (
‹
));

137 i‡(
‹
 != 0) {

138  
Ál£
;

140 
buf„r
 +8 * (
uöt64_t
);

142 
w‹dCou¡
 %= 8;

146 
w‹dCou¡
-- > 0) {

147 i‡(
	`GET_UNALIGNED
(
uöt64_t
, 
buf„r
) != 0) {

148  
Ál£
;

150 
buf„r
 +(
uöt64_t
);

152 
Àngth
 %(
uöt64_t
);

156 
Àngth
-- > 0) {

157 i‡(*
buf„r
++ != 0) {

158  
Ál£
;

161  
åue
;

162 
	}
}

165 
boﬁ
 
	$bioIsZîoD©a
(
BIO
 *
bio
)

167 
bio_vec
 *
biovec
;

168 
BioIãøt‹
 
ôî
 = 
	`¸óãBioIãøt‹
(
bio
);

169 (
biovec
 = 
	`gëNextBiovec
(&
ôî
)Ë!
NULL
;

170 
	`adv™˚BioIãøt‹
(&
ôî
)) {

171 i‡(!
	`isAŒZîos
(
	`gëBuf„rF‹Biovec
(
biovec
), biovec->
bv_Àn
)) {

172  
Ál£
;

175  
åue
;

176 
	}
}

179 
	$bioZîoD©a
(
BIO
 *
bio
)

195 
bio_vec
 *
biovec
;

196 
BioIãøt‹
 
ôî
 = 
	`¸óãBioIãøt‹
(
bio
);

197 (
biovec
 = 
	`gëNextBiovec
(&
ôî
)Ë!
NULL
;

198 
	`adv™˚BioIãøt‹
(&
ôî
)) {

199 
	`mem£t
(
	`gëBuf„rF‹Biovec
(
biovec
), 0, biovec->
bv_Àn
);

201 
	}
}

203 
	$£tBioSize
(
BIO
 *
bio
, 
BlockSize
 
bioSize
)

205 #ifde‡
USE_BI_ITER


206 
bio
->
bi_ôî
.
bi_size
 = 
bioSize
;

208 
bio
->
bi_size
 = 
bioSize
;

210 
	}
}

218 
	$öôülizeBio
(
BIO
 *
bio
, 
Kî√lLayî
 *
œyî
)

220 #i‡
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(3,7,0)

221 
bio
->
bi_de°ru˘‹
 = 
NULL
;

222 
bio
->
bi_Êags
 = 1 << 
BIO_UPTODATE
;

223 
bio
->
bi_idx
 = 0;

224 
bio
->
bi_rw
 = 0;

227 
v˙t
 = 
bio
->
bi_v˙t
;

228 *
pvt
 = 
bio
->
bi_¥iv©e
;

229 
	`bio_ª£t
(
bio
);

230 
bio
->
bi_¥iv©e
 = 
pvt
;

231 
bio
->
bi_v˙t
 = 
v˙t
;

233 
bio
->
bi_íd_io
 = 
com∂ëeAsyncBio
;

234 
	`£tBioSe˘‹
(
bio
, (
£˘‹_t
) -1);

235 
	`£tBioBlockDevi˚
(
bio
, 
œyî
->
dev
->
bdev
);

236 
	}
}

239 
	$ª£tBio
(
BIO
 *
bio
, 
Kî√lLayî
 *
œyî
)

241 
	`öôülizeBio
(
bio
, 
œyî
);

242 
	`£tBioSize
(
bio
, 
VDO_BLOCK_SIZE
);

243 
	}
}

246 
	$ÆloˇãBio
(
Kî√lLayî
 *
œyî
, 
bvecCou¡
, 
BIO
 **
bioPå
)

248 
BIO
 *
bio
 = 
	`bio_Æloc_bio£t
(
GFP_NOIO
, 
bvecCou¡
, 
œyî
->
bio£t
);

249 i‡(
	`IS_ERR
(
bio
)) {

250 
	`logEº‹
("biÿÆloˇti⁄ faûuª %ld", 
	`PTR_ERR
(
bio
));

251  
	`PTR_ERR
(
bio
);

253 
	`ªc‹dBioAŒoc
();

255 
	`öôülizeBio
(
bio
, 
œyî
);

257 *
bioPå
 = 
bio
;

258  
VDO_SUCCESS
;

259 
	}
}

262 
	$¸óãBio
(
Kî√lLayî
 *
œyî
, *
d©a
, 
BIO
 **
bioPå
)

264 
BIO
 *
bio
 = 
NULL
;

265 i‡(
d©a
 =
NULL
) {

266 
ªsu…
 = 
	`ÆloˇãBio
(
œyî
, 0, &
bio
);

267 i‡(
ªsu…
 !
VDO_SUCCESS
) {

268  
ªsu…
;

271 *
bioPå
 = 
bio
;

272  
VDO_SUCCESS
;

275 
Àn
 = 
VDO_BLOCK_SIZE
;

276 
kaddr
 = (Ë
d©a
;

277 
íd
 = (
kaddr
 + 
Àn
 + 
PAGE_SIZE
 - 1Ë>> 
PAGE_SHIFT
;

278 
°¨t
 = 
kaddr
 >> 
PAGE_SHIFT
;

279 c⁄° 
bvecCou¡
 = 
íd
 - 
°¨t
;

281 
ªsu…
 = 
	`ÆloˇãBio
(
œyî
, 
bvecCou¡
, &
bio
);

282 i‡(
ªsu…
 !
VDO_SUCCESS
) {

283  
ªsu…
;

286 
off£t
 = 
	`off£t_ö_∑ge
(
kaddr
);

287 
i
 = 0; (ò< 
bvecCou¡
Ë&& (
Àn
 > 0); i++) {

288 
byãs
 = 
PAGE_SIZE
 - 
off£t
;

289 i‡(
byãs
 > 
Àn
) {

290 
byãs
 = 
Àn
;

293 
∑ge
 *page

294 
	`is_vmÆloc_addr
(
d©a
Ë? 
	`vmÆloc_to_∑ge
(d©aË: 
	`vút_to_∑ge
(data);

295 
byãsAdded
 = 
	`bio_add_∑ge
(
bio
, 
∑ge
, 
byãs
, 
off£t
);

296 i‡(
byãsAdded
 !
byãs
) {

297 
	`‰ìBio
(
bio
, 
œyî
);

298  
	`logEº‹WôhSåögEº‹
(
VDO_BIO_CREATION_FAILED
,

300 
byãsAdded
);

304 
d©a
 +
byãs
;

305 
Àn
 -
byãs
;

306 
off£t
 = 0;

309 *
bioPå
 = 
bio
;

310  
VDO_SUCCESS
;

311 
	}
}

314 
	$¥ï¨eFlushBIO
(
BIO
 *
bio
,

315 *
c⁄ãxt
,

316 
block_devi˚
 *
devi˚
,

317 
bio_íd_io_t
 *
ídIOCÆlback
)

319 #i‡
LINUX_VERSION_CODE
 >
	`KERNEL_VERSION
(4,10,0)

320 
	`bio_£t_›_©ås
(
bio
, 0, 
REQ_PREFLUSH
);

321 #ñi‡
LINUX_VERSION_CODE
 >
	`KERNEL_VERSION
(4,8,0)

322 
bio
->
bi_›f
 = 
WRITE_FLUSH
;

324 
bio
->
bi_rw
 = 
WRITE_FLUSH
;

327 
bio
->
bi_íd_io
 = 
ídIOCÆlback
;

328 
bio
->
bi_¥iv©e
 = 
c⁄ãxt
;

329 
bio
->
bi_v˙t
 = 0;

330 
	`£tBioBlockDevi˚
(
bio
, 
devi˚
);

331 
	`£tBioSize
(
bio
, 0);

332 
	`£tBioSe˘‹
(
bio
, 0);

333 
	}
}

	@vdo/kernel/bio.h

22 #i‚de‡
BIO_H


23 
	#BIO_H


	)

25 
	~<löux/bio.h
>

26 
	~<löux/vîsi⁄.h
>

28 
	~"kî√lTy≥s.h
"

30 #i‡
LINUX_VERSION_CODE
 >
KERNEL_VERSION
(3,14,0)

31 
	#USE_BI_ITER
 1

	)

40 
bioC›yD©aIn
(
BIO
 *
bio
, *
d©aPå
);

48 
bioC›yD©aOut
(
BIO
 *
bio
, *
d©aPå
);

51 
ölöe
 
	$bioDisˇrdRWMask
()

53 #i‡
LINUX_VERSION_CODE
 =
	`KERNEL_VERSION
(2,6,32)

54  
BIO_DISCARD
;

55 #ñi‡
LINUX_VERSION_CODE
 >
	`KERNEL_VERSION
(4,8,0)

56  
REQ_OP_DISCARD
;

58  
REQ_DISCARD
;

60 
	}
}

63 
ölöe
 
	$bioFuaRWMask
()

65 #i‡
LINUX_VERSION_CODE
 =
	`KERNEL_VERSION
(2,6,32)

66  
BIO_FUA
;

68  
REQ_FUA
;

70 
	}
}

73 
ölöe
 
	$bioSyncIoRWMask
()

75 #i‡
LINUX_VERSION_CODE
 =
	`KERNEL_VERSION
(2,6,32)

76  1 << 
BIO_RW_SYNCIO
;

78  
REQ_SYNC
;

80 
	}
}

83 
ölöe
 
boﬁ
 
	$isDisˇrdBio
(
BIO
 *
bio
)

85 #i‡
LINUX_VERSION_CODE
 =
	`KERNEL_VERSION
(2,6,32)

86  (
bio
 !
NULL
Ë&& 
	`bio_rw_Êagged
(bio, 
BIO_RW_DISCARD
);

87 #ñi‡
LINUX_VERSION_CODE
 >
	`KERNEL_VERSION
(4,8,0)

88  (
bio
 !
NULL
Ë&& (
	`bio_›
(bioË=
REQ_OP_DISCARD
);

90  (
bio
 !
NULL
Ë&& ((bio->
bi_rw
 & 
REQ_DISCARD
) != 0);

92 
	}
}

95 
ölöe
 
boﬁ
 
	$isFlushBio
(
BIO
 *
bio
)

97 #i‡
LINUX_VERSION_CODE
 =
	`KERNEL_VERSION
(2,6,32)

98  
	`bio_rw_Êagged
(
bio
, 
BIO_RW_FLUSH
);

99 #ñi‡
LINUX_VERSION_CODE
 >
	`KERNEL_VERSION
(4,8,0)

100  (
bio
->
bi_›f
 & 
REQ_OP_FLUSH
) != 0;

102  (
bio
->
bi_rw
 & 
REQ_FLUSH
) != 0;

104 
	}
}

107 
ölöe
 
boﬁ
 
	$isFUABio
(
BIO
 *
bio
)

109 #i‡
LINUX_VERSION_CODE
 =
	`KERNEL_VERSION
(2,6,32)

110  
	`bio_rw_Êagged
(
bio
, 
BIO_RW_FUA
);

111 #ñi‡
LINUX_VERSION_CODE
 >
	`KERNEL_VERSION
(4,8,0)

112  (
bio
->
bi_›f
 & 
REQ_FUA
) != 0;

114  (
bio
->
bi_rw
 & 
REQ_FUA
) != 0;

116 
	}
}

119 
ölöe
 
boﬁ
 
	$isRódBio
(
BIO
 *
bio
)

122 #i‡
LINUX_VERSION_CODE
 =
	`KERNEL_VERSION
(2,6,32)

123  !
	`bio_rw_Êagged
(
bio
, 
BIO_RW
);

124 #ñi‡
LINUX_VERSION_CODE
 >
	`KERNEL_VERSION
(4,8,0)

125  (
	`›_is_wrôe
(
	`bio_›
(
bio
))) == 0;

127  (
bio
->
bi_rw
 & 
REQ_WRITE
) == 0;

129 
	}
}

132 
ölöe
 
boﬁ
 
	$isEm±yFlush
(
BIO
 *
bio
)

134 #i‡
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(2,6,37)

135  
	`bio_em±y_b¨rõr
(
bio
Ë|| 
	`bio_rw_Êagged
(bio, 
BIO_RW_FLUSH
);

136 #ñi‡
LINUX_VERSION_CODE
 >
	`KERNEL_VERSION
(4,8,0)

137  (
bio
->
bi_›f
 & 
REQ_OP_FLUSH
) != 0;

139  (
bio
->
bi_rw
 & 
REQ_FLUSH
) != 0;

141 
	}
}

144 
ölöe
 
boﬁ
 
	$isWrôeBio
(
BIO
 *
bio
)

146 #i‡
LINUX_VERSION_CODE
 =
	`KERNEL_VERSION
(2,6,32)

147  
	`bio_rw_Êagged
(
bio
, 
BIO_RW
);

148 #ñi‡
LINUX_VERSION_CODE
 >
	`KERNEL_VERSION
(4,8,0)

149  (
	`›_is_wrôe
(
	`bio_›
(
bio
))) != 0;

151  (
bio
->
bi_rw
 & 
REQ_WRITE
) != 0;

153 
	}
}

161 
ölöe
 
	$£tBioBlockDevi˚
(
BIO
 *
bio
, 
block_devi˚
 *
devi˚
)

163 
bio
->
bi_bdev
 = 
devi˚
;

164 
	}
}

173 
ölöe
 
	$gëBioSize
(
BIO
 *
bio
)

175 #ifde‡
USE_BI_ITER


176  
bio
->
bi_ôî
.
bi_size
;

178  
bio
->
bi_size
;

180 
	}
}

188 
ölöe
 
	$£tBioSe˘‹
(
BIO
 *
bio
, 
£˘‹_t
 
£˘‹
)

190 #ifde‡
USE_BI_ITER


191 
bio
->
bi_ôî
.
bi_£˘‹
 = 
£˘‹
;

193 
bio
->
bi_£˘‹
 = 
£˘‹
;

195 
	}
}

204 
ölöe
 
£˘‹_t
 
	$gëBioSe˘‹
(
BIO
 *
bio
)

206 #ifde‡
USE_BI_ITER


207  
bio
->
bi_ôî
.
bi_£˘‹
;

209  
bio
->
bi_£˘‹
;

211 
	}
}

219 
ölöe
 
	$com∂ëeBio
(
BIO
 *
bio
, 
îr‹
)

221 #i‡
LINUX_VERSION_CODE
 >
	`KERNEL_VERSION
(4,13,0)

222 
bio
->
bi_°©us
 = 
îr‹
;

223 
	`bio_ídio
(
bio
);

224 #ñi‡
LINUX_VERSION_CODE
 >
	`KERNEL_VERSION
(4,4,0)

225 
bio
->
bi_îr‹
 = 
îr‹
;

226 
	`bio_ídio
(
bio
);

228 
	`bio_ídio
(
bio
, 
îr‹
);

230 
	}
}

238 
‰ìBio
(
BIO
 *
bio
, 
Kî√lLayî
 *
œyî
);

247 
cou¡Bios
(
AtomicBioSèts
 *
bioSèts
, 
BIO
 *
bio
);

255 
ª£tBio
(
BIO
 *
bio
, 
Kî√lLayî
 *
œyî
);

264 
boﬁ
 
bioIsZîoD©a
(
BIO
 *
bio
);

271 
bioZîoD©a
(
BIO
 *
bio
);

282 
¸óãBio
(
Kî√lLayî
 *
œyî
, *
d©a
, 
BIO
 **
bioPå
);

292 
¥ï¨eFlushBIO
(
BIO
 *
bio
,

293 *
c⁄ãxt
,

294 
block_devi˚
 *
devi˚
,

295 
bio_íd_io_t
 *
ídIOCÆlback
);

	@vdo/kernel/bioIterator.h

22 #i‚de‡
BIO_ITERATOR_H


23 
	#BIO_ITERATOR_H


	)

25 
	~<löux/bio.h
>

27 
	~"bio.h
"

28 
	~"kî√lTy≥s.h
"

31 
BIO
 *
	mbio
;

32 #ifde‡
USE_BI_ITER


33 
bvec_ôî
 
	môî
;

35 
bio_vec
 
	mãmp
;

37 
	mödex
;

39 } 
	tBioIãøt‹
;

48 
BioIãøt‹
 
	$¸óãBioIãøt‹
(
BIO
 *
bio
)

50 
BioIãøt‹
 
ôî©‹
 = {

51 .
bio
 = bio,

52 #ifde‡
USE_BI_ITER


53 .
ôî
 = 
bio
->
bi_ôî
,

55 .
ödex
 = 
bio
->
bi_idx
,

58  
ôî©‹
;

59 
	}
}

68 
bio_vec
 *
	$gëNextBiovec
(
BioIãøt‹
 *
ôî©‹
)

70 
BIO
 *
bio
 = 
ôî©‹
->bio;

71 #ifde‡
USE_BI_ITER


72 i‡(
ôî©‹
->
ôî
.
bi_size
 == 0) {

73  
NULL
;

76 
ôî©‹
->
ãmp
 = 
	`bio_ôî_iovec
(
bio
, iãøt‹->
ôî
);

77  &
ôî©‹
->
ãmp
;

79 i‡(
ôî©‹
->
ödex
 >
bio
->
bi_v˙t
) {

80  
NULL
;

82  
	`bio_iovec_idx
(
bio
, 
ôî©‹
->
ödex
);

84 
	}
}

91 
	$adv™˚BioIãøt‹
(
BioIãøt‹
 *
ôî©‹
)

93 #ifde‡
USE_BI_ITER


94 
	`bio_adv™˚_ôî
(
ôî©‹
->
bio
, &ôî©‹->
ôî
, iãøt‹->
ãmp
.
bv_Àn
);

96 
ôî©‹
->
ödex
++;

98 
	}
}

	@vdo/kernel/bufferPool.c

22 
	~"buf„rPoﬁ.h
"

24 
	~<löux/dñay.h
>

25 
	~<löux/s‹t.h
>

27 
	~"loggî.h
"

28 
	~"mem‹yAŒoc.h
"

30 
	~"°©usCodes.h
"

43 
li°_hód
 
	mli°
;

44 *
	md©a
;

45 } 
	tBuf„rEÀmít
;

47 
	sbuf„rPoﬁ
 {

48 c⁄° *
	m«me
;

49 *
	md©a
;

50 
•ölock_t
 
	mlock
;

51 
	msize
;

52 
li°_hód
 
	m‰ìObje˘Li°
;

53 
li°_hód
 
	m•¨eLi°Nodes
;

54 
	mnumBusy
;

55 
	mmaxBusy
;

56 
Buf„rAŒoˇãFun˘i⁄
 *
	mÆloc
;

57 
Buf„rFªeFun˘i⁄
 *
	m‰ì
;

58 
Buf„rDumpFun˘i⁄
 *
	mdump
;

59 
Buf„rEÀmít
 *
	mbhód
;

60 **
	mobje˘s
;

64 
	$makeBuf„rPoﬁ
(c⁄° *
poﬁName
,

65 
size
,

66 
Buf„rAŒoˇãFun˘i⁄
 *
ÆloˇãFun˘i⁄
,

67 
Buf„rFªeFun˘i⁄
 *
‰ìFun˘i⁄
,

68 
Buf„rDumpFun˘i⁄
 *
dumpFun˘i⁄
,

69 *
poﬁD©a
,

70 
Buf„rPoﬁ
 **
poﬁPå
)

72 
Buf„rPoﬁ
 *
poﬁ
;

74 
ªsu…
 = 
	`ALLOCATE
(1, 
Buf„rPoﬁ
, "buf„∏poﬁ", &
poﬁ
);

75 i‡(
ªsu…
 !
VDO_SUCCESS
) {

76 
	`logEº‹
("buf„∏poﬁáŒoˇti⁄ faûuª %d", 
ªsu…
);

77  
ªsu…
;

80 
ªsu…
 = 
	`ALLOCATE
(
size
, 
Buf„rEÀmít
, "buf„∏poﬁÉÀmíts", &
poﬁ
->
bhód
);

81 i‡(
ªsu…
 !
VDO_SUCCESS
) {

82 
	`logEº‹
("buf„∏ñemíà¨øyáŒoˇti⁄ faûuª %d", 
ªsu…
);

83 
	`‰ìBuf„rPoﬁ
(&
poﬁ
);

84  
ªsu…
;

87 
ªsu…
 = 
	`ALLOCATE
(
size
, *, "obje˘Öoöãrs", &
poﬁ
->
obje˘s
);

88 i‡(
ªsu…
 !
VDO_SUCCESS
) {

89 
	`logEº‹
("buf„∏obje˘áºayáŒoˇti⁄ faûuª %d", 
ªsu…
);

90 
	`‰ìBuf„rPoﬁ
(&
poﬁ
);

91  
ªsu…
;

94 
poﬁ
->
«me
 = 
poﬁName
;

95 
poﬁ
->
Æloc
 = 
ÆloˇãFun˘i⁄
;

96 
poﬁ
->
‰ì
 = 
‰ìFun˘i⁄
;

97 
poﬁ
->
dump
 = 
dumpFun˘i⁄
;

98 
poﬁ
->
d©a
 = 
poﬁD©a
;

99 
poﬁ
->
size
 = size;

100 
	`•ö_lock_öô
(&
poﬁ
->
lock
);

101 
	`INIT_LIST_HEAD
(&
poﬁ
->
‰ìObje˘Li°
);

102 
	`INIT_LIST_HEAD
(&
poﬁ
->
•¨eLi°Nodes
);

103 
Buf„rEÀmít
 *
bh
 = 
poﬁ
->
bhód
;

104 
i
 = 0; i < 
poﬁ
->
size
; i++) {

105 
ªsu…
 = 
poﬁ
->
	`Æloc
’oﬁ->
d©a
, &
bh
->data);

106 i‡(
ªsu…
 !
VDO_SUCCESS
) {

107 
	`logEº‹
("vîify buf„∏d©®Æloˇti⁄ faûuª %d", 
ªsu…
);

108 
	`‰ìBuf„rPoﬁ
(&
poﬁ
);

109  
ªsu…
;

111 
poﬁ
->
obje˘s
[
i
] = 
bh
->
d©a
;

112 
	`li°_add
(&
bh
->
li°
, &
poﬁ
->
‰ìObje˘Li°
);

113 
bh
++;

115 
poﬁ
->
numBusy
 =Öoﬁ->
maxBusy
 = 0;

117 *
poﬁPå
 = 
poﬁ
;

118  
VDO_SUCCESS
;

119 
	}
}

122 
	$‰ìBuf„rPoﬁ
(
Buf„rPoﬁ
 **
poﬁPå
)

124 
Buf„rPoﬁ
 *
poﬁ
 = *
poﬁPå
;

125 i‡(
poﬁ
 =
NULL
) {

129 
	`ASSERT_LOG_ONLY
((
poﬁ
->
numBusy
 == 0), "freeing busy bufferÖool,ÇumBusy=%d",

130 
poﬁ
->
numBusy
);

131 i‡(
poﬁ
->
obje˘s
 !
NULL
) {

132 
i
 = 0; i < 
poﬁ
->
size
; i++) {

133 i‡(
poﬁ
->
obje˘s
[
i
] !
NULL
) {

134 
poﬁ
->
	`‰ì
’oﬁ->
d©a
,Öoﬁ->
obje˘s
[
i
]);

137 
	`FREE
(
poﬁ
->
obje˘s
);

139 
	`FREE
(
poﬁ
->
bhód
);

140 
	`FREE
(
poﬁ
);

141 *
poﬁPå
 = 
NULL
;

142 
	}
}

145 
boﬁ
 
	$öFªeLi°
(
Buf„rPoﬁ
 *
poﬁ
, *
d©a
)

147 
li°_hód
 *
node
;

148 
	`li°_f‹_óch
(
node
, &
poﬁ
->
‰ìObje˘Li°
) {

149 i‡(
	`c⁄èöî_of
(
node
, 
Buf„rEÀmít
, 
li°
)->
d©a
 == data) {

150  
åue
;

153  
Ál£
;

154 
	}
}

157 
	$dumpBuf„rPoﬁ
(
Buf„rPoﬁ
 *
poﬁ
, 
boﬁ
 
dumpEÀmíts
)

162 íum { 
ELEMENTS_PER_BATCH
 = 35 };

163 íum { 
SLEEP_FOR_SYSLOG
 = 4 };

165 i‡(
poﬁ
 =
NULL
) {

168 
	`•ö_lock
(&
poﬁ
->
lock
);

169 
	`logInfo
("%s: %u o‡%u busy (max %u)", 
poﬁ
->
«me
,Öoﬁ->
numBusy
,Öoﬁ->
size
,

170 
poﬁ
->
maxBusy
);

171 i‡(
dumpEÀmíts
 && (
poﬁ
->
dump
 !
NULL
)) {

172 
dum≥d
 = 0;

173 
i
 = 0; i < 
poﬁ
->
size
; i++) {

174 i‡(!
	`öFªeLi°
(
poﬁ
,Öoﬁ->
obje˘s
[
i
])) {

175 
poﬁ
->
	`dump
’oﬁ->
d©a
,Öoﬁ->
obje˘s
[
i
]);

176 i‡(++
dum≥d
 >
ELEMENTS_PER_BATCH
) {

177 
	`•ö_u∆ock
(&
poﬁ
->
lock
);

178 
dum≥d
 = 0;

179 
	`m¶ìp
(
SLEEP_FOR_SYSLOG
);

180 
	`•ö_lock
(&
poﬁ
->
lock
);

185 
	`•ö_u∆ock
(&
poﬁ
->
lock
);

186 
	}
}

189 
	$ÆlocBuf„rFromPoﬁ
(
Buf„rPoﬁ
 *
poﬁ
, **
d©aPå
)

191 i‡(
poﬁ
 =
NULL
) {

192  
UDS_INVALID_ARGUMENT
;

195 
	`•ö_lock
(&
poﬁ
->
lock
);

196 i‡(
	`u∆ikñy
(
	`li°_em±y
(&
poﬁ
->
‰ìObje˘Li°
))) {

197 
	`•ö_u∆ock
(&
poﬁ
->
lock
);

198 
	`logDebug
("no free buffers");

199  -
ENOMEM
;

202 
Buf„rEÀmít
 *
bh
 = 
	`li°_fú°_íåy
(&
poﬁ
->
‰ìObje˘Li°
, BufferElement,

203 
li°
);

204 
	`li°_move
(&
bh
->
li°
, &
poﬁ
->
•¨eLi°Nodes
);

205 
poﬁ
->
numBusy
++;

206 i‡(
poﬁ
->
numBusy
 >Öoﬁ->
maxBusy
) {

207 
poﬁ
->
maxBusy
 =Öoﬁ->
numBusy
;

209 *
d©aPå
 = 
bh
->
d©a
;

210 
	`•ö_u∆ock
(&
poﬁ
->
lock
);

211  
VDO_SUCCESS
;

213 
	}
}

216 
boﬁ
 
	$‰ìBuf„rToPoﬁI¡î«l
(
Buf„rPoﬁ
 *
poﬁ
, *
d©a
)

218 i‡(
	`u∆ikñy
(
	`li°_em±y
(&
poﬁ
->
•¨eLi°Nodes
))) {

219  
Ál£
;

221 
Buf„rEÀmít
 *
bh
 = 
	`li°_fú°_íåy
(&
poﬁ
->
•¨eLi°Nodes
, BufferElement,

222 
li°
);

223 
	`li°_move
(&
bh
->
li°
, &
poﬁ
->
‰ìObje˘Li°
);

224 
bh
->
d©a
 = data;

225 
poﬁ
->
numBusy
--;

226  
åue
;

227 
	}
}

230 
	$‰ìBuf„rToPoﬁ
(
Buf„rPoﬁ
 *
poﬁ
, *
d©a
)

232 
	`•ö_lock
(&
poﬁ
->
lock
);

233 
boﬁ
 
suc˚ss
 = 
	`‰ìBuf„rToPoﬁI¡î«l
(
poﬁ
, 
d©a
);

234 
	`•ö_u∆ock
(&
poﬁ
->
lock
);

235 i‡(!
suc˚ss
) {

236 
	`logDebug
("tryingÅoáddÅo freeÜist whenálready full");

238 
	}
}

241 
	$‰ìBuf„rsToPoﬁ
(
Buf„rPoﬁ
 *
poﬁ
, **
d©a
, 
cou¡
)

243 
	`•ö_lock
(&
poﬁ
->
lock
);

244 
boﬁ
 
suc˚ss
 = 
åue
;

245 
i
 = 0; (ò< 
cou¡
Ë&& 
suc˚ss
; i++) {

246 
suc˚ss
 = 
	`‰ìBuf„rToPoﬁI¡î«l
(
poﬁ
, 
d©a
[
i
]);

248 
	`•ö_u∆ock
(&
poﬁ
->
lock
);

249 i‡(!
suc˚ss
) {

250 
	`logDebug
("tryingÅoáddÅo freeÜist whenálready full");

252 
	}
}

	@vdo/kernel/bufferPool.h

21 #i‚de‡
BUFFERPOOL_H


22 
	#BUFFERPOOL_H


	)

30 
	~<löux/bug.h
>

31 
	~<löux/kî√l.h
>

32 
	~<löux/ty≥s.h
>

34 
buf„rPoﬁ
 
	tBuf„rPoﬁ
;

36 
	tBuf„rAŒoˇãFun˘i⁄
(*
	tpoﬁD©a
, **
	td©aPå
);

37 
	tBuf„rFªeFun˘i⁄
(*
	tpoﬁD©a
, *
	td©a
);

38 
	tBuf„rDumpFun˘i⁄
(*
	tpoﬁD©a
, *
	td©a
);

58 
	$makeBuf„rPoﬁ
(c⁄° *
poﬁName
,

59 
size
,

60 
Buf„rAŒoˇãFun˘i⁄
 *
ÆloˇãFun˘i⁄
,

61 
Buf„rFªeFun˘i⁄
 *
‰ìFun˘i⁄
,

62 
Buf„rDumpFun˘i⁄
 *
dumpFun˘i⁄
,

63 *
poﬁD©a
,

64 
Buf„rPoﬁ
 **
poﬁPå
)

65 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

73 
	`‰ìBuf„rPoﬁ
(
Buf„rPoﬁ
 **
poﬁPå
);

82 
	`dumpBuf„rPoﬁ
(
Buf„rPoﬁ
 *
poﬁ
, 
boﬁ
 
dumpEÀmíts
);

93 
	$ÆlocBuf„rFromPoﬁ
(
Buf„rPoﬁ
 *
poﬁ
, **
d©aPå
)

94 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

102 
	`‰ìBuf„rToPoﬁ
(
Buf„rPoﬁ
 *
poﬁ
, *
d©a
);

111 
	`‰ìBuf„rsToPoﬁ
(
Buf„rPoﬁ
 *
poﬁ
, **
d©a
, 
cou¡
);

128 
	s‰ìBuf„rPoöãrs
 {

129 
Buf„rPoﬁ
 *
poﬁ
;

130 
ödex
;

131 *
poöãrs
[30];

132 } 
	tFªeBuf„rPoöãrs
;

141 
ölöe
 
	$öôFªeBuf„rPoöãrs
(
FªeBuf„rPoöãrs
 *
fbp
,

142 
Buf„rPoﬁ
 *
poﬁ
)

144 
fbp
->
ödex
 = 0;

145 
fbp
->
poﬁ
 =Öool;

146 
	}
}

153 
ölöe
 
	$‰ìBuf„rPoöãrs
(
FªeBuf„rPoöãrs
 *
fbp
)

155 
	`‰ìBuf„rsToPoﬁ
(
fbp
->
poﬁ
, fbp->
poöãrs
, fbp->
ödex
);

156 
fbp
->
ödex
 = 0;

157 
	}
}

166 
ölöe
 
	$addFªeBuf„rPoöãr
(
FªeBuf„rPoöãrs
 *
fbp
,

167 *
poöãr
)

169 
fbp
->
poöãrs
[fbp->
ödex
] = 
poöãr
;

170 
fbp
->
ödex
++;

171 i‡(
fbp
->
ödex
 =
	`ARRAY_SIZE
(fbp->
poöãrs
)) {

172 
	`‰ìBuf„rPoöãrs
(
fbp
);

174 
	}
}

	@vdo/kernel/dataKVIO.c

22 
	~"d©aKVIO.h
"

24 
	~"loggî.h
"

25 
	~"mem‹yAŒoc.h
"

27 
	~"d©aVIO.h
"

28 
	~"lz4.h
"

29 
	~"murmur/MurmurHash3.h
"

31 
	~"bio.h
"

32 
	~"dedu≥Index.h
"

33 
	~"kvdoFlush.h
"

34 
	~"kvio.h
"

35 
	~"ªadCache.h
"

36 
	~"vdoComm⁄.h
"

37 
	~"vîify.h
"

39 
dumpPoﬁedD©aKVIO
(*
poﬁD©a
, *
d©a
);

42 
	mWRITE_PROTECT_FREE_POOL
 = 0,

43 
	mWP_DATA_KVIO_SIZE
 = ((
D©aKVIO
Ë+ 
PAGE_SIZE
 - 1

44 - (((
D©aKVIO
Ë+ 
PAGE_SIZE
 - 1)

45 % 
PAGE_SIZE
))

60 
__Æways_ölöe
 

61 
£tWrôePrŸe˘
(*
addªss
,

62 
size_t
 
byãCou¡
,

63 
boﬁ
 
mode
 
__©åibuã__
((
unu£d
)))

65 
BUG_ON
((((Ë
addªss
Ë% 
PAGE_SIZE
) != 0);

66 
BUG_ON
((
byãCou¡
 % 
PAGE_SIZE
) != 0);

67 
BUG
();

71 
	$maybeLogD©aKVIOTø˚
(
D©aKVIO
 *
d©aKVIO
)

73 i‡(
d©aKVIO
->
kvio
.
œyî
->
åa˚Loggög
) {

74 
	`logKvioTø˚
(&
d©aKVIO
->
kvio
);

76 
	}
}

87 
	$kvioCom∂ëi⁄T≠1
(
D©aKVIO
 *
d©aKVIO
)

95 
__asm__
 
	`__vﬁ©ûe__
("n›" : : "g" (
d©aKVIO
), "g" (
ba£Tø˚Loˇti⁄
));

96 
	}
}

107 
	$kvioCom∂ëi⁄T≠2
(
D©aKVIO
 *
d©aKVIO
)

110 
__asm__
 
	`__vﬁ©ûe__
("n›" : : "g" (
d©aKVIO
));

111 
	}
}

114 
	$kvdoAcknowÀdgeD©aKVIO
(
D©aKVIO
 *
d©aKVIO
)

116 
Kî√lLayî
 *
œyî
 = 
d©aKVIO
->
kvio
.layer;

117 
Exã∫ÆIOReque°
 *
exã∫ÆIOReque°
 = &
d©aKVIO
->externalIORequest;

118 
BIO
 *
bio
 = 
exã∫ÆIOReque°
->bio;

119 i‡(
bio
 =
NULL
) {

123 
exã∫ÆIOReque°
->
bio
 = 
NULL
;

125 
îr‹


126 
	`m≠ToSy°emEº‹
(
	`d©aVIOAsCom∂ëi⁄
(&
d©aKVIO
->
d©aVIO
)->
ªsu…
);

127 #i‡
LINUX_VERSION_CODE
 >
	`KERNEL_VERSION
(4,8,0)

128 
bio
->
bi_›f
 = 
exã∫ÆIOReque°
->
rw
;

130 
bio
->
bi_rw
 = 
exã∫ÆIOReque°
->
rw
;

132 i‡(
	`isFUABio
(
bio
Ë&& (
îr‹
 =0Ë&& 
	`shouldPro˚ssFlush
(
œyî
)) {

135 
	`¥ï¨eFlushBIO
(
bio
, 
exã∫ÆIOReque°
->
¥iv©e
, 
œyî
->
dev
->
bdev
,

136 
exã∫ÆIOReque°
->
ídIO
);

140 #i‡
LINUX_VERSION_CODE
 >
	`KERNEL_VERSION
(4,8,0)

141 
bio
->
bi_›f
 = 
exã∫ÆIOReque°
->
rw
;

143 
bio
->
bi_rw
 = 
exã∫ÆIOReque°
->
rw
;

145 
	`œunchKVDOFlush
(
œyî
, 
bio
);

149 
bio
->
bi_¥iv©e
 = 
exã∫ÆIOReque°
->
¥iv©e
;

150 
bio
->
bi_íd_io
 = 
exã∫ÆIOReque°
->
ídIO
;

151 
	`cou¡Bios
(&
œyî
->
biosAcknowÀdged
, 
bio
);

152 i‡(
	`gëBioSize
(
bio
Ë< 
VDO_BLOCK_SIZE
) {

153 
	`cou¡Bios
(&
œyî
->
biosAcknowÀdgedP¨tül
, 
bio
);

157 
	`d©aKVIOAddTø˚Rec‹d
(
d©aKVIO
, 
	`THIS_LOCATION
(
NULL
));

158 
	`com∂ëeBio
(
bio
, 
îr‹
);

159 
	}
}

162 
noölöe
 
	$˛ónD©aKVIO
(
D©aKVIO
 *
d©aKVIO
, 
FªeBuf„rPoöãrs
 *
fbp
)

164 
	`d©aKVIOAddTø˚Rec‹d
(
d©aKVIO
, 
	`THIS_LOCATION
(
NULL
));

165 
	`kvdoAcknowÀdgeD©aKVIO
(
d©aKVIO
);

167 
KVIO
 *
kvio
 = 
	`d©aKVIOAsKVIO
(
d©aKVIO
);

168 
kvio
->
bio
 = 
NULL
;

170 
	`runRódCacheRñó£Block
(
kvio
->
œyî
, &
d©aKVIO
->
ªadBlock
);

171 i‡(
	`u∆ikñy
(
kvio
->
vio
->
åa˚
 !
NULL
)) {

172 
	`maybeLogD©aKVIOTø˚
(
d©aKVIO
);

173 
	`kvioCom∂ëi⁄T≠1
(
d©aKVIO
);

174 
	`kvioCom∂ëi⁄T≠2
(
d©aKVIO
);

175 
	`‰ìTø˚ToPoﬁ
(
kvio
->
œyî
, kvio->
vio
->
åa˚
);

178 
	`addFªeBuf„rPoöãr
(
fbp
, 
d©aKVIO
);

179 
	}
}

182 
	$ªtu∫D©aKVIOB©chToPoﬁ
(
B©chPro˚ss‹
 *
b©ch
, *
˛osuª
)

184 
Kî√lLayî
 *
œyî
 = 
˛osuª
;

185 
uöt32_t
 
cou¡
 = 0;

186 
	`ASSERT_LOG_ONLY
(
b©ch
 !
NULL
, "batchÇotÇull");

187 
	`ASSERT_LOG_ONLY
(
œyî
 !
NULL
, "layerÇotÇull");

189 
FªeBuf„rPoöãrs
 
fbp
;

190 
	`öôFªeBuf„rPoöãrs
(&
fbp
, 
œyî
->
d©aKVIOPoﬁ
);

192 
KvdoW‹kIãm
 *
ôem
;

193 (
ôem
 = 
	`√xtB©chIãm
(
b©ch
)Ë!
NULL
) {

194 
	`˛ónD©aKVIO
(
	`w‹kIãmAsD©aKVIO
(
ôem
), &
fbp
);

195 
	`c⁄dReschedB©chPro˚ss‹
(
b©ch
);

196 
cou¡
++;

199 i‡(
fbp
.
ödex
 > 0) {

200 
	`‰ìBuf„rPoöãrs
(&
fbp
);

203 
	`com∂ëeM™yReque°s
(
œyî
, 
cou¡
);

204 
	}
}

207 
	$kvdoAcknowÀdgeThíCom∂ëeD©aKVIO
(
KvdoW‹kIãm
 *
ôem
)

209 
D©aKVIO
 *
d©aKVIO
 = 
	`w‹kIãmAsD©aKVIO
(
ôem
);

210 
	`kvdoAcknowÀdgeD©aKVIO
(
d©aKVIO
);

211 
	`addToB©chPro˚ss‹
(
d©aKVIO
->
kvio
.
œyî
->
d©aKVIORñó£r
, 
ôem
);

212 
	}
}

215 
	$kvdoCom∂ëeD©aKVIO
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

217 
D©aKVIO
 *
d©aKVIO
 = 
	`d©aVIOAsD©aKVIO
(
	`asD©aVIO
(
com∂ëi⁄
));

218 
	`d©aKVIOAddTø˚Rec‹d
(
d©aKVIO
, 
	`THIS_LOCATION
(
NULL
));

220 
Kî√lLayî
 *
œyî
 = 
	`gëLayîFromD©aKVIO
(
d©aKVIO
);

221 i‡(
	`u£BioAckQueue
(
œyî
Ë&& 
USE_BIO_ACK_QUEUE_FOR_READ


222 && (
d©aKVIO
->
exã∫ÆIOReque°
.
bio
 !
NULL
)) {

223 
	`œunchD©aKVIOOnBIOAckQueue
(
d©aKVIO
, 
kvdoAcknowÀdgeThíCom∂ëeD©aKVIO
,

224 
NULL
, 
BIO_ACK_Q_ACTION_ACK
);

226 
	`addToB©chPro˚ss‹
(
œyî
->
d©aKVIORñó£r
,

227 
	`w‹kIãmFromD©aKVIO
(
d©aKVIO
));

229 
	}
}

237 
	$c›yRódBlockD©a
(
KvdoW‹kIãm
 *
w‹kIãm
)

239 
D©aKVIO
 *
d©aKVIO
 = 
	`w‹kIãmAsD©aKVIO
(
w‹kIãm
);

243 i‡(
	`isRódModifyWrôeVIO
(
d©aKVIO
->
kvio
.
vio
)) {

244 
	`bioC›yD©aOut
(
	`gëBIOFromD©aKVIO
(
d©aKVIO
), d©aKVIO->
ªadBlock
.
d©a
);

245 
	`kvdoEnqueueD©aVIOCÆlback
(
d©aKVIO
);

251 i‡(
d©aKVIO
->
isP¨tül
) {

252 
	`kvdoEnqueueD©aVIOCÆlback
(
d©aKVIO
);

257 
	`bioC›yD©aOut
(
	`gëBIOFromD©aKVIO
(
d©aKVIO
), d©aKVIO->
ªadBlock
.
d©a
);

258 
	`kvdoAcknowÀdgeD©aVIO
(&
d©aKVIO
->
d©aVIO
);

259 
	}
}

266 
	$ªadD©aKVIORódBlockCÆlback
(
D©aKVIO
 *
d©aKVIO
)

268 i‡(
d©aKVIO
->
ªadBlock
.
°©us
 !
VDO_SUCCESS
) {

269 
	`£tCom∂ëi⁄Resu…
(
	`d©aVIOAsCom∂ëi⁄
(&
d©aKVIO
->
d©aVIO
),

270 
d©aKVIO
->
ªadBlock
.
°©us
);

271 
	`kvdoEnqueueD©aVIOCÆlback
(
d©aKVIO
);

275 
	`œunchD©aKVIOOnCPUQueue
(
d©aKVIO
, 
c›yRódBlockD©a
, 
NULL
,

276 
CPU_Q_ACTION_COMPRESS_BLOCK
);

277 
	}
}

279 #i‡
LINUX_VERSION_CODE
 >
KERNEL_VERSION
(4,4,0)

286 
	$ª£tU£rBio
(
BIO
 *
bio
)

295 
	$ª£tU£rBio
(
BIO
 *
bio
, 
îr‹
)

298 #i‡((
LINUX_VERSION_CODE
 >
	`KERNEL_VERSION
(3,14,0)) \

299 && (
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(4,2,0)))

302 
	`©omic_öc
(&
bio
->
bi_ªmaöög
);

305 #i‡
LINUX_VERSION_CODE
 >
	`KERNEL_VERSION
(4,4,0)

306 
	`com∂ëeAsyncBio
(
bio
);

308 
	`com∂ëeAsyncBio
(
bio
, 
îr‹
);

310 
	}
}

313 
	$kvdoRódD©aVIO
(
D©aVIO
 *
d©aVIO
)

315 
	`ASSERT_LOG_ONLY
(!
	`isWrôeVIO
(
	`d©aVIOAsVIO
(
d©aVIO
)),

317 
	`d©aVIOAddTø˚Rec‹d
(
d©aVIO
, 
	`THIS_LOCATION
("$F;io=readData"));

319 i‡(
	`isCom¥es£d
(
d©aVIO
->
m≠≥d
.
°©e
)) {

320 
	`kvdoRódBlock
(
d©aVIO
, d©aVIO->
m≠≥d
.
pbn
, d©aVIO->m≠≥d.
°©e
,

321 
READ_COMPRESSED_DATA
, 
ªadD©aKVIORódBlockCÆlback
);

325 
KVIO
 *
kvio
 = 
	`d©aVIOAsKVIO
(
d©aVIO
);

326 
BIO
 *
bio
 = 
kvio
->bio;

327 
bio
->
bi_íd_io
 = 
ª£tU£rBio
;

328 
	`£tBioSe˘‹
(
bio
, 
	`blockToSe˘‹
(
kvio
->
œyî
, 
d©aVIO
->
m≠≥d
.
pbn
));

329 
	`submôBio
(
bio
, 
BIO_Q_ACTION_DATA
);

330 
	}
}

333 
	$kvdoAcknowÀdgeD©aKVIOThíC⁄töue
(
KvdoW‹kIãm
 *
ôem
)

335 
D©aKVIO
 *
d©aKVIO
 = 
	`w‹kIãmAsD©aKVIO
(
ôem
);

336 
	`d©aKVIOAddTø˚Rec‹d
(
d©aKVIO
, 
	`THIS_LOCATION
(
NULL
));

337 
	`kvdoAcknowÀdgeD©aKVIO
(
d©aKVIO
);

340 
	`kvdoEnqueueD©aVIOCÆlback
(
d©aKVIO
);

341 
	}
}

344 
	$kvdoAcknowÀdgeD©aVIO
(
D©aVIO
 *
d©aVIO
)

346 
D©aKVIO
 *
d©aKVIO
 = 
	`d©aVIOAsD©aKVIO
(
d©aVIO
);

347 
Kî√lLayî
 *
œyî
 = 
	`gëLayîFromD©aKVIO
(
d©aKVIO
);

351 i‡(
	`isDisˇrdBio
(
d©aKVIO
->
exã∫ÆIOReque°
.
bio
)

352 && (
d©aKVIO
->
ªmaöögDisˇrd


353 > (
VDO_BLOCK_SIZE
 - 
d©aKVIO
->
off£t
))) {

354 
	`övokeCÆlback
(
	`d©aVIOAsCom∂ëi⁄
(
d©aVIO
));

360 i‡(
	`u£BioAckQueue
(
œyî
)) {

361 
	`d©aVIOAddTø˚Rec‹d
(
d©aVIO
, 
	`THIS_LOCATION
(
NULL
));

362 
	`œunchD©aKVIOOnBIOAckQueue
(
d©aKVIO
, 
kvdoAcknowÀdgeD©aKVIOThíC⁄töue
,

363 
NULL
, 
BIO_ACK_Q_ACTION_ACK
);

365 
	`kvdoAcknowÀdgeD©aKVIOThíC⁄töue
(
	`w‹kIãmFromD©aKVIO
(
d©aKVIO
));

367 
	}
}

370 
	$kvdoWrôeD©aVIO
(
D©aVIO
 *
d©aVIO
)

372 
	`ASSERT_LOG_ONLY
(
	`isWrôeVIO
(
	`d©aVIOAsVIO
(
d©aVIO
)),

374 
	`d©aVIOAddTø˚Rec‹d
(
d©aVIO
, 
	`THIS_LOCATION
("$F;io=writeData;j=normal"));

376 
KVIO
 *
kvio
 = 
	`d©aVIOAsKVIO
(
d©aVIO
);

377 
BIO
 *
bio
 = 
kvio
->bio;

379 #i‡
LINUX_VERSION_CODE
 >
	`KERNEL_VERSION
(4,8,0)

380 
bio
->
bi_›f
 |
WRITE
;

382 
bio
->
bi_rw
 |
WRITE
;

384 
	`£tBioSe˘‹
(
bio
, 
	`blockToSe˘‹
(
kvio
->
œyî
, 
d©aVIO
->
√wM≠≥d
.
pbn
));

385 
	`övÆid©eCacheAndSubmôBio
(
kvio
, 
BIO_Q_ACTION_DATA
);

386 
	}
}

389 
	$kvdoModifyWrôeD©aVIO
(
D©aVIO
 *
d©aVIO
)

391 
	`d©aVIOAddTø˚Rec‹d
(
d©aVIO
, 
	`THIS_LOCATION
(
NULL
));

392 
D©aKVIO
 *
d©aKVIO
 = 
	`d©aVIOAsD©aKVIO
(
d©aVIO
);

393 
BIO
 *
bio
 = 
d©aKVIO
->
exã∫ÆIOReque°
.bio;

394 
Kî√lLayî
 *
œyî
 = 
	`gëLayîFromD©aKVIO
(
d©aKVIO
);

395 
	`ª£tBio
(
d©aKVIO
->
d©aBlockBio
, 
œyî
);

397 i‡(!
	`isDisˇrdBio
(
bio
)) {

398 
	`bioC›yD©aIn
(
bio
, 
d©aKVIO
->
d©aBlock
 + d©aKVIO->
off£t
);

400 
	`mem£t
(
d©aKVIO
->
d©aBlock
 + d©aKVIO->
off£t
, '\0',

401 
	`mö
(
d©aKVIO
->
ªmaöögDisˇrd
,

402 (
DisˇrdSize
Ë(
VDO_BLOCK_SIZE
 - 
d©aKVIO
->
off£t
)));

405 
d©aVIO
->
isZîoBlock
 = 
	`bioIsZîoD©a
(
d©aKVIO
->
d©aBlockBio
);

406 
d©aKVIO
->
d©aBlockBio
->
bi_¥iv©e
 = &d©aKVIO->
kvio
;

407 #i‡
LINUX_VERSION_CODE
 >
	`KERNEL_VERSION
(4,8,0)

408 
d©aKVIO
->
d©aBlockBio
->
bi_›f
 = 
bio
->bi_›‡& ~
	`bioDisˇrdRWMask
();

410 
d©aKVIO
->
d©aBlockBio
->
bi_rw
 = 
bio
->bi_rw & ~
	`bioDisˇrdRWMask
();

412 
	}
}

415 
	$kvdoZîoD©aVIO
(
D©aVIO
 *
d©aVIO
)

417 
	`d©aVIOAddTø˚Rec‹d
(
d©aVIO
, 
	`THIS_LOCATION
("zeroDataVIO;io=readData"));

418 
	`bioZîoD©a
(
	`d©aVIOAsKVIO
(
d©aVIO
)->
bio
);

419 
	}
}

422 
boﬁ
 
	$kvdoCom∑ªD©aVIOs
(
D©aVIO
 *
fú°
, D©aVIO *
£c⁄d
)

424 
	`d©aVIOAddTø˚Rec‹d
(
£c⁄d
, 
	`THIS_LOCATION
(
NULL
));

425 
D©aKVIO
 *
a
 = 
	`d©aVIOAsD©aKVIO
(
fú°
);

426 
D©aKVIO
 *
b
 = 
	`d©aVIOAsD©aKVIO
(
£c⁄d
);

427 i‡(
	`memcmp
(
a
->
d©aBlock
, 
b
->d©aBlock, 
VDO_BLOCK_SIZE
) == 0) {

428  
åue
;

431 
	`©omic64_öc
(&(
	`gëLayîFromD©aKVIO
(
b
)->
dedu≥Advi˚SèÀ
));

432  
Ál£
;

433 
	}
}

436 
	$kvdoC›yD©aVIO
(
D©aVIO
 *
sour˚
, D©aVIO *
de°ö©i⁄
)

438 
	`d©aVIOAddTø˚Rec‹d
(
de°ö©i⁄
, 
	`THIS_LOCATION
(
NULL
));

439 
	`bioC›yD©aOut
(
	`d©aVIOAsKVIO
(
de°ö©i⁄
)->
bio
,

440 
	`d©aVIOAsD©aKVIO
(
sour˚
)->
d©aBlock
);

441 
	}
}

444 
	$kvdoCom¥essW‹k
(
KvdoW‹kIãm
 *
ôem
)

446 
D©aKVIO
 *
d©aKVIO
 = 
	`w‹kIãmAsD©aKVIO
(
ôem
);

447 
Kî√lLayî
 *
œyî
 = 
	`gëLayîFromD©aKVIO
(
d©aKVIO
);

448 
	`d©aKVIOAddTø˚Rec‹d
(
d©aKVIO
, 
	`THIS_LOCATION
(
NULL
));

450 *
c⁄ãxt
 = 
	`gëW‹kQueuePriv©eD©a
();

451 i‡(
	`u∆ikñy
(
c⁄ãxt
 =
NULL
)) {

452 
uöt32_t
 
ödex
 = 
	`©omicAdd32
(&
œyî
->
com¥essi⁄C⁄ãxtIndex
, 1) - 1;

453 
	`BUG_ON
(
ödex
 >
œyî
->
devi˚C⁄fig
->
thªadCou¡s
.
˝uThªads
);

454 
c⁄ãxt
 = 
œyî
->
com¥essi⁄C⁄ãxt
[
ödex
];

455 
	`£tW‹kQueuePriv©eD©a
(
c⁄ãxt
);

458 
size
 = 
	`LZ4_com¥ess_˘x_limôedOuçut
(
c⁄ãxt
, 
d©aKVIO
->
d©aBlock
,

459 
d©aKVIO
->
s¸©chBlock
,

460 
VDO_BLOCK_SIZE
,

461 
VDO_BLOCK_SIZE
);

462 
D©aVIO
 *
d©aVIO
 = &
d©aKVIO
->dataVIO;

463 i‡(
size
 > 0) {

465 
d©aVIO
->
com¥essi⁄
.
d©a
 = 
d©aKVIO
->
s¸©chBlock
;

466 
d©aVIO
->
com¥essi⁄
.
size
 = size;

469 
d©aVIO
->
com¥essi⁄
.
size
 = 
VDO_BLOCK_SIZE
 + 1;

472 
	`kvdoEnqueueD©aVIOCÆlback
(
d©aKVIO
);

473 
	}
}

476 
	$kvdoCom¥essD©aVIO
(
D©aVIO
 *
d©aVIO
)

478 
	`d©aVIOAddTø˚Rec‹d
(
d©aVIO
,

479 
	`THIS_LOCATION
("compressDataVIO;"

487 
D©aKVIO
 *
d©aKVIO
 = 
	`d©aVIOAsD©aKVIO
(
d©aVIO
);

488 i‡(
	`isDisˇrdBio
(
d©aKVIO
->
exã∫ÆIOReque°
.
bio
)

489 && (
d©aKVIO
->
ªmaöögDisˇrd
 > 0)) {

490 
d©aVIO
->
com¥essi⁄
.
size
 = 
VDO_BLOCK_SIZE
 + 1;

491 
	`kvdoEnqueueD©aVIOCÆlback
(
d©aKVIO
);

495 
	`œunchD©aKVIOOnCPUQueue
(
d©aKVIO
, 
kvdoCom¥essW‹k
, 
NULL
,

496 
CPU_Q_ACTION_COMPRESS_BLOCK
);

497 
	}
}

508 
__©åibuã__
((
w¨n_unu£d_ªsu…
))

509 
	$makeD©aKVIO
(
Kî√lLayî
 *
œyî
, 
BIO
 *
bio
, 
D©aKVIO
 **
d©aKVIOPå
)

511 
D©aKVIO
 *
d©aKVIO
;

512 
ªsu…
 = 
	`ÆlocBuf„rFromPoﬁ
(
œyî
->
d©aKVIOPoﬁ
, (**Ë&
d©aKVIO
);

513 i‡(
ªsu…
 !
VDO_SUCCESS
) {

514  
	`logEº‹WôhSåögEº‹
(
ªsu…
, "data kvioállocation failure");

517 i‡(
WRITE_PROTECT_FREE_POOL
) {

518 
	`£tWrôePrŸe˘
(
d©aKVIO
, 
WP_DATA_KVIO_SIZE
, 
Ál£
);

521 
KVIO
 *
kvio
 = &
d©aKVIO
->kvio;

522 
kvio
->
vio
 = 
	`d©aVIOAsVIO
(&
d©aKVIO
->
d©aVIO
);

523 
	`mem£t
(&
kvio
->
íqueuóbÀ
, 0, (
KvdoEnqueuóbÀ
));

524 
	`mem£t
(&
d©aKVIO
->
dedu≥C⁄ãxt
.
≥ndögLi°
, 0, (
li°_hód
));

525 
	`mem£t
(&
d©aKVIO
->
d©aVIO
, 0, (
D©aVIO
));

526 
kvio
->
bioToSubmô
 = 
NULL
;

527 
	`bio_li°_öô
(&
kvio
->
biosMîged
);

530 i‡(
	`isWrôeBio
(
bio
Ë|| (
	`gëBioSize
(bioË< 
VDO_BLOCK_SIZE
)) {

531 
	`ª£tBio
(
d©aKVIO
->
d©aBlockBio
, 
œyî
);

534 
	`öôülizeKVIO
(
kvio
, 
œyî
, 
VIO_TYPE_DATA
, 
VIO_PRIORITY_DATA
, 
NULL
, 
bio
);

535 *
d©aKVIOPå
 = 
d©aKVIO
;

536  
VDO_SUCCESS
;

537 
	}
}

553 
	$kvdoCª©eKVIOFromBio
(
Kî√lLayî
 *
œyî
,

554 
BIO
 *
bio
,

555 
Jiffõs
 
¨rivÆTime
,

556 
D©aKVIO
 **
d©aKVIOPå
)

558 
Exã∫ÆIOReque°
 
exã∫ÆIOReque°
 = {

559 .
bio
 = bio,

560 .
¥iv©e
 = 
bio
->
bi_¥iv©e
,

561 .
ídIO
 = 
bio
->
bi_íd_io
,

562 #i‡
LINUX_VERSION_CODE
 >
	`KERNEL_VERSION
(4,8,0)

563 .
rw
 = 
bio
->
bi_›f
,

565 .
rw
 = 
bio
->
bi_rw
,

571 #i‡
LINUX_VERSION_CODE
 >
	`KERNEL_VERSION
(4,8,0)

572 
bio
->
bi_›f
 &~
	`bioFuaRWMask
();

574 
bio
->
bi_rw
 &~
	`bioFuaRWMask
();

577 
D©aKVIO
 *
d©aKVIO
 = 
NULL
;

578 
ªsu…
 = 
	`makeD©aKVIO
(
œyî
, 
bio
, &
d©aKVIO
);

579 i‡(
ªsu…
 !
VDO_SUCCESS
) {

580  
ªsu…
;

583 
d©aKVIO
->
exã∫ÆIOReque°
 =ÉxternalIORequest;

584 
d©aKVIO
->
off£t
 = 
	`£˘‹ToBlockOff£t
(
œyî
, 
	`gëBioSe˘‹
(
bio
));

585 
d©aKVIO
->
isP¨tül
 = ((
	`gëBioSize
(
bio
Ë< 
VDO_BLOCK_SIZE
)

586 || (
d©aKVIO
->
off£t
 != 0));

588 
D©aVIO
 *
d©aVIO
 = &
d©aKVIO
->dataVIO;

589 i‡(!
d©aKVIO
->
isP¨tül
) {

598 i‡(
	`isDisˇrdBio
(
bio
)) {

604 
	`mem£t
(
d©aKVIO
->
d©aBlock
, 0, 
VDO_BLOCK_SIZE
);

605 } i‡(
	`bio_d©a_dú
(
bio
Ë=
WRITE
) {

606 
d©aVIO
->
isZîoBlock
 = 
	`bioIsZîoD©a
(
bio
);

609 
	`bioC›yD©aIn
(
bio
, 
d©aKVIO
->
d©aBlock
);

613 i‡(
d©aKVIO
->
isP¨tül
 || 
	`isWrôeBio
(
bio
)) {

619 
d©aKVIO
->
d©aBlockBio
->
bi_¥iv©e
 = &d©aKVIO->
kvio
;

620 i‡(
d©aKVIO
->
isP¨tül
 && 
	`isWrôeBio
(
bio
)) {

621 #i‡
LINUX_VERSION_CODE
 >
	`KERNEL_VERSION
(4,8,0)

622 
d©aKVIO
->
d©aBlockBio
->
bi_›f
 = 
READ
;

624 
d©aKVIO
->
d©aBlockBio
->
bi_rw
 = 
READ
;

627 #i‡
LINUX_VERSION_CODE
 >
	`KERNEL_VERSION
(4,8,0)

628 
d©aKVIO
->
d©aBlockBio
->
bi_›f
 = 
bio
->bi_opf;

630 
d©aKVIO
->
d©aBlockBio
->
bi_rw
 = 
bio
->bi_rw;

633 
	`d©aKVIOAsKVIO
(
d©aKVIO
)->
bio
 = d©aKVIO->
d©aBlockBio
;

634 
d©aKVIO
->
ªadBlock
.
d©a
 = d©aKVIO->
d©aBlock
;

637 
	`£tBioBlockDevi˚
(
bio
, 
œyî
->
dev
->
bdev
);

638 
bio
->
bi_íd_io
 = 
com∂ëeAsyncBio
;

639 *
d©aKVIOPå
 = 
d©aKVIO
;

640  
VDO_SUCCESS
;

641 
	}
}

644 
	$œunchD©aKVIOW‹k
(
KvdoW‹kIãm
 *
ôem
)

646 
	`runCÆlback
(
	`vioAsCom∂ëi⁄
(
	`w‹kIãmAsKVIO
(
ôem
)->
vio
));

647 
	}
}

659 
	$kvdoC⁄töueDisˇrdKVIO
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

661 
D©aVIO
 *
d©aVIO
 = 
	`asD©aVIO
(
com∂ëi⁄
);

662 
D©aKVIO
 *
d©aKVIO
 = 
	`d©aVIOAsD©aKVIO
(
d©aVIO
);

663 
Kî√lLayî
 *
œyî
 = 
	`gëLayîFromD©aKVIO
(
d©aKVIO
);

664 
d©aKVIO
->
ªmaöögDisˇrd


665 -
	`mö
(
d©aKVIO
->
ªmaöögDisˇrd
,

666 (
DisˇrdSize
Ë(
VDO_BLOCK_SIZE
 - 
d©aKVIO
->
off£t
));

667 i‡((
com∂ëi⁄
->
ªsu…
 !
VDO_SUCCESS
)

668 || (
d©aKVIO
->
ªmaöögDisˇrd
 == 0)) {

669 i‡(
d©aKVIO
->
hasDisˇrdPîmô
) {

670 
	`limôîRñó£
(&
œyî
->
disˇrdLimôî
);

671 
d©aKVIO
->
hasDisˇrdPîmô
 = 
Ál£
;

673 
	`kvdoCom∂ëeD©aKVIO
(
com∂ëi⁄
);

677 
BIO
 *
bio
 = 
	`gëBIOFromD©aKVIO
(
d©aKVIO
);

678 
	`ª£tBio
(
bio
, 
œyî
);

679 
d©aKVIO
->
isP¨tül
 = (d©aKVIO->
ªmaöögDisˇrd
 < 
VDO_BLOCK_SIZE
);

680 
d©aKVIO
->
off£t
 = 0;

682 
VIOO≥øti⁄
 
›î©i⁄
;

683 i‡(
d©aKVIO
->
isP¨tül
) {

684 
›î©i⁄
 = 
VIO_READ_MODIFY_WRITE
;

685 #i‡
LINUX_VERSION_CODE
 >
	`KERNEL_VERSION
(4,8,0)

686 
bio
->
bi_›f
 = 
READ
;

688 
bio
->
bi_rw
 = 
READ
;

691 
›î©i⁄
 = 
VIO_WRITE
;

694 
	`¥ï¨eD©aVIO
(
d©aVIO
, d©aVIO->
logiˇl
.
lbn
 + 1, 
›î©i⁄
,

695 !
d©aKVIO
->
isP¨tül
, 
kvdoC⁄töueDisˇrdKVIO
);

696 
	`íqueueD©aKVIO
(
d©aKVIO
, 
œunchD©aKVIOW‹k
, 
com∂ëi⁄
->
ˇŒback
,

697 
REQ_Q_ACTION_MAP_BIO
);

698 
	}
}

705 
	$kvdoCom∂ëeP¨tülRód
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

707 
D©aKVIO
 *
d©aKVIO
 = 
	`d©aVIOAsD©aKVIO
(
	`asD©aVIO
(
com∂ëi⁄
));

708 
	`d©aKVIOAddTø˚Rec‹d
(
d©aKVIO
, 
	`THIS_LOCATION
(
NULL
));

710 
	`bioC›yD©aOut
(
d©aKVIO
->
exã∫ÆIOReque°
.
bio
,

711 
d©aKVIO
->
ªadBlock
.
d©a
 + d©aKVIO->
off£t
);

712 
	`kvdoCom∂ëeD©aKVIO
(
com∂ëi⁄
);

714 
	}
}

717 
	$kvdoLaunchD©aKVIOFromBio
(
Kî√lLayî
 *
œyî
,

718 
BIO
 *
bio
,

719 
uöt64_t
 
¨rivÆTime
,

720 
boﬁ
 
hasDisˇrdPîmô
)

722 i‡(
	`gëBioSize
(
bio
Ë< 
VDO_BLOCK_SIZE
) {

723 
	`cou¡Bios
(&
œyî
->
biosInP¨tül
, 
bio
);

727 
D©aKVIO
 *
d©aKVIO
 = 
NULL
;

728 
ªsu…
 = 
	`kvdoCª©eKVIOFromBio
(
œyî
, 
bio
, 
¨rivÆTime
, &
d©aKVIO
);

729 i‡(
	`u∆ikñy
(
ªsu…
 !
VDO_SUCCESS
)) {

730 
	`logInfo
("%s: KVIOáŒoˇti⁄ faûuª", 
__func__
);

731 i‡(
hasDisˇrdPîmô
) {

732 
	`limôîRñó£
(&
œyî
->
disˇrdLimôî
);

734 
	`limôîRñó£
(&
œyî
->
ªque°Limôî
);

735  
	`m≠ToSy°emEº‹
(
ªsu…
);

743 
KVIO
 *
kvio
 = &
d©aKVIO
->kvio;

744 
VDOA˘i⁄
 *
ˇŒback
 = 
kvdoCom∂ëeD©aKVIO
;

745 
VIOO≥øti⁄
 
›î©i⁄
 = 
VIO_WRITE
;

746 
boﬁ
 
isTrim
 = 
Ál£
;

747 i‡(
	`isDisˇrdBio
(
bio
)) {

748 
d©aKVIO
->
hasDisˇrdPîmô
 = hasDiscardPermit;

749 
d©aKVIO
->
ªmaöögDisˇrd
 = 
	`gëBioSize
(
bio
);

750 
ˇŒback
 = 
kvdoC⁄töueDisˇrdKVIO
;

751 i‡(
d©aKVIO
->
isP¨tül
) {

752 
›î©i⁄
 = 
VIO_READ_MODIFY_WRITE
;

754 
isTrim
 = 
åue
;

756 } i‡(
d©aKVIO
->
isP¨tül
) {

757 i‡(
	`bio_d©a_dú
(
bio
Ë=
READ
) {

758 
ˇŒback
 = 
kvdoCom∂ëeP¨tülRód
;

759 
›î©i⁄
 = 
VIO_READ
;

761 
›î©i⁄
 = 
VIO_READ_MODIFY_WRITE
;

763 } i‡(
	`bio_d©a_dú
(
bio
Ë=
READ
) {

764 
›î©i⁄
 = 
VIO_READ
;

767 
LogiˇlBlockNumbî
 
lbn


768 
	`£˘‹ToBlock
(
œyî
, 
	`gëBioSe˘‹
(
bio
Ë-Üayî->
°¨tögSe˘‹Off£t
);

769 
	`¥ï¨eD©aVIO
(&
d©aKVIO
->
d©aVIO
, 
lbn
, 
›î©i⁄
, 
isTrim
, 
ˇŒback
);

770 
	`íqueueKVIO
(
kvio
, 
œunchD©aKVIOW‹k
, 
	`vioAsCom∂ëi⁄
(kvio->
vio
)->
ˇŒback
,

771 
REQ_Q_ACTION_MAP_BIO
);

772  
VDO_SUCCESS
;

773 
	}
}

780 
	$kvdoHashD©aW‹k
(
KvdoW‹kIãm
 *
ôem
)

782 
D©aKVIO
 *
d©aKVIO
 = 
	`w‹kIãmAsD©aKVIO
(
ôem
);

783 
D©aVIO
 *
d©aVIO
 = &
d©aKVIO
->dataVIO;

784 
	`d©aVIOAddTø˚Rec‹d
(
d©aVIO
, 
	`THIS_LOCATION
(
NULL
));

786 i‡((
d©aVIO
->
chunkName
) == 32) {

787 
	`MurmurHash3_x64_128_doubÀ
(
d©aKVIO
->
d©aBlock
, 
VDO_BLOCK_SIZE
,

788 0x62ó60be, 0x3ìb36cd, &
d©aVIO
->
chunkName
);

790 
	`MurmurHash3_x64_128
(
d©aKVIO
->
d©aBlock
, 
VDO_BLOCK_SIZE
, 0x62ea60be,

791 &
d©aVIO
->
chunkName
);

793 
d©aKVIO
->
dedu≥C⁄ãxt
.
chunkName
 = &
d©aVIO
->chunkName;

795 
	`kvdoEnqueueD©aVIOCÆlback
(
d©aKVIO
);

796 
	}
}

799 
	$kvdoHashD©aVIO
(
D©aVIO
 *
d©aVIO
)

801 
	`d©aVIOAddTø˚Rec‹d
(
d©aVIO
, 
	`THIS_LOCATION
(
NULL
));

802 
	`œunchD©aKVIOOnCPUQueue
(
	`d©aVIOAsD©aKVIO
(
d©aVIO
), 
kvdoHashD©aW‹k
, 
NULL
,

803 
CPU_Q_ACTION_HASH_BLOCK
);

804 
	}
}

807 
	$kvdoCheckF‹Du∂iˇti⁄
(
D©aVIO
 *
d©aVIO
)

809 
	`d©aVIOAddTø˚Rec‹d
(
d©aVIO
,

810 
	`THIS_LOCATION
("checkForDuplication;dup=post"));

811 
	`ASSERT_LOG_ONLY
(!
d©aVIO
->
isZîoBlock
,

813 
	`ASSERT_LOG_ONLY
(
d©aVIO
->
√wM≠≥d
.
°©e
 !
MAPPING_STATE_UNMAPPED
,

815 
	`ASSERT_LOG_ONLY
(
d©aVIO
->
chunkNameSë
,

818 
D©aKVIO
 *
d©aKVIO
 = 
	`d©aVIOAsD©aKVIO
(
d©aVIO
);

819 i‡(
	`hasAŒoˇti⁄
(
d©aVIO
)) {

820 
	`po°Dedu≥Advi˚
(
d©aKVIO
);

824 
	`quîyDedu≥Advi˚
(
d©aKVIO
);

826 
	}
}

833 
	$kvdoUpd©eDedu≥Advi˚
(
D©aVIO
 *
d©aVIO
)

835 
D©aKVIO
 *
d©aKVIO
 = 
	`d©aVIOAsD©aKVIO
(
d©aVIO
);

836 
	`ASSERT_LOG_ONLY
(
d©aVIO
->
chunkNameSë
,

838 
	`upd©eDedu≥Advi˚
(
d©aKVIO
);

839 
	}
}

844 
	$‰ìPoﬁedD©aKVIO
(*
poﬁD©a
, *
d©a
)

846 i‡(
d©a
 =
NULL
) {

850 
D©aKVIO
 *
d©aKVIO
 = (D©aKVIO *Ë
d©a
;

851 
Kî√lLayî
 *
œyî
 = (Kî√lLayî *Ë
poﬁD©a
;

852 i‡(
WRITE_PROTECT_FREE_POOL
) {

853 
	`£tWrôePrŸe˘
(
d©aKVIO
, 
WP_DATA_KVIO_SIZE
, 
Ál£
);

856 i‡(
d©aKVIO
->
d©aBlockBio
 !
NULL
) {

857 
	`‰ìBio
(
d©aKVIO
->
d©aBlockBio
, 
œyî
);

860 i‡(
d©aKVIO
->
ªadBlock
.
bio
 !
NULL
) {

861 
	`‰ìBio
(
d©aKVIO
->
ªadBlock
.
bio
, 
œyî
);

864 
	`FREE
(
d©aKVIO
->
ªadBlock
.
buf„r
);

865 
	`FREE
(
d©aKVIO
->
d©aBlock
);

866 
	`FREE
(
d©aKVIO
->
s¸©chBlock
);

867 
	`FREE
(
d©aKVIO
);

868 
	}
}

878 
	$ÆloˇãPoﬁedD©aKVIO
(
Kî√lLayî
 *
œyî
, 
D©aKVIO
 **
d©aKVIOPå
)

880 
D©aKVIO
 *
d©aKVIO
;

881 
ªsu…
;

882 i‡(
WRITE_PROTECT_FREE_POOL
) {

883 
	`STATIC_ASSERT
(
WP_DATA_KVIO_SIZE
 >(
D©aKVIO
));

884 
ªsu…
 = 
	`ÆloˇãMem‹y
(
WP_DATA_KVIO_SIZE
, 0, 
__func__
, &
d©aKVIO
);

885 i‡(
ªsu…
 =
VDO_SUCCESS
) {

886 
	`BUG_ON
((((
size_t
Ë
d©aKVIO
Ë& (
PAGE_SIZE
 - 1)) != 0);

889 
ªsu…
 = 
	`ALLOCATE
(1, 
D©aKVIO
, 
__func__
, &
d©aKVIO
);

892 i‡(
ªsu…
 !
VDO_SUCCESS
) {

893  
	`logEº‹WôhSåögEº‹
(
ªsu…
, "DataKVIOállocation failure");

896 
	`STATIC_ASSERT
(
VDO_BLOCK_SIZE
 <
PAGE_SIZE
);

897 
ªsu…
 = 
	`ÆloˇãMem‹y
(
VDO_BLOCK_SIZE
, 0, "kvio data",

898 &
d©aKVIO
->
d©aBlock
);

899 i‡(
ªsu…
 !
VDO_SUCCESS
) {

900  
	`logEº‹WôhSåögEº‹
(
ªsu…
, "DataKVIO dataállocation failure");

903 
ªsu…
 = 
	`¸óãBio
(
œyî
, 
d©aKVIO
->
d©aBlock
, &d©aKVIO->
d©aBlockBio
);

904 i‡(
ªsu…
 !
VDO_SUCCESS
) {

905  
	`logEº‹WôhSåögEº‹
(
ªsu…
,

909 i‡(
œyî
->
ªadCacheBlocks
 == 0) {

910 
ªsu…
 = 
	`ÆloˇãMem‹y
(
VDO_BLOCK_SIZE
, 0, "kvioÑead buffer",

911 &
d©aKVIO
->
ªadBlock
.
buf„r
);

912 i‡(
ªsu…
 !
VDO_SUCCESS
) {

913  
	`logEº‹WôhSåögEº‹
(
ªsu…
,

917 
ªsu…
 = 
	`¸óãBio
(
œyî
, 
d©aKVIO
->
ªadBlock
.
buf„r
,

918 &
d©aKVIO
->
ªadBlock
.
bio
);

919 i‡(
ªsu…
 !
VDO_SUCCESS
) {

920  
	`logEº‹WôhSåögEº‹
(
ªsu…
,

924 
d©aKVIO
->
ªadBlock
.
bio
->
bi_¥iv©e
 = &d©aKVIO->
kvio
;

927 
ªsu…
 = 
	`ÆloˇãMem‹y
(
VDO_BLOCK_SIZE
, 0, "kvio scratch",

928 &
d©aKVIO
->
s¸©chBlock
);

929 i‡(
ªsu…
 !
VDO_SUCCESS
) {

930  
	`logEº‹WôhSåögEº‹
(
ªsu…
,

934 *
d©aKVIOPå
 = 
d©aKVIO
;

935  
VDO_SUCCESS
;

936 
	}
}

941 
	$makePoﬁedD©aKVIO
(*
poﬁD©a
, **
d©aPå
)

943 
D©aKVIO
 *
d©aKVIO
 = 
NULL
;

944 
ªsu…
 = 
	`ÆloˇãPoﬁedD©aKVIO
((
Kî√lLayî
 *Ë
poﬁD©a
, &
d©aKVIO
);

945 i‡(
ªsu…
 !
VDO_SUCCESS
) {

946 
	`‰ìPoﬁedD©aKVIO
(
poﬁD©a
, 
d©aKVIO
);

947  
ªsu…
;

950 *
d©aPå
 = 
d©aKVIO
;

951  
VDO_SUCCESS
;

952 
	}
}

960 
	$dumpVIOWaôîs
(
WaôQueue
 *
queue
, *
waôOn
)

962 
Waôî
 *
fú°
 = 
	`gëFú°Waôî
(
queue
);

963 i‡(
fú°
 =
NULL
) {

967 
D©aVIO
 *
d©aVIO
 = 
	`waôîAsD©aVIO
(
fú°
);

968 
	`logInfo
(" %†i†locked. Waôed o¿by: VIO %∞pb¿%" 
PRIu64
 "Übn %"

969 
PRIu64
 " d-pbn %" PRIu64 "ÜastOp %s",

970 
waôOn
, 
d©aVIO
, 
	`gëD©aVIOAŒoˇti⁄
(dataVIO),

971 
d©aVIO
->
logiˇl
.
lbn
, d©aVIO->
du∂iˇã
.
pbn
,

972 
	`gëO≥øti⁄Name
(
d©aVIO
));

974 
Waôî
 *
waôî
 = 
fú°
->
√xtWaôî
;

975 
waôî
 !
fú°
;

976 
waôî
 = waôî->
√xtWaôî
) {

977 
d©aVIO
 = 
	`waôîAsD©aVIO
(
waôî
);

978 
	`logInfo
(" ...ánd : VIO %∞pb¿%" 
PRIu64
 "Übn %"

979 
PRIu64
 " d-pbn %" PRIu64 "ÜastOp %s",

980 
d©aVIO
, 
	`gëD©aVIOAŒoˇti⁄
(d©aVIO), d©aVIO->
logiˇl
.
lbn
,

981 
d©aVIO
->
du∂iˇã
.
pbn
, 
	`gëO≥øti⁄Name
(dataVIO));

983 
	}
}

1001 
	$ícodeVIODumpFœgs
(
D©aVIO
 *
d©aVIO
, 
buf„r
[8])

1003 *
pFœg
 = 
buf„r
;

1004 *
pFœg
++ = ' ';

1005 i‡(
	`d©aVIOAsCom∂ëi⁄
(
d©aVIO
)->
ªsu…
 !
VDO_SUCCESS
) {

1006 *
pFœg
++ = 'R';

1008 i‡(
	`d©aVIOAsAŒoˇtögVIO
(
d©aVIO
)->
waôî
.
√xtWaôî
 !
NULL
) {

1009 *
pFœg
++ = 'W';

1011 i‡(
d©aVIO
->
isDu∂iˇã
) {

1012 *
pFœg
++ = 'D';

1014 i‡(
pFœg
 =&
buf„r
[1]) {

1016 
pFœg
 = 
buf„r
;

1018 *
pFœg
 = '\0';

1019 
	}
}

1029 
dumpPoﬁedD©aKVIO
(*
poﬁD©a
 
__©åibuã__
((
unu£d
)),

1030 *
d©a
)

1032 
D©aKVIO
 *
	gd©aKVIO
 = (D©aKVIO *Ë
d©a
;

1033 
D©aVIO
 *
	gd©aVIO
 = &
d©aKVIO
->
d©aVIO
;

1044 
	gvioW‹kIãmDumpBuf„r
[100 + 
MAX_QUEUE_NAME_LEN
];

1050 
dumpW‹kIãmToBuf„r
(&
d©aKVIO
->
kvio
.
íqueuóbÀ
.
w‹kIãm
,

1051 
vioW‹kIãmDumpBuf„r
, (vioWorkItemDumpBuffer));

1054 íum { 
	gDECIMAL_DIGITS_PER_UINT64_T
 = (Ë(1 + 2.41 * (
uöt64_t
)) };

1055 
	gvioBlockNumbîDumpBuf„r
[("P L D")

1056 + 3 * 
DECIMAL_DIGITS_PER_UINT64_T
];

1057 i‡(
	gd©aVIO
->
	gisDu∂iˇã
) {

1058 
¢¥ötf
(
vioBlockNumbîDumpBuf„r
, (vioBlockNumberDumpBuffer),

1059 "P%" 
PRIu64
 " L%" PRIu64 " D%" PRIu64,

1060 
gëD©aVIOAŒoˇti⁄
(
d©aVIO
), d©aVIO->
logiˇl
.
lbn
,

1061 
d©aVIO
->
du∂iˇã
.
pbn
);

1062 } i‡(
hasAŒoˇti⁄
(
d©aVIO
)) {

1063 
¢¥ötf
(
vioBlockNumbîDumpBuf„r
, (vioBlockNumberDumpBuffer),

1064 "P%" 
PRIu64
 " L%" PRIu64,

1065 
gëD©aVIOAŒoˇti⁄
(
d©aVIO
), d©aVIO->
logiˇl
.
lbn
);

1067 
¢¥ötf
(
vioBlockNumbîDumpBuf„r
, (vioBlockNumberDumpBuffer),

1068 "L%" 
PRIu64
,

1069 
d©aVIO
->
logiˇl
.
lbn
);

1072 
	gvioFlushGíî©i⁄Buf„r
[(" FG")

1073 + 
DECIMAL_DIGITS_PER_UINT64_T
] = "";

1074 i‡(
	gd©aVIO
->
	gÊushGíî©i⁄
 != 0) {

1075 
¢¥ötf
(
vioFlushGíî©i⁄Buf„r
, (vioFlushGenerationBuffer),

1076 " FG%" 
PRIu64
, 
d©aVIO
->
ÊushGíî©i⁄
);

1080 
	gÊagsDumpBuf„r
[8];

1081 
ícodeVIODumpFœgs
(
d©aVIO
, 
ÊagsDumpBuf„r
);

1083 
logInfo
(" kvio %p %s%s %s %s%s",

1084 
d©aKVIO
, 
vioBlockNumbîDumpBuf„r
, 
vioFlushGíî©i⁄Buf„r
,

1085 
gëO≥øti⁄Name
(
d©aVIO
), 
vioW‹kIãmDumpBuf„r
, 
ÊagsDumpBuf„r
);

1089 
dumpVIOWaôîs
(&
d©aVIO
->
logiˇl
.
waôîs
, "lbn");

1090 i‡(
	gd©aVIO
->
	gÆloˇtögVIO
.
	gwrôeLock
 !
NULL
) {

1091 
dumpVIOWaôîs
(&
d©aVIO
->
ÆloˇtögVIO
.
wrôeLock
->
waôîs
, "pbn write");

1093 i‡(
	gd©aVIO
->
	gdu∂iˇãLock
 !
NULL
) {

1094 
dumpVIOWaôîs
(&
d©aVIO
->
du∂iˇãLock
->
waôîs
, "pbnÑead");

1096 
dumpVIOWaôîs
(&
d©aVIO
->
lockRëryWaôîs
, "pbnÑeadÑetry");

1102 
	$makeD©aKVIOBuf„rPoﬁ
(
Kî√lLayî
 *
œyî
,

1103 
uöt32_t
 
poﬁSize
,

1104 
Buf„rPoﬁ
 **
buf„rPoﬁPå
)

1106  
	`makeBuf„rPoﬁ
("D©aKVIO Poﬁ", 
poﬁSize
,

1107 
makePoﬁedD©aKVIO
, 
‰ìPoﬁedD©aKVIO
,

1108 
dumpPoﬁedD©aKVIO
, 
œyî
, 
buf„rPoﬁPå
);

1109 
	}
}

1112 
	$gëDedu≥Mëad©a
(c⁄° 
Dedu≥C⁄ãxt
 *
c⁄ãxt
,

1113 
BlockM≠pögSèã
 *
m≠pögSèã
,

1114 
PhysiˇlBlockNumbî
 *
pbn
)

1116 
D©aKVIO
 *
d©aKVIO
 = 
	`c⁄èöî_of
(
c⁄ãxt
, D©aKVIO, 
dedu≥C⁄ãxt
);

1117 *
m≠pögSèã
 = 
d©aKVIO
->
d©aVIO
.
√wM≠≥d
.
°©e
;

1118 *
pbn
 = 
d©aKVIO
->
d©aVIO
.
√wM≠≥d
.pbn;

1119 
	}
}

1122 
	$£tDedu≥Advi˚
(
Dedu≥C⁄ãxt
 *
c⁄ãxt
, c⁄° 
D©aLoˇti⁄
 *
advi˚
)

1124 
D©aKVIO
 *
d©aKVIO
 = 
	`c⁄èöî_of
(
c⁄ãxt
, D©aKVIO, 
dedu≥C⁄ãxt
);

1125 
	`ª˚iveDedu≥Advi˚
(&
d©aKVIO
->
d©aVIO
, 
advi˚
);

1126 
	}
}

	@vdo/kernel/dataKVIO.h

22 #i‚de‡
DATA_KVIO_H


23 
	#DATA_KVIO_H


	)

25 
	~"d©aVIO.h
"

26 
	~"kvio.h
"

27 
	~"uds-block.h
"

35 
BIO
 *
	mbio
;

38 *
	m¥iv©e
;

39 *
	mídIO
;

42 
	mrw
;

43 } 
	tExã∫ÆIOReque°
;

46 
	sdedu≥C⁄ãxt
 {

47 
UdsReque°
 
	mudsReque°
;

48 
li°_hód
 
	m≥ndögLi°
;

49 
Jiffõs
 
	msubmissi⁄Time
;

50 
Atomic32
 
	mªque°Sèã
;

51 
	m°©us
;

52 
boﬁ
 
	misPídög
;

54 c⁄° 
UdsChunkName
 *
	mchunkName
;

65 *
	md©a
;

70 *
	mbuf„r
;

75 
BIO
 *
	mbio
;

79 
D©aKVIOCÆlback
 
	mˇŒback
;

84 
PhysiˇlBlockNumbî
 
	mpbn
;

89 
BlockM≠pögSèã
 
	mm≠pögSèã
;

96 
BioQA˘i⁄
 
	ma˘i⁄
;

100 
	m°©us
;

104 
RódCacheE¡ry
 *
	mˇcheE¡ry
;

105 } 
	tRódBlock
;

107 
	sd©aKVIO
 {

109 
D©aVIO
 
	md©aVIO
;

111 
KVIO
 
	mkvio
;

113 
Exã∫ÆIOReque°
 
	mexã∫ÆIOReque°
;

115 
Dedu≥C⁄ãxt
 
	mdedu≥C⁄ãxt
;

117 
RódBlock
 
	mªadBlock
;

119 
BlockSize
 
	moff£t
;

120 
boﬁ
 
	misP¨tül
;

122 
boﬁ
 
	mhasDisˇrdPîmô
;

123 
DisˇrdSize
 
	mªmaöögDisˇrd
;

132 *
	md©aBlock
;

134 
BIO
 *
	md©aBlockBio
;

136 *
	ms¸©chBlock
;

146 
ölöe
 
D©aKVIO
 *
	$kvioAsD©aKVIO
(
KVIO
 *
kvio
)

148 
	`ASSERT_LOG_ONLY
(
	`isD©a
(
kvio
), "KVIO isá DataKVIO");

149  
	`c⁄èöî_of
(
kvio
, 
D©aKVIO
, kvio);

150 
	}
}

159 
ölöe
 
KVIO
 *
	$d©aKVIOAsKVIO
(
D©aKVIO
 *
d©aKVIO
)

161  &
d©aKVIO
->
kvio
;

162 
	}
}

171 
ölöe
 
D©aKVIO
 *
	$d©aVIOAsD©aKVIO
(
D©aVIO
 *
d©aVIO
)

173  
	`c⁄èöî_of
(
d©aVIO
, 
D©aKVIO
, dataVIO);

174 
	}
}

183 
ölöe
 
KVIO
 *
	$d©aVIOAsKVIO
(
D©aVIO
 *
d©aVIO
)

185  
	`d©aKVIOAsKVIO
(
	`d©aVIOAsD©aKVIO
(
d©aVIO
));

186 
	}
}

195 
ölöe
 
D©aKVIO
 *
	$w‹kIãmAsD©aKVIO
(
KvdoW‹kIãm
 *
ôem
)

197  
	`kvioAsD©aKVIO
(
	`w‹kIãmAsKVIO
(
ôem
));

198 
	}
}

207 
ölöe
 
KvdoW‹kIãm
 *
	$w‹kIãmFromD©aKVIO
(
D©aKVIO
 *
d©aKVIO
)

209  &
	`d©aKVIOAsKVIO
(
d©aKVIO
)->
íqueuóbÀ
.
w‹kIãm
;

210 
	}
}

219 
ölöe
 
BIO
 *
	$gëBIOFromD©aKVIO
(
D©aKVIO
 *
d©aKVIO
)

221  
	`d©aKVIOAsKVIO
(
d©aKVIO
)->
bio
;

222 
	}
}

231 
ölöe
 
Kî√lLayî
 *
	$gëLayîFromD©aKVIO
(
D©aKVIO
 *
d©aKVIO
)

233  
	`d©aKVIOAsKVIO
(
d©aKVIO
)->
œyî
;

234 
	}
}

245 
ölöe
 
	$íqueueD©aKVIO
(
D©aKVIO
 *
d©aKVIO
,

246 
KvdoW‹kFun˘i⁄
 
w‹k
,

247 *
°©sFun˘i⁄
,

248 
a˘i⁄
)

250 
	`íqueueKVIO
(
	`d©aKVIOAsKVIO
(
d©aKVIO
), 
w‹k
, 
°©sFun˘i⁄
, 
a˘i⁄
);

251 
	}
}

259 
ölöe
 
	$íqueueD©aKVIOW‹k
(
KvdoW‹kQueue
 *
queue
,

260 
D©aKVIO
 *
d©aKVIO
)

262 
	`íqueueKVIOW‹k
(
queue
, 
	`d©aKVIOAsKVIO
(
d©aKVIO
));

263 
	}
}

271 
ölöe
 
	$d©aKVIOAddTø˚Rec‹d
(
D©aKVIO
 *
d©aKVIO
,

272 
Tø˚Loˇti⁄
 
loˇti⁄
)

274 
	`d©aVIOAddTø˚Rec‹d
(&
d©aKVIO
->
d©aVIO
, 
loˇti⁄
);

275 
	}
}

285 
ölöe
 
	$œunchD©aKVIOOnCPUQueue
(
D©aKVIO
 *
d©aKVIO
,

286 
KvdoW‹kFun˘i⁄
 
w‹k
,

287 *
°©sFun˘i⁄
,

288 
a˘i⁄
)

290 
KVIO
 *
kvio
 = 
	`d©aKVIOAsKVIO
(
d©aKVIO
);

291 
	`œunchKVIO
(
kvio
, 
w‹k
, 
°©sFun˘i⁄
, 
a˘i⁄
, kvio->
œyî
->
˝uQueue
);

292 
	}
}

302 
ölöe
 
	$œunchD©aKVIOOnBIOAckQueue
(
D©aKVIO
 *
d©aKVIO
,

303 
KvdoW‹kFun˘i⁄
 
w‹k
,

304 *
°©sFun˘i⁄
,

305 
a˘i⁄
)

307 
KVIO
 *
kvio
 = 
	`d©aKVIOAsKVIO
(
d©aKVIO
);

308 
	`œunchKVIO
(
kvio
, 
w‹k
, 
°©sFun˘i⁄
, 
a˘i⁄
, kvio->
œyî
->
bioAckQueue
);

309 
	}
}

316 
ölöe
 
	$kvdoEnqueueD©aVIOCÆlback
(
D©aKVIO
 *
d©aKVIO
)

318 
	`kvdoEnqueueVIOCÆlback
(
	`d©aKVIOAsKVIO
(
d©aKVIO
));

319 
	}
}

338 
	$kvdoLaunchD©aKVIOFromBio
(
Kî√lLayî
 *
œyî
,

339 
BIO
 *
bio
,

340 
Jiffõs
 
¨rivÆTime
,

341 
boﬁ
 
hasDisˇrdPîmô
)

342 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

352 
	`ªtu∫D©aKVIOB©chToPoﬁ
(
B©chPro˚ss‹
 *
b©ch
, *
˛osuª
);

359 
	`kvdoZîoD©aVIO
(
D©aVIO
 *
d©aVIO
);

369 
boﬁ
 
	$kvdoCom∑ªD©aVIOs
(
D©aVIO
 *
fú°
, D©aVIO *
£c⁄d
)

370 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

378 
	`kvdoC›yD©aVIO
(
D©aVIO
 *
sour˚
, D©aVIO *
de°ö©i⁄
);

385 
	`kvdoRódD©aVIO
(
D©aVIO
 *
d©aVIO
);

392 
	`kvdoWrôeD©aVIO
(
D©aVIO
 *
d©aVIO
);

399 
	`kvdoModifyWrôeD©aVIO
(
D©aVIO
 *
d©aVIO
);

406 
	`kvdoHashD©aVIO
(
D©aVIO
 *
d©aVIO
);

413 
	`kvdoCheckF‹Du∂iˇti⁄
(
D©aVIO
 *
d©aVIO
);

420 
	`kvdoAcknowÀdgeD©aVIO
(
D©aVIO
 *
d©aVIO
);

427 
	`kvdoCom¥essD©aVIO
(
D©aVIO
 *
d©aVIO
);

434 
	`kvdoUpd©eDedu≥Advi˚
(
D©aVIO
 *
d©aVIO
);

445 
	$makeD©aKVIOBuf„rPoﬁ
(
Kî√lLayî
 *
œyî
,

446 
uöt32_t
 
poﬁSize
,

447 
Buf„rPoﬁ
 **
buf„rPoﬁPå
)

448 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

458 
	`gëDedu≥Mëad©a
(c⁄° 
Dedu≥C⁄ãxt
 *
c⁄ãxt
,

459 
BlockM≠pögSèã
 *
m≠pögSèã
,

460 
PhysiˇlBlockNumbî
 *
pbn
);

470 
	`£tDedu≥Advi˚
(
Dedu≥C⁄ãxt
 *
c⁄ãxt
, c⁄° 
D©aLoˇti⁄
 *
advi˚
);

	@vdo/kernel/deadlockQueue.c

22 
	~"dódlockQueue.h
"

25 
	$öôülizeDódlockQueue
(
DódlockQueue
 *
queue
)

27 
	`•ö_lock_öô
(&
queue
->
lock
);

28 
	`bio_li°_öô
(&
queue
->
li°
);

29 
	}
}

32 
	$addToDódlockQueue
(
DódlockQueue
 *
queue
, 
BIO
 *
bio
, 
Jiffõs
 
¨rivÆTime
)

34 
	`•ö_lock
(&
queue
->
lock
);

35 i‡(
	`bio_li°_em±y
(&
queue
->
li°
)) {

41 
queue
->
¨rivÆTime
 =árrivalTime;

43 
	`bio_li°_add
(&
queue
->
li°
, 
bio
);

44 
	`•ö_u∆ock
(&
queue
->
lock
);

45 
	}
}

	@vdo/kernel/deadlockQueue.h

22 #i‚de‡
DEADLOCK_QUEUE_H


23 
	#DEADLOCK_QUEUE_H


	)

25 
	~<löux/kî√l.h
>

27 
	~"bio.h
"

33 
	sdódlockQueue
 {

35 
•ölock_t
 
	mlock
;

37 
bio_li°
 
	mli°
;

42 
Jiffõs
 
	m¨rivÆTime
;

43 } 
	tDódlockQueue
;

50 
öôülizeDódlockQueue
(
DódlockQueue
 *
queue
);

64 
addToDódlockQueue
(
DódlockQueue
 *
queue
, 
BIO
 *
bio
, 
Jiffõs
 
¨rivÆTime
);

78 
ölöe
 
BIO
 *
	$pﬁlDódlockQueue
(
DódlockQueue
 *
queue
,

79 
Jiffõs
 *
¨rivÆTime
)

81 
	`•ö_lock
(&
queue
->
lock
);

82 
BIO
 *
bio
 = 
	`bio_li°_p›
(&
queue
->
li°
);

83 i‡(
	`u∆ikñy
(
bio
 !
NULL
)) {

84 *
¨rivÆTime
 = 
queue
->arrivalTime;

86 
	`•ö_u∆ock
(&
queue
->
lock
);

87  
bio
;

88 
	}
}

	@vdo/kernel/dedupeIndex.c

22 
	~"dedu≥Index.h
"

24 
	~"numîic.h
"

26 
	~"udsIndex.h
"

29 
	gÆbúeoTimeoutI¡îvÆ
 = 5000;

30 
	gmöAlbúeoTimîI¡îvÆ
 = 100;

33 
Jiffõs
 
	gÆbúeoTimeoutJiffõs
 = 0;

34 
Jiffõs
 
	gmöAlbúeoTimîJiffõs
 = 0;

37 
Jiffõs
 
	$gëAlbúeoTimeout
(
Jiffõs
 
°¨tJiffõs
)

39  
	`maxUL⁄g
(
°¨tJiffõs
 + 
ÆbúeoTimeoutJiffõs
,

40 
jiffõs
 + 
möAlbúeoTimîJiffõs
);

41 
	}
}

44 
	$£tAlbúeoTimeoutI¡îvÆ
(
vÆue
)

47 i‡(
vÆue
 > 120000) {

48 
vÆue
 = 120000;

51 
Jiffõs
 
ÆbJiffõs
 = 
	`m£cs_to_jiffõs
(
vÆue
);

52 i‡(
ÆbJiffõs
 < 2) {

53 
ÆbJiffõs
 = 2;

54 
vÆue
 = 
	`jiffõs_to_m£cs
(
ÆbJiffõs
);

56 
ÆbúeoTimeoutI¡îvÆ
 = 
vÆue
;

57 
ÆbúeoTimeoutJiffõs
 = 
ÆbJiffõs
;

58 
	}
}

61 
	$£tMöAlbúeoTimîI¡îvÆ
(
vÆue
)

64 i‡(
vÆue
 > 1000) {

65 
vÆue
 = 1000;

69 
Jiffõs
 
möJiffõs
 = 
	`m£cs_to_jiffõs
(
vÆue
);

70 i‡(
möJiffõs
 < 2) {

71 
möJiffõs
 = 2;

72 
vÆue
 = 
	`jiffõs_to_m£cs
(
möJiffõs
);

75 
möAlbúeoTimîI¡îvÆ
 = 
vÆue
;

76 
möAlbúeoTimîJiffõs
 = 
möJiffõs
;

77 
	}
}

80 
	$makeDedu≥Index
(
Dedu≥Index
 **
ödexPå
, 
Kî√lLayî
 *
œyî
)

82 i‡(
ÆbúeoTimeoutJiffõs
 == 0) {

83 
	`£tAlbúeoTimeoutI¡îvÆ
(
ÆbúeoTimeoutI¡îvÆ
);

86 i‡(
möAlbúeoTimîJiffõs
 == 0) {

87 
	`£tMöAlbúeoTimîI¡îvÆ
(
möAlbúeoTimîI¡îvÆ
);

90  
	`makeUDSIndex
(
œyî
, 
ödexPå
);

91 
	}
}

	@vdo/kernel/dedupeIndex.h

22 #i‚de‡
DEDUPE_INDEX_H


23 
	#DEDUPE_INDEX_H


	)

25 
	~"d©aVIO.h
"

27 
	~"d©aKVIO.h
"

29 
	sdedu≥Index
 {

37 (*
	mdump
)(
Dedu≥Index
 *
	mödex
, 
boﬁ
 
	mshowQueue
);

45 (*
	m‰ì
)(
Dedu≥Index
 *
	mödex
);

54 c⁄° *(*
	mgëDedu≥SèãName
)(
Dedu≥Index
 *
	mödex
);

63 (*
	mgëMaximumOut°™dög
)(
Dedu≥Index
 *
	mödex
);

72 (*
	mgëNumbîOut°™dög
)(
Dedu≥Index
 *
	mödex
);

82 (*
	mmesßge
)(
Dedu≥Index
 *
	mödex
, c⁄° *
	m«me
);

91 (*
	mpo°
)(
D©aKVIO
 *
	md©aKVIO
);

99 (*
	mquîy
)(
D©aKVIO
 *
	md©aKVIO
);

106 (*
	m°¨t
)(
Dedu≥Index
 *
	mödex
);

114 (*
	m°›
)(
Dedu≥Index
 *
	mödex
);

123 (*
	mföish
)(
Dedu≥Index
 *
	mödex
);

131 (*
	mupd©e
)(
D©aKVIO
 *
	md©aKVIO
);

142 
	$makeDedu≥Index
(
Dedu≥Index
 **
ödexPå
, 
Kî√lLayî
 *
œyî
)

143 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

152 
ölöe
 
	$dumpDedu≥Index
(
Dedu≥Index
 *
ödex
, 
boﬁ
 
showQueue
)

154 
ödex
->
	`dump
(ödex, 
showQueue
);

155 
	}
}

162 
ölöe
 
	$‰ìDedu≥Index
(
Dedu≥Index
 **
ödex
)

164 i‡(*
ödex
 !
NULL
) {

165 (*
ödex
)->
	`‰ì
(*index);

166 *
ödex
 = 
NULL
;

168 
	}
}

177 
ölöe
 c⁄° *
	$gëDedu≥SèãName
(
Dedu≥Index
 *
ödex
)

179  
ödex
->
	`gëDedu≥SèãName
(index);

180 
	}
}

189 
ölöe
 
	$gëMaximumOut°™dög
(
Dedu≥Index
 *
ödex
)

191  
ödex
->
	`gëMaximumOut°™dög
(index);

192 
	}
}

201 
ölöe
 
	$gëNumbîOut°™dög
(
Dedu≥Index
 *
ödex
)

203  
ödex
->
	`gëNumbîOut°™dög
(index);

204 
	}
}

211 
ölöe
 
	$övokeDedu≥CÆlback
(
D©aKVIO
 *
d©aKVIO
)

214 
	`d©aKVIOAddTø˚Rec‹d
(
d©aKVIO
, 
	`THIS_LOCATION
("$F($dup);cb=dedupe($dup)"));

215 
	`kvdoEnqueueD©aVIOCÆlback
(
d©aKVIO
);

216 
	}
}

226 
ölöe
 
	$mesßgeDedu≥Index
(
Dedu≥Index
 *
ödex
, c⁄° *
«me
)

228  
ödex
->
	`mesßge
(ödex, 
«me
);

229 
	}
}

245 
ölöe
 
	$po°Dedu≥Advi˚
(
D©aKVIO
 *
d©aKVIO
)

247 
Kî√lLayî
 *
œyî
 = 
	`d©aKVIOAsKVIO
(
d©aKVIO
)->layer;

248 
d©aKVIO
->
d©aVIO
.
isDu∂iˇã
 = 
Ál£
;

249 
œyî
->
dedu≥Index
->
	`po°
(
d©aKVIO
);

250 
	}
}

264 
ölöe
 
	$quîyDedu≥Advi˚
(
D©aKVIO
 *
d©aKVIO
)

266 
Kî√lLayî
 *
œyî
 = 
	`d©aKVIOAsKVIO
(
d©aKVIO
)->layer;

267 
œyî
->
dedu≥Index
->
	`quîy
(
d©aKVIO
);

268 
	}
}

275 
ölöe
 
	$°¨tDedu≥Index
(
Dedu≥Index
 *
ödex
)

277 
ödex
->
	`°¨t
(index);

278 
	}
}

286 
ölöe
 
	$°›Dedu≥Index
(
Dedu≥Index
 *
ödex
)

288  
ödex
->
	`°›
(index);

289 
	}
}

296 
ölöe
 
	$föishDedu≥Index
(
Dedu≥Index
 *
ödex
)

298  
ödex
->
	`föish
(index);

299 
	}
}

311 
ölöe
 
	$upd©eDedu≥Advi˚
(
D©aKVIO
 *
d©aKVIO
)

313 
Kî√lLayî
 *
œyî
 = 
	`d©aKVIOAsKVIO
(
d©aKVIO
)->layer;

314 
œyî
->
dedu≥Index
->
	`upd©e
(
d©aKVIO
);

315 
	}
}

319 
ÆbúeoTimeoutI¡îvÆ
;

320 
Jiffõs
 
ÆbúeoTimeoutJiffõs
;

324 
möAlbúeoTimîI¡îvÆ
;

334 
Jiffõs
 
gëAlbúeoTimeout
(Jiffõ†
°¨tJiffõs
);

342 
£tAlbúeoTimeoutI¡îvÆ
(
vÆue
);

350 
£tMöAlbúeoTimîI¡îvÆ
(
vÆue
);

	@vdo/kernel/deviceConfig.c

22 
	~"devi˚C⁄fig.h
"

24 
	~"loggî.h
"

25 
	~"mem‹yAŒoc.h
"

26 
	~"°rögUtûs.h
"

28 
	~"vdoSåögUtûs.h
"

31 
	mREQUIRED_ARGC
 = 10,

32 
	mPOOL_NAME_ARG_INDEX
 = 8,

34 
	mTHREAD_COUNT_LIMIT
 = 100,

35 
	mBIO_ROTATION_INTERVAL_LIMIT
 = 1024,

41 
	mDEFAULT_NUM_BIO_SUBMIT_QUEUES
 = 4,

43 
	mDEFAULT_BIO_SUBMIT_QUEUE_ROTATE_INTERVAL
 = 64,

47 
	$gëPoﬁNameFromArgv
(
¨gc
,

48 **
¨gv
,

49 **
îr‹På
,

50 **
poﬁNamePå
)

52 i‡(
¨gc
 !
REQUIRED_ARGC
) {

53 *
îr‹På
 = "IncorrectÇumber ofárguments";

54  
VDO_BAD_CONFIGURATION
;

56 *
poﬁNamePå
 = 
¨gv
[
POOL_NAME_ARG_INDEX
];

57  
VDO_SUCCESS
;

58 
	}
}

70 
__©åibuã__
((
w¨n_unu£d_ªsu…
))

71 
ölöe
 
	$∑r£Boﬁ
(c⁄° *
boﬁSå
,

72 c⁄° *
åueSå
,

73 c⁄° *
Ál£Så
,

74 
boﬁ
 *
boﬁPå
)

76 
boﬁ
 
vÆue
 = 
Ál£
;

77 i‡(!
	`°rcmp
(
boﬁSå
, 
åueSå
)) {

78 
vÆue
 = 
åue
;

79 } i‡(!
	`°rcmp
(
boﬁSå
, 
Ál£Så
)) {

80 
vÆue
 = 
Ál£
;

82  
VDO_BAD_CONFIGURATION
;

85 *
boﬁPå
 = 
vÆue
;

86  
VDO_SUCCESS
;

87 
	}
}

102 
	$¥o˚ssO√ThªadC⁄figS≥c
(c⁄° *
thªadP¨amTy≥
,

103 
cou¡
,

104 
ThªadCou¡C⁄fig
 *
c⁄fig
)

107 i‡(
	`°rcmp
(
thªadP¨amTy≥
, "bioRotationInterval") == 0) {

108 i‡(
cou¡
 == 0) {

109 
	`logEº‹
("thread config stringÉrror:"

111  -
EINVAL
;

112 } i‡(
cou¡
 > 
BIO_ROTATION_INTERVAL_LIMIT
) {

113 
	`logEº‹
("thread config stringÉrror:"

115 
BIO_ROTATION_INTERVAL_LIMIT
);

116  -
EINVAL
;

118 
c⁄fig
->
bioRŸ©i⁄I¡îvÆ
 = 
cou¡
;

119  
VDO_SUCCESS
;

122 i‡(
cou¡
 > 
THREAD_COUNT_LIMIT
) {

123 
	`logEº‹
("thread config stringÉrror:át most %d '%s'Åhreads"

125 
THREAD_COUNT_LIMIT
, 
thªadP¨amTy≥
);

126  -
EINVAL
;

129 i‡(
	`°rcmp
(
thªadP¨amTy≥
, "cpu") == 0) {

130 i‡(
cou¡
 == 0) {

131 
	`logEº‹
("thread config stringÉrror:"

133  -
EINVAL
;

135 
c⁄fig
->
˝uThªads
 = 
cou¡
;

136  
VDO_SUCCESS
;

137 } i‡(
	`°rcmp
(
thªadP¨amTy≥
, "ack") == 0) {

138 
c⁄fig
->
bioAckThªads
 = 
cou¡
;

139  
VDO_SUCCESS
;

140 } i‡(
	`°rcmp
(
thªadP¨amTy≥
, "bio") == 0) {

141 i‡(
cou¡
 == 0) {

142 
	`logEº‹
("thread config stringÉrror:"

144  -
EINVAL
;

146 
c⁄fig
->
bioThªads
 = 
cou¡
;

147  
VDO_SUCCESS
;

148 } i‡(
	`°rcmp
(
thªadP¨amTy≥
, "logical") == 0) {

149 
c⁄fig
->
logiˇlZ⁄es
 = 
cou¡
;

150  
VDO_SUCCESS
;

151 } i‡(
	`°rcmp
(
thªadP¨amTy≥
, "physical") == 0) {

152 
c⁄fig
->
physiˇlZ⁄es
 = 
cou¡
;

153  
VDO_SUCCESS
;

154 } i‡(
	`°rcmp
(
thªadP¨amTy≥
, "hash") == 0) {

155 
c⁄fig
->
hashZ⁄es
 = 
cou¡
;

156  
VDO_SUCCESS
;

161 
	`logEº‹
("unknow¿thªadÖ¨amëîÅy≥ \"%s\"", 
thªadP¨amTy≥
);

162  -
EINVAL
;

163 
	}
}

172 
	$∑r£O√ThªadC⁄figS≥c
(c⁄° *
•ec
,

173 
ThªadCou¡C⁄fig
 *
c⁄fig
)

175 **
fõlds
;

176 
ªsu…
 = 
	`•lôSåög
(
•ec
, '=', &
fõlds
);

177 i‡(
ªsu…
 !
UDS_SUCCESS
) {

178  
ªsu…
;

180 i‡((
fõlds
[0] =
NULL
) || (fields[1] == NULL) || (fields[2] != NULL)) {

181 
	`logEº‹
("thread config stringÉrror:"

183 
•ec
);

184 
	`‰ìSåögAºay
(
fõlds
);

185  -
EINVAL
;

187 
cou¡
;

188 *
°rögEnd
;

189 
ªsu…
 = 
	`°rögToUI¡
(
fõlds
[1], &
°rögEnd
, &
cou¡
);

190 i‡(
ªsu…
 !
UDS_SUCCESS
) {

191 
	`logEº‹
("thread config stringÉrror: integer valueÇeeded, found \"%s\"",

192 
fõlds
[1]);

193 
	`‰ìSåögAºay
(
fõlds
);

194  
ªsu…
;

196 i‡(*
°rögEnd
 != 0) {

197 
	`logEº‹
("thread config stringÉrror: invalidÇumeric spec \"%s\"",

198 
fõlds
[1]);

199 
	`‰ìSåögAºay
(
fõlds
);

200  -
EINVAL
;

203 
ªsu…
 = 
	`¥o˚ssO√ThªadC⁄figS≥c
(
fõlds
[0], 
cou¡
, 
c⁄fig
);

204 
	`‰ìSåögAºay
(
fõlds
);

205  
ªsu…
;

206 
	}
}

229 
	$∑r£ThªadC⁄figSåög
(c⁄° *
°rög
,

230 
ThªadCou¡C⁄fig
 *
c⁄fig
)

232 **
•ecs
;

233 
ªsu…
 = 
	`•lôSåög
(
°rög
, ',', &
•ecs
);

234 i‡(
ªsu…
 !
UDS_SUCCESS
) {

235  
ªsu…
;

237 
i
 = 0; 
•ecs
[i] !
NULL
; i++) {

238 
ªsu…
 = 
	`∑r£O√ThªadC⁄figS≥c
(
•ecs
[
i
], 
c⁄fig
);

239 i‡(
ªsu…
 !
VDO_SUCCESS
) {

243 
	`‰ìSåögAºay
(
•ecs
);

244  
ªsu…
;

245 
	}
}

254 
	$h™dÀP¨£Eº‹
(
Devi˚C⁄fig
 **
c⁄figPå
,

255 **
îr‹På
,

256 *
îr‹Så
)

258 
	`‰ìDevi˚C⁄fig
(
c⁄figPå
);

259 *
îr‹På
 = 
îr‹Så
;

260 
	}
}

263 
	$∑r£Devi˚C⁄fig
(
¨gc
,

264 **
¨gv
,

265 **
îr‹På
,

266 
Devi˚C⁄fig
 **
c⁄figPå
)

268 
Devi˚C⁄fig
 *
c⁄fig
 = 
NULL
;

269 i‡(
¨gc
 !
REQUIRED_ARGC
) {

270 
	`h™dÀP¨£Eº‹
(&
c⁄fig
, 
îr‹På
, "IncorrectÇumber ofárguments");

271  
VDO_BAD_CONFIGURATION
;

274 
ªsu…
 = 
	`ALLOCATE
(1, 
Devi˚C⁄fig
, "Devi˚C⁄fig", &
c⁄fig
);

275 i‡(
ªsu…
 !
VDO_SUCCESS
) {

276 
	`h™dÀP¨£Eº‹
(&
c⁄fig
, 
îr‹På
, "CouldÇotállocate config structure");

277  
VDO_BAD_CONFIGURATION
;

281 
ªsu…
 = 
	`joöSåögs
(
¨gv
, 
¨gc
, ' ', &
c⁄fig
->
‹igöÆSåög
);

282 i‡(
ªsu…
 !
VDO_SUCCESS
) {

283 
	`h™dÀP¨£Eº‹
(&
c⁄fig
, 
îr‹På
, "CouldÇotÖopulate string");

284  
VDO_BAD_CONFIGURATION
;

296 
c⁄fig
->
thªadCou¡s
 = (
ThªadCou¡C⁄fig
) {

297 .
bioAckThªads
 = 1,

298 .
bioThªads
 = 
DEFAULT_NUM_BIO_SUBMIT_QUEUES
,

299 .
bioRŸ©i⁄I¡îvÆ
 = 
DEFAULT_BIO_SUBMIT_QUEUE_ROTATE_INTERVAL
,

300 .
˝uThªads
 = 1,

301 .
logiˇlZ⁄es
 = 0,

302 .
physiˇlZ⁄es
 = 0,

303 .
hashZ⁄es
 = 0,

306 **
¨gumítPå
 = 
¨gv
;

308 
ªsu…
 = 
	`du∂iˇãSåög
(*
¨gumítPå
++, "parent deviceÇame",

309 &
c⁄fig
->
∑ª¡Devi˚Name
);

310 i‡(
ªsu…
 !
VDO_SUCCESS
) {

311 
	`h™dÀP¨£Eº‹
(&
c⁄fig
, 
îr‹På
, "CouldÇot copyÖarent deviceÇame");

312  
VDO_BAD_CONFIGURATION
;

316 
boﬁ
 
íabÀ512e
;

317 
ªsu…
 = 
	`∑r£Boﬁ
(*
¨gumítPå
++, "512", "4096", &
íabÀ512e
);

318 i‡(
ªsu…
 !
VDO_SUCCESS
) {

319 
	`h™dÀP¨£Eº‹
(&
c⁄fig
, 
îr‹På
, "InvalidÜogical block size");

320  
VDO_BAD_CONFIGURATION
;

322 
c⁄fig
->
logiˇlBlockSize
 = (
íabÀ512e
 ? 512 : 4096);

325 
ªsu…
 = 
	`∑r£Boﬁ
(*
¨gumítPå
++, "enabled", "disabled",

326 &
c⁄fig
->
ªadCacheE«bÀd
);

327 i‡(
ªsu…
 !
VDO_SUCCESS
) {

328 
	`h™dÀP¨£Eº‹
(&
c⁄fig
, 
îr‹På
, "InvalidÑead cache mode");

329  
VDO_BAD_CONFIGURATION
;

333 i‡(
	`ssˇnf
(*
¨gumítPå
++, "%u", &
c⁄fig
->
ªadCacheExåaBlocks
) != 1) {

334 
	`h™dÀP¨£Eº‹
(&
c⁄fig
, 
îr‹På
,

336  
VDO_BAD_CONFIGURATION
;

340 i‡(
	`ssˇnf
(*
¨gumítPå
++, "%u", &
c⁄fig
->
ˇcheSize
) != 1) {

341 
	`h™dÀP¨£Eº‹
(&
c⁄fig
, 
îr‹På
, "Invalid block mapÖage cache size");

342  
VDO_BAD_CONFIGURATION
;

346 i‡(
	`ssˇnf
(*
¨gumítPå
++, "%u", &
c⁄fig
->
blockM≠MaximumAge
) != 1) {

347 
	`h™dÀP¨£Eº‹
(&
c⁄fig
, 
îr‹På
, "Invalid block map maximumáge");

348  
VDO_BAD_CONFIGURATION
;

352 
ªsu…
 = 
	`∑r£Boﬁ
(*
¨gumítPå
++, "on", "off",

353 &
c⁄fig
->
mdRaid5ModeE«bÀd
);

354 i‡(
ªsu…
 !
VDO_SUCCESS
) {

355 
	`h™dÀP¨£Eº‹
(&
c⁄fig
, 
îr‹På
, "Invalid MD RAID5 mode");

356  
VDO_BAD_CONFIGURATION
;

360 
boﬁ
 
pﬁicyAsync
;

361 
ªsu…
 = 
	`∑r£Boﬁ
(*
¨gumítPå
++, "async", "sync", &
pﬁicyAsync
);

362 i‡(
ªsu…
 !
VDO_SUCCESS
) {

363 
	`h™dÀP¨£Eº‹
(&
c⁄fig
, 
îr‹På
, "Invalid writeÖolicy");

364  
VDO_BAD_CONFIGURATION
;

366 
c⁄fig
->
wrôePﬁicy
 = (
pﬁicyAsync
 ? 
WRITE_POLICY_ASYNC
 : 
WRITE_POLICY_SYNC
);

368 i‡(
¨gumítPå
 !&
¨gv
[
POOL_NAME_ARG_INDEX
]) {

369 
	`h™dÀP¨£Eº‹
(&
c⁄fig
, 
îr‹På
, "PoolÇameÇot inÉxpectedÜocation");

370  
VDO_BAD_CONFIGURATION
;

375 
ªsu…
 = 
	`du∂iˇãSåög
(*
¨gumítPå
++, "poﬁÇame", &
c⁄fig
->
poﬁName
);

376 i‡(
ªsu…
 !
VDO_SUCCESS
) {

377 
	`h™dÀP¨£Eº‹
(&
c⁄fig
, 
îr‹På
, "CouldÇot copyÖoolÇame");

378  
VDO_BAD_CONFIGURATION
;

381 
ªsu…
 = 
	`du∂iˇãSåög
(*
¨gumítPå
++, "thread config",

382 &
c⁄fig
->
thªadC⁄figSåög
);

383 i‡(
ªsu…
 !
VDO_SUCCESS
) {

384 
	`h™dÀP¨£Eº‹
(&
c⁄fig
, 
îr‹På
, "CouldÇot copyÅhread config");

385  
VDO_BAD_CONFIGURATION
;

388 i‡(
	`°rcmp
(".", 
c⁄fig
->
thªadC⁄figSåög
) != 0) {

389 
ªsu…
 = 
	`∑r£ThªadC⁄figSåög
(
c⁄fig
->
thªadC⁄figSåög
,

390 &
c⁄fig
->
thªadCou¡s
);

391 i‡(
ªsu…
 !
VDO_SUCCESS
) {

392 
	`h™dÀP¨£Eº‹
(&
c⁄fig
, 
îr‹På
, "InvalidÅhread-count configuration");

393  
VDO_BAD_CONFIGURATION
;

402 i‡(((
c⁄fig
->
thªadCou¡s
.
logiˇlZ⁄es
 == 0)

403 !(
c⁄fig
->
thªadCou¡s
.
physiˇlZ⁄es
 == 0))

404 || ((
c⁄fig
->
thªadCou¡s
.
physiˇlZ⁄es
 == 0)

405 !(
c⁄fig
->
thªadCou¡s
.
hashZ⁄es
 == 0))

407 
	`h™dÀP¨£Eº‹
(&
c⁄fig
, 
îr‹På
,

410  
VDO_BAD_CONFIGURATION
;

413 *
c⁄figPå
 = 
c⁄fig
;

414  
ªsu…
;

415 
	}
}

418 
	$‰ìDevi˚C⁄fig
(
Devi˚C⁄fig
 **
c⁄figPå
)

420 i‡(
c⁄figPå
 =
NULL
) {

424 
Devi˚C⁄fig
 *
c⁄fig
 = *
c⁄figPå
;

425 i‡(
c⁄fig
 =
NULL
) {

426 *
c⁄figPå
 = 
NULL
;

430 
	`FREE
(
c⁄fig
->
thªadC⁄figSåög
);

431 
	`FREE
(
c⁄fig
->
poﬁName
);

432 
	`FREE
(
c⁄fig
->
∑ª¡Devi˚Name
);

433 
	`FREE
(
c⁄fig
->
‹igöÆSåög
);

435 
	`FREE
(
c⁄fig
);

436 *
c⁄figPå
 = 
NULL
;

437 
	}
}

	@vdo/kernel/deviceConfig.h

21 #i‚de‡
DEVICE_CONFIG_H


22 
	#DEVICE_CONFIG_H


	)

24 
	~"kî√lTy≥s.h
"

27 
	mba£Thªads
;

28 
	mbioAckThªads
;

29 
	mbioThªads
;

30 
	mbioRŸ©i⁄I¡îvÆ
;

31 
	m˝uThªads
;

32 
	mlogiˇlZ⁄es
;

33 
	mphysiˇlZ⁄es
;

34 
	mhashZ⁄es
;

35 } 
	tThªadCou¡C⁄fig
;

38 *
	m‹igöÆSåög
;

39 *
	m∑ª¡Devi˚Name
;

40 
	mlogiˇlBlockSize
;

41 
WrôePﬁicy
 
	mwrôePﬁicy
;

42 
	mˇcheSize
;

43 
	mblockM≠MaximumAge
;

44 
boﬁ
 
	mmdRaid5ModeE«bÀd
;

45 
boﬁ
 
	mªadCacheE«bÀd
;

46 
	mªadCacheExåaBlocks
;

47 *
	mpoﬁName
;

48 *
	mthªadC⁄figSåög
;

49 
ThªadCou¡C⁄fig
 
	mthªadCou¡s
;

50 } 
	tDevi˚C⁄fig
;

62 
	$gëPoﬁNameFromArgv
(
¨gc
,

63 **
¨gv
,

64 **
îr‹På
,

65 **
poﬁNamePå
)

66 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

78 
	$∑r£Devi˚C⁄fig
(
¨gc
,

79 **
¨gv
,

80 **
îr‹På
,

81 
Devi˚C⁄fig
 **
c⁄figPå
)

82 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

89 
	`‰ìDevi˚C⁄fig
(
Devi˚C⁄fig
 **
c⁄figPå
);

	@vdo/kernel/deviceRegistry.c

22 
	~"devi˚Regi°ry.h
"

24 
	~<löux/li°.h
>

25 
	~<löux/ty≥s.h
>

26 
	~<löux/•ölock.h
>

28 
	~"mem‹yAŒoc.h
"

35 
li°_hód
 
	mlöks
;

36 
rwlock_t
 
	mlock
;

37 } 
	tDevi˚Regi°ry
;

40 
li°_hód
 
	mlöks
;

41 *
	m«me
;

42 
Kî√lLayî
 *
	mœyî
;

43 } 
	tRegi°îedDevi˚
;

45 
Devi˚Regi°ry
 
	gªgi°ry
;

48 
	$öôülizeDevi˚Regi°ryOn˚
()

50 
	`INIT_LIST_HEAD
(&
ªgi°ry
.
löks
);

51 
	`rwlock_öô
(&
ªgi°ry
.
lock
);

52 
	}
}

62 
__©åibuã__
((
w¨n_unu£d_ªsu…
))

63 
Regi°îedDevi˚
 *
	$födLayîLocked
(*
«me
)

65 
Regi°îedDevi˚
 *
devi˚
;

66 
	`li°_f‹_óch_íåy
(
devi˚
, &
ªgi°ry
.
löks
,Üinks) {

67 i‡(
	`°rcmp
(
devi˚
->
«me
,Çame) == 0) {

68  
devi˚
;

71  
NULL
;

72 
	}
}

75 
Kî√lLayî
 *
	$gëLayîByName
(*
«me
)

77 
	`ªad_lock
(&
ªgi°ry
.
lock
);

78 
Regi°îedDevi˚
 *
devi˚
 = 
	`födLayîLocked
(
«me
);

79 
	`ªad_u∆ock
(&
ªgi°ry
.
lock
);

80 i‡(
devi˚
 =
NULL
) {

81  
NULL
;

83  
devi˚
->
œyî
;

84 
	}
}

87 
	$addLayîToDevi˚Regi°ry
(*
«me
, 
Kî√lLayî
 *
œyî
)

89 
Regi°îedDevi˚
 *
√wDevi˚
;

90 
ªsu…
 = 
	`ALLOCATE
(1, 
Regi°îedDevi˚
, 
__func__
, &
√wDevi˚
);

91 i‡(
ªsu…
 !
VDO_SUCCESS
) {

92  
ªsu…
;

95 
ªsu…
 = 
	`du∂iˇãSåög
(
«me
, "«me", &
√wDevi˚
->name);

96 i‡(
ªsu…
 !
VDO_SUCCESS
) {

97 
	`FREE
(
√wDevi˚
);

98  
ªsu…
;

101 
	`INIT_LIST_HEAD
(&
√wDevi˚
->
löks
);

102 
√wDevi˚
->
œyî
 =Üayer;

104 
	`wrôe_lock
(&
ªgi°ry
.
lock
);

105 
Regi°îedDevi˚
 *
ﬁdDevi˚
 = 
	`födLayîLocked
(
«me
);

106 
ªsu…
 = 
	`ASSERT
(
ﬁdDevi˚
 =
NULL
, "DeviceÇotálreadyÑegistered");

107 i‡(
ªsu…
 =
VDO_SUCCESS
) {

108 
	`li°_add_èû
(&
√wDevi˚
->
löks
, &
ªgi°ry
.links);

110 
	`wrôe_u∆ock
(&
ªgi°ry
.
lock
);

112  
ªsu…
;

113 
	}
}

116 
	$ªmoveLayîFromDevi˚Regi°ry
(*
«me
)

118 
	`wrôe_lock
(&
ªgi°ry
.
lock
);

119 
Regi°îedDevi˚
 *
devi˚
 = 
	`födLayîLocked
(
«me
);

120 i‡(
devi˚
 !
NULL
) {

121 
	`li°_dñ_öô
(&
devi˚
->
löks
);

122 
	`FREE
(
devi˚
->
«me
);

124 
	`wrôe_u∆ock
(&
ªgi°ry
.
lock
);

125 
	`FREE
(
devi˚
);

126 
	}
}

	@vdo/kernel/deviceRegistry.h

22 #i‚de‡
DEVICE_REGISTRY_H


23 
	#DEVICE_REGISTRY_H


	)

25 
	~"kî√lTy≥s.h
"

30 
öôülizeDevi˚Regi°ryOn˚
();

39 
Kî√lLayî
 *
	$gëLayîByName
(*
«me
)

40 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

51 
	$addLayîToDevi˚Regi°ry
(*
«me
, 
Kî√lLayî
 *
œyî
)

52 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

59 
	`ªmoveLayîFromDevi˚Regi°ry
(*
«me
);

	@vdo/kernel/dmvdo.c

22 
	~"dmvdo.h
"

24 
	~<löux/moduÀ.h
>

26 
	~"loggî.h
"

27 
	~"mem‹yAŒoc.h
"

29 
	~"c⁄°™ts.h
"

30 
	~"thªadC⁄fig.h
"

31 
	~"vdo.h
"

33 
	~"dedu≥Index.h
"

34 
	~"devi˚Regi°ry.h
"

35 
	~"dump.h
"

36 
	~"ö°™˚Numbî.h
"

37 
	~"kî√lLayî.h
"

38 
	~"kvdoFlush.h
"

39 
	~"mem‹yUßge.h
"

40 
	~"ªadCache.h
"

41 
	~"°©usProcfs.h
"

42 
	~"°rögUtûs.h
"

43 
	~"sysfs.h
"

44 
	~"thªadDevi˚.h
"

45 
	~"thªadRegi°ry.h
"

47 
kvdoDevi˚
 
	gkvdoDevi˚
;

75 
	gmaxDisˇrdSe˘‹s
 = 
VDO_SECTORS_PER_BLOCK
;

83 #i‡
LINUX_VERSION_CODE
 >
KERNEL_VERSION
(3,0,0)

84 
	#HAS_DISCARDS_SUPPORTED
 1

	)

86 #i‡
LINUX_VERSION_CODE
 =
KERNEL_VERSION
(2,6,32Ë&& 
deföed
(
RHEL_RELEASE_CODE
)

87 #i‡
RHEL_RELEASE_CODE
 >
RHEL_RELEASE_VERSION
(6,2)

88 
	#HAS_DISCARDS_SUPPORTED
 1

	)

90 
	#HAS_DISCARDS_SUPPORTED
 0

	)

93 
	#HAS_DISCARDS_SUPPORTED
 0

	)

104 #ifde‡
RHEL_RELEASE_CODE


105 
	#HAS_FLUSH_SUPPORTED
 (
RHEL_RELEASE_CODE
 >
	`RHEL_RELEASE_VERSION
(6,6))

	)

107 
	#HAS_FLUSH_SUPPORTED
 (
LINUX_VERSION_CODE
 >
	`KERNEL_VERSION
(3,9,0))

	)

114 #ifde‡
RHEL_RELEASE_CODE


115 
	#HAS_PREPARE_IOCTL
 (
RHEL_RELEASE_CODE
 >
	`RHEL_RELEASE_VERSION
(7,3))

	)

117 
	#HAS_PREPARE_IOCTL
 (
LINUX_VERSION_CODE
 >
	`KERNEL_VERSION
(4,4,0))

	)

151 #i‡
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(3,8,0)

152 
	$vdoM≠Bio
(
dm_èrgë
 *
ti
, 
BIO
 *
bio
, 
m≠_öfo
 *
unu£d
)

154 
	$vdoM≠Bio
(
dm_èrgë
 *
ti
, 
BIO
 *
bio
)

157 
Kî√lLayî
 *
œyî
 = 
ti
->
¥iv©e
;

158  
	`kvdoM≠Bio
(
œyî
, 
bio
);

159 
	}
}

161 #i‡
HAS_PREPARE_IOCTL


163 
	$vdoPª∑ªIo˘l
(
dm_èrgë
 *
ti
,

164 
block_devi˚
 **
bdev
,

165 
fmode_t
 *
mode
)

169  -
EINVAL
;

170 
	}
}

173 
	$vdoIo˘l
(
dm_èrgë
 *
ti
, 
cmd
, 
¨g
)

177  -
EINVAL
;

178 
	}
}

181 #i‡
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(4,4,0)

183 
	$vdoMîge
(
dm_èrgë
 *
ti
,

184 
bvec_mîge_d©a
 *
bvm
,

185 
bio_vec
 *
biovec
,

186 
max_size
)

188 
Kî√lLayî
 *
œyî
 = 
ti
->
¥iv©e
;

189 
ªque°_queue
 *
q
 = 
	`bdev_gë_queue
(
œyî
->
dev
->
bdev
);

191 i‡(!
q
->
mîge_bvec_‚
) {

192  
max_size
;

195 
bvm
->
bi_bdev
 = 
œyî
->
dev
->
bdev
;

196 
bvm
->
bi_£˘‹
 = bvm->bi_£˘‹ - 
ti
->
begö
;

198  
	`mö
(
max_size
, 
q
->
	`mîge_bvec_‚
(q, 
bvm
, 
biovec
));

199 
	}
}

203 
	$vdoIoHöts
(
dm_èrgë
 *
ti
, 
queue_limôs
 *
limôs
)

205 
Kî√lLayî
 *
œyî
 = 
ti
->
¥iv©e
;

207 
limôs
->
logiˇl_block_size
 = 
œyî
->
logiˇlBlockSize
;

208 
limôs
->
physiˇl_block_size
 = 
VDO_BLOCK_SIZE
;

211 
	`blk_limôs_io_mö
(
limôs
, 
VDO_BLOCK_SIZE
);

213 
	`blk_limôs_io_›t
(
limôs
, 
VDO_BLOCK_SIZE
);

216 
limôs
->
max_disˇrd_£˘‹s
 = 
maxDisˇrdSe˘‹s
;

217 
limôs
->
disˇrd_gønuœrôy
 = 
VDO_BLOCK_SIZE
;

218 #i‡
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(4,12,0)

219 
limôs
->
disˇrd_zî€s_d©a
 = 1;

221 
	}
}

224 
	$vdoIãøãDevi˚s
(
dm_èrgë
 *
ti
,

225 
ôî©e_devi˚s_ˇŒout_‚
 
‚
,

226 *
d©a
)

228 
Kî√lLayî
 *
œyî
 = 
ti
->
¥iv©e
;

229 
£˘‹_t
 
Àn
 = 
	`blockToSe˘‹
(
œyî
,Üayî->
blockCou¡
);

231 #i‡
HAS_FLUSH_SUPPORTED


232  
	`‚
(
ti
, 
œyî
->
dev
, 0, 
Àn
, 
d©a
);

234 i‡(!
	`shouldPro˚ssFlush
(
œyî
)) {

235  
	`‚
(
ti
, 
œyî
->
dev
, 0, 
Àn
, 
d©a
);

243 
ªque°_queue
 *
q
 = 
	`bdev_gë_queue
(
œyî
->
dev
->
bdev
);

245 #i‡
LINUX_VERSINO_CODE
 >
	`KERNEL_VERSION
(4,7,0)

251 
Êush_Êags
 = 
q
->flush_flags;

252 
q
->
Êush_Êags
 = 
REQ_FLUSH
 | 
REQ_FUA
;

254 
ªsu…
 = 
	`‚
(
ti
, 
œyî
->
dev
, 0, 
Àn
, 
d©a
);

256 
q
->
Êush_Êags
 = flush_flags;

257  
ªsu…
;

261 
	}
}

263 c⁄° 
	gÆb£rvîLabñ
[] = "albserver";

281 #i‡(
LINUX_VERSION_CODE
 >
KERNEL_VERSION
(3,2,0)) \

282 && (
	gLINUX_VERSION_CODE
 < 
KERNEL_VERSION
(3,3,0)) \

283 && 
	$deföed
(
CONFIG_VERSION_SIGNATURE
)

285 
	#DMSTATUS_RETURNS_VOID
 1

	)

287 
	#DMSTATUS_RETURNS_VOID
 (
LINUX_VERSION_CODE
 > 
	`KERNEL_VERSION
(3,8,0))

	)

290 #i‡
DMSTATUS_RETURNS_VOID


291 
	tDMSètusRëu∫Ty≥
;

293 
	tDMSètusRëu∫Ty≥
;

296 
	#STATUS_TAKES_FLAGS_ARG
 (
LINUX_VERSION_CODE
 >
	`KERNEL_VERSION
(3,6,0))

	)

299 
DMSètusRëu∫Ty≥
 
	`vdoSètus
(
dm_èrgë
 *
ti
,

300 
°©us_ty≥_t
 
°©us_ty≥
,

301 #i‡
STATUS_TAKES_FLAGS_ARG


302 
°©us_Êags
,

304 *
ªsu…
,

305 
maxÀn
)

307 
Kî√lLayî
 *
œyî
 = 
ti
->
¥iv©e
;

308 
«meBuf„r
[
BDEVNAME_SIZE
];

310 
sz
 = 0;

319 
°©us_ty≥
) {

320 
STATUSTYPE_INFO
:

322 
	`DMEMIT
("/dev/%s %s %s cpu=%d,bio=%d,ack=%d,"

324 
	`bdev«me
(
œyî
->
dev
->
bdev
, 
«meBuf„r
), 
Æb£rvîLabñ
,

325 
	`gëDedu≥SèãName
(
œyî
->
dedu≥Index
),

326 
œyî
->
devi˚C⁄fig
->
thªadCou¡s
.
˝uThªads
,

327 
œyî
->
devi˚C⁄fig
->
thªadCou¡s
.
bioThªads
,

328 
œyî
->
devi˚C⁄fig
->
thªadCou¡s
.
bioAckThªads
,

329 
œyî
->
devi˚C⁄fig
->
thªadCou¡s
.
bioRŸ©i⁄I¡îvÆ
);

332 
STATUSTYPE_TABLE
:

334 
	`DMEMIT
("%s", 
œyî
->
devi˚C⁄fig
->
‹igöÆSåög
);

340 #i‡!
DMSTATUS_RETURNS_VOID


343 
	}
}

353 
BlockCou¡
 
	$gëDevi˚BlockCou¡
(
dm_dev
 *
dev
)

355 
uöt64_t
 
physiˇlSize
 = 
	`i_size_ªad
(
dev
->
bdev
->
bd_öode
);

356  
physiˇlSize
 / 
VDO_BLOCK_SIZE
;

357 
	}
}

360 
	$vdoPª∑ªToGrowLogiˇl
(
Kî√lLayî
 *
œyî
, *
sizeSåög
)

362 
BlockCou¡
 
logiˇlCou¡
;

363 i‡(
	`ssˇnf
(
sizeSåög
, "%Œu", &
logiˇlCou¡
) != 1) {

364 
	`logW¨nög
("Logiˇ»block cou¡ \"%s\" i†nŸáÇumbî", 
sizeSåög
);

365  -
EINVAL
;

368 i‡(
logiˇlCou¡
 > 
MAXIMUM_LOGICAL_BLOCKS
) {

369 
	`logW¨nög
("Logiˇ»block cou¡ \"%" 
PRIu64
 "\"ÉxceedsÅhe maximum (%"

370 
PRIu64
 ")", 
logiˇlCou¡
, 
MAXIMUM_LOGICAL_BLOCKS
);

371  -
EINVAL
;

374  
	`¥ï¨eToResizeLogiˇl
(
œyî
, 
logiˇlCou¡
);

375 
	}
}

388 
__©åibuã__
((
w¨n_unu£d_ªsu…
))

389 
	$¥o˚ssVDOMesßgeLocked
(
Kî√lLayî
 *
œyî
,

390 
¨gc
,

391 **
¨gv
)

394 i‡(
	`°∫ˇ£cmp
(
¨gv
[0], "x-", 2) == 0) {

395 
ªsu…
 = 
	`≥rf‹mKVDOExãndedComm™d
(&
œyî
->
kvdo
, 
¨gc
, 
¨gv
);

396 i‡(
ªsu…
 =
VDO_UNKNOWN_COMMAND
) {

397 
	`logW¨nög
("unknow¿exãnded comm™d '%s'Åÿdm£tu∞mesßge", 
¨gv
[0]);

398 
ªsu…
 = -
EINVAL
;

401  
ªsu…
;

405 
¨gc
) {

407 i‡(
	`°rˇ£cmp
(
¨gv
[0], "sync-dedupe") == 0) {

408 
	`waôF‹NoReque°sA˘ive
(
œyî
);

412 i‡(
	`°rˇ£cmp
(
¨gv
[0], "trace-on") == 0) {

413 
	`logInfo
("Tracing on");

414 
œyî
->
åa˚Loggög
 = 
åue
;

418 i‡(
	`°rˇ£cmp
(
¨gv
[0], "trace-off") == 0) {

419 
	`logInfo
("Tracing off");

420 
œyî
->
åa˚Loggög
 = 
Ál£
;

424 i‡(
	`°rˇ£cmp
(
¨gv
[0], "prepareToGrowPhysical") == 0) {

425  
	`¥ï¨eToResizePhysiˇl
(
œyî
, 
	`gëDevi˚BlockCou¡
÷ayî->
dev
));

428 i‡(
	`°rˇ£cmp
(
¨gv
[0], "growPhysical") == 0) {

429  
	`ªsizePhysiˇl
(
œyî
, 
	`gëDevi˚BlockCou¡
÷ayî->
dev
));

435 i‡(
	`°rˇ£cmp
(
¨gv
[0], "compression") == 0) {

436 i‡(
	`°rˇ£cmp
(
¨gv
[1], "on") == 0) {

437 
	`£tKVDOCom¥essög
(&
œyî
->
kvdo
, 
åue
);

441 i‡(
	`°rˇ£cmp
(
¨gv
[1], "off") == 0) {

442 
	`£tKVDOCom¥essög
(&
œyî
->
kvdo
, 
Ál£
);

446 
	`logW¨nög
("invalidárgument '%s'Åo dmsetup compression message",

447 
¨gv
[1]);

448  -
EINVAL
;

451 i‡(
	`°rˇ£cmp
(
¨gv
[0], "prepareToGrowLogical") == 0) {

452  
	`vdoPª∑ªToGrowLogiˇl
(
œyî
, 
¨gv
[1]);

462 
	`logW¨nög
("uƒecognized dm£tu∞mesßgê'%s'Ñe˚ived", 
¨gv
[0]);

463  -
EINVAL
;

464 
	}
}

477 
__©åibuã__
((
w¨n_unu£d_ªsu…
))

478 
	$¥o˚ssVDOMesßge
(
Kî√lLayî
 *
œyî
,

479 
¨gc
,

480 **
¨gv
)

489 i‡(
	`°rˇ£cmp
(
¨gv
[0], "dump") == 0) {

490  
	`vdoDump
(
œyî
, 
¨gc
, 
¨gv
, "dmsetup message");

493 i‡(
¨gc
 == 1) {

494 i‡(
	`°rˇ£cmp
(
¨gv
[0], "dump-on-shutdown") == 0) {

495 
œyî
->
dumpOnShutdown
 = 
åue
;

500 i‡((
	`°rˇ£cmp
(
¨gv
[0], "index-disable") == 0)

501 || (
	`°rˇ£cmp
(
¨gv
[0], "index-enable") == 0)) {

502  
	`mesßgeDedu≥Index
(
œyî
->
dedu≥Index
, 
¨gv
[0]);

508 i‡(
	`°rˇ£cmp
(
¨gv
[0], "reconnect") == 0) {

509  
	`mesßgeDedu≥Index
(
œyî
->
dedu≥Index
, "index-enable");

512 i‡(
	`°rˇ£cmp
(
¨gv
[0], "connect") == 0) {

513  
	`mesßgeDedu≥Index
(
œyî
->
dedu≥Index
, "index-enable");

516 i‡(
	`°rˇ£cmp
(
¨gv
[0], "disconnect") == 0) {

517  
	`mesßgeDedu≥Index
(
œyî
->
dedu≥Index
, "index-disable");

521 i‡(!
	`com∑ªAndSw≠Boﬁ
(&
œyî
->
¥o˚ssögMesßge
, 
Ál£
, 
åue
)) {

522  -
EBUSY
;

525 
ªsu…
 = 
	`¥o˚ssVDOMesßgeLocked
(
œyî
, 
¨gc
, 
¨gv
);

526 
	`©omicSt‹eBoﬁ
(&
œyî
->
¥o˚ssögMesßge
, 
Ál£
);

527  
ªsu…
;

528 
	}
}

531 
	$vdoMesßge
(
dm_èrgë
 *
ti
, 
¨gc
, **
¨gv
)

533 i‡(
¨gc
 == 0) {

534 
	`logW¨nög
("unspecified dmsetup message");

535  -
EINVAL
;

538 
Kî√lLayî
 *
œyî
 = (Kî√lLayî *Ë
ti
->
¥iv©e
;

539 
Regi°îedThªad
 
ÆloˇtögThªad
, 
ö°™˚Thªad
;

540 
	`ªgi°îAŒoˇtögThªad
(&
ÆloˇtögThªad
, 
NULL
);

541 
	`ªgi°îThªadDevi˚
(&
ö°™˚Thªad
, 
œyî
);

542 
ªsu…
 = 
	`¥o˚ssVDOMesßge
(
œyî
, 
¨gc
, 
¨gv
);

543 
	`uƒegi°îThªadDevi˚ID
();

544 
	`uƒegi°îAŒoˇtögThªad
();

545  
	`m≠ToSy°emEº‹
(
ªsu…
);

546 
	}
}

558 
	$gëUndîlyögDevi˚
(
dm_èrgë
 *
ti
,

559 c⁄° *
«me
,

560 
dm_dev
 **
devPå
)

562 
ªsu…
;

563 #i‡
LINUX_VERSION_CODE
 >
	`KERNEL_VERSION
(2,6,34)

564 
ªsu…
 = 
	`dm_gë_devi˚
(
ti
, 
«me
, 
	`dm_èbÀ_gë_mode
—i->
èbÀ
), 
devPå
);

566 #i‡
LINUX_VERSION_CODE
 >
	`KERNEL_VERSION
(2,6,32)

569 #i‡
	`deföed
(
RHEL_RELEASE_CODE
)

570 
ªsu…
 = 
	`dm_gë_devi˚
(
ti
, 
«me
, 
	`dm_èbÀ_gë_mode
—i->
èbÀ
), 
devPå
);

572 
ªsu…
 = 
	`dm_gë_devi˚
(
ti
, 
«me
, 0, 0, 
	`dm_èbÀ_gë_mode
—i->
èbÀ
), 
devPå
);

579 i‡(
ªsu…
 != 0) {

580 
	`logEº‹
("couldn'à›í devi˚ \"%s\":Éº‹ %d", 
«me
, 
ªsu…
);

581  -
EINVAL
;

583  
ªsu…
;

584 
	}
}

591 
	$c⁄figuªT¨gëC≠abûôõs
(
dm_èrgë
 *
ti
)

593 #i‡
HAS_DISCARDS_SUPPORTED


594 
ti
->
disˇrds_suµ‹ãd
 = 1;

596 #i‡
HAS_FLUSH_SUPPORTED


597 
ti
->
Êush_suµ‹ãd
 = 1;

599 #i‡
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(3,9,0)

600 
ti
->
num_disˇrd_ªque°s
 = 1;

601 
ti
->
num_Êush_ªque°s
 = 1;

603 
ti
->
num_disˇrd_bios
 = 1;

604 
ti
->
num_Êush_bios
 = 1;

607 #i‡
LINUX_VERSION_CODE
 >
	`KERNEL_VERSION
(3,6,0)

610 
ti
->
max_io_Àn
 = 
VDO_SECTORS_PER_BLOCK
;

612 
ti
->
•lô_io
 = 
VDO_SECTORS_PER_BLOCK
;

624 #i‡(
LINUX_VERSION_CODE
 >
	`KERNEL_VERSION
(4,3,0))

625 
ti
->
•lô_disˇrd_bios
 = 1;

627 
	}
}

640 
	$˛ónupInôülize
(
dm_èrgë
 *
ti
,

641 
Devi˚C⁄fig
 *
c⁄fig
,

642 
dm_dev
 *
dev
,

643 
ThªadC⁄fig
 *
thªadC⁄fig
,

644 
Kî√lLayî
 *
œyî
,

645 
ö°™˚
,

646 *
why
)

648 
	`‰ìDevi˚C⁄fig
(&
c⁄fig
);

649 i‡(
thªadC⁄fig
 !
NULL
) {

650 
	`‰ìThªadC⁄fig
(&
thªadC⁄fig
);

652 i‡(
œyî
 !
NULL
) {

654 
	`‰ìKî√lLayî
(
œyî
);

657 
	`ªÀa£KVDOIn°™˚
(
ö°™˚
);

659 i‡(
dev
 !
NULL
) {

660 
	`dm_put_devi˚
(
ti
, 
dev
);

663 
ti
->
îr‹
 = 
why
;

664 
	}
}

676 
	$vdoInôülize
(
dm_èrgë
 *
ti
,

677 
ö°™˚
,

678 
Devi˚C⁄fig
 *
c⁄fig
)

680 
	`logInfo
("starting device '%s' device instantiation %u (ti=%p)"

682 
c⁄fig
->
poﬁName
, 
ö°™˚
, 
ti
,

683 ((
c⁄fig
->
wrôePﬁicy
 =
WRITE_POLICY_ASYNC
) ? "async" : "sync"));

685 
dm_dev
 *
dev
;

686 
ªsu…
 = 
	`gëUndîlyögDevi˚
(
ti
, 
c⁄fig
->
∑ª¡Devi˚Name
, &
dev
);

687 i‡(
ªsu…
 != 0) {

688 
	`˛ónupInôülize
(
ti
, 
c⁄fig
, 
NULL
, NULL, NULL, 
ö°™˚
,

690  
ªsu…
;

693 
ªque°_queue
 *
ªque°Queue
 = 
	`bdev_gë_queue
(
dev
->
bdev
);

695 #i‡
LINUX_VERSION_CODE
 >
	`KERNEL_VERSION
(4,7,0)

696 
	`logInfo
("underlying device, REQ_FLUSH: %s, REQ_FUA: %s",

697 (
	`ã°_bô
(
QUEUE_FLAG_WC
, &
ªque°Queue
->
queue_Êags
)

699 (
	`ã°_bô
(
QUEUE_FLAG_FUA
, &
ªque°Queue
->
queue_Êags
)

702 
	`logInfo
("underlying device, REQ_FLUSH: %s, REQ_FUA: %s",

703 (((
ªque°Queue
->
Êush_Êags
 & 
REQ_FLUSH
) == REQ_FLUSH)

705 (((
ªque°Queue
->
Êush_Êags
 & 
REQ_FUA
) == REQ_FUA)

709 
uöt64_t
 
blockSize
 = 
VDO_BLOCK_SIZE
;

710 
uöt64_t
 
logiˇlSize
 = 
	`to_byãs
(
ti
->
Àn
);

711 
BlockCou¡
 
logiˇlBlocks
 = 
logiˇlSize
 / 
blockSize
;

712 
BlockCou¡
 
physiˇlBlocks
 = 
	`gëDevi˚BlockCou¡
(
dev
);

714 
	`logDebug
("Logiˇ»block sizê = %" 
PRIu64
,

715 (
uöt64_t
Ë
c⁄fig
->
logiˇlBlockSize
);

716 
	`logDebug
("Logiˇ»block† = %" 
PRIu64
, 
logiˇlBlocks
);

717 
	`logDebug
("Physiˇ»block sizê = %" 
PRIu64
, (
uöt64_t
Ë
blockSize
);

718 
	`logDebug
("Physiˇ»block† = %" 
PRIu64
, 
physiˇlBlocks
);

719 
	`logDebug
("Block m≠ cachêblock† = %u", 
c⁄fig
->
ˇcheSize
);

720 
	`logDebug
("Block m≠ maximumágê = %u", 
c⁄fig
->
blockM≠MaximumAge
);

721 
	`logDebug
("MD RAID5 modê = %s", (
c⁄fig
->
mdRaid5ModeE«bÀd


723 
	`logDebug
("Ród cachêmodê = %s", (
c⁄fig
->
ªadCacheE«bÀd


725 
	`logDebug
("Ród cachêexå®block†%u", 
c⁄fig
->
ªadCacheExåaBlocks
);

726 
	`logDebug
("WriteÖolicy = %s",

727 ((
c⁄fig
->
wrôePﬁicy
 =
WRITE_POLICY_ASYNC
) ? "async" : "sync"));

731 
VDOLﬂdC⁄fig
 
lﬂdC⁄fig
 = {

732 .
ˇcheSize
 = 
c⁄fig
->cacheSize,

733 .
thªadC⁄fig
 = 
NULL
,

734 .
wrôePﬁicy
 = 
c⁄fig
->writePolicy,

735 .
maximumAge
 = 
c⁄fig
->
blockM≠MaximumAge
,

740 *
ÁûuªRós⁄
;

741 
Kî√lLayî
 *
œyî
;

742 
ªsu…
 = 
	`makeKî√lLayî
(
physiˇlBlocks
, 
ti
->
begö
, 
dev
, 
ö°™˚
,

743 
c⁄fig
, &
kvdoDevi˚
.
kobj
, &
lﬂdC⁄fig
.
thªadC⁄fig
,

744 &
ÁûuªRós⁄
, &
œyî
);

745 i‡(
ªsu…
 !
VDO_SUCCESS
) {

746 
	`logEº‹
("CouldÇot create kernelÖhysicalÜayer. (VDOÉrror %d,"

747 " mesßgê%s)", 
ªsu…
, 
ÁûuªRós⁄
);

748 
	`˛ónupInôülize
(
ti
, 
NULL
, 
dev
, 
lﬂdC⁄fig
.
thªadC⁄fig
, NULL, 
ö°™˚
,

749 
ÁûuªRós⁄
);

750  
ªsu…
;

753 i‡(
c⁄fig
->
ˇcheSize
 < (2 * 
MAXIMUM_USER_VIOS


754 * 
lﬂdC⁄fig
.
thªadC⁄fig
->
logiˇlZ⁄eCou¡
)) {

755 
	`logW¨nög
("Insufficient block map cache forÜogical zones");

756 
	`˛ónupInôülize
(
ti
, 
NULL
, 
dev
, 
lﬂdC⁄fig
.
thªadC⁄fig
, 
œyî
, 
ö°™˚
,

758  
VDO_BAD_CONFIGURATION
;

761 
ªsu…
 = 
	`°¨tKî√lLayî
(
œyî
, &
lﬂdC⁄fig
, &
ÁûuªRós⁄
);

762 
	`‰ìThªadC⁄fig
(&
lﬂdC⁄fig
.
thªadC⁄fig
);

763 i‡(
ªsu…
 !
VDO_SUCCESS
) {

764 
	`logEº‹
("CouldÇot start kernelÖhysicalÜayer. (VDOÉrror %d,"

765 " mesßgê%s)", 
ªsu…
, 
ÁûuªRós⁄
);

766 
	`˛ónupInôülize
(
ti
, 
NULL
, 
dev
, NULL, 
œyî
, 
ö°™˚
, 
ÁûuªRós⁄
);

767  
ªsu…
;

770 
œyî
->
ti
 =Åi;

771 
ti
->
¥iv©e
 = 
œyî
;

772 
	`c⁄figuªT¨gëC≠abûôõs
(
ti
);

774 
	`logInfo
("devi˚ '%s' sèπed", 
c⁄fig
->
poﬁName
);

775  
VDO_SUCCESS
;

776 
	}
}

788 
	$c⁄vîtToNewDevi˚
(
Kî√lLayî
 *
œyî
,

789 
dm_èrgë
 *
ti
,

790 
dm_dev
 *
dev
)

792 i‡(
œyî
->
ﬁdTI
 !
NULL
) {

793 
	`logDebug
("RñósögÑe‡by %∞Åÿ%p", 
œyî
->
ﬁdTI
,Üayî->
ﬁdDev
);

794 
	`dm_put_devi˚
(
œyî
->
ﬁdTI
,Üayî->
ﬁdDev
);

796 
	`kobje˘_gë
(&
œyî
->
kobj
);

798 
œyî
->
ﬁdTI
 =Üayî->
ti
;

799 
œyî
->
ﬁdDev
 =Üayî->
dev
;

800 
œyî
->
ti
 =Åi;

801 
œyî
->
dev
 = dev;

802 
	}
}

805 
	$vdoCå
(
dm_èrgë
 *
ti
, 
¨gc
, **
¨gv
)

808 *
poﬁName
;

809 
ªsu…
 = 
	`gëPoﬁNameFromArgv
(
¨gc
, 
¨gv
, &
ti
->
îr‹
, &
poﬁName
);

810 i‡(
ªsu…
 !
VDO_SUCCESS
) {

811  -
EINVAL
;

814 
Regi°îedThªad
 
ÆloˇtögThªad
;

815 
	`ªgi°îAŒoˇtögThªad
(&
ÆloˇtögThªad
, 
NULL
);

817 
Kî√lLayî
 *
ﬁdLayî
 = 
	`gëLayîByName
(
poﬁName
);

818 
ö°™˚
;

819 i‡(
ﬁdLayî
 =
NULL
) {

820 
ªsu…
 = 
	`ÆloˇãKVDOIn°™˚
(&
ö°™˚
);

821 i‡(
ªsu…
 !
VDO_SUCCESS
) {

822 
	`uƒegi°îAŒoˇtögThªad
();

823  -
ENOMEM
;

826 
ö°™˚
 = 
ﬁdLayî
->instance;

829 
Regi°îedThªad
 
ö°™˚Thªad
;

830 
	`ªgi°îThªadDevi˚ID
(&
ö°™˚Thªad
, &
ö°™˚
);

832 
Devi˚C⁄fig
 *
c⁄fig
 = 
NULL
;

833 
ªsu…
 = 
	`∑r£Devi˚C⁄fig
(
¨gc
, 
¨gv
, &
ti
->
îr‹
, &
c⁄fig
);

834 i‡(
ªsu…
 !
VDO_SUCCESS
) {

835 
	`uƒegi°îThªadDevi˚ID
();

836 
	`uƒegi°îAŒoˇtögThªad
();

837 
	`ªÀa£KVDOIn°™˚
(
ö°™˚
);

838  -
EINVAL
;

842 i‡(
ﬁdLayî
 !
NULL
) {

843 i‡(
	`gëKî√lLayîSèã
(
ﬁdLayî
Ë!
LAYER_SUSPENDED
) {

844 
	`logEº‹
("Can't modifyálready-existing VDOÇamed %sÅhat isn't"

845 " su•íded", 
poﬁName
);

846 
	`‰ìDevi˚C⁄fig
(&
c⁄fig
);

847 
	`uƒegi°îThªadDevi˚ID
();

848 
	`uƒegi°îAŒoˇtögThªad
();

849 
	`ªÀa£KVDOIn°™˚
(
ö°™˚
);

850  -
EINVAL
;

863 
	`logInfo
("modifying device '%s' (ti=%p) writeÖolicy %s",

864 
c⁄fig
->
poﬁName
, 
ti
,

865 ((
c⁄fig
->
wrôePﬁicy
 =
WRITE_POLICY_ASYNC
) ? "async" : "sync"));

866 
ti
->
¥iv©e
 = 
ﬁdLayî
;

867 
	`c⁄figuªT¨gëC≠abûôõs
(
ti
);

869 
dm_dev
 *
√wDev
;

870 
ªsu…
 = 
	`gëUndîlyögDevi˚
(
ti
, 
c⁄fig
->
∑ª¡Devi˚Name
, &
√wDev
);

871 i‡(
ªsu…
 == 0) {

872 
ªsu…
 = 
	`modifyKî√lLayî
(
ﬁdLayî
, 
ti
, 
c⁄fig
, &ti->
îr‹
);

873 i‡(
ªsu…
 !
VDO_SUCCESS
) {

874 
ªsu…
 = 
	`m≠ToSy°emEº‹
(result);

875 
	`dm_put_devi˚
(
ti
, 
√wDev
);

876 
	`‰ìDevi˚C⁄fig
(&
c⁄fig
);

878 
	`c⁄vîtToNewDevi˚
(
ﬁdLayî
, 
ti
, 
√wDev
);

879 
Devi˚C⁄fig
 *
ﬁdC⁄fig
 = 
ﬁdLayî
->
devi˚C⁄fig
;

880 
ﬁdLayî
->
devi˚C⁄fig
 = 
c⁄fig
;

881 
	`‰ìDevi˚C⁄fig
(&
ﬁdC⁄fig
);

884 
	`‰ìDevi˚C⁄fig
(&
c⁄fig
);

885 
	`logEº‹
("CouldÇot find underlying device");

887 
	`uƒegi°îThªadDevi˚ID
();

888 
	`uƒegi°îAŒoˇtögThªad
();

889  
ªsu…
;

894 
ªsu…
 = 
	`vdoInôülize
(
ti
, 
ö°™˚
, 
c⁄fig
);

895 i‡(
ªsu…
 !
VDO_SUCCESS
) {

897 
ªsu…
 = 
	`m≠ToSy°emEº‹
(result);

900 
	`uƒegi°îThªadDevi˚ID
();

901 
	`uƒegi°îAŒoˇtögThªad
();

902  
ªsu…
;

903 
	}
}

906 
	$vdoDå
(
dm_èrgë
 *
ti
)

908 
Kî√lLayî
 *
œyî
 = 
ti
->
¥iv©e
;

909 i‡(
œyî
->
ti
 !=Åi) {

924 i‡(
œyî
->
ﬁdTI
 =
ti
) {

925 
	`logDebug
("RñósögÑe„ªn˚ by oldÅò%∞tÿdev %p", 
œyî
->
ﬁdTI
,

926 
œyî
->
ﬁdDev
);

927 
	`dm_put_devi˚
(
œyî
->
ﬁdTI
,Üayî->
ﬁdDev
);

928 
œyî
->
ﬁdTI
 = 
NULL
;

929 
œyî
->
ﬁdDev
 = 
NULL
;

930 
	`kobje˘_put
(&
œyî
->
kobj
);

935 
dm_dev
 *
dev
 = 
œyî
->dev;

936 
ö°™˚
 = 
œyî
->instance;

938 
Regi°îedThªad
 
ÆloˇtögThªad
, 
ö°™˚Thªad
;

939 
	`ªgi°îThªadDevi˚ID
(&
ö°™˚Thªad
, &
ö°™˚
);

940 
	`ªgi°îAŒoˇtögThªad
(&
ÆloˇtögThªad
, 
NULL
);

942 
	`waôF‹NoReque°sA˘ive
(
œyî
);

943 
	`logInfo
("°›pög devi˚ '%s'", 
œyî
->
devi˚C⁄fig
->
poﬁName
);

945 i‡(
œyî
->
dumpOnShutdown
) {

946 
	`vdoDumpAŒ
(
œyî
, "device shutdown");

951 c⁄° *
poﬁName
;

952 *
poﬁNameToFªe
;

953 
ªsu…
 = 
	`du∂iˇãSåög
(
œyî
->
devi˚C⁄fig
->
poﬁName
, "poolÇame",

954 &
poﬁNameToFªe
);

955 
poﬁName
 = (
ªsu…
 =
VDO_SUCCESS
Ë? 
poﬁNameToFªe
 : "unknown";

957 
	`‰ìKî√lLayî
(
œyî
);

958 
	`dm_put_devi˚
(
ti
, 
dev
);

960 
	`logInfo
("devi˚ '%s' st›≥d", 
poﬁName
);

961 
poﬁName
 = 
NULL
;

962 
	`FREE
(
poﬁNameToFªe
);

963 
poﬁNameToFªe
 = 
NULL
;

965 
	`uƒegi°îThªadDevi˚ID
();

966 
	`uƒegi°îAŒoˇtögThªad
();

967 
	}
}

970 
	$vdoPo°su•íd
(
dm_èrgë
 *
ti
)

972 
Kî√lLayî
 *
œyî
 = 
ti
->
¥iv©e
;

973 
Regi°îedThªad
 
ö°™˚Thªad
;

974 
	`ªgi°îThªadDevi˚
(&
ö°™˚Thªad
, 
œyî
);

975 c⁄° *
poﬁName
 = 
œyî
->
devi˚C⁄fig
->poolName;

976 
	`logInfo
("su•ídög devi˚ '%s'", 
poﬁName
);

977 
ªsu…
 = 
	`su•ídKî√lLayî
(
œyî
);

978 i‡(
ªsu…
 =
VDO_SUCCESS
) {

979 
	`logInfo
("devi˚ '%s' su•íded", 
poﬁName
);

981 
	`logEº‹
("su•íd o‡devi˚ '%s' faûed wôhÉº‹: %d", 
poﬁName
, 
ªsu…
);

983 
	`uƒegi°îThªadDevi˚ID
();

984 
	}
}

987 
	$vdoPªªsume
(
dm_èrgë
 *
ti
)

989 
Kî√lLayî
 *
œyî
 = 
ti
->
¥iv©e
;

990 
Regi°îedThªad
 
ö°™˚Thªad
;

991 
	`ªgi°îThªadDevi˚
(&
ö°™˚Thªad
, 
œyî
);

992 
	`logInfo
("ªsumög devi˚ '%s'", 
œyî
->
devi˚C⁄fig
->
poﬁName
);

993 
ªsu…
 = 
	`ªsumeKî√lLayî
(
œyî
);

994 i‡(
ªsu…
 !
VDO_SUCCESS
) {

995 
	`logEº‹
("resume of device '%s' failed withÉrror: %d",

996 
œyî
->
devi˚C⁄fig
->
poﬁName
, 
ªsu…
);

998 
	`uƒegi°îThªadDevi˚ID
();

999  
	`m≠ToSy°emEº‹
(
ªsu…
);

1000 
	}
}

1003 
	$vdoResume
(
dm_èrgë
 *
ti
)

1005 
Kî√lLayî
 *
œyî
 = 
ti
->
¥iv©e
;

1006 
Regi°îedThªad
 
ö°™˚Thªad
;

1007 
	`ªgi°îThªadDevi˚
(&
ö°™˚Thªad
, 
œyî
);

1008 
	`logInfo
("devi˚ '%s'Ñesumed", 
œyî
->
devi˚C⁄fig
->
poﬁName
);

1009 
	`uƒegi°îThªadDevi˚ID
();

1010 
	}
}

1012 
èrgë_ty≥
 
	gvdoT¨gëBio
 = {

1013 .
«me
 = "dedupe",

1014 .
	gvîsi⁄
 = {

1015 
VDO_VERSION_MAJOR
, 
VDO_VERSION_MINOR
, 
VDO_VERSION_MICRO
,

1017 .
	gmoduÀ
 = 
THIS_MODULE
,

1018 .
	g˘r
 = 
vdoCå
,

1019 .
	gdå
 = 
vdoDå
,

1020 .
	gio_höts
 = 
vdoIoHöts
,

1021 .
	gôî©e_devi˚s
 = 
vdoIãøãDevi˚s
,

1022 .
	gm≠
 = 
vdoM≠Bio
,

1023 .
	gmesßge
 = 
vdoMesßge
,

1024 .
	g°©us
 = 
vdoSètus
,

1025 .
	gpo°su•íd
 = 
vdoPo°su•íd
,

1026 .
	g¥îesume
 = 
vdoPªªsume
,

1027 .
	gªsume
 = 
vdoResume
,

1029 #i‡
HAS_PREPARE_IOCTL


1030 .
	g¥ï¨e_io˘l
 = 
vdoPª∑ªIo˘l
,

1032 .
	gio˘l
 = 
vdoIo˘l
,

1034 #i‡
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(4,4,0)

1035 .
	gmîge
 = 
vdoMîge
,

1039 
boﬁ
 
	gdmRegi°îed
 = 
Ál£
;

1040 
boﬁ
 
	gsysfsInôülized
 = 
Ál£
;

1043 
	$vdoDe°roy
()

1045 
	`logDebug
("ö %s", 
__func__
);

1047 
kvdoDevi˚
.
°©us
 = 
SHUTTING_DOWN
;

1049 i‡(
sysfsInôülized
) {

1050 
	`vdoPutSysfs
(&
kvdoDevi˚
.
kobj
);

1052 
	`vdoDe°royProcfs
();

1054 
kvdoDevi˚
.
°©us
 = 
UNINITIALIZED
;

1056 i‡(
dmRegi°îed
) {

1057 
	`dm_uƒegi°î_èrgë
(&
vdoT¨gëBio
);

1060 
	`˛ónUpIn°™˚NumbîTøckög
();

1062 
	`logInfo
("unloading");

1063 
	}
}

1066 
__öô
 
	$vdoInô
()

1068 
ªsu…
 = 0;

1070 
	`öôülizeThªadDevi˚Regi°ry
();

1071 
	`öôülizeSènd¨dEº‹Blocks
();

1072 
	`öôülizeDevi˚Regi°ryOn˚
();

1073 
	`logInfo
("lﬂded vîsi⁄ %s", 
CURRENT_VERSION
);

1075 
ªsu…
 = 
	`dm_ªgi°î_èrgë
(&
vdoT¨gëBio
);

1076 i‡(
ªsu…
 < 0) {

1077 
	`logEº‹
("dm_ªgi°î_èrgë faûed %d", 
ªsu…
);

1078 
	`vdoDe°roy
();

1079  
ªsu…
;

1081 
dmRegi°îed
 = 
åue
;

1083 
kvdoDevi˚
.
°©us
 = 
UNINITIALIZED
;

1085 
	`vdoInôProcfs
();

1089 
ªsu…
 = 
	`vdoInôSysfs
(&
kvdoDevi˚
.
kobj
);

1090 i‡(
ªsu…
 < 0) {

1091 
	`logEº‹
("sysf†öôüliz©i⁄ faûed %d", 
ªsu…
);

1092 
	`vdoDe°roy
();

1094  
ªsu…
;

1096 
sysfsInôülized
 = 
åue
;

1098 
	`öôW‹kQueueOn˚
();

1099 
	`öôülizeTø˚LoggögOn˚
();

1100 
	`öôülizeHóπbótR©e
();

1101 
	`öôKî√lVDOOn˚
();

1102 
	`öôülizeIn°™˚NumbîTøckög
();

1104 
kvdoDevi˚
.
°©us
 = 
READY
;

1105  
ªsu…
;

1106 
	}
}

1109 
__exô
 
	$vdoExô
()

1111 
	`vdoDe°roy
();

1112 
	}
}

1114 
moduÀ_öô
(
vdoInô
);

1115 
moduÀ_exô
(
vdoExô
);

1117 
MODULE_DESCRIPTION
(
DM_NAME
 "Åarget forÅransparent deduplication");

1118 
MODULE_AUTHOR
("Red Hat, Inc.");

1119 
MODULE_LICENSE
("GPL");

1120 
MODULE_VERSION
(
CURRENT_VERSION
);

	@vdo/kernel/dmvdo.h

22 #i‚de‡
DMVDO_H


23 
	#DMVDO_H


	)

25 
	~<löux/kî√l.h
>

26 
	~<löux/kobje˘.h
>

27 
	~<löux/ty≥s.h
>

29 
	~"kî√lLayî.h
"

32 
	mUNINITIALIZED
 = 0,

33 
	mREADY
,

34 
	mSHUTTING_DOWN
,

35 } 
	tKVDOSètus
;

40 
	skvdoDevi˚
 {

41 
KVDOSètus
 
	m°©us
;

42 
kobje˘
 
	mkobj
;

45 
kvdoDevi˚
 kvdoDevice;

	@vdo/kernel/dump.c

22 
	~"dump.h
"

24 
	~<löux/moduÀ.h
>

26 
	~"mem‹yAŒoc.h
"

28 
	~"c⁄°™ts.h
"

29 
	~"vdo.h
"

31 
	~"dedu≥Index.h
"

32 
	~"hi°ogøm.h
"

33 
	~"loggî.h
"

34 
	~"ªadCache.h
"

36 
	edumpO±i⁄s
 {

38 
	mSHOW_ALBIREO_QUEUE
,

39 
	mSHOW_BIO_ACK_QUEUE
,

40 
	mSHOW_BIO_QUEUE
,

41 
	mSHOW_CPU_QUEUES
,

42 
	mSHOW_REQUEST_QUEUE
,

44 
	mSHOW_VIO_POOL
,

46 
	mSHOW_READCACHES
,

47 
	mSHOW_VDO_STATUS
,

50 
	mSKIP_DEFAULT


53 
	edumpO±i⁄Fœgs
 {

55 
	mFLAG_SHOW_ALBIREO_QUEUE
 = (1 << 
SHOW_ALBIREO_QUEUE
),

56 
	mFLAG_SHOW_BIO_ACK_QUEUE
 = (1 << 
SHOW_BIO_ACK_QUEUE
),

57 
	mFLAG_SHOW_BIO_QUEUE
 = (1 << 
SHOW_BIO_QUEUE
),

58 
	mFLAG_SHOW_CPU_QUEUES
 = (1 << 
SHOW_CPU_QUEUES
),

59 
	mFLAG_SHOW_REQUEST_QUEUE
 = (1 << 
SHOW_REQUEST_QUEUE
),

61 
	mFLAG_SHOW_VIO_POOL
 = (1 << 
SHOW_VIO_POOL
),

63 
	mFLAG_SHOW_READCACHES
 = (1 << 
SHOW_READCACHES
),

64 
	mFLAG_SHOW_VDO_STATUS
 = (1 << 
SHOW_VDO_STATUS
),

66 
	mFLAG_SKIP_DEFAULT
 = (1 << 
SKIP_DEFAULT
)

70 
	mFLAGS_ALL_POOLS
 = (
FLAG_SHOW_VIO_POOL
),

71 
	mFLAGS_ALL_QUEUES
 = (
FLAG_SHOW_REQUEST_QUEUE


72 | 
FLAG_SHOW_ALBIREO_QUEUE


73 | 
FLAG_SHOW_BIO_ACK_QUEUE


74 | 
FLAG_SHOW_BIO_QUEUE


75 | 
FLAG_SHOW_CPU_QUEUES
),

76 
	mFLAGS_ALL_THREADS
 = (
FLAGS_ALL_QUEUES
),

77 
	mDEFAULT_DUMP_FLAGS
 = (
FLAGS_ALL_THREADS
 | 
FLAG_SHOW_VDO_STATUS
)

81 
ölöe
 
boﬁ
 
	$isArgSåög
(c⁄° *
¨g
, c⁄° *
thisO±i⁄
)

84  
	`°∫ˇ£cmp
(
¨g
, 
thisO±i⁄
, 
	`°æí
(thisOption)) == 0;

85 
	}
}

88 
	$doDump
(
Kî√lLayî
 *
œyî
,

89 
dumpO±i⁄sReque°ed
,

90 c⁄° *
why
)

92 
	`logInfo
("%†dum∞åiggîed vü %s", 
THIS_MODULE
->
«me
, 
why
);

94 
uöt32_t
 
a˘ive
, 
maximum
;

95 
	`gëLimôîVÆuesAtomiˇŒy
(&
œyî
->
ªque°Limôî
, &
a˘ive
, &
maximum
);

96 
	`logInfo
("%" 
PRIu32
 " deviceÑequests outstanding (max %" PRIu32 "), "

98 
a˘ive
, 
maximum
,

99 (
	`©omic64_ªad
(&
œyî
->
biosSubmôãd
)

100 - 
	`©omic64_ªad
(&
œyî
->
biosCom∂ëed
)),

101 
œyî
->
devi˚C⁄fig
->
poﬁName
);

102 
	`logInfo
("dedupe: %ld valid %ld stale",

103 
	`©omic64_ªad
(&
œyî
->
dedu≥Advi˚VÆid
),

104 
	`©omic64_ªad
(&
œyî
->
dedu≥Advi˚SèÀ
));

105 i‡((
dumpO±i⁄sReque°ed
 & 
FLAG_SHOW_REQUEST_QUEUE
) != 0) {

106 
	`dumpKVDOW‹kQueue
(&
œyî
->
kvdo
);

108 i‡((
dumpO±i⁄sReque°ed
 & 
FLAG_SHOW_BIO_QUEUE
) != 0) {

109 
	`dumpBioW‹kQueue
(
œyî
->
ioSubmôãr
);

111 i‡(
	`u£BioAckQueue
(
œyî
)

112 && ((
dumpO±i⁄sReque°ed
 & 
FLAG_SHOW_BIO_ACK_QUEUE
) != 0)) {

113 
	`dumpW‹kQueue
(
œyî
->
bioAckQueue
);

115 i‡((
dumpO±i⁄sReque°ed
 & 
FLAG_SHOW_CPU_QUEUES
) != 0) {

116 
	`dumpW‹kQueue
(
œyî
->
˝uQueue
);

118 
	`dumpDedu≥Index
(
œyî
->
dedu≥Index
,

119 (
dumpO±i⁄sReque°ed
 & 
FLAG_SHOW_ALBIREO_QUEUE
) != 0);

120 
	`dumpBuf„rPoﬁ
(
œyî
->
d©aKVIOPoﬁ
,

121 (
dumpO±i⁄sReque°ed
 & 
FLAG_SHOW_VIO_POOL
) != 0);

122 i‡((
dumpO±i⁄sReque°ed
 & 
FLAG_SHOW_READCACHES
) != 0) {

123 
	`ªadCacheDump
(
	`gëIOSubmôãrRódCache
(
œyî
->
ioSubmôãr
), 
åue
, 
Ál£
);

125 i‡((
dumpO±i⁄sReque°ed
 & 
FLAG_SHOW_VDO_STATUS
) != 0) {

128 
	`dumpKVDOSètus
(&
œyî
->
kvdo
);

130 
	`ªp‹tMem‹yUßge
();

131 
	`logInfo
("íd o‡%†dump", 
THIS_MODULE
->
«me
);

132 
	}
}

135 
	$∑r£DumpO±i⁄s
(
¨gc
,

136 * c⁄° *
¨gv
,

137 *
dumpO±i⁄sReque°edPå
)

139 
dumpO±i⁄sReque°ed
 = 0;

142 c⁄° *
«me
;

143 
Êags
;

144 } 
›ti⁄Names
[] = {

146 { "dedu≥", 
FLAG_SKIP_DEFAULT
 | 
FLAG_SHOW_ALBIREO_QUEUE
 },

147 { "dedu≥q", 
FLAG_SKIP_DEFAULT
 | 
FLAG_SHOW_ALBIREO_QUEUE
 },

148 { "kvdodedu≥q", 
FLAG_SKIP_DEFAULT
 | 
FLAG_SHOW_ALBIREO_QUEUE
 },

149 { "biﬂck", 
FLAG_SKIP_DEFAULT
 | 
FLAG_SHOW_BIO_ACK_QUEUE
 },

150 { "kvdobiﬂckq", 
FLAG_SKIP_DEFAULT
 | 
FLAG_SHOW_BIO_ACK_QUEUE
 },

151 { "biﬂckq", 
FLAG_SKIP_DEFAULT
 | 
FLAG_SHOW_BIO_ACK_QUEUE
 },

152 { "bio", 
FLAG_SKIP_DEFAULT
 | 
FLAG_SHOW_BIO_QUEUE
 },

153 { "kvdobioq", 
FLAG_SKIP_DEFAULT
 | 
FLAG_SHOW_BIO_QUEUE
 },

154 { "bioq", 
FLAG_SKIP_DEFAULT
 | 
FLAG_SHOW_BIO_QUEUE
 },

155 { "˝u", 
FLAG_SKIP_DEFAULT
 | 
FLAG_SHOW_CPU_QUEUES
 },

156 { "kvdo˝uq", 
FLAG_SKIP_DEFAULT
 | 
FLAG_SHOW_CPU_QUEUES
 },

157 { "˝uq", 
FLAG_SKIP_DEFAULT
 | 
FLAG_SHOW_CPU_QUEUES
 },

158 { "ªque°", 
FLAG_SKIP_DEFAULT
 | 
FLAG_SHOW_REQUEST_QUEUE
 },

159 { "kvd‹eqq", 
FLAG_SKIP_DEFAULT
 | 
FLAG_SHOW_REQUEST_QUEUE
 },

160 { "ªqq", 
FLAG_SKIP_DEFAULT
 | 
FLAG_SHOW_REQUEST_QUEUE
 },

161 { "vi›oﬁ", 
FLAG_SKIP_DEFAULT
 | 
FLAG_SHOW_VIO_POOL
 },

162 { "vdo", 
FLAG_SKIP_DEFAULT
 | 
FLAG_SHOW_VDO_STATUS
 },

163 { "ªadˇche", 
FLAG_SKIP_DEFAULT
 | 
FLAG_SHOW_READCACHES
 },

164 { "ªadˇches", 
FLAG_SKIP_DEFAULT
 | 
FLAG_SHOW_READCACHES
 },

166 { "poﬁs", 
FLAG_SKIP_DEFAULT
 | 
FLAGS_ALL_POOLS
 },

167 { "queues", 
FLAG_SKIP_DEFAULT
 | 
FLAGS_ALL_QUEUES
 },

168 { "thªads", 
FLAG_SKIP_DEFAULT
 | 
FLAGS_ALL_THREADS
 },

169 { "deÁu…", 
FLAG_SKIP_DEFAULT
 | 
DEFAULT_DUMP_FLAGS
 },

173 
boﬁ
 
›ti⁄sOkay
 = 
åue
;

174 
i
 = 1; i < 
¨gc
; i++) {

175 
j
;

176 
j
 = 0; j < 
	`COUNT_OF
(
›ti⁄Names
); j++) {

177 i‡(
	`isArgSåög
(
¨gv
[
i
], 
›ti⁄Names
[
j
].
«me
)) {

178 
dumpO±i⁄sReque°ed
 |
›ti⁄Names
[
j
].
Êags
;

182 i‡(
j
 =
	`COUNT_OF
(
›ti⁄Names
)) {

183 
	`logW¨nög
("dum∞›ti⁄Çamê'%s' unknown", 
¨gv
[
i
]);

184 
›ti⁄sOkay
 = 
Ál£
;

187 i‡(!
›ti⁄sOkay
) {

188  -
EINVAL
;

190 i‡((
dumpO±i⁄sReque°ed
 & 
FLAG_SKIP_DEFAULT
) == 0) {

191 
dumpO±i⁄sReque°ed
 |
DEFAULT_DUMP_FLAGS
;

193 *
dumpO±i⁄sReque°edPå
 = 
dumpO±i⁄sReque°ed
;

195 
	}
}

198 
	$vdoDump
(
Kî√lLayî
 *
œyî
,

199 
¨gc
,

200 * c⁄° *
¨gv
,

201 c⁄° *
why
)

203 
dumpO±i⁄sReque°ed
 = 0;

204 
ªsu…
 = 
	`∑r£DumpO±i⁄s
(
¨gc
, 
¨gv
, &
dumpO±i⁄sReque°ed
);

205 i‡(
ªsu…
 != 0) {

206  
ªsu…
;

208 
	`doDump
(
œyî
, 
dumpO±i⁄sReque°ed
, 
why
);

210 
	}
}

213 
	$vdoDumpAŒ
(
Kî√lLayî
 *
œyî
, c⁄° *
why
)

215 
	`doDump
(
œyî
, ~0, 
why
);

216 
	}
}

	@vdo/kernel/dump.h

22 #i‚de‡
DUMP_H


23 
	#DUMP_H


	)

25 
	~"kî√lLayî.h
"

36 
vdoDump
(
Kî√lLayî
 *
œyî
,

37 
¨gc
,

38 * c⁄° *
¨gv
,

39 c⁄° *
why
);

49 
vdoDumpAŒ
(
Kî√lLayî
 *
œyî
, c⁄° *
why
);

	@vdo/kernel/errors.c

22 
	~"îr‹s.h
"

24 
	~<löux/kî√l.h
>

25 
	~<löux/moduÀ.h
>

26 
	~<löux/°rög.h
>

28 
	~"comm⁄.h
"

29 
	~"≥rmas£π.h
"

30 
	~"°©usCodes.h
"

32 c⁄° 
îr‹Info
 
	gîr‹Li°
[] = {

83 c⁄° 
îr‹Info
 
	göã∫ÆEº‹Li°
[] = {

110 
	mUDS_UNRECOVERABLE
 = (1 << 17)

113 
	sîr‹Block
 {

114 c⁄° *
	m«me
;

115 
	mba£
;

116 
	mœ°
;

117 
	mmax
;

118 c⁄° 
Eº‹Info
 *
	möfos
;

119 } 
	tEº‹Block
;

122 
	mMAX_ERROR_BLOCKS
 = 6

125 
	sîr‹Inf‹m©i⁄
 {

126 
	mÆloˇãd
;

127 
	mcou¡
;

128 
Eº‹Block
 
	mblocks
[
MAX_ERROR_BLOCKS
];

129 } 
	gªgi°îedEº‹s
;

132 
	$öôülizeSènd¨dEº‹Blocks
()

134 
ªgi°îedEº‹s
.
Æloˇãd
 = 
MAX_ERROR_BLOCKS
;

135 
ªgi°îedEº‹s
.
cou¡
 = 0;

138 
ªgi°îedEº‹s
.
blocks
[ªgi°îedEº‹s.
cou¡
++] = (
Eº‹Block
) {

139 .
«me
 = "UDS Error",

140 .
ba£
 = 
UDS_ERROR_CODE_BASE
,

141 .
œ°
 = 
UDS_ERROR_CODE_LAST
,

142 .
max
 = 
UDS_ERROR_CODE_BLOCK_END
,

143 .
öfos
 = 
îr‹Li°
,

146 
ªgi°îedEº‹s
.
blocks
[ªgi°îedEº‹s.
cou¡
++] = (
Eº‹Block
) {

147 .
«me
 = "UDS Internal Error",

148 .
ba£
 = 
UDS_INTERNAL_ERROR_CODE_BASE
,

149 .
œ°
 = 
UDS_INTERNAL_ERROR_CODE_LAST
,

150 .
max
 = 
UDS_INTERNAL_ERROR_CODE_BLOCK_END
,

151 .
öfos
 = 
öã∫ÆEº‹Li°
,

154 
ªgi°îedEº‹s
.
blocks
[ªgi°îedEº‹s.
cou¡
++] = (
Eº‹Block
) {

155 .
«me
 = 
THIS_MODULE
->name,

156 .
ba£
 = 
VDO_BLOCK_START
,

157 .
œ°
 = 
VDO_STATUS_CODE_LAST
,

158 .
max
 = 
VDO_BLOCK_END
,

159 .
öfos
 = 
vdoSètusLi°
,

161 
	}
}

172 c⁄° *
	$gëEº‹Info
(
î∫um
, c⁄° 
Eº‹Info
 **
öfoPå
)

174 
Eº‹Block
 *
block
 = 
ªgi°îedEº‹s
.
blocks
;

175 
block
 < 
ªgi°îedEº‹s
.
blocks
 +Ñegi°îedEº‹s.
cou¡
;

176 ++
block
) {

177 i‡((
î∫um
 >
block
->
ba£
Ë&& (î∫um < block->
œ°
)) {

178 i‡(
öfoPå
 !
NULL
) {

179 *
öfoPå
 = 
block
->
öfos
 + (
î∫um
 - block->
ba£
);

181  
block
->
«me
;

182 } i‡((
î∫um
 >
block
->
œ°
Ë&& (î∫um < block->
max
)) {

183 i‡(
öfoPå
 !
NULL
) {

184 *
öfoPå
 = 
NULL
;

186  
block
->
«me
;

189 i‡(
öfoPå
 !
NULL
) {

190 *
öfoPå
 = 
NULL
;

192  
NULL
;

193 
	}
}

196 c⁄° *
	$°rögEº‹
(
î∫um
, *
buf
, 
size_t
 
buÊí
)

198 i‡(
buf
 =
NULL
) {

199  
NULL
;

202 c⁄° 
Eº‹Info
 *
öfo
 = 
NULL
;

203 c⁄° *
blockName
 = 
	`gëEº‹Info
(
î∫um
, &
öfo
);

205 i‡(
blockName
 !
NULL
) {

206 i‡(
öfo
 !
NULL
) {

207 
	`¢¥ötf
(
buf
, 
buÊí
, "%s: %s", 
blockName
, 
öfo
->
mesßge
);

209 
	`¢¥ötf
(
buf
, 
buÊí
, "Unknow¿%†%d", 
blockName
, 
î∫um
);

212 
	`¢¥ötf
(
buf
, 
buÊí
, "Sy°emÉº‹ %d", 
î∫um
);

214  
buf
;

215 
	}
}

218 c⁄° *
	$°rögEº‹Name
(
î∫um
, *
buf
, 
size_t
 
buÊí
)

220 c⁄° 
Eº‹Info
 *
öfo
 = 
NULL
;

221 c⁄° *
blockName
 = 
	`gëEº‹Info
(
î∫um
, &
öfo
);

223 i‡(
blockName
 !
NULL
) {

224 i‡(
öfo
 !
NULL
) {

225 
	`¢¥ötf
(
buf
, 
buÊí
, "%s: %s", 
blockName
, 
öfo
->
«me
);

227 
	`¢¥ötf
(
buf
, 
buÊí
, "Unknow¿%†%d", 
blockName
, 
î∫um
);

230 
	`¢¥ötf
(
buf
, 
buÊí
, "Sy°emÉº‹ %d", 
î∫um
);

232  
buf
;

233 
	}
}

236 
	$makeUƒecovîabÀ
(
ªsu…Code
)

238  ((
ªsu…Code
 =
UDS_SUCCESS
)

239 ? 
ªsu…Code


240 : (
ªsu…Code
 | 
UDS_UNRECOVERABLE
));

241 
	}
}

244 
	$ßnsUƒecovîabÀ
(
ªsu…Code
)

246  
ªsu…Code
 & ~
UDS_UNRECOVERABLE
;

247 
	}
}

250 
boﬁ
 
	$isUƒecovîabÀ
(
ªsu…Code
)

252  (
boﬁ
)(
ªsu…Code
 & 
UDS_UNRECOVERABLE
);

253 
	}
}

256 
	$ªgi°îEº‹Block
(c⁄° *
blockName
,

257 
fú°Eº‹
,

258 
œ°Re£rvedEº‹
,

259 c⁄° 
Eº‹Info
 *
öfos
,

260 
size_t
 
öfoSize
)

262 
ªsu…
 = 
	`ASSERT
(
fú°Eº‹
 < 
œ°Re£rvedEº‹
,

264 i‡(
ªsu…
 !
UDS_SUCCESS
) {

265  
ªsu…
;

268 i‡(
ªgi°îedEº‹s
.
cou¡
 =ªgi°îedEº‹s.
Æloˇãd
) {

270  
UDS_OVERFLOW
;

273 
Eº‹Block
 *
block
 = 
ªgi°îedEº‹s
.
blocks
;

274 
block
 < 
ªgi°îedEº‹s
.
blocks
 +Ñegi°îedEº‹s.
cou¡
;

275 ++
block
) {

276 i‡(
	`°rcmp
(
blockName
, 
block
->
«me
) == 0) {

277  
UDS_DUPLICATE_NAME
;

280 i‡((
fú°Eº‹
 < 
block
->
max
Ë&& (
œ°Re£rvedEº‹
 > block->
ba£
)) {

281  
UDS_ALREADY_REGISTERED
;

285 
ªgi°îedEº‹s
.
blocks
[ªgi°îedEº‹s.
cou¡
++] = (
Eº‹Block
) {

286 .
«me
 = 
blockName
,

287 .
ba£
 = 
fú°Eº‹
,

288 .
œ°
 = 
fú°Eº‹
 + (
öfoSize
 / (
Eº‹Info
)),

289 .
max
 = 
œ°Re£rvedEº‹
,

290 .
öfos
 = infos

293  
UDS_SUCCESS
;

294 
	}
}

	@vdo/kernel/errors.h

22 #i‚de‡
ERRORS_H


23 
	#ERRORS_H


	)

25 
	~<löux/ty≥s.h
>

26 
	~"uds-îr‹.h
"

28 
	eudsI¡î«lEº‹Codes
 {

30 
	mUDS_INTERNAL_ERROR_CODE_BASE
 = 66560,

32 
	mUDS_PROTOCOL_ERROR
 = 
UDS_INTERNAL_ERROR_CODE_BASE
 + 0,

34 
	mUDS_OVERFLOW
 = 
UDS_INTERNAL_ERROR_CODE_BASE
 + 1,

36 
	mUDS_FILLDONE
 = 
UDS_INTERNAL_ERROR_CODE_BASE
 + 2,

38 
	mUDS_INVALID_ARGUMENT
 = 
UDS_INTERNAL_ERROR_CODE_BASE
 + 3,

40 
	mUDS_BAD_STATE
 = 
UDS_INTERNAL_ERROR_CODE_BASE
 + 4,

42 
	mUDS_DUPLICATE_NAME
 = 
UDS_INTERNAL_ERROR_CODE_BASE
 + 5,

44 
	mUDS_UNEXPECTED_RESULT
 = 
UDS_INTERNAL_ERROR_CODE_BASE
 + 6,

46 
	mUDS_INJECTED_ERROR
 = 
UDS_INTERNAL_ERROR_CODE_BASE
 + 7,

48 
	mUDS_ASSERTION_FAILED
 = 
UDS_INTERNAL_ERROR_CODE_BASE
 + 8,

50 
	mUDS_UNSCANNABLE
 = 
UDS_INTERNAL_ERROR_CODE_BASE
 + 9,

52 
	mUDS_QUEUED
 = 
UDS_INTERNAL_ERROR_CODE_BASE
 + 10,

54 
	mUDS_QUEUE_ALREADY_CONNECTED
 = 
UDS_INTERNAL_ERROR_CODE_BASE
 + 11,

56 
	mUDS_BAD_FILL_PHASE
 = 
UDS_INTERNAL_ERROR_CODE_BASE
 + 12,

58 
	mUDS_BUFFER_ERROR
 = 
UDS_INTERNAL_ERROR_CODE_BASE
 + 13,

60 
	mUDS_CONNECTION_LOST
 = 
UDS_INTERNAL_ERROR_CODE_BASE
 + 14,

62 
	mUDS_TIMEOUT
 = 
UDS_INTERNAL_ERROR_CODE_BASE
 + 15,

64 
	mUDS_NO_DIRECTORY
 = 
UDS_INTERNAL_ERROR_CODE_BASE
 + 16,

66 
	mUDS_CHECKPOINT_INCOMPLETE
 = 
UDS_INTERNAL_ERROR_CODE_BASE
 + 17,

68 
	mUDS_INVALID_RUN_ID
 = 
UDS_INTERNAL_ERROR_CODE_BASE
 + 18,

70 
	mUDS_RUN_CANCELED
 = 
UDS_INTERNAL_ERROR_CODE_BASE
 + 19,

72 
	mUDS_ALREADY_REGISTERED
 = 
UDS_INTERNAL_ERROR_CODE_BASE
 + 20,

74 
	mUDS_INTERNAL_ERROR_CODE_LAST
,

76 
	mUDS_INTERNAL_ERROR_CODE_BLOCK_END
 = 
UDS_INTERNAL_ERROR_CODE_BASE
 + 440

80 
	mERRBUF_SIZE
 = 128

83 c⁄° *
°rögEº‹
(
î∫um
, *
buf
, 
size_t
 
buÊí
);

84 c⁄° *
°rögEº‹Name
(
î∫um
, *
buf
, 
size_t
 
buÊí
);

86 
	$makeUƒecovîabÀ
(
ªsu…Code
Ë
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

87 
boﬁ
 
	$isUƒecovîabÀ
(
ªsu…Code
Ë
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

88 
	$ßnsUƒecovîabÀ
(
ªsu…Code
Ë
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

90 
	sîr‹Info
 {

91 c⁄° *
«me
;

92 c⁄° *
mesßge
;

93 } 
	tEº‹Info
;

101 
	`öôülizeSènd¨dEº‹Blocks
();

118 
	`ªgi°îEº‹Block
(c⁄° *
blockName
,

119 
fú°Eº‹
,

120 
œ°Re£rvedEº‹
,

121 c⁄° 
Eº‹Info
 *
öfos
,

122 
size_t
 
öfoSize
);

	@vdo/kernel/funnelQueue.c

22 
	~"fu¬ñQueue.h
"

24 
	~"°©usCodes.h
"

26 
	~"mem‹yAŒoc.h
"

27 
	~"≥rmas£π.h
"

30 
	$makeFu¬ñQueue
(
Fu¬ñQueue
 **
queuePå
)

39 
	`STATIC_ASSERT
(
__x86_64__
);

49 
	`STATIC_ASSERT
(((
Fu¬ñQueue
Ë% 
CACHE_LINE_BYTES
) == 0);

51 
Fu¬ñQueue
 *
queue
;

52 
ªsu…
 = 
	`ALLOCATE
(1, 
Fu¬ñQueue
, "fu¬ñ queue", &
queue
);

53 i‡(
ªsu…
 !
UDS_SUCCESS
) {

54  
ªsu…
;

56 
ªsu…
 = 
	`ASSERT
((((
uöçå_t
Ë
queue
 % 
CACHE_LINE_BYTES
) == 0),

58 i‡(
ªsu…
 !
VDO_SUCCESS
) {

59 
	`FREE
(
queue
);

60  
ªsu…
;

65 
queue
->
°ub
.
√xt
 = 
NULL
;

66 
queue
->
√we°
 = &queue->
°ub
;

67 
queue
->
ﬁde°
 = &queue->
°ub
;

69 *
queuePå
 = 
queue
;

70  
UDS_SUCCESS
;

71 
	}
}

74 
	$‰ìFu¬ñQueue
(
Fu¬ñQueue
 *
queue
)

76 
	`FREE
(
queue
);

77 
	}
}

80 
Fu¬ñQueueE¡ry
 *
	$gëOlde°
(
Fu¬ñQueue
 *
queue
)

82 
Fu¬ñQueueE¡ry
 *
ﬁde°
 = 
queue
->oldest;

83 
Fu¬ñQueueE¡ry
 *
√xt
 = 
ﬁde°
->next;

85 i‡(
ﬁde°
 =&
queue
->
°ub
) {

88 i‡(
√xt
 =
NULL
) {

89  
NULL
;

93 
ﬁde°
 = 
√xt
;

94 
queue
->
ﬁde°
 = oldest;

95 
√xt
 = 
ﬁde°
->next;

100 i‡(
√xt
 =
NULL
) {

101 
Fu¬ñQueueE¡ry
 *
√we°
 = 
queue
->newest;

102 i‡(
ﬁde°
 !
√we°
) {

105  
NULL
;

110 
	`fu¬ñQueuePut
(
queue
, &queue->
°ub
);

113 
√xt
 = 
ﬁde°
->next;

114 i‡(
√xt
 =
NULL
) {

117  
NULL
;

120  
ﬁde°
;

121 
	}
}

124 
Fu¬ñQueueE¡ry
 *
	$fu¬ñQueuePﬁl
(
Fu¬ñQueue
 *
queue
)

126 
Fu¬ñQueueE¡ry
 *
ﬁde°
 = 
	`gëOlde°
(
queue
);

127 i‡(
ﬁde°
 =
NULL
) {

128  
ﬁde°
;

137 
queue
->
ﬁde°
 = olde°->
√xt
;

142 
	`¥e„tchAddªss
(
queue
->
ﬁde°
, 
åue
);

143 
ﬁde°
->
√xt
 = 
NULL
;

144  
ﬁde°
;

145 
	}
}

148 
Fu¬ñQueueE¡ry
 *
	$fu¬ñQueuePìk
(
Fu¬ñQueue
 *
queue
)

150  
	`gëOlde°
(
queue
);

151 
	}
}

154 
boﬁ
 
	$isFu¬ñQueueEm±y
(
Fu¬ñQueue
 *
queue
)

156 
Fu¬ñQueueE¡ry
 *
ﬁde°
 = 
queue
->oldest;

157 
Fu¬ñQueueE¡ry
 *
√xt
 = 
ﬁde°
->next;

162 i‡(
ﬁde°
 =&
queue
->
°ub
) {

165 i‡(
√xt
 =
NULL
) {

166  
åue
;

170  
Ál£
;

171 
	}
}

	@vdo/kernel/funnelQueue.h

22 #i‚de‡
FUNNEL_QUEUE_H


23 
	#FUNNEL_QUEUE_H


	)

25 
	~<löux/°ddef.h
>

27 
	~"˝u.h
"

28 
	~"utû/©omic.h
"

70 
	sfu¬ñQueueE¡ry
 {

72 
fu¬ñQueueE¡ry
 * vﬁ©ûê
	m√xt
;

73 } 
	tFu¬ñQueueE¡ry
;

80 
__©åibuã__
((
	tÆig√d
(
	tCACHE_LINE_BYTES
))Ë
	tfu¬ñQueue
 {

83 
Fu¬ñQueueE¡ry
 * vﬁ©ûê
√we°
;

86 
Fu¬ñQueueE¡ry
 *
ﬁde°
 
	`__©åibuã__
((
	`Æig√d
(
CACHE_LINE_BYTES
)));

89 
Fu¬ñQueueE¡ry
 
°ub
;

90 
	}
} 
	tFu¬ñQueue
;

99 
	$makeFu¬ñQueue
(
Fu¬ñQueue
 **
queuePå
)

100 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

111 
	`‰ìFu¬ñQueue
(
Fu¬ñQueue
 *
queue
);

125 
ölöe
 
	$fu¬ñQueuePut
(
Fu¬ñQueue
 *
queue
, 
Fu¬ñQueueE¡ry
 *
íåy
)

127 
íåy
->
√xt
 = 
NULL
;

128 
	`gccFí˚
();

129 
Fu¬ñQueueE¡ry
 *
¥evious
 = 
	`__sync_lock_ã°_™d_£t
(&
queue
->
√we°
, 
íåy
);

130 
	`gccFí˚
();

133 
¥evious
->
√xt
 = 
íåy
;

134 
	}
}

144 
Fu¬ñQueueE¡ry
 *
	$fu¬ñQueuePﬁl
(
Fu¬ñQueue
 *
queue
)

145 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

157 
Fu¬ñQueueE¡ry
 *
	$fu¬ñQueuePìk
(
Fu¬ñQueue
 *
queue
)

158 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

174 
boﬁ
 
	$isFu¬ñQueueEm±y
(
Fu¬ñQueue
 *
queue
)

175 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

	@vdo/kernel/heartbeat.c

22 
	~"hóπbót.h
"

24 
	~"kî√lLayî.h
"

25 
	~"kî√lVDOI¡î«ls.h
"

26 
	~"loggî.h
"

27 
	~"vdo.h
"

29 
Jiffõs
 
	ghóπbótI¡îvÆ
;

32 
	$öôülizeHóπbótR©e
()

45 
hóπbótI¡îvÆ
 = 
	`u£cs_to_jiffõs
(
HEARTBEAT_INTERVAL
+1) - 1;

46 
hóπbótU£c
 = 
	`jiffõs_to_u£cs
(
hóπbótI¡îvÆ
);

47 i‡(
hóπbótU£c
 !
HEARTBEAT_INTERVAL
) {

48 
	`logW¨nög
("configured heartbeat interval (%u usec)"

50 
HEARTBEAT_INTERVAL
, 
	`jiffõs_to_u£cs
(1));

51 
	`logW¨nög
("roundög dow¿hóπbóàöãrvÆÅÿ%lu u£c", 
hóπbótU£c
);

53 
	}
}

60 
	$kvdoHóπbótW‹k
(
KvdoW‹kIãm
 *
ôem
)

62 
HóπbótD©a
 *
hóπbót
 = 
	`c⁄èöî_of
(
ôem
, HóπbótD©a, 
w‹kIãm
);

64 
KVDOThªad
 *
thªad
 = 
	`c⁄èöî_of
(
hóπbót
, KVDOThread, heartbeat);

65 i‡(!
hóπbót
->
°›
) {

66 
ThªadID
 
id
 = 
thªad
 - &thªad->
kvdo
->
thªads
[0];

67 
	`hóπbótCÆlback
(
hóπbót
, 
id
);

68 
	`íqueueKVDOThªadW‹kDñayed
(
thªad
, &
hóπbót
->
w‹kIãm
,

69 
jiffõs
 + 
hóπbótI¡îvÆ
);

71 
	`com∂ëe
(&
thªad
->
hóπbótWaô
);

73 
	}
}

76 
	$£tupHóπbót
(
HóπbótD©a
 *
hóπbót
)

78 
	`£tupW‹kIãm
(&
hóπbót
->
w‹kIãm
, 
kvdoHóπbótW‹k
, 
NULL
,

79 
REQ_Q_ACTION_HEARTBEAT
);

80 
	}
}

83 
	$°¨tHóπbót
(
HóπbótD©a
 *
hóπbót
)

85 
hóπbót
->
°›
 = 
Ál£
;

87 
KVDOThªad
 *
thªad
 = 
	`c⁄èöî_of
(
hóπbót
, KVDOThread, heartbeat);

88 
	`íqueueKVDOThªadW‹kDñayed
(
thªad
, &
hóπbót
->
w‹kIãm
,

89 
jiffõs
 + 
hóπbótI¡îvÆ
);

90 
	}
}

93 
	$°›Hóπbót
(
HóπbótD©a
 *
hóπbót
)

100 
hóπbót
->
°›
 = 
åue
;

101 
	}
}

	@vdo/kernel/heartbeat.h

22 #i‚de‡
HEARTBEAT_H


23 
	#HEARTBEAT_H


	)

25 
	~"w‹kQueue.h
"

27 
	shóπbótD©a
 {

28 
boﬁ
 
	m°›
;

29 
KvdoW‹kIãm
 
	mw‹kIãm
;

30 } 
	tHóπbótD©a
;

37 
öôülizeHóπbótR©e
();

44 
£tupHóπbót
(
HóπbótD©a
 *
hóπbót
);

51 
°¨tHóπbót
(
HóπbótD©a
 *
hóπbót
);

60 
°›Hóπbót
(
HóπbótD©a
 *
hóπbót
);

71 
hóπbótCÆlback
(
HóπbótD©a
 *
hóπbót
, 
ThªadID
 
thªad
);

	@vdo/kernel/histogram.c

22 
	~<löux/kobje˘.h
>

24 
	~"mem‹yAŒoc.h
"

26 
	~"comm⁄.h
"

27 
	~"hi°ogøm.h
"

28 
	~"loggî.h
"

29 
	~"numUtûs.h
"

40 
	mNO_BUCKETS
 = 1

68 
	shi°ogøm
 {

71 
©omic64_t
 *
	mcou¡îs
;

72 
uöt64_t
 
	mlimô
;

73 
©omic64_t
 
	msum
;

74 
©omic64_t
 
	mcou¡
;

75 
©omic64_t
 
	mmöimum
;

76 
©omic64_t
 
	mmaximum
;

77 
©omic64_t
 
	mu«c˚±abÀ
;

78 
	mnumBuckës
;

79 
boﬁ
 
	mlogFœg
;

81 c⁄° *
	mœbñ
;

82 c⁄° *
	mcou¡edIãms
;

83 c⁄° *
	mmëric
;

84 c⁄° *
	mßm∂eUnôs
;

85 
	mc⁄vîsi⁄Fa˘‹
;

86 
kobje˘
 
	mkobj
;

93 íum { 
	mMAX_LOG_SIZE
 = 12 };

94 c⁄° 
uöt64_t
 
	gbŸtomVÆue
[1 + 10 * 
MAX_LOG_SIZE
] = {

130 
	$divideRoundögToNóª°
(
uöt64_t
 
numbî
, uöt64_à
divis‹
)

132 
numbî
 +
divis‹
 / 2;

133  
numbî
 / 
divis‹
;

134 
	}
}

137 
	$maxBuckë
(
Hi°ogøm
 *
h
)

139 
max
 = 
h
->
numBuckës
;

140 (
max
 >0Ë&& (
	`©omic64_ªad
(&
h
->
cou¡îs
[max]) == 0)) {

141 
max
--;

144  
max
;

145 
	}
}

150 
©åibuã
 
	m©å
;

151 
ssize_t
 (*
show
)(
Hi°ogøm
 *
	mh
, *
	mbuf
);

152 
ssize_t
 (*
°‹e
)(
Hi°ogøm
 *
	mh
, c⁄° *
	mbuf
, 
size_t
 
	mÀngth
);

153 } 
	tHi°ogømAâribuã
;

156 
	$hi°ogømKobjRñó£
(
kobje˘
 *
kobj
)

158 
Hi°ogøm
 *
h
 = 
	`c⁄èöî_of
(
kobj
, Histogram, kobj);

159 
	`FREE
(
h
->
cou¡îs
);

160 
	`FREE
(
h
);

161 
	}
}

164 
ssize_t
 
	$hi°ogømShow
(
kobje˘
 *
kobj
,

165 
©åibuã
 *
©å
,

166 *
buf
)

168 
Hi°ogømAâribuã
 *
ha
 = 
	`c⁄èöî_of
(
©å
, HistogramAttribute,áttr);

169 i‡(
ha
->
show
 =
NULL
) {

170  -
EINVAL
;

172 
Hi°ogøm
 *
h
 = 
	`c⁄èöî_of
(
kobj
, Histogram, kobj);

173  
ha
->
	`show
(
h
, 
buf
);

174 
	}
}

177 
ssize_t
 
	$hi°ogømSt‹e
(
kobje˘
 *
kobj
,

178 
©åibuã
 *
©å
,

179 c⁄° *
buf
,

180 
size_t
 
Àngth
)

182 
Hi°ogømAâribuã
 *
ha
 = 
	`c⁄èöî_of
(
©å
, HistogramAttribute,áttr);

183 i‡(
ha
->
show
 =
NULL
) {

184  -
EINVAL
;

186 
Hi°ogøm
 *
h
 = 
	`c⁄èöî_of
(
kobj
, Histogram, kobj);

187  
ha
->
	`°‹e
(
h
, 
buf
, 
Àngth
);

188 
	}
}

191 
ssize_t
 
	$hi°ogømShowCou¡
(
Hi°ogøm
 *
h
, *
buf
)

193  
	`•rötf
(
buf
, "%ld\n", 
	`©omic64_ªad
(&
h
->
cou¡
));

194 
	}
}

197 
ssize_t
 
	$hi°ogømShowHi°ogøm
(
Hi°ogøm
 *
h
, *
buf„r
)

203 
size_t
 
buf„rSize
 = 
PAGE_SIZE
;

204 
boﬁ
 
b¨s
 = 
åue
;

205 
ssize_t
 
Àngth
 = 0;

206 
max
 = 
	`maxBuckë
(
h
);

209 íum { 
BAR_SIZE
 = 50 };

210 
b¨
[
BAR_SIZE
 + 2];

211 
b¨
[0] = ' ';

212 
	`mem£t
(
b¨
 + 1, '=', 
BAR_SIZE
);

213 
b¨
[
BAR_SIZE
 + 1] = '\0';

215 
uöt64_t
 
tŸÆ
 = 0;

216 
i
 = 0; i <
max
; i++) {

217 
tŸÆ
 +
	`©omic64_ªad
(&
h
->
cou¡îs
[
i
]);

220 
Àngth
 +
	`¢¥ötf
(
buf„r
, 
buf„rSize
, "%s Histogram -Çumber of %s by %s",

221 
h
->
œbñ
, h->
cou¡edIãms
, h->
mëric
);

222 i‡(
Àngth
 >(
buf„rSize
 - 1)) {

223  
buf„rSize
 - 1;

225 i‡(
h
->
ßm∂eUnôs
 !
NULL
) {

226 
Àngth
 +
	`¢¥ötf
(
buf„r
 +Üígth, 
buf„rSize
 -Üength, " (%s)",

227 
h
->
ßm∂eUnôs
);

228 i‡(
Àngth
 >(
buf„rSize
 - 1)) {

229  
buf„rSize
 - 1;

232 
Àngth
 +
	`¢¥ötf
(
buf„r
 +Üígth, 
buf„rSize
 -Üength, "\n");

233 i‡(
Àngth
 >(
buf„rSize
 - 1)) {

234  
buf„rSize
 - 1;

236 
i
 = 0; i <
max
; i++) {

237 
uöt64_t
 
vÆue
 = 
	`©omic64_ªad
(&
h
->
cou¡îs
[
i
]);

239 
b¨Lígth
;

240 i‡(
b¨s
 && (
tŸÆ
 != 0)) {

242 
b¨Lígth
 = (
	`divideRoundögToNóª°
(
vÆue
 * 
BAR_SIZE
, 
tŸÆ
) + 1);

243 i‡(
b¨Lígth
 == 1) {

245 
b¨Lígth
 = 0;

249 
b¨Lígth
 = 0;

252 i‡(
h
->
logFœg
) {

253 i‡(
i
 =
h
->
numBuckës
) {

254 
Àngth
 +
	`¢¥ötf
(
buf„r
 +Üígth, 
buf„rSize
 -Üength, "%-16s",

257 
lowî
 = 
h
->
c⁄vîsi⁄Fa˘‹
 * 
bŸtomVÆue
[
i
];

258 
uµî
 = 
h
->
c⁄vîsi⁄Fa˘‹
 * 
bŸtomVÆue
[
i
 + 1] - 1;

259 
Àngth
 +
	`¢¥ötf
(
buf„r
 +Üígth, 
buf„rSize
 -Üength, "%6u - %7u",

260 
lowî
, 
uµî
);

263 i‡(
i
 =
h
->
numBuckës
) {

264 
Àngth
 +
	`¢¥ötf
(
buf„r
 +Üígth, 
buf„rSize
 -Üength, "%6s",

267 
Àngth
 +
	`¢¥ötf
(
buf„r
 +Üígth, 
buf„rSize
 -Üígth, "%6d", 
i
);

270 i‡(
Àngth
 >(
buf„rSize
 - 1)) {

271  
buf„rSize
 - 1;

273 
Àngth
 +
	`¢¥ötf
(
buf„r
 +Üígth, 
buf„rSize
 -Üength,

274 " : %12" 
PRIu64
 "%.*s\n", 
vÆue
, 
b¨Lígth
, 
b¨
);

275 i‡(
Àngth
 >(
buf„rSize
 - 1)) {

276  
buf„rSize
 - 1;

280 
Àngth
 +
	`¢¥ötf
(
buf„r
 +Üígth, 
buf„rSize
 -Üength,

281 "tŸÆ %" 
PRIu64
 "\n", 
tŸÆ
);

282  
	`möSizeT
(
buf„rSize
 - 1, 
Àngth
);

283 
	}
}

286 
ssize_t
 
	$hi°ogømShowMaximum
(
Hi°ogøm
 *
h
, *
buf
)

289 
vÆue
 = 
	`©omic64_ªad
(&
h
->
maximum
);

290  
	`•rötf
(
buf
, "%lu\n", 
h
->
c⁄vîsi⁄Fa˘‹
 * 
vÆue
);

291 
	}
}

294 
ssize_t
 
	$hi°ogømShowMöimum
(
Hi°ogøm
 *
h
, *
buf
)

297 
vÆue
 = ((
	`©omic64_ªad
(&
h
->
cou¡
) > 0)

298 ? 
	`©omic64_ªad
(&
h
->
möimum
)

300  
	`•rötf
(
buf
, "%lu\n", 
h
->
c⁄vîsi⁄Fa˘‹
 * 
vÆue
);

301 
	}
}

304 
ssize_t
 
	$hi°ogømShowLimô
(
Hi°ogøm
 *
h
, *
buf
)

307  
	`•rötf
(
buf
, "%u\n", ()(
h
->
c⁄vîsi⁄Fa˘‹
 * h->
limô
));

308 
	}
}

311 
ssize_t
 
	$hi°ogømSt‹eLimô
(
Hi°ogøm
 *
h
,

312 c⁄° *
buf
,

313 
size_t
 
Àngth
)

315 
vÆue
;

316 i‡((
Àngth
 > 12Ë|| (
	`ssˇnf
(
buf
, "%u", &
vÆue
) != 1)) {

317  -
EINVAL
;

325 
h
->
limô
 = 
	`compuãBuckëCou¡
(
vÆue
, h->
c⁄vîsi⁄Fa˘‹
);

326 
	`©omic64_£t
(&
h
->
u«c˚±abÀ
, 0);

327  
Àngth
;

328 
	}
}

331 
ssize_t
 
	$hi°ogømShowMón
(
Hi°ogøm
 *
h
, *
buf
)

333 
uöt64_t
 
cou¡
 = 
	`©omic64_ªad
(&
h
->count);

334 i‡(
cou¡
 == 0) {

335  
	`•rötf
(
buf
, "0/0\n");

338 
sumTimes1000InRï‹tögUnôs


339 
h
->
c⁄vîsi⁄Fa˘‹
 * 
	`©omic64_ªad
(&h->
sum
) * 1000;

340 
mónTimes1000


341 
	`divideRoundögToNóª°
(
sumTimes1000InRï‹tögUnôs
, 
cou¡
);

343  
	`•rötf
(
buf
, "%u.%03u\n", 
mónTimes1000
 / 1000,

344 
mónTimes1000
 % 1000);

345 
	}
}

348 
ssize_t
 
	$hi°ogømShowU«c˚±abÀ
(
Hi°ogøm
 *
h
, *
buf
)

350  
	`•rötf
(
buf
, "%ld\n", 
	`©omic64_ªad
(&
h
->
u«c˚±abÀ
));

351 
	}
}

354 
ssize_t
 
	$hi°ogømShowLabñ
(
Hi°ogøm
 *
h
, *
buf
)

356  
	`•rötf
(
buf
, "%s\n", 
h
->
œbñ
);

357 
	}
}

360 
ssize_t
 
	$hi°ogømShowUnô
(
Hi°ogøm
 *
h
, *
buf
)

362 i‡(
h
->
ßm∂eUnôs
 !
NULL
) {

363  
	`•rötf
(
buf
, "%s\n", 
h
->
ßm∂eUnôs
);

365 *
buf
 = 0;

368 
	}
}

372 
sysfs_›s
 
	ghi°ogømSysfsOps
 = {

373 .
show
 = 
hi°ogømShow
,

374 .
	g°‹e
 = 
hi°ogømSt‹e
,

377 
Hi°ogømAâribuã
 
	gcou¡Aâribuã
 = {

378 .
©å
 = { .
«me
 = "cou¡", .
	gmode
 = 0444, },

379 .
	gshow
 = 
hi°ogømShowCou¡
,

382 
Hi°ogømAâribuã
 
	ghi°ogømAâribuã
 = {

383 .
©å
 = { .
«me
 = "hi°ogøm", .
	gmode
 = 0444, },

384 .
	gshow
 = 
hi°ogømShowHi°ogøm
,

387 
Hi°ogømAâribuã
 
	gœbñAâribuã
 = {

388 .
©å
 = { .
«me
 = "œbñ", .
	gmode
 = 0444, },

389 .
	gshow
 = 
hi°ogømShowLabñ
,

392 
Hi°ogømAâribuã
 
	gmaximumAâribuã
 = {

393 .
©å
 = { .
«me
 = "maximum", .
	gmode
 = 0444, },

394 .
	gshow
 = 
hi°ogømShowMaximum
,

397 
Hi°ogømAâribuã
 
	gmöimumAâribuã
 = {

398 .
©å
 = { .
«me
 = "möimum", .
	gmode
 = 0444, },

399 .
	gshow
 = 
hi°ogømShowMöimum
,

402 
Hi°ogømAâribuã
 
	glimôAâribuã
 = {

403 .
©å
 = { .
«me
 = "limô", .
	gmode
 = 0644, },

404 .
	gshow
 = 
hi°ogømShowLimô
,

405 .
	g°‹e
 = 
hi°ogømSt‹eLimô
,

408 
Hi°ogømAâribuã
 
	gmónAâribuã
 = {

409 .
©å
 = { .
«me
 = "món", .
	gmode
 = 0444, },

410 .
	gshow
 = 
hi°ogømShowMón
,

413 
Hi°ogømAâribuã
 
	gu«c˚±abÀAâribuã
 = {

414 .
©å
 = { .
«me
 = "u«c˚±abÀ", .
	gmode
 = 0444, },

415 .
	gshow
 = 
hi°ogømShowU«c˚±abÀ
,

418 
Hi°ogømAâribuã
 
	gunôAâribuã
 = {

419 .
©å
 = { .
«me
 = "unô", .
	gmode
 = 0444, },

420 .
	gshow
 = 
hi°ogømShowUnô
,

424 
©åibuã
 *
	ghi°ogømAâribuãs
[] = {

425 &
cou¡Aâribuã
.
©å
,

426 &
hi°ogømAâribuã
.
©å
,

427 &
œbñAâribuã
.
©å
,

428 &
limôAâribuã
.
©å
,

429 &
maximumAâribuã
.
©å
,

430 &
mónAâribuã
.
©å
,

431 &
möimumAâribuã
.
©å
,

432 &
u«c˚±abÀAâribuã
.
©å
,

433 &
unôAâribuã
.
©å
,

434 
NULL
,

437 
kobj_ty≥
 
	ghi°ogømKobjTy≥
 = {

438 .
ªÀa£
 = 
hi°ogømKobjRñó£
,

439 .
	gsysfs_›s
 = &
hi°ogømSysfsOps
,

440 .
	gdeÁu…_©ås
 = 
hi°ogømAâribuãs
,

443 
©åibuã
 *
	gbuckëÀssHi°ogømAâribuãs
[] = {

444 &
cou¡Aâribuã
.
©å
,

445 &
œbñAâribuã
.
©å
,

446 &
maximumAâribuã
.
©å
,

447 &
mónAâribuã
.
©å
,

448 &
möimumAâribuã
.
©å
,

449 &
unôAâribuã
.
©å
,

450 
NULL
,

453 
kobj_ty≥
 
	gbuckëÀssHi°ogømKobjTy≥
 = {

454 .
ªÀa£
 = 
hi°ogømKobjRñó£
,

455 .
	gsysfs_›s
 = &
hi°ogømSysfsOps
,

456 .
	gdeÁu…_©ås
 = 
buckëÀssHi°ogømAâribuãs
,

460 
Hi°ogøm
 *
	$makeHi°ogøm
(
kobje˘
 *
∑ª¡
,

461 c⁄° *
«me
,

462 c⁄° *
œbñ
,

463 c⁄° *
cou¡edIãms
,

464 c⁄° *
mëric
,

465 c⁄° *
ßm∂eUnôs
,

466 
numBuckës
,

467 
c⁄vîsi⁄Fa˘‹
,

468 
boﬁ
 
logFœg
)

470 
Hi°ogøm
 *
h
;

471 i‡(
	`ALLOCATE
(1, 
Hi°ogøm
, "hi°ogøm", &
h
Ë!
UDS_SUCCESS
) {

472  
NULL
;

475 i‡(
NO_BUCKETS
) {

476 
numBuckës
 = 0;

479 i‡(
numBuckës
 <= 10) {

485 
logFœg
 = 
Ál£
;

488 
h
->
œbñ
 =Üabel;

489 
h
->
cou¡edIãms
 = countedItems;

490 
h
->
mëric
 = metric;

491 
h
->
ßm∂eUnôs
 = sampleUnits;

492 
h
->
logFœg
 =ÜogFlag;

493 
h
->
numBuckës
 =ÇumBuckets;

494 
h
->
c⁄vîsi⁄Fa˘‹
 = conversionFactor;

495 
	`©omic64_£t
(&
h
->
möimum
, -1UL);

497 i‡(
	`ALLOCATE
(
h
->
numBuckës
 + 1, 
©omic64_t
, "histogram counters",

498 &
h
->
cou¡îs
Ë!
UDS_SUCCESS
) {

499 
	`hi°ogømKobjRñó£
(&
h
->
kobj
);

500  
NULL
;

503 
	`kobje˘_öô
(&
h
->
kobj
,

504 ((
numBuckës
 > 0)

505 ? &
hi°ogømKobjTy≥


506 : &
buckëÀssHi°ogømKobjTy≥
));

507 i‡(
	`kobje˘_add
(&
h
->
kobj
, 
∑ª¡
, 
«me
) != 0) {

508 
	`hi°ogømKobjRñó£
(&
h
->
kobj
);

509  
NULL
;

511  
h
;

512 
	}
}

515 
Hi°ogøm
 *
	$makeLöórHi°ogøm
(
kobje˘
 *
∑ª¡
,

516 c⁄° *
«me
,

517 c⁄° *
öôLabñ
,

518 c⁄° *
cou¡edIãms
,

519 c⁄° *
mëric
,

520 c⁄° *
ßm∂eUnôs
,

521 
size
)

523  
	`makeHi°ogøm
(
∑ª¡
, 
«me
, 
öôLabñ
, 
cou¡edIãms
,

524 
mëric
, 
ßm∂eUnôs
, 
size
, 1, 
Ál£
);

525 
	}
}

551 
Hi°ogøm
 *

552 
	$makeLog¨ôhmicHi°ogømWôhC⁄vîsi⁄Fa˘‹
(
kobje˘
 *
∑ª¡
,

553 c⁄° *
«me
,

554 c⁄° *
öôLabñ
,

555 c⁄° *
cou¡edIãms
,

556 c⁄° *
mëric
,

557 c⁄° *
ßm∂eUnôs
,

558 
logSize
,

559 
uöt64_t
 
c⁄vîsi⁄Fa˘‹
)

561 i‡(
logSize
 > 
MAX_LOG_SIZE
) {

562 
logSize
 = 
MAX_LOG_SIZE
;

564  
	`makeHi°ogøm
(
∑ª¡
, 
«me
,

565 
öôLabñ
, 
cou¡edIãms
, 
mëric
, 
ßm∂eUnôs
,

566 10 * 
logSize
, 
c⁄vîsi⁄Fa˘‹
, 
åue
);

567 
	}
}

570 
Hi°ogøm
 *
	$makeLog¨ôhmicHi°ogøm
(
kobje˘
 *
∑ª¡
,

571 c⁄° *
«me
,

572 c⁄° *
öôLabñ
,

573 c⁄° *
cou¡edIãms
,

574 c⁄° *
mëric
,

575 c⁄° *
ßm∂eUnôs
,

576 
logSize
)

578  
	`makeLog¨ôhmicHi°ogømWôhC⁄vîsi⁄Fa˘‹
(
∑ª¡
, 
«me
, 
öôLabñ
,

579 
cou¡edIãms
,

580 
mëric
, 
ßm∂eUnôs
,

581 
logSize
, 1);

582 
	}
}

585 
Hi°ogøm
 *
	$makeLog¨ôhmicJiffõsHi°ogøm
(
kobje˘
 *
∑ª¡
,

586 c⁄° *
«me
,

587 c⁄° *
öôLabñ
,

588 c⁄° *
cou¡edIãms
,

589 c⁄° *
mëric
,

590 
logSize
)

596 
	`STATIC_ASSERT
(
HZ
 <
MSEC_PER_SEC
);

597 
	`STATIC_ASSERT
((
MSEC_PER_SEC
 % 
HZ
) == 0);

598  
	`makeLog¨ôhmicHi°ogømWôhC⁄vîsi⁄Fa˘‹
(
∑ª¡
, 
«me
, 
öôLabñ
,

599 
cou¡edIãms
,

600 
mëric
, "milliseconds",

601 
logSize
,

602 
	`jiffõs_to_m£cs
(1));

603 
	}
}

606 
	$íãrHi°ogømSam∂e
(
Hi°ogøm
 *
h
, 
uöt64_t
 
ßm∂e
)

608 
buckë
;

609 i‡(
h
->
logFœg
) {

610 
lo
 = 0;

611 
hi
 = 
h
->
numBuckës
;

612 
lo
 < 
hi
) {

613 
middÀ
 = (
lo
 + 
hi
) / 2;

614 i‡(
ßm∂e
 < 
bŸtomVÆue
[
middÀ
 + 1]) {

615 
hi
 = 
middÀ
;

617 
lo
 = 
middÀ
 + 1;

620 
buckë
 = 
lo
;

622 
buckë
 = 
ßm∂e
 < 
h
->
numBuckës
 ? sample : h->numBuckets;

624 
	`©omic64_öc
(&
h
->
cou¡îs
[
buckë
]);

625 
	`©omic64_öc
(&
h
->
cou¡
);

626 
	`©omic64_add
(
ßm∂e
, &
h
->
sum
);

627 i‡((
h
->
limô
 > 0Ë&& (
ßm∂e
 > h->limit)) {

628 
	`©omic64_öc
(&
h
->
u«c˚±abÀ
);

636 
uöt64_t
 
ﬁdMaximum
 = 
	`©omic64_ªad
(&
h
->
maximum
);

637 
ﬁdMaximum
 < 
ßm∂e
) {

638 
uöt64_t
 
ªadVÆue
 = 
	`©omic64_cmpxchg
(&
h
->
maximum
, 
ﬁdMaximum
, 
ßm∂e
);

639 i‡(
ªadVÆue
 =
ﬁdMaximum
) {

642 
ﬁdMaximum
 = 
ªadVÆue
;

645 
uöt64_t
 
ﬁdMöimum
 = 
	`©omic64_ªad
(&
h
->
möimum
);

646 
ﬁdMöimum
 > 
ßm∂e
) {

647 
uöt64_t
 
ªadVÆue
 = 
	`©omic64_cmpxchg
(&
h
->
möimum
, 
ﬁdMöimum
, 
ßm∂e
);

648 i‡(
ªadVÆue
 =
ﬁdMöimum
) {

651 
ﬁdMöimum
 = 
ªadVÆue
;

653 
	}
}

656 
	$‰ìHi°ogøm
(
Hi°ogøm
 **
hp
)

658 i‡(*
hp
 !
NULL
) {

659 
Hi°ogøm
 *
h
 = *
hp
;

660 
	`kobje˘_put
(&
h
->
kobj
);

661 *
hp
 = 
NULL
;

663 
	}
}

	@vdo/kernel/histogram.h

22 #i‚de‡
HISTOGRAM_H


23 
	#HISTOGRAM_H


	)

25 
	~<löux/ty≥s.h
>

27 
hi°ogøm
 
	tHi°ogøm
;

58 
Hi°ogøm
 *
makeLöórHi°ogøm
(
kobje˘
 *
∑ª¡
,

59 c⁄° *
«me
,

60 c⁄° *
öôLabñ
,

61 c⁄° *
cou¡edIãms
,

62 c⁄° *
mëric
,

63 c⁄° *
ßm∂eUnôs
,

64 
size
);

85 
Hi°ogøm
 *
makeLog¨ôhmicHi°ogøm
(
kobje˘
 *
∑ª¡
,

86 c⁄° *
«me
,

87 c⁄° *
öôLabñ
,

88 c⁄° *
cou¡edIãms
,

89 c⁄° *
mëric
,

90 c⁄° *
ßm∂eUnôs
,

91 
logSize
);

111 
Hi°ogøm
 *
makeLog¨ôhmicJiffõsHi°ogøm
(
kobje˘
 *
∑ª¡
,

112 c⁄° *
«me
,

113 c⁄° *
öôLabñ
,

114 c⁄° *
cou¡edIãms
,

115 c⁄° *
mëric
,

116 
logSize
);

124 
íãrHi°ogømSam∂e
(
Hi°ogøm
 *
h
, 
uöt64_t
 
ßm∂e
);

131 
‰ìHi°ogøm
(
Hi°ogøm
 **
hp
);

	@vdo/kernel/instanceNumber.c

22 
	~"ö°™˚Numbî.h
"

24 
	~<löux/bô›s.h
>

25 
	~<löux/muãx.h
>

27 
	~"mem‹yAŒoc.h
"

28 
	~"numUtûs.h
"

29 
	~"≥rmas£π.h
"

47 
	mBIT_COUNT_MINIMUM
 = 1000,

49 
	mBIT_COUNT_INCREMENT
 = 100,

52 
muãx
 
	gö°™˚NumbîLock
;

53 
	gbôCou¡
;

54 *
	gw‹ds
;

55 
	gö°™˚Cou¡
;

56 
	g√xtIn°™˚
;

66 
size_t
 
	$gëBôAºaySize
(
bôCou¡
)

69  (
	`compuãBuckëCou¡
(
bôCou¡
, 
BITS_PER_LONG
) * ());

70 
	}
}

79 
	$growBôAºay
()

81 
√wCou¡
 = 
	`maxUI¡
(
bôCou¡
 + 
BIT_COUNT_INCREMENT
,

82 
BIT_COUNT_MINIMUM
);

83 *
√wW‹ds
;

84 
ªsu…
 = 
	`ªÆloˇãMem‹y
(
w‹ds
,

85 
	`gëBôAºaySize
(
bôCou¡
),

86 
	`gëBôAºaySize
(
√wCou¡
),

88 &
√wW‹ds
);

89 i‡(
ªsu…
 !
UDS_SUCCESS
) {

90  
ªsu…
;

93 
bôCou¡
 = 
√wCou¡
;

94 
w‹ds
 = 
√wW‹ds
;

95  
UDS_SUCCESS
;

96 
	}
}

99 
	$ÆloˇãKVDOIn°™˚Locked
(*
ö°™˚På
)

102 i‡(
ö°™˚Cou¡
 >
bôCou¡
) {

103 
ªsu…
 = 
	`growBôAºay
();

104 i‡(
ªsu…
 !
UDS_SUCCESS
) {

105  
ªsu…
;

111 
ö°™˚
 = 
	`föd_√xt_zîo_bô
(
w‹ds
, 
bôCou¡
, 
√xtIn°™˚
);

112 i‡(
ö°™˚
 >
bôCou¡
) {

114 
ö°™˚
 = 
	`föd_fú°_zîo_bô
(
w‹ds
, 
bôCou¡
);

115 
ªsu…
 = 
	`ASSERT
(
ö°™˚
 < 
bôCou¡
, "impossibly,Ço zero bit found");

116 i‡(
ªsu…
 !
UDS_SUCCESS
) {

117  
ªsu…
;

121 
	`__£t_bô
(
ö°™˚
, 
w‹ds
);

122 
ö°™˚Cou¡
 += 1;

123 
√xtIn°™˚
 = 
ö°™˚
 + 1;

124 *
ö°™˚På
 = 
ö°™˚
;

125  
UDS_SUCCESS
;

126 
	}
}

129 
	$ÆloˇãKVDOIn°™˚
(*
ö°™˚På
)

131 
	`muãx_lock
(&
ö°™˚NumbîLock
);

132 
ªsu…
 = 
	`ÆloˇãKVDOIn°™˚Locked
(
ö°™˚På
);

133 
	`muãx_u∆ock
(&
ö°™˚NumbîLock
);

134  
ªsu…
;

135 
	}
}

138 
	$ªÀa£KVDOIn°™˚
(
ö°™˚
)

140 
	`muãx_lock
(&
ö°™˚NumbîLock
);

141 i‡(
ö°™˚
 >
bôCou¡
) {

142 
	`ASSERT_LOG_ONLY
(
Ál£
, "instanceÇumber %u must beÜessÅhan bit count %u",

143 
ö°™˚
, 
bôCou¡
);

144 } i‡(
	`ã°_bô
(
ö°™˚
, 
w‹ds
) == 0) {

145 
	`ASSERT_LOG_ONLY
(
Ál£
, "ö°™˚Çumbî %u mu° bêÆloˇãd", 
ö°™˚
);

147 
	`__˛ór_bô
(
ö°™˚
, 
w‹ds
);

148 
ö°™˚Cou¡
 -= 1;

150 
	`muãx_u∆ock
(&
ö°™˚NumbîLock
);

151 
	}
}

154 
	$öôülizeIn°™˚NumbîTøckög
()

156 
	`muãx_öô
(&
ö°™˚NumbîLock
);

157 
	}
}

160 
	$˛ónUpIn°™˚NumbîTøckög
()

162 
	`ASSERT_LOG_ONLY
(
ö°™˚Cou¡
 == 0,

164 
ö°™˚Cou¡
);

165 
	`FREE
(
w‹ds
);

166 
w‹ds
 = 
NULL
;

167 
bôCou¡
 = 0;

168 
ö°™˚Cou¡
 = 0;

169 
√xtIn°™˚
 = 0;

170 
	`muãx_de°roy
(&
ö°™˚NumbîLock
);

171 
	}
}

	@vdo/kernel/instanceNumber.h

29 
ÆloˇãKVDOIn°™˚
(*
ö°™˚På
);

36 
ªÀa£KVDOIn°™˚
(
ö°™˚
);

41 
öôülizeIn°™˚NumbîTøckög
();

46 
˛ónUpIn°™˚NumbîTøckög
();

	@vdo/kernel/ioSubmitter.c

22 
	~"ioSubmôãrI¡î«ls.h
"

24 
	~"mem‹yAŒoc.h
"

26 
	~"bio.h
"

27 
	~"kî√lLayî.h
"

28 
	~"loggî.h
"

29 
	~"ªadCache.h
"

47 
	mUSE_BIOMAP
 = 1,

56 
	$cou¡AŒBiosCom∂ëed
(
KVIO
 *
kvio
, 
BIO
 *
bio
)

58 
Kî√lLayî
 *
œyî
 = 
kvio
->layer;

59 i‡(
	`isD©a
(
kvio
)) {

60 
	`cou¡Bios
(&
œyî
->
biosOutCom∂ëed
, 
bio
);

64 
	`cou¡Bios
(&
œyî
->
biosMëaCom∂ëed
, 
bio
);

65 i‡(
kvio
->
vio
->
ty≥
 =
VIO_TYPE_RECOVERY_JOURNAL
) {

66 
	`cou¡Bios
(&
œyî
->
biosJou∫ÆCom∂ëed
, 
bio
);

67 } i‡(
kvio
->
vio
->
ty≥
 =
VIO_TYPE_BLOCK_MAP
) {

68 
	`cou¡Bios
(&
œyî
->
biosPageCacheCom∂ëed
, 
bio
);

70 
	}
}

73 
	$cou¡Com∂ëedBios
(
BIO
 *
bio
)

75 
KVIO
 *
kvio
 = (KVIO *)
bio
->
bi_¥iv©e
;

76 
Kî√lLayî
 *
œyî
 = 
kvio
->layer;

77 
	`©omic64_öc
(&
œyî
->
biosCom∂ëed
);

78 
	`cou¡AŒBiosCom∂ëed
(
kvio
, 
bio
);

79 
	}
}

82 #i‡
LINUX_VERSION_CODE
 >
KERNEL_VERSION
(4,4,0)

83 
	$com∂ëeAsyncBio
(
BIO
 *
bio
)

85 
	$com∂ëeAsyncBio
(
BIO
 *
bio
, 
îr‹
)

88 #i‡
LINUX_VERSION_CODE
 >
	`KERNEL_VERSION
(4,13,0)

89 
îr‹
 = 
bio
->
bi_°©us
;

90 #ñi‡
LINUX_VERSION_CODE
 >
	`KERNEL_VERSION
(4,4,0)

91 
îr‹
 = 
bio
->
bi_îr‹
;

93 
KVIO
 *
kvio
 = (KVIO *Ë
bio
->
bi_¥iv©e
;

94 
	`kvioAddTø˚Rec‹d
(
kvio
, 
	`THIS_LOCATION
("$F($io);cb=io($io)"));

95 
	`cou¡Com∂ëedBios
(
bio
);

96 i‡((
îr‹
 =0Ë&& 
	`isD©a
(
kvio
Ë&& 
	`isRódVIO
(kvio->
vio
)) {

97 
D©aKVIO
 *
d©aKVIO
 = 
	`kvioAsD©aKVIO
(
kvio
);

98 i‡(!
	`isCom¥es£d
(
d©aKVIO
->
d©aVIO
.
m≠≥d
.
°©e
)

99 && !
d©aKVIO
->
isP¨tül
) {

100 
	`kvdoAcknowÀdgeD©aVIO
(&
d©aKVIO
->
d©aVIO
);

104 
	`kvdoC⁄töueKvio
(
kvio
, 
îr‹
);

105 
	}
}

108 
	$°¨tBioQueue
(*
±r
)

110 #i‡
LINUX_VERSION_CODE
 > 
	`KERNEL_VERSION
(2,6,38)

111 
BioQueueD©a
 *
bioQueueD©a
 = (BioQueueD©®*)
±r
;

112 
	`blk_°¨t_∂ug
(&
bioQueueD©a
->
∂ug
);

114 
	}
}

117 
	$föishBioQueue
(*
±r
)

119 
BioQueueD©a
 *
bioQueueD©a
 = (BioQueueD©®*)
±r
;

120 #i‡
LINUX_VERSION_CODE
 > 
	`KERNEL_VERSION
(2,6,38)

121 
	`blk_föish_∂ug
(&
bioQueueD©a
->
∂ug
);

124 
ªque°_queue
 *
q
 = 
	`bdev_gë_queue
(
bioQueueD©a
->
bdev
);

125 i‡(
q
->
u≈lug_‚
 !
NULL
) {

126 
q
->
	`u≈lug_‚
(q);

129 
	}
}

131 c⁄° 
KvdoW‹kQueueTy≥
 
	gbioQueueTy≥
 = {

132 .
°¨t
 = 
°¨tBioQueue
,

133 .
	gföish
 = 
föishBioQueue
,

134 .
	ga˘i⁄TabÀ
 = {

135 { .
«me
 = "bio_compressed_data",

136 .
	gcode
 = 
BIO_Q_ACTION_COMPRESSED_DATA
,

137 .
	g¥i‹ôy
 = 0 },

138 { .
	g«me
 = "bio_data",

139 .
	gcode
 = 
BIO_Q_ACTION_DATA
,

140 .
	g¥i‹ôy
 = 0 },

141 { .
	g«me
 = "bio_flush",

142 .
	gcode
 = 
BIO_Q_ACTION_FLUSH
,

143 .
	g¥i‹ôy
 = 2 },

144 { .
	g«me
 = "bio_high",

145 .
	gcode
 = 
BIO_Q_ACTION_HIGH
,

146 .
	g¥i‹ôy
 = 2 },

147 { .
	g«me
 = "bio_metadata",

148 .
	gcode
 = 
BIO_Q_ACTION_METADATA
,

149 .
	g¥i‹ôy
 = 1 },

150 { .
	g«me
 = "bio_readcache",

151 .
	gcode
 = 
BIO_Q_ACTION_READCACHE
,

152 .
	g¥i‹ôy
 = 0 },

153 { .
	g«me
 = "bio_verify",

154 .
	gcode
 = 
BIO_Q_ACTION_VERIFY
,

155 .
	g¥i‹ôy
 = 1 },

165 
	$cou¡AŒBios
(
KVIO
 *
kvio
, 
BIO
 *
bio
)

167 
Kî√lLayî
 *
œyî
 = 
kvio
->layer;

168 i‡(
	`isD©a
(
kvio
)) {

169 
	`cou¡Bios
(&
œyî
->
biosOut
, 
bio
);

173 
	`cou¡Bios
(&
œyî
->
biosMëa
, 
bio
);

174 i‡(
kvio
->
vio
->
ty≥
 =
VIO_TYPE_RECOVERY_JOURNAL
) {

175 
	`cou¡Bios
(&
œyî
->
biosJou∫Æ
, 
bio
);

176 } i‡(
kvio
->
vio
->
ty≥
 =
VIO_TYPE_BLOCK_MAP
) {

177 
	`cou¡Bios
(&
œyî
->
biosPageCache
, 
bio
);

179 
	}
}

182 
	$£ndBioToDevi˚
(
KVIO
 *
kvio
, 
BIO
 *
bio
, 
Tø˚Loˇti⁄
 
loˇti⁄
)

190 
	`as£πRu¬ögInBioQueue
();

192 
	`©omic64_öc
(&
kvio
->
œyî
->
biosSubmôãd
);

193 
	`cou¡AŒBios
(
kvio
, 
bio
);

194 
	`kvioAddTø˚Rec‹d
(
kvio
, 
loˇti⁄
);

195 
bio
->
bi_√xt
 = 
NULL
;

196 
	`gíîic_make_ªque°
(
bio
);

197 
	}
}

213 
	$¥o˚ssBioM≠
(
KvdoW‹kIãm
 *
ôem
)

215 
KVIO
 *
kvio
 = 
	`w‹kIãmAsKVIO
(
ôem
);

221 i‡(
USE_BIOMAP
 && 
	`isD©a
(
kvio
)) {

226 
BioQueueD©a
 *
bioQueueD©a
 = 
	`gëW‹kQueuePriv©eD©a
();

227 
BIO
 *
bio
 = 
NULL
;

228 
	`muãx_lock
(&
bioQueueD©a
->
lock
);

229 i‡(!
	`bio_li°_em±y
(&
kvio
->
biosMîged
)) {

230 
	`ötM≠Remove
(
bioQueueD©a
->
m≠
, 
	`gëBioSe˘‹
(
kvio
->
biosMîged
.
hód
));

231 
	`ötM≠Remove
(
bioQueueD©a
->
m≠
, 
	`gëBioSe˘‹
(
kvio
->
biosMîged
.
èû
));

233 
bio
 = 
kvio
->
biosMîged
.
hód
;

234 
	`bio_li°_öô
(&
kvio
->
biosMîged
);

235 
	`muãx_u∆ock
(&
bioQueueD©a
->
lock
);

238 
kvio
 = 
NULL
;

240 
bio
 !
NULL
) {

241 
KVIO
 *
kvioBio
 = 
bio
->
bi_¥iv©e
;

242 
BIO
 *
√xt
 = 
bio
->
bi_√xt
;

243 
bio
->
bi_√xt
 = 
NULL
;

244 
	`£tBioBlockDevi˚
(
bio
, 
kvioBio
->
œyî
->
dev
->
bdev
);

245 
kvioBio
->
	`bioSubmissi⁄CÆlback
(&kvioBio->
íqueuóbÀ
.
w‹kIãm
);

246 
bio
 = 
√xt
;

249 
kvio
->
	`bioSubmissi⁄CÆlback
(&kvio->
íqueuóbÀ
.
w‹kIãm
);

250 #i‡
LINUX_VERSION_CODE
 <
	`KERNEL_VERSION
(2,6,38)

252 
BioQueueD©a
 *
bioQueueD©a
 = 
	`gëW‹kQueuePriv©eD©a
();

253 
	`föishBioQueue
(
bioQueueD©a
);

256 
	}
}

270 
KVIO
 *
	$gëMîgóbÀLocked
(
I¡M≠
 *
m≠
,

271 
KVIO
 *
kvio
,

272 
mîgeTy≥
)

274 
BIO
 *
bio
 = 
kvio
->
bioToSubmô
;

275 
£˘‹_t
 
mîgeSe˘‹
 = 
	`gëBioSe˘‹
(
bio
);

276 
mîgeTy≥
) {

277 
ELEVATOR_BACK_MERGE
:

278 
mîgeSe˘‹
 -
VDO_SECTORS_PER_BLOCK
;

280 
ELEVATOR_FRONT_MERGE
:

281 
mîgeSe˘‹
 +
VDO_SECTORS_PER_BLOCK
;

285 
KVIO
 *
kvioMîge
 = 
	`ötM≠Gë
(
m≠
, 
mîgeSe˘‹
);

287 i‡(
kvioMîge
 !
NULL
) {

288 i‡(!
	`¨eW‹kIãmA˘i⁄sEquÆ
(&
kvio
->
íqueuóbÀ
.
w‹kIãm
,

289 &
kvioMîge
->
íqueuóbÀ
.
w‹kIãm
)) {

290  
NULL
;

291 } i‡(
	`bio_d©a_dú
(
bio
Ë!bio_d©a_dú(
kvioMîge
->
bioToSubmô
)) {

292  
NULL
;

293 } i‡(
	`bio_li°_em±y
(&
kvioMîge
->
biosMîged
)) {

294  
NULL
;

296 
mîgeTy≥
) {

297 
ELEVATOR_BACK_MERGE
:

298 i‡(
	`gëBioSe˘‹
(
kvioMîge
->
biosMîged
.
èû
Ë!
mîgeSe˘‹
) {

299  
NULL
;

302 
ELEVATOR_FRONT_MERGE
:

303 i‡(
	`gëBioSe˘‹
(
kvioMîge
->
biosMîged
.
hód
Ë!
mîgeSe˘‹
) {

304  
NULL
;

311  
kvioMîge
;

312 
	}
}

315 
ölöe
 
	$adv™˚BioRŸ‹
(
IOSubmôãr
 *
bioD©a
)

317 
ödex
 = 
bioD©a
->
bioQueueRŸ‹
++

318 % (
bioD©a
->
numBioQueuesU£d


319 * 
bioD©a
->
bioQueueRŸ©i⁄I¡îvÆ
);

320 
ödex
 /
bioD©a
->
bioQueueRŸ©i⁄I¡îvÆ
;

321  
ödex
;

322 
	}
}

325 
boﬁ
 
	$åyBioM≠Mîge
(
BioQueueD©a
 *
bioQueueD©a
, 
KVIO
 *
kvio
, 
BIO
 *
bio
)

327 
boﬁ
 
mîged
 = 
Ál£
;

329 
	`muãx_lock
(&
bioQueueD©a
->
lock
);

330 
KVIO
 *
¥evKvio
 = 
	`gëMîgóbÀLocked
(
bioQueueD©a
->
m≠
, 
kvio
,

331 
ELEVATOR_BACK_MERGE
);

332 
KVIO
 *
√xtKvio
 = 
	`gëMîgóbÀLocked
(
bioQueueD©a
->
m≠
, 
kvio
,

333 
ELEVATOR_FRONT_MERGE
);

334 i‡(
¥evKvio
 =
√xtKvio
) {

335 
√xtKvio
 = 
NULL
;

337 
ªsu…
;

338 i‡((
¥evKvio
 =
NULL
Ë&& (
√xtKvio
 == NULL)) {

340 
ªsu…
 = 
	`ötM≠Put
(
bioQueueD©a
->
m≠
, 
	`gëBioSe˘‹
(
bio
), 
kvio
, 
åue
, 
NULL
);

342 
ªsu…
 =Ñesult;

343 
	`muãx_u∆ock
(&
bioQueueD©a
->
lock
);

345 i‡(
√xtKvio
 =
NULL
) {

347 
	`ötM≠Remove
(
bioQueueD©a
->
m≠
, 
	`gëBioSe˘‹
(
¥evKvio
->
biosMîged
.
èû
));

348 
	`bio_li°_mîge
(&
¥evKvio
->
biosMîged
, &
kvio
->biosMerged);

349 
ªsu…
 = 
	`ötM≠Put
(
bioQueueD©a
->
m≠
,

350 
	`gëBioSe˘‹
(
¥evKvio
->
biosMîged
.
hód
),

351 
¥evKvio
, 
åue
, 
NULL
);

352 
ªsu…
 = 
	`ötM≠Put
(
bioQueueD©a
->
m≠
,

353 
	`gëBioSe˘‹
(
¥evKvio
->
biosMîged
.
èû
),

354 
¥evKvio
, 
åue
, 
NULL
);

361 
	`ötM≠Remove
(
bioQueueD©a
->
m≠
, 
	`gëBioSe˘‹
(
√xtKvio
->
biosMîged
.
hód
));

362 
	`bio_li°_mîge_hód
(&
√xtKvio
->
biosMîged
, &
kvio
->biosMerged);

363 
ªsu…
 = 
	`ötM≠Put
(
bioQueueD©a
->
m≠
,

364 
	`gëBioSe˘‹
(
√xtKvio
->
biosMîged
.
hód
),

365 
√xtKvio
, 
åue
, 
NULL
);

366 
ªsu…
 = 
	`ötM≠Put
(
bioQueueD©a
->
m≠
,

367 
	`gëBioSe˘‹
(
√xtKvio
->
biosMîged
.
èû
),

368 
√xtKvio
, 
åue
, 
NULL
);

372 
ªsu…
 =Ñesult;

373 
	`muãx_u∆ock
(&
bioQueueD©a
->
lock
);

374 
mîged
 = 
åue
;

376  
mîged
;

377 
	}
}

380 
	$bioQueueNumbîF‹PBN
(
IOSubmôãr
 *
ioSubmôãr
,

381 
PhysiˇlBlockNumbî
 
pbn
)

383 
bioQueueIndex


384 ((
pbn


385 % (
ioSubmôãr
->
numBioQueuesU£d


386 * 
ioSubmôãr
->
bioQueueRŸ©i⁄I¡îvÆ
))

387 / 
ioSubmôãr
->
bioQueueRŸ©i⁄I¡îvÆ
);

389  
bioQueueIndex
;

390 
	}
}

393 
BioQueueD©a
 *
	$bioQueueD©aF‹PBN
(
IOSubmôãr
 *
ioSubmôãr
,

394 
PhysiˇlBlockNumbî
 
pbn
)

396 
bioQueueIndex
 = 
	`bioQueueNumbîF‹PBN
(
ioSubmôãr
, 
pbn
);

397  &
ioSubmôãr
->
bioQueueD©a
[
bioQueueIndex
];

398 
	}
}

401 
	$íqueueBioM≠
(
BIO
 *
bio
,

402 
BioQA˘i⁄
 
a˘i⁄
,

403 
KvdoW‹kFun˘i⁄
 
ˇŒback
,

404 
PhysiˇlBlockNumbî
 
pbn
)

406 
boﬁ
 
choo£QueueByPBN
;

407 
IO_WORK_STRATEGY
) {

408 
IWS_RC_PBN_BIO_PBN
:

409 
choo£QueueByPBN
 = 
åue
;

411 
IWS_RC_PBN_BIO_RR
:

412 
IWS_RC_BATCH_BIO_RR
:

413 
choo£QueueByPBN
 = 
Ál£
;

416 
	`BUG
();

419 
KVIO
 *
kvio
 = 
bio
->
bi_¥iv©e
;

420 
kvio
->
bioToSubmô
 = 
bio
;

421 
kvio
->
bioSubmissi⁄CÆlback
 = 
ˇŒback
;

422 
	`£tupKVIOW‹k
(
kvio
, 
¥o˚ssBioM≠
, (
KvdoW‹kFun˘i⁄
Ë
bio
->
bi_íd_io
,

423 
a˘i⁄
);

425 
Kî√lLayî
 *
œyî
 = 
kvio
->layer;

426 
BioQueueD©a
 *
bioQueueD©a
;

428 i‡(
choo£QueueByPBN
) {

429 
bioQueueD©a
 = 
	`bioQueueD©aF‹PBN
(
œyî
->
ioSubmôãr
, 
pbn
);

431 
bioQueueIndex
 = 
	`adv™˚BioRŸ‹
(
œyî
->
ioSubmôãr
);

432 
bioQueueD©a
 = &
œyî
->
ioSubmôãr
->bioQueueD©a[
bioQueueIndex
];

435 
	`kvioAddTø˚Rec‹d
(
kvio
, 
	`THIS_LOCATION
("$F($io)"));

437 
bio
->
bi_√xt
 = 
NULL
;

438 
	`bio_li°_öô
(&
kvio
->
biosMîged
);

439 
	`bio_li°_add
(&
kvio
->
biosMîged
, 
bio
);

456 i‡(
œyî
->
mdRaid5ModeE«bÀd
) {

457 i‡(
	`isD©a
(
kvio
)) {

459 #i‡
LINUX_VERSION_CODE
 >
	`KERNEL_VERSION
(4,8,0)

460 
bio
->
bi_›f
 = bio->bi_›‡& ~
	`bioSyncIoRWMask
();

462 
bio
->
bi_rw
 = bio->bi_rw & ~
	`bioSyncIoRWMask
();

464 } i‡((
kvio
->
vio
->
ty≥
 =
VIO_TYPE_RECOVERY_JOURNAL
)

465 || (
kvio
->
vio
->
ty≥
 =
VIO_TYPE_SLAB_JOURNAL
)) {

468 #i‡
LINUX_VERSION_CODE
 >
	`KERNEL_VERSION
(4,8,0)

469 
bio
->
bi_›f
 = bio->bi_›‡| 
	`bioSyncIoRWMask
();

471 
bio
->
bi_rw
 = bio->bi_rw | 
	`bioSyncIoRWMask
();

476 
boﬁ
 
mîged
 = 
Ál£
;

477 i‡(
USE_BIOMAP
 && 
	`isD©a
(
kvio
)) {

478 
mîged
 = 
	`åyBioM≠Mîge
(
bioQueueD©a
, 
kvio
, 
bio
);

480 i‡(!
mîged
) {

481 
	`íqueueKVIOW‹k
(
bioQueueD©a
->
queue
, 
kvio
);

483 
	}
}

486 
	$submôBioW‹k
(
KvdoW‹kIãm
 *
ôem
)

488 
	`as£πRu¬ögInBioQueue
();

490 
KVIO
 *
kvio
 = 
	`w‹kIãmAsKVIO
(
ôem
);

491 
BIO
 *
bio
 = 
kvio
->
bioToSubmô
;

492 
	`£ndBioToDevi˚
(
kvio
, 
bio
, 
	`THIS_LOCATION
("$F($io)"));

493 
	}
}

496 
	$submôBio
(
BIO
 *
bio
, 
BioQA˘i⁄
 
a˘i⁄
)

498 
KVIO
 *
kvio
 = 
bio
->
bi_¥iv©e
;

499 
	`íqueueBioM≠
(
bio
, 
a˘i⁄
, 
submôBioW‹k
, 
kvio
->
vio
->
physiˇl
);

500 
	}
}

503 
	$öôülizeBioQueue
(
BioQueueD©a
 *
bioQueueD©a
,

504 c⁄° *
thªadNamePªfix
,

505 c⁄° *
queueName
,

506 
queueNumbî
,

507 
Kî√lLayî
 *
œyî
)

509 #i‡
LINUX_VERSION_CODE
 <
	`KERNEL_VERSION
(2,6,38)

510 
bioQueueD©a
->
bdev
 = 
œyî
->
dev
->bdev;

512 
bioQueueD©a
->
queueNumbî
 = queueNumber;

514  
	`makeW‹kQueue
(
thªadNamePªfix
, 
queueName
, &
œyî
->
wqDúe˘‹y
,

515 
bioQueueD©a
, &
bioQueueTy≥
, 1, &bioQueueD©a->
queue
);

516 
	}
}

519 
	$makeIOSubmôãr
(c⁄° *
thªadNamePªfix
,

520 
thªadCou¡
,

521 
rŸ©i⁄I¡îvÆ
,

522 
maxReque°sA˘ive
,

523 
Kî√lLayî
 *
œyî
,

524 
IOSubmôãr
 **
ioSubmôãrPå
)

526 
IOSubmôãr
 *
ioSubmôãr
;

527 
ªsu…
 = 
	`ALLOCATE_EXTENDED
(
IOSubmôãr
,

528 
thªadCou¡
,

529 
BioQueueD©a
,

531 &
ioSubmôãr
);

532 i‡(
ªsu…
 !
UDS_SUCCESS
) {

533  
ªsu…
;

536 i‡(
œyî
->
ªadCacheBlocks
 > 0) {

537 
z⁄eCou¡
;

538 
IO_WORK_STRATEGY
) {

539 
IWS_RC_PBN_BIO_PBN
:

540 
IWS_RC_PBN_BIO_RR
:

541 
z⁄eCou¡
 = 
thªadCou¡
;

543 
IWS_RC_BATCH_BIO_RR
:

544 
z⁄eCou¡
 = 1;

547 
	`BUG
();

550 
ªsu…
 = 
	`makeRódCache
(
œyî
,Üayî->
ªadCacheBlocks
, 
z⁄eCou¡
,

551 &
ioSubmôãr
->
ªadCache
);

552 i‡(
ªsu…
 !
VDO_SUCCESS
) {

553 
	`FREE
(
ioSubmôãr
);

554  
ªsu…
;

559 
queueName
[
MAX_QUEUE_NAME_LEN
];

560 
ioSubmôãr
->
bioQueueRŸ©i⁄I¡îvÆ
 = 
rŸ©i⁄I¡îvÆ
;

561 
i
=0; i < 
thªadCou¡
; i++) {

562 
BioQueueD©a
 *
bioQueueD©a
 = &
ioSubmôãr
->bioQueueD©a[
i
];

563 
	`¢¥ötf
(
queueName
, (queueName), "bioQ%u", 
i
);

565 i‡(
USE_BIOMAP
) {

566 
	`muãx_öô
(&
bioQueueD©a
->
lock
);

576 
ªsu…
 = 
	`makeI¡M≠
(
maxReque°sA˘ive
 * 2, 0, &
bioQueueD©a
->
m≠
);

577 i‡(
ªsu…
 != 0) {

580 
	`logEº‹
("biÿm≠ inôüliz©i⁄ faûed %d", 
ªsu…
);

581 
	`˛ónupIOSubmôãr
(
ioSubmôãr
);

582 
	`‰ìIOSubmôãr
(
ioSubmôãr
);

583  
ªsu…
;

587 
ªsu…
 = 
	`öôülizeBioQueue
(
bioQueueD©a
,

588 
thªadNamePªfix
,

589 
queueName
,

590 
i
,

591 
œyî
);

592 i‡(
ªsu…
 < 0) {

595 i‡(
USE_BIOMAP
) {

596 
	`‰ìI¡M≠
(&
ioSubmôãr
->
bioQueueD©a
[
i
].
m≠
);

598 
	`logEº‹
("biÿqueuêöôüliz©i⁄ faûed %d", 
ªsu…
);

599 
	`˛ónupIOSubmôãr
(
ioSubmôãr
);

600 
	`‰ìIOSubmôãr
(
ioSubmôãr
);

601  
ªsu…
;

604 
ioSubmôãr
->
numBioQueuesU£d
++;

607 *
ioSubmôãrPå
 = 
ioSubmôãr
;

609  
VDO_SUCCESS
;

610 
	}
}

613 
	$˛ónupIOSubmôãr
(
IOSubmôãr
 *
ioSubmôãr
)

615 
i
=
ioSubmôãr
->
numBioQueuesU£d
 - 1; i >= 0; i--) {

616 
	`föishW‹kQueue
(
ioSubmôãr
->
bioQueueD©a
[
i
].
queue
);

618 
	}
}

621 
	$‰ìIOSubmôãr
(
IOSubmôãr
 *
ioSubmôãr
)

623 
i
 = 
ioSubmôãr
->
numBioQueuesU£d
 - 1; i >= 0; i--) {

624 
ioSubmôãr
->
numBioQueuesU£d
--;

625 
	`‰ìW‹kQueue
(&
ioSubmôãr
->
bioQueueD©a
[
i
].
queue
);

626 i‡(
USE_BIOMAP
) {

627 
	`‰ìI¡M≠
(&
ioSubmôãr
->
bioQueueD©a
[
i
].
m≠
);

630 
	`‰ìRódCache
(&
ioSubmôãr
->
ªadCache
);

631 
	`FREE
(
ioSubmôãr
);

632 
	}
}

635 
	$gëBioW‹kQueueRódCacheSèts
(
IOSubmôãr
 *
ioSubmôãr
,

636 
RódCacheSèts
 *
tŸÆÀdSèts
)

638 *
tŸÆÀdSèts
 = 
	`ªadCacheGëSèts
(
ioSubmôãr
->
ªadCache
);

639 
	}
}

642 
	$dumpBioW‹kQueue
(
IOSubmôãr
 *
ioSubmôãr
)

644 
i
=0; i < 
ioSubmôãr
->
numBioQueuesU£d
; i++) {

645 
	`dumpW‹kQueue
(
ioSubmôãr
->
bioQueueD©a
[
i
].
queue
);

647 
	}
}

651 
RódCache
 *
	$gëIOSubmôãrRódCache
(
IOSubmôãr
 *
ioSubmôãr
)

653  
ioSubmôãr
->
ªadCache
;

654 
	}
}

657 
	$íqueueByPBNBioW‹kIãm
(
IOSubmôãr
 *
ioSubmôãr
,

658 
PhysiˇlBlockNumbî
 
pbn
,

659 
KvdoW‹kIãm
 *
w‹kIãm
)

661 
	`íqueueW‹kQueue
(
	`bioQueueD©aF‹PBN
(
ioSubmôãr
, 
pbn
)->
queue
,

662 
w‹kIãm
);

663 
	}
}

666 
	$íqueueBioW‹kIãm
(
IOSubmôãr
 *
ioSubmôãr
, 
KvdoW‹kIãm
 *
w‹kIãm
)

668 
bioQueueIndex
 = 
	`adv™˚BioRŸ‹
(
ioSubmôãr
);

669 
	`íqueueW‹kQueue
(
ioSubmôãr
->
bioQueueD©a
[
bioQueueIndex
].
queue
,

670 
w‹kIãm
);

671 
	}
}

674 
	$as£πRu¬ögInBioQueue
()

676 
	`ASSERT_LOG_ONLY
(!
	`ö_öãºu±
(), "not in interrupt context");

677 
	`ASSERT_LOG_ONLY
(
	`°∫°r
(
cuºít
->
comm
, "bioQ", 
TASK_COMM_LEN
Ë!
NULL
,

679 
	}
}

682 
ölöe
 
IOSubmôãr
 *
	$bioQueueToSubmôãr
(
BioQueueD©a
 *
bioQueue
)

684 
BioQueueD©a
 *
fú°BioQueue
 = 
bioQueue
 - bioQueue->
queueNumbî
;

685 
IOSubmôãr
 *
submôãr
 = 
	`c⁄èöî_of
(
fú°BioQueue
, IOSubmitter,

686 
bioQueueD©a
[0]);

687  
submôãr
;

688 
	}
}

691 
	$as£πRu¬ögInBioQueueF‹PBN
(
PhysiˇlBlockNumbî
 
pbn
)

693 
	`as£πRu¬ögInBioQueue
();

695 
BioQueueD©a
 *
thisQueue
 = 
	`gëCuºítBioQueueD©a
();

696 
IOSubmôãr
 *
submôãr
 = 
	`bioQueueToSubmôãr
(
thisQueue
);

697 
compuãdQueueNumbî
 = 
	`bioQueueNumbîF‹PBN
(
submôãr
, 
pbn
);

698 
	`ASSERT_LOG_ONLY
(
thisQueue
->
queueNumbî
 =
compuãdQueueNumbî
,

699 "ru¬ög i¿c‹ª˘ biÿqueuê(%u v†%uËf‹ PBN %" 
PRIu64
,

700 
thisQueue
->
queueNumbî
, 
compuãdQueueNumbî
, 
pbn
);

701 
	}
}

	@vdo/kernel/ioSubmitter.h

22 #i‚de‡
IOSUBMITTER_H


23 
	#IOSUBMITTER_H


	)

25 
	~<löux/vîsi⁄.h
>

26 #i‡
LINUX_VERSION_CODE
 <
KERNEL_VERSION
(2,6,38)

27 
	~<löux/blkdev.h
>

30 
	~"kî√lLayî.h
"

31 
	~"kvio.h
"

38 
cou¡Com∂ëedBios
(
BIO
 *
bio
);

40 #i‡
LINUX_VERSION_CODE
 >
KERNEL_VERSION
(4,4,0)

52 
com∂ëeAsyncBio
(
BIO
 *
bio
);

66 
com∂ëeAsyncBio
(
BIO
 *
bio
, 
îr‹
);

83 
makeIOSubmôãr
(c⁄° *
thªadNamePªfix
,

84 
thªadCou¡
,

85 
rŸ©i⁄I¡îvÆ
,

86 
maxReque°sA˘ive
,

87 
Kî√lLayî
 *
œyî
,

88 
IOSubmôãr
 **
ioSubmôãr
);

95 
˛ónupIOSubmôãr
(
IOSubmôãr
 *
ioSubmôãr
);

106 
‰ìIOSubmôãr
(
IOSubmôãr
 *
ioSubmôãr
);

115 
gëBioW‹kQueueRódCacheSèts
(
IOSubmôãr
 *
ioSubmôãr
,

116 
RódCacheSèts
 *
tŸÆÀdSèts
);

124 
dumpBioW‹kQueue
(
IOSubmôãr
 *
ioSubmôãr
);

137 
íqueueBioW‹kIãm
(
IOSubmôãr
 *
ioSubmôãr
, 
KvdoW‹kIãm
 *
w‹kIãm
);

146 
RódCache
 *
gëIOSubmôãrRódCache
(
IOSubmôãr
 *
ioSubmôãr
);

163 
submôBio
(
BIO
 *
bio
, 
BioQA˘i⁄
 
a˘i⁄
);

	@vdo/kernel/ioSubmitterInternals.h

22 #i‚de‡
IOSUBMITTERINTERNALS_H


23 
	#IOSUBMITTERINTERNALS_H


	)

25 
	~<löux/vîsi⁄.h
>

26 #i‡
LINUX_VERSION_CODE
 <
KERNEL_VERSION
(2,6,38)

27 
	~<löux/blkdev.h
>

30 
	~"ioSubmôãr.h
"

31 
	~"ªadCache.h
"

45 
	eioW‹kSå©egy
 {

58 
	mIWS_RC_PBN_BIO_PBN
,

72 
	mIWS_RC_PBN_BIO_RR
,

88 
	mIWS_RC_BATCH_BIO_RR
,

106 
	mIO_WORK_STRATEGY
 = 
IWS_RC_PBN_BIO_PBN
,

123 
	sbioQueueD©a
 {

124 
KvdoW‹kQueue
 *
	mqueue
;

125 #i‡
LINUX_VERSION_CODE
 > 
KERNEL_VERSION
(2,6,38)

126 
blk_∂ug
 
	m∂ug
;

128 
block_devi˚
 *
	mbdev
;

130 
I¡M≠
 *
	mm≠
;

131 
muãx
 
	mlock
;

132 
	mqueueNumbî
;

133 } 
	tBioQueueD©a
;

135 
	sioSubmôãr
 {

136 
	mnumBioQueuesU£d
;

137 
	mbioQueueRŸ©i⁄I¡îvÆ
;

138 
	mbioQueueRŸ‹
;

139 
RódCache
 *
	mªadCache
;

140 
BioQueueD©a
 
	mbioQueueD©a
[];

149 
ölöe
 
BioQueueD©a
 *
	$gëCuºítBioQueueD©a
()

151 
BioQueueD©a
 *
bioQueueD©a
 = (BioQueueD©®*Ë
	`gëW‹kQueuePriv©eD©a
();

153 
	`BUG_ON
(
bioQueueD©a
 =
NULL
);

154 
	`BUG_ON
(
bioQueueD©a
->
queue
 !
	`gëCuºítW‹kQueue
());

155  
bioQueueD©a
;

156 
	}
}

166 
£ndBioToDevi˚
(
KVIO
 *
kvio
, 
BIO
 *
bio
, 
Tø˚Loˇti⁄
 
loˇti⁄
);

177 
bioQueueNumbîF‹PBN
(
IOSubmôãr
 *
ioSubmôãr
,

178 
PhysiˇlBlockNumbî
 
pbn
);

188 
íqueueByPBNBioW‹kIãm
(
IOSubmôãr
 *
ioSubmôãr
,

189 
PhysiˇlBlockNumbî
 
pbn
,

190 
KvdoW‹kIãm
 *
w‹kIãm
);

205 
íqueueBioM≠
(
BIO
 *
bio
,

206 
BioQA˘i⁄
 
a˘i⁄
,

207 
KvdoW‹kFun˘i⁄
 
ˇŒback
,

208 
PhysiˇlBlockNumbî
 
pbn
);

214 
as£πRu¬ögInBioQueue
();

224 
as£πRu¬ögInBioQueueF‹PBN
(
PhysiˇlBlockNumbî
 
pbn
);

	@vdo/kernel/kernelLayer.c

22 
	~"kî√lLayî.h
"

24 
	~<löux/¸c32.h
>

25 
	~<löux/moduÀ.h
>

27 
	~"loggî.h
"

28 
	~"mem‹yAŒoc.h
"

30 
	~"lz4.h
"

31 
	~"ªÀa£Vîsi⁄s.h
"

32 
	~"vﬁumeGeomëry.h
"

33 
	~"°©i°ics.h
"

34 
	~"vdo.h
"

36 
	~"bio.h
"

37 
	~"d©aKVIO.h
"

38 
	~"dedu≥Index.h
"

39 
	~"devi˚Regi°ry.h
"

40 
	~"ö°™˚Numbî.h
"

41 
	~"ioSubmôãrI¡î«ls.h
"

42 
	~"kvdoFlush.h
"

43 
	~"kvio.h
"

44 
	~"murmur/MurmurHash3.h
"

45 
	~"poﬁSysfs.h
"

46 
	~"ªadCache.h
"

47 
	~"°©usProcfs.h
"

48 
	~"°rögUtûs.h
"

49 
	~"vîify.h
"

52 
	mDEDUPE_TIMEOUT_REPORT_INTERVAL
 = 1000,

55 c⁄° 
KvdoW‹kQueueTy≥
 
	gbioAckQTy≥
 = {

56 .
a˘i⁄TabÀ
 = {

57 { .
«me
 = "bio_ack",

58 .
	gcode
 = 
BIO_ACK_Q_ACTION_ACK
,

59 .
	g¥i‹ôy
 = 0 },

63 c⁄° 
KvdoW‹kQueueTy≥
 
	g˝uQTy≥
 = {

64 .
a˘i⁄TabÀ
 = {

65 { .
«me
 = "cpu_compare_blocks",

66 .
	gcode
 = 
CPU_Q_ACTION_COMPARE_BLOCKS
,

67 .
	g¥i‹ôy
 = 0 },

68 { .
	g«me
 = "cpu_complete_kvio",

69 .
	gcode
 = 
CPU_Q_ACTION_COMPLETE_KVIO
,

70 .
	g¥i‹ôy
 = 0 },

71 { .
	g«me
 = "cpu_compress_block",

72 .
	gcode
 = 
CPU_Q_ACTION_COMPRESS_BLOCK
,

73 .
	g¥i‹ôy
 = 0 },

74 { .
	g«me
 = "cpu_dedupe_shutdown",

75 .
	gcode
 = 
CPU_Q_ACTION_DEDUPE_SHUTDOWN
,

76 .
	g¥i‹ôy
 = 1 },

77 { .
	g«me
 = "cpu_hash_block",

78 .
	gcode
 = 
CPU_Q_ACTION_HASH_BLOCK
,

79 .
	g¥i‹ôy
 = 0 },

80 { .
	g«me
 = "cpu_event_reporter",

81 .
	gcode
 = 
CPU_Q_ACTION_EVENT_REPORTER
,

82 .
	g¥i‹ôy
 = 0 },

83 { .
	g«me
 = "cpu_set_up_verify",

84 .
	gcode
 = 
CPU_Q_ACTION_SET_UP_VERIFY
,

85 .
	g¥i‹ôy
 = 0

92 
	gdeÁu…MaxReque°sA˘ive
 = 2000;

95 
CRC32Checksum
 
	$kvdoUpd©eCRC32
(
CRC32Checksum
 
¸c
,

96 c⁄° 
byã
 *
buf„r
,

97 
size_t
 
Àngth
)

103  
	`¸c32
(
¸c
 ^ 0xffffffff, 
buf„r
, 
Àngth
) ^ 0xffffffff;

104 
	}
}

107 
BlockCou¡
 
	$kvdoGëBlockCou¡
(
PhysiˇlLayî
 *
hódî
)

109  
	`asKî√lLayî
(
hódî
)->
blockCou¡
;

110 
	}
}

113 
BlockCou¡
 
	$kvdoGëD©aRegi⁄Off£t
(
PhysiˇlLayî
 *
hódî
)

115 
VﬁumeGeomëry
 *
geomëry
 = 
	`asKî√lLayî
(
hódî
)->geometry;

116 i‡(
geomëry
 =
NULL
) {

121  
geomëry
->
∑πôi⁄s
[
DATA_REGION
].
°¨tBlock
;

122 
	}
}

125 
	$m≠ToSy°emEº‹
(
îr‹
)

128 i‡(
	`likñy
(
îr‹
 <= 0)) {

129  
îr‹
;

131 i‡(
îr‹
 < 1024) {

133 
	`logInfo
("%s: mappingÉrrno value %d used withoutÇegation",

134 
__func__
, 
îr‹
);

135  -
îr‹
;

138 
îr‹Name
[80], 
îr‹Mesßge
[
ERRBUF_SIZE
];

139 
	`ßnsUƒecovîabÀ
(
îr‹
)) {

140 
VDO_NO_SPACE
:

141  -
ENOSPC
;

142 
VDO_READ_ONLY
:

143  -
EIO
;

145 
	`logInfo
("%s: mapping internal status code %d (%s: %s)Åo EIO",

146 
__func__
, 
îr‹
,

147 
	`°rögEº‹Name
(
îr‹
, 
îr‹Name
, (errorName)),

148 
	`°rögEº‹
(
îr‹
, 
îr‹Mesßge
, (errorMessage)));

149  -
EIO
;

151 
	}
}

154 
	$£tKî√lLayîSèã
(
Kî√lLayî
 *
œyî
, 
Kî√lLayîSèã
 
√wSèã
)

156 
	`ªœxedSt‹e32
(&
œyî
->
°©e
, 
√wSèã
);

157 
	}
}

160 
	$waôF‹NoReque°sA˘ive
(
Kî√lLayî
 *
œyî
)

165 
boﬁ
 
wasCom¥essög
 = 
	`£tKVDOCom¥essög
(&
œyî
->
kvdo
, 
Ál£
);

167 
	`limôîWaôF‹IdÀ
(&
œyî
->
ªque°Limôî
);

169 i‡(
wasCom¥essög
) {

170 
	`£tKVDOCom¥essög
(&
œyî
->
kvdo
, 
åue
);

172 
	}
}

195 
	$œunchD©aKVIOFromVDOThªad
(
Kî√lLayî
 *
œyî
,

196 
BIO
 *
bio
,

197 
Jiffõs
 
¨rivÆTime
)

199 
	`logW¨nög
("kvdoMapBio called from withiná VDOÅhread!");

224 i‡(!
	`limôîPﬁl
(&
œyî
->
ªque°Limôî
)) {

225 
	`addToDódlockQueue
(&
œyî
->
dódlockQueue
, 
bio
, 
¨rivÆTime
);

226 
	`logW¨nög
("queuedán I/OÑequestÅoávoid deadlock!");

228  
DM_MAPIO_SUBMITTED
;

231 
boﬁ
 
hasDisˇrdPîmô


232 (
	`isDisˇrdBio
(
bio
Ë&& 
	`limôîPﬁl
(&
œyî
->
disˇrdLimôî
));

233 
ªsu…
 = 
	`kvdoLaunchD©aKVIOFromBio
(
œyî
, 
bio
, 
¨rivÆTime
,

234 
hasDisˇrdPîmô
);

236 i‡(
ªsu…
 !
VDO_SUCCESS
) {

237  
ªsu…
;

240  
DM_MAPIO_SUBMITTED
;

241 
	}
}

244 
	$kvdoM≠Bio
(
Kî√lLayî
 *
œyî
, 
BIO
 *
bio
)

246 
Jiffõs
 
¨rivÆTime
 = 
jiffõs
;

247 
Kî√lLayîSèã
 
°©e
 = 
	`gëKî√lLayîSèã
(
œyî
);

248 
	`ASSERT_LOG_ONLY
(
°©e
 =
LAYER_RUNNING
,

249 "kvdoM≠BiÿshouldÇŸ bêˇŒed whûêö sèã %d", 
°©e
);

252 
	`cou¡Bios
(&
œyî
->
biosIn
, 
bio
);

255 i‡(
	`isEm±yFlush
(
bio
)) {

256 i‡(
	`shouldPro˚ssFlush
(
œyî
)) {

257 
	`œunchKVDOFlush
(
œyî
, 
bio
);

258  
DM_MAPIO_SUBMITTED
;

262 
	`cou¡Bios
(&
œyî
->
biosAcknowÀdged
, 
bio
);

263 
	`©omic64_öc
(&
œyî
->
ÊushOut
);

264 
	`£tBioBlockDevi˚
(
bio
, 
œyî
->
dev
->
bdev
);

265  
DM_MAPIO_REMAPPED
;

268 i‡(
	`isDisˇrdBio
(
bio
Ë&& 
	`isRódBio
(bio)) {

270  -
EIO
;

273 i‡(
	`gëCuºítW‹kQueue
(Ë!
NULL
) {

280  
	`œunchD©aKVIOFromVDOThªad
(
œyî
, 
bio
, 
¨rivÆTime
);

282 
boﬁ
 
hasDisˇrdPîmô
 = 
Ál£
;

283 i‡(
	`isDisˇrdBio
(
bio
)) {

284 
	`limôîWaôF‹O√Fªe
(&
œyî
->
disˇrdLimôî
);

285 
hasDisˇrdPîmô
 = 
åue
;

287 
	`limôîWaôF‹O√Fªe
(&
œyî
->
ªque°Limôî
);

289 
ªsu…
 = 
	`kvdoLaunchD©aKVIOFromBio
(
œyî
, 
bio
, 
¨rivÆTime
,

290 
hasDisˇrdPîmô
);

292 i‡(
ªsu…
 !
VDO_SUCCESS
) {

293  
ªsu…
;

296  
DM_MAPIO_SUBMITTED
;

297 
	}
}

300 
	$com∂ëeM™yReque°s
(
Kî√lLayî
 *
œyî
, 
uöt32_t
 
cou¡
)

303 
cou¡
 > 0) {

304 
Jiffõs
 
¨rivÆTime
 = 0;

305 
BIO
 *
bio
 = 
	`pﬁlDódlockQueue
(&
œyî
->
dódlockQueue
, &
¨rivÆTime
);

306 i‡(
	`likñy
(
bio
 =
NULL
)) {

310 
boﬁ
 
hasDisˇrdPîmô


311 (
	`isDisˇrdBio
(
bio
Ë&& 
	`limôîPﬁl
(&
œyî
->
disˇrdLimôî
));

312 
ªsu…
 = 
	`kvdoLaunchD©aKVIOFromBio
(
œyî
, 
bio
, 
¨rivÆTime
,

313 
hasDisˇrdPîmô
);

314 i‡(
ªsu…
 !
VDO_SUCCESS
) {

315 
	`com∂ëeBio
(
bio
, 
ªsu…
);

318 
cou¡
--;

321 i‡(
cou¡
 > 0) {

322 
	`limôîRñó£M™y
(&
œyî
->
ªque°Limôî
, 
cou¡
);

324 
	}
}

327 
	$ªp‹tEvíts
(
PîiodicEvítRï‹ãr
 *
ªp‹ãr
)

329 
	`©omic_£t
(&
ªp‹ãr
->
w‹kIãmQueued
, 0);

330 
uöt64_t
 
√wVÆue
 = 
	`©omic64_ªad
(&
ªp‹ãr
->
vÆue
);

331 
uöt64_t
 
dif„ªn˚
 = 
√wVÆue
 - 
ªp‹ãr
->
œ°Rï‹ãdVÆue
;

332 i‡(
dif„ªn˚
 != 0) {

333 
	`logDebug
(
ªp‹ãr
->
f‹m©
, 
dif„ªn˚
);

334 
ªp‹ãr
->
œ°Rï‹ãdVÆue
 = 
√wVÆue
;

336 
	}
}

339 
	$ªp‹tEvítsW‹k
(
KvdoW‹kIãm
 *
ôem
)

341 
PîiodicEvítRï‹ãr
 *
ªp‹ãr
 = 
	`c⁄èöî_of
(
ôem
, PeriodicEventReporter,

342 
w‹kIãm
);

343 
	`ªp‹tEvíts
(
ªp‹ãr
);

344 
	}
}

347 
	$öôPîiodicEvítRï‹ãr
(
PîiodicEvítRï‹ãr
 *
ªp‹ãr
,

348 c⁄° *
f‹m©
,

349 
ªp‹tögI¡îvÆ
,

350 
Kî√lLayî
 *
œyî
)

352 
	`£tupW‹kIãm
(&
ªp‹ãr
->
w‹kIãm
, 
ªp‹tEvítsW‹k
, 
NULL
,

353 
CPU_Q_ACTION_EVENT_REPORTER
);

354 
ªp‹ãr
->
f‹m©
 = format;

355 
ªp‹ãr
->
ªp‹tögI¡îvÆ
 = 
	`m£cs_to_jiffõs
(reportingInterval);

356 
ªp‹ãr
->
œyî
 =Üayer;

357 
	}
}

360 
	$addEvítCou¡
(
PîiodicEvítRï‹ãr
 *
ªp‹ãr
, 
cou¡
)

362 i‡(
cou¡
 > 0) {

363 
	`©omic64_add
(
cou¡
, &
ªp‹ãr
->
vÆue
);

364 
ﬁdW‹kIãmQueued
 = 
	`©omic_xchg
(&
ªp‹ãr
->
w‹kIãmQueued
, 1);

365 i‡(
ﬁdW‹kIãmQueued
 == 0) {

366 
	`íqueueW‹kQueueDñayed
(
ªp‹ãr
->
œyî
->
˝uQueue
,

367 &
ªp‹ãr
->
w‹kIãm
,

368 
jiffõs
 + 
ªp‹ãr
->
ªp‹tögI¡îvÆ
);

371 
	}
}

374 
	$°›PîiodicEvítRï‹ãr
(
PîiodicEvítRï‹ãr
 *
ªp‹ãr
)

376 
	`ªp‹tEvíts
(
ªp‹ãr
);

377 
	}
}

380 
	$kvdoRï‹tDedu≥Timeout
(
Kî√lLayî
 *
œyî
, 
expúedCou¡
)

382 
	`addEvítCou¡
(&
œyî
->
ÆbúeoTimeoutRï‹ãr
, 
expúedCou¡
);

383 
	}
}

386 
	$kvdoCª©eEnqueuóbÀ
(
VDOCom∂ëi⁄
 *
com∂ëi⁄
)

388 
KvdoEnqueuóbÀ
 *
kvdoEnqueuóbÀ
;

389 
ªsu…
 = 
	`ALLOCATE
(1, 
KvdoEnqueuóbÀ
, "kvdoEnqueueable",

390 &
kvdoEnqueuóbÀ
);

391 i‡(
ªsu…
 !
VDO_SUCCESS
) {

392 
	`logEº‹
("kvdoEnqueuóbÀáŒoˇti⁄ faûuª %d", 
ªsu…
);

393  
ªsu…
;

395 
kvdoEnqueuóbÀ
->
íqueuóbÀ
.
com∂ëi⁄
 = completion;

396 
com∂ëi⁄
->
íqueuóbÀ
 = &
kvdoEnqueuóbÀ
->enqueueable;

397  
VDO_SUCCESS
;

398 
	}
}

401 
	$kvdoDe°royEnqueuóbÀ
(
EnqueuóbÀ
 **
íqueuóbÀPå
)

403 
KvdoEnqueuóbÀ
 *
kvdoEnqueuóbÀ
 = 
	`c⁄èöî_of
(*
íqueuóbÀPå
,

404 
KvdoEnqueuóbÀ
,

405 
íqueuóbÀ
);

406 
	`FREE
(
kvdoEnqueuóbÀ
);

407 *
íqueuóbÀPå
 = 
NULL
;

408 
	}
}

413 
kvdoAŒoˇãIOBuf„r
(
PhysiˇlLayî
 *
œyî
 
__©åibuã__
((
unu£d
)),

414 
size_t
 
byãs
,

415 c⁄° *
why
,

416 **
buf„rPå
)

418  
ALLOCATE
(
byãs
, , 
why
, 
buf„rPå
);

421 #i‡
LINUX_VERSION_CODE
 >
KERNEL_VERSION
(4,4,0)

427 
	$ídSyncRód
(
BIO
 *
bio
)

435 
	$ídSyncRód
(
BIO
 *
bio
, 
ªsu…
)

438 #i‡
LINUX_VERSION_CODE
 >
	`KERNEL_VERSION
(4,13,0)

439 
ªsu…
 = 
bio
->
bi_°©us
;

440 #ñi‡
LINUX_VERSION_CODE
 >
	`KERNEL_VERSION
(4,4,0)

441 
ªsu…
 = 
bio
->
bi_îr‹
;

444 i‡(
ªsu…
 != 0) {

445 
	`logEº‹WôhSåögEº‹
(
ªsu…
, "synchronousÑead failed");

446 #i‡
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(4,4,0)

447 
	`˛ór_bô
(
BIO_UPTODATE
, &
bio
->
bi_Êags
);

451 
com∂ëi⁄
 *com∂ëi⁄ = (com∂ëi⁄ *Ë
bio
->
bi_¥iv©e
;

452 
	`com∂ëe
(
com∂ëi⁄
);

453 
	}
}

459 
	$kvdoSynchr⁄ousRód
(
PhysiˇlLayî
 *
œyî
,

460 
PhysiˇlBlockNumbî
 
°¨tBlock
,

461 
size_t
 
blockCou¡
,

462 *
buf„r
,

463 
size_t
 *
blocksRód
)

465 i‡(
blockCou¡
 != 1) {

466  
VDO_NOT_IMPLEMENTED
;

469 
Kî√lLayî
 *
kî√lLayî
 = 
	`asKî√lLayî
(
œyî
);

471 
com∂ëi⁄
 
bioWaô
;

472 
	`öô_com∂ëi⁄
(&
bioWaô
);

473 
BIO
 *
bio
;

474 
ªsu…
 = 
	`¸óãBio
(
kî√lLayî
, 
buf„r
, &
bio
);

475 i‡(
ªsu…
 !
VDO_SUCCESS
) {

476  
ªsu…
;

478 #i‡
LINUX_VERSION_CODE
 >
	`KERNEL_VERSION
(4,8,0)

479 
bio
->
bi_›f
 = 
READ
;

481 
bio
->
bi_rw
 = 
READ
;

483 
bio
->
bi_íd_io
 = 
ídSyncRód
;

484 
bio
->
bi_¥iv©e
 = &
bioWaô
;

485 
	`£tBioBlockDevi˚
(
bio
, 
kî√lLayî
->
dev
->
bdev
);

486 
	`£tBioSe˘‹
(
bio
, 
	`blockToSe˘‹
(
kî√lLayî
, 
°¨tBlock
));

487 
	`gíîic_make_ªque°
(
bio
);

488 
	`waô_f‹_com∂ëi⁄
(&
bioWaô
);

489 #i‡
LINUX_VERSION_CODE
 >
	`KERNEL_VERSION
(4,13,0)

490 i‡(
bio
->
bi_°©us
 != 0) {

491 #ñi‡
LINUX_VERSION_CODE
 >
	`KERNEL_VERSION
(4,4,0)

492 i‡(
bio
->
bi_îr‹
 != 0) {

494 i‡(!
	`bio_Êagged
(
bio
, 
BIO_UPTODATE
)) {

496 
ªsu…
 = -
EIO
;

499 
	`‰ìBio
(
bio
, 
kî√lLayî
);

501 i‡(
ªsu…
 !
VDO_SUCCESS
) {

502  
ªsu…
;

504 i‡(
blocksRód
 !
NULL
) {

505 *
blocksRód
 = 
blockCou¡
;

507  
VDO_SUCCESS
;

508 
	}
}

513 
	$kvdoFªeVIO
(
VIO
 **
vioPå
)

515 
VIO
 *
vio
 = *
vioPå
;

516 i‡(
vio
 =
NULL
) {

520 
	`BUG_ON
(
	`isD©aVIO
(
vio
));

522 i‡(
	`isCom¥es£dWrôeVIO
(
vio
)) {

523 
Com¥es£dWrôeKVIO
 *
com¥es£dWrôeKVIO


524 
	`ÆloˇtögVIOAsCom¥es£dWrôeKVIO
(
	`vioAsAŒoˇtögVIO
(
vio
));

525 
	`‰ìCom¥es£dWrôeKVIO
(&
com¥es£dWrôeKVIO
);

527 
Mëad©aKVIO
 *
mëad©aKVIO
 = 
	`vioAsMëad©aKVIO
(
vio
);

528 
	`‰ìMëad©aKVIO
(&
mëad©aKVIO
);

531 *
vioPå
 = 
NULL
;

532 
	}
}

535 
boﬁ
 
	$isFlushRequúed
(
PhysiˇlLayî
 *
comm⁄
)

537  
	`shouldPro˚ssFlush
(
	`asKî√lLayî
(
comm⁄
));

538 
	}
}

548 
	$kvdoCom∂ëeSyncO≥øti⁄
(
PhysiˇlLayî
 *
comm⁄
)

550 
Kî√lLayî
 *
œyî
 = 
	`asKî√lLayî
(
comm⁄
);

551 
	`com∂ëe
(&
œyî
->
ˇŒbackSync
);

552 
	}
}

561 
	$waôF‹SyncO≥øti⁄
(
PhysiˇlLayî
 *
comm⁄
)

563 
Kî√lLayî
 *
œyî
 = 
	`asKî√lLayî
(
comm⁄
);

566 
	`waô_f‹_com∂ëi⁄_öãºu±ibÀ
(&
œyî
->
ˇŒbackSync
) != 0) {

568 
	}
}

571 
	$makeKî√lLayî
(
BlockCou¡
 
blockCou¡
,

572 
uöt64_t
 
°¨tögSe˘‹
,

573 
dm_dev
 *
dev
,

574 
ö°™˚
,

575 
Devi˚C⁄fig
 *
c⁄fig
,

576 
kobje˘
 *
∑ª¡Kobje˘
,

577 
ThªadC⁄fig
 **
thªadC⁄figPoöãr
,

578 **
ªas⁄
,

579 
Kî√lLayî
 **
œyîPå
)

582 *
ªas⁄
 = "UnspecifiedÉrror";

590 
Kî√lLayî
 *
œyî
;

591 
ªsu…
 = 
	`ALLOCATE
(1, 
Kî√lLayî
, "VDO c⁄figuøti⁄", &
œyî
);

592 i‡(
ªsu…
 !
UDS_SUCCESS
) {

593 *
ªas⁄
 = "Cannotállocate VDO configuration";

594 
	`‰ìDevi˚C⁄fig
(&
c⁄fig
);

595  
ªsu…
;

600 
œyî
->
comm⁄
.
ÆloˇãIOBuf„r
 = 
kvdoAŒoˇãIOBuf„r
;

601 
œyî
->
comm⁄
.
¸óãEnqueuóbÀ
 = 
kvdoCª©eEnqueuóbÀ
;

602 
œyî
->
comm⁄
.
de°royEnqueuóbÀ
 = 
kvdoDe°royEnqueuóbÀ
;

604 
ªsu…
 = 
	`ÆloˇãVDO
(&
œyî
->
comm⁄
, &œyî->
kvdo
.
vdo
);

605 i‡(
ªsu…
 !
VDO_SUCCESS
) {

606 *
ªas⁄
 = "Cannotállocate VDO";

607 
	`‰ìDevi˚C⁄fig
(&
c⁄fig
);

608 
	`FREE
(
œyî
);

609  
ªsu…
;

615 
	`kobje˘_öô
(&
œyî
->
kobj
, &
kî√lLayîKobjTy≥
);

616 
ªsu…
 = 
	`kobje˘_add
(&
œyî
->
kobj
, 
∑ª¡Kobje˘
, 
c⁄fig
->
poﬁName
);

617 i‡(
ªsu…
 != 0) {

618 *
ªas⁄
 = "Cannotádd sysfsÇode";

619 
	`‰ìDevi˚C⁄fig
(&
c⁄fig
);

620 
	`kobje˘_put
(&
œyî
->
kobj
);

621  
ªsu…
;

623 
	`kobje˘_öô
(&
œyî
->
wqDúe˘‹y
, &
w‹kQueueDúe˘‹yKobjTy≥
);

624 
ªsu…
 = 
	`kobje˘_add
(&
œyî
->
wqDúe˘‹y
, &œyî->
kobj
, "work_queues");

625 i‡(
ªsu…
 != 0) {

626 *
ªas⁄
 = "Cannotádd sysfsÇode";

627 
	`‰ìDevi˚C⁄fig
(&
c⁄fig
);

628 
	`kobje˘_put
(&
œyî
->
wqDúe˘‹y
);

629 
	`kobje˘_put
(&
œyî
->
kobj
);

630  
ªsu…
;

633 
	`•ö_lock_öô
(&
œyî
->
°©sLock
);

634 
ªsu…
 = 
	`ALLOCATE
(1, 
VDOSèti°ics
, "VDOStatistics storage",

635 &
œyî
->
vdoSètsSt‹age
);

636 i‡(
ªsu…
 != 0) {

637 *
ªas⁄
 = "Cannotállocate VDO statistics storage";

638 
	`‰ìDevi˚C⁄fig
(&
c⁄fig
);

639 
	`kobje˘_put
(&
œyî
->
wqDúe˘‹y
);

640 
	`kobje˘_put
(&
œyî
->
kobj
);

641  
ªsu…
;

643 
ªsu…
 = 
	`ALLOCATE
(1, 
Kî√lSèti°ics
, "KernelStatistics storage",

644 &
œyî
->
kî√lSètsSt‹age
);

645 i‡(
ªsu…
 != 0) {

646 *
ªas⁄
 = "Cannotállocate kernel statistics storage";

647 
	`‰ìDevi˚C⁄fig
(&
c⁄fig
);

648 
	`kobje˘_put
(&
œyî
->
wqDúe˘‹y
);

649 
	`kobje˘_put
(&
œyî
->
kobj
);

650  
ªsu…
;

652 
	`kobje˘_öô
(&
œyî
->
°©sDúe˘‹y
, &
°©sDúe˘‹yKobjTy≥
);

653 
ªsu…
 = 
	`kobje˘_add
(&
œyî
->
°©sDúe˘‹y
, &œyî->
kobj
, "statistics");

654 i‡(
ªsu…
 != 0) {

655 *
ªas⁄
 = "Cannotádd sysfs statisticsÇode";

656 
	`‰ìDevi˚C⁄fig
(&
c⁄fig
);

657 
	`kobje˘_put
(&
œyî
->
°©sDúe˘‹y
);

658 
	`kobje˘_put
(&
œyî
->
wqDúe˘‹y
);

659 
	`kobje˘_put
(&
œyî
->
kobj
);

660  
ªsu…
;

673 
	`£tKî√lLayîSèã
(
œyî
, 
LAYER_SIMPLE_THINGS_INITIALIZED
);

675 
	`öôülizeDódlockQueue
(&
œyî
->
dódlockQueue
);

677 
ªque°Limô
 = 
deÁu…MaxReque°sA˘ive
;

678 
	`öôülizeLimôî
(&
œyî
->
ªque°Limôî
, 
ªque°Limô
);

679 
	`öôülizeLimôî
(&
œyî
->
disˇrdLimôî
, 
ªque°Limô
 * 3 / 4);

680 
œyî
->
ªadCacheBlocks


681 (
c⁄fig
->
ªadCacheE«bÀd


682 ? (
ªque°Limô
 + 
c⁄fig
->
ªadCacheExåaBlocks
) : 0);

684 
œyî
->
Æloˇti⁄sAŒowed
 = 
åue
;

685 
œyî
->
dev
 = dev;

686 
œyî
->
blockCou¡
 = blockCount;

687 
œyî
->
ö°™˚
 = instance;

688 
œyî
->
logiˇlBlockSize
 = 
c⁄fig
->logicalBlockSize;

689 
œyî
->
mdRaid5ModeE«bÀd
 = 
c⁄fig
->mdRaid5ModeEnabled;

690 
œyî
->
devi˚C⁄fig
 = 
c⁄fig
;

691 
œyî
->
°¨tögSe˘‹Off£t
 = 
°¨tögSe˘‹
;

693 
œyî
->
comm⁄
.
upd©eCRC32
 = 
kvdoUpd©eCRC32
;

694 
œyî
->
comm⁄
.
gëBlockCou¡
 = 
kvdoGëBlockCou¡
;

695 
œyî
->
comm⁄
.
gëD©aRegi⁄Off£t
 = 
kvdoGëD©aRegi⁄Off£t
;

696 
œyî
->
comm⁄
.
isFlushRequúed
 = isFlushRequired;

697 
œyî
->
comm⁄
.
¸óãMëad©aVIO
 = 
kvdoCª©eMëad©aVIO
;

698 
œyî
->
comm⁄
.
¸óãCom¥es£dWrôeVIO
 = 
kvdoCª©eCom¥es£dWrôeVIO
;

699 
œyî
->
comm⁄
.
‰ìVIO
 = 
kvdoFªeVIO
;

700 
œyî
->
comm⁄
.
com∂ëeFlush
 = 
kvdoCom∂ëeFlush
;

701 
œyî
->
comm⁄
.
íqueue
 = 
kvdoEnqueue
;

702 
œyî
->
comm⁄
.
waôF‹AdmöO≥øti⁄
 = 
waôF‹SyncO≥øti⁄
;

703 
œyî
->
comm⁄
.
com∂ëeAdmöO≥øti⁄
 = 
kvdoCom∂ëeSyncO≥øti⁄
;

704 
œyî
->
comm⁄
.
gëCuºítThªadID
 = 
kvdoGëCuºítThªadID
;

705 
œyî
->
comm⁄
.
zîoD©aVIO
 = 
kvdoZîoD©aVIO
;

706 
œyî
->
comm⁄
.
com∑ªD©aVIOs
 = 
kvdoCom∑ªD©aVIOs
;

707 
œyî
->
comm⁄
.
c›yD©a
 = 
kvdoC›yD©aVIO
;

708 
œyî
->
comm⁄
.
ªadD©a
 = 
kvdoRódD©aVIO
;

709 
œyî
->
comm⁄
.
wrôeD©a
 = 
kvdoWrôeD©aVIO
;

710 
œyî
->
comm⁄
.
wrôeCom¥es£dBlock
 = 
kvdoWrôeCom¥es£dBlock
;

711 
œyî
->
comm⁄
.
ªadMëad©a
 = 
kvdoSubmôMëad©aVIO
;

712 
œyî
->
comm⁄
.
wrôeMëad©a
 = 
kvdoSubmôMëad©aVIO
;

713 
œyî
->
comm⁄
.
≠∂yP¨tülWrôe
 = 
kvdoModifyWrôeD©aVIO
;

714 
œyî
->
comm⁄
.
Êush
 = 
kvdoFlushVIO
;

715 
œyî
->
comm⁄
.
hashD©a
 = 
kvdoHashD©aVIO
;

716 
œyî
->
comm⁄
.
checkF‹Du∂iˇti⁄
 = 
kvdoCheckF‹Du∂iˇti⁄
;

717 
œyî
->
comm⁄
.
vîifyDu∂iˇti⁄
 = 
kvdoVîifyDu∂iˇti⁄
;

718 
œyî
->
comm⁄
.
acknowÀdgeD©aVIO
 = 
kvdoAcknowÀdgeD©aVIO
;

719 
œyî
->
comm⁄
.
com¥essD©aVIO
 = 
kvdoCom¥essD©aVIO
;

720 
œyî
->
comm⁄
.
upd©eAlbúeo
 = 
kvdoUpd©eDedu≥Advi˚
;

722 
	`•ö_lock_öô
(&
œyî
->
ÊushLock
);

723 
	`bio_li°_öô
(&
œyî
->
waôögFlushes
);

725 
ªsu…
 = 
	`addLayîToDevi˚Regi°ry
(
c⁄fig
->
poﬁName
, 
œyî
);

726 i‡(
ªsu…
 !
VDO_SUCCESS
) {

727 *
ªas⁄
 = "CannotáddÜayerÅo deviceÑegistry";

728 
	`‰ìKî√lLayî
(
œyî
);

729  
ªsu…
;

732 
	`¢¥ötf
(
œyî
->
thªadNamePªfix
, (layer->threadNamePrefix), "%s%u",

733 
THIS_MODULE
->
«me
, 
ö°™˚
);

735 
ªsu…
 = 
	`makeThªadC⁄fig
(
c⁄fig
->
thªadCou¡s
.
logiˇlZ⁄es
,

736 
c⁄fig
->
thªadCou¡s
.
physiˇlZ⁄es
,

737 
c⁄fig
->
thªadCou¡s
.
hashZ⁄es
,

738 
thªadC⁄figPoöãr
);

739 i‡(
ªsu…
 !
VDO_SUCCESS
) {

740 *
ªas⁄
 = "Cannot createÅhread configuration";

741 
	`‰ìKî√lLayî
(
œyî
);

742  
ªsu…
;

745 
c⁄fig
->
thªadCou¡s
.
ba£Thªads
 = (*
thªadC⁄figPoöãr
)->
ba£ThªadCou¡
;

747 
	`logInfo
("zones: %dÜogical, %dÖhysical, %d hash; baseÅhreads: %d",

748 
c⁄fig
->
thªadCou¡s
.
logiˇlZ⁄es
,

749 
c⁄fig
->
thªadCou¡s
.
physiˇlZ⁄es
,

750 
c⁄fig
->
thªadCou¡s
.
hashZ⁄es
,

751 
c⁄fig
->
thªadCou¡s
.
ba£Thªads
);

753 
ªsu…
 = 
	`makeB©chPro˚ss‹
(
œyî
, 
ªtu∫D©aKVIOB©chToPoﬁ
,Üayer,

754 &
œyî
->
d©aKVIORñó£r
);

755 i‡(
ªsu…
 !
UDS_SUCCESS
) {

756 *
ªas⁄
 = "Cannotállocate KVIO-freeing batchÖrocessor";

757 
	`‰ìKî√lLayî
(
œyî
);

758  
ªsu…
;

762 
ªsu…
 = 
	`makeKVDOFlush
(&
œyî
->
•¨eKVDOFlush
);

763 i‡(
ªsu…
 !
UDS_SUCCESS
) {

764 *
ªas⁄
 = "Cannotállocate KVDOFlushÑecord";

765 
	`‰ìKî√lLayî
(
œyî
);

766  
ªsu…
;

770 #i‡
LINUX_VERSION_CODE
 >
	`KERNEL_VERSION
(4,13,0)

771 
œyî
->
bio£t
 = 
	`bio£t_¸óã
(0, 0, 0);

773 
œyî
->
bio£t
 = 
	`bio£t_¸óã
(0, 0);

775 i‡(
œyî
->
bio£t
 =
NULL
) {

776 *
ªas⁄
 = "Cannotállocate dedupe bioset";

777 
	`‰ìKî√lLayî
(
œyî
);

778  -
ENOMEM
;

783 
œyî
->
comm⁄
.
ªadî
 = 
kvdoSynchr⁄ousRód
;

784 
ªsu…
 = 
	`lﬂdVﬁumeGeomëry
(&
œyî
->
comm⁄
, &œyî->
geomëry
);

785 
œyî
->
comm⁄
.
ªadî
 = 
NULL
;

786 i‡(
ªsu…
 !
VDO_SUCCESS
) {

787 i‡(
ªsu…
 =
VDO_INCORRECT_COMPONENT
) {

790 
	`logInfo
("CouldÇotÖarse geometry block; continuingássuming it'sán"

793 *
ªas⁄
 = "CouldÇotÜoad geometry block";

794 
	`‰ìKî√lLayî
(
œyî
);

795  
ªsu…
;

800 
	`öôPîiodicEvítRï‹ãr
(&
œyî
->
ÆbúeoTimeoutRï‹ãr
,

801 "Albúeÿtimeouà⁄ %" 
PRIu64
 "Ñequests",

802 
DEDUPE_TIMEOUT_REPORT_INTERVAL
, 
œyî
);

805 
	`BUG_ON
(
œyî
->
thªadNamePªfix
[0] == '\0');

806 
ªsu…
 = 
	`makeDedu≥Index
(&
œyî
->
dedu≥Index
,Üayer);

807 i‡(
ªsu…
 !
UDS_SUCCESS
) {

808 *
ªas⁄
 = "Cannot initialize dedupe index";

809 
	`‰ìKî√lLayî
(
œyî
);

810  
ªsu…
;

814 
ªsu…
 = 
	`ALLOCATE
(
c⁄fig
->
thªadCou¡s
.
˝uThªads
, *, "LZ4 context",

815 &
œyî
->
com¥essi⁄C⁄ãxt
);

816 i‡(
ªsu…
 !
VDO_SUCCESS
) {

817 *
ªas⁄
 = "cannotállocate LZ4 context";

818 
	`‰ìKî√lLayî
(
œyî
);

819  
ªsu…
;

821 
i
 = 0; i < 
c⁄fig
->
thªadCou¡s
.
˝uThªads
; i++) {

822 
ªsu…
 = 
	`ALLOCATE
(
	`LZ4_c⁄ãxt_size
(), , "LZ4 context",

823 &
œyî
->
com¥essi⁄C⁄ãxt
[
i
]);

824 i‡(
ªsu…
 !
VDO_SUCCESS
) {

825 *
ªas⁄
 = "cannotállocate LZ4 context";

826 
	`‰ìKî√lLayî
(
œyî
);

827  
ªsu…
;

837 
	`£tKî√lLayîSèã
(
œyî
, 
LAYER_BUFFER_POOLS_INITIALIZED
);

840 
	`BUG_ON
(
œyî
->
ªque°Limôî
.
limô
 <= 0);

841 
ªsu…
 = 
	`åa˚Kî√lLayîInô
(
œyî
);

842 i‡(
ªsu…
 !
VDO_SUCCESS
) {

843 *
ªas⁄
 = "Cannot initializeÅrace data";

844 
	`‰ìKî√lLayî
(
œyî
);

845  
ªsu…
;

849 
	`BUG_ON
(
œyî
->
logiˇlBlockSize
 <= 0);

850 
	`BUG_ON
(
œyî
->
ªque°Limôî
.
limô
 <= 0);

851 
	`BUG_ON
(
œyî
->
bio£t
 =
NULL
);

852 
	`BUG_ON
(
œyî
->
dev
 =
NULL
);

853 
ªsu…
 = 
	`makeD©aKVIOBuf„rPoﬁ
(
œyî
,Üayî->
ªque°Limôî
.
limô
,

854 &
œyî
->
d©aKVIOPoﬁ
);

855 i‡(
ªsu…
 !
VDO_SUCCESS
) {

856 *
ªas⁄
 = "Cannotállocate vio data";

857 
	`‰ìKî√lLayî
(
œyî
);

858  
ªsu…
;

868 
ªsu…
 = 
	`öôülizeKVDO
(&
œyî
->
kvdo
, *
thªadC⁄figPoöãr
, 
ªas⁄
);

869 i‡(
ªsu…
 < 0) {

870 
	`‰ìKî√lLayî
(
œyî
);

871  
ªsu…
;

874 
	`£tKî√lLayîSèã
(
œyî
, 
LAYER_REQUEST_QUEUE_INITIALIZED
);

877 
ªsu…
 = 
	`makeIOSubmôãr
(
œyî
->
thªadNamePªfix
,

878 
c⁄fig
->
thªadCou¡s
.
bioThªads
,

879 
c⁄fig
->
thªadCou¡s
.
bioRŸ©i⁄I¡îvÆ
,

880 
œyî
->
ªque°Limôî
.
limô
,

881 
œyî
,

882 &
œyî
->
ioSubmôãr
);

883 i‡(
ªsu…
 !
VDO_SUCCESS
) {

886 
	`‰ìKî√lLayî
(
œyî
);

887 *
ªas⁄
 = "bio submission initialization failed";

888  
ªsu…
;

890 
	`£tKî√lLayîSèã
(
œyî
, 
LAYER_BIO_DATA_INITIALIZED
);

893 i‡(
	`u£BioAckQueue
(
œyî
)) {

894 
ªsu…
 = 
	`makeW‹kQueue
(
œyî
->
thªadNamePªfix
, "ackQ",

895 &
œyî
->
wqDúe˘‹y
,Üayî, &
bioAckQTy≥
,

896 
c⁄fig
->
thªadCou¡s
.
bioAckThªads
,

897 &
œyî
->
bioAckQueue
);

898 i‡(
ªsu…
 !
VDO_SUCCESS
) {

899 *
ªas⁄
 = "bioáck queue initialization failed";

900 
	`‰ìKî√lLayî
(
œyî
);

901  
ªsu…
;

905 
	`£tKî√lLayîSèã
(
œyî
, 
LAYER_BIO_ACK_QUEUE_INITIALIZED
);

908 
ªsu…
 = 
	`makeW‹kQueue
(
œyî
->
thªadNamePªfix
, "˝uQ", &œyî->
wqDúe˘‹y
,

909 
NULL
, &
˝uQTy≥
, 
c⁄fig
->
thªadCou¡s
.
˝uThªads
,

910 &
œyî
->
˝uQueue
);

911 i‡(
ªsu…
 !
VDO_SUCCESS
) {

912 *
ªas⁄
 = "Albireo CPU queue initialization failed";

913 
	`‰ìKî√lLayî
(
œyî
);

914  
ªsu…
;

917 
	`£tKî√lLayîSèã
(
œyî
, 
LAYER_CPU_QUEUE_INITIALIZED
);

919 *
œyîPå
 = 
œyî
;

920  
VDO_SUCCESS
;

921 
	}
}

924 
	$modifyKî√lLayî
(
Kî√lLayî
 *
œyî
,

925 
dm_èrgë
 *
ti
,

926 
Devi˚C⁄fig
 *
c⁄fig
,

927 **
why
)

929 i‡(
ti
->
begö
 !
œyî
->ti->begin) {

930 *
why
 = "Starting sector cannot change";

931  
VDO_PARAMETER_MISMATCH
;

934 
Devi˚C⁄fig
 *
exè¡C⁄fig
 = 
œyî
->
devi˚C⁄fig
;

936 i‡(
	`°rcmp
(
c⁄fig
->
∑ª¡Devi˚Name
, 
exè¡C⁄fig
->parentDeviceName) != 0) {

937 *
why
 = "Underlying device cannot change";

938  
VDO_PARAMETER_MISMATCH
;

941 i‡(
c⁄fig
->
logiˇlBlockSize
 !
exè¡C⁄fig
->logicalBlockSize) {

942 *
why
 = "Logical block size cannot change";

943  
VDO_PARAMETER_MISMATCH
;

946 i‡(
c⁄fig
->
ˇcheSize
 !
exè¡C⁄fig
->cacheSize) {

947 *
why
 = "Block map cache size cannot change";

948  
VDO_PARAMETER_MISMATCH
;

951 i‡(
c⁄fig
->
blockM≠MaximumAge
 !
exè¡C⁄fig
->blockMapMaximumAge) {

952 *
why
 = "Block map maximumáge cannot change";

953  
VDO_PARAMETER_MISMATCH
;

956 i‡(
c⁄fig
->
mdRaid5ModeE«bÀd
 !
exè¡C⁄fig
->mdRaid5ModeEnabled) {

957 *
why
 = "mdRaid5Mode cannot change";

958  
VDO_PARAMETER_MISMATCH
;

961 i‡(
c⁄fig
->
ªadCacheE«bÀd
 !
exè¡C⁄fig
->readCacheEnabled) {

962 *
why
 = "Read cacheÉnabled cannot change";

963  
VDO_PARAMETER_MISMATCH
;

966 i‡(
c⁄fig
->
ªadCacheExåaBlocks
 !
exè¡C⁄fig
->readCacheExtraBlocks) {

967 *
why
 = "Read cache size cannot change";

968  
VDO_PARAMETER_MISMATCH
;

971 i‡(
	`°rcmp
(
c⁄fig
->
thªadC⁄figSåög
, 
exè¡C⁄fig
->threadConfigString)

973 *
why
 = "Thread configuration cannot change";

974  
VDO_PARAMETER_MISMATCH
;

979 i‡(
c⁄fig
->
wrôePﬁicy
 !
œyî
->
devi˚C⁄fig
->writePolicy) {

988 i‡(
	`gëKî√lLayîSèã
(
œyî
Ë!
LAYER_SUSPENDED
) {

989 *
why
 = "Device must be suspended before changing writeÖolicy";

990  
VDO_COMPONENT_BUSY
;

993 
	`£tWrôePﬁicy
(
œyî
->
kvdo
.
vdo
, 
c⁄fig
->
wrôePﬁicy
);

994  
VDO_SUCCESS
;

997 i‡(
ti
->
Àn
 !
œyî
->ti->len) {

998 i‡(
	`gëKî√lLayîSèã
(
œyî
Ë!
LAYER_SUSPENDED
) {

999 *
why
 = "Device must be suspended before changingÜogical size";

1000  
VDO_COMPONENT_BUSY
;

1003 
size_t
 
logiˇlByãs
 = 
	`to_byãs
(
ti
->
Àn
);

1004 i‡((
logiˇlByãs
 % 
VDO_BLOCK_SIZE
) != 0) {

1005 *
why
 = "Logical size must beá multiple of 4096";

1006  
VDO_PARAMETER_MISMATCH
;

1009 
ªsu…
 = 
	`ªsizeLogiˇl
(
œyî
, 
logiˇlByãs
 / 
VDO_BLOCK_SIZE
);

1010 i‡(
ªsu…
 !
VDO_SUCCESS
) {

1011 *
why
 = "Device growLogical failed";

1012  
ªsu…
;

1016  
VDO_SUCCESS
;

1017 
	}
}

1020 
	$‰ìKî√lLayî
(
Kî√lLayî
 *
œyî
)

1026 
boﬁ
 
u£dBioAckQueue
 = 
Ál£
;

1027 
boﬁ
 
u£dCpuQueue
 = 
Ál£
;

1028 
boﬁ
 
u£dKVDO
 = 
Ál£
;

1029 
boﬁ
 
ªÀa£In°™˚
 = 
Ál£
;

1031 
Kî√lLayîSèã
 
°©e
 = 
	`gëKî√lLayîSèã
(
œyî
);

1032 
°©e
) {

1033 
LAYER_STOPPING
:

1034 
	`logEº‹
("re-entered freeKernelLayer while stopping");

1037 
LAYER_SUSPENDING
:

1038 
LAYER_RESUMING
:

1039 
	`logW¨nög
("shutting down while still supending orÑesuming");

1042 
LAYER_RUNNING
:

1043 
LAYER_SUSPENDED
:

1044 
	`°›Kî√lLayî
(
œyî
);

1047 
LAYER_STOPPED
:

1048 
LAYER_CPU_QUEUE_INITIALIZED
:

1049 
	`föishW‹kQueue
(
œyî
->
˝uQueue
);

1050 
u£dCpuQueue
 = 
åue
;

1051 
ªÀa£In°™˚
 = 
åue
;

1054 
LAYER_BIO_ACK_QUEUE_INITIALIZED
:

1055 i‡(
	`u£BioAckQueue
(
œyî
)) {

1056 
	`föishW‹kQueue
(
œyî
->
bioAckQueue
);

1057 
u£dBioAckQueue
 = 
åue
;

1061 
LAYER_BIO_DATA_INITIALIZED
:

1062 
	`˛ónupIOSubmôãr
(
œyî
->
ioSubmôãr
);

1065 
LAYER_REQUEST_QUEUE_INITIALIZED
:

1066 
	`föishKVDO
(&
œyî
->
kvdo
);

1067 
u£dKVDO
 = 
åue
;

1070 
LAYER_BUFFER_POOLS_INITIALIZED
:

1071 
	`‰ìBuf„rPoﬁ
(&
œyî
->
d©aKVIOPoﬁ
);

1072 
	`‰ìBuf„rPoﬁ
(&
œyî
->
åa˚Buf„rPoﬁ
);

1075 
LAYER_SIMPLE_THINGS_INITIALIZED
:

1076 i‡(
œyî
->
com¥essi⁄C⁄ãxt
 !
NULL
) {

1077 
i
 = 0; i < 
œyî
->
devi˚C⁄fig
->
thªadCou¡s
.
˝uThªads
; i++) {

1078 
	`FREE
(
œyî
->
com¥essi⁄C⁄ãxt
[
i
]);

1080 
	`FREE
(
œyî
->
com¥essi⁄C⁄ãxt
);

1082 i‡(
œyî
->
dedu≥Index
 !
NULL
) {

1083 
	`föishDedu≥Index
(
œyî
->
dedu≥Index
);

1085 
	`FREE
(
œyî
->
geomëry
);

1086 
	`FREE
(
œyî
->
•¨eKVDOFlush
);

1087 
œyî
->
•¨eKVDOFlush
 = 
NULL
;

1088 
	`‰ìB©chPro˚ss‹
(&
œyî
->
d©aKVIORñó£r
);

1089 
	`ªmoveLayîFromDevi˚Regi°ry
(
œyî
->
devi˚C⁄fig
->
poﬁName
);

1093 
	`logEº‹
("Unknow¿Kî√»Layî sèã: %d", 
°©e
);

1097 i‡(
u£dCpuQueue
) {

1098 
	`‰ìW‹kQueue
(&
œyî
->
˝uQueue
);

1100 i‡(
u£dBioAckQueue
) {

1101 
	`‰ìW‹kQueue
(&
œyî
->
bioAckQueue
);

1103 i‡(
œyî
->
ioSubmôãr
) {

1104 
	`‰ìIOSubmôãr
(
œyî
->
ioSubmôãr
);

1106 i‡(
u£dKVDO
) {

1107 
	`de°royKVDO
(&
œyî
->
kvdo
);

1109 i‡(
œyî
->
bio£t
 !
NULL
) {

1110 
	`bio£t_‰ì
(
œyî
->
bio£t
);

1111 
œyî
->
bio£t
 = 
NULL
;

1114 
	`‰ìDedu≥Index
(&
œyî
->
dedu≥Index
);

1115 
	`‰ìDevi˚C⁄fig
(&
œyî
->
devi˚C⁄fig
);

1117 
	`°›PîiodicEvítRï‹ãr
(&
œyî
->
ÆbúeoTimeoutRï‹ãr
);

1118 i‡(
ªÀa£In°™˚
) {

1119 
	`ªÀa£KVDOIn°™˚
(
œyî
->
ö°™˚
);

1125 
	`kobje˘_put
(&
œyî
->
°©sDúe˘‹y
);

1126 
	`kobje˘_put
(&
œyî
->
wqDúe˘‹y
);

1127 
	`kobje˘_put
(&
œyî
->
kobj
);

1128 
	}
}

1131 
	$°¨tKî√lLayî
(
Kî√lLayî
 *
œyî
,

1132 c⁄° 
VDOLﬂdC⁄fig
 *
lﬂdC⁄fig
,

1133 **
ªas⁄
)

1135 
	`ASSERT_LOG_ONLY
(
	`gëKî√lLayîSèã
(
œyî
Ë=
LAYER_CPU_QUEUE_INITIALIZED
,

1137 
	`£tKî√lLayîSèã
(
œyî
, 
LAYER_RUNNING
);

1139 
ªsu…
 = 
	`°¨tKVDO
(&
œyî
->
kvdo
, &œyî->
comm⁄
, 
lﬂdC⁄fig
,

1140 
œyî
->
vioTø˚Rec‹dög
, 
ªas⁄
);

1141 i‡(
ªsu…
 !
VDO_SUCCESS
) {

1142 
	`°›Kî√lLayî
(
œyî
);

1143  
ªsu…
;

1146 
	`°¨tDedu≥Index
(
œyî
->
dedu≥Index
);

1147 
ªsu…
 = 
	`vdoCª©eProcfsE¡ry
(
œyî
,Üayî->
devi˚C⁄fig
->
poﬁName
,

1148 &
œyî
->
¥ocfsPriv©e
);

1149 i‡(
ªsu…
 !
VDO_SUCCESS
) {

1150 *
ªas⁄
 = "CouldÇot createÖroc filesystemÉntry";

1151 
	`°›Kî√lLayî
(
œyî
);

1152  
ªsu…
;

1155 
œyî
->
Æloˇti⁄sAŒowed
 = 
Ál£
;

1157  
VDO_SUCCESS
;

1158 
	}
}

1161 
	$°›Kî√lLayî
(
Kî√lLayî
 *
œyî
)

1163 
îr‹Name
[80] = "";

1164 
îr‹Mesßge
[
ERRBUF_SIZE
] = "";

1166 
œyî
->
Æloˇti⁄sAŒowed
 = 
åue
;

1168 
ªsu…
 = 
	`°›KVDO
(&
œyî
->
kvdo
);

1169 i‡((
ªsu…
 !
VDO_SUCCESS
Ë&& (ªsu… !
VDO_READ_ONLY
)) {

1170 
	`logEº‹
("%s: Close device failed %d (%s: %s)",

1171 
__func__
, 
ªsu…
,

1172 
	`°rögEº‹Name
(
ªsu…
, 
îr‹Name
, (errorName)),

1173 
	`°rögEº‹
(
ªsu…
, 
îr‹Mesßge
, (errorMessage)));

1176 
	`gëKî√lLayîSèã
(
œyî
)) {

1177 
LAYER_SUSPENDING
:

1178 
LAYER_SUSPENDED
:

1179 
LAYER_RESUMING
:

1180 
LAYER_RUNNING
:

1181 
	`£tKî√lLayîSèã
(
œyî
, 
LAYER_STOPPING
);

1182 
	`vdoDe°royProcfsE¡ry
(
œyî
->
devi˚C⁄fig
->
poﬁName
,Üayî->
¥ocfsPriv©e
);

1183 
	`°›Dedu≥Index
(
œyî
->
dedu≥Index
);

1186 
LAYER_STOPPING
:

1187 
LAYER_STOPPED
:

1189 
	`£tKî√lLayîSèã
(
œyî
, 
LAYER_STOPPED
);

1192  
ªsu…
;

1193 
	}
}

1196 
	$su•ídKî√lLayî
(
Kî√lLayî
 *
œyî
)

1200 
Kî√lLayîSèã
 
°©e
 = 
	`gëKî√lLayîSèã
(
œyî
);

1201 i‡(
°©e
 =
LAYER_SUSPENDED
) {

1202  
VDO_SUCCESS
;

1204 i‡(
°©e
 !
LAYER_RUNNING
) {

1205 
	`logEº‹
("Suspend invoked while in unexpected kernelÜayer state %d",

1206 
°©e
);

1207  -
EINVAL
;

1210 
	`£tKî√lLayîSèã
(
œyî
, 
LAYER_SUSPENDING
);

1211 
	`su•ídKVDO
(&
œyî
->
kvdo
);

1214 
	`£tKî√lLayîSèã
(
œyî
, 
LAYER_SUSPENDED
);

1217 
	`waôF‹NoReque°sA˘ive
(
œyî
);

1218  
	`synchr⁄ousFlush
(
œyî
);

1219 
	}
}

1222 
	$ªsumeKî√lLayî
(
Kî√lLayî
 *
œyî
)

1224 i‡(
	`gëKî√lLayîSèã
(
œyî
Ë=
LAYER_SUSPENDED
) {

1225 
	`£tKî√lLayîSèã
(
œyî
, 
LAYER_RESUMING
);

1226 
	`ªsumeKVDO
(&
œyî
->
kvdo
);

1227 
	`£tKî√lLayîSèã
(
œyî
, 
LAYER_RUNNING
);

1229  
VDO_SUCCESS
;

1230 
	}
}

1233 
	$¥ï¨eToResizePhysiˇl
(
Kî√lLayî
 *
œyî
, 
BlockCou¡
 
physiˇlCou¡
)

1235 
	`logInfo
("Pª∑rögÅÿªsizêphysiˇ»tÿ%" 
PRIu64
, 
physiˇlCou¡
);

1237 
œyî
->
Æloˇti⁄sAŒowed
 = 
åue
;

1238 
ªsu…
 = 
	`kvdoPª∑ªToGrowPhysiˇl
(&
œyî
->
kvdo
, 
physiˇlCou¡
);

1239 
œyî
->
Æloˇti⁄sAŒowed
 = 
Ál£
;

1240 i‡(
ªsu…
 !
VDO_SUCCESS
) {

1242  
ªsu…
;

1245 
	`logInfo
("DoneÖreparingÅoÑesizeÖhysical");

1246  
VDO_SUCCESS
;

1247 
	}
}

1250 
	$ªsizePhysiˇl
(
Kî√lLayî
 *
œyî
, 
BlockCou¡
 
physiˇlCou¡
)

1252 i‡(
physiˇlCou¡
 <
œyî
->
blockCou¡
) {

1253 
	`logW¨nög
("Reque°edÖhysiˇ»block cou¡ %" 
PRIu64


1254 "ÇŸ gª©îÅh™ %" 
PRIu64
,

1255 (
uöt64_t
Ë
physiˇlCou¡
, (uöt64_tË
œyî
->
blockCou¡
);

1256  -
EINVAL
;

1259 
œyî
->
Æloˇti⁄sAŒowed
 = 
åue
;

1260 
ªsu…
 = 
	`kvdoResizePhysiˇl
(&
œyî
->
kvdo
, 
physiˇlCou¡
);

1261 
œyî
->
Æloˇti⁄sAŒowed
 = 
Ál£
;

1262 i‡(
ªsu…
 !
VDO_SUCCESS
) {

1264  
ªsu…
;

1266 
	`logInfo
("Physiˇ»block cou¡ wa†%" 
PRIu64
 ",Çow %" PRIu64,

1267 (
uöt64_t
Ë
œyî
->
blockCou¡
, (uöt64_tË
physiˇlCou¡
);

1268 
œyî
->
blockCou¡
 = 
physiˇlCou¡
;

1271  
VDO_SUCCESS
;

1272 
	}
}

1275 
	$¥ï¨eToResizeLogiˇl
(
Kî√lLayî
 *
œyî
, 
BlockCou¡
 
logiˇlCou¡
)

1277 
	`logInfo
("Pª∑rögÅÿªsizêlogiˇ»tÿ%" 
PRIu64
, 
logiˇlCou¡
);

1279 
œyî
->
Æloˇti⁄sAŒowed
 = 
åue
;

1280 
ªsu…
 = 
	`kvdoPª∑ªToGrowLogiˇl
(&
œyî
->
kvdo
, 
logiˇlCou¡
);

1281 
œyî
->
Æloˇti⁄sAŒowed
 = 
Ál£
;

1282 i‡(
ªsu…
 !
VDO_SUCCESS
) {

1284  
ªsu…
;

1287 
	`logInfo
("DoneÖreparingÅoÑesizeÜogical");

1288  
VDO_SUCCESS
;

1289 
	}
}

1292 
	$ªsizeLogiˇl
(
Kî√lLayî
 *
œyî
, 
BlockCou¡
 
logiˇlCou¡
)

1294 
	`logInfo
("ResizögÜogiˇ»tÿ%" 
PRIu64
, 
logiˇlCou¡
);

1295 
ªsu…
 = 
	`kvdoResizeLogiˇl
(&
œyî
->
kvdo
, 
logiˇlCou¡
);

1296 i‡(
ªsu…
 !
VDO_SUCCESS
) {

1298  
ªsu…
;

1301 
	`logInfo
("Logiˇ»block†now %" 
PRIu64
, 
logiˇlCou¡
);

1302  
VDO_SUCCESS
;

1303 
	}
}

	@vdo/kernel/kernelLayer.h

22 #i‚de‡
KERNELLAYER_H


23 
	#KERNELLAYER_H


	)

25 
	~<löux/devi˚-m≠≥r.h
>

27 
	~"c⁄°™ts.h
"

28 
	~"Êush.h
"

29 
	~"ötM≠.h
"

30 
	~"physiˇlLayî.h
"

31 
	~"vﬁumeGeomëry.h
"

32 
	~"waôQueue.h
"

34 
	~"b©chPro˚ss‹.h
"

35 
	~"buf„rPoﬁ.h
"

36 
	~"dódlockQueue.h
"

37 
	~"devi˚C⁄fig.h
"

38 
	~"hóπbót.h
"

39 
	~"hi°ogøm.h
"

40 
	~"kî√lSèti°ics.h
"

41 
	~"kî√lTy≥s.h
"

42 
	~"kî√lVDO.h
"

43 
	~"kåa˚.h
"

44 
	~"limôî.h
"

45 
	~"w‹kQueue.h
"

48 
	mVDO_SECTORS_PER_BLOCK
 = (
VDO_BLOCK_SIZE
 >> 
SECTOR_SHIFT
)

52 
	mLAYER_SIMPLE_THINGS_INITIALIZED
,

53 
	mLAYER_BUFFER_POOLS_INITIALIZED
,

54 
	mLAYER_REQUEST_QUEUE_INITIALIZED
,

55 
	mLAYER_CPU_QUEUE_INITIALIZED
,

56 
	mLAYER_BIO_ACK_QUEUE_INITIALIZED
,

57 
	mLAYER_BIO_DATA_INITIALIZED
,

58 
	mLAYER_RUNNING
,

59 
	mLAYER_SUSPENDING
,

60 
	mLAYER_SUSPENDED
,

61 
	mLAYER_RESUMING
,

62 
	mLAYER_STOPPING
,

63 
	mLAYER_STOPPED
,

64 } 
	tKî√lLayîSèã
;

67 
	s©omicBioSèts
 {

68 
©omic64_t
 
	mªad
;

69 
©omic64_t
 
	mwrôe
;

70 
©omic64_t
 
	mdisˇrd
;

71 
©omic64_t
 
	mÊush
;

72 
©omic64_t
 
	mfua
;

76 
	s≥riodicEvítRï‹ãr
 {

77 
uöt64_t
 
	mœ°Rï‹ãdVÆue
;

78 c⁄° *
	mf‹m©
;

79 
©omic64_t
 
	mvÆue
;

80 
Jiffõs
 
	mªp‹tögI¡îvÆ
;

91 
©omic_t
 
	mw‹kIãmQueued
;

92 
KvdoW‹kIãm
 
	mw‹kIãm
;

93 
Kî√lLayî
 *
	mœyî
;

94 } 
	tPîiodicEvítRï‹ãr
;

96 
ölöe
 
uöt64_t
 
	$gëEvítCou¡
(
PîiodicEvítRï‹ãr
 *
ªp‹ãr
)

98  
	`©omic64_ªad
(&
ªp‹ãr
->
vÆue
);

99 
	}
}

104 
	skî√lLayî
 {

105 
PhysiˇlLayî
 
	mcomm⁄
;

107 
Devi˚C⁄fig
 *
	mdevi˚C⁄fig
;

108 
	mthªadNamePªfix
[
MAX_QUEUE_NAME_LEN
];

109 
kobje˘
 
	mkobj
;

110 
kobje˘
 
	mwqDúe˘‹y
;

111 
kobje˘
 
	m°©sDúe˘‹y
;

112 
VDOSèti°ics
 *
	mvdoSètsSt‹age
;

113 
Kî√lSèti°ics
 *
	mkî√lSètsSt‹age
;

114 
•ölock_t
 
	m°©sLock
;

119 
	mö°™˚
;

121 
Atomic32
 
	m°©e
;

122 
boﬁ
 
	mÆloˇti⁄sAŒowed
;

124 
dm_èrgë
 *
	mti
;

126 
dm_èrgë
 *
	mﬁdTI
;

127 
dm_dev
 *
	mﬁdDev
;

128 
AtomicBoﬁ
 
	m¥o˚ssögMesßge
;

131 
Limôî
 
	mªque°Limôî
;

132 
Limôî
 
	mdisˇrdLimôî
;

133 
KVDO
 
	mkvdo
;

135 
DódlockQueue
 
	mdódlockQueue
;

137 
bio_li°
 
	mwaôögFlushes
;

138 
KVDOFlush
 *
	m•¨eKVDOFlush
;

139 
•ölock_t
 
	mÊushLock
;

140 
Jiffõs
 
	mÊushAºivÆTime
;

145 
com∂ëi⁄
 
	mÊushWaô
;

146 
boﬁ
 
	mmdRaid5ModeE«bÀd
;

151 
IOSubmôãr
 *
	mioSubmôãr
;

156 
KvdoW‹kQueue
 *
	m˝uQueue
;

158 **
	mcom¥essi⁄C⁄ãxt
;

159 
Atomic32
 
	mcom¥essi⁄C⁄ãxtIndex
;

161 
KvdoW‹kQueue
 *
	mbioAckQueue
;

163 
dm_dev
 *
	mdev
;

164 
BlockCou¡
 
	mblockCou¡
;

165 
BlockSize
 
	mlogiˇlBlockSize
;

166 
uöt64_t
 
	m°¨tögSe˘‹Off£t
;

167 
VﬁumeGeomëry
 *
	mgeomëry
;

169 
	mªadCacheBlocks
;

171 
Buf„rPoﬁ
 *
	md©aKVIOPoﬁ
;

172 
bio_£t
 *
	mbio£t
;

174 
Dedu≥Index
 *
	mdedu≥Index
;

176 
©omic64_t
 
	mbiosSubmôãd
;

177 
©omic64_t
 
	mbiosCom∂ëed
;

178 
©omic64_t
 
	mdedu≥Advi˚VÆid
;

179 
©omic64_t
 
	mdedu≥Advi˚SèÀ
;

180 
©omic64_t
 
	mÊushOut
;

181 
AtomicBioSèts
 
	mbiosIn
;

182 
AtomicBioSèts
 
	mbiosInP¨tül
;

183 
AtomicBioSèts
 
	mbiosOut
;

184 
AtomicBioSèts
 
	mbiosOutCom∂ëed
;

185 
AtomicBioSèts
 
	mbiosAcknowÀdged
;

186 
AtomicBioSèts
 
	mbiosAcknowÀdgedP¨tül
;

187 
AtomicBioSèts
 
	mbiosMëa
;

188 
AtomicBioSèts
 
	mbiosMëaCom∂ëed
;

189 
AtomicBioSèts
 
	mbiosJou∫Æ
;

190 
AtomicBioSèts
 
	mbiosPageCache
;

191 
AtomicBioSèts
 
	mbiosJou∫ÆCom∂ëed
;

192 
AtomicBioSèts
 
	mbiosPageCacheCom∂ëed
;

194 
PîiodicEvítRï‹ãr
 
	mÆbúeoTimeoutRï‹ãr
;

197 
boﬁ
 
	mdumpOnShutdown
;

202 
boﬁ
 
	mvioTø˚Rec‹dög
;

203 
Sam∂eCou¡î
 
	måa˚Sam∂eCou¡î
;

205 
boﬁ
 
	måa˚Loggög
;

207 
Buf„rPoﬁ
 *
	måa˚Buf„rPoﬁ
;

209 *
	m¥ocfsPriv©e
;

211 
B©chPro˚ss‹
 *
	md©aKVIORñó£r
;

215 
com∂ëi⁄
 
	mˇŒbackSync
;

218 
	ebioQA˘i⁄
 {

219 
	mBIO_Q_ACTION_COMPRESSED_DATA
,

220 
	mBIO_Q_ACTION_DATA
,

221 
	mBIO_Q_ACTION_FLUSH
,

222 
	mBIO_Q_ACTION_HIGH
,

223 
	mBIO_Q_ACTION_METADATA
,

224 
	mBIO_Q_ACTION_READCACHE
,

225 
	mBIO_Q_ACTION_VERIFY


226 } 
	tBioQA˘i⁄
;

228 
	e˝uQA˘i⁄
 {

229 
	mCPU_Q_ACTION_COMPARE_BLOCKS
,

230 
	mCPU_Q_ACTION_COMPLETE_KVIO
,

231 
	mCPU_Q_ACTION_COMPRESS_BLOCK
,

232 
	mCPU_Q_ACTION_DEDUPE_SHUTDOWN
,

233 
	mCPU_Q_ACTION_EVENT_REPORTER
,

234 
	mCPU_Q_ACTION_HASH_BLOCK
,

235 
	mCPU_Q_ACTION_SET_UP_VERIFY
,

236 } 
	tCPUQA˘i⁄
;

238 
	ebioAckQA˘i⁄
 {

239 
	mBIO_ACK_Q_ACTION_ACK
,

240 } 
	tBioAckQA˘i⁄
;

242 (*
	tDedu≥ShutdownCÆlbackFun˘i⁄
)(
	tKî√lLayî
 *
	tœyî
);

248 
	skvdoEnqueuóbÀ
 {

249 
KvdoW‹kIãm
 
w‹kIãm
;

250 
EnqueuóbÀ
 
íqueuóbÀ
;

251 } 
	tKvdoEnqueuóbÀ
;

269 
	$makeKî√lLayî
(
BlockCou¡
 
blockCou¡
,

270 
uöt64_t
 
°¨tögSe˘‹
,

271 
dm_dev
 *
dev
,

272 
ö°™˚
,

273 
Devi˚C⁄fig
 *
c⁄fig
,

274 
kobje˘
 *
∑ª¡Kobje˘
,

275 
ThªadC⁄fig
 **
thªadC⁄figPoöãr
,

276 **
ªas⁄
,

277 
Kî√lLayî
 **
œyîPå
)

278 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

290 
	$modifyKî√lLayî
(
Kî√lLayî
 *
œyî
,

291 
dm_èrgë
 *
ti
,

292 
Devi˚C⁄fig
 *
c⁄fig
,

293 **
why
)

294 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

302 
	`‰ìKî√lLayî
(
Kî√lLayî
 *
œyî
);

315 
	`°¨tKî√lLayî
(
Kî√lLayî
 *
œyî
,

316 c⁄° 
VDOLﬂdC⁄fig
 *
lﬂdC⁄fig
,

317 **
ªas⁄
);

326 
	`°›Kî√lLayî
(
Kî√lLayî
 *
œyî
);

335 
	`su•ídKî√lLayî
(
Kî√lLayî
 *
œyî
);

344 
	`ªsumeKî√lLayî
(
Kî√lLayî
 *
œyî
);

353 
ölöe
 
Kî√lLayîSèã
 
	$gëKî√lLayîSèã
(c⁄° 
Kî√lLayî
 *
œyî
)

355  
	`ªœxedLﬂd32
(&
œyî
->
°©e
);

356 
	}
}

368 
kvdoM≠Bio
(
Kî√lLayî
 *
œyî
, 
BIO
 *
bio
);

377 
ölöe
 
Kî√lLayî
 *
	$asKî√lLayî
(
PhysiˇlLayî
 *
œyî
)

379  
	`c⁄èöî_of
(
œyî
, 
Kî√lLayî
, 
comm⁄
);

380 
	}
}

396 
ölöe
 
£˘‹_t
 
	$blockToSe˘‹
(
Kî√lLayî
 *
œyî
, 
£˘‹_t
 
blockNumbî
)

398  (
blockNumbî
 * 
VDO_SECTORS_PER_BLOCK
);

399 
	}
}

411 
ölöe
 
£˘‹_t
 
	$£˘‹ToBlock
(
Kî√lLayî
 *
œyî
, 
£˘‹_t
 
£˘‹Numbî
)

413  (
£˘‹Numbî
 / 
VDO_SECTORS_PER_BLOCK
);

414 
	}
}

424 
ölöe
 
BlockSize
 
	$£˘‹ToBlockOff£t
(
Kî√lLayî
 *
œyî
,

425 
£˘‹_t
 
£˘‹Numbî
)

427 
£˘‹sPîBlockMask
 = 
VDO_SECTORS_PER_BLOCK
 - 1;

428  
	`to_byãs
(
£˘‹Numbî
 & 
£˘‹sPîBlockMask
);

429 
	}
}

442 
m≠ToSy°emEº‹
(
îr‹
);

455 
kvdoRï‹tDedu≥Timeout
(
Kî√lLayî
 *
œyî
, 
expúedCou¡
);

462 
waôF‹NoReque°sA˘ive
(
Kî√lLayî
 *
œyî
);

471 
ölöe
 
	$íqueueCPUW‹kQueue
(
Kî√lLayî
 *
œyî
, 
KvdoW‹kIãm
 *
ôem
)

473 
	`íqueueW‹kQueue
(
œyî
->
˝uQueue
, 
ôem
);

474 
	}
}

485 
¥ï¨eToResizePhysiˇl
(
Kî√lLayî
 *
œyî
, 
BlockCou¡
 
physiˇlCou¡
);

496 
ªsizePhysiˇl
(
Kî√lLayî
 *
œyî
, 
BlockCou¡
 
physiˇlCou¡
);

507 
¥ï¨eToResizeLogiˇl
(
Kî√lLayî
 *
œyî
, 
BlockCou¡
 
logiˇlCou¡
);

518 
ªsizeLogiˇl
(
Kî√lLayî
 *
œyî
, 
BlockCou¡
 
logiˇlCou¡
);

532 
ölöe
 
boﬁ
 
	$u£BioAckQueue
(
Kî√lLayî
 *
œyî
)

534  
œyî
->
devi˚C⁄fig
->
thªadCou¡s
.
bioAckThªads
 > 0;

535 
	}
}

544 
com∂ëeM™yReque°s
(
Kî√lLayî
 *
œyî
, 
uöt32_t
 
cou¡
);

	@vdo/kernel/kernelStatistics.h

20 #i‚de‡
KERNEL_STATISTICS_H


21 
	#KERNEL_STATISTICS_H


	)

23 
	~"hódî.h
"

24 
	~"ty≥s.h
"

28 
uöt64_t
 
	mªad
;

30 
uöt64_t
 
	mwrôe
;

32 
uöt64_t
 
	mdisˇrd
;

34 
uöt64_t
 
	mÊush
;

36 
uöt64_t
 
	mfua
;

37 } 
	tBioSèts
;

42 
uöt64_t
 
	mac˚s£s
;

44 
uöt64_t
 
	mhôs
;

46 
uöt64_t
 
	md©aHôs
;

47 } 
	tRódCacheSèts
;

51 
uöt64_t
 
	mbyãsU£d
;

53 
uöt64_t
 
	m≥akByãsU£d
;

55 
uöt64_t
 
	mbiosU£d
;

57 
uöt64_t
 
	m≥akBioCou¡
;

58 } 
	tMem‹yUßge
;

61 
uöt32_t
 
	mvîsi⁄
;

62 
uöt32_t
 
	mªÀa£Vîsi⁄
;

64 
uöt32_t
 
	mö°™˚
;

66 
uöt32_t
 
	mcuºítVIOsInProgªss
;

68 
uöt32_t
 
	mmaxVIOs
;

70 
uöt32_t
 
	mcuºDedu≥Quîõs
;

72 
uöt32_t
 
	mmaxDedu≥Quîõs
;

74 
uöt64_t
 
	mdedu≥Advi˚VÆid
;

76 
uöt64_t
 
	mdedu≥Advi˚SèÀ
;

78 
uöt64_t
 
	mdedu≥Advi˚Timeouts
;

80 
uöt64_t
 
	mÊushOut
;

82 
uöt64_t
 
	mlogiˇlBlockSize
;

84 
BioSèts
 
	mbiosIn
;

85 
BioSèts
 
	mbiosInP¨tül
;

87 
BioSèts
 
	mbiosOut
;

89 
BioSèts
 
	mbiosMëa
;

90 
BioSèts
 
	mbiosJou∫Æ
;

91 
BioSèts
 
	mbiosPageCache
;

92 
BioSèts
 
	mbiosOutCom∂ëed
;

93 
BioSèts
 
	mbiosMëaCom∂ëed
;

94 
BioSèts
 
	mbiosJou∫ÆCom∂ëed
;

95 
BioSèts
 
	mbiosPageCacheCom∂ëed
;

96 
BioSèts
 
	mbiosAcknowÀdged
;

97 
BioSèts
 
	mbiosAcknowÀdgedP¨tül
;

99 
BioSèts
 
	mbiosInProgªss
;

101 
RódCacheSèts
 
	mªadCache
;

103 
Mem‹yUßge
 
	mmem‹yUßge
;

104 } 
	tKî√lSèti°ics
;

111 
ölöe
 c⁄° *
	$gëProcRoŸ
() {

113 
	}
}

120 
ölöe
 c⁄° *
	$gëKî√lSèti°icsProcFûe
() {

122 
	}
}

	@vdo/kernel/kernelTypes.h

22 #i‚de‡
KERNEL_TYPES_H


23 
	#KERNEL_TYPES_H


	)

25 
	~"ty≥s.h
"

30 
uöt32_t
 
	tDisˇrdSize
;

35 
uöt64_t
 
	tJiffõs
;

40 
öt64_t
 
	tTimeoutJiffõs
;

42 
©omicBioSèts
 
	tAtomicBioSèts
;

43 
bio
 
	tBIO
;

44 
d©aKVIO
 
	tD©aKVIO
;

45 
dedu≥C⁄ãxt
 
	tDedu≥C⁄ãxt
;

46 
dedu≥Index
 
	tDedu≥Index
;

47 
ioSubmôãr
 
	tIOSubmôãr
;

48 
kî√lLayî
 
	tKî√lLayî
;

49 
kvdo
 
	tKVDO
;

50 
kvdoFlush
 
	tKVDOFlush
;

51 
kvdoW‹kIãm
 
	tKvdoW‹kIãm
;

52 
kvdoW‹kQueue
 
	tKvdoW‹kQueue
;

53 
kvio
 
	tKVIO
;

54 
ªadCache
 
	tRódCache
;

55 
ªadCacheE¡ry
 
	tRódCacheE¡ry
;

57 (*
	tKVIOCÆlback
)(
	tKVIO
 *
	tkvio
);

58 (*
	tD©aKVIOCÆlback
)(
	tD©aKVIO
 *
	td©aKVIO
);

59 (*
	tKvdoW‹kFun˘i⁄
)(
	tKvdoW‹kIãm
 *
	tw‹kIãm
);

	@vdo/kernel/kernelVDO.c

22 
	~"kî√lVDOI¡î«ls.h
"

24 
	~<löux/dñay.h
>

26 
	~"mem‹yAŒoc.h
"

28 
	~"°©i°ics.h
"

29 
	~"thªadC⁄fig.h
"

30 
	~"vdo.h
"

31 
	~"vdoClo£.h
"

32 
	~"vdoDebug.h
"

33 
	~"vdoLﬂd.h
"

34 
	~"vdoResize.h
"

35 
	~"vdoResizeLogiˇl.h
"

37 
	~"kî√lLayî.h
"

38 
	~"kvio.h
"

39 
	~"loggî.h
"

41 íum { 
	mPARANOID_THREAD_CONSISTENCY_CHECKS
 = 0 };

48 
°›AŒHóπbóts
(
KVDO
 *
kvdo
);

51 
	$°¨tKVDOReque°Queue
(*
±r
)

53 
KVDOThªad
 *
thªad
 = 
±r
;

54 
KVDO
 *
kvdo
 = 
thªad
->kvdo;

55 
Kî√lLayî
 *
œyî
 = 
	`c⁄èöî_of
(
kvdo
, KernelLayer, kvdo);

56 
	`ªgi°îAŒoˇtögThªad
(&
thªad
->
ÆloˇtögThªad
,

57 &
œyî
->
Æloˇti⁄sAŒowed
);

58 
	`£tW‹kQueuePriv©eD©a
(
thªad
);

59 
	}
}

62 
	$föishKVDOReque°Queue
(*
±r
)

64 
	`uƒegi°îAŒoˇtögThªad
();

65 
	}
}

68 c⁄° 
KvdoW‹kQueueTy≥
 
	gªque°QueueTy≥
 = {

69 .
°¨t
 = 
°¨tKVDOReque°Queue
,

70 .
	gföish
 = 
föishKVDOReque°Queue
,

71 .
	ga˘i⁄TabÀ
 = {

72 { .
«me
 = "req_completion",

73 .
	gcode
 = 
REQ_Q_ACTION_COMPLETION
,

74 .
	g¥i‹ôy
 = 1 },

75 { .
	g«me
 = "req_flush",

76 .
	gcode
 = 
REQ_Q_ACTION_FLUSH
,

77 .
	g¥i‹ôy
 = 2 },

78 { .
	g«me
 = "req_heartbeat",

79 .
	gcode
 = 
REQ_Q_ACTION_HEARTBEAT
,

80 .
	g¥i‹ôy
 = 2 },

81 { .
	g«me
 = "req_map_bio",

82 .
	gcode
 = 
REQ_Q_ACTION_MAP_BIO
,

83 .
	g¥i‹ôy
 = 0 },

84 { .
	g«me
 = "req_shutdown",

85 .
	gcode
 = 
REQ_Q_ACTION_SHUTDOWN
,

86 .
	g¥i‹ôy
 = 0 },

87 { .
	g«me
 = "req_sync",

88 .
	gcode
 = 
REQ_Q_ACTION_SYNC
,

89 .
	g¥i‹ôy
 = 2 },

90 { .
	g«me
 = "req_vio_callback",

91 .
	gcode
 = 
REQ_Q_ACTION_VIO_CALLBACK
,

92 .
	g¥i‹ôy
 = 1 },

97 
	$öôülizeKVDO
(
KVDO
 *
kvdo
,

98 c⁄° 
ThªadC⁄fig
 *
thªadC⁄fig
,

99 **
ªas⁄
)

101 
ba£Thªads
 = 
thªadC⁄fig
->
ba£ThªadCou¡
;

102 
ªsu…
 = 
	`ALLOCATE
(
ba£Thªads
, 
KVDOThªad
,

104 &
kvdo
->
thªads
);

105 i‡(
ªsu…
 !
VDO_SUCCESS
) {

106 *
ªas⁄
 = "CannotállocationÅhread structures";

107  
ªsu…
;

109 
Kî√lLayî
 *
œyî
 = 
	`c⁄èöî_of
(
kvdo
, KernelLayer, kvdo);

110 
kvdo
->
öôülizedThªadCou¡
 = 0;

111 
kvdo
->
öôülizedThªadCou¡
 < 
ba£Thªads
;

112 
kvdo
->
öôülizedThªadCou¡
++) {

113 
KVDOThªad
 *
thªad
 = &
kvdo
->
thªads
[kvdo->
öôülizedThªadCou¡
];

116 
	`öô_com∂ëi⁄
(&
thªad
->
hóπbótWaô
);

119 
	`£tupHóπbót
(&
thªad
->
hóπbót
);

121 
thªad
->
kvdo
 = kvdo;

122 
thªad
->
thªadID
 = 
kvdo
->
öôülizedThªadCou¡
;

124 
queueName
[
MAX_QUEUE_NAME_LEN
];

126 
	`gëVDOThªadName
(
thªadC⁄fig
, 
kvdo
->
öôülizedThªadCou¡
,

127 
queueName
, (queueName));

128 
ªsu…
 = 
	`makeW‹kQueue
(
œyî
->
thªadNamePªfix
, 
queueName
,

129 &
œyî
->
wqDúe˘‹y
, 
thªad
, &
ªque°QueueTy≥
,

130 1, &
thªad
->
ªque°Queue
);

131 i‡(
ªsu…
 !
VDO_SUCCESS
) {

132 *
ªas⁄
 = "Cannot initializeÑequest queue";

133 
kvdo
->
öôülizedThªadCou¡
 > 0) {

134 
thªadToDe°roy
 = 
kvdo
->
öôülizedThªadCou¡
 - 1;

135 
thªad
 = &
kvdo
->
thªads
[
thªadToDe°roy
];

136 
	`föishW‹kQueue
(
thªad
->
ªque°Queue
);

137 
	`‰ìW‹kQueue
(&
thªad
->
ªque°Queue
);

138 
kvdo
->
öôülizedThªadCou¡
--;

140 
	`FREE
(
kvdo
->
thªads
);

141  
ªsu…
;

145  
VDO_SUCCESS
;

146 
	}
}

149 
	$°¨tKVDO
(
KVDO
 *
kvdo
,

150 
PhysiˇlLayî
 *
comm⁄
,

151 c⁄° 
VDOLﬂdC⁄fig
 *
lﬂdC⁄fig
,

152 
boﬁ
 
vioTø˚Rec‹dög
,

153 **
ªas⁄
)

155 
Kî√lLayî
 *
œyî
 = 
	`asKî√lLayî
(
comm⁄
);

156 
	`öô_com∂ëi⁄
(&
œyî
->
ˇŒbackSync
);

157 
ªsu…
 = 
	`≥rf‹mVDOLﬂd
(
kvdo
->
vdo
, 
lﬂdC⁄fig
);

158 i‡((
ªsu…
 !
VDO_SUCCESS
Ë&& (ªsu… !
VDO_READ_ONLY
)) {

159 *
ªas⁄
 = "CannotÜoad metadata from device";

160  
ªsu…
;

163 
	`£tVDOTøcögFœgs
(
kvdo
->
vdo
, 
vioTø˚Rec‹dög
);

165 
i
 = 0; i < 
kvdo
->
öôülizedThªadCou¡
; i++) {

166 
	`°¨tHóπbót
(&
kvdo
->
thªads
[
i
].
hóπbót
);

168 
	`m¶ìp
(50 / 
kvdo
->
öôülizedThªadCou¡
);

170 
kvdo
->
hóπsBótög
 = 
åue
;

172  
VDO_SUCCESS
;

173 
	}
}

176 
	$°›KVDO
(
KVDO
 *
kvdo
)

178 i‡(
kvdo
->
vdo
 =
NULL
) {

179  
VDO_SUCCESS
;

183 i‡(
kvdo
->
hóπsBótög
) {

184 
	`°›AŒHóπbóts
(
kvdo
);

187 
Kî√lLayî
 *
œyî
 = 
	`c⁄èöî_of
(
kvdo
, KernelLayer, kvdo);

188 
	`öô_com∂ëi⁄
(&
œyî
->
ˇŒbackSync
);

189  
	`≥rf‹mVDOClo£
(
kvdo
->
vdo
);

190 
	}
}

193 
	$föishKVDO
(
KVDO
 *
kvdo
)

195 
i
 = 0; i < 
kvdo
->
öôülizedThªadCou¡
; i++) {

196 
	`föishW‹kQueue
(
kvdo
->
thªads
[
i
].
ªque°Queue
);

198 
	}
}

201 
	$de°royKVDO
(
KVDO
 *
kvdo
)

203 
	`de°royVDO
(
kvdo
->
vdo
);

204 
i
 = 0; i < 
kvdo
->
öôülizedThªadCou¡
; i++) {

205 
	`‰ìW‹kQueue
(&
kvdo
->
thªads
[
i
].
ªque°Queue
);

207 
	`FREE
(
kvdo
->
thªads
);

208 
kvdo
->
thªads
 = 
NULL
;

209 
	}
}

213 
	$dumpKVDOW‹kQueue
(
KVDO
 *
kvdo
)

215 
i
 = 0; i < 
kvdo
->
öôülizedThªadCou¡
; i++) {

216 
	`dumpW‹kQueue
(
kvdo
->
thªads
[
i
].
ªque°Queue
);

218 
	}
}

222 
KvdoW‹kIãm
 
	mw‹kIãm
;

223 
KVDO
 *
	mkvdo
;

224 *
	md©a
;

225 
com∂ëi⁄
 *
	mcom∂ëi⁄
;

226 } 
	tSyncQueueW‹k
;

242 
	$≥rf‹mKVDOO≥øti⁄
(
KVDO
 *
kvdo
,

243 
KvdoW‹kFun˘i⁄
 
a˘i⁄
,

244 *
d©a
,

245 
ThªadID
 
thªadID
,

246 
com∂ëi⁄
 *completion)

248 
SyncQueueW‹k
 
sync
;

250 
	`mem£t
(&
sync
, 0, (sync));

251 
	`£tupW‹kIãm
(&
sync
.
w‹kIãm
, 
a˘i⁄
, 
NULL
, 
REQ_Q_ACTION_SYNC
);

252 
sync
.
kvdo
 = kvdo;

253 
sync
.
d©a
 = data;

254 
sync
.
com∂ëi⁄
 = completion;

256 
	`öô_com∂ëi⁄
(
com∂ëi⁄
);

257 
	`íqueueKVDOW‹k
(
kvdo
, &
sync
.
w‹kIãm
, 
thªadID
);

258 
	`waô_f‹_com∂ëi⁄
(
com∂ëi⁄
);

259 
	}
}

277 
	$≥rf‹mKVDOThªadA˘i⁄
(
KVDOThªad
 *
thªad
,

278 
KvdoW‹kFun˘i⁄
 
a˘i⁄
,

279 *
d©a
,

280 
com∂ëi⁄
 *completion)

282 
SyncQueueW‹k
 
sync
;

284 
	`mem£t
(&
sync
, 0, (sync));

285 
	`£tupW‹kIãm
(&
sync
.
w‹kIãm
, 
a˘i⁄
, 
NULL
, 
REQ_Q_ACTION_SYNC
);

286 
sync
.
kvdo
 = 
thªad
->kvdo;

287 
sync
.
d©a
 = data;

288 
sync
.
com∂ëi⁄
 = completion;

290 
	`öô_com∂ëi⁄
(
com∂ëi⁄
);

291 
	`íqueueW‹kQueue
(
thªad
->
ªque°Queue
, &
sync
.
w‹kIãm
);

292 
	`waô_f‹_com∂ëi⁄
(
com∂ëi⁄
);

293 
	}
}

296 
	$°›HóπbótW‹k
(
KvdoW‹kIãm
 *
ôem
)

298 
SyncQueueW‹k
 *
su•íd
 = 
	`c⁄èöî_of
(
ôem
, SyncQueueW‹k, 
w‹kIãm
);

299 
KVDOThªad
 *
thªad
 = (KVDOThªad *Ë
su•íd
->
d©a
;

302 
	`°›Hóπbót
(&
thªad
->
hóπbót
);

303 
	}
}

306 
	$°›AŒHóπbóts
(
KVDO
 *
kvdo
)

312 
i
 = 0; i < 
kvdo
->
öôülizedThªadCou¡
; i++) {

313 
	`≥rf‹mKVDOThªadA˘i⁄
(&
kvdo
->
thªads
[
i
], 
°›HóπbótW‹k
,

314 &
kvdo
->
thªads
[
i
],

315 &
kvdo
->
thªads
[
i
].
hóπbótWaô
);

317 
kvdo
->
hóπsBótög
 = 
Ál£
;

318 
	}
}

321 
	$su•ídKVDO
(
KVDO
 *
kvdo
)

323 
	`°›AŒHóπbóts
(
kvdo
);

324 
	}
}

327 
	$ªsumeKVDO
(
KVDO
 *
kvdo
)

329 
i
 = 0; i < 
kvdo
->
öôülizedThªadCou¡
; i++) {

330 
	`°¨tHóπbót
(&
kvdo
->
thªads
[
i
].
hóπbót
);

332 
kvdo
->
hóπsBótög
 = 
åue
;

333 
	}
}

337 
boﬁ
 
	míabÀ
;

338 
boﬁ
 
	mwasE«bÀd
;

339 } 
	tVDOCom¥essD©a
;

347 
	$£tCom¥essögW‹k
(
KvdoW‹kIãm
 *
ôem
)

349 
SyncQueueW‹k
 *
w‹k
 = 
	`c⁄èöî_of
(
ôem
, SyncQueueW‹k, 
w‹kIãm
);

350 
VDOCom¥essD©a
 *
d©a
 = (VDOCom¥essD©®*)
w‹k
->data;

351 
d©a
->
wasE«bÀd
 = 
	`£tVDOCom¥essög
(
	`gëVDO
(
w‹k
->
kvdo
), d©a->
íabÀ
);

352 
	`com∂ëe
(
w‹k
->
com∂ëi⁄
);

353 
	}
}

356 
boﬁ
 
	$£tKVDOCom¥essög
(
KVDO
 *
kvdo
, 
boﬁ
 
íabÀCom¥essi⁄
)

358 
com∂ëi⁄
 
com¥essWaô
;

359 
VDOCom¥essD©a
 
d©a
;

360 
d©a
.
íabÀ
 = 
íabÀCom¥essi⁄
;

361 
	`≥rf‹mKVDOO≥øti⁄
(
kvdo
, 
£tCom¥essögW‹k
, &
d©a
,

362 
	`gëPackîZ⁄eThªad
(
	`gëThªadC⁄fig
(
kvdo
->
vdo
)),

363 &
com¥essWaô
);

364  
d©a
.
wasE«bÀd
;

365 
	}
}

372 
	$gëVDOSèti°icsW‹k
(
KvdoW‹kIãm
 *
ôem
)

374 
SyncQueueW‹k
 *
w‹k
 = 
	`c⁄èöî_of
(
ôem
, SyncQueueW‹k, 
w‹kIãm
);

375 
VDOSèti°ics
 *
°©s
 = (VDOSèti°ic†*)
w‹k
->
d©a
;

376 
	`gëVDOSèti°ics
(
	`gëVDO
(
w‹k
->
kvdo
), 
°©s
);

377 
	`com∂ëe
(
w‹k
->
com∂ëi⁄
);

378 
	}
}

381 
	$gëKVDOSèti°ics
(
KVDO
 *
kvdo
, 
VDOSèti°ics
 *
°©s
)

383 
com∂ëi⁄
 
°©sWaô
;

384 
	`mem£t
(
°©s
, 0, (
VDOSèti°ics
));

385 
	`≥rf‹mKVDOO≥øti⁄
(
kvdo
, 
gëVDOSèti°icsW‹k
, 
°©s
,

386 
	`gëAdmöThªad
(
	`gëThªadC⁄fig
(
kvdo
->
vdo
)),

387 &
°©sWaô
);

388 
	}
}

393 
	svdoA˘i⁄D©a
 {

394 
VDOA˘i⁄
 *
	ma˘i⁄
;

395 
VDOCom∂ëi⁄
 *
	mvdoCom∂ëi⁄
;

396 
com∂ëi⁄
 
	mwaôî
;

397 } 
	tVDOA˘i⁄D©a
;

407 
	$öôülizeVDOA˘i⁄D©a
(
VDOA˘i⁄D©a
 *
d©a
,

408 
VDOA˘i⁄
 *
a˘i⁄
,

409 
VDOCom∂ëi⁄
 *
vdoCom∂ëi⁄
)

411 *
d©a
 = (
VDOA˘i⁄D©a
) {

412 .
a˘i⁄
 =áction,

413 .
vdoCom∂ëi⁄
 = vdoCompletion,

415 
	}
}

422 
	$föishVDOA˘i⁄
(
VDOCom∂ëi⁄
 *
vdoCom∂ëi⁄
)

424 
SyncQueueW‹k
 *
w‹k
 = 
vdoCom∂ëi⁄
->
∑ª¡
;

425 
	`com∂ëe
(
w‹k
->
com∂ëi⁄
);

426 
	}
}

437 
	$≥rf‹mVDOA˘i⁄W‹k
(
KvdoW‹kIãm
 *
ôem
)

439 
SyncQueueW‹k
 *
w‹k
 = 
	`c⁄èöî_of
(
ôem
, SyncQueueW‹k, 
w‹kIãm
);

440 
VDOA˘i⁄D©a
 *
d©a
 = 
w‹k
->data;

441 
ThªadID
 
id
 = 
	`gëPhysiˇlLayî
()->
	`gëCuºítThªadID
();

443 
	`£tCÆlbackWôhP¨ít
(
d©a
->
vdoCom∂ëi⁄
, 
föishVDOA˘i⁄
, 
id
, 
w‹k
);

444 
d©a
->
	`a˘i⁄
(d©a->
vdoCom∂ëi⁄
);

445 
	}
}

448 
	$≥rf‹mKVDOExãndedComm™d
(
KVDO
 *
kvdo
, 
¨gc
, **
¨gv
)

450 
VDOA˘i⁄D©a
 
d©a
;

451 
VDOComm™dCom∂ëi⁄
 
cmd
;

453 
ªsu…
 = 
	`öôülizeVDOComm™dCom∂ëi⁄
(&
cmd
, 
	`gëVDO
(
kvdo
), 
¨gc
, 
¨gv
);

454 i‡(
ªsu…
 !
VDO_SUCCESS
) {

455  
ªsu…
;

458 
	`öôülizeVDOA˘i⁄D©a
(&
d©a
, 
execuãVDOExãndedComm™d
, &
cmd
.
com∂ëi⁄
);

459 
	`≥rf‹mKVDOO≥øti⁄
(
kvdo
, 
≥rf‹mVDOA˘i⁄W‹k
, &
d©a
,

460 
	`gëAdmöThªad
(
	`gëThªadC⁄fig
(
kvdo
->
vdo
)),

461 &
d©a
.
waôî
);

463  
	`de°royVDOComm™dCom∂ëi⁄
(&
cmd
);

464 
	}
}

467 
	$hóπbótCÆlback
(
HóπbótD©a
 *
hóπbót
, 
ThªadID
 
thªadID
)

469 
KVDOThªad
 *
thªad
 = 
	`c⁄èöî_of
(
hóπbót
, KVDOThread, heartbeat);

470 
	`bót
(
thªad
->
kvdo
->
vdo
, 
thªadID
);

471 
	}
}

474 
	$dumpKVDOSètus
(
KVDO
 *
kvdo
)

476 
	`dumpVDOSètus
(
kvdo
->
vdo
);

477 
	}
}

480 
boﬁ
 
	$gëKVDOCom¥essög
(
KVDO
 *
kvdo
)

482  
	`gëVDOCom¥essög
(
kvdo
->
vdo
);

483 
	}
}

486 
	$kvdoPª∑ªToGrowPhysiˇl
(
KVDO
 *
kvdo
, 
BlockCou¡
 
physiˇlCou¡
)

488 
VDO
 *
vdo
 = 
kvdo
->vdo;

489  
	`¥ï¨eToGrowPhysiˇl
(
vdo
, 
physiˇlCou¡
);

490 
	}
}

493 
	$kvdoResizePhysiˇl
(
KVDO
 *
kvdo
, 
BlockCou¡
 
physiˇlCou¡
)

495 
Kî√lLayî
 *
œyî
 = 
	`c⁄èöî_of
(
kvdo
, KernelLayer, kvdo);

496 
	`öô_com∂ëi⁄
(&
œyî
->
ˇŒbackSync
);

497 
ªsu…
 = 
	`≥rf‹mGrowPhysiˇl
(
kvdo
->
vdo
, 
physiˇlCou¡
);

498 i‡(
ªsu…
 !
VDO_SUCCESS
) {

499 
	`logEº‹
("ªsizê›î©i⁄ faûed,Ñesu… = %d", 
ªsu…
);

500  
ªsu…
;

503  
VDO_SUCCESS
;

504 
	}
}

507 
	$kvdoPª∑ªToGrowLogiˇl
(
KVDO
 *
kvdo
, 
BlockCou¡
 
logiˇlCou¡
)

509 
VDO
 *
vdo
 = 
kvdo
->vdo;

510  
	`¥ï¨eToGrowLogiˇl
(
vdo
, 
logiˇlCou¡
);

511 
	}
}

514 
	$kvdoResizeLogiˇl
(
KVDO
 *
kvdo
, 
BlockCou¡
 
logiˇlCou¡
)

516 
Kî√lLayî
 *
œyî
 = 
	`c⁄èöî_of
(
kvdo
, KernelLayer, kvdo);

517 
	`öô_com∂ëi⁄
(&
œyî
->
ˇŒbackSync
);

518 
ªsu…
 = 
	`≥rf‹mGrowLogiˇl
(
kvdo
->
vdo
, 
logiˇlCou¡
);

519 i‡(
ªsu…
 !
VDO_SUCCESS
) {

520 
	`logEº‹
("growÜogiˇ»›î©i⁄ faûed,Ñesu… = %d", 
ªsu…
);

523  
ªsu…
;

524 
	}
}

527 
WrôePﬁicy
 
	$gëKVDOWrôePﬁicy
(
KVDO
 *
kvdo
)

529  
	`gëWrôePﬁicy
(
kvdo
->
vdo
);

530 
	}
}

533 
	$íqueueKVDOThªadW‹k
(
KVDOThªad
 *
thªad
,

534 
KvdoW‹kIãm
 *
ôem
)

536 
	`íqueueW‹kQueue
(
thªad
->
ªque°Queue
, 
ôem
);

537 
	}
}

540 
	$íqueueKVDOThªadW‹kDñayed
(
KVDOThªad
 *
thªad
,

541 
KvdoW‹kIãm
 *
ôem
,

542 
Jiffõs
 
executi⁄Time
)

544 
	`íqueueW‹kQueueDñayed
(
thªad
->
ªque°Queue
, 
ôem
, 
executi⁄Time
);

545 
	}
}

548 
	$íqueueKVDOW‹k
(
KVDO
 *
kvdo
, 
KvdoW‹kIãm
 *
ôem
, 
ThªadID
 
thªadID
)

550 
	`íqueueKVDOThªadW‹k
(&
kvdo
->
thªads
[
thªadID
], 
ôem
);

551 
	}
}

554 
	$íqueueKVIO
(
KVIO
 *
kvio
,

555 
KvdoW‹kFun˘i⁄
 
w‹k
,

556 *
°©sFun˘i⁄
,

557 
a˘i⁄
)

559 
ThªadID
 
thªadID
 = 
	`vioAsCom∂ëi⁄
(
kvio
->
vio
)->
ˇŒbackThªadID
;

560 
	`BUG_ON
(
thªadID
 < 0);

561 
	`BUG_ON
(
thªadID
 >
kvio
->
œyî
->
kvdo
.
öôülizedThªadCou¡
);

562 
	`œunchKVIO
(
kvio
, 
w‹k
, 
°©sFun˘i⁄
, 
a˘i⁄
,

563 
kvio
->
œyî
->
kvdo
.
thªads
[
thªadID
].
ªque°Queue
);

564 
	}
}

567 
	$kvdoEnqueueW‹k
(
KvdoW‹kIãm
 *
w‹kIãm
)

569 
KvdoEnqueuóbÀ
 *
kvdoEnqueuóbÀ
 = 
	`c⁄èöî_of
(
w‹kIãm
,

570 
KvdoEnqueuóbÀ
,

571 
w‹kIãm
);

572 
	`runCÆlback
(
kvdoEnqueuóbÀ
->
íqueuóbÀ
.
com∂ëi⁄
);

573 
	}
}

576 
	$kvdoEnqueue
(
EnqueuóbÀ
 *
íqueuóbÀ
)

578 
KvdoEnqueuóbÀ
 *
kvdoEnqueuóbÀ
 = 
	`c⁄èöî_of
(
íqueuóbÀ
,

579 
KvdoEnqueuóbÀ
,

580 
íqueuóbÀ
);

581 
Kî√lLayî
 *
œyî
 = 
	`asKî√lLayî
(
íqueuóbÀ
->
com∂ëi⁄
->layer);

582 
ThªadID
 
thªadID
 = 
íqueuóbÀ
->
com∂ëi⁄
->
ˇŒbackThªadID
;

583 i‡(
	`ASSERT
(
thªadID
 < 
œyî
->
kvdo
.
öôülizedThªadCou¡
,

585 
thªadID
, 
íqueuóbÀ
->
com∂ëi⁄
->
ty≥
,

586 
œyî
->
kvdo
.
öôülizedThªadCou¡
Ë!
UDS_SUCCESS
) {

587 
	`BUG
();

590 i‡(
íqueuóbÀ
->
com∂ëi⁄
->
ty≥
 =
VIO_COMPLETION
) {

591 
	`vioAddTø˚Rec‹d
(
	`asVIO
(
íqueuóbÀ
->
com∂ëi⁄
),

592 
	`THIS_LOCATION
("$F($cb)"));

594 
	`£tupW‹kIãm
(&
kvdoEnqueuóbÀ
->
w‹kIãm
, 
kvdoEnqueueW‹k
,

595 (
KvdoW‹kFun˘i⁄
Ë
íqueuóbÀ
->
com∂ëi⁄
->
ˇŒback
,

596 
REQ_Q_ACTION_COMPLETION
);

597 
	`íqueueKVDOThªadW‹k
(&
œyî
->
kvdo
.
thªads
[
thªadID
],

598 &
kvdoEnqueuóbÀ
->
w‹kIãm
);

599 
	}
}

602 
ThªadID
 
	$kvdoGëCuºítThªadID
()

604 
KVDOThªad
 *
thªad
 = 
	`gëW‹kQueuePriv©eD©a
();

605 i‡(
thªad
 =
NULL
) {

606  
INVALID_THREAD_ID
;

609 
ThªadID
 
thªadID
 = 
thªad
->threadID;

610 i‡(
PARANOID_THREAD_CONSISTENCY_CHECKS
) {

611 
KVDO
 *
kvdo
 = 
thªad
->kvdo;

612 
Kî√lLayî
 *
kî√lLayî
 = 
	`asKî√lLayî
(
	`gëPhysiˇlLayî
());

613 
	`BUG_ON
(&
kî√lLayî
->
kvdo
 != kvdo);

614 
	`BUG_ON
(
thªadID
 >
kvdo
->
öôülizedThªadCou¡
);

615 
	`BUG_ON
(
thªad
 !&
kvdo
->
thªads
[
thªadID
]);

617  
thªadID
;

618 
	}
}

621 
PhysiˇlLayî
 *
	$gëKî√lPhysiˇlLayî
()

623 
KVDOThªad
 *
thªad
 = 
	`gëW‹kQueuePriv©eD©a
();

624 i‡(
thªad
 =
NULL
) {

625  
NULL
;

627 
KVDO
 *
kvdo
 = 
thªad
->kvdo;

628 
Kî√lLayî
 *
œyî
 = 
	`c⁄èöî_of
(
kvdo
, KernelLayer, kvdo);

629  &
œyî
->
comm⁄
;

630 
	}
}

632 
	$öôKî√lVDOOn˚
()

634 
	`ªgi°îPhysiˇlLayîGëãr
(
gëKî√lPhysiˇlLayî
);

635 
	}
}

	@vdo/kernel/kernelVDO.h

22 #i‚de‡
KERNEL_VDO_H


23 
	#KERNEL_VDO_H


	)

25 
	~"com∂ëi⁄.h
"

26 
	~"hóπbót.h
"

27 
	~"kî√lTy≥s.h
"

28 
	~"thªadRegi°ry.h
"

31 
KVDO
 *
	mkvdo
;

32 
ThªadID
 
	mthªadID
;

33 
KvdoW‹kQueue
 *
	mªque°Queue
;

34 
Regi°îedThªad
 
	mÆloˇtögThªad
;

37 
HóπbótD©a
 
	mhóπbót
;

38 
com∂ëi⁄
 
	mhóπbótWaô
;

39 } 
	tKVDOThªad
;

41 
	skvdo
 {

42 
KVDOThªad
 *
	mthªads
;

43 
ThªadID
 
	möôülizedThªadCou¡
;

44 
KvdoW‹kIãm
 
	mw‹kIãm
;

45 
VDOA˘i⁄
 *
	ma˘i⁄
;

46 
VDOCom∂ëi⁄
 *
	mcom∂ëi⁄
;

48 
VDO
 *
	mvdo
;

50 
boﬁ
 
	mhóπsBótög
;

53 
	eªqQA˘i⁄
 {

54 
	mREQ_Q_ACTION_COMPLETION
,

55 
	mREQ_Q_ACTION_FLUSH
,

56 
	mREQ_Q_ACTION_HEARTBEAT
,

57 
	mREQ_Q_ACTION_MAP_BIO
,

58 
	mREQ_Q_ACTION_SHUTDOWN
,

59 
	mREQ_Q_ACTION_SYNC
,

60 
	mREQ_Q_ACTION_VIO_CALLBACK


61 } 
	tReqQA˘i⁄
;

72 
öôülizeKVDO
(
KVDO
 *
kvdo
,

73 c⁄° 
ThªadC⁄fig
 *
thªadC⁄fig
,

74 **
ªas⁄
);

87 
°¨tKVDO
(
KVDO
 *
kvdo
,

88 
PhysiˇlLayî
 *
comm⁄
,

89 c⁄° 
VDOLﬂdC⁄fig
 *
lﬂdC⁄fig
,

90 
boﬁ
 
vioTø˚Rec‹dög
,

91 **
ªas⁄
);

100 
°›KVDO
(
KVDO
 *
kvdo
);

108 
föishKVDO
(
KVDO
 *
kvdo
);

116 
de°royKVDO
(
KVDO
 *
kvdo
);

123 
su•ídKVDO
(
KVDO
 *
kvdo
);

130 
ªsumeKVDO
(
KVDO
 *
kvdo
);

139 
dumpKVDOW‹kQueue
(
KVDO
 *
kvdo
);

148 
ölöe
 
VDO
 *
	$gëVDO
(
KVDO
 *
kvdo
)

150  
kvdo
->
vdo
;

151 
	}
}

161 
boﬁ
 
£tKVDOCom¥essög
(
KVDO
 *
kvdo
, boﬁ 
íabÀCom¥essi⁄
);

170 
boﬁ
 
gëKVDOCom¥essög
(
KVDO
 *
kvdo
);

178 
gëKVDOSèti°ics
(
KVDO
 *
kvdo
, 
VDOSèti°ics
 *
°©s
);

187 
WrôePﬁicy
 
gëKVDOWrôePﬁicy
(
KVDO
 *
kvdo
);

194 
dumpKVDOSètus
(
KVDO
 *
kvdo
);

204 
kvdoPª∑ªToGrowPhysiˇl
(
KVDO
 *
kvdo
, 
BlockCou¡
 
physiˇlCou¡
);

214 
kvdoResizePhysiˇl
(
KVDO
 *
kvdo
, 
BlockCou¡
 
physiˇlCou¡
);

224 
kvdoPª∑ªToGrowLogiˇl
(
KVDO
 *
kvdo
, 
BlockCou¡
 
logiˇlCou¡
);

234 
kvdoResizeLogiˇl
(
KVDO
 *
kvdo
, 
BlockCou¡
 
logiˇlCou¡
);

246 
≥rf‹mKVDOExãndedComm™d
(
KVDO
 *
kvdo
, 
¨gc
, **
¨gv
);

255 
íqueueKVDOW‹k
(
KVDO
 *
kvdo
, 
KvdoW‹kIãm
 *
ôem
, 
ThªadID
 
thªadID
);

266 
íqueueKVIO
(
KVIO
 *
kvio
,

267 
KvdoW‹kFun˘i⁄
 
w‹k
,

268 *
°©sFun˘i⁄
,

269 
a˘i⁄
);

277 
kvdoEnqueue
(
EnqueuóbÀ
 *
íqueuóbÀ
);

285 
ThªadID
 
kvdoGëCuºítThªadID
();

290 
öôKî√lVDOOn˚
();

	@vdo/kernel/kernelVDOInternals.h

22 #i‚de‡
KERNEL_VDO_INTERNALS_H


23 
	#KERNEL_VDO_INTERNALS_H


	)

25 
	~"kî√lVDO.h
"

34 
íqueueKVDOThªadW‹k
(
KVDOThªad
 *
thªad
, 
KvdoW‹kIãm
 *
ôem
);

46 
íqueueKVDOThªadW‹kDñayed
(
KVDOThªad
 *
thªad
,

47 
KvdoW‹kIãm
 *
ôem
,

48 
Jiffõs
 
executi⁄Time
);

	@vdo/kernel/ktrace.c

22 
	~"kåa˚.h
"

24 
	~"mem‹yAŒoc.h
"

26 
	~"d©aVIO.h
"

28 
	~"kvio.h
"

29 
	~"loggî.h
"

34 
	mTRACE_LOG_MAX
 = 820,

37 
	mTRACE_SAMPLE_INTERVAL
 = 3,

40 
boﬁ
 
	gåa˚Rec‹dög
 = 
Ál£
;

43 
	mbuf„r
[2000];

44 
	mcou¡î
;

45 
muãx
 
	mlock
;

46 } 
	gåa˚LoggögSèã
;

54 
	$öôülizeSam∂eCou¡î
(
Sam∂eCou¡î
 *
cou¡î
,

55 
öãrvÆ
)

57 
	`•ö_lock_öô
(&
cou¡î
->
lock
);

58 
cou¡î
->
tick
 = 0;

59 
cou¡î
->
öãrvÆ
 = interval;

60 
	}
}

63 
boﬁ
 
	$ßm∂eThisO√
(
Sam∂eCou¡î
 *
cou¡î
)

65 
boﬁ
 
w™tTøcög
 = 
Ál£
;

66 
	`•ö_lock
(&
cou¡î
->
lock
);

67 
cou¡î
->
tick
++;

68 i‡(
cou¡î
->
tick
 >cou¡î->
öãrvÆ
) {

69 
cou¡î
->
tick
 = 0;

70 
w™tTøcög
 = 
åue
;

72 
	`•ö_u∆ock
(&
cou¡î
->
lock
);

73  
w™tTøcög
;

74 
	}
}

77 
	$‰ìTø˚D©aBuf„r
(*
poﬁD©a
, *
d©a
)

79 
Tø˚
 *
åa˚
 = (Tø˚ *Ë
d©a
;

80 
	`FREE
(
åa˚
);

81 
	}
}

84 
	$ÆlocTø˚D©aBuf„r
(*
poﬁD©a
, **
d©aPå
)

86 
Tø˚
 *
åa˚
;

87 
ªsu…
 = 
	`ALLOCATE
(1, 
Tø˚
, 
__func__
, &
åa˚
);

88 i‡(
ªsu…
 !
VDO_SUCCESS
) {

89 
	`logEº‹
("åa˚ d©®Æloˇti⁄ faûuª %d", 
ªsu…
);

90  
ªsu…
;

93 *
d©aPå
 = 
åa˚
;

94  
VDO_SUCCESS
;

95 
	}
}

98 
	$ÆlocTø˚FromPoﬁ
(
Kî√lLayî
 *
œyî
, 
Tø˚
 **
åa˚Poöãr
)

100 
ªsu…
 = 
	`ÆlocBuf„rFromPoﬁ
(
œyî
->
åa˚Buf„rPoﬁ
,

101 (**Ë
åa˚Poöãr
);

102 i‡(
ªsu…
 =
VDO_SUCCESS
) {

103 (*
åa˚Poöãr
)->
u£d
 = 0;

105  
ªsu…
;

106 
	}
}

109 
	$‰ìTø˚ToPoﬁ
(
Kî√lLayî
 *
œyî
, 
Tø˚
 *
åa˚
)

111 
	`‰ìBuf„rToPoﬁ
(
œyî
->
åa˚Buf„rPoﬁ
, 
åa˚
);

112 
	}
}

115 
	$åa˚Kî√lLayîInô
(
Kî√lLayî
 *
œyî
)

117 
œyî
->
vioTø˚Rec‹dög
 = 
åa˚Rec‹dög
;

118 
	`öôülizeSam∂eCou¡î
(&
œyî
->
åa˚Sam∂eCou¡î
, 
TRACE_SAMPLE_INTERVAL
);

119 
åa˚Rec‹dsNìded
 = 0;

120 i‡(
œyî
->
vioTø˚Rec‹dög
) {

121 
åa˚Rec‹dsNìded
 +
œyî
->
ªque°Limôî
.
limô
;

123 i‡(
åa˚Rec‹dsNìded
 > 0) {

124  
	`makeBuf„rPoﬁ
("KVDO Tø˚ D©®Poﬁ", 
åa˚Rec‹dsNìded
,

125 
ÆlocTø˚D©aBuf„r
, 
‰ìTø˚D©aBuf„r
, 
NULL
,

126 
œyî
, &œyî->
åa˚Buf„rPoﬁ
);

128  
VDO_SUCCESS
;

129 
	}
}

132 
	$öôülizeTø˚LoggögOn˚
()

134 
	`muãx_öô
(&
åa˚LoggögSèã
.
lock
);

135 
	}
}

138 
	$logKvioTø˚
(
KVIO
 *
kvio
)

140 
Kî√lLayî
 *
œyî
 = 
kvio
->layer;

142 
	`muãx_lock
(&
åa˚LoggögSèã
.
lock
);

143 
åa˚LoggögSèã
.
cou¡î
++;

148 i‡(
œyî
->
åa˚Loggög
 && ((
åa˚LoggögSèã
.
cou¡î
 % 1024) == 37)) {

149 
	`kvioAddTø˚Rec‹d
(
kvio
, 
	`THIS_LOCATION
(
NULL
));

150 
size_t
 
åa˚Lí
 = 0;

151 
	`f‹m©Tø˚
(
kvio
->
vio
->
åa˚
, 
åa˚LoggögSèã
.
buf„r
,

152 (
åa˚LoggögSèã
.
buf„r
), &
åa˚Lí
);

154 i‡(
	`isMëad©a
(
kvio
)) {

155 
	`logInfo
("finishing kvio %s meta @%p %s",

156 (
	`isWrôeVIO
(
kvio
->
vio
) ? "read" : "write"),

157 
kvio
, 
åa˚LoggögSèã
.
buf„r
);

158 } i‡(
	`isCom¥es£dWrôî
(
kvio
)) {

159 
	`logInfo
("finishing kvio write comp @%p %s",

160 
kvio
, 
åa˚LoggögSèã
.
buf„r
);

162 c⁄° *
du≥Labñ
 = "";

163 i‡(
	`isWrôeVIO
(
kvio
->
vio
)) {

164 
D©aVIO
 *
d©aVIO
 = 
	`vioAsD©aVIO
(
kvio
->
vio
);

165 i‡(
	`isTrimD©aVIO
(
d©aVIO
)) {

166 
du≥Labñ
 = "trim ";

167 } i‡(
d©aVIO
->
isZîoBlock
) {

168 
du≥Labñ
 = "zero ";

169 } i‡(
d©aVIO
->
isDu∂iˇã
) {

170 
du≥Labñ
 = "dupe ";

172 
du≥Labñ
 = "new ";

176 
	`logInfo
("finishing kvio %s data %s@%p %.*s",

177 (
	`isWrôeVIO
(
kvio
->
vio
) ? "read" : "write"),

178 
du≥Labñ
, 
kvio
, 
TRACE_LOG_MAX
, 
åa˚LoggögSèã
.
buf„r
);

179 *
buf
 = 
åa˚LoggögSèã
.
buf„r
;

180 
åa˚Lí
 > 
TRACE_LOG_MAX
) {

181 
åa˚Lí
 -
TRACE_LOG_MAX
;

182 
buf
 +
TRACE_LOG_MAX
;

183 
	`logInfo
("m‹êkviÿ%∞∑th: %.*s", 
kvio
, 
TRACE_LOG_MAX
, 
buf
);

188 
	`muãx_u∆ock
(&
åa˚LoggögSèã
.
lock
);

189 
	}
}

	@vdo/kernel/ktrace.h

22 #i‚de‡
KTRACE_H


23 
	#KTRACE_H


	)

25 
	~<löux/devi˚-m≠≥r.h
>

27 
	~"comm⁄.h
"

28 
	~"åa˚.h
"

30 
	gkî√lLayî
;

31 
	gkvio
;

35 
	möãrvÆ
;

36 
	mtick
;

37 
•ölock_t
 
	mlock
;

38 } 
	tSam∂eCou¡î
;

43 
boﬁ
 
åa˚Rec‹dög
;

53 
boﬁ
 
ßm∂eThisO√
(
Sam∂eCou¡î
 *
cou¡î
);

62 
åa˚Kî√lLayîInô
(
kî√lLayî
 *
œyî
);

67 
öôülizeTø˚LoggögOn˚
();

77 
ÆlocTø˚FromPoﬁ
(
kî√lLayî
 *
œyî
, 
Tø˚
 **
åa˚Poöãr
);

85 
‰ìTø˚ToPoﬁ
(
kî√lLayî
 *
œyî
, 
Tø˚
 *
åa˚
);

92 
logKvioTø˚
(
kvio
 *kvio);

	@vdo/kernel/kvdoFlush.c

22 
	~"kvdoFlush.h
"

24 
	~"loggî.h
"

25 
	~"mem‹yAŒoc.h
"

27 
	~"thªadC⁄fig.h
"

29 
	~"bio.h
"

30 
	~"ioSubmôãr.h
"

45 
	skvdoFlush
 {

46 
KvdoW‹kIãm
 
	mw‹kIãm
;

47 
Kî√lLayî
 *
	mœyî
;

48 
bio_li°
 
	mbios
;

49 
Jiffõs
 
	m¨rivÆTime
;

50 
VDOFlush
 
	mvdoFlush
;

54 
	$makeKVDOFlush
(
KVDOFlush
 **
ÊushPå
)

56  
	`ALLOCATE
(1, 
KVDOFlush
, 
__func__
, 
ÊushPå
);

57 
	}
}

60 
boﬁ
 
	$shouldPro˚ssFlush
(
Kî√lLayî
 *
œyî
)

62  (
	`gëKVDOWrôePﬁicy
(&
œyî
->
kvdo
Ë=
WRITE_POLICY_ASYNC
);

63 
	}
}

70 
	$kvdoFlushW‹k
(
KvdoW‹kIãm
 *
ôem
)

72 
KVDOFlush
 *
kvdoFlush
 = 
	`c⁄èöî_of
(
ôem
, KVDOFlush, 
w‹kIãm
);

73 
	`Êush
(
kvdoFlush
->
œyî
->
kvdo
.
vdo
, &kvdoFlush->
vdoFlush
);

74 
	}
}

84 
	$öôülizeKVDOFlush
(
KVDOFlush
 *
kvdoFlush
, 
Kî√lLayî
 *
œyî
)

86 
kvdoFlush
->
œyî
 =Üayer;

87 
	`bio_li°_öô
(&
kvdoFlush
->
bios
);

88 
	`bio_li°_mîge
(&
kvdoFlush
->
bios
, &
œyî
->
waôögFlushes
);

89 
	`bio_li°_öô
(&
œyî
->
waôögFlushes
);

90 
kvdoFlush
->
¨rivÆTime
 = 
œyî
->
ÊushAºivÆTime
;

91 
	}
}

94 
	$íqueueKVDOFlush
(
KVDOFlush
 *
kvdoFlush
)

96 
	`£tupW‹kIãm
(&
kvdoFlush
->
w‹kIãm
, 
kvdoFlushW‹k
, 
NULL
, 
REQ_Q_ACTION_FLUSH
);

97 
KVDO
 *
kvdo
 = &
kvdoFlush
->
œyî
->kvdo;

98 
	`íqueueKVDOW‹k
(
kvdo
, &
kvdoFlush
->
w‹kIãm
,

99 
	`gëPackîZ⁄eThªad
(
	`gëThªadC⁄fig
(
kvdo
->
vdo
)));

100 
	}
}

103 
	$œunchKVDOFlush
(
Kî√lLayî
 *
œyî
, 
BIO
 *
bio
)

107 
KVDOFlush
 *
kvdoFlush
 = 
	`kzÆloc
((KVDOFlush), 
GFP_NOWAIT
);

109 
	`•ö_lock
(&
œyî
->
ÊushLock
);

113 i‡(
	`bio_li°_em±y
(&
œyî
->
waôögFlushes
)) {

114 
œyî
->
ÊushAºivÆTime
 = 
jiffõs
;

116 
	`bio_li°_add
(&
œyî
->
waôögFlushes
, 
bio
);

118 i‡(
kvdoFlush
 =
NULL
) {

120 i‡(
œyî
->
•¨eKVDOFlush
 =
NULL
) {

123 
	`•ö_u∆ock
(&
œyî
->
ÊushLock
);

128 
kvdoFlush
 = 
œyî
->
•¨eKVDOFlush
;

129 
œyî
->
•¨eKVDOFlush
 = 
NULL
;

133 
	`öôülizeKVDOFlush
(
kvdoFlush
, 
œyî
);

135 
	`•ö_u∆ock
(&
œyî
->
ÊushLock
);

138 
	`íqueueKVDOFlush
(
kvdoFlush
);

139 
	}
}

150 
	$ªÀa£KVDOFlush
(
KVDOFlush
 *
kvdoFlush
)

152 
Kî√lLayî
 *
œyî
 = 
kvdoFlush
->layer;

153 
boﬁ
 
ªœunchFlush
 = 
Ál£
;

154 
boﬁ
 
‰ìFlush
 = 
Ál£
;

156 
	`•ö_lock
(&
œyî
->
ÊushLock
);

157 i‡(
	`bio_li°_em±y
(&
œyî
->
waôögFlushes
)) {

159 i‡(
œyî
->
•¨eKVDOFlush
 =
NULL
) {

161 
	`mem£t
(
kvdoFlush
, 0, (*kvdoFlush));

162 
œyî
->
•¨eKVDOFlush
 = 
kvdoFlush
;

164 
‰ìFlush
 = 
åue
;

168 
	`öôülizeKVDOFlush
(
kvdoFlush
, 
œyî
);

169 
ªœunchFlush
 = 
åue
;

171 
	`•ö_u∆ock
(&
œyî
->
ÊushLock
);

173 i‡(
ªœunchFlush
) {

175 
	`íqueueKVDOFlush
(
kvdoFlush
);

176 } i‡(
‰ìFlush
) {

177 
	`k‰ì
(
kvdoFlush
);

179 
	}
}

186 
	$kvdoCom∂ëeFlushW‹k
(
KvdoW‹kIãm
 *
ôem
)

188 
KVDOFlush
 *
kvdoFlush
 = 
	`c⁄èöî_of
(
ôem
, KVDOFlush, 
w‹kIãm
);

189 
Kî√lLayî
 *
œyî
 = 
kvdoFlush
->layer;

191 
BIO
 *
bio
;

192 (
bio
 = 
	`bio_li°_p›
(&
kvdoFlush
->
bios
)Ë!
NULL
) {

193 
	`£tBioBlockDevi˚
(
bio
, 
œyî
->
dev
->
bdev
);

197 
	`cou¡Bios
(&
œyî
->
biosAcknowÀdged
, 
bio
);

201 i‡(!
	`isEm±yFlush
(
bio
)) {

202 #i‡
LINUX_VERSION_CODE
 >
	`KERNEL_VERSION
(4,10,0)

203 
	`bio_£t_›_©ås
(
bio
, 0, 
REQ_PREFLUSH
);

204 #ñi‡
LINUX_VERSION_CODE
 >
	`KERNEL_VERSION
(4,8,0)

205 
bio
->
bi_›f
 = 
WRITE_FLUSH
;

207 
bio
->
bi_rw
 = 
WRITE_FLUSH
;

210 
	`©omic64_öc
(&
œyî
->
ÊushOut
);

211 
	`gíîic_make_ªque°
(
bio
);

217 
	`ªÀa£KVDOFlush
(
kvdoFlush
);

218 
	}
}

221 
	$kvdoCom∂ëeFlush
(
VDOFlush
 **
kÂ
)

223 i‡(*
kÂ
 !
NULL
) {

224 
KVDOFlush
 *
kvdoFlush
 = 
	`c⁄èöî_of
(*
kÂ
, KVDOFlush, 
vdoFlush
);

225 
	`£tupW‹kIãm
(&
kvdoFlush
->
w‹kIãm
, 
kvdoCom∂ëeFlushW‹k
, 
NULL
,

226 
BIO_Q_ACTION_FLUSH
);

227 
	`íqueueBioW‹kIãm
(
kvdoFlush
->
œyî
->
ioSubmôãr
,

228 &
kvdoFlush
->
w‹kIãm
);

229 *
kÂ
 = 
NULL
;

231 
	}
}

233 #i‡
LINUX_VERSION_CODE
 >
KERNEL_VERSION
(4,4,0)

239 
	$ídSynchr⁄ousFlush
(
BIO
 *
bio
)

247 
	$ídSynchr⁄ousFlush
(
BIO
 *
bio
, 
ªsu…
)

250 #i‡
LINUX_VERSION_CODE
 >
	`KERNEL_VERSION
(4,13,0)

251 
ªsu…
 = 
bio
->
bi_°©us
;

252 #ñi‡
LINUX_VERSION_CODE
 >
	`KERNEL_VERSION
(4,4,0)

253 
ªsu…
 = 
bio
->
bi_îr‹
;

256 i‡(
ªsu…
 != 0) {

257 
	`logEº‹WôhSåögEº‹
(
ªsu…
, "synchronous flush failed");

258 #i‡
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(4,4,0)

259 
	`˛ór_bô
(
BIO_UPTODATE
, &
bio
->
bi_Êags
);

263 
Kî√lLayî
 *
œyî
 = 
bio
->
bi_¥iv©e
;

264 
	`©omic64_öc
(&
œyî
->
ÊushOut
);

265 
	`com∂ëe
(&
œyî
->
ÊushWaô
);

266 
	}
}

269 
	$synchr⁄ousFlush
(
Kî√lLayî
 *
œyî
)

271 
BIO
 *
bio
;

272 
ªsu…
 = 
	`¸óãBio
(
œyî
, 
NULL
, &
bio
);

273 i‡(
ªsu…
 !
VDO_SUCCESS
) {

274  
ªsu…
;

277 
	`öô_com∂ëi⁄
(&
œyî
->
ÊushWaô
);

278 
	`¥ï¨eFlushBIO
(
bio
, 
œyî
,Üayî->
dev
->
bdev
, 
ídSynchr⁄ousFlush
);

279 
bio
->
bi_√xt
 = 
NULL
;

280 
	`gíîic_make_ªque°
(
bio
);

281 
	`waô_f‹_com∂ëi⁄
(&
œyî
->
ÊushWaô
);

282 #i‡
LINUX_VERSION_CODE
 >
	`KERNEL_VERSION
(4,13,0)

283 i‡(
bio
->
bi_°©us
 != 0) {

284 #ñi‡
LINUX_VERSION_CODE
 >
	`KERNEL_VERSION
(4,4,0)

285 i‡(
bio
->
bi_îr‹
 != 0) {

287 i‡(!
	`bio_Êagged
(
bio
, 
BIO_UPTODATE
)) {

289 
ªsu…
 = -
EIO
;

292 
	`‰ìBio
(
bio
, 
œyî
);

293  
ªsu…
;

294 
	}
}

	@vdo/kernel/kvdoFlush.h

22 #i‚de‡
KVDO_FLUSH_H


23 
	#KVDO_FLUSH_H


	)

25 
	~"Êush.h
"

27 
	~"kî√lLayî.h
"

34 
makeKVDOFlush
(
KVDOFlush
 **
ÊushPå
);

45 
boﬁ
 
shouldPro˚ssFlush
(
Kî√lLayî
 *
œyî
);

55 
œunchKVDOFlush
(
Kî√lLayî
 *
œyî
, 
BIO
 *
bio
);

62 
kvdoCom∂ëeFlush
(
VDOFlush
 **
kÂ
);

71 
synchr⁄ousFlush
(
Kî√lLayî
 *
œyî
);

	@vdo/kernel/kvio.c

22 
	~"kvio.h
"

25 
	~"loggî.h
"

26 
	~"mem‹yAŒoc.h
"

28 
	~"numUtûs.h
"

29 
	~"vdo.h
"

30 
	~"waôQueue.h
"

32 
	~"bio.h
"

33 
	~"ioSubmôãr.h
"

34 
	~"kvdoFlush.h
"

35 
	~"ªadCache.h
"

43 
	$kvdoH™dÀVIOCÆlback
(
KvdoW‹kIãm
 *
ôem
)

45 
KVIO
 *
kvio
 = 
	`w‹kIãmAsKVIO
(
ôem
);

46 
	`runCÆlback
(
	`vioAsCom∂ëi⁄
(
kvio
->
vio
));

47 
	}
}

50 
	$kvdoEnqueueVIOCÆlback
(
KVIO
 *
kvio
)

52 
	`íqueueKVIO
(
kvio
, 
kvdoH™dÀVIOCÆlback
,

53 (
KvdoW‹kFun˘i⁄
Ë
	`vioAsCom∂ëi⁄
(
kvio
->
vio
)->
ˇŒback
,

54 
REQ_Q_ACTION_VIO_CALLBACK
);

55 
	}
}

58 
	$kvdoC⁄töueKvio
(
KVIO
 *
kvio
, 
îr‹
)

60 i‡(
	`u∆ikñy
(
îr‹
 !
VDO_SUCCESS
)) {

61 
	`£tCom∂ëi⁄Resu…
(
	`vioAsCom∂ëi⁄
(
kvio
->
vio
), 
îr‹
);

63 
	`kvdoEnqueueVIOCÆlback
(
kvio
);

64 
	}
}

68 
noölöe
 
	$maybeLogKvioTø˚
(
KVIO
 *
kvio
)

70 i‡(
kvio
->
œyî
->
åa˚Loggög
) {

71 
	`logKvioTø˚
(
kvio
);

73 
	}
}

76 
	$‰ìKVIO
(
KVIO
 **
kvioPå
)

78 
KVIO
 *
kvio
 = *
kvioPå
;

79 i‡(
kvio
 =
NULL
) {

83 i‡(
	`u∆ikñy
(
kvio
->
vio
->
åa˚
 !
NULL
)) {

84 
	`maybeLogKvioTø˚
(
kvio
);

85 
	`FREE
(
kvio
->
vio
->
åa˚
);

88 
	`‰ìBio
(
kvio
->
bio
, kvio->
œyî
);

89 
	`FREE
(
kvio
);

90 *
kvioPå
 = 
NULL
;

91 
	}
}

94 
	$‰ìMëad©aKVIO
(
Mëad©aKVIO
 **
mëad©aKVIOPå
)

96 
	`‰ìKVIO
((
KVIO
 **Ë
mëad©aKVIOPå
);

97 
	}
}

100 
	$‰ìCom¥es£dWrôeKVIO
(
Com¥es£dWrôeKVIO
 **
com¥es£dWrôeKVIOPå
)

102 
	`‰ìKVIO
((
KVIO
 **Ë
com¥es£dWrôeKVIOPå
);

103 
	}
}

106 
	$kvdoWrôeCom¥es£dBlock
(
AŒoˇtögVIO
 *
ÆloˇtögVIO
)

110 
Com¥es£dWrôeKVIO
 *
com¥es£dWrôeKVIO


111 
	`ÆloˇtögVIOAsCom¥es£dWrôeKVIO
(
ÆloˇtögVIO
);

112 
KVIO
 *
kvio
 = 
	`com¥es£dWrôeKVIOAsKVIO
(
com¥es£dWrôeKVIO
);

113 
BIO
 *
bio
 = 
kvio
->bio;

114 
	`ª£tBio
(
bio
, 
kvio
->
œyî
);

115 #i‡
LINUX_VERSION_CODE
 >
	`KERNEL_VERSION
(4,10,0)

116 
	`bio_£t_›_©ås
(
bio
, 
REQ_OP_WRITE
, 0);

117 #ñi‡
LINUX_VERSION_CODE
 >
	`KERNEL_VERSION
(4,8,0)

118 
bio
->
bi_›f
 = 
WRITE
;

120 
bio
->
bi_rw
 = 
WRITE
;

122 
	`£tBioSe˘‹
(
bio
, 
	`blockToSe˘‹
(
kvio
->
œyî
, kvio->
vio
->
physiˇl
));

123 
	`övÆid©eCacheAndSubmôBio
(
kvio
, 
BIO_Q_ACTION_COMPRESSED_DATA
);

124 
	}
}

133 
ölöe
 
BioQA˘i⁄
 
	$gëMëad©aA˘i⁄
(
VIO
 *
vio
)

135  ((
vio
->
¥i‹ôy
 =
VIO_PRIORITY_HIGH
)

136 ? 
BIO_Q_ACTION_HIGH
 : 
BIO_Q_ACTION_METADATA
);

137 
	}
}

140 
	$kvdoSubmôMëad©aVIO
(
VIO
 *
vio
)

142 
KVIO
 *
kvio
 = 
	`mëad©aKVIOAsKVIO
(
	`vioAsMëad©aKVIO
(
vio
));

143 
BIO
 *
bio
 = 
kvio
->bio;

144 
	`ª£tBio
(
bio
, 
kvio
->
œyî
);

146 i‡(
	`vioRequúesFlushA·î
(
vio
Ë&& 
	`shouldPro˚ssFlush
(
kvio
->
œyî
)) {

147 #i‡
LINUX_VERSION_CODE
 >
	`KERNEL_VERSION
(4,8,0)

148 
bio
->
bi_›f
 = 
	`bioFuaRWMask
();

150 
bio
->
bi_rw
 = 
	`bioFuaRWMask
();

153 
	`£tBioSe˘‹
(
bio
, 
	`blockToSe˘‹
(
kvio
->
œyî
, 
vio
->
physiˇl
));

156 i‡(
	`isRódVIO
(
vio
)) {

157 
	`ASSERT_LOG_ONLY
(!
	`vioRequúesFlushBef‹e
(
vio
),

159 
	`vioAddTø˚Rec‹d
(
vio
, 
	`THIS_LOCATION
("$F;io=readMeta"));

160 #i‡
LINUX_VERSION_CODE
 >
	`KERNEL_VERSION
(4,8,0)

161 
	`bio_£t_›_©ås
(
bio
, 
REQ_OP_READ
, 0);

163 
bio
->
bi_rw
 |
READ
;

165 } i‡(
	`vioRequúesFlushBef‹e
(
vio
Ë&& 
	`shouldPro˚ssFlush
(
kvio
->
œyî
)) {

166 #i‡
LINUX_VERSION_CODE
 >
	`KERNEL_VERSION
(4,10,0)

167 
	`bio_£t_›_©ås
(
bio
, 
REQ_OP_WRITE
, 
REQ_PREFLUSH
);

168 #ñi‡
LINUX_VERSION_CODE
 >
	`KERNEL_VERSION
(4,8,0)

169 
	`bio_£t_›_©ås
(
bio
, 
REQ_OP_WRITE
, 
WRITE_FLUSH
);

171 
bio
->
bi_rw
 |
WRITE_FLUSH
;

173 
	`vioAddTø˚Rec‹d
(
vio
, 
	`THIS_LOCATION
("$F;io=flushWriteMeta"));

175 #i‡
LINUX_VERSION_CODE
 >
	`KERNEL_VERSION
(4,8,0)

176 
	`bio_£t_›_©ås
(
bio
, 
REQ_OP_WRITE
, 0);

178 
bio
->
bi_rw
 |
WRITE
;

180 
	`vioAddTø˚Rec‹d
(
vio
, 
	`THIS_LOCATION
("$F;io=writeMeta"));

183 
	`submôBio
(
bio
, 
	`gëMëad©aA˘i⁄
(
vio
));

184 
	}
}

186 #i‡
LINUX_VERSION_CODE
 >
KERNEL_VERSION
(4,4,0)

193 
	$com∂ëeFlushBio
(
BIO
 *
bio
)

202 
	$com∂ëeFlushBio
(
BIO
 *
bio
, 
îr‹
)

205 
KVIO
 *
kvio
 = (KVIO *Ë
bio
->
bi_¥iv©e
;

208 
bio
->
bi_v˙t
 = 1;

210 
	`ª£tBio
(
bio
, 
kvio
->
œyî
);

211 #i‡
LINUX_VERSION_CODE
 >
	`KERNEL_VERSION
(4,13,0)

212 
	`kvdoC⁄töueKvio
(
kvio
, 
bio
->
bi_°©us
);

213 #ñi‡
LINUX_VERSION_CODE
 >
	`KERNEL_VERSION
(4,4,0)

214 
	`kvdoC⁄töueKvio
(
kvio
, 
bio
->
bi_îr‹
);

216 
	`kvdoC⁄töueKvio
(
kvio
, 
îr‹
);

218 
	}
}

221 
	$kvdoFlushVIO
(
VIO
 *
vio
)

223 
KVIO
 *
kvio
 = 
	`mëad©aKVIOAsKVIO
(
	`vioAsMëad©aKVIO
(
vio
));

224 
BIO
 *
bio
 = 
kvio
->bio;

225 
Kî√lLayî
 *
œyî
 = 
kvio
->layer;

226 
	`ª£tBio
(
bio
, 
œyî
);

227 
	`¥ï¨eFlushBIO
(
bio
, 
kvio
, 
œyî
->
dev
->
bdev
, 
com∂ëeFlushBio
);

228 
	`submôBio
(
bio
, 
	`gëMëad©aA˘i⁄
(
vio
));

229 
	}
}

249 
noölöe
 
boﬁ


250 
	$ßm∂eThisVIO
(
KVIO
 *
kvio
, 
Kî√lLayî
 *
œyî
, 
BIO
 *
bio
)

252 
boﬁ
 
ªsu…
 = 
åue
;

253 
__asm__
 
	`__vﬁ©ûe__
("nop"

254 : "=g" (
ªsu…
)

255 : "0" (
ªsu…
),

256 "g" (
kvio
),

257 "g" (
œyî
),

258 "g" (
bio
)

260  
ªsu…
;

261 
	}
}

264 
	$öôülizeKVIO
(
KVIO
 *
kvio
,

265 
Kî√lLayî
 *
œyî
,

266 
VIOTy≥
 
vioTy≥
,

267 
VIOPri‹ôy
 
¥i‹ôy
,

268 *
∑ª¡
,

269 
BIO
 *
bio
)

271 i‡(
œyî
->
vioTø˚Rec‹dög


272 && 
	`ßm∂eThisVIO
(
kvio
, 
œyî
, 
bio
)

273 && 
	`ßm∂eThisO√
(&
œyî
->
åa˚Sam∂eCou¡î
)) {

274 
ªsu…
 = (
	`isD©aVIOTy≥
(
vioTy≥
)

275 ? 
	`ÆlocTø˚FromPoﬁ
(
œyî
, &
kvio
->
vio
->
åa˚
)

276 : 
	`ALLOCATE
(1, 
Tø˚
, "åa˚", &
kvio
->
vio
->
åa˚
));

277 i‡(
ªsu…
 !
VDO_SUCCESS
) {

278 
	`logEº‹
("åa˚Ñec‹dáŒoˇti⁄ faûuª %d", 
ªsu…
);

282 
kvio
->
bio
 = bio;

283 
kvio
->
œyî
 =Üayer;

284 i‡(
bio
 !
NULL
) {

285 
bio
->
bi_¥iv©e
 = 
kvio
;

288 
	`öôülizeVIO
(
kvio
->
vio
, 
vioTy≥
, 
¥i‹ôy
, 
∑ª¡
, 
	`gëVDO
(&
œyî
->
kvdo
),

289 &
œyî
->
comm⁄
);

293 
	`kvioAddTø˚Rec‹d
(
kvio
, 
	`THIS_LOCATION
("$F;io=?init;j=normal"));

295 
VDOCom∂ëi⁄
 *
com∂ëi⁄
 = 
	`vioAsCom∂ëi⁄
(
kvio
->
vio
);

296 
kvio
->
íqueuóbÀ
.íqueuóbÀ.
com∂ëi⁄
 = completion;

297 
com∂ëi⁄
->
íqueuóbÀ
 = &
kvio
->enqueueable.enqueueable;

298 
	}
}

313 
__©åibuã__
((
w¨n_unu£d_ªsu…
))

314 
	$makeMëad©aKVIO
(
Kî√lLayî
 *
œyî
,

315 
VIOTy≥
 
vioTy≥
,

316 
VIOPri‹ôy
 
¥i‹ôy
,

317 *
∑ª¡
,

318 
BIO
 *
bio
,

319 
Mëad©aKVIO
 **
mëad©aKVIOPå
)

322 
	`STATIC_ASSERT
((
Mëad©aKVIO
) <= 256);

326 
Mëad©aKVIO
 *
mëad©aKVIO
;

327 
ªsu…
 = 
	`ALLOCATE
(1, 
Mëad©aKVIO
, 
__func__
, &
mëad©aKVIO
);

328 i‡(
ªsu…
 !
VDO_SUCCESS
) {

329 
	`logEº‹
("mëad©®KVIOáŒoˇti⁄ faûuª %d", 
ªsu…
);

330  
ªsu…
;

333 
KVIO
 *
kvio
 = &
mëad©aKVIO
->kvio;

334 
kvio
->
vio
 = &
mëad©aKVIO
->vio;

335 
	`öôülizeKVIO
(
kvio
, 
œyî
, 
vioTy≥
, 
¥i‹ôy
, 
∑ª¡
, 
bio
);

336 *
mëad©aKVIOPå
 = 
mëad©aKVIO
;

337  
VDO_SUCCESS
;

338 
	}
}

353 
__©åibuã__
((
w¨n_unu£d_ªsu…
))

355 
	$makeCom¥es£dWrôeKVIO
(
Kî√lLayî
 *
œyî
,

356 *
∑ª¡
,

357 
BIO
 *
bio
,

358 
Com¥es£dWrôeKVIO
 **
com¥es£dWrôeKVIOPå
)

362 
Com¥es£dWrôeKVIO
 *
com¥es£dWrôeKVIO
;

363 
ªsu…
 = 
	`ALLOCATE
(1, 
Com¥es£dWrôeKVIO
, 
__func__
,

364 &
com¥es£dWrôeKVIO
);

365 i‡(
ªsu…
 !
VDO_SUCCESS
) {

366 
	`logEº‹
("com¥es£d wrôêKVIOáŒoˇti⁄ faûuª %d", 
ªsu…
);

367  
ªsu…
;

370 
KVIO
 *
kvio
 = &
com¥es£dWrôeKVIO
->kvio;

371 
kvio
->
vio
 = 
	`ÆloˇtögVIOAsVIO
(&
com¥es£dWrôeKVIO
->
ÆloˇtögVIO
);

372 
	`öôülizeKVIO
(
kvio
, 
œyî
, 
VIO_TYPE_COMPRESSED_BLOCK
,

373 
VIO_PRIORITY_COMPRESSED_DATA
, 
∑ª¡
, 
bio
);

374 *
com¥es£dWrôeKVIOPå
 = 
com¥es£dWrôeKVIO
;

375  
VDO_SUCCESS
;

376 
	}
}

379 
	$kvdoCª©eMëad©aVIO
(
PhysiˇlLayî
 *
œyî
,

380 
VIOTy≥
 
vioTy≥
,

381 
VIOPri‹ôy
 
¥i‹ôy
,

382 *
∑ª¡
,

383 *
d©a
,

384 
VIO
 **
vioPå
)

386 
ªsu…
 = 
	`ASSERT
(
	`isMëad©aVIOTy≥
(
vioTy≥
),

387 "%d i†®mëad©®ty≥", 
vioTy≥
);

388 i‡(
ªsu…
 !
VDO_SUCCESS
) {

389  
ªsu…
;

392 
BIO
 *
bio
;

393 
Kî√lLayî
 *
kî√lLayî
 = 
	`asKî√lLayî
(
œyî
);

394 
ªsu…
 = 
	`¸óãBio
(
kî√lLayî
, 
d©a
, &
bio
);

395 i‡(
ªsu…
 !
VDO_SUCCESS
) {

396  
ªsu…
;

399 
Mëad©aKVIO
 *
mëad©aKVIO
;

400 
ªsu…
 = 
	`makeMëad©aKVIO
(
kî√lLayî
, 
vioTy≥
, 
¥i‹ôy
, 
∑ª¡
, 
bio
,

401 &
mëad©aKVIO
);

402 i‡(
ªsu…
 !
VDO_SUCCESS
) {

403 
	`‰ìBio
(
bio
, 
kî√lLayî
);

404  
ªsu…
;

407 *
vioPå
 = &
mëad©aKVIO
->
vio
;

408  
VDO_SUCCESS
;

409 
	}
}

412 
	$kvdoCª©eCom¥es£dWrôeVIO
(
PhysiˇlLayî
 *
œyî
,

413 *
∑ª¡
,

414 *
d©a
,

415 
AŒoˇtögVIO
 **
ÆloˇtögVIOPå
)

417 
BIO
 *
bio
;

418 
Kî√lLayî
 *
kî√lLayî
 = 
	`asKî√lLayî
(
œyî
);

419 
ªsu…
 = 
	`¸óãBio
(
kî√lLayî
, 
d©a
, &
bio
);

420 i‡(
ªsu…
 !
VDO_SUCCESS
) {

421  
ªsu…
;

424 
Com¥es£dWrôeKVIO
 *
com¥es£dWrôeKVIO
;

425 
ªsu…
 = 
	`makeCom¥es£dWrôeKVIO
(
kî√lLayî
, 
∑ª¡
, 
bio
,

426 &
com¥es£dWrôeKVIO
);

427 i‡(
ªsu…
 !
VDO_SUCCESS
) {

428 
	`‰ìBio
(
bio
, 
kî√lLayî
);

429  
ªsu…
;

432 *
ÆloˇtögVIOPå
 = &
com¥es£dWrôeKVIO
->
ÆloˇtögVIO
;

433  
VDO_SUCCESS
;

434 
	}
}

	@vdo/kernel/kvio.h

22 #i‚de‡
KVIO_H


23 
	#KVIO_H


	)

25 
	~"ÆloˇtögVIO.h
"

26 
	~"vio.h
"

28 
	~"kî√lLayî.h
"

33 
	skvio
 {

34 
KvdoEnqueuóbÀ
 
	míqueuóbÀ
;

35 
VIO
 *
	mvio
;

36 
Kî√lLayî
 *
	mœyî
;

37 
BIO
 *
	mbio
;

46 
BIO
 *
	mbioToSubmô
;

53 
bio_li°
 
	mbiosMîged
;

61 
KvdoW‹kFun˘i⁄
 
	mbioSubmissi⁄CÆlback
;

63 
	mdebugSlŸ
;

67 
KVIO
 
	mkvio
;

68 
VIO
 
	mvio
;

69 } 
	tMëad©aKVIO
;

72 
KVIO
 
	mkvio
;

73 
AŒoˇtögVIO
 
	mÆloˇtögVIO
;

74 } 
	tCom¥es£dWrôeKVIO
;

83 
ölöe
 
boﬁ
 
	$isD©a
(
KVIO
 *
kvio
)

85  
	`isD©aVIO
(
kvio
->
vio
);

86 
	}
}

95 
ölöe
 
boﬁ
 
	$isCom¥es£dWrôî
(
KVIO
 *
kvio
)

97  
	`isCom¥es£dWrôeVIO
(
kvio
->
vio
);

98 
	}
}

107 
ölöe
 
boﬁ
 
	$isMëad©a
(
KVIO
 *
kvio
)

109  
	`isMëad©aVIO
(
kvio
->
vio
);

110 
	}
}

119 
ölöe
 
Mëad©aKVIO
 *
	$vioAsMëad©aKVIO
(
VIO
 *
vio
)

121 
	`ASSERT_LOG_ONLY
(
	`isMëad©aVIO
(
vio
), "VIO isá metadata VIO");

122  
	`c⁄èöî_of
(
vio
, 
Mëad©aKVIO
, vio);

123 
	}
}

132 
ölöe
 
KVIO
 *
	$mëad©aKVIOAsKVIO
(
Mëad©aKVIO
 *
mëad©aKVIO
)

134  &
mëad©aKVIO
->
kvio
;

135 
	}
}

144 
ölöe
 
Com¥es£dWrôeKVIO
 *

145 
	$ÆloˇtögVIOAsCom¥es£dWrôeKVIO
(
AŒoˇtögVIO
 *
ÆloˇtögVIO
)

147 
	`ASSERT_LOG_ONLY
(
	`isCom¥es£dWrôeAŒoˇtögVIO
(
ÆloˇtögVIO
),

149  
	`c⁄èöî_of
(
ÆloˇtögVIO
, 
Com¥es£dWrôeKVIO
,állocatingVIO);

150 
	}
}

159 
ölöe


160 
KVIO
 *
	$com¥es£dWrôeKVIOAsKVIO
(
Com¥es£dWrôeKVIO
 *
com¥es£dWrôeKVIO
)

162  &
com¥es£dWrôeKVIO
->
kvio
;

163 
	}
}

172 
ölöe
 
KVIO
 *
	$w‹kIãmAsKVIO
(
KvdoW‹kIãm
 *
ôem
)

174  
	`c⁄èöî_of
(
ôem
, 
KVIO
, 
íqueuóbÀ
.
w‹kIãm
);

175 
	}
}

183 
ölöe
 
	$íqueueKVIOW‹k
(
KvdoW‹kQueue
 *
queue
, 
KVIO
 *
kvio
)

185 
	`íqueueW‹kQueue
(
queue
, &
kvio
->
íqueuóbÀ
.
w‹kIãm
);

186 
	}
}

194 
ölöe
 
	$kvioAddTø˚Rec‹d
(
KVIO
 *
kvio
, 
Tø˚Loˇti⁄
 
loˇti⁄
)

196 
	`vioAddTø˚Rec‹d
(
kvio
->
vio
, 
loˇti⁄
);

197 
	}
}

207 
ölöe
 
	$£tupKVIOW‹k
(
KVIO
 *
kvio
,

208 
KvdoW‹kFun˘i⁄
 
w‹k
,

209 *
°©sFun˘i⁄
,

210 
a˘i⁄
)

212 
	`£tupW‹kIãm
(&
kvio
->
íqueuóbÀ
.
w‹kIãm
, 
w‹k
, 
°©sFun˘i⁄
, 
a˘i⁄
);

213 
	}
}

224 
ölöe
 
	$œunchKVIO
(
KVIO
 *
kvio
,

225 
KvdoW‹kFun˘i⁄
 
w‹k
,

226 *
°©sFun˘i⁄
,

227 
a˘i⁄
,

228 
KvdoW‹kQueue
 *
queue
)

230 
	`£tupKVIOW‹k
(
kvio
, 
w‹k
, 
°©sFun˘i⁄
, 
a˘i⁄
);

231 
	`íqueueKVIOW‹k
(
queue
, 
kvio
);

232 
	}
}

239 
kvdoEnqueueVIOCÆlback
(
KVIO
 *
kvio
);

247 
kvdoC⁄töueKvio
(
KVIO
 *
kvio
, 
îr‹
);

259 
öôülizeKVIO
(
KVIO
 *
kvio
,

260 
Kî√lLayî
 *
œyî
,

261 
VIOTy≥
 
vioTy≥
,

262 
VIOPri‹ôy
 
¥i‹ôy
,

263 *
∑ª¡
,

264 
BIO
 *
bio
);

271 
‰ìMëad©aKVIO
(
Mëad©aKVIO
 **
mëad©aKVIOPå
);

279 
‰ìCom¥es£dWrôeKVIO
(
Com¥es£dWrôeKVIO
 **
com¥es£dWrôeKVIOPå
);

295 
	$kvdoCª©eMëad©aVIO
(
PhysiˇlLayî
 *
œyî
,

296 
VIOTy≥
 
vioTy≥
,

297 
VIOPri‹ôy
 
¥i‹ôy
,

298 *
∑ª¡
,

299 *
d©a
,

300 
VIO
 **
vioPå
)

301 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

316 
	$kvdoCª©eCom¥es£dWrôeVIO
(
PhysiˇlLayî
 *
œyî
,

317 *
∑ª¡
,

318 *
d©a
,

319 
AŒoˇtögVIO
 **
ÆloˇtögVIOPå
)

320 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

329 
	`kvdoWrôeCom¥es£dBlock
(
AŒoˇtögVIO
 *
ÆloˇtögVIO
);

338 
	`kvdoSubmôMëad©aVIO
(
VIO
 *
vio
);

347 
	`kvdoFlushVIO
(
VIO
 *
vio
);

	@vdo/kernel/limiter.c

22 
	~"limôî.h
"

24 
	~<löux/sched.h
>

27 
	$gëLimôîVÆuesAtomiˇŒy
(
Limôî
 *
limôî
,

28 
uöt32_t
 *
a˘ive
,

29 
uöt32_t
 *
maximum
)

31 
	`•ö_lock
(&
limôî
->
lock
);

32 *
a˘ive
 = 
limôî
->active;

33 *
maximum
 = 
limôî
->maximum;

34 
	`•ö_u∆ock
(&
limôî
->
lock
);

35 
	}
}

38 
	$öôülizeLimôî
(
Limôî
 *
limôî
, 
uöt32_t
 
limô
)

40 
limôî
->
a˘ive
 = 0;

41 
limôî
->
limô
 =Üimit;

42 
limôî
->
maximum
 = 0;

43 
	`öô_waôqueue_hód
(&
limôî
->
waôîQueue
);

44 
	`•ö_lock_öô
(&
limôî
->
lock
);

45 
	}
}

48 
	$limôîRñó£M™y
(
Limôî
 *
limôî
, 
uöt32_t
 
cou¡
)

50 
	`•ö_lock
(&
limôî
->
lock
);

51 
limôî
->
a˘ive
 -
cou¡
;

52 
	`•ö_u∆ock
(&
limôî
->
lock
);

53 i‡(
	`waôqueue_a˘ive
(&
limôî
->
waôîQueue
)) {

54 
	`wake_up_ƒ
(&
limôî
->
waôîQueue
, 
cou¡
);

56 
	}
}

59 
	$limôîWaôF‹IdÀ
(
Limôî
 *
limôî
)

61 
	`•ö_lock
(&
limôî
->
lock
);

62 
limôî
->
a˘ive
 > 0) {

63 
	`DEFINE_WAIT
(
waô
);

64 
	`¥ï¨e_to_waô_ex˛usive
(&
limôî
->
waôîQueue
, &
waô
,

65 
TASK_UNINTERRUPTIBLE
);

66 
	`•ö_u∆ock
(&
limôî
->
lock
);

67 
	`io_scheduÀ
();

68 
	`•ö_lock
(&
limôî
->
lock
);

69 
	`föish_waô
(&
limôî
->
waôîQueue
, &
waô
);

71 
	`•ö_u∆ock
(&
limôî
->
lock
);

72 
	}
}

84 
boﬁ
 
	$èkePîmôLocked
(
Limôî
 *
limôî
)

86 i‡(
limôî
->
a˘ive
 >limôî->
limô
) {

87  
Ál£
;

89 
limôî
->
a˘ive
 += 1;

90 i‡(
limôî
->
a˘ive
 >Üimôî->
maximum
) {

91 
limôî
->
maximum
 =Üimôî->
a˘ive
;

93  
åue
;

94 
	}
}

97 
	$limôîWaôF‹O√Fªe
(
Limôî
 *
limôî
)

99 
	`•ö_lock
(&
limôî
->
lock
);

100 !
	`èkePîmôLocked
(
limôî
)) {

101 
	`DEFINE_WAIT
(
waô
);

102 
	`¥ï¨e_to_waô_ex˛usive
(&
limôî
->
waôîQueue
, &
waô
,

103 
TASK_UNINTERRUPTIBLE
);

104 
	`•ö_u∆ock
(&
limôî
->
lock
);

105 
	`io_scheduÀ
();

106 
	`•ö_lock
(&
limôî
->
lock
);

107 
	`föish_waô
(&
limôî
->
waôîQueue
, &
waô
);

109 
	`•ö_u∆ock
(&
limôî
->
lock
);

110 
	}
}

113 
boﬁ
 
	$limôîPﬁl
(
Limôî
 *
limôî
)

115 
	`•ö_lock
(&
limôî
->
lock
);

116 
boﬁ
 
acquúed
 = 
	`èkePîmôLocked
(
limôî
);

117 
	`•ö_u∆ock
(&
limôî
->
lock
);

118  
acquúed
;

119 
	}
}

	@vdo/kernel/limiter.h

22 #i‚de‡
LIMITER_H


23 
	#LIMITER_H


	)

25 
	~<löux/waô.h
>

33 
	slimôî
 {

35 
•ölock_t
 
	mlock
;

37 
waô_queue_hód_t
 
	mwaôîQueue
;

39 
uöt32_t
 
	ma˘ive
;

41 
uöt32_t
 
	mmaximum
;

43 
uöt32_t
 
	mlimô
;

44 } 
	tLimôî
;

53 
gëLimôîVÆuesAtomiˇŒy
(
Limôî
 *
limôî
,

54 
uöt32_t
 *
a˘ive
,

55 
uöt32_t
 *
maximum
);

63 
öôülizeLimôî
(
Limôî
 *
limôî
, 
uöt32_t
 
limô
);

71 
limôîRñó£M™y
(
Limôî
 *
limôî
, 
uöt32_t
 
cou¡
);

78 
ölöe
 
	$limôîRñó£
(
Limôî
 *
limôî
)

80 
	`limôîRñó£M™y
(
limôî
, 1);

81 
	}
}

88 
limôîWaôF‹IdÀ
(
Limôî
 *
limôî
);

97 
limôîWaôF‹O√Fªe
(
Limôî
 *
limôî
);

108 
boﬁ
 
limôîPﬁl
(
Limôî
 *
limôî
);

	@vdo/kernel/logger.c

22 
	~"loggî.h
"

24 
	~<löux/dñay.h
>

25 
	~<löux/h¨dúq.h
>

26 
	~<löux/moduÀ.h
>

28 
	~"îr‹s.h
"

29 
	~"thªadDevi˚.h
"

31 c⁄° 
	gDEFAULT_PRIORITY
 = 
LOG_INFO
;

34 c⁄° *
	m«me
;

35 c⁄° 
	m¥i‹ôy
;

36 } 
	tPRIORITY_NAMES
;

38 c⁄° 
PRIORITY_NAMES
 
	gPRIORITIES
[] = {

39 { "ALERT", 
LOG_ALERT
 },

40 { "CRIT", 
LOG_CRIT
 },

41 { "CRITICAL", 
LOG_CRIT
 },

42 { "DEBUG", 
LOG_DEBUG
 },

43 { "EMERG", 
LOG_EMERG
 },

44 { "EMERGENCY", 
LOG_EMERG
 },

45 { "ERR", 
LOG_ERR
 },

46 { "ERROR", 
LOG_ERR
 },

47 { "INFO", 
LOG_INFO
 },

48 { "NOTICE", 
LOG_NOTICE
 },

49 { "PANIC", 
LOG_EMERG
 },

50 { "WARN", 
LOG_WARNING
 },

51 { "WARNING", 
LOG_WARNING
 },

52 { 
NULL
, -1 },

56 
	mPRIORITY_COUNT
 = 8

59 c⁄° *
	gPRIORITY_STRINGS
[] = {

70 
	glogLevñ
 = 
LOG_INFO
;

73 
	$°rögToPri‹ôy
(c⁄° *
°rög
)

75 
i
 = 0; 
PRIORITIES
[i].
«me
 !
NULL
; i++) {

76 i‡(
	`°rˇ£cmp
(
°rög
, 
PRIORITIES
[
i
].
«me
) == 0) {

77  
PRIORITIES
[
i
].
¥i‹ôy
;

80  
DEFAULT_PRIORITY
;

81 
	}
}

84 
	$gëLogLevñ
()

86  
logLevñ
;

87 
	}
}

90 
	$£tLogLevñ
(
√wLogLevñ
)

92 
logLevñ
 = 
√wLogLevñ
;

93 
	}
}

96 c⁄° *
	$¥i‹ôyToSåög
(
¥i‹ôy
)

98 i‡((
¥i‹ôy
 < 0Ë|| (¥i‹ôy >
PRIORITY_COUNT
)) {

101  
PRIORITY_STRINGS
[
¥i‹ôy
];

102 
	}
}

105 
	$°¨tLoggögF‹Pri‹ôy
(
¥i‹ôy
)

107 
¥i‹ôy
) {

108 
LOG_EMERG
:

109 
LOG_ALERT
:

110 
LOG_CRIT
:

111 
	`¥ötk
(
KERN_CRIT
);

113 
LOG_ERR
:

114 
	`¥ötk
(
KERN_ERR
);

116 
LOG_WARNING
:

117 
	`¥ötk
(
KERN_WARNING
);

119 
LOG_NOTICE
:

120 
	`¥ötk
(
KERN_NOTICE
);

122 
LOG_INFO
:

123 
	`¥ötk
(
KERN_INFO
);

125 
LOG_DEBUG
:

126 
	`¥ötk
(
KERN_DEBUG
);

129 i‡(
	`ö_öãºu±
()) {

130 *
ty≥
 = "INTR";

131 i‡(
	`ö_nmi
()) {

132 
ty≥
 = "NMI";

133 } i‡(
	`ö_úq
()) {

134 
ty≥
 = "HI";

135 } i‡(
	`ö_so·úq
()) {

136 
ty≥
 = "SI";

138 
	`¥ötk
("%s:[%s]: ", 
THIS_MODULE
->
«me
, 
ty≥
);

143 
devi˚In°™˚
 = 
	`gëThªadDevi˚ID
();

144 i‡(
devi˚In°™˚
 != -1) {

145 
	`¥ötk
("%s%u:%s: ", 
THIS_MODULE
->
«me
, 
devi˚In°™˚
, 
cuºít
->
comm
);

148 
size_t
 
«meLí
 = 
	`°æí
(
THIS_MODULE
->
«me
);

149 i‡(((
cuºít
->
Êags
 & 
PF_KTHREAD
) != 0)

150 && (
	`°∫cmp
(
THIS_MODULE
->
«me
, 
cuºít
->
comm
, 
«meLí
) == 0)) {

155 
	`¥ötk
("%s: ", 
cuºít
->
comm
);

159 
	`¥ötk
("%s: %s: ", 
THIS_MODULE
->
«me
, 
cuºít
->
comm
);

160 
	}
}

163 
	$logMesßgePack
(
¥i‹ôy
,

164 c⁄° *
¥efix
,

165 c⁄° *
fmt1
,

166 
va_li°
 
¨gs1
,

167 c⁄° *
fmt2
,

168 
va_li°
 
¨gs2
)

170 i‡(
¥i‹ôy
 > 
logLevñ
) {

173 
	`°¨tLoggögF‹Pri‹ôy
(
¥i‹ôy
);

174 i‡(
¥efix
 !
NULL
) {

175 
	`¥ötk
("%s", 
¥efix
);

177 i‡(
fmt1
 !
NULL
) {

178 
	`v¥ötk
(
fmt1
, 
¨gs1
);

180 i‡(
fmt2
 !
NULL
) {

181 
	`v¥ötk
(
fmt2
, 
¨gs2
);

183 
	`¥ötk
("\n");

184 
	}
}

187 
	$logEmbeddedMesßge
(
¥i‹ôy
,

188 c⁄° *
¥efix
,

189 c⁄° *
fmt1
,

190 
va_li°
 
¨gs1
,

191 c⁄° *
fmt2
,

194 
va_li°
 
≠
;

195 
	`va_°¨t
(
≠
, 
fmt2
);

196 
	`logMesßgePack
(
¥i‹ôy
, 
¥efix
, 
fmt1
, 
¨gs1
, 
fmt2
, 
≠
);

197 
	`va_íd
(
≠
);

198 
	}
}

201 
	$vLogMesßge
(
¥i‹ôy
, c⁄° *
f‹m©
, 
va_li°
 
¨gs
)

203 
va_li°
 
dummy
;

204 
	`logMesßgePack
(
¥i‹ôy
, 
NULL
, 
f‹m©
, 
¨gs
, NULL, 
dummy
);

205 
	}
}

208 
	$logMesßge
(
¥i‹ôy
, c⁄° *
f‹m©
, ...)

210 
va_li°
 
¨gs
;

212 
	`va_°¨t
(
¨gs
, 
f‹m©
);

213 
	`vLogMesßge
(
¥i‹ôy
, 
f‹m©
, 
¨gs
);

214 
	`va_íd
(
¨gs
);

215 
	}
}

218 
__©åibuã__
((
	$f‹m©
(
¥ötf
, 2, 3)))

219 
	$logAtLevñ
(
¥i‹ôy
, c⁄° *
f‹m©
, ...)

221 
va_li°
 
¨gs
;

223 
	`va_°¨t
(
¨gs
, 
f‹m©
);

224 
	`vLogMesßge
(
¥i‹ôy
, 
f‹m©
, 
¨gs
);

225 
	`va_íd
(
¨gs
);

226 
	}
}

229 
	$logDebug
(c⁄° *
f‹m©
, ...)

231 
va_li°
 
¨gs
;

233 
	`va_°¨t
(
¨gs
, 
f‹m©
);

234 
	`vLogMesßge
(
LOG_DEBUG
, 
f‹m©
, 
¨gs
);

235 
	`va_íd
(
¨gs
);

236 
	}
}

239 
	$logInfo
(c⁄° *
f‹m©
, ...)

241 
va_li°
 
¨gs
;

243 
	`va_°¨t
(
¨gs
, 
f‹m©
);

244 
	`vLogMesßge
(
LOG_INFO
, 
f‹m©
, 
¨gs
);

245 
	`va_íd
(
¨gs
);

246 
	}
}

249 
	$logNŸi˚
(c⁄° *
f‹m©
, ...)

251 
va_li°
 
¨gs
;

253 
	`va_°¨t
(
¨gs
, 
f‹m©
);

254 
	`vLogMesßge
(
LOG_NOTICE
, 
f‹m©
, 
¨gs
);

255 
	`va_íd
(
¨gs
);

256 
	}
}

259 
	$logW¨nög
(c⁄° *
f‹m©
, ...)

261 
va_li°
 
¨gs
;

263 
	`va_°¨t
(
¨gs
, 
f‹m©
);

264 
	`vLogMesßge
(
LOG_WARNING
, 
f‹m©
, 
¨gs
);

265 
	`va_íd
(
¨gs
);

266 
	}
}

269 
	$logEº‹
(c⁄° *
f‹m©
, ...)

271 
va_li°
 
¨gs
;

273 
	`va_°¨t
(
¨gs
, 
f‹m©
);

274 
	`vLogMesßge
(
LOG_ERR
, 
f‹m©
, 
¨gs
);

275 
	`va_íd
(
¨gs
);

276 
	}
}

279 
	$vLogEº‹
(c⁄° *
f‹m©
, 
va_li°
 
¨gs
)

281 
	`vLogMesßge
(
LOG_ERR
, 
f‹m©
, 
¨gs
);

282 
	}
}

285 
	$logBackåa˚
(
¥i‹ôy
)

287 
	`logAtLevñ
(
¥i‹ôy
, "[backtrace]");

288 i‡(
¥i‹ôy
 > 
logLevñ
) {

291 
	`dump_°ack
();

292 
	}
}

295 
	$vLogWôhSåögEº‹
(
¥i‹ôy
,

296 
î∫um
,

297 c⁄° *
f‹m©
,

298 
va_li°
 
¨gs
)

300 
îrbuf
[
ERRBUF_SIZE
] = "";

301 
	`logEmbeddedMesßge
(
¥i‹ôy
, 
NULL
, 
f‹m©
, 
¨gs
, ": %s (%d)",

302 
	`°rögEº‹
(
î∫um
, 
îrbuf
, (errbuf)),

303 
î∫um
);

304  
î∫um
;

305 
	}
}

308 
	$logWôhSåögEº‹
(
¥i‹ôy
, 
î∫um
, c⁄° *
f‹m©
, ...)

310 
va_li°
 
¨gs
;

312 
	`va_°¨t
(
¨gs
, 
f‹m©
);

313 
	`vLogWôhSåögEº‹
(
¥i‹ôy
, 
î∫um
, 
f‹m©
, 
¨gs
);

314 
	`va_íd
(
¨gs
);

315  
î∫um
;

316 
	}
}

319 
	$logEº‹WôhSåögEº‹
(
î∫um
, c⁄° *
f‹m©
, ...)

321 
va_li°
 
¨gs
;

323 
	`va_°¨t
(
¨gs
, 
f‹m©
);

324 
	`vLogWôhSåögEº‹
(
LOG_ERR
, 
î∫um
, 
f‹m©
, 
¨gs
);

325 
	`va_íd
(
¨gs
);

326  
î∫um
;

327 
	}
}

330 
	$vLogEº‹WôhSåögEº‹
(
î∫um
, c⁄° *
f‹m©
, 
va_li°
 
¨gs
)

332 
	`vLogWôhSåögEº‹
(
LOG_ERR
, 
î∫um
, 
f‹m©
, 
¨gs
);

333  
î∫um
;

334 
	}
}

337 
	$logW¨nögWôhSåögEº‹
(
î∫um
, c⁄° *
f‹m©
, ...)

339 
va_li°
 
¨gs
;

341 
	`va_°¨t
(
¨gs
, 
f‹m©
);

342 
	`vLogWôhSåögEº‹
(
LOG_WARNING
, 
î∫um
, 
f‹m©
, 
¨gs
);

343 
	`va_íd
(
¨gs
);

344  
î∫um
;

345 
	}
}

348 
	$logDebugWôhSåögEº‹
(
î∫um
, c⁄° *
f‹m©
, ...)

350 
va_li°
 
¨gs
;

352 
	`va_°¨t
(
¨gs
, 
f‹m©
);

353 
	`vLogWôhSåögEº‹
(
LOG_DEBUG
, 
î∫um
, 
f‹m©
, 
¨gs
);

354 
	`va_íd
(
¨gs
);

355  
î∫um
;

356 
	}
}

359 
	$logInfoWôhSåögEº‹
(
î∫um
, c⁄° *
f‹m©
, ...)

361 
va_li°
 
¨gs
;

363 
	`va_°¨t
(
¨gs
, 
f‹m©
);

364 
	`vLogWôhSåögEº‹
(
LOG_INFO
, 
î∫um
, 
f‹m©
, 
¨gs
);

365 
	`va_íd
(
¨gs
);

366  
î∫um
;

367 
	}
}

370 
	$logNŸi˚WôhSåögEº‹
(
î∫um
, c⁄° *
f‹m©
, ...)

372 
va_li°
 
¨gs
;

374 
	`va_°¨t
(
¨gs
, 
f‹m©
);

375 
	`vLogWôhSåögEº‹
(
LOG_NOTICE
, 
î∫um
, 
f‹m©
, 
¨gs
);

376 
	`va_íd
(
¨gs
);

377  
î∫um
;

378 
	}
}

381 
	$logF©ÆWôhSåögEº‹
(
î∫um
, c⁄° *
f‹m©
, ...)

383 
va_li°
 
¨gs
;

385 
	`va_°¨t
(
¨gs
, 
f‹m©
);

386 
	`vLogWôhSåögEº‹
(
LOG_CRIT
, 
î∫um
, 
f‹m©
, 
¨gs
);

387 
	`va_íd
(
¨gs
);

388  
î∫um
;

389 
	}
}

392 
	$logUƒecovîabÀ
(
î∫um
, c⁄° *
f‹m©
, ...)

394 i‡((
î∫um
 =
UDS_SUCCESS
 ||Éºnum =
UDS_QUEUED
) || (errnum == 0)) {

395  
î∫um
;

398 
va_li°
 
¨gs
;

399 
	`va_°¨t
(
¨gs
, 
f‹m©
);

400 
	`vLogWôhSåögEº‹
(
LOG_CRIT
, 
î∫um
, 
f‹m©
, 
¨gs
);

401 
	`va_íd
(
¨gs
);

402  
	`makeUƒecovîabÀ
(
î∫um
);

403 
	}
}

406 
	$logF©Æ
(c⁄° *
f‹m©
, ...)

408 
va_li°
 
¨gs
;

410 
	`va_°¨t
(
¨gs
, 
f‹m©
);

411 
	`vLogMesßge
(
LOG_CRIT
, 
f‹m©
, 
¨gs
);

412 
	`va_íd
(
¨gs
);

413 
	}
}

416 
	$∑u£F‹Loggî
()

420 
	`m¶ìp
(4);

421 
	}
}

	@vdo/kernel/logger.h

22 #i‚de‡
LOGGER_H


23 
	#LOGGER_H
 1

	)

25 
	~<°d¨g.h
>

26 
	~<löux/sched.h
>

27 
	~<löux/ty≥s.h
>

29 
	#LOG_EMERG
 0

	)

30 
	#LOG_ALERT
 1

	)

31 
	#LOG_CRIT
 2

	)

32 
	#LOG_ERR
 3

	)

33 
	#LOG_WARNING
 4

	)

34 
	#LOG_NOTICE
 5

	)

35 
	#LOG_INFO
 6

	)

36 
	#LOG_DEBUG
 7

	)

56 
gëLogLevñ
();

63 
£tLogLevñ
(
√wLogLevñ
);

73 
°rögToPri‹ôy
(c⁄° *
°rög
);

80 c⁄° *
¥i‹ôyToSåög
(
¥i‹ôy
);

87 
	$logDebug
(c⁄° *
f‹m©
, ...Ë
	`__©åibuã__
((
	`f‹m©
(
¥ötf
, 1, 2)));

94 
	$logInfo
(c⁄° *
f‹m©
, ...Ë
	`__©åibuã__
((
	`f‹m©
(
¥ötf
, 1, 2)));

101 
	$logNŸi˚
(c⁄° *
f‹m©
, ...Ë
	`__©åibuã__
((
	`f‹m©
(
¥ötf
, 1, 2)));

108 
	$logW¨nög
(c⁄° *
f‹m©
, ...Ë
	`__©åibuã__
((
	`f‹m©
(
¥ötf
, 1, 2)));

115 
	$logEº‹
(c⁄° *
f‹m©
, ...Ë
	`__©åibuã__
((
	`f‹m©
(
¥ötf
, 1, 2)));

124 
	$vLogEº‹
(c⁄° *
f‹m©
, 
va_li°
 
¨gs
)

125 
	`__©åibuã__
((
	`f‹m©
(
¥ötf
, 1, 0)));

136 
	$logEmbeddedMesßge
(
¥i‹ôy
,

137 c⁄° *
¥efix
,

138 c⁄° *
fmt1
,

139 
va_li°
 
¨gs1
,

140 c⁄° *
fmt2
,

142 
	`__©åibuã__
((
	`f‹m©
(
¥ötf
, 3, 0), format(printf, 5, 6)));

154 
	$logMesßgePack
(
¥i‹ôy
,

155 c⁄° *
¥efix
,

156 c⁄° *
fmt1
,

157 
va_li°
 
¨gs1
,

158 c⁄° *
fmt2
,

159 
va_li°
 
¨gs2
)

160 
	`__©åibuã__
((
	`f‹m©
(
¥ötf
, 3, 0)));

167 
	`logBackåa˚
(
¥i‹ôy
);

178 
	$logWôhSåögEº‹
(
¥i‹ôy
, 
î∫um
, c⁄° *
f‹m©
, ...)

179 
	`__©åibuã__
((
	`f‹m©
(
¥ötf
, 3, 4)));

191 
	$vLogWôhSåögEº‹
(
¥i‹ôy
,

192 
î∫um
,

193 c⁄° *
f‹m©
,

194 
va_li°
 
¨gs
)

195 
	`__©åibuã__
((
	`f‹m©
(
¥ötf
, 3, 0)));

205 
	$logEº‹WôhSåögEº‹
(
î∫um
, c⁄° *
f‹m©
, ...)

206 
	`__©åibuã__
((
	`f‹m©
(
¥ötf
, 2, 3)));

209 
	$logDebugWôhSåögEº‹
(
î∫um
, c⁄° *
f‹m©
, ...)

210 
	`__©åibuã__
((
	`f‹m©
(
¥ötf
, 2, 3)));

213 
	$logInfoWôhSåögEº‹
(
î∫um
, c⁄° *
f‹m©
, ...)

214 
	`__©åibuã__
((
	`f‹m©
(
¥ötf
, 2, 3)));

217 
	$logNŸi˚WôhSåögEº‹
(
î∫um
, c⁄° *
f‹m©
, ...)

218 
	`__©åibuã__
((
	`f‹m©
(
¥ötf
, 2, 3)));

221 
	$logW¨nögWôhSåögEº‹
(
î∫um
, c⁄° *
f‹m©
, ...)

222 
	`__©åibuã__
((
	`f‹m©
(
¥ötf
, 2, 3)));

225 
	$logF©ÆWôhSåögEº‹
(
î∫um
, c⁄° *
f‹m©
, ...)

226 
	`__©åibuã__
((
	`f‹m©
(
¥ötf
, 2, 3)));

236 
	$vLogEº‹WôhSåögEº‹
(
î∫um
, c⁄° *
f‹m©
, 
va_li°
 
¨gs
)

237 
	`__©åibuã__
((
	`f‹m©
(
¥ötf
, 2, 0)));

247 
	$logUƒecovîabÀ
(
î∫um
, c⁄° *
f‹m©
, ...)

248 
	`__©åibuã__
((
	`f‹m©
(
¥ötf
, 2, 3)));

255 
	$logF©Æ
(c⁄° *
f‹m©
, ...Ë
	`__©åibuã__
((
	`f‹m©
(
¥ötf
, 1, 2)));

264 
	$vLogMesßge
(
¥i‹ôy
, c⁄° *
f‹m©
, 
va_li°
 
¨gs
)

265 
	`__©åibuã__
((
	`f‹m©
(
¥ötf
, 2, 0)));

273 
	$logMesßge
(
¥i‹ôy
, c⁄° *
f‹m©
, ...)

274 
	`__©åibuã__
((
	`f‹m©
(
¥ötf
, 2, 3)));

283 
	`∑u£F‹Loggî
();

	@vdo/kernel/memoryUsage.c

22 
	~"mem‹yUßge.h
"

24 
	~"mem‹yAŒoc.h
"

26 
	~"kî√lSèti°ics.h
"

29 
Mem‹yUßge
 
	$gëMem‹yUßge
()

31 
Mem‹yUßge
 
mem‹yUßge
;

32 
	`gëMem‹ySèts
(&
mem‹yUßge
.
byãsU£d
, &mem‹yUßge.
≥akByãsU£d
,

33 &
mem‹yUßge
.
biosU£d
, &mem‹yUßge.
≥akBioCou¡
);

34  
mem‹yUßge
;

35 
	}
}

	@vdo/kernel/memoryUsage.h

22 #i‚de‡
MEMORY_USAGE_H


23 
	#MEMORY_USAGE_H
 1

	)

25 
	~"mem‹yAŒoc.h
"

27 
	~"kî√lSèti°ics.h
"

34 
Mem‹yUßge
 
	$gëMem‹yUßge
()

35 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

	@vdo/kernel/numeric.h

22 #i‚de‡
NUMERIC_H


23 
	#NUMERIC_H
 1

	)

25 
	~<asm/byã‹dî.h
>

26 
	~<löux/ty≥s.h
>

28 
	~"comm⁄.h
"

30 #i‡!((
deföed
 
__LITTLE_ENDIAN
Ë|| (deföed 
__BIG_ENDIAN
))

33 #i‡(
deföed
 
__LITTLE_ENDIAN
Ë&& (deföed 
__BIG_ENDIAN
)

36 #ifde‡
__LITTLE_ENDIAN


37 
	#__NUMERIC_BYTE_ORDER
 
__LITTLE_ENDIAN


	)

39 
	#__NUMERIC_BYTE_ORDER
 
__BIG_ENDIAN


	)

41 
	#bsw≠_16
 
__swab16


	)

52 
	#UNALIGNED_WRAPPER
(
TYPE
) \

53 
u«lig√d_wøp_
##
TYPE


	)

54 
	#UNALIGNED_WRAPPER_DEF
(
TYPE
) \

55 
	`__©åibuã__
((
	t∑cked
, 
	tmay_Æüs
)Ë{ 
TYPE
 
vÆue
; } \

56 
	tUNALIGNED_WRAPPER
(
	tTYPE
)

	)

57 
	tUNALIGNED_WRAPPER_DEF
(
	tuöt64_t
);

58 
UNALIGNED_WRAPPER_DEF
(
uöt32_t
);

59 
UNALIGNED_WRAPPER_DEF
(
uöt16_t
);

61 
	#GET_UNALIGNED
(
TYPE
,
ADDR
) \

62 (((c⁄° 
	`UNALIGNED_WRAPPER
(
TYPE
Ë*)(
ADDR
))->
vÆue
)

	)

63 
	#PUT_UNALIGNED
(
TYPE
,
ADDR
,
VALUE
) \

64 (((
	`UNALIGNED_WRAPPER
(
TYPE
Ë*)(
ADDR
))->
vÆue
 = (
VALUE
))

	)

74 
__©åibuã__
((
w¨n_unu£d_ªsu…
))

75 
ölöe
 
	$möI¡
(
a
, 
b
)

77  ((
a
 < 
b
) ?á : b);

78 
	}
}

88 
__©åibuã__
((
w¨n_unu£d_ªsu…
))

89 
ölöe
 
	$maxI¡
(
a
, 
b
)

91  ((
a
 > 
b
) ?á : b);

92 
	}
}

102 
__©åibuã__
((
w¨n_unu£d_ªsu…
))

103 
ölöe
 
	$maxL⁄g
(
a
, 
b
)

105  ((
a
 > 
b
) ?á : b);

106 
	}
}

116 
__©åibuã__
((
w¨n_unu£d_ªsu…
))

117 
ölöe
 
	$maxUL⁄g
(
a
, 
b
)

119  ((
a
 > 
b
) ?á : b);

120 
	}
}

130 
__©åibuã__
((
w¨n_unu£d_ªsu…
))

131 
ölöe
 
size_t
 
	$möSizeT
(
size_t
 
a
, size_à
b
)

133  ((
a
 < 
b
) ?á : b);

134 
	}
}

144 
__©åibuã__
((
w¨n_unu£d_ªsu…
))

145 
ölöe
 
size_t
 
	$maxSizeT
(
size_t
 
a
, size_à
b
)

147  ((
a
 > 
b
) ?á : b);

148 
	}
}

158 
__©åibuã__
((
w¨n_unu£d_ªsu…
))

159 
ölöe
 
	$maxUI¡
(
a
, 
b
)

161  ((
a
 > 
b
) ?á : b);

162 
	}
}

172 
__©åibuã__
((
w¨n_unu£d_ªsu…
))

173 
ölöe
 
uöt64_t
 
	$möUI¡64
(
uöt64_t
 
a
, uöt64_à
b
)

175  ((
a
 < 
b
) ?á : b);

176 
	}
}

186 
__©åibuã__
((
w¨n_unu£d_ªsu…
))

187 
ölöe
 
uöt64_t
 
	$maxUI¡64
(
uöt64_t
 
a
, uöt64_à
b
)

189  ((
a
 > 
b
) ?á : b);

190 
	}
}

200 
__©åibuã__
((
w¨n_unu£d_ªsu…
))

201 
ölöe
 
uöt64_t
 
	$gëUI¡64BE
(c⁄° 
byã
* 
d©a
)

203 
uöt64_t
 
num
 = 
	`GET_UNALIGNED
(uöt64_t, 
d©a
);

204 #i‡
__NUMERIC_BYTE_ORDER
 =
__LITTLE_ENDIAN


205 
num
 = 
	`__buûtö_bsw≠64
(num);

207  
num
;

208 
	}
}

218 
ölöe
 
	$decodeUI¡64BE
(c⁄° 
byã
 *
buf„r
,

219 
size_t
 *
off£t
,

220 
uöt64_t
 *
decoded
)

222 *
decoded
 = 
	`gëUI¡64BE
(
buf„r
 + *
off£t
);

223 *
off£t
 +(
uöt64_t
);

224 
	}
}

233 
ölöe
 
	$°‹eUI¡64BE
(
byã
* 
d©a
, 
uöt64_t
 
num
)

235 #i‡
__NUMERIC_BYTE_ORDER
 =
__LITTLE_ENDIAN


236 
num
 = 
	`__buûtö_bsw≠64
(num);

238 
	`PUT_UNALIGNED
(
uöt64_t
, 
d©a
, 
num
);

239 
	}
}

250 
ölöe
 
	$ícodeUI¡64BE
(
byã
 *
d©a
,

251 
size_t
 *
off£t
,

252 
uöt64_t
 
toEncode
)

254 
	`°‹eUI¡64BE
(
d©a
 + *
off£t
, 
toEncode
);

255 *
off£t
 +(
uöt64_t
);

256 
	}
}

266 
__©åibuã__
((
w¨n_unu£d_ªsu…
))

267 
ölöe
 
uöt32_t
 
	$gëUI¡32BE
(c⁄° 
byã
* 
d©a
)

269 
uöt32_t
 
num
 = 
	`GET_UNALIGNED
(uöt32_t, 
d©a
);

270 #i‡
__NUMERIC_BYTE_ORDER
 =
__LITTLE_ENDIAN


271 
num
 = 
	`__buûtö_bsw≠32
(num);

273  
num
;

274 
	}
}

284 
ölöe
 
	$decodeUI¡32BE
(c⁄° 
byã
 *
buf„r
,

285 
size_t
 *
off£t
,

286 
uöt32_t
 *
decoded
)

288 *
decoded
 = 
	`gëUI¡32BE
(
buf„r
 + *
off£t
);

289 *
off£t
 +(
uöt32_t
);

290 
	}
}

299 
ölöe
 
	$°‹eUI¡32BE
(
byã
* 
d©a
, 
uöt32_t
 
num
)

301 #i‡
__NUMERIC_BYTE_ORDER
 =
__LITTLE_ENDIAN


302 
num
 = 
	`__buûtö_bsw≠32
(num);

304 
	`PUT_UNALIGNED
(
uöt32_t
, 
d©a
, 
num
);

305 
	}
}

316 
ölöe
 
	$ícodeUI¡32BE
(
byã
 *
d©a
,

317 
size_t
 *
off£t
,

318 
uöt32_t
 
toEncode
)

320 
	`°‹eUI¡32BE
(
d©a
 + *
off£t
, 
toEncode
);

321 *
off£t
 +(
uöt32_t
);

322 
	}
}

332 
__©åibuã__
((
w¨n_unu£d_ªsu…
))

333 
ölöe
 
uöt16_t
 
	$gëUI¡16BE
(c⁄° 
byã
* 
d©a
)

335 
uöt16_t
 
num
 = 
	`GET_UNALIGNED
(uöt16_t, 
d©a
);

336 #i‡
__NUMERIC_BYTE_ORDER
 =
__LITTLE_ENDIAN


338 
num
 = 
	`bsw≠_16
(num);

340  
num
;

341 
	}
}

352 
ölöe
 
	$decodeUI¡16BE
(c⁄° 
byã
 *
buf„r
,

353 
size_t
 *
off£t
,

354 
uöt16_t
 *
decoded
)

356 *
decoded
 = 
	`gëUI¡16BE
(
buf„r
 + *
off£t
);

357 *
off£t
 +(
uöt16_t
);

358 
	}
}

367 
ölöe
 
	$°‹eUI¡16BE
(
byã
* 
d©a
, 
uöt16_t
 
num
)

369 #i‡
__NUMERIC_BYTE_ORDER
 =
__LITTLE_ENDIAN


371 
num
 = 
	`bsw≠_16
(num);

373 
	`PUT_UNALIGNED
(
uöt16_t
, 
d©a
, 
num
);

374 
	}
}

385 
ölöe
 
	$ícodeUI¡16BE
(
byã
 *
d©a
,

386 
size_t
 *
off£t
,

387 
uöt16_t
 
toEncode
)

389 
	`°‹eUI¡16BE
(
d©a
 + *
off£t
, 
toEncode
);

390 *
off£t
 +(
uöt16_t
);

391 
	}
}

401 
__©åibuã__
((
w¨n_unu£d_ªsu…
))

402 
ölöe
 
uöt64_t
 
	$gëUI¡64LE
(c⁄° 
byã
* 
d©a
)

404 
uöt64_t
 
num
 = 
	`GET_UNALIGNED
(uöt64_t, 
d©a
);

405 #i‡
__NUMERIC_BYTE_ORDER
 !
__LITTLE_ENDIAN


406 
num
 = 
	`__buûtö_bsw≠64
(num);

408  
num
;

409 
	}
}

418 
ölöe
 
	$°‹eUI¡64LE
(
byã
* 
d©a
, 
uöt64_t
 
num
)

420 #i‡
__NUMERIC_BYTE_ORDER
 !
__LITTLE_ENDIAN


421 
num
 = 
	`__buûtö_bsw≠64
(num);

423 
	`PUT_UNALIGNED
(
uöt64_t
, 
d©a
, 
num
);

424 
	}
}

434 
__©åibuã__
((
w¨n_unu£d_ªsu…
))

435 
ölöe
 
uöt32_t
 
	$gëUI¡32LE
(c⁄° 
byã
* 
d©a
)

437 
uöt32_t
 
num
 = 
	`GET_UNALIGNED
(uöt32_t, 
d©a
);

438 #i‡
__NUMERIC_BYTE_ORDER
 !
__LITTLE_ENDIAN


439 
num
 = 
	`__buûtö_bsw≠32
(num);

441  
num
;

442 
	}
}

451 
ölöe
 
	$°‹eUI¡32LE
(
byã
* 
d©a
, 
uöt32_t
 
num
)

453 #i‡
__NUMERIC_BYTE_ORDER
 !
__LITTLE_ENDIAN


454 
num
 = 
	`__buûtö_bsw≠32
(num);

456 
	`PUT_UNALIGNED
(
uöt32_t
, 
d©a
, 
num
);

457 
	}
}

467 
__©åibuã__
((
w¨n_unu£d_ªsu…
))

468 
ölöe
 
uöt16_t
 
	$gëUI¡16LE
(c⁄° 
byã
* 
d©a
)

470 
uöt16_t
 
num
 = 
	`GET_UNALIGNED
(uöt16_t, 
d©a
);

471 #i‡
__NUMERIC_BYTE_ORDER
 !
__LITTLE_ENDIAN


472 
num
 = 
	`__buûtö_bsw≠16
(num);

474  
num
;

475 
	}
}

484 
ölöe
 
	$°‹eUI¡16LE
(
byã
* 
d©a
, 
uöt16_t
 
num
)

486 #i‡
__NUMERIC_BYTE_ORDER
 !
__LITTLE_ENDIAN


487 
num
 = 
	`__buûtö_bsw≠16
(num);

489 
	`PUT_UNALIGNED
(
uöt16_t
, 
d©a
, 
num
);

490 
	}
}

497 
numîicCompûeTimeAs£πi⁄s
();

	@vdo/kernel/poolSysfs.c

22 
	~"poﬁSysfs.h
"

24 
	~"mem‹yAŒoc.h
"

26 
	~"vdo.h
"

28 
	~"dedu≥Index.h
"

30 
	spoﬁAâribuã
 {

31 
©åibuã
 
	m©å
;

32 
ssize_t
 (*
show
)(
Kî√lLayî
 *
	mœyî
, *
	mbuf
);

33 
ssize_t
 (*
°‹e
)(
Kî√lLayî
 *
	mœyî
, c⁄° *
	mvÆue
, 
size_t
 
	mcou¡
);

34 } 
	tPoﬁAâribuã
;

37 
ssize_t
 
	$vdoPoﬁAârShow
(
kobje˘
 *
kobj
,

38 
©åibuã
 *
©å
,

39 *
buf
)

41 
PoﬁAâribuã
 *
poﬁAâr
 = 
	`c⁄èöî_of
(
©å
, PoolAttribute,áttr);

42 i‡(
poﬁAâr
->
show
 =
NULL
) {

43  -
EINVAL
;

45 
Kî√lLayî
 *
œyî
 = 
	`c⁄èöî_of
(
kobj
, KernelLayer, kobj);

46  
poﬁAâr
->
	`show
(
œyî
, 
buf
);

47 
	}
}

50 
ssize_t
 
	$vdoPoﬁAârSt‹e
(
kobje˘
 *
kobj
,

51 
©åibuã
 *
©å
,

52 c⁄° *
buf
,

53 
size_t
 
Àngth
)

55 
PoﬁAâribuã
 *
poﬁAâr
 = 
	`c⁄èöî_of
(
©å
, PoolAttribute,áttr);

56 i‡(
poﬁAâr
->
°‹e
 =
NULL
) {

57  -
EINVAL
;

59 
Kî√lLayî
 *
œyî
 = 
	`c⁄èöî_of
(
kobj
, KernelLayer, kobj);

60  
poﬁAâr
->
	`°‹e
(
œyî
, 
buf
, 
Àngth
);

61 
	}
}

63 
sysfs_›s
 
	gvdoPoﬁSysfsOps
 = {

64 .
show
 = 
vdoPoﬁAârShow
,

65 .
	g°‹e
 = 
vdoPoﬁAârSt‹e
,

69 
ssize_t
 
	$poﬁCom¥essögShow
(
Kî√lLayî
 *
œyî
, *
buf
)

71  
	`•rötf
(
buf
, "%s\n", (
	`gëKVDOCom¥essög
(&
œyî
->
kvdo
) ? "1" : "0"));

72 
	}
}

75 
ssize_t
 
	$poﬁDisˇrdsA˘iveShow
(
Kî√lLayî
 *
œyî
, *
buf
)

77  
	`•rötf
(
buf
, "%" 
PRIu32
 "\n", 
œyî
->
disˇrdLimôî
.
a˘ive
);

78 
	}
}

81 
ssize_t
 
	$poﬁDisˇrdsLimôShow
(
Kî√lLayî
 *
œyî
, *
buf
)

83  
	`•rötf
(
buf
, "%" 
PRIu32
 "\n", 
œyî
->
disˇrdLimôî
.
limô
);

84 
	}
}

87 
ssize_t
 
	$poﬁDisˇrdsLimôSt‹e
(
Kî√lLayî
 *
œyî
,

88 c⁄° *
buf
,

89 
size_t
 
Àngth
)

91 
vÆue
;

92 i‡((
Àngth
 > 12Ë|| (
	`ssˇnf
(
buf
, "%u", &
vÆue
) != 1) || (value < 1)) {

93  -
EINVAL
;

95 
œyî
->
disˇrdLimôî
.
limô
 = 
vÆue
;

96  
Àngth
;

97 
	}
}

100 
ssize_t
 
	$poﬁDisˇrdsMaximumShow
(
Kî√lLayî
 *
œyî
, *
buf
)

102  
	`•rötf
(
buf
, "%" 
PRIu32
 "\n", 
œyî
->
disˇrdLimôî
.
maximum
);

103 
	}
}

106 
ssize_t
 
	$poﬁIn°™˚Show
(
Kî√lLayî
 *
œyî
, *
buf
)

108  
	`•rötf
(
buf
, "%u\n", 
œyî
->
ö°™˚
);

109 
	}
}

112 
ssize_t
 
	$poﬁReque°sA˘iveShow
(
Kî√lLayî
 *
œyî
, *
buf
)

114  
	`•rötf
(
buf
, "%" 
PRIu32
 "\n", 
œyî
->
ªque°Limôî
.
a˘ive
);

115 
	}
}

118 
ssize_t
 
	$poﬁReque°sLimôShow
(
Kî√lLayî
 *
œyî
, *
buf
)

120  
	`•rötf
(
buf
, "%" 
PRIu32
 "\n", 
œyî
->
ªque°Limôî
.
limô
);

121 
	}
}

124 
ssize_t
 
	$poﬁReque°sMaximumShow
(
Kî√lLayî
 *
œyî
, *
buf
)

126  
	`•rötf
(
buf
, "%" 
PRIu32
 "\n", 
œyî
->
ªque°Limôî
.
maximum
);

127 
	}
}

130 
	$vdoPoﬁRñó£
(
kobje˘
 *
kobj
)

132 
Kî√lLayî
 *
œyî
 = 
	`c⁄èöî_of
(
kobj
, KernelLayer, kobj);

133 
	`FREE
(
œyî
->
vdoSètsSt‹age
);

134 
	`FREE
(
œyî
->
kî√lSètsSt‹age
);

135 
	`‰ìVDO
(&
œyî
->
kvdo
.
vdo
);

136 
	`FREE
(
œyî
);

137 
	}
}

139 
PoﬁAâribuã
 
	gvdoPoﬁCom¥essögAâr
 = {

140 .
©å
 = { .
«me
 = "com¥essög", .
	gmode
 = 0444, },

141 .
	gshow
 = 
poﬁCom¥essögShow
,

144 
PoﬁAâribuã
 
	gvdoPoﬁDisˇrdsA˘iveAâr
 = {

145 .
©å
 = { .
«me
 = "disˇrds_a˘ive", .
	gmode
 = 0444, },

146 .
	gshow
 = 
poﬁDisˇrdsA˘iveShow
,

149 
PoﬁAâribuã
 
	gvdoPoﬁDisˇrdsLimôAâr
 = {

150 .
©å
 = { .
«me
 = "disˇrds_limô", .
	gmode
 = 0644, },

151 .
	gshow
 = 
poﬁDisˇrdsLimôShow
,

152 .
	g°‹e
 = 
poﬁDisˇrdsLimôSt‹e
,

155 
PoﬁAâribuã
 
	gvdoPoﬁDisˇrdsMaximumAâr
 = {

156 .
©å
 = { .
«me
 = "disˇrds_maximum", .
	gmode
 = 0444, },

157 .
	gshow
 = 
poﬁDisˇrdsMaximumShow
,

160 
PoﬁAâribuã
 
	gvdoPoﬁIn°™˚Aâr
 = {

161 .
©å
 = { .
«me
 = "ö°™˚", .
	gmode
 = 0444, },

162 .
	gshow
 = 
poﬁIn°™˚Show
,

165 
PoﬁAâribuã
 
	gvdoPoﬁReque°sA˘iveAâr
 = {

166 .
©å
 = { .
«me
 = "ªque°s_a˘ive", .
	gmode
 = 0444, },

167 .
	gshow
 = 
poﬁReque°sA˘iveShow
,

170 
PoﬁAâribuã
 
	gvdoPoﬁReque°sLimôAâr
 = {

171 .
©å
 = { .
«me
 = "ªque°s_limô", .
	gmode
 = 0444, },

172 .
	gshow
 = 
poﬁReque°sLimôShow
,

175 
PoﬁAâribuã
 
	gvdoPoﬁReque°sMaximumAâr
 = {

176 .
©å
 = { .
«me
 = "ªque°s_maximum", .
	gmode
 = 0444, },

177 .
	gshow
 = 
poﬁReque°sMaximumShow
,

180 
©åibuã
 *
	gpoﬁAârs
[] = {

181 &
vdoPoﬁCom¥essögAâr
.
©å
,

182 &
vdoPoﬁDisˇrdsA˘iveAâr
.
©å
,

183 &
vdoPoﬁDisˇrdsLimôAâr
.
©å
,

184 &
vdoPoﬁDisˇrdsMaximumAâr
.
©å
,

185 &
vdoPoﬁIn°™˚Aâr
.
©å
,

186 &
vdoPoﬁReque°sA˘iveAâr
.
©å
,

187 &
vdoPoﬁReque°sLimôAâr
.
©å
,

188 &
vdoPoﬁReque°sMaximumAâr
.
©å
,

189 
NULL
,

192 
kobj_ty≥
 
	gkî√lLayîKobjTy≥
 = {

193 .
ªÀa£
 = 
vdoPoﬁRñó£
,

194 .
	gsysfs_›s
 = &
vdoPoﬁSysfsOps
,

195 .
	gdeÁu…_©ås
 = 
poﬁAârs
,

199 
	$w‹kQueueDúe˘‹yRñó£
(
kobje˘
 *
kobj
)

215 
	}
}

218 
©åibuã
 *
	gnoAârs
[] = {

219 
NULL
,

222 
sysfs_›s
 
	gnoSysfsOps
 = {

224 .
show
 = 
NULL
,

225 .
	g°‹e
 = 
NULL
,

228 
kobj_ty≥
 
	gw‹kQueueDúe˘‹yKobjTy≥
 = {

229 .
ªÀa£
 = 
w‹kQueueDúe˘‹yRñó£
,

230 .
	gsysfs_›s
 = &
noSysfsOps
,

231 .
	gdeÁu…_©ås
 = 
noAârs
,

	@vdo/kernel/poolSysfs.h

22 #i‚de‡
POOL_SYSFS_H


23 
	#POOL_SYSFS_H


	)

25 
	~<löux/kobje˘.h
>

28 
kobj_ty≥
 
kî√lLayîKobjTy≥
;

30 
kobj_ty≥
 
w‹kQueueDúe˘‹yKobjTy≥
;

32 
kobj_ty≥
 
°©sDúe˘‹yKobjTy≥
;

	@vdo/kernel/poolSysfsStats.c

20 
	~"dedu≥Index.h
"

21 
	~"loggî.h
"

22 
	~"poﬁSysfs.h
"

23 
	~"°©i°ics.h
"

24 
	~"°©usProcfs.h
"

25 
	~"thªadDevi˚.h
"

26 
	~"vdo.h
"

28 
	spoﬁSètsAâribuã
 {

29 
©åibuã
 
	m©å
;

30 
ssize_t
 (*
show
)(
Kî√lLayî
 *
	mœyî
, *
	mbuf
);

31 } 
	tPoﬁSètsAâribuã
;

33 
ssize_t
 
	$poﬁSètsAârShow
(
kobje˘
 *
kobj
,

34 
©åibuã
 *
©å
,

35 *
buf
)

37 
PoﬁSètsAâribuã
 *
poﬁSètsAâr
 = 
	`c⁄èöî_of
(
©å
, PoolStatsAttribute,

38 
©å
);

40 i‡(
poﬁSètsAâr
->
show
 =
NULL
) {

41  -
EINVAL
;

43 
Kî√lLayî
 *
œyî
 = 
	`c⁄èöî_of
(
kobj
, Kî√lLayî, 
°©sDúe˘‹y
);

44  
poﬁSètsAâr
->
	`show
(
œyî
, 
buf
);

45 
	}
}

47 
sysfs_›s
 
	gpoﬁSètsSysfsOps
 = {

48 .
show
 = 
poﬁSètsAârShow
,

49 .
	g°‹e
 = 
NULL
,

54 
ssize_t
 
	$poﬁSètsD©aBlocksU£dShow
(
Kî√lLayî
 *
œyî
, *
buf
)

56 
ssize_t
 
ªtvÆ
;

57 
	`•ö_lock
(&
œyî
->
°©sLock
);

58 
	`gëKVDOSèti°ics
(&
œyî
->
kvdo
,Üayî->
vdoSètsSt‹age
);

59 
ªtvÆ
 = 
	`•rötf
(
buf
, "%" 
PRIu64
 "\n", 
œyî
->
vdoSètsSt‹age
->
d©aBlocksU£d
);

60 
	`•ö_u∆ock
(&
œyî
->
°©sLock
);

61  
ªtvÆ
;

62 
	}
}

64 
PoﬁSètsAâribuã
 
	gpoﬁSètsD©aBlocksU£dAâr
 = {

65 .
©å
 = { .
«me
 = "d©a_blocks_u£d", .
	gmode
 = 0444, },

66 .
	gshow
 = 
poﬁSètsD©aBlocksU£dShow
,

71 
ssize_t
 
	$poﬁSètsOvîhódBlocksU£dShow
(
Kî√lLayî
 *
œyî
, *
buf
)

73 
ssize_t
 
ªtvÆ
;

74 
	`•ö_lock
(&
œyî
->
°©sLock
);

75 
	`gëKVDOSèti°ics
(&
œyî
->
kvdo
,Üayî->
vdoSètsSt‹age
);

76 
ªtvÆ
 = 
	`•rötf
(
buf
, "%" 
PRIu64
 "\n", 
œyî
->
vdoSètsSt‹age
->
ovîhódBlocksU£d
);

77 
	`•ö_u∆ock
(&
œyî
->
°©sLock
);

78  
ªtvÆ
;

79 
	}
}

81 
PoﬁSètsAâribuã
 
	gpoﬁSètsOvîhódBlocksU£dAâr
 = {

82 .
©å
 = { .
«me
 = "ovîhód_blocks_u£d", .
	gmode
 = 0444, },

83 .
	gshow
 = 
poﬁSètsOvîhódBlocksU£dShow
,

88 
ssize_t
 
	$poﬁSètsLogiˇlBlocksU£dShow
(
Kî√lLayî
 *
œyî
, *
buf
)

90 
ssize_t
 
ªtvÆ
;

91 
	`•ö_lock
(&
œyî
->
°©sLock
);

92 
	`gëKVDOSèti°ics
(&
œyî
->
kvdo
,Üayî->
vdoSètsSt‹age
);

93 
ªtvÆ
 = 
	`•rötf
(
buf
, "%" 
PRIu64
 "\n", 
œyî
->
vdoSètsSt‹age
->
logiˇlBlocksU£d
);

94 
	`•ö_u∆ock
(&
œyî
->
°©sLock
);

95  
ªtvÆ
;

96 
	}
}

98 
PoﬁSètsAâribuã
 
	gpoﬁSètsLogiˇlBlocksU£dAâr
 = {

99 .
©å
 = { .
«me
 = "logiˇl_blocks_u£d", .
	gmode
 = 0444, },

100 .
	gshow
 = 
poﬁSètsLogiˇlBlocksU£dShow
,

105 
ssize_t
 
	$poﬁSètsPhysiˇlBlocksShow
(
Kî√lLayî
 *
œyî
, *
buf
)

107 
ssize_t
 
ªtvÆ
;

108 
	`•ö_lock
(&
œyî
->
°©sLock
);

109 
	`gëKVDOSèti°ics
(&
œyî
->
kvdo
,Üayî->
vdoSètsSt‹age
);

110 
ªtvÆ
 = 
	`•rötf
(
buf
, "%" 
PRIu64
 "\n", 
œyî
->
vdoSètsSt‹age
->
physiˇlBlocks
);

111 
	`•ö_u∆ock
(&
œyî
->
°©sLock
);

112  
ªtvÆ
;

113 
	}
}

115 
PoﬁSètsAâribuã
 
	gpoﬁSètsPhysiˇlBlocksAâr
 = {

116 .
©å
 = { .
«me
 = "physiˇl_blocks", .
	gmode
 = 0444, },

117 .
	gshow
 = 
poﬁSètsPhysiˇlBlocksShow
,

122 
ssize_t
 
	$poﬁSètsLogiˇlBlocksShow
(
Kî√lLayî
 *
œyî
, *
buf
)

124 
ssize_t
 
ªtvÆ
;

125 
	`•ö_lock
(&
œyî
->
°©sLock
);

126 
	`gëKVDOSèti°ics
(&
œyî
->
kvdo
,Üayî->
vdoSètsSt‹age
);

127 
ªtvÆ
 = 
	`•rötf
(
buf
, "%" 
PRIu64
 "\n", 
œyî
->
vdoSètsSt‹age
->
logiˇlBlocks
);

128 
	`•ö_u∆ock
(&
œyî
->
°©sLock
);

129  
ªtvÆ
;

130 
	}
}

132 
PoﬁSètsAâribuã
 
	gpoﬁSètsLogiˇlBlocksAâr
 = {

133 .
©å
 = { .
«me
 = "logiˇl_blocks", .
	gmode
 = 0444, },

134 .
	gshow
 = 
poﬁSètsLogiˇlBlocksShow
,

139 
ssize_t
 
	$poﬁSètsBlockM≠CacheSizeShow
(
Kî√lLayî
 *
œyî
, *
buf
)

141 
ssize_t
 
ªtvÆ
;

142 
	`•ö_lock
(&
œyî
->
°©sLock
);

143 
	`gëKVDOSèti°ics
(&
œyî
->
kvdo
,Üayî->
vdoSètsSt‹age
);

144 
ªtvÆ
 = 
	`•rötf
(
buf
, "%" 
PRIu64
 "\n", 
œyî
->
vdoSètsSt‹age
->
blockM≠CacheSize
);

145 
	`•ö_u∆ock
(&
œyî
->
°©sLock
);

146  
ªtvÆ
;

147 
	}
}

149 
PoﬁSètsAâribuã
 
	gpoﬁSètsBlockM≠CacheSizeAâr
 = {

150 .
©å
 = { .
«me
 = "block_m≠_ˇche_size", .
	gmode
 = 0444, },

151 .
	gshow
 = 
poﬁSètsBlockM≠CacheSizeShow
,

156 
ssize_t
 
	$poﬁSètsWrôePﬁicyShow
(
Kî√lLayî
 *
œyî
, *
buf
)

158 
ssize_t
 
ªtvÆ
;

159 
	`•ö_lock
(&
œyî
->
°©sLock
);

160 
	`gëKVDOSèti°ics
(&
œyî
->
kvdo
,Üayî->
vdoSètsSt‹age
);

161 
ªtvÆ
 = 
	`•rötf
(
buf
, "%s\n", 
œyî
->
vdoSètsSt‹age
->
wrôePﬁicy
);

162 
	`•ö_u∆ock
(&
œyî
->
°©sLock
);

163  
ªtvÆ
;

164 
	}
}

166 
PoﬁSètsAâribuã
 
	gpoﬁSètsWrôePﬁicyAâr
 = {

167 .
©å
 = { .
«me
 = "wrôe_pﬁicy", .
	gmode
 = 0444, },

168 .
	gshow
 = 
poﬁSètsWrôePﬁicyShow
,

173 
ssize_t
 
	$poﬁSètsBlockSizeShow
(
Kî√lLayî
 *
œyî
, *
buf
)

175 
ssize_t
 
ªtvÆ
;

176 
	`•ö_lock
(&
œyî
->
°©sLock
);

177 
	`gëKVDOSèti°ics
(&
œyî
->
kvdo
,Üayî->
vdoSètsSt‹age
);

178 
ªtvÆ
 = 
	`•rötf
(
buf
, "%" 
PRIu64
 "\n", 
œyî
->
vdoSètsSt‹age
->
blockSize
);

179 
	`•ö_u∆ock
(&
œyî
->
°©sLock
);

180  
ªtvÆ
;

181 
	}
}

183 
PoﬁSètsAâribuã
 
	gpoﬁSètsBlockSizeAâr
 = {

184 .
©å
 = { .
«me
 = "block_size", .
	gmode
 = 0444, },

185 .
	gshow
 = 
poﬁSètsBlockSizeShow
,

190 
ssize_t
 
	$poﬁSètsCom∂ëeRecovîõsShow
(
Kî√lLayî
 *
œyî
, *
buf
)

192 
ssize_t
 
ªtvÆ
;

193 
	`•ö_lock
(&
œyî
->
°©sLock
);

194 
	`gëKVDOSèti°ics
(&
œyî
->
kvdo
,Üayî->
vdoSètsSt‹age
);

195 
ªtvÆ
 = 
	`•rötf
(
buf
, "%" 
PRIu64
 "\n", 
œyî
->
vdoSètsSt‹age
->
com∂ëeRecovîõs
);

196 
	`•ö_u∆ock
(&
œyî
->
°©sLock
);

197  
ªtvÆ
;

198 
	}
}

200 
PoﬁSètsAâribuã
 
	gpoﬁSètsCom∂ëeRecovîõsAâr
 = {

201 .
©å
 = { .
«me
 = "com∂ëe_ªcovîõs", .
	gmode
 = 0444, },

202 .
	gshow
 = 
poﬁSètsCom∂ëeRecovîõsShow
,

207 
ssize_t
 
	$poﬁSètsRódO∆yRecovîõsShow
(
Kî√lLayî
 *
œyî
, *
buf
)

209 
ssize_t
 
ªtvÆ
;

210 
	`•ö_lock
(&
œyî
->
°©sLock
);

211 
	`gëKVDOSèti°ics
(&
œyî
->
kvdo
,Üayî->
vdoSètsSt‹age
);

212 
ªtvÆ
 = 
	`•rötf
(
buf
, "%" 
PRIu64
 "\n", 
œyî
->
vdoSètsSt‹age
->
ªadO∆yRecovîõs
);

213 
	`•ö_u∆ock
(&
œyî
->
°©sLock
);

214  
ªtvÆ
;

215 
	}
}

217 
PoﬁSètsAâribuã
 
	gpoﬁSètsRódO∆yRecovîõsAâr
 = {

218 .
©å
 = { .
«me
 = "ªad_⁄ly_ªcovîõs", .
	gmode
 = 0444, },

219 .
	gshow
 = 
poﬁSètsRódO∆yRecovîõsShow
,

224 
ssize_t
 
	$poﬁSètsModeShow
(
Kî√lLayî
 *
œyî
, *
buf
)

226 
ssize_t
 
ªtvÆ
;

227 
	`•ö_lock
(&
œyî
->
°©sLock
);

228 
	`gëKVDOSèti°ics
(&
œyî
->
kvdo
,Üayî->
vdoSètsSt‹age
);

229 
ªtvÆ
 = 
	`•rötf
(
buf
, "%s\n", 
œyî
->
vdoSètsSt‹age
->
mode
);

230 
	`•ö_u∆ock
(&
œyî
->
°©sLock
);

231  
ªtvÆ
;

232 
	}
}

234 
PoﬁSètsAâribuã
 
	gpoﬁSètsModeAâr
 = {

235 .
©å
 = { .
«me
 = "mode", .
	gmode
 = 0444, },

236 .
	gshow
 = 
poﬁSètsModeShow
,

241 
ssize_t
 
	$poﬁSètsInRecovîyModeShow
(
Kî√lLayî
 *
œyî
, *
buf
)

243 
ssize_t
 
ªtvÆ
;

244 
	`•ö_lock
(&
œyî
->
°©sLock
);

245 
	`gëKVDOSèti°ics
(&
œyî
->
kvdo
,Üayî->
vdoSètsSt‹age
);

246 
ªtvÆ
 = 
	`•rötf
(
buf
, "%d\n", 
œyî
->
vdoSètsSt‹age
->
öRecovîyMode
);

247 
	`•ö_u∆ock
(&
œyî
->
°©sLock
);

248  
ªtvÆ
;

249 
	}
}

251 
PoﬁSètsAâribuã
 
	gpoﬁSètsInRecovîyModeAâr
 = {

252 .
©å
 = { .
«me
 = "ö_ªcovîy_mode", .
	gmode
 = 0444, },

253 .
	gshow
 = 
poﬁSètsInRecovîyModeShow
,

258 
ssize_t
 
	$poﬁSètsRecovîyPî˚¡ageShow
(
Kî√lLayî
 *
œyî
, *
buf
)

260 
ssize_t
 
ªtvÆ
;

261 
	`•ö_lock
(&
œyî
->
°©sLock
);

262 
	`gëKVDOSèti°ics
(&
œyî
->
kvdo
,Üayî->
vdoSètsSt‹age
);

263 
ªtvÆ
 = 
	`•rötf
(
buf
, "%u\n", 
œyî
->
vdoSètsSt‹age
->
ªcovîyPî˚¡age
);

264 
	`•ö_u∆ock
(&
œyî
->
°©sLock
);

265  
ªtvÆ
;

266 
	}
}

268 
PoﬁSètsAâribuã
 
	gpoﬁSètsRecovîyPî˚¡ageAâr
 = {

269 .
©å
 = { .
«me
 = "ªcovîy_≥r˚¡age", .
	gmode
 = 0444, },

270 .
	gshow
 = 
poﬁSètsRecovîyPî˚¡ageShow
,

275 
ssize_t
 
	$poﬁSètsPackîCom¥es£dFøgmítsWrôãnShow
(
Kî√lLayî
 *
œyî
, *
buf
)

277 
ssize_t
 
ªtvÆ
;

278 
	`•ö_lock
(&
œyî
->
°©sLock
);

279 
	`gëKVDOSèti°ics
(&
œyî
->
kvdo
,Üayî->
vdoSètsSt‹age
);

280 
ªtvÆ
 = 
	`•rötf
(
buf
, "%" 
PRIu64
 "\n", 
œyî
->
vdoSètsSt‹age
->
∑ckî
.
com¥es£dFøgmítsWrôãn
);

281 
	`•ö_u∆ock
(&
œyî
->
°©sLock
);

282  
ªtvÆ
;

283 
	}
}

285 
PoﬁSètsAâribuã
 
	gpoﬁSètsPackîCom¥es£dFøgmítsWrôãnAâr
 = {

286 .
©å
 = { .
«me
 = "∑ckî_com¥es£d_‰agmíts_wrôãn", .
	gmode
 = 0444, },

287 .
	gshow
 = 
poﬁSètsPackîCom¥es£dFøgmítsWrôãnShow
,

292 
ssize_t
 
	$poﬁSètsPackîCom¥es£dBlocksWrôãnShow
(
Kî√lLayî
 *
œyî
, *
buf
)

294 
ssize_t
 
ªtvÆ
;

295 
	`•ö_lock
(&
œyî
->
°©sLock
);

296 
	`gëKVDOSèti°ics
(&
œyî
->
kvdo
,Üayî->
vdoSètsSt‹age
);

297 
ªtvÆ
 = 
	`•rötf
(
buf
, "%" 
PRIu64
 "\n", 
œyî
->
vdoSètsSt‹age
->
∑ckî
.
com¥es£dBlocksWrôãn
);

298 
	`•ö_u∆ock
(&
œyî
->
°©sLock
);

299  
ªtvÆ
;

300 
	}
}

302 
PoﬁSètsAâribuã
 
	gpoﬁSètsPackîCom¥es£dBlocksWrôãnAâr
 = {

303 .
©å
 = { .
«me
 = "∑ckî_com¥es£d_blocks_wrôãn", .
	gmode
 = 0444, },

304 .
	gshow
 = 
poﬁSètsPackîCom¥es£dBlocksWrôãnShow
,

309 
ssize_t
 
	$poﬁSètsPackîCom¥es£dFøgmítsInPackîShow
(
Kî√lLayî
 *
œyî
, *
buf
)

311 
ssize_t
 
ªtvÆ
;

312 
	`•ö_lock
(&
œyî
->
°©sLock
);

313 
	`gëKVDOSèti°ics
(&
œyî
->
kvdo
,Üayî->
vdoSètsSt‹age
);

314 
ªtvÆ
 = 
	`•rötf
(
buf
, "%" 
PRIu64
 "\n", 
œyî
->
vdoSètsSt‹age
->
∑ckî
.
com¥es£dFøgmítsInPackî
);

315 
	`•ö_u∆ock
(&
œyî
->
°©sLock
);

316  
ªtvÆ
;

317 
	}
}

319 
PoﬁSètsAâribuã
 
	gpoﬁSètsPackîCom¥es£dFøgmítsInPackîAâr
 = {

320 .
©å
 = { .
«me
 = "∑ckî_com¥es£d_‰agmíts_ö_∑ckî", .
	gmode
 = 0444, },

321 .
	gshow
 = 
poﬁSètsPackîCom¥es£dFøgmítsInPackîShow
,

326 
ssize_t
 
	$poﬁSètsAŒoˇt‹SœbCou¡Show
(
Kî√lLayî
 *
œyî
, *
buf
)

328 
ssize_t
 
ªtvÆ
;

329 
	`•ö_lock
(&
œyî
->
°©sLock
);

330 
	`gëKVDOSèti°ics
(&
œyî
->
kvdo
,Üayî->
vdoSètsSt‹age
);

331 
ªtvÆ
 = 
	`•rötf
(
buf
, "%" 
PRIu64
 "\n", 
œyî
->
vdoSètsSt‹age
->
Æloˇt‹
.
¶abCou¡
);

332 
	`•ö_u∆ock
(&
œyî
->
°©sLock
);

333  
ªtvÆ
;

334 
	}
}

336 
PoﬁSètsAâribuã
 
	gpoﬁSètsAŒoˇt‹SœbCou¡Aâr
 = {

337 .
©å
 = { .
«me
 = "Æloˇt‹_¶ab_cou¡", .
	gmode
 = 0444, },

338 .
	gshow
 = 
poﬁSètsAŒoˇt‹SœbCou¡Show
,

343 
ssize_t
 
	$poﬁSètsAŒoˇt‹SœbsO≥√dShow
(
Kî√lLayî
 *
œyî
, *
buf
)

345 
ssize_t
 
ªtvÆ
;

346 
	`•ö_lock
(&
œyî
->
°©sLock
);

347 
	`gëKVDOSèti°ics
(&
œyî
->
kvdo
,Üayî->
vdoSètsSt‹age
);

348 
ªtvÆ
 = 
	`•rötf
(
buf
, "%" 
PRIu64
 "\n", 
œyî
->
vdoSètsSt‹age
->
Æloˇt‹
.
¶absO≥√d
);

349 
	`•ö_u∆ock
(&
œyî
->
°©sLock
);

350  
ªtvÆ
;

351 
	}
}

353 
PoﬁSètsAâribuã
 
	gpoﬁSètsAŒoˇt‹SœbsO≥√dAâr
 = {

354 .
©å
 = { .
«me
 = "Æloˇt‹_¶abs_›íed", .
	gmode
 = 0444, },

355 .
	gshow
 = 
poﬁSètsAŒoˇt‹SœbsO≥√dShow
,

360 
ssize_t
 
	$poﬁSètsAŒoˇt‹SœbsRe›íedShow
(
Kî√lLayî
 *
œyî
, *
buf
)

362 
ssize_t
 
ªtvÆ
;

363 
	`•ö_lock
(&
œyî
->
°©sLock
);

364 
	`gëKVDOSèti°ics
(&
œyî
->
kvdo
,Üayî->
vdoSètsSt‹age
);

365 
ªtvÆ
 = 
	`•rötf
(
buf
, "%" 
PRIu64
 "\n", 
œyî
->
vdoSètsSt‹age
->
Æloˇt‹
.
¶absRe›íed
);

366 
	`•ö_u∆ock
(&
œyî
->
°©sLock
);

367  
ªtvÆ
;

368 
	}
}

370 
PoﬁSètsAâribuã
 
	gpoﬁSètsAŒoˇt‹SœbsRe›íedAâr
 = {

371 .
©å
 = { .
«me
 = "Æloˇt‹_¶abs_ª›íed", .
	gmode
 = 0444, },

372 .
	gshow
 = 
poﬁSètsAŒoˇt‹SœbsRe›íedShow
,

377 
ssize_t
 
	$poﬁSètsJou∫ÆDiskFuŒShow
(
Kî√lLayî
 *
œyî
, *
buf
)

379 
ssize_t
 
ªtvÆ
;

380 
	`•ö_lock
(&
œyî
->
°©sLock
);

381 
	`gëKVDOSèti°ics
(&
œyî
->
kvdo
,Üayî->
vdoSètsSt‹age
);

382 
ªtvÆ
 = 
	`•rötf
(
buf
, "%" 
PRIu64
 "\n", 
œyî
->
vdoSètsSt‹age
->
jou∫Æ
.
diskFuŒ
);

383 
	`•ö_u∆ock
(&
œyî
->
°©sLock
);

384  
ªtvÆ
;

385 
	}
}

387 
PoﬁSètsAâribuã
 
	gpoﬁSètsJou∫ÆDiskFuŒAâr
 = {

388 .
©å
 = { .
«me
 = "jou∫Æ_disk_fuŒ", .
	gmode
 = 0444, },

389 .
	gshow
 = 
poﬁSètsJou∫ÆDiskFuŒShow
,

394 
ssize_t
 
	$poﬁSètsJou∫ÆSœbJou∫ÆCommôsReque°edShow
(
Kî√lLayî
 *
œyî
, *
buf
)

396 
ssize_t
 
ªtvÆ
;

397 
	`•ö_lock
(&
œyî
->
°©sLock
);

398 
	`gëKVDOSèti°ics
(&
œyî
->
kvdo
,Üayî->
vdoSètsSt‹age
);

399 
ªtvÆ
 = 
	`•rötf
(
buf
, "%" 
PRIu64
 "\n", 
œyî
->
vdoSètsSt‹age
->
jou∫Æ
.
¶abJou∫ÆCommôsReque°ed
);

400 
	`•ö_u∆ock
(&
œyî
->
°©sLock
);

401  
ªtvÆ
;

402 
	}
}

404 
PoﬁSètsAâribuã
 
	gpoﬁSètsJou∫ÆSœbJou∫ÆCommôsReque°edAâr
 = {

405 .
©å
 = { .
«me
 = "jou∫Æ_¶ab_jou∫Æ_commôs_ªque°ed", .
	gmode
 = 0444, },

406 .
	gshow
 = 
poﬁSètsJou∫ÆSœbJou∫ÆCommôsReque°edShow
,

411 
ssize_t
 
	$poﬁSètsJou∫ÆE¡rõsSèπedShow
(
Kî√lLayî
 *
œyî
, *
buf
)

413 
ssize_t
 
ªtvÆ
;

414 
	`•ö_lock
(&
œyî
->
°©sLock
);

415 
	`gëKVDOSèti°ics
(&
œyî
->
kvdo
,Üayî->
vdoSètsSt‹age
);

416 
ªtvÆ
 = 
	`•rötf
(
buf
, "%" 
PRIu64
 "\n", 
œyî
->
vdoSètsSt‹age
->
jou∫Æ
.
íåõs
.
°¨ãd
);

417 
	`•ö_u∆ock
(&
œyî
->
°©sLock
);

418  
ªtvÆ
;

419 
	}
}

421 
PoﬁSètsAâribuã
 
	gpoﬁSètsJou∫ÆE¡rõsSèπedAâr
 = {

422 .
©å
 = { .
«me
 = "jou∫Æ_íåõs_°¨ãd", .
	gmode
 = 0444, },

423 .
	gshow
 = 
poﬁSètsJou∫ÆE¡rõsSèπedShow
,

428 
ssize_t
 
	$poﬁSètsJou∫ÆE¡rõsWrôãnShow
(
Kî√lLayî
 *
œyî
, *
buf
)

430 
ssize_t
 
ªtvÆ
;

431 
	`•ö_lock
(&
œyî
->
°©sLock
);

432 
	`gëKVDOSèti°ics
(&
œyî
->
kvdo
,Üayî->
vdoSètsSt‹age
);

433 
ªtvÆ
 = 
	`•rötf
(
buf
, "%" 
PRIu64
 "\n", 
œyî
->
vdoSètsSt‹age
->
jou∫Æ
.
íåõs
.
wrôãn
);

434 
	`•ö_u∆ock
(&
œyî
->
°©sLock
);

435  
ªtvÆ
;

436 
	}
}

438 
PoﬁSètsAâribuã
 
	gpoﬁSètsJou∫ÆE¡rõsWrôãnAâr
 = {

439 .
©å
 = { .
«me
 = "jou∫Æ_íåõs_wrôãn", .
	gmode
 = 0444, },

440 .
	gshow
 = 
poﬁSètsJou∫ÆE¡rõsWrôãnShow
,

445 
ssize_t
 
	$poﬁSètsJou∫ÆE¡rõsCommôãdShow
(
Kî√lLayî
 *
œyî
, *
buf
)

447 
ssize_t
 
ªtvÆ
;

448 
	`•ö_lock
(&
œyî
->
°©sLock
);

449 
	`gëKVDOSèti°ics
(&
œyî
->
kvdo
,Üayî->
vdoSètsSt‹age
);

450 
ªtvÆ
 = 
	`•rötf
(
buf
, "%" 
PRIu64
 "\n", 
œyî
->
vdoSètsSt‹age
->
jou∫Æ
.
íåõs
.
commôãd
);

451 
	`•ö_u∆ock
(&
œyî
->
°©sLock
);

452  
ªtvÆ
;

453 
	}
}

455 
PoﬁSètsAâribuã
 
	gpoﬁSètsJou∫ÆE¡rõsCommôãdAâr
 = {

456 .
©å
 = { .
«me
 = "jou∫Æ_íåõs_commôãd", .
	gmode
 = 0444, },

457 .
	gshow
 = 
poﬁSètsJou∫ÆE¡rõsCommôãdShow
,

462 
ssize_t
 
	$poﬁSètsJou∫ÆBlocksSèπedShow
(
Kî√lLayî
 *
œyî
, *
buf
)

464 
ssize_t
 
ªtvÆ
;

465 
	`•ö_lock
(&
œyî
->
°©sLock
);

466 
	`gëKVDOSèti°ics
(&
œyî
->
kvdo
,Üayî->
vdoSètsSt‹age
);

467 
ªtvÆ
 = 
	`•rötf
(
buf
, "%" 
PRIu64
 "\n", 
œyî
->
vdoSètsSt‹age
->
jou∫Æ
.
blocks
.
°¨ãd
);

468 
	`•ö_u∆ock
(&
œyî
->
°©sLock
);

469  
ªtvÆ
;

470 
	}
}

472 
PoﬁSètsAâribuã
 
	gpoﬁSètsJou∫ÆBlocksSèπedAâr
 = {

473 .
©å
 = { .
«me
 = "jou∫Æ_blocks_°¨ãd", .
	gmode
 = 0444, },

474 .
	gshow
 = 
poﬁSètsJou∫ÆBlocksSèπedShow
,

479 
ssize_t
 
	$poﬁSètsJou∫ÆBlocksWrôãnShow
(
Kî√lLayî
 *
œyî
, *
buf
)

481 
ssize_t
 
ªtvÆ
;

482 
	`•ö_lock
(&
œyî
->
°©sLock
);

483 
	`gëKVDOSèti°ics
(&
œyî
->
kvdo
,Üayî->
vdoSètsSt‹age
);

484 
ªtvÆ
 = 
	`•rötf
(
buf
, "%" 
PRIu64
 "\n", 
œyî
->
vdoSètsSt‹age
->
jou∫Æ
.
blocks
.
wrôãn
);

485 
	`•ö_u∆ock
(&
œyî
->
°©sLock
);

486  
ªtvÆ
;

487 
	}
}

489 
PoﬁSètsAâribuã
 
	gpoﬁSètsJou∫ÆBlocksWrôãnAâr
 = {

490 .
©å
 = { .
«me
 = "jou∫Æ_blocks_wrôãn", .
	gmode
 = 0444, },

491 .
	gshow
 = 
poﬁSètsJou∫ÆBlocksWrôãnShow
,

496 
ssize_t
 
	$poﬁSètsJou∫ÆBlocksCommôãdShow
(
Kî√lLayî
 *
œyî
, *
buf
)

498 
ssize_t
 
ªtvÆ
;

499 
	`•ö_lock
(&
œyî
->
°©sLock
);

500 
	`gëKVDOSèti°ics
(&
œyî
->
kvdo
,Üayî->
vdoSètsSt‹age
);

501 
ªtvÆ
 = 
	`•rötf
(
buf
, "%" 
PRIu64
 "\n", 
œyî
->
vdoSètsSt‹age
->
jou∫Æ
.
blocks
.
commôãd
);

502 
	`•ö_u∆ock
(&
œyî
->
°©sLock
);

503  
ªtvÆ
;

504 
	}
}

506 
PoﬁSètsAâribuã
 
	gpoﬁSètsJou∫ÆBlocksCommôãdAâr
 = {

507 .
©å
 = { .
«me
 = "jou∫Æ_blocks_commôãd", .
	gmode
 = 0444, },

508 .
	gshow
 = 
poﬁSètsJou∫ÆBlocksCommôãdShow
,

513 
ssize_t
 
	$poﬁSètsSœbJou∫ÆDiskFuŒCou¡Show
(
Kî√lLayî
 *
œyî
, *
buf
)

515 
ssize_t
 
ªtvÆ
;

516 
	`•ö_lock
(&
œyî
->
°©sLock
);

517 
	`gëKVDOSèti°ics
(&
œyî
->
kvdo
,Üayî->
vdoSètsSt‹age
);

518 
ªtvÆ
 = 
	`•rötf
(
buf
, "%" 
PRIu64
 "\n", 
œyî
->
vdoSètsSt‹age
->
¶abJou∫Æ
.
diskFuŒCou¡
);

519 
	`•ö_u∆ock
(&
œyî
->
°©sLock
);

520  
ªtvÆ
;

521 
	}
}

523 
PoﬁSètsAâribuã
 
	gpoﬁSètsSœbJou∫ÆDiskFuŒCou¡Aâr
 = {

524 .
©å
 = { .
«me
 = "¶ab_jou∫Æ_disk_fuŒ_cou¡", .
	gmode
 = 0444, },

525 .
	gshow
 = 
poﬁSètsSœbJou∫ÆDiskFuŒCou¡Show
,

530 
ssize_t
 
	$poﬁSètsSœbJou∫ÆFlushCou¡Show
(
Kî√lLayî
 *
œyî
, *
buf
)

532 
ssize_t
 
ªtvÆ
;

533 
	`•ö_lock
(&
œyî
->
°©sLock
);

534 
	`gëKVDOSèti°ics
(&
œyî
->
kvdo
,Üayî->
vdoSètsSt‹age
);

535 
ªtvÆ
 = 
	`•rötf
(
buf
, "%" 
PRIu64
 "\n", 
œyî
->
vdoSètsSt‹age
->
¶abJou∫Æ
.
ÊushCou¡
);

536 
	`•ö_u∆ock
(&
œyî
->
°©sLock
);

537  
ªtvÆ
;

538 
	}
}

540 
PoﬁSètsAâribuã
 
	gpoﬁSètsSœbJou∫ÆFlushCou¡Aâr
 = {

541 .
©å
 = { .
«me
 = "¶ab_jou∫Æ_Êush_cou¡", .
	gmode
 = 0444, },

542 .
	gshow
 = 
poﬁSètsSœbJou∫ÆFlushCou¡Show
,

547 
ssize_t
 
	$poﬁSètsSœbJou∫ÆBlockedCou¡Show
(
Kî√lLayî
 *
œyî
, *
buf
)

549 
ssize_t
 
ªtvÆ
;

550 
	`•ö_lock
(&
œyî
->
°©sLock
);

551 
	`gëKVDOSèti°ics
(&
œyî
->
kvdo
,Üayî->
vdoSètsSt‹age
);

552 
ªtvÆ
 = 
	`•rötf
(
buf
, "%" 
PRIu64
 "\n", 
œyî
->
vdoSètsSt‹age
->
¶abJou∫Æ
.
blockedCou¡
);

553 
	`•ö_u∆ock
(&
œyî
->
°©sLock
);

554  
ªtvÆ
;

555 
	}
}

557 
PoﬁSètsAâribuã
 
	gpoﬁSètsSœbJou∫ÆBlockedCou¡Aâr
 = {

558 .
©å
 = { .
«me
 = "¶ab_jou∫Æ_blocked_cou¡", .
	gmode
 = 0444, },

559 .
	gshow
 = 
poﬁSètsSœbJou∫ÆBlockedCou¡Show
,

564 
ssize_t
 
	$poﬁSètsSœbJou∫ÆBlocksWrôãnShow
(
Kî√lLayî
 *
œyî
, *
buf
)

566 
ssize_t
 
ªtvÆ
;

567 
	`•ö_lock
(&
œyî
->
°©sLock
);

568 
	`gëKVDOSèti°ics
(&
œyî
->
kvdo
,Üayî->
vdoSètsSt‹age
);

569 
ªtvÆ
 = 
	`•rötf
(
buf
, "%" 
PRIu64
 "\n", 
œyî
->
vdoSètsSt‹age
->
¶abJou∫Æ
.
blocksWrôãn
);

570 
	`•ö_u∆ock
(&
œyî
->
°©sLock
);

571  
ªtvÆ
;

572 
	}
}

574 
PoﬁSètsAâribuã
 
	gpoﬁSètsSœbJou∫ÆBlocksWrôãnAâr
 = {

575 .
©å
 = { .
«me
 = "¶ab_jou∫Æ_blocks_wrôãn", .
	gmode
 = 0444, },

576 .
	gshow
 = 
poﬁSètsSœbJou∫ÆBlocksWrôãnShow
,

581 
ssize_t
 
	$poﬁSètsSœbJou∫ÆTaûBusyCou¡Show
(
Kî√lLayî
 *
œyî
, *
buf
)

583 
ssize_t
 
ªtvÆ
;

584 
	`•ö_lock
(&
œyî
->
°©sLock
);

585 
	`gëKVDOSèti°ics
(&
œyî
->
kvdo
,Üayî->
vdoSètsSt‹age
);

586 
ªtvÆ
 = 
	`•rötf
(
buf
, "%" 
PRIu64
 "\n", 
œyî
->
vdoSètsSt‹age
->
¶abJou∫Æ
.
èûBusyCou¡
);

587 
	`•ö_u∆ock
(&
œyî
->
°©sLock
);

588  
ªtvÆ
;

589 
	}
}

591 
PoﬁSètsAâribuã
 
	gpoﬁSètsSœbJou∫ÆTaûBusyCou¡Aâr
 = {

592 .
©å
 = { .
«me
 = "¶ab_jou∫Æ_èû_busy_cou¡", .
	gmode
 = 0444, },

593 .
	gshow
 = 
poﬁSètsSœbJou∫ÆTaûBusyCou¡Show
,

598 
ssize_t
 
	$poﬁSètsSœbSumm¨yBlocksWrôãnShow
(
Kî√lLayî
 *
œyî
, *
buf
)

600 
ssize_t
 
ªtvÆ
;

601 
	`•ö_lock
(&
œyî
->
°©sLock
);

602 
	`gëKVDOSèti°ics
(&
œyî
->
kvdo
,Üayî->
vdoSètsSt‹age
);

603 
ªtvÆ
 = 
	`•rötf
(
buf
, "%" 
PRIu64
 "\n", 
œyî
->
vdoSètsSt‹age
->
¶abSumm¨y
.
blocksWrôãn
);

604 
	`•ö_u∆ock
(&
œyî
->
°©sLock
);

605  
ªtvÆ
;

606 
	}
}

608 
PoﬁSètsAâribuã
 
	gpoﬁSètsSœbSumm¨yBlocksWrôãnAâr
 = {

609 .
©å
 = { .
«me
 = "¶ab_summ¨y_blocks_wrôãn", .
	gmode
 = 0444, },

610 .
	gshow
 = 
poﬁSètsSœbSumm¨yBlocksWrôãnShow
,

615 
ssize_t
 
	$poﬁSètsRefCou¡sBlocksWrôãnShow
(
Kî√lLayî
 *
œyî
, *
buf
)

617 
ssize_t
 
ªtvÆ
;

618 
	`•ö_lock
(&
œyî
->
°©sLock
);

619 
	`gëKVDOSèti°ics
(&
œyî
->
kvdo
,Üayî->
vdoSètsSt‹age
);

620 
ªtvÆ
 = 
	`•rötf
(
buf
, "%" 
PRIu64
 "\n", 
œyî
->
vdoSètsSt‹age
->
ªfCou¡s
.
blocksWrôãn
);

621 
	`•ö_u∆ock
(&
œyî
->
°©sLock
);

622  
ªtvÆ
;

623 
	}
}

625 
PoﬁSètsAâribuã
 
	gpoﬁSètsRefCou¡sBlocksWrôãnAâr
 = {

626 .
©å
 = { .
«me
 = "ªf_cou¡s_blocks_wrôãn", .
	gmode
 = 0444, },

627 .
	gshow
 = 
poﬁSètsRefCou¡sBlocksWrôãnShow
,

632 
ssize_t
 
	$poﬁSètsBlockM≠DútyPagesShow
(
Kî√lLayî
 *
œyî
, *
buf
)

634 
ssize_t
 
ªtvÆ
;

635 
	`•ö_lock
(&
œyî
->
°©sLock
);

636 
	`gëKVDOSèti°ics
(&
œyî
->
kvdo
,Üayî->
vdoSètsSt‹age
);

637 
ªtvÆ
 = 
	`•rötf
(
buf
, "%" 
PRIu32
 "\n", 
œyî
->
vdoSètsSt‹age
->
blockM≠
.
dútyPages
);

638 
	`•ö_u∆ock
(&
œyî
->
°©sLock
);

639  
ªtvÆ
;

640 
	}
}

642 
PoﬁSètsAâribuã
 
	gpoﬁSètsBlockM≠DútyPagesAâr
 = {

643 .
©å
 = { .
«me
 = "block_m≠_dúty_∑ges", .
	gmode
 = 0444, },

644 .
	gshow
 = 
poﬁSètsBlockM≠DútyPagesShow
,

649 
ssize_t
 
	$poﬁSètsBlockM≠CÀ™PagesShow
(
Kî√lLayî
 *
œyî
, *
buf
)

651 
ssize_t
 
ªtvÆ
;

652 
	`•ö_lock
(&
œyî
->
°©sLock
);

653 
	`gëKVDOSèti°ics
(&
œyî
->
kvdo
,Üayî->
vdoSètsSt‹age
);

654 
ªtvÆ
 = 
	`•rötf
(
buf
, "%" 
PRIu32
 "\n", 
œyî
->
vdoSètsSt‹age
->
blockM≠
.
˛ónPages
);

655 
	`•ö_u∆ock
(&
œyî
->
°©sLock
);

656  
ªtvÆ
;

657 
	}
}

659 
PoﬁSètsAâribuã
 
	gpoﬁSètsBlockM≠CÀ™PagesAâr
 = {

660 .
©å
 = { .
«me
 = "block_m≠_˛ón_∑ges", .
	gmode
 = 0444, },

661 .
	gshow
 = 
poﬁSètsBlockM≠CÀ™PagesShow
,

666 
ssize_t
 
	$poﬁSètsBlockM≠FªePagesShow
(
Kî√lLayî
 *
œyî
, *
buf
)

668 
ssize_t
 
ªtvÆ
;

669 
	`•ö_lock
(&
œyî
->
°©sLock
);

670 
	`gëKVDOSèti°ics
(&
œyî
->
kvdo
,Üayî->
vdoSètsSt‹age
);

671 
ªtvÆ
 = 
	`•rötf
(
buf
, "%" 
PRIu32
 "\n", 
œyî
->
vdoSètsSt‹age
->
blockM≠
.
‰ìPages
);

672 
	`•ö_u∆ock
(&
œyî
->
°©sLock
);

673  
ªtvÆ
;

674 
	}
}

676 
PoﬁSètsAâribuã
 
	gpoﬁSètsBlockM≠FªePagesAâr
 = {

677 .
©å
 = { .
«me
 = "block_m≠_‰ì_∑ges", .
	gmode
 = 0444, },

678 .
	gshow
 = 
poﬁSètsBlockM≠FªePagesShow
,

683 
ssize_t
 
	$poﬁSètsBlockM≠FaûedPagesShow
(
Kî√lLayî
 *
œyî
, *
buf
)

685 
ssize_t
 
ªtvÆ
;

686 
	`•ö_lock
(&
œyî
->
°©sLock
);

687 
	`gëKVDOSèti°ics
(&
œyî
->
kvdo
,Üayî->
vdoSètsSt‹age
);

688 
ªtvÆ
 = 
	`•rötf
(
buf
, "%" 
PRIu32
 "\n", 
œyî
->
vdoSètsSt‹age
->
blockM≠
.
ÁûedPages
);

689 
	`•ö_u∆ock
(&
œyî
->
°©sLock
);

690  
ªtvÆ
;

691 
	}
}

693 
PoﬁSètsAâribuã
 
	gpoﬁSètsBlockM≠FaûedPagesAâr
 = {

694 .
©å
 = { .
«me
 = "block_m≠_Áûed_∑ges", .
	gmode
 = 0444, },

695 .
	gshow
 = 
poﬁSètsBlockM≠FaûedPagesShow
,

700 
ssize_t
 
	$poﬁSètsBlockM≠IncomögPagesShow
(
Kî√lLayî
 *
œyî
, *
buf
)

702 
ssize_t
 
ªtvÆ
;

703 
	`•ö_lock
(&
œyî
->
°©sLock
);

704 
	`gëKVDOSèti°ics
(&
œyî
->
kvdo
,Üayî->
vdoSètsSt‹age
);

705 
ªtvÆ
 = 
	`•rötf
(
buf
, "%" 
PRIu32
 "\n", 
œyî
->
vdoSètsSt‹age
->
blockM≠
.
öcomögPages
);

706 
	`•ö_u∆ock
(&
œyî
->
°©sLock
);

707  
ªtvÆ
;

708 
	}
}

710 
PoﬁSètsAâribuã
 
	gpoﬁSètsBlockM≠IncomögPagesAâr
 = {

711 .
©å
 = { .
«me
 = "block_m≠_öcomög_∑ges", .
	gmode
 = 0444, },

712 .
	gshow
 = 
poﬁSètsBlockM≠IncomögPagesShow
,

717 
ssize_t
 
	$poﬁSètsBlockM≠OutgoögPagesShow
(
Kî√lLayî
 *
œyî
, *
buf
)

719 
ssize_t
 
ªtvÆ
;

720 
	`•ö_lock
(&
œyî
->
°©sLock
);

721 
	`gëKVDOSèti°ics
(&
œyî
->
kvdo
,Üayî->
vdoSètsSt‹age
);

722 
ªtvÆ
 = 
	`•rötf
(
buf
, "%" 
PRIu32
 "\n", 
œyî
->
vdoSètsSt‹age
->
blockM≠
.
outgoögPages
);

723 
	`•ö_u∆ock
(&
œyî
->
°©sLock
);

724  
ªtvÆ
;

725 
	}
}

727 
PoﬁSètsAâribuã
 
	gpoﬁSètsBlockM≠OutgoögPagesAâr
 = {

728 .
©å
 = { .
«me
 = "block_m≠_outgoög_∑ges", .
	gmode
 = 0444, },

729 .
	gshow
 = 
poﬁSètsBlockM≠OutgoögPagesShow
,

734 
ssize_t
 
	$poﬁSètsBlockM≠CachePªssuªShow
(
Kî√lLayî
 *
œyî
, *
buf
)

736 
ssize_t
 
ªtvÆ
;

737 
	`•ö_lock
(&
œyî
->
°©sLock
);

738 
	`gëKVDOSèti°ics
(&
œyî
->
kvdo
,Üayî->
vdoSètsSt‹age
);

739 
ªtvÆ
 = 
	`•rötf
(
buf
, "%" 
PRIu32
 "\n", 
œyî
->
vdoSètsSt‹age
->
blockM≠
.
ˇchePªssuª
);

740 
	`•ö_u∆ock
(&
œyî
->
°©sLock
);

741  
ªtvÆ
;

742 
	}
}

744 
PoﬁSètsAâribuã
 
	gpoﬁSètsBlockM≠CachePªssuªAâr
 = {

745 .
©å
 = { .
«me
 = "block_m≠_ˇche_¥essuª", .
	gmode
 = 0444, },

746 .
	gshow
 = 
poﬁSètsBlockM≠CachePªssuªShow
,

751 
ssize_t
 
	$poﬁSètsBlockM≠RódCou¡Show
(
Kî√lLayî
 *
œyî
, *
buf
)

753 
ssize_t
 
ªtvÆ
;

754 
	`•ö_lock
(&
œyî
->
°©sLock
);

755 
	`gëKVDOSèti°ics
(&
œyî
->
kvdo
,Üayî->
vdoSètsSt‹age
);

756 
ªtvÆ
 = 
	`•rötf
(
buf
, "%" 
PRIu64
 "\n", 
œyî
->
vdoSètsSt‹age
->
blockM≠
.
ªadCou¡
);

757 
	`•ö_u∆ock
(&
œyî
->
°©sLock
);

758  
ªtvÆ
;

759 
	}
}

761 
PoﬁSètsAâribuã
 
	gpoﬁSètsBlockM≠RódCou¡Aâr
 = {

762 .
©å
 = { .
«me
 = "block_m≠_ªad_cou¡", .
	gmode
 = 0444, },

763 .
	gshow
 = 
poﬁSètsBlockM≠RódCou¡Show
,

768 
ssize_t
 
	$poﬁSètsBlockM≠WrôeCou¡Show
(
Kî√lLayî
 *
œyî
, *
buf
)

770 
ssize_t
 
ªtvÆ
;

771 
	`•ö_lock
(&
œyî
->
°©sLock
);

772 
	`gëKVDOSèti°ics
(&
œyî
->
kvdo
,Üayî->
vdoSètsSt‹age
);

773 
ªtvÆ
 = 
	`•rötf
(
buf
, "%" 
PRIu64
 "\n", 
œyî
->
vdoSètsSt‹age
->
blockM≠
.
wrôeCou¡
);

774 
	`•ö_u∆ock
(&
œyî
->
°©sLock
);

775  
ªtvÆ
;

776 
	}
}

778 
PoﬁSètsAâribuã
 
	gpoﬁSètsBlockM≠WrôeCou¡Aâr
 = {

779 .
©å
 = { .
«me
 = "block_m≠_wrôe_cou¡", .
	gmode
 = 0444, },

780 .
	gshow
 = 
poﬁSètsBlockM≠WrôeCou¡Show
,

785 
ssize_t
 
	$poﬁSètsBlockM≠FaûedRódsShow
(
Kî√lLayî
 *
œyî
, *
buf
)

787 
ssize_t
 
ªtvÆ
;

788 
	`•ö_lock
(&
œyî
->
°©sLock
);

789 
	`gëKVDOSèti°ics
(&
œyî
->
kvdo
,Üayî->
vdoSètsSt‹age
);

790 
ªtvÆ
 = 
	`•rötf
(
buf
, "%" 
PRIu64
 "\n", 
œyî
->
vdoSètsSt‹age
->
blockM≠
.
ÁûedRóds
);

791 
	`•ö_u∆ock
(&
œyî
->
°©sLock
);

792  
ªtvÆ
;

793 
	}
}

795 
PoﬁSètsAâribuã
 
	gpoﬁSètsBlockM≠FaûedRódsAâr
 = {

796 .
©å
 = { .
«me
 = "block_m≠_Áûed_ªads", .
	gmode
 = 0444, },

797 .
	gshow
 = 
poﬁSètsBlockM≠FaûedRódsShow
,

802 
ssize_t
 
	$poﬁSètsBlockM≠FaûedWrôesShow
(
Kî√lLayî
 *
œyî
, *
buf
)

804 
ssize_t
 
ªtvÆ
;

805 
	`•ö_lock
(&
œyî
->
°©sLock
);

806 
	`gëKVDOSèti°ics
(&
œyî
->
kvdo
,Üayî->
vdoSètsSt‹age
);

807 
ªtvÆ
 = 
	`•rötf
(
buf
, "%" 
PRIu64
 "\n", 
œyî
->
vdoSètsSt‹age
->
blockM≠
.
ÁûedWrôes
);

808 
	`•ö_u∆ock
(&
œyî
->
°©sLock
);

809  
ªtvÆ
;

810 
	}
}

812 
PoﬁSètsAâribuã
 
	gpoﬁSètsBlockM≠FaûedWrôesAâr
 = {

813 .
©å
 = { .
«me
 = "block_m≠_Áûed_wrôes", .
	gmode
 = 0444, },

814 .
	gshow
 = 
poﬁSètsBlockM≠FaûedWrôesShow
,

819 
ssize_t
 
	$poﬁSètsBlockM≠Re˛aimedShow
(
Kî√lLayî
 *
œyî
, *
buf
)

821 
ssize_t
 
ªtvÆ
;

822 
	`•ö_lock
(&
œyî
->
°©sLock
);

823 
	`gëKVDOSèti°ics
(&
œyî
->
kvdo
,Üayî->
vdoSètsSt‹age
);

824 
ªtvÆ
 = 
	`•rötf
(
buf
, "%" 
PRIu64
 "\n", 
œyî
->
vdoSètsSt‹age
->
blockM≠
.
ª˛aimed
);

825 
	`•ö_u∆ock
(&
œyî
->
°©sLock
);

826  
ªtvÆ
;

827 
	}
}

829 
PoﬁSètsAâribuã
 
	gpoﬁSètsBlockM≠Re˛aimedAâr
 = {

830 .
©å
 = { .
«me
 = "block_m≠_ª˛aimed", .
	gmode
 = 0444, },

831 .
	gshow
 = 
poﬁSètsBlockM≠Re˛aimedShow
,

836 
ssize_t
 
	$poﬁSètsBlockM≠RódOutgoögShow
(
Kî√lLayî
 *
œyî
, *
buf
)

838 
ssize_t
 
ªtvÆ
;

839 
	`•ö_lock
(&
œyî
->
°©sLock
);

840 
	`gëKVDOSèti°ics
(&
œyî
->
kvdo
,Üayî->
vdoSètsSt‹age
);

841 
ªtvÆ
 = 
	`•rötf
(
buf
, "%" 
PRIu64
 "\n", 
œyî
->
vdoSètsSt‹age
->
blockM≠
.
ªadOutgoög
);

842 
	`•ö_u∆ock
(&
œyî
->
°©sLock
);

843  
ªtvÆ
;

844 
	}
}

846 
PoﬁSètsAâribuã
 
	gpoﬁSètsBlockM≠RódOutgoögAâr
 = {

847 .
©å
 = { .
«me
 = "block_m≠_ªad_outgoög", .
	gmode
 = 0444, },

848 .
	gshow
 = 
poﬁSètsBlockM≠RódOutgoögShow
,

853 
ssize_t
 
	$poﬁSètsBlockM≠FoundInCacheShow
(
Kî√lLayî
 *
œyî
, *
buf
)

855 
ssize_t
 
ªtvÆ
;

856 
	`•ö_lock
(&
œyî
->
°©sLock
);

857 
	`gëKVDOSèti°ics
(&
œyî
->
kvdo
,Üayî->
vdoSètsSt‹age
);

858 
ªtvÆ
 = 
	`•rötf
(
buf
, "%" 
PRIu64
 "\n", 
œyî
->
vdoSètsSt‹age
->
blockM≠
.
foundInCache
);

859 
	`•ö_u∆ock
(&
œyî
->
°©sLock
);

860  
ªtvÆ
;

861 
	}
}

863 
PoﬁSètsAâribuã
 
	gpoﬁSètsBlockM≠FoundInCacheAâr
 = {

864 .
©å
 = { .
«me
 = "block_m≠_found_ö_ˇche", .
	gmode
 = 0444, },

865 .
	gshow
 = 
poﬁSètsBlockM≠FoundInCacheShow
,

870 
ssize_t
 
	$poﬁSètsBlockM≠DisˇrdRequúedShow
(
Kî√lLayî
 *
œyî
, *
buf
)

872 
ssize_t
 
ªtvÆ
;

873 
	`•ö_lock
(&
œyî
->
°©sLock
);

874 
	`gëKVDOSèti°ics
(&
œyî
->
kvdo
,Üayî->
vdoSètsSt‹age
);

875 
ªtvÆ
 = 
	`•rötf
(
buf
, "%" 
PRIu64
 "\n", 
œyî
->
vdoSètsSt‹age
->
blockM≠
.
disˇrdRequúed
);

876 
	`•ö_u∆ock
(&
œyî
->
°©sLock
);

877  
ªtvÆ
;

878 
	}
}

880 
PoﬁSètsAâribuã
 
	gpoﬁSètsBlockM≠DisˇrdRequúedAâr
 = {

881 .
©å
 = { .
«me
 = "block_m≠_disˇrd_ªquúed", .
	gmode
 = 0444, },

882 .
	gshow
 = 
poﬁSètsBlockM≠DisˇrdRequúedShow
,

887 
ssize_t
 
	$poﬁSètsBlockM≠WaôF‹PageShow
(
Kî√lLayî
 *
œyî
, *
buf
)

889 
ssize_t
 
ªtvÆ
;

890 
	`•ö_lock
(&
œyî
->
°©sLock
);

891 
	`gëKVDOSèti°ics
(&
œyî
->
kvdo
,Üayî->
vdoSètsSt‹age
);

892 
ªtvÆ
 = 
	`•rötf
(
buf
, "%" 
PRIu64
 "\n", 
œyî
->
vdoSètsSt‹age
->
blockM≠
.
waôF‹Page
);

893 
	`•ö_u∆ock
(&
œyî
->
°©sLock
);

894  
ªtvÆ
;

895 
	}
}

897 
PoﬁSètsAâribuã
 
	gpoﬁSètsBlockM≠WaôF‹PageAâr
 = {

898 .
©å
 = { .
«me
 = "block_m≠_waô_f‹_∑ge", .
	gmode
 = 0444, },

899 .
	gshow
 = 
poﬁSètsBlockM≠WaôF‹PageShow
,

904 
ssize_t
 
	$poﬁSètsBlockM≠FëchRequúedShow
(
Kî√lLayî
 *
œyî
, *
buf
)

906 
ssize_t
 
ªtvÆ
;

907 
	`•ö_lock
(&
œyî
->
°©sLock
);

908 
	`gëKVDOSèti°ics
(&
œyî
->
kvdo
,Üayî->
vdoSètsSt‹age
);

909 
ªtvÆ
 = 
	`•rötf
(
buf
, "%" 
PRIu64
 "\n", 
œyî
->
vdoSètsSt‹age
->
blockM≠
.
„tchRequúed
);

910 
	`•ö_u∆ock
(&
œyî
->
°©sLock
);

911  
ªtvÆ
;

912 
	}
}

914 
PoﬁSètsAâribuã
 
	gpoﬁSètsBlockM≠FëchRequúedAâr
 = {

915 .
©å
 = { .
«me
 = "block_m≠_„tch_ªquúed", .
	gmode
 = 0444, },

916 .
	gshow
 = 
poﬁSètsBlockM≠FëchRequúedShow
,

921 
ssize_t
 
	$poﬁSètsBlockM≠PagesLﬂdedShow
(
Kî√lLayî
 *
œyî
, *
buf
)

923 
ssize_t
 
ªtvÆ
;

924 
	`•ö_lock
(&
œyî
->
°©sLock
);

925 
	`gëKVDOSèti°ics
(&
œyî
->
kvdo
,Üayî->
vdoSètsSt‹age
);

926 
ªtvÆ
 = 
	`•rötf
(
buf
, "%" 
PRIu64
 "\n", 
œyî
->
vdoSètsSt‹age
->
blockM≠
.
∑gesLﬂded
);

927 
	`•ö_u∆ock
(&
œyî
->
°©sLock
);

928  
ªtvÆ
;

929 
	}
}

931 
PoﬁSètsAâribuã
 
	gpoﬁSètsBlockM≠PagesLﬂdedAâr
 = {

932 .
©å
 = { .
«me
 = "block_m≠_∑ges_lﬂded", .
	gmode
 = 0444, },

933 .
	gshow
 = 
poﬁSètsBlockM≠PagesLﬂdedShow
,

938 
ssize_t
 
	$poﬁSètsBlockM≠PagesSavedShow
(
Kî√lLayî
 *
œyî
, *
buf
)

940 
ssize_t
 
ªtvÆ
;

941 
	`•ö_lock
(&
œyî
->
°©sLock
);

942 
	`gëKVDOSèti°ics
(&
œyî
->
kvdo
,Üayî->
vdoSètsSt‹age
);

943 
ªtvÆ
 = 
	`•rötf
(
buf
, "%" 
PRIu64
 "\n", 
œyî
->
vdoSètsSt‹age
->
blockM≠
.
∑gesSaved
);

944 
	`•ö_u∆ock
(&
œyî
->
°©sLock
);

945  
ªtvÆ
;

946 
	}
}

948 
PoﬁSètsAâribuã
 
	gpoﬁSètsBlockM≠PagesSavedAâr
 = {

949 .
©å
 = { .
«me
 = "block_m≠_∑ges_ßved", .
	gmode
 = 0444, },

950 .
	gshow
 = 
poﬁSètsBlockM≠PagesSavedShow
,

955 
ssize_t
 
	$poﬁSètsBlockM≠FlushCou¡Show
(
Kî√lLayî
 *
œyî
, *
buf
)

957 
ssize_t
 
ªtvÆ
;

958 
	`•ö_lock
(&
œyî
->
°©sLock
);

959 
	`gëKVDOSèti°ics
(&
œyî
->
kvdo
,Üayî->
vdoSètsSt‹age
);

960 
ªtvÆ
 = 
	`•rötf
(
buf
, "%" 
PRIu64
 "\n", 
œyî
->
vdoSètsSt‹age
->
blockM≠
.
ÊushCou¡
);

961 
	`•ö_u∆ock
(&
œyî
->
°©sLock
);

962  
ªtvÆ
;

963 
	}
}

965 
PoﬁSètsAâribuã
 
	gpoﬁSètsBlockM≠FlushCou¡Aâr
 = {

966 .
©å
 = { .
«me
 = "block_m≠_Êush_cou¡", .
	gmode
 = 0444, },

967 .
	gshow
 = 
poﬁSètsBlockM≠FlushCou¡Show
,

972 
ssize_t
 
	$poﬁSètsEº‹sInvÆidAdvi˚PBNCou¡Show
(
Kî√lLayî
 *
œyî
, *
buf
)

974 
ssize_t
 
ªtvÆ
;

975 
	`•ö_lock
(&
œyî
->
°©sLock
);

976 
	`gëKVDOSèti°ics
(&
œyî
->
kvdo
,Üayî->
vdoSètsSt‹age
);

977 
ªtvÆ
 = 
	`•rötf
(
buf
, "%" 
PRIu64
 "\n", 
œyî
->
vdoSètsSt‹age
->
îr‹s
.
övÆidAdvi˚PBNCou¡
);

978 
	`•ö_u∆ock
(&
œyî
->
°©sLock
);

979  
ªtvÆ
;

980 
	}
}

982 
PoﬁSètsAâribuã
 
	gpoﬁSètsEº‹sInvÆidAdvi˚PBNCou¡Aâr
 = {

983 .
©å
 = { .
«me
 = "îr‹s_övÆid_advi˚PBNCou¡", .
	gmode
 = 0444, },

984 .
	gshow
 = 
poﬁSètsEº‹sInvÆidAdvi˚PBNCou¡Show
,

989 
ssize_t
 
	$poﬁSètsEº‹sInvÆidRﬁlovîPBNCou¡Show
(
Kî√lLayî
 *
œyî
, *
buf
)

991 
ssize_t
 
ªtvÆ
;

992 
	`•ö_lock
(&
œyî
->
°©sLock
);

993 
	`gëKVDOSèti°ics
(&
œyî
->
kvdo
,Üayî->
vdoSètsSt‹age
);

994 
ªtvÆ
 = 
	`•rötf
(
buf
, "%" 
PRIu64
 "\n", 
œyî
->
vdoSètsSt‹age
->
îr‹s
.
övÆidRﬁlovîPBNCou¡
);

995 
	`•ö_u∆ock
(&
œyî
->
°©sLock
);

996  
ªtvÆ
;

997 
	}
}

999 
PoﬁSètsAâribuã
 
	gpoﬁSètsEº‹sInvÆidRﬁlovîPBNCou¡Aâr
 = {

1000 .
©å
 = { .
«me
 = "îr‹s_övÆid_rﬁlovîPBNCou¡", .
	gmode
 = 0444, },

1001 .
	gshow
 = 
poﬁSètsEº‹sInvÆidRﬁlovîPBNCou¡Show
,

1006 
ssize_t
 
	$poﬁSètsEº‹sDedu≥DódlockAvoid™˚Cou¡Show
(
Kî√lLayî
 *
œyî
, *
buf
)

1008 
ssize_t
 
ªtvÆ
;

1009 
	`•ö_lock
(&
œyî
->
°©sLock
);

1010 
	`gëKVDOSèti°ics
(&
œyî
->
kvdo
,Üayî->
vdoSètsSt‹age
);

1011 
ªtvÆ
 = 
	`•rötf
(
buf
, "%" 
PRIu64
 "\n", 
œyî
->
vdoSètsSt‹age
->
îr‹s
.
dedu≥DódlockAvoid™˚Cou¡
);

1012 
	`•ö_u∆ock
(&
œyî
->
°©sLock
);

1013  
ªtvÆ
;

1014 
	}
}

1016 
PoﬁSètsAâribuã
 
	gpoﬁSètsEº‹sDedu≥DódlockAvoid™˚Cou¡Aâr
 = {

1017 .
©å
 = { .
«me
 = "îr‹s_dedu≥_dódlock_avoid™˚_cou¡", .
	gmode
 = 0444, },

1018 .
	gshow
 = 
poﬁSètsEº‹sDedu≥DódlockAvoid™˚Cou¡Show
,

1023 
ssize_t
 
	$poﬁSètsEº‹sNoS∑˚Eº‹Cou¡Show
(
Kî√lLayî
 *
œyî
, *
buf
)

1025 
ssize_t
 
ªtvÆ
;

1026 
	`•ö_lock
(&
œyî
->
°©sLock
);

1027 
	`gëKVDOSèti°ics
(&
œyî
->
kvdo
,Üayî->
vdoSètsSt‹age
);

1028 
ªtvÆ
 = 
	`•rötf
(
buf
, "%" 
PRIu64
 "\n", 
œyî
->
vdoSètsSt‹age
->
îr‹s
.
noS∑˚Eº‹Cou¡
);

1029 
	`•ö_u∆ock
(&
œyî
->
°©sLock
);

1030  
ªtvÆ
;

1031 
	}
}

1033 
PoﬁSètsAâribuã
 
	gpoﬁSètsEº‹sNoS∑˚Eº‹Cou¡Aâr
 = {

1034 .
©å
 = { .
«me
 = "îr‹s_no_•a˚_îr‹_cou¡", .
	gmode
 = 0444, },

1035 .
	gshow
 = 
poﬁSètsEº‹sNoS∑˚Eº‹Cou¡Show
,

1040 
ssize_t
 
	$poﬁSètsEº‹sRódO∆yEº‹Cou¡Show
(
Kî√lLayî
 *
œyî
, *
buf
)

1042 
ssize_t
 
ªtvÆ
;

1043 
	`•ö_lock
(&
œyî
->
°©sLock
);

1044 
	`gëKVDOSèti°ics
(&
œyî
->
kvdo
,Üayî->
vdoSètsSt‹age
);

1045 
ªtvÆ
 = 
	`•rötf
(
buf
, "%" 
PRIu64
 "\n", 
œyî
->
vdoSètsSt‹age
->
îr‹s
.
ªadO∆yEº‹Cou¡
);

1046 
	`•ö_u∆ock
(&
œyî
->
°©sLock
);

1047  
ªtvÆ
;

1048 
	}
}

1050 
PoﬁSètsAâribuã
 
	gpoﬁSètsEº‹sRódO∆yEº‹Cou¡Aâr
 = {

1051 .
©å
 = { .
«me
 = "îr‹s_ªad_⁄ly_îr‹_cou¡", .
	gmode
 = 0444, },

1052 .
	gshow
 = 
poﬁSètsEº‹sRódO∆yEº‹Cou¡Show
,

1057 
ssize_t
 
	$poﬁSètsIn°™˚Show
(
Kî√lLayî
 *
œyî
, *
buf
)

1059 
ssize_t
 
ªtvÆ
;

1060 
	`•ö_lock
(&
œyî
->
°©sLock
);

1061 
	`gëKî√lSèts
(
œyî
,Üayî->
kî√lSètsSt‹age
);

1062 
ªtvÆ
 = 
	`•rötf
(
buf
, "%" 
PRIu32
 "\n", 
œyî
->
kî√lSètsSt‹age
->
ö°™˚
);

1063 
	`•ö_u∆ock
(&
œyî
->
°©sLock
);

1064  
ªtvÆ
;

1065 
	}
}

1067 
PoﬁSètsAâribuã
 
	gpoﬁSètsIn°™˚Aâr
 = {

1068 .
©å
 = { .
«me
 = "ö°™˚", .
	gmode
 = 0444, },

1069 .
	gshow
 = 
poﬁSètsIn°™˚Show
,

1074 
ssize_t
 
	$poﬁSètsCuºítVIOsInProgªssShow
(
Kî√lLayî
 *
œyî
, *
buf
)

1076 
ssize_t
 
ªtvÆ
;

1077 
	`•ö_lock
(&
œyî
->
°©sLock
);

1078 
	`gëKî√lSèts
(
œyî
,Üayî->
kî√lSètsSt‹age
);

1079 
ªtvÆ
 = 
	`•rötf
(
buf
, "%" 
PRIu32
 "\n", 
œyî
->
kî√lSètsSt‹age
->
cuºítVIOsInProgªss
);

1080 
	`•ö_u∆ock
(&
œyî
->
°©sLock
);

1081  
ªtvÆ
;

1082 
	}
}

1084 
PoﬁSètsAâribuã
 
	gpoﬁSètsCuºítVIOsInProgªssAâr
 = {

1085 .
©å
 = { .
«me
 = "cuºítVIOs_ö_¥ogªss", .
	gmode
 = 0444, },

1086 .
	gshow
 = 
poﬁSètsCuºítVIOsInProgªssShow
,

1091 
ssize_t
 
	$poﬁSètsMaxVIOsShow
(
Kî√lLayî
 *
œyî
, *
buf
)

1093 
ssize_t
 
ªtvÆ
;

1094 
	`•ö_lock
(&
œyî
->
°©sLock
);

1095 
	`gëKî√lSèts
(
œyî
,Üayî->
kî√lSètsSt‹age
);

1096 
ªtvÆ
 = 
	`•rötf
(
buf
, "%" 
PRIu32
 "\n", 
œyî
->
kî√lSètsSt‹age
->
maxVIOs
);

1097 
	`•ö_u∆ock
(&
œyî
->
°©sLock
);

1098  
ªtvÆ
;

1099 
	}
}

1101 
PoﬁSètsAâribuã
 
	gpoﬁSètsMaxVIOsAâr
 = {

1102 .
©å
 = { .
«me
 = "maxVIOs", .
	gmode
 = 0444, },

1103 .
	gshow
 = 
poﬁSètsMaxVIOsShow
,

1108 
ssize_t
 
	$poﬁSètsCuºDedu≥QuîõsShow
(
Kî√lLayî
 *
œyî
, *
buf
)

1110 
ssize_t
 
ªtvÆ
;

1111 
	`•ö_lock
(&
œyî
->
°©sLock
);

1112 
	`gëKî√lSèts
(
œyî
,Üayî->
kî√lSètsSt‹age
);

1113 
ªtvÆ
 = 
	`•rötf
(
buf
, "%" 
PRIu32
 "\n", 
œyî
->
kî√lSètsSt‹age
->
cuºDedu≥Quîõs
);

1114 
	`•ö_u∆ock
(&
œyî
->
°©sLock
);

1115  
ªtvÆ
;

1116 
	}
}

1118 
PoﬁSètsAâribuã
 
	gpoﬁSètsCuºDedu≥QuîõsAâr
 = {

1119 .
©å
 = { .
«me
 = "cuº_dedu≥_quîõs", .
	gmode
 = 0444, },

1120 .
	gshow
 = 
poﬁSètsCuºDedu≥QuîõsShow
,

1125 
ssize_t
 
	$poﬁSètsMaxDedu≥QuîõsShow
(
Kî√lLayî
 *
œyî
, *
buf
)

1127 
ssize_t
 
ªtvÆ
;

1128 
	`•ö_lock
(&
œyî
->
°©sLock
);

1129 
	`gëKî√lSèts
(
œyî
,Üayî->
kî√lSètsSt‹age
);

1130 
ªtvÆ
 = 
	`•rötf
(
buf
, "%" 
PRIu32
 "\n", 
œyî
->
kî√lSètsSt‹age
->
maxDedu≥Quîõs
);

1131 
	`•ö_u∆ock
(&
œyî
->
°©sLock
);

1132  
ªtvÆ
;

1133 
	}
}

1135 
PoﬁSètsAâribuã
 
	gpoﬁSètsMaxDedu≥QuîõsAâr
 = {

1136 .
©å
 = { .
«me
 = "max_dedu≥_quîõs", .
	gmode
 = 0444, },

1137 .
	gshow
 = 
poﬁSètsMaxDedu≥QuîõsShow
,

1142 
ssize_t
 
	$poﬁSètsDedu≥Advi˚VÆidShow
(
Kî√lLayî
 *
œyî
, *
buf
)

1144 
ssize_t
 
ªtvÆ
;

1145 
	`•ö_lock
(&
œyî
->
°©sLock
);

1146 
	`gëKî√lSèts
(
œyî
,Üayî->
kî√lSètsSt‹age
);

1147 
ªtvÆ
 = 
	`•rötf
(
buf
, "%" 
PRIu64
 "\n", 
œyî
->
kî√lSètsSt‹age
->
dedu≥Advi˚VÆid
);

1148 
	`•ö_u∆ock
(&
œyî
->
°©sLock
);

1149  
ªtvÆ
;

1150 
	}
}

1152 
PoﬁSètsAâribuã
 
	gpoﬁSètsDedu≥Advi˚VÆidAâr
 = {

1153 .
©å
 = { .
«me
 = "dedu≥_advi˚_vÆid", .
	gmode
 = 0444, },

1154 .
	gshow
 = 
poﬁSètsDedu≥Advi˚VÆidShow
,

1159 
ssize_t
 
	$poﬁSètsDedu≥Advi˚SèÀShow
(
Kî√lLayî
 *
œyî
, *
buf
)

1161 
ssize_t
 
ªtvÆ
;

1162 
	`•ö_lock
(&
œyî
->
°©sLock
);

1163 
	`gëKî√lSèts
(
œyî
,Üayî->
kî√lSètsSt‹age
);

1164 
ªtvÆ
 = 
	`•rötf
(
buf
, "%" 
PRIu64
 "\n", 
œyî
->
kî√lSètsSt‹age
->
dedu≥Advi˚SèÀ
);

1165 
	`•ö_u∆ock
(&
œyî
->
°©sLock
);

1166  
ªtvÆ
;

1167 
	}
}

1169 
PoﬁSètsAâribuã
 
	gpoﬁSètsDedu≥Advi˚SèÀAâr
 = {

1170 .
©å
 = { .
«me
 = "dedu≥_advi˚_°Æe", .
	gmode
 = 0444, },

1171 .
	gshow
 = 
poﬁSètsDedu≥Advi˚SèÀShow
,

1176 
ssize_t
 
	$poﬁSètsDedu≥Advi˚TimeoutsShow
(
Kî√lLayî
 *
œyî
, *
buf
)

1178 
ssize_t
 
ªtvÆ
;

1179 
	`•ö_lock
(&
œyî
->
°©sLock
);

1180 
	`gëKî√lSèts
(
œyî
,Üayî->
kî√lSètsSt‹age
);

1181 
ªtvÆ
 = 
	`•rötf
(
buf
, "%" 
PRIu64
 "\n", 
œyî
->
kî√lSètsSt‹age
->
dedu≥Advi˚Timeouts
);

1182 
	`•ö_u∆ock
(&
œyî
->
°©sLock
);

1183  
ªtvÆ
;

1184 
	}
}

1186 
PoﬁSètsAâribuã
 
	gpoﬁSètsDedu≥Advi˚TimeoutsAâr
 = {

1187 .
©å
 = { .
«me
 = "dedu≥_advi˚_timeouts", .
	gmode
 = 0444, },

1188 .
	gshow
 = 
poﬁSètsDedu≥Advi˚TimeoutsShow
,

1193 
ssize_t
 
	$poﬁSètsFlushOutShow
(
Kî√lLayî
 *
œyî
, *
buf
)

1195 
ssize_t
 
ªtvÆ
;

1196 
	`•ö_lock
(&
œyî
->
°©sLock
);

1197 
	`gëKî√lSèts
(
œyî
,Üayî->
kî√lSètsSt‹age
);

1198 
ªtvÆ
 = 
	`•rötf
(
buf
, "%" 
PRIu64
 "\n", 
œyî
->
kî√lSètsSt‹age
->
ÊushOut
);

1199 
	`•ö_u∆ock
(&
œyî
->
°©sLock
);

1200  
ªtvÆ
;

1201 
	}
}

1203 
PoﬁSètsAâribuã
 
	gpoﬁSètsFlushOutAâr
 = {

1204 .
©å
 = { .
«me
 = "Êush_out", .
	gmode
 = 0444, },

1205 .
	gshow
 = 
poﬁSètsFlushOutShow
,

1210 
ssize_t
 
	$poﬁSètsLogiˇlBlockSizeShow
(
Kî√lLayî
 *
œyî
, *
buf
)

1212 
ssize_t
 
ªtvÆ
;

1213 
	`•ö_lock
(&
œyî
->
°©sLock
);

1214 
	`gëKî√lSèts
(
œyî
,Üayî->
kî√lSètsSt‹age
);

1215 
ªtvÆ
 = 
	`•rötf
(
buf
, "%" 
PRIu64
 "\n", 
œyî
->
kî√lSètsSt‹age
->
logiˇlBlockSize
);

1216 
	`•ö_u∆ock
(&
œyî
->
°©sLock
);

1217  
ªtvÆ
;

1218 
	}
}

1220 
PoﬁSètsAâribuã
 
	gpoﬁSètsLogiˇlBlockSizeAâr
 = {

1221 .
©å
 = { .
«me
 = "logiˇl_block_size", .
	gmode
 = 0444, },

1222 .
	gshow
 = 
poﬁSètsLogiˇlBlockSizeShow
,

1227 
ssize_t
 
	$poﬁSètsBiosInRódShow
(
Kî√lLayî
 *
œyî
, *
buf
)

1229 
ssize_t
 
ªtvÆ
;

1230 
	`•ö_lock
(&
œyî
->
°©sLock
);

1231 
	`gëKî√lSèts
(
œyî
,Üayî->
kî√lSètsSt‹age
);

1232 
ªtvÆ
 = 
	`•rötf
(
buf
, "%" 
PRIu64
 "\n", 
œyî
->
kî√lSètsSt‹age
->
biosIn
.
ªad
);

1233 
	`•ö_u∆ock
(&
œyî
->
°©sLock
);

1234  
ªtvÆ
;

1235 
	}
}

1237 
PoﬁSètsAâribuã
 
	gpoﬁSètsBiosInRódAâr
 = {

1238 .
©å
 = { .
«me
 = "bios_ö_ªad", .
	gmode
 = 0444, },

1239 .
	gshow
 = 
poﬁSètsBiosInRódShow
,

1244 
ssize_t
 
	$poﬁSètsBiosInWrôeShow
(
Kî√lLayî
 *
œyî
, *
buf
)

1246 
ssize_t
 
ªtvÆ
;

1247 
	`•ö_lock
(&
œyî
->
°©sLock
);

1248 
	`gëKî√lSèts
(
œyî
,Üayî->
kî√lSètsSt‹age
);

1249 
ªtvÆ
 = 
	`•rötf
(
buf
, "%" 
PRIu64
 "\n", 
œyî
->
kî√lSètsSt‹age
->
biosIn
.
wrôe
);

1250 
	`•ö_u∆ock
(&
œyî
->
°©sLock
);

1251  
ªtvÆ
;

1252 
	}
}

1254 
PoﬁSètsAâribuã
 
	gpoﬁSètsBiosInWrôeAâr
 = {

1255 .
©å
 = { .
«me
 = "bios_ö_wrôe", .
	gmode
 = 0444, },

1256 .
	gshow
 = 
poﬁSètsBiosInWrôeShow
,

1261 
ssize_t
 
	$poﬁSètsBiosInDisˇrdShow
(
Kî√lLayî
 *
œyî
, *
buf
)

1263 
ssize_t
 
ªtvÆ
;

1264 
	`•ö_lock
(&
œyî
->
°©sLock
);

1265 
	`gëKî√lSèts
(
œyî
,Üayî->
kî√lSètsSt‹age
);

1266 
ªtvÆ
 = 
	`•rötf
(
buf
, "%" 
PRIu64
 "\n", 
œyî
->
kî√lSètsSt‹age
->
biosIn
.
disˇrd
);

1267 
	`•ö_u∆ock
(&
œyî
->
°©sLock
);

1268  
ªtvÆ
;

1269 
	}
}

1271 
PoﬁSètsAâribuã
 
	gpoﬁSètsBiosInDisˇrdAâr
 = {

1272 .
©å
 = { .
«me
 = "bios_ö_disˇrd", .
	gmode
 = 0444, },

1273 .
	gshow
 = 
poﬁSètsBiosInDisˇrdShow
,

1278 
ssize_t
 
	$poﬁSètsBiosInFlushShow
(
Kî√lLayî
 *
œyî
, *
buf
)

1280 
ssize_t
 
ªtvÆ
;

1281 
	`•ö_lock
(&
œyî
->
°©sLock
);

1282 
	`gëKî√lSèts
(
œyî
,Üayî->
kî√lSètsSt‹age
);

1283 
ªtvÆ
 = 
	`•rötf
(
buf
, "%" 
PRIu64
 "\n", 
œyî
->
kî√lSètsSt‹age
->
biosIn
.
Êush
);

1284 
	`•ö_u∆ock
(&
œyî
->
°©sLock
);

1285  
ªtvÆ
;

1286 
	}
}

1288 
PoﬁSètsAâribuã
 
	gpoﬁSètsBiosInFlushAâr
 = {

1289 .
©å
 = { .
«me
 = "bios_ö_Êush", .
	gmode
 = 0444, },

1290 .
	gshow
 = 
poﬁSètsBiosInFlushShow
,

1295 
ssize_t
 
	$poﬁSètsBiosInFuaShow
(
Kî√lLayî
 *
œyî
, *
buf
)

1297 
ssize_t
 
ªtvÆ
;

1298 
	`•ö_lock
(&
œyî
->
°©sLock
);

1299 
	`gëKî√lSèts
(
œyî
,Üayî->
kî√lSètsSt‹age
);

1300 
ªtvÆ
 = 
	`•rötf
(
buf
, "%" 
PRIu64
 "\n", 
œyî
->
kî√lSètsSt‹age
->
biosIn
.
fua
);

1301 
	`•ö_u∆ock
(&
œyî
->
°©sLock
);

1302  
ªtvÆ
;

1303 
	}
}

1305 
PoﬁSètsAâribuã
 
	gpoﬁSètsBiosInFuaAâr
 = {

1306 .
©å
 = { .
«me
 = "bios_ö_fua", .
	gmode
 = 0444, },

1307 .
	gshow
 = 
poﬁSètsBiosInFuaShow
,

1312 
ssize_t
 
	$poﬁSètsBiosInP¨tülRódShow
(
Kî√lLayî
 *
œyî
, *
buf
)

1314 
ssize_t
 
ªtvÆ
;

1315 
	`•ö_lock
(&
œyî
->
°©sLock
);

1316 
	`gëKî√lSèts
(
œyî
,Üayî->
kî√lSètsSt‹age
);

1317 
ªtvÆ
 = 
	`•rötf
(
buf
, "%" 
PRIu64
 "\n", 
œyî
->
kî√lSètsSt‹age
->
biosInP¨tül
.
ªad
);

1318 
	`•ö_u∆ock
(&
œyî
->
°©sLock
);

1319  
ªtvÆ
;

1320 
	}
}

1322 
PoﬁSètsAâribuã
 
	gpoﬁSètsBiosInP¨tülRódAâr
 = {

1323 .
©å
 = { .
«me
 = "bios_ö_∑πül_ªad", .
	gmode
 = 0444, },

1324 .
	gshow
 = 
poﬁSètsBiosInP¨tülRódShow
,

1329 
ssize_t
 
	$poﬁSètsBiosInP¨tülWrôeShow
(
Kî√lLayî
 *
œyî
, *
buf
)

1331 
ssize_t
 
ªtvÆ
;

1332 
	`•ö_lock
(&
œyî
->
°©sLock
);

1333 
	`gëKî√lSèts
(
œyî
,Üayî->
kî√lSètsSt‹age
);

1334 
ªtvÆ
 = 
	`•rötf
(
buf
, "%" 
PRIu64
 "\n", 
œyî
->
kî√lSètsSt‹age
->
biosInP¨tül
.
wrôe
);

1335 
	`•ö_u∆ock
(&
œyî
->
°©sLock
);

1336  
ªtvÆ
;

1337 
	}
}

1339 
PoﬁSètsAâribuã
 
	gpoﬁSètsBiosInP¨tülWrôeAâr
 = {

1340 .
©å
 = { .
«me
 = "bios_ö_∑πül_wrôe", .
	gmode
 = 0444, },

1341 .
	gshow
 = 
poﬁSètsBiosInP¨tülWrôeShow
,

1346 
ssize_t
 
	$poﬁSètsBiosInP¨tülDisˇrdShow
(
Kî√lLayî
 *
œyî
, *
buf
)

1348 
ssize_t
 
ªtvÆ
;

1349 
	`•ö_lock
(&
œyî
->
°©sLock
);

1350 
	`gëKî√lSèts
(
œyî
,Üayî->
kî√lSètsSt‹age
);

1351 
ªtvÆ
 = 
	`•rötf
(
buf
, "%" 
PRIu64
 "\n", 
œyî
->
kî√lSètsSt‹age
->
biosInP¨tül
.
disˇrd
);

1352 
	`•ö_u∆ock
(&
œyî
->
°©sLock
);

1353  
ªtvÆ
;

1354 
	}
}

1356 
PoﬁSètsAâribuã
 
	gpoﬁSètsBiosInP¨tülDisˇrdAâr
 = {

1357 .
©å
 = { .
«me
 = "bios_ö_∑πül_disˇrd", .
	gmode
 = 0444, },

1358 .
	gshow
 = 
poﬁSètsBiosInP¨tülDisˇrdShow
,

1363 
ssize_t
 
	$poﬁSètsBiosInP¨tülFlushShow
(
Kî√lLayî
 *
œyî
, *
buf
)

1365 
ssize_t
 
ªtvÆ
;

1366 
	`•ö_lock
(&
œyî
->
°©sLock
);

1367 
	`gëKî√lSèts
(
œyî
,Üayî->
kî√lSètsSt‹age
);

1368 
ªtvÆ
 = 
	`•rötf
(
buf
, "%" 
PRIu64
 "\n", 
œyî
->
kî√lSètsSt‹age
->
biosInP¨tül
.
Êush
);

1369 
	`•ö_u∆ock
(&
œyî
->
°©sLock
);

1370  
ªtvÆ
;

1371 
	}
}

1373 
PoﬁSètsAâribuã
 
	gpoﬁSètsBiosInP¨tülFlushAâr
 = {

1374 .
©å
 = { .
«me
 = "bios_ö_∑πül_Êush", .
	gmode
 = 0444, },

1375 .
	gshow
 = 
poﬁSètsBiosInP¨tülFlushShow
,

1380 
ssize_t
 
	$poﬁSètsBiosInP¨tülFuaShow
(
Kî√lLayî
 *
œyî
, *
buf
)

1382 
ssize_t
 
ªtvÆ
;

1383 
	`•ö_lock
(&
œyî
->
°©sLock
);

1384 
	`gëKî√lSèts
(
œyî
,Üayî->
kî√lSètsSt‹age
);

1385 
ªtvÆ
 = 
	`•rötf
(
buf
, "%" 
PRIu64
 "\n", 
œyî
->
kî√lSètsSt‹age
->
biosInP¨tül
.
fua
);

1386 
	`•ö_u∆ock
(&
œyî
->
°©sLock
);

1387  
ªtvÆ
;

1388 
	}
}

1390 
PoﬁSètsAâribuã
 
	gpoﬁSètsBiosInP¨tülFuaAâr
 = {

1391 .
©å
 = { .
«me
 = "bios_ö_∑πül_fua", .
	gmode
 = 0444, },

1392 .
	gshow
 = 
poﬁSètsBiosInP¨tülFuaShow
,

1397 
ssize_t
 
	$poﬁSètsBiosOutRódShow
(
Kî√lLayî
 *
œyî
, *
buf
)

1399 
ssize_t
 
ªtvÆ
;

1400 
	`•ö_lock
(&
œyî
->
°©sLock
);

1401 
	`gëKî√lSèts
(
œyî
,Üayî->
kî√lSètsSt‹age
);

1402 
ªtvÆ
 = 
	`•rötf
(
buf
, "%" 
PRIu64
 "\n", 
œyî
->
kî√lSètsSt‹age
->
biosOut
.
ªad
);

1403 
	`•ö_u∆ock
(&
œyî
->
°©sLock
);

1404  
ªtvÆ
;

1405 
	}
}

1407 
PoﬁSètsAâribuã
 
	gpoﬁSètsBiosOutRódAâr
 = {

1408 .
©å
 = { .
«me
 = "bios_out_ªad", .
	gmode
 = 0444, },

1409 .
	gshow
 = 
poﬁSètsBiosOutRódShow
,

1414 
ssize_t
 
	$poﬁSètsBiosOutWrôeShow
(
Kî√lLayî
 *
œyî
, *
buf
)

1416 
ssize_t
 
ªtvÆ
;

1417 
	`•ö_lock
(&
œyî
->
°©sLock
);

1418 
	`gëKî√lSèts
(
œyî
,Üayî->
kî√lSètsSt‹age
);

1419 
ªtvÆ
 = 
	`•rötf
(
buf
, "%" 
PRIu64
 "\n", 
œyî
->
kî√lSètsSt‹age
->
biosOut
.
wrôe
);

1420 
	`•ö_u∆ock
(&
œyî
->
°©sLock
);

1421  
ªtvÆ
;

1422 
	}
}

1424 
PoﬁSètsAâribuã
 
	gpoﬁSètsBiosOutWrôeAâr
 = {

1425 .
©å
 = { .
«me
 = "bios_out_wrôe", .
	gmode
 = 0444, },

1426 .
	gshow
 = 
poﬁSètsBiosOutWrôeShow
,

1431 
ssize_t
 
	$poﬁSètsBiosOutDisˇrdShow
(
Kî√lLayî
 *
œyî
, *
buf
)

1433 
ssize_t
 
ªtvÆ
;

1434 
	`•ö_lock
(&
œyî
->
°©sLock
);

1435 
	`gëKî√lSèts
(
œyî
,Üayî->
kî√lSètsSt‹age
);

1436 
ªtvÆ
 = 
	`•rötf
(
buf
, "%" 
PRIu64
 "\n", 
œyî
->
kî√lSètsSt‹age
->
biosOut
.
disˇrd
);

1437 
	`•ö_u∆ock
(&
œyî
->
°©sLock
);

1438  
ªtvÆ
;

1439 
	}
}

1441 
PoﬁSètsAâribuã
 
	gpoﬁSètsBiosOutDisˇrdAâr
 = {

1442 .
©å
 = { .
«me
 = "bios_out_disˇrd", .
	gmode
 = 0444, },

1443 .
	gshow
 = 
poﬁSètsBiosOutDisˇrdShow
,

1448 
ssize_t
 
	$poﬁSètsBiosOutFlushShow
(
Kî√lLayî
 *
œyî
, *
buf
)

1450 
ssize_t
 
ªtvÆ
;

1451 
	`•ö_lock
(&
œyî
->
°©sLock
);

1452 
	`gëKî√lSèts
(
œyî
,Üayî->
kî√lSètsSt‹age
);

1453 
ªtvÆ
 = 
	`•rötf
(
buf
, "%" 
PRIu64
 "\n", 
œyî
->
kî√lSètsSt‹age
->
biosOut
.
Êush
);

1454 
	`•ö_u∆ock
(&
œyî
->
°©sLock
);

1455  
ªtvÆ
;

1456 
	}
}

1458 
PoﬁSètsAâribuã
 
	gpoﬁSètsBiosOutFlushAâr
 = {

1459 .
©å
 = { .
«me
 = "bios_out_Êush", .
	gmode
 = 0444, },

1460 .
	gshow
 = 
poﬁSètsBiosOutFlushShow
,

1465 
ssize_t
 
	$poﬁSètsBiosOutFuaShow
(
Kî√lLayî
 *
œyî
, *
buf
)

1467 
ssize_t
 
ªtvÆ
;

1468 
	`•ö_lock
(&
œyî
->
°©sLock
);

1469 
	`gëKî√lSèts
(
œyî
,Üayî->
kî√lSètsSt‹age
);

1470 
ªtvÆ
 = 
	`•rötf
(
buf
, "%" 
PRIu64
 "\n", 
œyî
->
kî√lSètsSt‹age
->
biosOut
.
fua
);

1471 
	`•ö_u∆ock
(&
œyî
->
°©sLock
);

1472  
ªtvÆ
;

1473 
	}
}

1475 
PoﬁSètsAâribuã
 
	gpoﬁSètsBiosOutFuaAâr
 = {

1476 .
©å
 = { .
«me
 = "bios_out_fua", .
	gmode
 = 0444, },

1477 .
	gshow
 = 
poﬁSètsBiosOutFuaShow
,

1482 
ssize_t
 
	$poﬁSètsBiosMëaRódShow
(
Kî√lLayî
 *
œyî
, *
buf
)

1484 
ssize_t
 
ªtvÆ
;

1485 
	`•ö_lock
(&
œyî
->
°©sLock
);

1486 
	`gëKî√lSèts
(
œyî
,Üayî->
kî√lSètsSt‹age
);

1487 
ªtvÆ
 = 
	`•rötf
(
buf
, "%" 
PRIu64
 "\n", 
œyî
->
kî√lSètsSt‹age
->
biosMëa
.
ªad
);

1488 
	`•ö_u∆ock
(&
œyî
->
°©sLock
);

1489  
ªtvÆ
;

1490 
	}
}

1492 
PoﬁSètsAâribuã
 
	gpoﬁSètsBiosMëaRódAâr
 = {

1493 .
©å
 = { .
«me
 = "bios_mëa_ªad", .
	gmode
 = 0444, },

1494 .
	gshow
 = 
poﬁSètsBiosMëaRódShow
,

1499 
ssize_t
 
	$poﬁSètsBiosMëaWrôeShow
(
Kî√lLayî
 *
œyî
, *
buf
)

1501 
ssize_t
 
ªtvÆ
;

1502 
	`•ö_lock
(&
œyî
->
°©sLock
);

1503 
	`gëKî√lSèts
(
œyî
,Üayî->
kî√lSètsSt‹age
);

1504 
ªtvÆ
 = 
	`•rötf
(
buf
, "%" 
PRIu64
 "\n", 
œyî
->
kî√lSètsSt‹age
->
biosMëa
.
wrôe
);

1505 
	`•ö_u∆ock
(&
œyî
->
°©sLock
);

1506  
ªtvÆ
;

1507 
	}
}

1509 
PoﬁSètsAâribuã
 
	gpoﬁSètsBiosMëaWrôeAâr
 = {

1510 .
©å
 = { .
«me
 = "bios_mëa_wrôe", .
	gmode
 = 0444, },

1511 .
	gshow
 = 
poﬁSètsBiosMëaWrôeShow
,

1516 
ssize_t
 
	$poﬁSètsBiosMëaDisˇrdShow
(
Kî√lLayî
 *
œyî
, *
buf
)

1518 
ssize_t
 
ªtvÆ
;

1519 
	`•ö_lock
(&
œyî
->
°©sLock
);

1520 
	`gëKî√lSèts
(
œyî
,Üayî->
kî√lSètsSt‹age
);

1521 
ªtvÆ
 = 
	`•rötf
(
buf
, "%" 
PRIu64
 "\n", 
œyî
->
kî√lSètsSt‹age
->
biosMëa
.
disˇrd
);

1522 
	`•ö_u∆ock
(&
œyî
->
°©sLock
);

1523  
ªtvÆ
;

1524 
	}
}

1526 
PoﬁSètsAâribuã
 
	gpoﬁSètsBiosMëaDisˇrdAâr
 = {

1527 .
©å
 = { .
«me
 = "bios_mëa_disˇrd", .
	gmode
 = 0444, },

1528 .
	gshow
 = 
poﬁSètsBiosMëaDisˇrdShow
,

1533 
ssize_t
 
	$poﬁSètsBiosMëaFlushShow
(
Kî√lLayî
 *
œyî
, *
buf
)

1535 
ssize_t
 
ªtvÆ
;

1536 
	`•ö_lock
(&
œyî
->
°©sLock
);

1537 
	`gëKî√lSèts
(
œyî
,Üayî->
kî√lSètsSt‹age
);

1538 
ªtvÆ
 = 
	`•rötf
(
buf
, "%" 
PRIu64
 "\n", 
œyî
->
kî√lSètsSt‹age
->
biosMëa
.
Êush
);

1539 
	`•ö_u∆ock
(&
œyî
->
°©sLock
);

1540  
ªtvÆ
;

1541 
	}
}

1543 
PoﬁSètsAâribuã
 
	gpoﬁSètsBiosMëaFlushAâr
 = {

1544 .
©å
 = { .
«me
 = "bios_mëa_Êush", .
	gmode
 = 0444, },

1545 .
	gshow
 = 
poﬁSètsBiosMëaFlushShow
,

1550 
ssize_t
 
	$poﬁSètsBiosMëaFuaShow
(
Kî√lLayî
 *
œyî
, *
buf
)

1552 
ssize_t
 
ªtvÆ
;

1553 
	`•ö_lock
(&
œyî
->
°©sLock
);

1554 
	`gëKî√lSèts
(
œyî
,Üayî->
kî√lSètsSt‹age
);

1555 
ªtvÆ
 = 
	`•rötf
(
buf
, "%" 
PRIu64
 "\n", 
œyî
->
kî√lSètsSt‹age
->
biosMëa
.
fua
);

1556 
	`•ö_u∆ock
(&
œyî
->
°©sLock
);

1557  
ªtvÆ
;

1558 
	}
}

1560 
PoﬁSètsAâribuã
 
	gpoﬁSètsBiosMëaFuaAâr
 = {

1561 .
©å
 = { .
«me
 = "bios_mëa_fua", .
	gmode
 = 0444, },

1562 .
	gshow
 = 
poﬁSètsBiosMëaFuaShow
,

1567 
ssize_t
 
	$poﬁSètsBiosJou∫ÆRódShow
(
Kî√lLayî
 *
œyî
, *
buf
)

1569 
ssize_t
 
ªtvÆ
;

1570 
	`•ö_lock
(&
œyî
->
°©sLock
);

1571 
	`gëKî√lSèts
(
œyî
,Üayî->
kî√lSètsSt‹age
);

1572 
ªtvÆ
 = 
	`•rötf
(
buf
, "%" 
PRIu64
 "\n", 
œyî
->
kî√lSètsSt‹age
->
biosJou∫Æ
.
ªad
);

1573 
	`•ö_u∆ock
(&
œyî
->
°©sLock
);

1574  
ªtvÆ
;

1575 
	}
}

1577 
PoﬁSètsAâribuã
 
	gpoﬁSètsBiosJou∫ÆRódAâr
 = {

1578 .
©å
 = { .
«me
 = "bios_jou∫Æ_ªad", .
	gmode
 = 0444, },

1579 .
	gshow
 = 
poﬁSètsBiosJou∫ÆRódShow
,

1584 
ssize_t
 
	$poﬁSètsBiosJou∫ÆWrôeShow
(
Kî√lLayî
 *
œyî
, *
buf
)

1586 
ssize_t
 
ªtvÆ
;

1587 
	`•ö_lock
(&
œyî
->
°©sLock
);

1588 
	`gëKî√lSèts
(
œyî
,Üayî->
kî√lSètsSt‹age
);

1589 
ªtvÆ
 = 
	`•rötf
(
buf
, "%" 
PRIu64
 "\n", 
œyî
->
kî√lSètsSt‹age
->
biosJou∫Æ
.
wrôe
);

1590 
	`•ö_u∆ock
(&
œyî
->
°©sLock
);

1591  
ªtvÆ
;

1592 
	}
}

1594 
PoﬁSètsAâribuã
 
	gpoﬁSètsBiosJou∫ÆWrôeAâr
 = {

1595 .
©å
 = { .
«me
 = "bios_jou∫Æ_wrôe", .
	gmode
 = 0444, },

1596 .
	gshow
 = 
poﬁSètsBiosJou∫ÆWrôeShow
,

1601 
ssize_t
 
	$poﬁSètsBiosJou∫ÆDisˇrdShow
(
Kî√lLayî
 *
œyî
, *
buf
)

1603 
ssize_t
 
ªtvÆ
;

1604 
	`•ö_lock
(&
œyî
->
°©sLock
);

1605 
	`gëKî√lSèts
(
œyî
,Üayî->
kî√lSètsSt‹age
);

1606 
ªtvÆ
 = 
	`•rötf
(
buf
, "%" 
PRIu64
 "\n", 
œyî
->
kî√lSètsSt‹age
->
biosJou∫Æ
.
disˇrd
);

1607 
	`•ö_u∆ock
(&
œyî
->
°©sLock
);

1608  
ªtvÆ
;

1609 
	}
}

1611 
PoﬁSètsAâribuã
 
	gpoﬁSètsBiosJou∫ÆDisˇrdAâr
 = {

1612 .
©å
 = { .
«me
 = "bios_jou∫Æ_disˇrd", .
	gmode
 = 0444, },

1613 .
	gshow
 = 
poﬁSètsBiosJou∫ÆDisˇrdShow
,

1618 
ssize_t
 
	$poﬁSètsBiosJou∫ÆFlushShow
(
Kî√lLayî
 *
œyî
, *
buf
)

1620 
ssize_t
 
ªtvÆ
;

1621 
	`•ö_lock
(&
œyî
->
°©sLock
);

1622 
	`gëKî√lSèts
(
œyî
,Üayî->
kî√lSètsSt‹age
);

1623 
ªtvÆ
 = 
	`•rötf
(
buf
, "%" 
PRIu64
 "\n", 
œyî
->
kî√lSètsSt‹age
->
biosJou∫Æ
.
Êush
);

1624 
	`•ö_u∆ock
(&
œyî
->
°©sLock
);

1625  
ªtvÆ
;

1626 
	}
}

1628 
PoﬁSètsAâribuã
 
	gpoﬁSètsBiosJou∫ÆFlushAâr
 = {

1629 .
©å
 = { .
«me
 = "bios_jou∫Æ_Êush", .
	gmode
 = 0444, },

1630 .
	gshow
 = 
poﬁSètsBiosJou∫ÆFlushShow
,

1635 
ssize_t
 
	$poﬁSètsBiosJou∫ÆFuaShow
(
Kî√lLayî
 *
œyî
, *
buf
)

1637 
ssize_t
 
ªtvÆ
;

1638 
	`•ö_lock
(&
œyî
->
°©sLock
);

1639 
	`gëKî√lSèts
(
œyî
,Üayî->
kî√lSètsSt‹age
);

1640 
ªtvÆ
 = 
	`•rötf
(
buf
, "%" 
PRIu64
 "\n", 
œyî
->
kî√lSètsSt‹age
->
biosJou∫Æ
.
fua
);

1641 
	`•ö_u∆ock
(&
œyî
->
°©sLock
);

1642  
ªtvÆ
;

1643 
	}
}

1645 
PoﬁSètsAâribuã
 
	gpoﬁSètsBiosJou∫ÆFuaAâr
 = {

1646 .
©å
 = { .
«me
 = "bios_jou∫Æ_fua", .
	gmode
 = 0444, },

1647 .
	gshow
 = 
poﬁSètsBiosJou∫ÆFuaShow
,

1652 
ssize_t
 
	$poﬁSètsBiosPageCacheRódShow
(
Kî√lLayî
 *
œyî
, *
buf
)

1654 
ssize_t
 
ªtvÆ
;

1655 
	`•ö_lock
(&
œyî
->
°©sLock
);

1656 
	`gëKî√lSèts
(
œyî
,Üayî->
kî√lSètsSt‹age
);

1657 
ªtvÆ
 = 
	`•rötf
(
buf
, "%" 
PRIu64
 "\n", 
œyî
->
kî√lSètsSt‹age
->
biosPageCache
.
ªad
);

1658 
	`•ö_u∆ock
(&
œyî
->
°©sLock
);

1659  
ªtvÆ
;

1660 
	}
}

1662 
PoﬁSètsAâribuã
 
	gpoﬁSètsBiosPageCacheRódAâr
 = {

1663 .
©å
 = { .
«me
 = "bios_∑ge_ˇche_ªad", .
	gmode
 = 0444, },

1664 .
	gshow
 = 
poﬁSètsBiosPageCacheRódShow
,

1669 
ssize_t
 
	$poﬁSètsBiosPageCacheWrôeShow
(
Kî√lLayî
 *
œyî
, *
buf
)

1671 
ssize_t
 
ªtvÆ
;

1672 
	`•ö_lock
(&
œyî
->
°©sLock
);

1673 
	`gëKî√lSèts
(
œyî
,Üayî->
kî√lSètsSt‹age
);

1674 
ªtvÆ
 = 
	`•rötf
(
buf
, "%" 
PRIu64
 "\n", 
œyî
->
kî√lSètsSt‹age
->
biosPageCache
.
wrôe
);

1675 
	`•ö_u∆ock
(&
œyî
->
°©sLock
);

1676  
ªtvÆ
;

1677 
	}
}

1679 
PoﬁSètsAâribuã
 
	gpoﬁSètsBiosPageCacheWrôeAâr
 = {

1680 .
©å
 = { .
«me
 = "bios_∑ge_ˇche_wrôe", .
	gmode
 = 0444, },

1681 .
	gshow
 = 
poﬁSètsBiosPageCacheWrôeShow
,

1686 
ssize_t
 
	$poﬁSètsBiosPageCacheDisˇrdShow
(
Kî√lLayî
 *
œyî
, *
buf
)

1688 
ssize_t
 
ªtvÆ
;

1689 
	`•ö_lock
(&
œyî
->
°©sLock
);

1690 
	`gëKî√lSèts
(
œyî
,Üayî->
kî√lSètsSt‹age
);

1691 
ªtvÆ
 = 
	`•rötf
(
buf
, "%" 
PRIu64
 "\n", 
œyî
->
kî√lSètsSt‹age
->
biosPageCache
.
disˇrd
);

1692 
	`•ö_u∆ock
(&
œyî
->
°©sLock
);

1693  
ªtvÆ
;

1694 
	}
}

1696 
PoﬁSètsAâribuã
 
	gpoﬁSètsBiosPageCacheDisˇrdAâr
 = {

1697 .
©å
 = { .
«me
 = "bios_∑ge_ˇche_disˇrd", .
	gmode
 = 0444, },

1698 .
	gshow
 = 
poﬁSètsBiosPageCacheDisˇrdShow
,

1703 
ssize_t
 
	$poﬁSètsBiosPageCacheFlushShow
(
Kî√lLayî
 *
œyî
, *
buf
)

1705 
ssize_t
 
ªtvÆ
;

1706 
	`•ö_lock
(&
œyî
->
°©sLock
);

1707 
	`gëKî√lSèts
(
œyî
,Üayî->
kî√lSètsSt‹age
);

1708 
ªtvÆ
 = 
	`•rötf
(
buf
, "%" 
PRIu64
 "\n", 
œyî
->
kî√lSètsSt‹age
->
biosPageCache
.
Êush
);

1709 
	`•ö_u∆ock
(&
œyî
->
°©sLock
);

1710  
ªtvÆ
;

1711 
	}
}

1713 
PoﬁSètsAâribuã
 
	gpoﬁSètsBiosPageCacheFlushAâr
 = {

1714 .
©å
 = { .
«me
 = "bios_∑ge_ˇche_Êush", .
	gmode
 = 0444, },

1715 .
	gshow
 = 
poﬁSètsBiosPageCacheFlushShow
,

1720 
ssize_t
 
	$poﬁSètsBiosPageCacheFuaShow
(
Kî√lLayî
 *
œyî
, *
buf
)

1722 
ssize_t
 
ªtvÆ
;

1723 
	`•ö_lock
(&
œyî
->
°©sLock
);

1724 
	`gëKî√lSèts
(
œyî
,Üayî->
kî√lSètsSt‹age
);

1725 
ªtvÆ
 = 
	`•rötf
(
buf
, "%" 
PRIu64
 "\n", 
œyî
->
kî√lSètsSt‹age
->
biosPageCache
.
fua
);

1726 
	`•ö_u∆ock
(&
œyî
->
°©sLock
);

1727  
ªtvÆ
;

1728 
	}
}

1730 
PoﬁSètsAâribuã
 
	gpoﬁSètsBiosPageCacheFuaAâr
 = {

1731 .
©å
 = { .
«me
 = "bios_∑ge_ˇche_fua", .
	gmode
 = 0444, },

1732 .
	gshow
 = 
poﬁSètsBiosPageCacheFuaShow
,

1737 
ssize_t
 
	$poﬁSètsBiosOutCom∂ëedRódShow
(
Kî√lLayî
 *
œyî
, *
buf
)

1739 
ssize_t
 
ªtvÆ
;

1740 
	`•ö_lock
(&
œyî
->
°©sLock
);

1741 
	`gëKî√lSèts
(
œyî
,Üayî->
kî√lSètsSt‹age
);

1742 
ªtvÆ
 = 
	`•rötf
(
buf
, "%" 
PRIu64
 "\n", 
œyî
->
kî√lSètsSt‹age
->
biosOutCom∂ëed
.
ªad
);

1743 
	`•ö_u∆ock
(&
œyî
->
°©sLock
);

1744  
ªtvÆ
;

1745 
	}
}

1747 
PoﬁSètsAâribuã
 
	gpoﬁSètsBiosOutCom∂ëedRódAâr
 = {

1748 .
©å
 = { .
«me
 = "bios_out_com∂ëed_ªad", .
	gmode
 = 0444, },

1749 .
	gshow
 = 
poﬁSètsBiosOutCom∂ëedRódShow
,

1754 
ssize_t
 
	$poﬁSètsBiosOutCom∂ëedWrôeShow
(
Kî√lLayî
 *
œyî
, *
buf
)

1756 
ssize_t
 
ªtvÆ
;

1757 
	`•ö_lock
(&
œyî
->
°©sLock
);

1758 
	`gëKî√lSèts
(
œyî
,Üayî->
kî√lSètsSt‹age
);

1759 
ªtvÆ
 = 
	`•rötf
(
buf
, "%" 
PRIu64
 "\n", 
œyî
->
kî√lSètsSt‹age
->
biosOutCom∂ëed
.
wrôe
);

1760 
	`•ö_u∆ock
(&
œyî
->
°©sLock
);

1761  
ªtvÆ
;

1762 
	}
}

1764 
PoﬁSètsAâribuã
 
	gpoﬁSètsBiosOutCom∂ëedWrôeAâr
 = {

1765 .
©å
 = { .
«me
 = "bios_out_com∂ëed_wrôe", .
	gmode
 = 0444, },

1766 .
	gshow
 = 
poﬁSètsBiosOutCom∂ëedWrôeShow
,

1771 
ssize_t
 
	$poﬁSètsBiosOutCom∂ëedDisˇrdShow
(
Kî√lLayî
 *
œyî
, *
buf
)

1773 
ssize_t
 
ªtvÆ
;

1774 
	`•ö_lock
(&
œyî
->
°©sLock
);

1775 
	`gëKî√lSèts
(
œyî
,Üayî->
kî√lSètsSt‹age
);

1776 
ªtvÆ
 = 
	`•rötf
(
buf
, "%" 
PRIu64
 "\n", 
œyî
->
kî√lSètsSt‹age
->
biosOutCom∂ëed
.
disˇrd
);

1777 
	`•ö_u∆ock
(&
œyî
->
°©sLock
);

1778  
ªtvÆ
;

1779 
	}
}

1781 
PoﬁSètsAâribuã
 
	gpoﬁSètsBiosOutCom∂ëedDisˇrdAâr
 = {

1782 .
©å
 = { .
«me
 = "bios_out_com∂ëed_disˇrd", .
	gmode
 = 0444, },

1783 .
	gshow
 = 
poﬁSètsBiosOutCom∂ëedDisˇrdShow
,

1788 
ssize_t
 
	$poﬁSètsBiosOutCom∂ëedFlushShow
(
Kî√lLayî
 *
œyî
, *
buf
)

1790 
ssize_t
 
ªtvÆ
;

1791 
	`•ö_lock
(&
œyî
->
°©sLock
);

1792 
	`gëKî√lSèts
(
œyî
,Üayî->
kî√lSètsSt‹age
);

1793 
ªtvÆ
 = 
	`•rötf
(
buf
, "%" 
PRIu64
 "\n", 
œyî
->
kî√lSètsSt‹age
->
biosOutCom∂ëed
.
Êush
);

1794 
	`•ö_u∆ock
(&
œyî
->
°©sLock
);

1795  
ªtvÆ
;

1796 
	}
}

1798 
PoﬁSètsAâribuã
 
	gpoﬁSètsBiosOutCom∂ëedFlushAâr
 = {

1799 .
©å
 = { .
«me
 = "bios_out_com∂ëed_Êush", .
	gmode
 = 0444, },

1800 .
	gshow
 = 
poﬁSètsBiosOutCom∂ëedFlushShow
,

1805 
ssize_t
 
	$poﬁSètsBiosOutCom∂ëedFuaShow
(
Kî√lLayî
 *
œyî
, *
buf
)

1807 
ssize_t
 
ªtvÆ
;

1808 
	`•ö_lock
(&
œyî
->
°©sLock
);

1809 
	`gëKî√lSèts
(
œyî
,Üayî->
kî√lSètsSt‹age
);

1810 
ªtvÆ
 = 
	`•rötf
(
buf
, "%" 
PRIu64
 "\n", 
œyî
->
kî√lSètsSt‹age
->
biosOutCom∂ëed
.
fua
);

1811 
	`•ö_u∆ock
(&
œyî
->
°©sLock
);

1812  
ªtvÆ
;

1813 
	}
}

1815 
PoﬁSètsAâribuã
 
	gpoﬁSètsBiosOutCom∂ëedFuaAâr
 = {

1816 .
©å
 = { .
«me
 = "bios_out_com∂ëed_fua", .
	gmode
 = 0444, },

1817 .
	gshow
 = 
poﬁSètsBiosOutCom∂ëedFuaShow
,

1822 
ssize_t
 
	$poﬁSètsBiosMëaCom∂ëedRódShow
(
Kî√lLayî
 *
œyî
, *
buf
)

1824 
ssize_t
 
ªtvÆ
;

1825 
	`•ö_lock
(&
œyî
->
°©sLock
);

1826 
	`gëKî√lSèts
(
œyî
,Üayî->
kî√lSètsSt‹age
);

1827 
ªtvÆ
 = 
	`•rötf
(
buf
, "%" 
PRIu64
 "\n", 
œyî
->
kî√lSètsSt‹age
->
biosMëaCom∂ëed
.
ªad
);

1828 
	`•ö_u∆ock
(&
œyî
->
°©sLock
);

1829  
ªtvÆ
;

1830 
	}
}

1832 
PoﬁSètsAâribuã
 
	gpoﬁSètsBiosMëaCom∂ëedRódAâr
 = {

1833 .
©å
 = { .
«me
 = "bios_mëa_com∂ëed_ªad", .
	gmode
 = 0444, },

1834 .
	gshow
 = 
poﬁSètsBiosMëaCom∂ëedRódShow
,

1839 
ssize_t
 
	$poﬁSètsBiosMëaCom∂ëedWrôeShow
(
Kî√lLayî
 *
œyî
, *
buf
)

1841 
ssize_t
 
ªtvÆ
;

1842 
	`•ö_lock
(&
œyî
->
°©sLock
);

1843 
	`gëKî√lSèts
(
œyî
,Üayî->
kî√lSètsSt‹age
);

1844 
ªtvÆ
 = 
	`•rötf
(
buf
, "%" 
PRIu64
 "\n", 
œyî
->
kî√lSètsSt‹age
->
biosMëaCom∂ëed
.
wrôe
);

1845 
	`•ö_u∆ock
(&
œyî
->
°©sLock
);

1846  
ªtvÆ
;

1847 
	}
}

1849 
PoﬁSètsAâribuã
 
	gpoﬁSètsBiosMëaCom∂ëedWrôeAâr
 = {

1850 .
©å
 = { .
«me
 = "bios_mëa_com∂ëed_wrôe", .
	gmode
 = 0444, },

1851 .
	gshow
 = 
poﬁSètsBiosMëaCom∂ëedWrôeShow
,

1856 
ssize_t
 
	$poﬁSètsBiosMëaCom∂ëedDisˇrdShow
(
Kî√lLayî
 *
œyî
, *
buf
)

1858 
ssize_t
 
ªtvÆ
;

1859 
	`•ö_lock
(&
œyî
->
°©sLock
);

1860 
	`gëKî√lSèts
(
œyî
,Üayî->
kî√lSètsSt‹age
);

1861 
ªtvÆ
 = 
	`•rötf
(
buf
, "%" 
PRIu64
 "\n", 
œyî
->
kî√lSètsSt‹age
->
biosMëaCom∂ëed
.
disˇrd
);

1862 
	`•ö_u∆ock
(&
œyî
->
°©sLock
);

1863  
ªtvÆ
;

1864 
	}
}

1866 
PoﬁSètsAâribuã
 
	gpoﬁSètsBiosMëaCom∂ëedDisˇrdAâr
 = {

1867 .
©å
 = { .
«me
 = "bios_mëa_com∂ëed_disˇrd", .
	gmode
 = 0444, },

1868 .
	gshow
 = 
poﬁSètsBiosMëaCom∂ëedDisˇrdShow
,

1873 
ssize_t
 
	$poﬁSètsBiosMëaCom∂ëedFlushShow
(
Kî√lLayî
 *
œyî
, *
buf
)

1875 
ssize_t
 
ªtvÆ
;

1876 
	`•ö_lock
(&
œyî
->
°©sLock
);

1877 
	`gëKî√lSèts
(
œyî
,Üayî->
kî√lSètsSt‹age
);

1878 
ªtvÆ
 = 
	`•rötf
(
buf
, "%" 
PRIu64
 "\n", 
œyî
->
kî√lSètsSt‹age
->
biosMëaCom∂ëed
.
Êush
);

1879 
	`•ö_u∆ock
(&
œyî
->
°©sLock
);

1880  
ªtvÆ
;

1881 
	}
}

1883 
PoﬁSètsAâribuã
 
	gpoﬁSètsBiosMëaCom∂ëedFlushAâr
 = {

1884 .
©å
 = { .
«me
 = "bios_mëa_com∂ëed_Êush", .
	gmode
 = 0444, },

1885 .
	gshow
 = 
poﬁSètsBiosMëaCom∂ëedFlushShow
,

1890 
ssize_t
 
	$poﬁSètsBiosMëaCom∂ëedFuaShow
(
Kî√lLayî
 *
œyî
, *
buf
)

1892 
ssize_t
 
ªtvÆ
;

1893 
	`•ö_lock
(&
œyî
->
°©sLock
);

1894 
	`gëKî√lSèts
(
œyî
,Üayî->
kî√lSètsSt‹age
);

1895 
ªtvÆ
 = 
	`•rötf
(
buf
, "%" 
PRIu64
 "\n", 
œyî
->
kî√lSètsSt‹age
->
biosMëaCom∂ëed
.
fua
);

1896 
	`•ö_u∆ock
(&
œyî
->
°©sLock
);

1897  
ªtvÆ
;

1898 
	}
}

1900 
PoﬁSètsAâribuã
 
	gpoﬁSètsBiosMëaCom∂ëedFuaAâr
 = {

1901 .
©å
 = { .
«me
 = "bios_mëa_com∂ëed_fua", .
	gmode
 = 0444, },

1902 .
	gshow
 = 
poﬁSètsBiosMëaCom∂ëedFuaShow
,

1907 
ssize_t
 
	$poﬁSètsBiosJou∫ÆCom∂ëedRódShow
(
Kî√lLayî
 *
œyî
, *
buf
)

1909 
ssize_t
 
ªtvÆ
;

1910 
	`•ö_lock
(&
œyî
->
°©sLock
);

1911 
	`gëKî√lSèts
(
œyî
,Üayî->
kî√lSètsSt‹age
);

1912 
ªtvÆ
 = 
	`•rötf
(
buf
, "%" 
PRIu64
 "\n", 
œyî
->
kî√lSètsSt‹age
->
biosJou∫ÆCom∂ëed
.
ªad
);

1913 
	`•ö_u∆ock
(&
œyî
->
°©sLock
);

1914  
ªtvÆ
;

1915 
	}
}

1917 
PoﬁSètsAâribuã
 
	gpoﬁSètsBiosJou∫ÆCom∂ëedRódAâr
 = {

1918 .
©å
 = { .
«me
 = "bios_jou∫Æ_com∂ëed_ªad", .
	gmode
 = 0444, },

1919 .
	gshow
 = 
poﬁSètsBiosJou∫ÆCom∂ëedRódShow
,

1924 
ssize_t
 
	$poﬁSètsBiosJou∫ÆCom∂ëedWrôeShow
(
Kî√lLayî
 *
œyî
, *
buf
)

1926 
ssize_t
 
ªtvÆ
;

1927 
	`•ö_lock
(&
œyî
->
°©sLock
);

1928 
	`gëKî√lSèts
(
œyî
,Üayî->
kî√lSètsSt‹age
);

1929 
ªtvÆ
 = 
	`•rötf
(
buf
, "%" 
PRIu64
 "\n", 
œyî
->
kî√lSètsSt‹age
->
biosJou∫ÆCom∂ëed
.
wrôe
);

1930 
	`•ö_u∆ock
(&
œyî
->
°©sLock
);

1931  
ªtvÆ
;

1932 
	}
}

1934 
PoﬁSètsAâribuã
 
	gpoﬁSètsBiosJou∫ÆCom∂ëedWrôeAâr
 = {

1935 .
©å
 = { .
«me
 = "bios_jou∫Æ_com∂ëed_wrôe", .
	gmode
 = 0444, },

1936 .
	gshow
 = 
poﬁSètsBiosJou∫ÆCom∂ëedWrôeShow
,

1941 
ssize_t
 
	$poﬁSètsBiosJou∫ÆCom∂ëedDisˇrdShow
(
Kî√lLayî
 *
œyî
, *
buf
)

1943 
ssize_t
 
ªtvÆ
;

1944 
	`•ö_lock
(&
œyî
->
°©sLock
);

1945 
	`gëKî√lSèts
(
œyî
,Üayî->
kî√lSètsSt‹age
);

1946 
ªtvÆ
 = 
	`•rötf
(
buf
, "%" 
PRIu64
 "\n", 
œyî
->
kî√lSètsSt‹age
->
biosJou∫ÆCom∂ëed
.
disˇrd
);

1947 
	`•ö_u∆ock
(&
œyî
->
°©sLock
);

1948  
ªtvÆ
;

1949 
	}
}

1951 
PoﬁSètsAâribuã
 
	gpoﬁSètsBiosJou∫ÆCom∂ëedDisˇrdAâr
 = {

1952 .
©å
 = { .
«me
 = "bios_jou∫Æ_com∂ëed_disˇrd", .
	gmode
 = 0444, },

1953 .
	gshow
 = 
poﬁSètsBiosJou∫ÆCom∂ëedDisˇrdShow
,

1958 
ssize_t
 
	$poﬁSètsBiosJou∫ÆCom∂ëedFlushShow
(
Kî√lLayî
 *
œyî
, *
buf
)

1960 
ssize_t
 
ªtvÆ
;

1961 
	`•ö_lock
(&
œyî
->
°©sLock
);

1962 
	`gëKî√lSèts
(
œyî
,Üayî->
kî√lSètsSt‹age
);

1963 
ªtvÆ
 = 
	`•rötf
(
buf
, "%" 
PRIu64
 "\n", 
œyî
->
kî√lSètsSt‹age
->
biosJou∫ÆCom∂ëed
.
Êush
);

1964 
	`•ö_u∆ock
(&
œyî
->
°©sLock
);

1965  
ªtvÆ
;

1966 
	}
}

1968 
PoﬁSètsAâribuã
 
	gpoﬁSètsBiosJou∫ÆCom∂ëedFlushAâr
 = {

1969 .
©å
 = { .
«me
 = "bios_jou∫Æ_com∂ëed_Êush", .
	gmode
 = 0444, },

1970 .
	gshow
 = 
poﬁSètsBiosJou∫ÆCom∂ëedFlushShow
,

1975 
ssize_t
 
	$poﬁSètsBiosJou∫ÆCom∂ëedFuaShow
(
Kî√lLayî
 *
œyî
, *
buf
)

1977 
ssize_t
 
ªtvÆ
;

1978 
	`•ö_lock
(&
œyî
->
°©sLock
);

1979 
	`gëKî√lSèts
(
œyî
,Üayî->
kî√lSètsSt‹age
);

1980 
ªtvÆ
 = 
	`•rötf
(
buf
, "%" 
PRIu64
 "\n", 
œyî
->
kî√lSètsSt‹age
->
biosJou∫ÆCom∂ëed
.
fua
);

1981 
	`•ö_u∆ock
(&
œyî
->
°©sLock
);

1982  
ªtvÆ
;

1983 
	}
}

1985 
PoﬁSètsAâribuã
 
	gpoﬁSètsBiosJou∫ÆCom∂ëedFuaAâr
 = {

1986 .
©å
 = { .
«me
 = "bios_jou∫Æ_com∂ëed_fua", .
	gmode
 = 0444, },

1987 .
	gshow
 = 
poﬁSètsBiosJou∫ÆCom∂ëedFuaShow
,

1992 
ssize_t
 
	$poﬁSètsBiosPageCacheCom∂ëedRódShow
(
Kî√lLayî
 *
œyî
, *
buf
)

1994 
ssize_t
 
ªtvÆ
;

1995 
	`•ö_lock
(&
œyî
->
°©sLock
);

1996 
	`gëKî√lSèts
(
œyî
,Üayî->
kî√lSètsSt‹age
);

1997 
ªtvÆ
 = 
	`•rötf
(
buf
, "%" 
PRIu64
 "\n", 
œyî
->
kî√lSètsSt‹age
->
biosPageCacheCom∂ëed
.
ªad
);

1998 
	`•ö_u∆ock
(&
œyî
->
°©sLock
);

1999  
ªtvÆ
;

2000 
	}
}

2002 
PoﬁSètsAâribuã
 
	gpoﬁSètsBiosPageCacheCom∂ëedRódAâr
 = {

2003 .
©å
 = { .
«me
 = "bios_∑ge_ˇche_com∂ëed_ªad", .
	gmode
 = 0444, },

2004 .
	gshow
 = 
poﬁSètsBiosPageCacheCom∂ëedRódShow
,

2009 
ssize_t
 
	$poﬁSètsBiosPageCacheCom∂ëedWrôeShow
(
Kî√lLayî
 *
œyî
, *
buf
)

2011 
ssize_t
 
ªtvÆ
;

2012 
	`•ö_lock
(&
œyî
->
°©sLock
);

2013 
	`gëKî√lSèts
(
œyî
,Üayî->
kî√lSètsSt‹age
);

2014 
ªtvÆ
 = 
	`•rötf
(
buf
, "%" 
PRIu64
 "\n", 
œyî
->
kî√lSètsSt‹age
->
biosPageCacheCom∂ëed
.
wrôe
);

2015 
	`•ö_u∆ock
(&
œyî
->
°©sLock
);

2016  
ªtvÆ
;

2017 
	}
}

2019 
PoﬁSètsAâribuã
 
	gpoﬁSètsBiosPageCacheCom∂ëedWrôeAâr
 = {

2020 .
©å
 = { .
«me
 = "bios_∑ge_ˇche_com∂ëed_wrôe", .
	gmode
 = 0444, },

2021 .
	gshow
 = 
poﬁSètsBiosPageCacheCom∂ëedWrôeShow
,

2026 
ssize_t
 
	$poﬁSètsBiosPageCacheCom∂ëedDisˇrdShow
(
Kî√lLayî
 *
œyî
, *
buf
)

2028 
ssize_t
 
ªtvÆ
;

2029 
	`•ö_lock
(&
œyî
->
°©sLock
);

2030 
	`gëKî√lSèts
(
œyî
,Üayî->
kî√lSètsSt‹age
);

2031 
ªtvÆ
 = 
	`•rötf
(
buf
, "%" 
PRIu64
 "\n", 
œyî
->
kî√lSètsSt‹age
->
biosPageCacheCom∂ëed
.
disˇrd
);

2032 
	`•ö_u∆ock
(&
œyî
->
°©sLock
);

2033  
ªtvÆ
;

2034 
	}
}

2036 
PoﬁSètsAâribuã
 
	gpoﬁSètsBiosPageCacheCom∂ëedDisˇrdAâr
 = {

2037 .
©å
 = { .
«me
 = "bios_∑ge_ˇche_com∂ëed_disˇrd", .
	gmode
 = 0444, },

2038 .
	gshow
 = 
poﬁSètsBiosPageCacheCom∂ëedDisˇrdShow
,

2043 
ssize_t
 
	$poﬁSètsBiosPageCacheCom∂ëedFlushShow
(
Kî√lLayî
 *
œyî
, *
buf
)

2045 
ssize_t
 
ªtvÆ
;

2046 
	`•ö_lock
(&
œyî
->
°©sLock
);

2047 
	`gëKî√lSèts
(
œyî
,Üayî->
kî√lSètsSt‹age
);

2048 
ªtvÆ
 = 
	`•rötf
(
buf
, "%" 
PRIu64
 "\n", 
œyî
->
kî√lSètsSt‹age
->
biosPageCacheCom∂ëed
.
Êush
);

2049 
	`•ö_u∆ock
(&
œyî
->
°©sLock
);

2050  
ªtvÆ
;

2051 
	}
}

2053 
PoﬁSètsAâribuã
 
	gpoﬁSètsBiosPageCacheCom∂ëedFlushAâr
 = {

2054 .
©å
 = { .
«me
 = "bios_∑ge_ˇche_com∂ëed_Êush", .
	gmode
 = 0444, },

2055 .
	gshow
 = 
poﬁSètsBiosPageCacheCom∂ëedFlushShow
,

2060 
ssize_t
 
	$poﬁSètsBiosPageCacheCom∂ëedFuaShow
(
Kî√lLayî
 *
œyî
, *
buf
)

2062 
ssize_t
 
ªtvÆ
;

2063 
	`•ö_lock
(&
œyî
->
°©sLock
);

2064 
	`gëKî√lSèts
(
œyî
,Üayî->
kî√lSètsSt‹age
);

2065 
ªtvÆ
 = 
	`•rötf
(
buf
, "%" 
PRIu64
 "\n", 
œyî
->
kî√lSètsSt‹age
->
biosPageCacheCom∂ëed
.
fua
);

2066 
	`•ö_u∆ock
(&
œyî
->
°©sLock
);

2067  
ªtvÆ
;

2068 
	}
}

2070 
PoﬁSètsAâribuã
 
	gpoﬁSètsBiosPageCacheCom∂ëedFuaAâr
 = {

2071 .
©å
 = { .
«me
 = "bios_∑ge_ˇche_com∂ëed_fua", .
	gmode
 = 0444, },

2072 .
	gshow
 = 
poﬁSètsBiosPageCacheCom∂ëedFuaShow
,

2077 
ssize_t
 
	$poﬁSètsBiosAcknowÀdgedRódShow
(
Kî√lLayî
 *
œyî
, *
buf
)

2079 
ssize_t
 
ªtvÆ
;

2080 
	`•ö_lock
(&
œyî
->
°©sLock
);

2081 
	`gëKî√lSèts
(
œyî
,Üayî->
kî√lSètsSt‹age
);

2082 
ªtvÆ
 = 
	`•rötf
(
buf
, "%" 
PRIu64
 "\n", 
œyî
->
kî√lSètsSt‹age
->
biosAcknowÀdged
.
ªad
);

2083 
	`•ö_u∆ock
(&
œyî
->
°©sLock
);

2084  
ªtvÆ
;

2085 
	}
}

2087 
PoﬁSètsAâribuã
 
	gpoﬁSètsBiosAcknowÀdgedRódAâr
 = {

2088 .
©å
 = { .
«me
 = "bios_acknowÀdged_ªad", .
	gmode
 = 0444, },

2089 .
	gshow
 = 
poﬁSètsBiosAcknowÀdgedRódShow
,

2094 
ssize_t
 
	$poﬁSètsBiosAcknowÀdgedWrôeShow
(
Kî√lLayî
 *
œyî
, *
buf
)

2096 
ssize_t
 
ªtvÆ
;

2097 
	`•ö_lock
(&
œyî
->
°©sLock
);

2098 
	`gëKî√lSèts
(
œyî
,Üayî->
kî√lSètsSt‹age
);

2099 
ªtvÆ
 = 
	`•rötf
(
buf
, "%" 
PRIu64
 "\n", 
œyî
->
kî√lSètsSt‹age
->
biosAcknowÀdged
.
wrôe
);

2100 
	`•ö_u∆ock
(&
œyî
->
°©sLock
);

2101  
ªtvÆ
;

2102 
	}
}

2104 
PoﬁSètsAâribuã
 
	gpoﬁSètsBiosAcknowÀdgedWrôeAâr
 = {

2105 .
©å
 = { .
«me
 = "bios_acknowÀdged_wrôe", .
	gmode
 = 0444, },

2106 .
	gshow
 = 
poﬁSètsBiosAcknowÀdgedWrôeShow
,

2111 
ssize_t
 
	$poﬁSètsBiosAcknowÀdgedDisˇrdShow
(
Kî√lLayî
 *
œyî
, *
buf
)

2113 
ssize_t
 
ªtvÆ
;

2114 
	`•ö_lock
(&
œyî
->
°©sLock
);

2115 
	`gëKî√lSèts
(
œyî
,Üayî->
kî√lSètsSt‹age
);

2116 
ªtvÆ
 = 
	`•rötf
(
buf
, "%" 
PRIu64
 "\n", 
œyî
->
kî√lSètsSt‹age
->
biosAcknowÀdged
.
disˇrd
);

2117 
	`•ö_u∆ock
(&
œyî
->
°©sLock
);

2118  
ªtvÆ
;

2119 
	}
}

2121 
PoﬁSètsAâribuã
 
	gpoﬁSètsBiosAcknowÀdgedDisˇrdAâr
 = {

2122 .
©å
 = { .
«me
 = "bios_acknowÀdged_disˇrd", .
	gmode
 = 0444, },

2123 .
	gshow
 = 
poﬁSètsBiosAcknowÀdgedDisˇrdShow
,

2128 
ssize_t
 
	$poﬁSètsBiosAcknowÀdgedFlushShow
(
Kî√lLayî
 *
œyî
, *
buf
)

2130 
ssize_t
 
ªtvÆ
;

2131 
	`•ö_lock
(&
œyî
->
°©sLock
);

2132 
	`gëKî√lSèts
(
œyî
,Üayî->
kî√lSètsSt‹age
);

2133 
ªtvÆ
 = 
	`•rötf
(
buf
, "%" 
PRIu64
 "\n", 
œyî
->
kî√lSètsSt‹age
->
biosAcknowÀdged
.
Êush
);

2134 
	`•ö_u∆ock
(&
œyî
->
°©sLock
);

2135  
ªtvÆ
;

2136 
	}
}

2138 
PoﬁSètsAâribuã
 
	gpoﬁSètsBiosAcknowÀdgedFlushAâr
 = {

2139 .
©å
 = { .
«me
 = "bios_acknowÀdged_Êush", .
	gmode
 = 0444, },

2140 .
	gshow
 = 
poﬁSètsBiosAcknowÀdgedFlushShow
,

2145 
ssize_t
 
	$poﬁSètsBiosAcknowÀdgedFuaShow
(
Kî√lLayî
 *
œyî
, *
buf
)

2147 
ssize_t
 
ªtvÆ
;

2148 
	`•ö_lock
(&
œyî
->
°©sLock
);

2149 
	`gëKî√lSèts
(
œyî
,Üayî->
kî√lSètsSt‹age
);

2150 
ªtvÆ
 = 
	`•rötf
(
buf
, "%" 
PRIu64
 "\n", 
œyî
->
kî√lSètsSt‹age
->
biosAcknowÀdged
.
fua
);

2151 
	`•ö_u∆ock
(&
œyî
->
°©sLock
);

2152  
ªtvÆ
;

2153 
	}
}

2155 
PoﬁSètsAâribuã
 
	gpoﬁSètsBiosAcknowÀdgedFuaAâr
 = {

2156 .
©å
 = { .
«me
 = "bios_acknowÀdged_fua", .
	gmode
 = 0444, },

2157 .
	gshow
 = 
poﬁSètsBiosAcknowÀdgedFuaShow
,

2162 
ssize_t
 
	$poﬁSètsBiosAcknowÀdgedP¨tülRódShow
(
Kî√lLayî
 *
œyî
, *
buf
)

2164 
ssize_t
 
ªtvÆ
;

2165 
	`•ö_lock
(&
œyî
->
°©sLock
);

2166 
	`gëKî√lSèts
(
œyî
,Üayî->
kî√lSètsSt‹age
);

2167 
ªtvÆ
 = 
	`•rötf
(
buf
, "%" 
PRIu64
 "\n", 
œyî
->
kî√lSètsSt‹age
->
biosAcknowÀdgedP¨tül
.
ªad
);

2168 
	`•ö_u∆ock
(&
œyî
->
°©sLock
);

2169  
ªtvÆ
;

2170 
	}
}

2172 
PoﬁSètsAâribuã
 
	gpoﬁSètsBiosAcknowÀdgedP¨tülRódAâr
 = {

2173 .
©å
 = { .
«me
 = "bios_acknowÀdged_∑πül_ªad", .
	gmode
 = 0444, },

2174 .
	gshow
 = 
poﬁSètsBiosAcknowÀdgedP¨tülRódShow
,

2179 
ssize_t
 
	$poﬁSètsBiosAcknowÀdgedP¨tülWrôeShow
(
Kî√lLayî
 *
œyî
, *
buf
)

2181 
ssize_t
 
ªtvÆ
;

2182 
	`•ö_lock
(&
œyî
->
°©sLock
);

2183 
	`gëKî√lSèts
(
œyî
,Üayî->
kî√lSètsSt‹age
);

2184 
ªtvÆ
 = 
	`•rötf
(
buf
, "%" 
PRIu64
 "\n", 
œyî
->
kî√lSètsSt‹age
->
biosAcknowÀdgedP¨tül
.
wrôe
);

2185 
	`•ö_u∆ock
(&
œyî
->
°©sLock
);

2186  
ªtvÆ
;

2187 
	}
}

2189 
PoﬁSètsAâribuã
 
	gpoﬁSètsBiosAcknowÀdgedP¨tülWrôeAâr
 = {

2190 .
©å
 = { .
«me
 = "bios_acknowÀdged_∑πül_wrôe", .
	gmode
 = 0444, },

2191 .
	gshow
 = 
poﬁSètsBiosAcknowÀdgedP¨tülWrôeShow
,

2196 
ssize_t
 
	$poﬁSètsBiosAcknowÀdgedP¨tülDisˇrdShow
(
Kî√lLayî
 *
œyî
, *
buf
)

2198 
ssize_t
 
ªtvÆ
;

2199 
	`•ö_lock
(&
œyî
->
°©sLock
);

2200 
	`gëKî√lSèts
(
œyî
,Üayî->
kî√lSètsSt‹age
);

2201 
ªtvÆ
 = 
	`•rötf
(
buf
, "%" 
PRIu64
 "\n", 
œyî
->
kî√lSètsSt‹age
->
biosAcknowÀdgedP¨tül
.
disˇrd
);

2202 
	`•ö_u∆ock
(&
œyî
->
°©sLock
);

2203  
ªtvÆ
;

2204 
	}
}

2206 
PoﬁSètsAâribuã
 
	gpoﬁSètsBiosAcknowÀdgedP¨tülDisˇrdAâr
 = {

2207 .
©å
 = { .
«me
 = "bios_acknowÀdged_∑πül_disˇrd", .
	gmode
 = 0444, },

2208 .
	gshow
 = 
poﬁSètsBiosAcknowÀdgedP¨tülDisˇrdShow
,

2213 
ssize_t
 
	$poﬁSètsBiosAcknowÀdgedP¨tülFlushShow
(
Kî√lLayî
 *
œyî
, *
buf
)

2215 
ssize_t
 
ªtvÆ
;

2216 
	`•ö_lock
(&
œyî
->
°©sLock
);

2217 
	`gëKî√lSèts
(
œyî
,Üayî->
kî√lSètsSt‹age
);

2218 
ªtvÆ
 = 
	`•rötf
(
buf
, "%" 
PRIu64
 "\n", 
œyî
->
kî√lSètsSt‹age
->
biosAcknowÀdgedP¨tül
.
Êush
);

2219 
	`•ö_u∆ock
(&
œyî
->
°©sLock
);

2220  
ªtvÆ
;

2221 
	}
}

2223 
PoﬁSètsAâribuã
 
	gpoﬁSètsBiosAcknowÀdgedP¨tülFlushAâr
 = {

2224 .
©å
 = { .
«me
 = "bios_acknowÀdged_∑πül_Êush", .
	gmode
 = 0444, },

2225 .
	gshow
 = 
poﬁSètsBiosAcknowÀdgedP¨tülFlushShow
,

2230 
ssize_t
 
	$poﬁSètsBiosAcknowÀdgedP¨tülFuaShow
(
Kî√lLayî
 *
œyî
, *
buf
)

2232 
ssize_t
 
ªtvÆ
;

2233 
	`•ö_lock
(&
œyî
->
°©sLock
);

2234 
	`gëKî√lSèts
(
œyî
,Üayî->
kî√lSètsSt‹age
);

2235 
ªtvÆ
 = 
	`•rötf
(
buf
, "%" 
PRIu64
 "\n", 
œyî
->
kî√lSètsSt‹age
->
biosAcknowÀdgedP¨tül
.
fua
);

2236 
	`•ö_u∆ock
(&
œyî
->
°©sLock
);

2237  
ªtvÆ
;

2238 
	}
}

2240 
PoﬁSètsAâribuã
 
	gpoﬁSètsBiosAcknowÀdgedP¨tülFuaAâr
 = {

2241 .
©å
 = { .
«me
 = "bios_acknowÀdged_∑πül_fua", .
	gmode
 = 0444, },

2242 .
	gshow
 = 
poﬁSètsBiosAcknowÀdgedP¨tülFuaShow
,

2247 
ssize_t
 
	$poﬁSètsBiosInProgªssRódShow
(
Kî√lLayî
 *
œyî
, *
buf
)

2249 
ssize_t
 
ªtvÆ
;

2250 
	`•ö_lock
(&
œyî
->
°©sLock
);

2251 
	`gëKî√lSèts
(
œyî
,Üayî->
kî√lSètsSt‹age
);

2252 
ªtvÆ
 = 
	`•rötf
(
buf
, "%" 
PRIu64
 "\n", 
œyî
->
kî√lSètsSt‹age
->
biosInProgªss
.
ªad
);

2253 
	`•ö_u∆ock
(&
œyî
->
°©sLock
);

2254  
ªtvÆ
;

2255 
	}
}

2257 
PoﬁSètsAâribuã
 
	gpoﬁSètsBiosInProgªssRódAâr
 = {

2258 .
©å
 = { .
«me
 = "bios_ö_¥ogªss_ªad", .
	gmode
 = 0444, },

2259 .
	gshow
 = 
poﬁSètsBiosInProgªssRódShow
,

2264 
ssize_t
 
	$poﬁSètsBiosInProgªssWrôeShow
(
Kî√lLayî
 *
œyî
, *
buf
)

2266 
ssize_t
 
ªtvÆ
;

2267 
	`•ö_lock
(&
œyî
->
°©sLock
);

2268 
	`gëKî√lSèts
(
œyî
,Üayî->
kî√lSètsSt‹age
);

2269 
ªtvÆ
 = 
	`•rötf
(
buf
, "%" 
PRIu64
 "\n", 
œyî
->
kî√lSètsSt‹age
->
biosInProgªss
.
wrôe
);

2270 
	`•ö_u∆ock
(&
œyî
->
°©sLock
);

2271  
ªtvÆ
;

2272 
	}
}

2274 
PoﬁSètsAâribuã
 
	gpoﬁSètsBiosInProgªssWrôeAâr
 = {

2275 .
©å
 = { .
«me
 = "bios_ö_¥ogªss_wrôe", .
	gmode
 = 0444, },

2276 .
	gshow
 = 
poﬁSètsBiosInProgªssWrôeShow
,

2281 
ssize_t
 
	$poﬁSètsBiosInProgªssDisˇrdShow
(
Kî√lLayî
 *
œyî
, *
buf
)

2283 
ssize_t
 
ªtvÆ
;

2284 
	`•ö_lock
(&
œyî
->
°©sLock
);

2285 
	`gëKî√lSèts
(
œyî
,Üayî->
kî√lSètsSt‹age
);

2286 
ªtvÆ
 = 
	`•rötf
(
buf
, "%" 
PRIu64
 "\n", 
œyî
->
kî√lSètsSt‹age
->
biosInProgªss
.
disˇrd
);

2287 
	`•ö_u∆ock
(&
œyî
->
°©sLock
);

2288  
ªtvÆ
;

2289 
	}
}

2291 
PoﬁSètsAâribuã
 
	gpoﬁSètsBiosInProgªssDisˇrdAâr
 = {

2292 .
©å
 = { .
«me
 = "bios_ö_¥ogªss_disˇrd", .
	gmode
 = 0444, },

2293 .
	gshow
 = 
poﬁSètsBiosInProgªssDisˇrdShow
,

2298 
ssize_t
 
	$poﬁSètsBiosInProgªssFlushShow
(
Kî√lLayî
 *
œyî
, *
buf
)

2300 
ssize_t
 
ªtvÆ
;

2301 
	`•ö_lock
(&
œyî
->
°©sLock
);

2302 
	`gëKî√lSèts
(
œyî
,Üayî->
kî√lSètsSt‹age
);

2303 
ªtvÆ
 = 
	`•rötf
(
buf
, "%" 
PRIu64
 "\n", 
œyî
->
kî√lSètsSt‹age
->
biosInProgªss
.
Êush
);

2304 
	`•ö_u∆ock
(&
œyî
->
°©sLock
);

2305  
ªtvÆ
;

2306 
	}
}

2308 
PoﬁSètsAâribuã
 
	gpoﬁSètsBiosInProgªssFlushAâr
 = {

2309 .
©å
 = { .
«me
 = "bios_ö_¥ogªss_Êush", .
	gmode
 = 0444, },

2310 .
	gshow
 = 
poﬁSètsBiosInProgªssFlushShow
,

2315 
ssize_t
 
	$poﬁSètsBiosInProgªssFuaShow
(
Kî√lLayî
 *
œyî
, *
buf
)

2317 
ssize_t
 
ªtvÆ
;

2318 
	`•ö_lock
(&
œyî
->
°©sLock
);

2319 
	`gëKî√lSèts
(
œyî
,Üayî->
kî√lSètsSt‹age
);

2320 
ªtvÆ
 = 
	`•rötf
(
buf
, "%" 
PRIu64
 "\n", 
œyî
->
kî√lSètsSt‹age
->
biosInProgªss
.
fua
);

2321 
	`•ö_u∆ock
(&
œyî
->
°©sLock
);

2322  
ªtvÆ
;

2323 
	}
}

2325 
PoﬁSètsAâribuã
 
	gpoﬁSètsBiosInProgªssFuaAâr
 = {

2326 .
©å
 = { .
«me
 = "bios_ö_¥ogªss_fua", .
	gmode
 = 0444, },

2327 .
	gshow
 = 
poﬁSètsBiosInProgªssFuaShow
,

2332 
ssize_t
 
	$poﬁSètsRódCacheAc˚s£sShow
(
Kî√lLayî
 *
œyî
, *
buf
)

2334 
ssize_t
 
ªtvÆ
;

2335 
	`•ö_lock
(&
œyî
->
°©sLock
);

2336 
	`gëKî√lSèts
(
œyî
,Üayî->
kî√lSètsSt‹age
);

2337 
ªtvÆ
 = 
	`•rötf
(
buf
, "%" 
PRIu64
 "\n", 
œyî
->
kî√lSètsSt‹age
->
ªadCache
.
ac˚s£s
);

2338 
	`•ö_u∆ock
(&
œyî
->
°©sLock
);

2339  
ªtvÆ
;

2340 
	}
}

2342 
PoﬁSètsAâribuã
 
	gpoﬁSètsRódCacheAc˚s£sAâr
 = {

2343 .
©å
 = { .
«me
 = "ªad_ˇche_ac˚s£s", .
	gmode
 = 0444, },

2344 .
	gshow
 = 
poﬁSètsRódCacheAc˚s£sShow
,

2349 
ssize_t
 
	$poﬁSètsRódCacheHôsShow
(
Kî√lLayî
 *
œyî
, *
buf
)

2351 
ssize_t
 
ªtvÆ
;

2352 
	`•ö_lock
(&
œyî
->
°©sLock
);

2353 
	`gëKî√lSèts
(
œyî
,Üayî->
kî√lSètsSt‹age
);

2354 
ªtvÆ
 = 
	`•rötf
(
buf
, "%" 
PRIu64
 "\n", 
œyî
->
kî√lSètsSt‹age
->
ªadCache
.
hôs
);

2355 
	`•ö_u∆ock
(&
œyî
->
°©sLock
);

2356  
ªtvÆ
;

2357 
	}
}

2359 
PoﬁSètsAâribuã
 
	gpoﬁSètsRódCacheHôsAâr
 = {

2360 .
©å
 = { .
«me
 = "ªad_ˇche_hôs", .
	gmode
 = 0444, },

2361 .
	gshow
 = 
poﬁSètsRódCacheHôsShow
,

2366 
ssize_t
 
	$poﬁSètsRódCacheD©aHôsShow
(
Kî√lLayî
 *
œyî
, *
buf
)

2368 
ssize_t
 
ªtvÆ
;

2369 
	`•ö_lock
(&
œyî
->
°©sLock
);

2370 
	`gëKî√lSèts
(
œyî
,Üayî->
kî√lSètsSt‹age
);

2371 
ªtvÆ
 = 
	`•rötf
(
buf
, "%" 
PRIu64
 "\n", 
œyî
->
kî√lSètsSt‹age
->
ªadCache
.
d©aHôs
);

2372 
	`•ö_u∆ock
(&
œyî
->
°©sLock
);

2373  
ªtvÆ
;

2374 
	}
}

2376 
PoﬁSètsAâribuã
 
	gpoﬁSètsRódCacheD©aHôsAâr
 = {

2377 .
©å
 = { .
«me
 = "ªad_ˇche_d©a_hôs", .
	gmode
 = 0444, },

2378 .
	gshow
 = 
poﬁSètsRódCacheD©aHôsShow
,

2383 
ssize_t
 
	$poﬁSètsMem‹yUßgeByãsU£dShow
(
Kî√lLayî
 *
œyî
, *
buf
)

2385 
ssize_t
 
ªtvÆ
;

2386 
	`•ö_lock
(&
œyî
->
°©sLock
);

2387 
	`gëKî√lSèts
(
œyî
,Üayî->
kî√lSètsSt‹age
);

2388 
ªtvÆ
 = 
	`•rötf
(
buf
, "%" 
PRIu64
 "\n", 
œyî
->
kî√lSètsSt‹age
->
mem‹yUßge
.
byãsU£d
);

2389 
	`•ö_u∆ock
(&
œyî
->
°©sLock
);

2390  
ªtvÆ
;

2391 
	}
}

2393 
PoﬁSètsAâribuã
 
	gpoﬁSètsMem‹yUßgeByãsU£dAâr
 = {

2394 .
©å
 = { .
«me
 = "mem‹y_ußge_byãs_u£d", .
	gmode
 = 0444, },

2395 .
	gshow
 = 
poﬁSètsMem‹yUßgeByãsU£dShow
,

2400 
ssize_t
 
	$poﬁSètsMem‹yUßgePókByãsU£dShow
(
Kî√lLayî
 *
œyî
, *
buf
)

2402 
ssize_t
 
ªtvÆ
;

2403 
	`•ö_lock
(&
œyî
->
°©sLock
);

2404 
	`gëKî√lSèts
(
œyî
,Üayî->
kî√lSètsSt‹age
);

2405 
ªtvÆ
 = 
	`•rötf
(
buf
, "%" 
PRIu64
 "\n", 
œyî
->
kî√lSètsSt‹age
->
mem‹yUßge
.
≥akByãsU£d
);

2406 
	`•ö_u∆ock
(&
œyî
->
°©sLock
);

2407  
ªtvÆ
;

2408 
	}
}

2410 
PoﬁSètsAâribuã
 
	gpoﬁSètsMem‹yUßgePókByãsU£dAâr
 = {

2411 .
©å
 = { .
«me
 = "mem‹y_ußge_≥ak_byãs_u£d", .
	gmode
 = 0444, },

2412 .
	gshow
 = 
poﬁSètsMem‹yUßgePókByãsU£dShow
,

2417 
ssize_t
 
	$poﬁSètsMem‹yUßgeBiosU£dShow
(
Kî√lLayî
 *
œyî
, *
buf
)

2419 
ssize_t
 
ªtvÆ
;

2420 
	`•ö_lock
(&
œyî
->
°©sLock
);

2421 
	`gëKî√lSèts
(
œyî
,Üayî->
kî√lSètsSt‹age
);

2422 
ªtvÆ
 = 
	`•rötf
(
buf
, "%" 
PRIu64
 "\n", 
œyî
->
kî√lSètsSt‹age
->
mem‹yUßge
.
biosU£d
);

2423 
	`•ö_u∆ock
(&
œyî
->
°©sLock
);

2424  
ªtvÆ
;

2425 
	}
}

2427 
PoﬁSètsAâribuã
 
	gpoﬁSètsMem‹yUßgeBiosU£dAâr
 = {

2428 .
©å
 = { .
«me
 = "mem‹y_ußge_bios_u£d", .
	gmode
 = 0444, },

2429 .
	gshow
 = 
poﬁSètsMem‹yUßgeBiosU£dShow
,

2434 
ssize_t
 
	$poﬁSètsMem‹yUßgePókBioCou¡Show
(
Kî√lLayî
 *
œyî
, *
buf
)

2436 
ssize_t
 
ªtvÆ
;

2437 
	`•ö_lock
(&
œyî
->
°©sLock
);

2438 
	`gëKî√lSèts
(
œyî
,Üayî->
kî√lSètsSt‹age
);

2439 
ªtvÆ
 = 
	`•rötf
(
buf
, "%" 
PRIu64
 "\n", 
œyî
->
kî√lSètsSt‹age
->
mem‹yUßge
.
≥akBioCou¡
);

2440 
	`•ö_u∆ock
(&
œyî
->
°©sLock
);

2441  
ªtvÆ
;

2442 
	}
}

2444 
PoﬁSètsAâribuã
 
	gpoﬁSètsMem‹yUßgePókBioCou¡Aâr
 = {

2445 .
©å
 = { .
«me
 = "mem‹y_ußge_≥ak_bio_cou¡", .
	gmode
 = 0444, },

2446 .
	gshow
 = 
poﬁSètsMem‹yUßgePókBioCou¡Show
,

2449 
©åibuã
 *
	gpoﬁSètsAârs
[] = {

2450 &
poﬁSètsD©aBlocksU£dAâr
.
©å
,

2451 &
poﬁSètsOvîhódBlocksU£dAâr
.
©å
,

2452 &
poﬁSètsLogiˇlBlocksU£dAâr
.
©å
,

2453 &
poﬁSètsPhysiˇlBlocksAâr
.
©å
,

2454 &
poﬁSètsLogiˇlBlocksAâr
.
©å
,

2455 &
poﬁSètsBlockM≠CacheSizeAâr
.
©å
,

2456 &
poﬁSètsWrôePﬁicyAâr
.
©å
,

2457 &
poﬁSètsBlockSizeAâr
.
©å
,

2458 &
poﬁSètsCom∂ëeRecovîõsAâr
.
©å
,

2459 &
poﬁSètsRódO∆yRecovîõsAâr
.
©å
,

2460 &
poﬁSètsModeAâr
.
©å
,

2461 &
poﬁSètsInRecovîyModeAâr
.
©å
,

2462 &
poﬁSètsRecovîyPî˚¡ageAâr
.
©å
,

2463 &
poﬁSètsPackîCom¥es£dFøgmítsWrôãnAâr
.
©å
,

2464 &
poﬁSètsPackîCom¥es£dBlocksWrôãnAâr
.
©å
,

2465 &
poﬁSètsPackîCom¥es£dFøgmítsInPackîAâr
.
©å
,

2466 &
poﬁSètsAŒoˇt‹SœbCou¡Aâr
.
©å
,

2467 &
poﬁSètsAŒoˇt‹SœbsO≥√dAâr
.
©å
,

2468 &
poﬁSètsAŒoˇt‹SœbsRe›íedAâr
.
©å
,

2469 &
poﬁSètsJou∫ÆDiskFuŒAâr
.
©å
,

2470 &
poﬁSètsJou∫ÆSœbJou∫ÆCommôsReque°edAâr
.
©å
,

2471 &
poﬁSètsJou∫ÆE¡rõsSèπedAâr
.
©å
,

2472 &
poﬁSètsJou∫ÆE¡rõsWrôãnAâr
.
©å
,

2473 &
poﬁSètsJou∫ÆE¡rõsCommôãdAâr
.
©å
,

2474 &
poﬁSètsJou∫ÆBlocksSèπedAâr
.
©å
,

2475 &
poﬁSètsJou∫ÆBlocksWrôãnAâr
.
©å
,

2476 &
poﬁSètsJou∫ÆBlocksCommôãdAâr
.
©å
,

2477 &
poﬁSètsSœbJou∫ÆDiskFuŒCou¡Aâr
.
©å
,

2478 &
poﬁSètsSœbJou∫ÆFlushCou¡Aâr
.
©å
,

2479 &
poﬁSètsSœbJou∫ÆBlockedCou¡Aâr
.
©å
,

2480 &
poﬁSètsSœbJou∫ÆBlocksWrôãnAâr
.
©å
,

2481 &
poﬁSètsSœbJou∫ÆTaûBusyCou¡Aâr
.
©å
,

2482 &
poﬁSètsSœbSumm¨yBlocksWrôãnAâr
.
©å
,

2483 &
poﬁSètsRefCou¡sBlocksWrôãnAâr
.
©å
,

2484 &
poﬁSètsBlockM≠DútyPagesAâr
.
©å
,

2485 &
poﬁSètsBlockM≠CÀ™PagesAâr
.
©å
,

2486 &
poﬁSètsBlockM≠FªePagesAâr
.
©å
,

2487 &
poﬁSètsBlockM≠FaûedPagesAâr
.
©å
,

2488 &
poﬁSètsBlockM≠IncomögPagesAâr
.
©å
,

2489 &
poﬁSètsBlockM≠OutgoögPagesAâr
.
©å
,

2490 &
poﬁSètsBlockM≠CachePªssuªAâr
.
©å
,

2491 &
poﬁSètsBlockM≠RódCou¡Aâr
.
©å
,

2492 &
poﬁSètsBlockM≠WrôeCou¡Aâr
.
©å
,

2493 &
poﬁSètsBlockM≠FaûedRódsAâr
.
©å
,

2494 &
poﬁSètsBlockM≠FaûedWrôesAâr
.
©å
,

2495 &
poﬁSètsBlockM≠Re˛aimedAâr
.
©å
,

2496 &
poﬁSètsBlockM≠RódOutgoögAâr
.
©å
,

2497 &
poﬁSètsBlockM≠FoundInCacheAâr
.
©å
,

2498 &
poﬁSètsBlockM≠DisˇrdRequúedAâr
.
©å
,

2499 &
poﬁSètsBlockM≠WaôF‹PageAâr
.
©å
,

2500 &
poﬁSètsBlockM≠FëchRequúedAâr
.
©å
,

2501 &
poﬁSètsBlockM≠PagesLﬂdedAâr
.
©å
,

2502 &
poﬁSètsBlockM≠PagesSavedAâr
.
©å
,

2503 &
poﬁSètsBlockM≠FlushCou¡Aâr
.
©å
,

2504 &
poﬁSètsEº‹sInvÆidAdvi˚PBNCou¡Aâr
.
©å
,

2505 &
poﬁSètsEº‹sInvÆidRﬁlovîPBNCou¡Aâr
.
©å
,

2506 &
poﬁSètsEº‹sDedu≥DódlockAvoid™˚Cou¡Aâr
.
©å
,

2507 &
poﬁSètsEº‹sNoS∑˚Eº‹Cou¡Aâr
.
©å
,

2508 &
poﬁSètsEº‹sRódO∆yEº‹Cou¡Aâr
.
©å
,

2509 &
poﬁSètsIn°™˚Aâr
.
©å
,

2510 &
poﬁSètsCuºítVIOsInProgªssAâr
.
©å
,

2511 &
poﬁSètsMaxVIOsAâr
.
©å
,

2512 &
poﬁSètsCuºDedu≥QuîõsAâr
.
©å
,

2513 &
poﬁSètsMaxDedu≥QuîõsAâr
.
©å
,

2514 &
poﬁSètsDedu≥Advi˚VÆidAâr
.
©å
,

2515 &
poﬁSètsDedu≥Advi˚SèÀAâr
.
©å
,

2516 &
poﬁSètsDedu≥Advi˚TimeoutsAâr
.
©å
,

2517 &
poﬁSètsFlushOutAâr
.
©å
,

2518 &
poﬁSètsLogiˇlBlockSizeAâr
.
©å
,

2519 &
poﬁSètsBiosInRódAâr
.
©å
,

2520 &
poﬁSètsBiosInWrôeAâr
.
©å
,

2521 &
poﬁSètsBiosInDisˇrdAâr
.
©å
,

2522 &
poﬁSètsBiosInFlushAâr
.
©å
,

2523 &
poﬁSètsBiosInFuaAâr
.
©å
,

2524 &
poﬁSètsBiosInP¨tülRódAâr
.
©å
,

2525 &
poﬁSètsBiosInP¨tülWrôeAâr
.
©å
,

2526 &
poﬁSètsBiosInP¨tülDisˇrdAâr
.
©å
,

2527 &
poﬁSètsBiosInP¨tülFlushAâr
.
©å
,

2528 &
poﬁSètsBiosInP¨tülFuaAâr
.
©å
,

2529 &
poﬁSètsBiosOutRódAâr
.
©å
,

2530 &
poﬁSètsBiosOutWrôeAâr
.
©å
,

2531 &
poﬁSètsBiosOutDisˇrdAâr
.
©å
,

2532 &
poﬁSètsBiosOutFlushAâr
.
©å
,

2533 &
poﬁSètsBiosOutFuaAâr
.
©å
,

2534 &
poﬁSètsBiosMëaRódAâr
.
©å
,

2535 &
poﬁSètsBiosMëaWrôeAâr
.
©å
,

2536 &
poﬁSètsBiosMëaDisˇrdAâr
.
©å
,

2537 &
poﬁSètsBiosMëaFlushAâr
.
©å
,

2538 &
poﬁSètsBiosMëaFuaAâr
.
©å
,

2539 &
poﬁSètsBiosJou∫ÆRódAâr
.
©å
,

2540 &
poﬁSètsBiosJou∫ÆWrôeAâr
.
©å
,

2541 &
poﬁSètsBiosJou∫ÆDisˇrdAâr
.
©å
,

2542 &
poﬁSètsBiosJou∫ÆFlushAâr
.
©å
,

2543 &
poﬁSètsBiosJou∫ÆFuaAâr
.
©å
,

2544 &
poﬁSètsBiosPageCacheRódAâr
.
©å
,

2545 &
poﬁSètsBiosPageCacheWrôeAâr
.
©å
,

2546 &
poﬁSètsBiosPageCacheDisˇrdAâr
.
©å
,

2547 &
poﬁSètsBiosPageCacheFlushAâr
.
©å
,

2548 &
poﬁSètsBiosPageCacheFuaAâr
.
©å
,

2549 &
poﬁSètsBiosOutCom∂ëedRódAâr
.
©å
,

2550 &
poﬁSètsBiosOutCom∂ëedWrôeAâr
.
©å
,

2551 &
poﬁSètsBiosOutCom∂ëedDisˇrdAâr
.
©å
,

2552 &
poﬁSètsBiosOutCom∂ëedFlushAâr
.
©å
,

2553 &
poﬁSètsBiosOutCom∂ëedFuaAâr
.
©å
,

2554 &
poﬁSètsBiosMëaCom∂ëedRódAâr
.
©å
,

2555 &
poﬁSètsBiosMëaCom∂ëedWrôeAâr
.
©å
,

2556 &
poﬁSètsBiosMëaCom∂ëedDisˇrdAâr
.
©å
,

2557 &
poﬁSètsBiosMëaCom∂ëedFlushAâr
.
©å
,

2558 &
poﬁSètsBiosMëaCom∂ëedFuaAâr
.
©å
,

2559 &
poﬁSètsBiosJou∫ÆCom∂ëedRódAâr
.
©å
,

2560 &
poﬁSètsBiosJou∫ÆCom∂ëedWrôeAâr
.
©å
,

2561 &
poﬁSètsBiosJou∫ÆCom∂ëedDisˇrdAâr
.
©å
,

2562 &
poﬁSètsBiosJou∫ÆCom∂ëedFlushAâr
.
©å
,

2563 &
poﬁSètsBiosJou∫ÆCom∂ëedFuaAâr
.
©å
,

2564 &
poﬁSètsBiosPageCacheCom∂ëedRódAâr
.
©å
,

2565 &
poﬁSètsBiosPageCacheCom∂ëedWrôeAâr
.
©å
,

2566 &
poﬁSètsBiosPageCacheCom∂ëedDisˇrdAâr
.
©å
,

2567 &
poﬁSètsBiosPageCacheCom∂ëedFlushAâr
.
©å
,

2568 &
poﬁSètsBiosPageCacheCom∂ëedFuaAâr
.
©å
,

2569 &
poﬁSètsBiosAcknowÀdgedRódAâr
.
©å
,

2570 &
poﬁSètsBiosAcknowÀdgedWrôeAâr
.
©å
,

2571 &
poﬁSètsBiosAcknowÀdgedDisˇrdAâr
.
©å
,

2572 &
poﬁSètsBiosAcknowÀdgedFlushAâr
.
©å
,

2573 &
poﬁSètsBiosAcknowÀdgedFuaAâr
.
©å
,

2574 &
poﬁSètsBiosAcknowÀdgedP¨tülRódAâr
.
©å
,

2575 &
poﬁSètsBiosAcknowÀdgedP¨tülWrôeAâr
.
©å
,

2576 &
poﬁSètsBiosAcknowÀdgedP¨tülDisˇrdAâr
.
©å
,

2577 &
poﬁSètsBiosAcknowÀdgedP¨tülFlushAâr
.
©å
,

2578 &
poﬁSètsBiosAcknowÀdgedP¨tülFuaAâr
.
©å
,

2579 &
poﬁSètsBiosInProgªssRódAâr
.
©å
,

2580 &
poﬁSètsBiosInProgªssWrôeAâr
.
©å
,

2581 &
poﬁSètsBiosInProgªssDisˇrdAâr
.
©å
,

2582 &
poﬁSètsBiosInProgªssFlushAâr
.
©å
,

2583 &
poﬁSètsBiosInProgªssFuaAâr
.
©å
,

2584 &
poﬁSètsRódCacheAc˚s£sAâr
.
©å
,

2585 &
poﬁSètsRódCacheHôsAâr
.
©å
,

2586 &
poﬁSètsRódCacheD©aHôsAâr
.
©å
,

2587 &
poﬁSètsMem‹yUßgeByãsU£dAâr
.
©å
,

2588 &
poﬁSètsMem‹yUßgePókByãsU£dAâr
.
©å
,

2589 &
poﬁSètsMem‹yUßgeBiosU£dAâr
.
©å
,

2590 &
poﬁSètsMem‹yUßgePókBioCou¡Aâr
.
©å
,

2591 
NULL
,

2595 
	$poﬁSètsRñó£
(
kobje˘
 *
kobj
)

2598 
	}
}

2600 
kobj_ty≥
 
	g°©sDúe˘‹yKobjTy≥
 = {

2601 .
ªÀa£
 = 
poﬁSètsRñó£
,

2602 .
	gsysfs_›s
 = &
poﬁSètsSysfsOps
,

2603 .
	gdeÁu…_©ås
 = 
poﬁSètsAârs
,

	@vdo/kernel/readCache.c

20 
	~"ªadCache.h
"

22 
	~"loggî.h
"

23 
	~"mem‹yAŒoc.h
"

24 
	~"utû/©omic.h
"

26 
	~"com¥es£dBlock.h
"

27 
	~"ötM≠.h
"

28 
	~"lz4.h
"

29 
	~"°©usCodes.h
"

30 
	~"waôQueue.h
"

32 
	~"b©chPro˚ss‹.h
"

33 
	~"bio.h
"

34 
	~"d©aKVIO.h
"

35 
	~"hi°ogøm.h
"

36 
	~"ioSubmôãrI¡î«ls.h
"

58 c⁄° 
PhysiˇlBlockNumbî
 
	gINVALID_BLOCK
 = (PhysicalBlockNumber) -1;

61 
	mRC_FREE
,

62 
	mRC_RECLAIMABLE
,

63 
	mRC_IN_USE
,

64 
	mRC_IN_USE_PBN
,

65 
	mRC_MAX_STATES


66 } 
	tCacheE¡rySèã
;

68 
	sªadCacheE¡ryRñó£
 {

69 
KvdoW‹kIãm
 
	mw‹kIãm
;

70 
Atomic32
 
	mªÀa£s
;

71 } 
	tRódCacheE¡ryRñó£
;

73 
ªadCacheZ⁄e
 
	tRódCacheZ⁄e
;

75 
	sªadCacheE¡ry
 {

76 
li°_hód
 
	mli°
;

77 
	míåyNum
;

78 
boﬁ
 
	md©aVÆid
;

79 
Atomic32
 
	mªfCou¡
;

80 
uöt64_t
 
	mhôs
;

81 
PhysiˇlBlockNumbî
 
	mpbn
;

82 *
	md©aBlock
;

83 
	mîr‹
;

84 
BIO
 *
	mbio
;

85 
RódCacheZ⁄e
 *
	mz⁄e
;

86 
•ölock_t
 
	mwaôLock
;

87 
WaôQueue
 
	mˇŒbackWaôîs
;

88 
RódCacheE¡ryRñó£
 
	mªÀa£
;

92 
	mTHREAD_SAFE
 = 0

95 
	sªadCacheZ⁄e
 {

96 
RódCacheSèts
 
	m°©s
;

97 
Kî√lLayî
 *
	mœyî
;

98 
	mnumE¡rõs
;

99 
•ölock_t
 
	mlock
;

100 
li°_hód
 
	mbusyLi°
;

101 
li°_hód
 
	mª˛aimLi°
;

102 
li°_hód
 
	m‰ìLi°
;

103 
I¡M≠
 *
	mpbnM≠
;

104 
RódCacheE¡ry
 **
	mblockM≠
;

105 *
	md©aBlocks
;

106 
B©chPro˚ss‹
 *
	mb©chPro˚ss‹
;

109 
	sªadCache
 {

110 
Kî√lLayî
 *
	mœyî
;

111 
	mz⁄eCou¡
;

112 
RódCacheZ⁄e
 *
	mz⁄es
[];

115 
dumpRódCacheE¡ry
(
èg
, 
RódCacheE¡ry
 *
íåy
);

118 
ölöe
 
uöt32_t
 
	$gëCacheE¡ryRefCou¡
(
RódCacheZ⁄e
 *
z⁄e
,

119 
RódCacheE¡ry
 *
ˇcheE¡ry
)

121 
uöt32_t
 
ªsu…
;

123 i‡(
THREAD_SAFE
) {

124 
ªsu…
 = 
	`©omicLﬂd32
(&
ˇcheE¡ry
->
ªfCou¡
);

126 
ªsu…
 = 
	`ªœxedLﬂd32
(&
ˇcheE¡ry
->
ªfCou¡
);

129  
ªsu…
;

130 
	}
}

133 
ölöe
 
uöt32_t
 
	$addToCacheE¡ryRefCou¡
(
RódCacheZ⁄e
 *
z⁄e
,

134 
RódCacheE¡ry
 *
ˇcheE¡ry
,

135 
öt32_t
 
dñè
)

137 
uöt32_t
 
ªsu…
;

139 i‡(
THREAD_SAFE
) {

140 
ªsu…
 = 
	`©omicAdd32
(&
ˇcheE¡ry
->
ªfCou¡
, 
dñè
);

142 
ªsu…
 = 
	`ªœxedAdd32
(&
ˇcheE¡ry
->
ªfCou¡
, 
dñè
);

145  
ªsu…
;

146 
	}
}

149 
ölöe
 
	$£tCacheE¡ryRefCou¡
(
RódCacheZ⁄e
 *
z⁄e
,

150 
RódCacheE¡ry
 *
ˇcheE¡ry
,

151 
uöt32_t
 
√wVÆue
)

153 i‡(
THREAD_SAFE
) {

154 
	`©omicSt‹e32
(&
ˇcheE¡ry
->
ªfCou¡
, 
√wVÆue
);

156 
	`ªœxedSt‹e32
(&
ˇcheE¡ry
->
ªfCou¡
, 
√wVÆue
);

158 
	}
}

161 
ölöe
 
	$lock
(
RódCacheZ⁄e
 *
z⁄e
)

163 i‡(
THREAD_SAFE
) {

164 
	`•ö_lock
(&
z⁄e
->
lock
);

166 
	}
}

169 
ölöe
 
	$u∆ock
(
RódCacheZ⁄e
 *
z⁄e
)

171 i‡(
THREAD_SAFE
) {

172 
	`•ö_u∆ock
(&
z⁄e
->
lock
);

174 
	}
}

182 
ölöe
 
	$logCacheE¡ry
(c⁄° *
œbñ
, 
RódCacheE¡ry
 *
ˇcheE¡ry
)

184 i‡(
ˇcheE¡ry
 =
NULL
) {

185 
	`logInfo
("%s: cacheE¡ry=NULL", 
œbñ
);

189 
uöt32_t
 
ªfCou¡
 = 
	`ªœxedLﬂd32
(&
ˇcheE¡ry
->refCount);

190 i‡(
ˇcheE¡ry
->
pbn
 =
INVALID_BLOCK
) {

191 
	`logInfo
("%s:ÉntryNum=%dÑefCount=%dÖbn=INVALID",

192 
œbñ
, 
ˇcheE¡ry
->
íåyNum
, 
ªfCou¡
);

194 
	`logInfo
("%s:É¡ryNum=%dÑefCou¡=%dÖbn=%" 
PRIu64
,

195 
œbñ
, 
ˇcheE¡ry
->
íåyNum
, 
ªfCou¡
, cacheE¡ry->
pbn
);

197 
	}
}

208 
ölöe
 
CacheE¡rySèã
 
	$gëSèã
(
RódCacheE¡ry
 *
ˇcheE¡ry
)

210 i‡(
	`ªœxedLﬂd32
(&
ˇcheE¡ry
->
ªfCou¡
) == 0) {

211  (
ˇcheE¡ry
->
pbn
 =
INVALID_BLOCK
Ë? 
RC_FREE
 : 
RC_RECLAIMABLE
;

213  (
ˇcheE¡ry
->
pbn
 =
INVALID_BLOCK
Ë? 
RC_IN_USE
 : 
RC_IN_USE_PBN
;

215 
	}
}

223 
	$ªÀa£BlockI¡î«l
(
RódCacheE¡ry
 *
ˇcheE¡ry
)

225 
RódCacheZ⁄e
 *
z⁄e
 = 
ˇcheE¡ry
->zone;

226 i‡(
	`ASSERT
(
	`gëCacheE¡ryRefCou¡
(
z⁄e
, 
ˇcheE¡ry
) > 0,

230 i‡(
	`addToCacheE¡ryRefCou¡
(
z⁄e
, 
ˇcheE¡ry
, -1) == 0) {

231 
	`lock
(
z⁄e
);

232 i‡(
	`gëCacheE¡ryRefCou¡
(
z⁄e
, 
ˇcheE¡ry
) == 0) {

233 i‡(
ˇcheE¡ry
->
pbn
 !
INVALID_BLOCK
) {

234 
	`li°_move_èû
(&
ˇcheE¡ry
->
li°
, &
z⁄e
->
ª˛aimLi°
);

236 
	`li°_move_èû
(&
ˇcheE¡ry
->
li°
, &
z⁄e
->
‰ìLi°
);

239 
	`u∆ock
(
z⁄e
);

241 
	}
}

244 
	$as£πRu¬ögInCPUQueue
()

246 
	`ASSERT_LOG_ONLY
(!
	`ö_öãºu±
(), "not in interrupt context");

247 
	`ASSERT_LOG_ONLY
(
	`°∫°r
(
cuºít
->
comm
, "CpuQ", 
TASK_COMM_LEN
Ë!
NULL
,

249 
	}
}

252 
	$as£πRu¬ögInRCQueueF‹PBN
(
RódCache
 *
ˇche
,

253 
PhysiˇlBlockNumbî
 
pbn
)

255 
IO_WORK_STRATEGY
) {

256 
IWS_RC_PBN_BIO_PBN
:

257 
IWS_RC_PBN_BIO_RR
:

258 
	`as£πRu¬ögInBioQueueF‹PBN
(
pbn
);

260 
IWS_RC_BATCH_BIO_RR
:

262 
	`as£πRu¬ögInCPUQueue
();

265 
	`BUG
();

267 
	}
}

277 
RódCacheZ⁄e
 *
	$gëRódCacheZ⁄e
(
RódCache
 *
ªadCache
,

278 
ödex
)

280 
	`BUG_ON
(
ödex
 >
ªadCache
->
z⁄eCou¡
);

281  
ªadCache
->
z⁄es
[
ödex
];

282 
	}
}

285 
	$z⁄eNumbîF‹PBN
(
RódCache
 *
ˇche
,

286 
PhysiˇlBlockNumbî
 
pbn
)

288 
IO_WORK_STRATEGY
) {

289 
IWS_RC_PBN_BIO_PBN
:

290 
IWS_RC_PBN_BIO_RR
:

292  
	`bioQueueNumbîF‹PBN
(
ˇche
->
œyî
->
ioSubmôãr
, 
pbn
);

293 
IWS_RC_BATCH_BIO_RR
:

296 
	`BUG
();

298 
	}
}

301 
RódCacheZ⁄e
 *
	$z⁄eF‹PBN
(
RódCache
 *
ˇche
, 
PhysiˇlBlockNumbî
 
pbn
)

303  
	`gëRódCacheZ⁄e
(
ˇche
, 
	`z⁄eNumbîF‹PBN
(ˇche, 
pbn
));

304 
	}
}

314 
	$£tBlockPBNI¡î«l
(
RódCacheZ⁄e
 *
z⁄e
,

315 
RódCacheE¡ry
 *
ˇcheE¡ry
,

316 
PhysiˇlBlockNumbî
 
pbn
)

318 
	`as£πRu¬ögInRCQueueF‹PBN
(
z⁄e
->
œyî
->
ioSubmôãr
->
ªadCache
, 
pbn
);

320 
	`lock
(
z⁄e
);

321 
ªsu…
 = 
	`ötM≠Put
(
z⁄e
->
pbnM≠
, 
pbn
, 
ˇcheE¡ry
, 
åue
, 
NULL
);

322 i‡(
ªsu…
 !
VDO_SUCCESS
) {

323 
	`u∆ock
(
z⁄e
);

324  
ªsu…
;

326 
ˇcheE¡ry
->
pbn
 =Öbn;

327 
	`u∆ock
(
z⁄e
);

328  
VDO_SUCCESS
;

329 
	}
}

332 
RódCacheE¡ry
 *
	$födBlockF‹RódI¡î«l
(
RódCacheZ⁄e
 *
z⁄e
,

333 
PhysiˇlBlockNumbî
 
pbn
)

335 
	`lock
(
z⁄e
);

336 
z⁄e
->
°©s
.
ac˚s£s
++;

337 
RódCacheE¡ry
 *
ˇcheE¡ry
 = 
	`ötM≠Gë
(
z⁄e
->
pbnM≠
, 
pbn
);

338 i‡(
ˇcheE¡ry
 !
NULL
) {

339 i‡(
	`gëSèã
(
ˇcheE¡ry
Ë=
RC_RECLAIMABLE
) {

340 
	`li°_move_èû
(&
ˇcheE¡ry
->
li°
, &
z⁄e
->
busyLi°
);

342 
z⁄e
->
°©s
.
hôs
++;

343 i‡(
ˇcheE¡ry
->
d©aVÆid
) {

344 
z⁄e
->
°©s
.
d©aHôs
++;

346 
	`addToCacheE¡ryRefCou¡
(
z⁄e
, 
ˇcheE¡ry
, 1);

347 
ˇcheE¡ry
->
hôs
++;

349 
	`u∆ock
(
z⁄e
);

350  
ˇcheE¡ry
;

351 
	}
}

354 
RódCacheSèts
 
	$ªadCacheZ⁄eGëSèts
(
RódCacheZ⁄e
 *
z⁄e
)

356 
RódCacheSèts
 
°©s
 = {

357 .
ac˚s£s
 = 0,

358 .
hôs
 = 0

361 i‡(
z⁄e
 !
NULL
) {

362 
	`lock
(
z⁄e
);

363 
°©s
 = 
z⁄e
->stats;

364 
	`u∆ock
(
z⁄e
);

367  
°©s
;

368 
	}
}

371 
RódCacheSèts
 
	$ªadCacheGëSèts
(
RódCache
 *
ªadCache
)

373 
RódCacheSèts
 
tŸÆÀdSèts
;

376 
tŸÆÀdSèts
.
ac˚s£s
 = 0;

377 
tŸÆÀdSèts
.
d©aHôs
 = 0;

378 
tŸÆÀdSèts
.
hôs
 = 0;

379 i‡(
ªadCache
 =
NULL
) {

380  
tŸÆÀdSèts
;

383 
i
 = 0; i < 
ªadCache
->
z⁄eCou¡
; i++) {

384 
RódCacheSèts
 
°©s
 = 
	`ªadCacheZ⁄eGëSèts
(
ªadCache
->
z⁄es
[
i
]);

385 
tŸÆÀdSèts
.
ac˚s£s
 +
°©s
.accesses;

386 
tŸÆÀdSèts
.
d©aHôs
 +
°©s
.dataHits;

387 
tŸÆÀdSèts
.
hôs
 +
°©s
.hits;

390  
tŸÆÀdSèts
;

391 
	}
}

394 
	$gëS¸©chBlockI¡î«l
(
RódCacheZ⁄e
 *
z⁄e
,

395 
RódCacheE¡ry
 **
ˇcheE¡ryPå
)

397 
RódCacheE¡ry
 *
ˇcheE¡ry
;

398 
	`lock
(
z⁄e
);

399 i‡(
	`li°_em±y
(&
z⁄e
->
‰ìLi°
)) {

400 i‡(
	`u∆ikñy
(
	`li°_em±y
(&
z⁄e
->
ª˛aimLi°
))) {

401 
	`u∆ock
(
z⁄e
);

402 
	`ASSERT_LOG_ONLY
(
Ál£
,

404  
VDO_READ_CACHE_BUSY
;

406 
ˇcheE¡ry
 = 
	`li°_fú°_íåy
(&
z⁄e
->
ª˛aimLi°
,

407 
RódCacheE¡ry
, 
li°
);

408 
	`ötM≠Remove
(
z⁄e
->
pbnM≠
, 
ˇcheE¡ry
->
pbn
);

409 
ˇcheE¡ry
->
pbn
 = 
INVALID_BLOCK
;

410 
	`ASSERT_LOG_ONLY
(
	`ªœxedLﬂd32
(&
ˇcheE¡ry
->
ªfCou¡
) == 0,

413 
ˇcheE¡ry
 = 
	`li°_fú°_íåy
(&
z⁄e
->
‰ìLi°
, 
RódCacheE¡ry
,

414 
li°
);

415 
	`ASSERT_LOG_ONLY
(
	`ªœxedLﬂd32
(&
ˇcheE¡ry
->
ªfCou¡
) == 0,

418 
	`li°_move
(&
ˇcheE¡ry
->
li°
, &
z⁄e
->
busyLi°
);

419 
	`u∆ock
(
z⁄e
);

420 
	`£tCacheE¡ryRefCou¡
(
z⁄e
, 
ˇcheE¡ry
, 1);

421 
ˇcheE¡ry
->
hôs
 = 0;

422 
ˇcheE¡ry
->
d©aVÆid
 = 
Ál£
;

423 
	`ASSERT_LOG_ONLY
(
ˇcheE¡ry
->
pbn
 =
INVALID_BLOCK
,

425 *
ˇcheE¡ryPå
 = 
ˇcheE¡ry
;

426  
VDO_SUCCESS
;

427 
	}
}

430 
	$ÆloˇãBlockF‹RódI¡î«l
(
RódCacheZ⁄e
 *
z⁄e
,

431 
PhysiˇlBlockNumbî
 
pbn
,

432 
RódCacheE¡ry
 **
ˇcheE¡ryPå
)

434 
	`as£πRu¬ögInRCQueueF‹PBN
(
z⁄e
->
œyî
->
ioSubmôãr
->
ªadCache
, 
pbn
);

436 
RódCacheE¡ry
 *
ˇcheE¡ry
 = 
	`födBlockF‹RódI¡î«l
(
z⁄e
, 
pbn
);

437 i‡(
ˇcheE¡ry
 =
NULL
) {

438 
ªsu…
 = 
	`gëS¸©chBlockI¡î«l
(
z⁄e
, &
ˇcheE¡ry
);

439 i‡(
ªsu…
 !
VDO_SUCCESS
) {

440  
ªsu…
;

442 
	`£tBlockPBNI¡î«l
(
z⁄e
, 
ˇcheE¡ry
, 
pbn
);

444 *
ˇcheE¡ryPå
 = 
ˇcheE¡ry
;

445  
VDO_SUCCESS
;

446 
	}
}

454 
	$uncom¥essRódBlock
(
KvdoW‹kIãm
 *
w‹kIãm
)

456 
D©aKVIO
 *
d©aKVIO
 = 
	`w‹kIãmAsD©aKVIO
(
w‹kIãm
);

457 
RódBlock
 *
ªadBlock
 = &
d©aKVIO
->readBlock;

458 
BlockSize
 
blockSize
 = 
VDO_BLOCK_SIZE
;

462 
uöt16_t
 
‰agmítOff£t
, 
‰agmítSize
;

463 *
com¥es£dD©a
 = 
ªadBlock
->
d©a
;

464 
ªsu…
 = 
	`gëCom¥es£dBlockFøgmít
(
ªadBlock
->
m≠pögSèã
,

465 
com¥es£dD©a
, 
blockSize
,

466 &
‰agmítOff£t
,

467 &
‰agmítSize
);

468 i‡(
ªsu…
 !
VDO_SUCCESS
) {

469 
	`logDebug
("%s: føgÉº %d", 
__func__
, 
ªsu…
);

470 
ªadBlock
->
°©us
 = 
ªsu…
;

471 
ªadBlock
->
	`ˇŒback
(
d©aKVIO
);

475 *
‰agmít
 = 
com¥es£dD©a
 + 
‰agmítOff£t
;

476 
size
 = 
	`LZ4_uncom¥ess_unknownOuçutSize
(
‰agmít
, 
d©aKVIO
->
s¸©chBlock
,

477 
‰agmítSize
, 
blockSize
);

478 i‡(
size
 =
blockSize
) {

479 
ªadBlock
->
d©a
 = 
d©aKVIO
->
s¸©chBlock
;

481 
	`logDebug
("%s:Üz4Éº‹", 
__func__
);

482 
ªadBlock
->
°©us
 = 
VDO_INVALID_FRAGMENT
;

485 
ªadBlock
->
	`ˇŒback
(
d©aKVIO
);

486 
	}
}

495 
	$com∂ëeRód
(
D©aKVIO
 *
d©aKVIO
, 
ªsu…
)

497 
RódBlock
 *
ªadBlock
 = &
d©aKVIO
->readBlock;

498 
ªadBlock
->
°©us
 = 
ªsu…
;

500 i‡((
ªsu…
 =
VDO_SUCCESS
Ë&& 
	`isCom¥es£d
(
ªadBlock
->
m≠pögSèã
)) {

501 
	`œunchD©aKVIOOnCPUQueue
(
d©aKVIO
, 
uncom¥essRódBlock
, 
NULL
,

502 
CPU_Q_ACTION_COMPRESS_BLOCK
);

506 
ªadBlock
->
	`ˇŒback
(
d©aKVIO
);

507 
	}
}

509 #i‡
LINUX_VERSION_CODE
 >
KERNEL_VERSION
(4,4,0)

515 
	$ªadBioCÆlback
(
BIO
 *
bio
)

523 
	$ªadBioCÆlback
(
BIO
 *
bio
, 
ªsu…
)

526 
KVIO
 *
kvio
 = (KVIO *Ë
bio
->
bi_¥iv©e
;

527 
D©aKVIO
 *
d©aKVIO
 = 
	`kvioAsD©aKVIO
(
kvio
);

528 
d©aKVIO
->
ªadBlock
.
d©a
 = d©aKVIO->ªadBlock.
buf„r
;

529 
	`d©aKVIOAddTø˚Rec‹d
(
d©aKVIO
, 
	`THIS_LOCATION
(
NULL
));

530 
	`cou¡Com∂ëedBios
(
bio
);

531 #i‡
LINUX_VERSION_CODE
 >
	`KERNEL_VERSION
(4,13,0)

532 
	`com∂ëeRód
(
d©aKVIO
, 
bio
->
bi_°©us
);

533 #ñi‡
LINUX_VERSION_CODE
 >
	`KERNEL_VERSION
(4,4,0)

534 
	`com∂ëeRód
(
d©aKVIO
, 
bio
->
bi_îr‹
);

536 
	`com∂ëeRód
(
d©aKVIO
, 
ªsu…
);

538 
	}
}

546 
	$ˇcheBlockRódWaôîCÆlback
(
Waôî
 *
waôî
, *
c⁄ãxt
)

548 
	`com∂ëeRód
(
	`d©aVIOAsD©aKVIO
(
	`waôîAsD©aVIO
(
waôî
)), *((*Ë
c⁄ãxt
));

549 
	}
}

552 
	$ªadBlockCom∂ëi⁄W‹k
(
KvdoW‹kIãm
 *
ôem
)

554 
D©aKVIO
 *
d©aKVIO
 = 
	`w‹kIãmAsD©aKVIO
(
ôem
);

555 
	`d©aKVIOAddTø˚Rec‹d
(
d©aKVIO
, 
	`THIS_LOCATION
(
NULL
));

557 
îr‹
 = 
d©aKVIO
->
ªadBlock
.
°©us
;

558 
RódCacheE¡ry
 *
ˇcheE¡ry
 = 
d©aKVIO
->
ªadBlock
.cacheEntry;

562 
	`•ö_lock
(&
ˇcheE¡ry
->
waôLock
);

563 
ˇcheE¡ry
->
d©aVÆid
 = (
îr‹
 == 0);

564 
	`nŸifyAŒWaôîs
(&
ˇcheE¡ry
->
ˇŒbackWaôîs
,

565 
ˇcheBlockRódWaôîCÆlback
, &
îr‹
);

566 
	`•ö_u∆ock
(&
ˇcheE¡ry
->
waôLock
);

567 
	}
}

569 #i‡
LINUX_VERSION_CODE
 >
KERNEL_VERSION
(4,4,0)

575 
	$ªadCacheBioCÆlback
(
BIO
 *
bio
)

583 
	$ªadCacheBioCÆlback
(
BIO
 *
bio
, 
îr‹
)

586 
KVIO
 *
kvio
 = (KVIO *Ë
bio
->
bi_¥iv©e
;

587 
D©aKVIO
 *
d©aKVIO
 = 
	`kvioAsD©aKVIO
(
kvio
);

588 
	`d©aKVIOAddTø˚Rec‹d
(
d©aKVIO
, 
	`THIS_LOCATION
(
NULL
));

589 
	`cou¡Com∂ëedBios
(
bio
);

592 #i‡
LINUX_VERSION_CODE
 >
	`KERNEL_VERSION
(4,13,0)

593 
d©aKVIO
->
ªadBlock
.
°©us
 = 
bio
->
bi_°©us
;

594 #ñi‡
LINUX_VERSION_CODE
 >
	`KERNEL_VERSION
(4,4,0)

595 
d©aKVIO
->
ªadBlock
.
°©us
 = 
bio
->
bi_îr‹
;

597 
d©aKVIO
->
ªadBlock
.
°©us
 = 
îr‹
;

599 
	`íqueueD©aKVIO
(
d©aKVIO
, 
ªadBlockCom∂ëi⁄W‹k
, 
NULL
,

600 
REQ_Q_ACTION_VIO_CALLBACK
);

601 
	}
}

624 
	$submôBioFromRódCache
(
D©aKVIO
 *
d©aKVIO
,

625 
BIO
 *
bio
,

626 
Tø˚Loˇti⁄
 
loˇti⁄
)

628 
IO_WORK_STRATEGY
) {

629 
IWS_RC_PBN_BIO_RR
:

630 
IWS_RC_BATCH_BIO_RR
:

632 
	`submôBio
(
bio
, 
d©aKVIO
->
ªadBlock
.
a˘i⁄
);

635 
IWS_RC_PBN_BIO_PBN
:

637 
KVIO
 *
kvio
 = 
	`d©aKVIOAsKVIO
(
d©aKVIO
);

640 
	`£ndBioToDevi˚
(
kvio
, 
bio
, 
loˇti⁄
);

645 
	`BUG
();

647 
	}
}

656 
	$ªadCacheInvÆid©ePBN
(
RódCache
 *
ªadCache
,

657 
PhysiˇlBlockNumbî
 
pbn
)

659 i‡(
	`ASSERT
(
ªadCache
 !
NULL
, "specifiedÑead cache")) {

663 
	`as£πRu¬ögInRCQueueF‹PBN
(
ªadCache
, 
pbn
);

665 
RódCacheZ⁄e
 *
z⁄e
 = 
	`z⁄eF‹PBN
(
ªadCache
, 
pbn
);

666 
	`lock
(
z⁄e
);

667 
	`ötM≠Remove
(
z⁄e
->
pbnM≠
, 
pbn
);

668 
	`u∆ock
(
z⁄e
);

669 
	}
}

672 
	$övÆid©ePBNAndC⁄töueVIO
(
KvdoW‹kIãm
 *
ôem
)

674 
KVIO
 *
kvio
 = 
	`w‹kIãmAsKVIO
(
ôem
);

676 
	`ªadCacheInvÆid©ePBN
(
kvio
->
œyî
->
ioSubmôãr
->
ªadCache
,

677 
kvio
->
vio
->
physiˇl
);

678 
	`kvdoEnqueueVIOCÆlback
(
kvio
);

679 
	}
}

692 
	$runRódCacheW‹kIãm
(
Kî√lLayî
 *
œyî
,

693 
PhysiˇlBlockNumbî
 
pbn
,

694 
KvdoW‹kIãm
 *
w‹kIãm
)

696 
IO_WORK_STRATEGY
) {

697 
IWS_RC_PBN_BIO_PBN
:

698 
IWS_RC_PBN_BIO_RR
:

701 
	`íqueueByPBNBioW‹kIãm
(
œyî
->
ioSubmôãr
, 
pbn
, 
w‹kIãm
);

707 
IWS_RC_BATCH_BIO_RR
:

708 
	`addToB©chPro˚ss‹
(
	`z⁄eF‹PBN
(
œyî
->
ioSubmôãr
->
ªadCache
,

709 
pbn
)->
b©chPro˚ss‹
,

710 
w‹kIãm
);

714 
	`BUG
();

716 
	}
}

719 #i‡
LINUX_VERSION_CODE
 >
KERNEL_VERSION
(4,4,0)

720 
	$övÆid©ePBNBioCÆlback
(
BIO
 *
bio
)

722 
	$övÆid©ePBNBioCÆlback
(
BIO
 *
bio
, 
îr‹
)

725 
bio
->
bi_íd_io
 = 
com∂ëeAsyncBio
;

727 
KVIO
 *
kvio
 = (KVIO *Ë
bio
->
bi_¥iv©e
;

728 
	`kvioAddTø˚Rec‹d
(
kvio
, 
	`THIS_LOCATION
("$F($io);cb=io($io)"));

729 
	`cou¡Com∂ëedBios
(
bio
);

730 #i‡
LINUX_VERSION_CODE
 >
	`KERNEL_VERSION
(4,13,0)

731 i‡(
	`u∆ikñy
(
bio
->
bi_°©us
)) {

732 
	`£tCom∂ëi⁄Resu…
(
	`vioAsCom∂ëi⁄
(
kvio
->
vio
), 
bio
->
bi_°©us
);

734 #ñi‡
LINUX_VERSION_CODE
 >
	`KERNEL_VERSION
(4,4,0)

735 i‡(
	`u∆ikñy
(
bio
->
bi_îr‹
)) {

736 
	`£tCom∂ëi⁄Resu…
(
	`vioAsCom∂ëi⁄
(
kvio
->
vio
), 
bio
->
bi_îr‹
);

739 i‡(
	`u∆ikñy
(
îr‹
)) {

740 
	`£tCom∂ëi⁄Resu…
(
	`vioAsCom∂ëi⁄
(
kvio
->
vio
), 
îr‹
);

744 
	`£tupKVIOW‹k
(
kvio
, 
övÆid©ePBNAndC⁄töueVIO
, 
NULL
,

745 
BIO_Q_ACTION_READCACHE
);

746 
	`runRódCacheW‹kIãm
(
kvio
->
œyî
, kvio->
vio
->
physiˇl
,

747 &
kvio
->
íqueuóbÀ
.
w‹kIãm
);

748 
	}
}

751 
	$övÆid©eCacheAndSubmôBio
(
KVIO
 *
kvio
, 
BioQA˘i⁄
 
a˘i⁄
)

753 
BIO
 *
bio
 = 
kvio
->bio;

754 
	`BUG_ON
(
bio
->
bi_íd_io
 !
com∂ëeAsyncBio
);

755 i‡(
kvio
->
œyî
->
ioSubmôãr
->
ªadCache
 !
NULL
) {

756 
bio
->
bi_íd_io
 = 
övÆid©ePBNBioCÆlback
;

758 
	`BUG_ON
(
bio
->
bi_¥iv©e
 !
kvio
);

759 
	`BUG_ON
(
bio
->
bi_bdev
 !
kvio
->
œyî
->
dev
->
bdev
);

760 
	`submôBio
(
bio
, 
a˘i⁄
);

761 
	}
}

765 
¥o˚ssRódCacheB©ch
(
B©chPro˚ss‹
 *
b©ch
,

766 *
˛osuª
 
__©åibuã__
((
unu£d
)))

768 
KvdoW‹kIãm
 *
	gw‹kIãm
;

769 (
	gw‹kIãm
 = 
√xtB©chIãm
(
b©ch
)Ë!
NULL
) {

772 
w‹kIãm
->
w‹k
(workItem);

781 
	$‰ìRódCacheZ⁄e
(
RódCacheZ⁄e
 **
ªadCacheZ⁄ePå
)

783 i‡(*
ªadCacheZ⁄ePå
 =
NULL
) {

787 
RódCacheZ⁄e
 *
z⁄e
 = *
ªadCacheZ⁄ePå
;

791 
RódCacheE¡ry
 *
ˇcheE¡ry
;

792 
RódCacheE¡ry
 *
ãmp
;

793 
	`li°_f‹_óch_íåy_ß„
(
ˇcheE¡ry
, 
ãmp
, &
z⁄e
->
‰ìLi°
, 
li°
) {

794 
ªfCou¡
 = 
	`gëCacheE¡ryRefCou¡
(
z⁄e
, 
ˇcheE¡ry
);

795 
	`ASSERT_LOG_ONLY
(
ªfCou¡
 == 0,

797 
ªfCou¡
, 
ˇcheE¡ry
);

798 
	`‰ìBio
(
ˇcheE¡ry
->
bio
, 
z⁄e
->
œyî
);

799 
	`FREE
(
ˇcheE¡ry
);

801 
boﬁ
 
fú°
 = 
åue
;

802 
	`li°_f‹_óch_íåy_ß„
(
ˇcheE¡ry
, 
ãmp
, &
z⁄e
->
ª˛aimLi°
, 
li°
) {

803 
ªfCou¡
 = 
	`gëCacheE¡ryRefCou¡
(
z⁄e
, 
ˇcheE¡ry
);

804 i‡(
ªfCou¡
 != 0) {

805 i‡(
fú°
) {

806 
	`ASSERT_LOG_ONLY
(
ªfCou¡
 == 0,

808 
ªfCou¡
, 
ˇcheE¡ry
);

809 
fú°
 = 
Ál£
;

812 
	`dumpRódCacheE¡ry
('R', 
ˇcheE¡ry
);

814 
	`‰ìBio
(
ˇcheE¡ry
->
bio
, 
z⁄e
->
œyî
);

815 
	`FREE
(
ˇcheE¡ry
);

817 
	`ASSERT_LOG_ONLY
(
	`li°_em±y
(&
z⁄e
->
busyLi°
),

819 
	`li°_f‹_óch_íåy_ß„
(
ˇcheE¡ry
, 
ãmp
, &
z⁄e
->
busyLi°
, 
li°
) {

820 
	`dumpRódCacheE¡ry
('B', 
ˇcheE¡ry
);

821 
	`‰ìBio
(
ˇcheE¡ry
->
bio
, 
z⁄e
->
œyî
);

822 
	`FREE
(
ˇcheE¡ry
);

824 
	`‰ìB©chPro˚ss‹
(&
z⁄e
->
b©chPro˚ss‹
);

825 
	`‰ìI¡M≠
(&
z⁄e
->
pbnM≠
);

826 
	`FREE
(
z⁄e
->
d©aBlocks
);

827 
	`FREE
(
z⁄e
->
blockM≠
);

828 
	`FREE
(
z⁄e
);

830 *
ªadCacheZ⁄ePå
 = 
NULL
;

831 
	}
}

834 
	$‰ìRódCache
(
RódCache
 **
ªadCachePå
)

836 
RódCache
 *
ªadCache
 = *
ªadCachePå
;

837 i‡(
ªadCache
 =
NULL
) {

840 *
ªadCachePå
 = 
NULL
;

842 
i
 = 0; i < 
ªadCache
->
z⁄eCou¡
; i++) {

843 
	`‰ìRódCacheZ⁄e
(&
ªadCache
->
z⁄es
[
i
]);

845 
	`FREE
(
ªadCache
);

846 
	}
}

858 
	$makeRódCacheZ⁄e
(
Kî√lLayî
 *
œyî
,

859 
z⁄eNumbî
,

860 
numE¡rõs
,

861 
RódCacheZ⁄e
 **
ªadCacheZ⁄ePå
)

863 
RódCacheZ⁄e
 *
z⁄e
;

864 
ªsu…
 = 
	`ALLOCATE
(1, 
RódCacheZ⁄e
, "ªad cachêz⁄e", &
z⁄e
);

865 i‡(
ªsu…
 !
VDO_SUCCESS
) {

866  
ªsu…
;

868 
z⁄e
->
numE¡rõs
 =ÇumEntries;

869 
ªsu…
 = 
	`ALLOCATE
(((
size_t
)
z⁄e
->
numE¡rõs
 * (size_t)
VDO_BLOCK_SIZE
),

870 , "ªad cachêd©a", &
z⁄e
->
d©aBlocks
);

871 i‡(
ªsu…
 !
VDO_SUCCESS
) {

872 
	`FREE
(
z⁄e
);

873  
ªsu…
;

875 
ªsu…
 = 
	`ALLOCATE
(
z⁄e
->
numE¡rõs
, 
RódCacheE¡ry
 *,

876 "ªad cachêblock m≠", &
z⁄e
->
blockM≠
);

877 i‡(
ªsu…
 !
VDO_SUCCESS
) {

878 
	`FREE
(
z⁄e
->
d©aBlocks
);

879 
	`FREE
(
z⁄e
);

880  
ªsu…
;

882 
	`•ö_lock_öô
(&
z⁄e
->
lock
);

883 
	`INIT_LIST_HEAD
(&
z⁄e
->
busyLi°
);

884 
	`INIT_LIST_HEAD
(&
z⁄e
->
ª˛aimLi°
);

885 
	`INIT_LIST_HEAD
(&
z⁄e
->
‰ìLi°
);

886 
ªsu…
 = 
	`makeI¡M≠
(
z⁄e
->
numE¡rõs
, 0, &z⁄e->
pbnM≠
);

887 i‡(
ªsu…
 !
VDO_SUCCESS
) {

888 
	`FREE
(
z⁄e
->
d©aBlocks
);

889 
	`FREE
(
z⁄e
);

890  
ªsu…
;

893 i‡(
IO_WORK_STRATEGY
 =
IWS_RC_BATCH_BIO_RR
) {

894 
ªsu…
 = 
	`makeB©chPro˚ss‹
(
œyî
, 
¥o˚ssRódCacheB©ch
, 
z⁄e
,

895 &
z⁄e
->
b©chPro˚ss‹
);

896 i‡(
ªsu…
 !
VDO_SUCCESS
) {

897 
	`‰ìRódCacheZ⁄e
(&
z⁄e
);

898  
ªsu…
;

902 
z⁄e
->
œyî
 =Üayer;

903 
i
 = 0; i < 
z⁄e
->
numE¡rõs
; i++) {

904 
RódCacheE¡ry
 *
ˇcheE¡ry
;

905 
ªsu…
 = 
	`ALLOCATE
(1, 
RódCacheE¡ry
, "ªad cachêíåy", &
ˇcheE¡ry
);

906 i‡(
ªsu…
 !
VDO_SUCCESS
) {

907 
	`‰ìRódCacheZ⁄e
(&
z⁄e
);

908  
ªsu…
;

910 
ˇcheE¡ry
->
pbn
 = 
INVALID_BLOCK
;

911 
ˇcheE¡ry
->
d©aBlock
 = 
z⁄e
->
d©aBlocks
 + ((
uöt64_t
)
i
 * 
VDO_BLOCK_SIZE
);

912 
ªsu…
 = 
	`¸óãBio
(
z⁄e
->
œyî
, 
ˇcheE¡ry
->
d©aBlock
, &ˇcheE¡ry->
bio
);

913 i‡(
ªsu…
 !
VDO_SUCCESS
) {

914 
	`FREE
(
ˇcheE¡ry
);

915 
	`‰ìRódCacheZ⁄e
(&
z⁄e
);

916  
ªsu…
;

918 
	`•ö_lock_öô
(&
ˇcheE¡ry
->
waôLock
);

919 
ˇcheE¡ry
->
z⁄e
 = zone;

920 
ˇcheE¡ry
->
íåyNum
 = 
i
;

921 
z⁄e
->
blockM≠
[
i
] = 
ˇcheE¡ry
;

922 
	`li°_add
(&
ˇcheE¡ry
->
li°
, &
z⁄e
->
‰ìLi°
);

925 *
ªadCacheZ⁄ePå
 = 
z⁄e
;

927  
VDO_SUCCESS
;

928 
	}
}

931 
	$makeRódCache
(
Kî√lLayî
 *
œyî
,

932 
numE¡rõs
,

933 
z⁄eCou¡
,

934 
RódCache
 **
ªadCachePå
)

936 
ªsu…
;

938 i‡(
IO_WORK_STRATEGY
 =
IWS_RC_BATCH_BIO_RR
) {

943 
ªsu…
 = 
	`ASSERT
(
z⁄eCou¡
 == 1,

945 i‡(
ªsu…
 !
UDS_SUCCESS
) {

946  
ªsu…
;

950 
RódCache
 *
ªadCache
;

951 
ªsu…
 = 
	`ALLOCATE_EXTENDED
(
RódCache
, 
z⁄eCou¡
, 
RódCacheZ⁄e
 *,

952 "ªad cache", &
ªadCache
);

953 i‡(
ªsu…
 !
VDO_SUCCESS
) {

954  
ªsu…
;

956 
ªadCache
->
œyî
 =Üayer;

957 
ªadCache
->
z⁄eCou¡
 = zoneCount;

958 
i
 = 0; i < 
z⁄eCou¡
; i++) {

959 
ªsu…
 = 
	`makeRódCacheZ⁄e
(
œyî
, 
i
, 
numE¡rõs
, &
ªadCache
->
z⁄es
[i]);

960 i‡(
ªsu…
 !
VDO_SUCCESS
) {

961 
	`‰ìRódCache
(&
ªadCache
);

962  
ªsu…
;

965 *
ªadCachePå
 = 
ªadCache
;

966  
VDO_SUCCESS
;

967 
	}
}

970 
	$ªadCacheZ⁄eRñó£BlockW‹k
(
KvdoW‹kIãm
 *
ôem
)

972 
RódCacheE¡ryRñó£
 *
ªÀa£


973 
	`c⁄èöî_of
(
ôem
, 
RódCacheE¡ryRñó£
, 
w‹kIãm
);

974 
RódCacheE¡ry
 *
ˇcheE¡ry
 = 
	`c⁄èöî_of
(
ªÀa£
, ReadCacheEntry,Ñelease);

976 
	`©omicAdd32
(&
ˇcheE¡ry
->
ªÀa£
.
ªÀa£s
, -1) > 0) {

977 
	`ªÀa£BlockI¡î«l
(
ˇcheE¡ry
);

979 
	`ªÀa£BlockI¡î«l
(
ˇcheE¡ry
);

980 
	}
}

998 
	$ªadCacheBlockCÆlback
(
KvdoW‹kIãm
 *
ôem
)

1000 
D©aKVIO
 *
d©aKVIO
 = 
	`w‹kIãmAsD©aKVIO
(
ôem
);

1001 
RódBlock
 *
ªadBlock
 = &
d©aKVIO
->readBlock;

1002 
Kî√lLayî
 *
œyî
 = 
	`gëLayîFromD©aKVIO
(
d©aKVIO
);

1003 
RódCache
 *
ªadCache
 = 
œyî
->
ioSubmôãr
->readCache;

1004 
RódCacheZ⁄e
 *
z⁄e
 = 
	`z⁄eF‹PBN
(
ªadCache
, 
ªadBlock
->
pbn
);

1006 i‡(
	`ASSERT
(
z⁄e
 !
NULL
, "specifiedÑead cache")) {

1007 
	`com∂ëeRód
(
d©aKVIO
, 
VDO_BAD_CONFIGURATION
);

1011 
	`as£πRu¬ögInRCQueueF‹PBN
(
ªadCache
, 
ªadBlock
->
pbn
);

1013 
RódCacheE¡ry
 *
ˇcheE¡ry
 = 
NULL
;

1014 
ªsu…
 = 
	`ÆloˇãBlockF‹RódI¡î«l
(
z⁄e
, 
ªadBlock
->
pbn
, &
ˇcheE¡ry
);

1015 i‡(
ªsu…
 !
VDO_SUCCESS
) {

1016 
	`com∂ëeRód
(
d©aKVIO
, 
ªsu…
);

1020 
ªadBlock
->
ˇcheE¡ry
 = cacheEntry;

1021 
ªadBlock
->
d©a
 = 
ˇcheE¡ry
->
d©aBlock
;

1023 
	`•ö_lock
(&
ˇcheE¡ry
->
waôLock
);

1024 i‡(
ˇcheE¡ry
->
d©aVÆid
) {

1025 
	`•ö_u∆ock
(&
ˇcheE¡ry
->
waôLock
);

1026 
	`com∂ëeRód
(
d©aKVIO
, 
VDO_SUCCESS
);

1030 
boﬁ
 
issueIO
 = !
	`hasWaôîs
(&
ˇcheE¡ry
->
ˇŒbackWaôîs
);

1031 
ªsu…
 = 
	`íqueueD©aVIO
(&
ˇcheE¡ry
->
ˇŒbackWaôîs
, &
d©aKVIO
->
d©aVIO
,

1032 
	`THIS_LOCATION
("$F($io)"));

1033 
	`•ö_u∆ock
(&
ˇcheE¡ry
->
waôLock
);

1035 i‡(
ªsu…
 !
VDO_SUCCESS
) {

1036 
	`com∂ëeRód
(
d©aKVIO
, 
ªsu…
);

1040 i‡(!
issueIO
) {

1044 
BIO
 *
bio
 = 
ˇcheE¡ry
->bio;

1045 
	`ª£tBio
(
bio
, 
œyî
);

1046 
	`£tBioSe˘‹
(
bio
, 
	`blockToSe˘‹
(
œyî
, 
ªadBlock
->
pbn
));

1047 
bio
->
bi_íd_io
 = 
ªadCacheBioCÆlback
;

1048 
bio
->
bi_¥iv©e
 = &
d©aKVIO
->
kvio
;

1050 
	`logDebug
("%s: submôtögÑódÑeque° f‹Öb¿%" 
PRIu64
, 
__func__
,

1051 
ªadBlock
->
pbn
);

1052 
	`ASSERT_LOG_ONLY
(
bio
->
bi_bdev
 =
œyî
->
dev
->
bdev
, "bi_bdeválready set");

1054 
	`submôBioFromRódCache
(
d©aKVIO
, 
bio
, 
	`THIS_LOCATION
("$F($io)"));

1055 
	}
}

1058 
	$kvdoRódBlock
(
D©aVIO
 *
d©aVIO
,

1059 
PhysiˇlBlockNumbî
 
loˇti⁄
,

1060 
BlockM≠pögSèã
 
m≠pögSèã
,

1061 
RódBlockO≥øti⁄
 
›î©i⁄
,

1062 
D©aKVIOCÆlback
 
ˇŒback
)

1064 
	`d©aVIOAddTø˚Rec‹d
(
d©aVIO
, 
	`THIS_LOCATION
(
NULL
));

1066 
BioQA˘i⁄
 
a˘i⁄
 = 
BIO_Q_ACTION_DATA
;

1067 
›î©i⁄
) {

1068 
READ_NO_OPERATION
:

1069 
	`logEº‹
("u√x≥˘ed RódBlockO≥øti⁄: %d", 
›î©i⁄
);

1072 
READ_COMPRESSED_DATA
:

1073 
a˘i⁄
 = 
BIO_Q_ACTION_COMPRESSED_DATA
;

1076 
READ_VERIFY_DEDUPE
:

1077 
a˘i⁄
 = 
BIO_Q_ACTION_VERIFY
;

1081 
	`logEº‹
("undeföed RódBlockO≥øti⁄: %d", 
›î©i⁄
);

1085 
D©aKVIO
 *
d©aKVIO
 = 
	`d©aVIOAsD©aKVIO
(
d©aVIO
);

1086 
RódBlock
 *
ªadBlock
 = &
d©aKVIO
->readBlock;

1087 
Kî√lLayî
 *
œyî
 = 
	`gëLayîFromD©aKVIO
(
d©aKVIO
);

1088 
	`runRódCacheRñó£Block
(
œyî
, 
ªadBlock
);

1090 
ªadBlock
->
pbn
 = 
loˇti⁄
;

1091 
ªadBlock
->
ˇŒback
 = callback;

1092 
ªadBlock
->
°©us
 = 
VDO_SUCCESS
;

1093 
ªadBlock
->
m≠pögSèã
 = mappingState;

1094 
ªadBlock
->
a˘i⁄
 =áction;

1096 
	`BUG_ON
(
	`gëBIOFromD©aKVIO
(
d©aKVIO
)->
bi_¥iv©e
 !&d©aKVIO->
kvio
);

1097 i‡(
ªadBlock
->
bio
 !
NULL
) {

1099 
BIO
 *
bio
 = 
ªadBlock
->bio;

1100 
	`ª£tBio
(
bio
, 
œyî
);

1101 
	`£tBioSe˘‹
(
bio
, 
	`blockToSe˘‹
(
œyî
, 
loˇti⁄
));

1102 #i‡
LINUX_VERSION_CODE
 >
	`KERNEL_VERSION
(4,10,0)

1103 
	`bio_£t_›_©ås
(
bio
, 
REQ_OP_READ
, 0);

1104 #ñi‡
LINUX_VERSION_CODE
 >
	`KERNEL_VERSION
(4,8,0)

1105 
bio
->
bi_›f
 = 
READ
;

1107 
bio
->
bi_rw
 = 
READ
;

1109 
bio
->
bi_íd_io
 = 
ªadBioCÆlback
;

1110 
	`BUG_ON
(
bio
->
bi_bdev
 !
œyî
->
dev
->
bdev
);

1111 
	`submôBio
(
bio
, 
a˘i⁄
);

1116 i‡(
IO_WORK_STRATEGY
 =
IWS_RC_PBN_BIO_PBN
) {

1119 
	`íqueueBioM≠
(
	`gëBIOFromD©aKVIO
(
d©aKVIO
), 
a˘i⁄
, 
ªadCacheBlockCÆlback
,

1120 
loˇti⁄
);

1124 i‡((
IO_WORK_STRATEGY
 =
IWS_RC_PBN_BIO_RR
)

1125 || (
IO_WORK_STRATEGY
 =
IWS_RC_BATCH_BIO_RR
)) {

1126 
KVIO
 *
kvio
 = 
	`d©aKVIOAsKVIO
(
d©aKVIO
);

1127 
	`£tupKVIOW‹k
(
kvio
, 
ªadCacheBlockCÆlback
, 
NULL
,

1128 
BIO_Q_ACTION_READCACHE
);

1129 
	`runRódCacheW‹kIãm
(
œyî
, 
loˇti⁄
, &
kvio
->
íqueuóbÀ
.
w‹kIãm
);

1133 
	`BUG
();

1134 
	}
}

1137 
	$runRódCacheRñó£Block
(
Kî√lLayî
 *
œyî
, 
RódBlock
 *
ªadBlock
)

1139 
ªadBlock
->
d©a
 = 
NULL
;

1140 i‡(
ªadBlock
->
ˇcheE¡ry
 =
NULL
) {

1144 
RódCacheZ⁄e
 *
z⁄e
 = 
	`z⁄eF‹PBN
(
œyî
->
ioSubmôãr
->
ªadCache
,

1145 
ªadBlock
->
pbn
);

1146 i‡(
	`ASSERT
(
z⁄e
 !
NULL
, "pbn mapsÅoÑead cache")) {

1150 i‡(
	`©omicAdd32
(&
ªadBlock
->
ˇcheE¡ry
->
ªÀa£
.
ªÀa£s
, 1) == 1) {

1151 
KvdoW‹kIãm
 *
w‹kIãm
 = &
ªadBlock
->
ˇcheE¡ry
->
ªÀa£
.workItem;

1152 
	`£tupW‹kIãm
(
w‹kIãm
, 
ªadCacheZ⁄eRñó£BlockW‹k
, 
NULL
,

1153 
BIO_Q_ACTION_HIGH
);

1154 
	`runRódCacheW‹kIãm
(
œyî
, 
ªadBlock
->
pbn
, 
w‹kIãm
);

1157 
ªadBlock
->
ˇcheE¡ry
 = 
NULL
;

1158 
	}
}

1161 
	$dumpRódCacheE¡ry
(
èg
, 
RódCacheE¡ry
 *
íåy
)

1168 
	`•ö_lock
(&
íåy
->
waôLock
);

1170 
Waôî
 *
fú°
 = 
	`gëFú°Waôî
(&
íåy
->
ˇŒbackWaôîs
);

1171 *
maybeWaôîs
 = (
fú°
 !
NULL
) ? " waiters" : "";

1180 
uöt32_t
 
ªfCou¡
 = 
	`ªœxedLﬂd32
(&
íåy
->refCount);

1181 i‡(
íåy
->
îr‹
 == 0) {

1182 
	`logInfo
(" #%d %c%†R%u P%" 
PRIu64
 " @%p%s",

1183 
íåy
->
íåyNum
, 
èg
,

1184 
íåy
->
d©aVÆid
 ? "" : "I",

1185 
ªfCou¡
, 
íåy
->
pbn
,

1186 
íåy
->
d©aBlock
,

1187 
maybeWaôîs
);

1189 
	`logInfo
(" #%d %c%†R%u P%" 
PRIu64
 " @%pÉrr%d %s",

1190 
íåy
->
íåyNum
, 
èg
,

1191 
íåy
->
d©aVÆid
 ? "" : "I",

1192 
ªfCou¡
, 
íåy
->
pbn
,

1193 
íåy
->
d©aBlock
,É¡ry->
îr‹
,

1194 
maybeWaôîs
);

1197 i‡(
fú°
 !
NULL
) {

1198 
Waôî
 *
waôî
 = 
fú°
;

1200 
D©aVIO
 *
d©aVIO
 = 
	`waôîAsD©aVIO
(
waôî
);

1205 
	`logInfo
(" D©aVIO %∞P%" 
PRIu64
 " L%" PRIu64 " D%" PRIu64 " op %s",

1206 
d©aVIO
, d©aVIO->
m≠≥d
.
pbn
, d©aVIO->
logiˇl
.
lbn
,

1207 
d©aVIO
->
du∂iˇã
.
pbn
, 
	`gëO≥øti⁄Name
(dataVIO));

1208 
waôî
 = waôî->
√xtWaôî
;

1209 } 
waôî
 !
fú°
);

1212 
	`•ö_u∆ock
(&
íåy
->
waôLock
);

1213 
	}
}

1216 
	$ªadCacheZ⁄eDump
(
RódCacheZ⁄e
 *
z⁄e
,

1217 
boﬁ
 
dumpBusyEÀmíts
,

1218 
boﬁ
 
dumpAŒEÀmíts
)

1220 i‡(
	`ASSERT
(
z⁄e
 !
NULL
, "specifiedÑead cache")) {

1227 
	`logInfo
("Read cache %p:"

1228 " %" 
PRIu64
 "áccesses %" PRIu64 " hits %" PRIu64 " data hits"

1230 
z⁄e
,

1231 
z⁄e
->
°©s
.
ac˚s£s
, z⁄e->°©s.
hôs
, z⁄e->°©s.
d©aHôs
,

1232 
z⁄e
->
numE¡rõs
);

1234 
numFªeIãms
 = 0;

1235 
numRe˛aimIãms
 = 0;

1236 
numBusyIãms
 = 0;

1238 
i
 = 0; i < 
z⁄e
->
numE¡rõs
; i++) {

1239 
CacheE¡rySèã
 
°©e
 = 
	`gëSèã
(
z⁄e
->
blockM≠
[
i
]);

1240 
°©e
) {

1241 
RC_FREE
:

1242 
numFªeIãms
++;

1243 i‡(
dumpAŒEÀmíts
) {

1244 
	`dumpRódCacheE¡ry
('F', 
z⁄e
->
blockM≠
[
i
]);

1248 
RC_IN_USE
:

1249 
RC_IN_USE_PBN
:

1250 
numBusyIãms
++;

1251 i‡(
dumpBusyEÀmíts
 || 
dumpAŒEÀmíts
) {

1252 
	`dumpRódCacheE¡ry
('B', 
z⁄e
->
blockM≠
[
i
]);

1256 
RC_RECLAIMABLE
:

1257 
numRe˛aimIãms
++;

1258 i‡(
dumpAŒEÀmíts
) {

1259 
	`dumpRódCacheE¡ry
('R', 
z⁄e
->
blockM≠
[
i
]);

1264 
	`ASSERT_LOG_ONLY
(
Ál£
,

1265 "ˇchêíåy sèã (%dËam⁄gÉx≥˘ed vÆues", 
°©e
);

1270 
	`logInfo
("Read cache %p: %u free %uÑeclaimable %u busy",

1271 
z⁄e
, 
numFªeIãms
, 
numRe˛aimIãms
, 
numBusyIãms
);

1272 
	}
}

1275 
	$ªadCacheDump
(
RódCache
 *
ªadCache
,

1276 
boﬁ
 
dumpBusyEÀmíts
,

1277 
boﬁ
 
dumpAŒEÀmíts
)

1279 i‡(
ªadCache
 =
NULL
) {

1283 
i
 = 0; i < 
ªadCache
->
z⁄eCou¡
; i++) {

1284 
	`logInfo
("Ród cachêz⁄ê%d:", 
i
);

1285 
	`ªadCacheZ⁄eDump
(
ªadCache
->
z⁄es
[
i
],

1286 
dumpBusyEÀmíts
, 
dumpAŒEÀmíts
);

1288 
	}
}

	@vdo/kernel/readCache.h

21 #i‚de‡
READCACHE_H


22 
	#READCACHE_H


	)

24 
	~"d©aKVIO.h
"

25 
	~"ioSubmôãr.h
"

26 
	~"kî√lLayî.h
"

28 
	eªadBlockO≥øti⁄
 {

29 
	mREAD_NO_OPERATION
 = 0,

30 
	mREAD_COMPRESSED_DATA
,

31 
	mREAD_VERIFY_DEDUPE
,

32 } 
	tRódBlockO≥øti⁄
;

44 
makeRódCache
(
Kî√lLayî
 *
œyî
,

45 
numE¡rõs
,

46 
z⁄eCou¡
,

47 
RódCache
 **
ªadCachePå
);

54 
‰ìRódCache
(
RódCache
 **
ªadCachePå
);

68 
kvdoRódBlock
(
D©aVIO
 *
d©aVIO
,

69 
PhysiˇlBlockNumbî
 
loˇti⁄
,

70 
BlockM≠pögSèã
 
m≠pögSèã
,

71 
RódBlockO≥øti⁄
 
›î©i⁄
,

72 
D©aKVIOCÆlback
 
ˇŒback
);

82 
runRódCacheRñó£Block
(
Kî√lLayî
 *
œyî
, 
RódBlock
 *
ªadBlock
);

91 
RódCacheSèts
 
ªadCacheGëSèts
(
RódCache
 *
ªadCache
);

100 
ªadCacheDump
(
RódCache
 *
ªadCache
,

101 
boﬁ
 
dumpBusyEÀmíts
,

102 
boﬁ
 
dumpAŒEÀmíts
);

116 
övÆid©eCacheAndSubmôBio
(
KVIO
 *
kvio
, 
BioQA˘i⁄
 
a˘i⁄
);

	@vdo/kernel/statusCodeBlocks.h

22 #i‚de‡
STATUS_CODE_BLOCKS_H


23 
	#STATUS_CODE_BLOCKS_H


	)

26 
	mUDS_BLOCK_SIZE
 = 
UDS_ERROR_CODE_BLOCK_END
 - 
UDS_ERROR_CODE_BASE
,

27 
	mVDO_BLOCK_START
 = 
UDS_ERROR_CODE_BLOCK_END
,

28 
	mVDO_BLOCK_END
 = 
VDO_BLOCK_START
 + 
UDS_BLOCK_SIZE
,

29 
	mPRP_BLOCK_START
 = 
VDO_BLOCK_END
,

30 
	mPRP_BLOCK_END
 = 
PRP_BLOCK_START
 + 
UDS_BLOCK_SIZE
,

	@vdo/kernel/statusProcfs.c

35 
	~"°©usProcfs.h
"

37 
	~<löux/vîsi⁄.h
>

39 
	~"mem‹yAŒoc.h
"

41 
	~"ªÀa£Vîsi⁄s.h
"

42 
	~"°©i°ics.h
"

43 
	~"vdo.h
"

45 
	~"dedu≥Index.h
"

46 
	~"ioSubmôãr.h
"

47 
	~"kî√lSèti°ics.h
"

48 
	~"loggî.h
"

49 
	~"mem‹yUßge.h
"

50 
	~"thªadDevi˚.h
"

51 
	~"vdoComm⁄.h
"

53 
¥oc_dú_íåy
 *
	g¥ocfsRoŸ
 = 
NULL
;

56 
	$°©usDedu≥Show
(
£q_fûe
 *
m
, *
v
)

58 
Kî√lLayî
 *
œyî
 = (Kî√lLayî *Ë
m
->
¥iv©e
;

59 
VDOSèti°ics
 *
°©s
;

60 
size_t
 
Àn
 = (
VDOSèti°ics
);

61 
Regi°îedThªad
 
ÆloˇtögThªad
, 
ö°™˚Thªad
;

62 
	`ªgi°îAŒoˇtögThªad
(&
ÆloˇtögThªad
, 
NULL
);

63 
	`ªgi°îThªadDevi˚
(&
ö°™˚Thªad
, 
œyî
);

64 
ªsu…
 = 
	`ALLOCATE
(1, 
VDOSèti°ics
, 
__func__
, &
°©s
);

65 i‡(
ªsu…
 =
VDO_SUCCESS
) {

66 
	`gëKVDOSèti°ics
(&
œyî
->
kvdo
, 
°©s
);

67 
	`£q_wrôe
(
m
, 
°©s
, 
Àn
);

68 
	`FREE
(
°©s
);

70 
	`uƒegi°îThªadDevi˚ID
();

71 
	`uƒegi°îAŒoˇtögThªad
();

72  
ªsu…
;

73 
	}
}

76 
	$°©usDedu≥O≥n
(
öode
 *öode, 
fûe
 *file)

78 #i‡
LINUX_VERSION_CODE
 >
	`KERNEL_VERSION
(3,10,0)

79  
	`sögÀ_›í
(
fûe
, 
°©usDedu≥Show
, 
	`PDE_DATA
(
öode
));

81  
	`sögÀ_›í
(
fûe
, 
°©usDedu≥Show
, 
	`PDE
(
öode
)->
d©a
);

83 
	}
}

85 c⁄° 
fûe_›î©i⁄s
 
	gvdoProcfsDedu≥Ops
 = {

86 .
›í
 = 
°©usDedu≥O≥n
,

87 .
	gªad
 = 
£q_ªad
,

88 .
	gŒ£ek
 = 
£q_l£ek
,

89 .
	gªÀa£
 = 
sögÀ_ªÀa£
,

93 
	$c›yBioSèt
(
BioSèts
 *
b
, c⁄° 
AtomicBioSèts
 *
a
)

95 
b
->
ªad
 = 
	`©omic64_ªad
(&
a
->read);

96 
b
->
wrôe
 = 
	`©omic64_ªad
(&
a
->write);

97 
b
->
disˇrd
 = 
	`©omic64_ªad
(&
a
->discard);

98 
b
->
Êush
 = 
	`©omic64_ªad
(&
a
->flush);

99 
b
->
fua
 = 
	`©omic64_ªad
(&
a
->fua);

100 
	}
}

103 
BioSèts
 
	$subåa˘BioSèts
(
BioSèts
 
möuíd
, BioSèt†
subåahíd
)

105  (
BioSèts
) {

106 .
ªad
 = 
möuíd
.ªad - 
subåahíd
.read,

107 .
wrôe
 = 
möuíd
.wrôê- 
subåahíd
.write,

108 .
disˇrd
 = 
möuíd
.disˇrd - 
subåahíd
.discard,

109 .
Êush
 = 
möuíd
.Êush - 
subåahíd
.flush,

110 .
fua
 = 
möuíd
.fu®- 
subåahíd
.fua,

112 
	}
}

115 
	$gëKî√lSèts
(
Kî√lLayî
 *
œyî
, 
Kî√lSèti°ics
 *
°©s
)

117 
°©s
->
vîsi⁄
 = 
STATISTICS_VERSION
;

118 
°©s
->
ªÀa£Vîsi⁄
 = 
CURRENT_RELEASE_VERSION_NUMBER
;

119 
°©s
->
ö°™˚
 = 
œyî
->instance;

120 
	`gëLimôîVÆuesAtomiˇŒy
(&
œyî
->
ªque°Limôî
,

121 &
°©s
->
cuºítVIOsInProgªss
, &°©s->
maxVIOs
);

122 
°©s
->
dedu≥Advi˚VÆid
 = 
	`©omic64_ªad
(&
œyî
->dedupeAdviceValid);

123 
°©s
->
dedu≥Advi˚SèÀ
 = 
	`©omic64_ªad
(&
œyî
->dedupeAdviceStale);

124 
°©s
->
dedu≥Advi˚Timeouts


125 
	`gëEvítCou¡
(&
œyî
->
ÆbúeoTimeoutRï‹ãr
);

126 
°©s
->
cuºDedu≥Quîõs
 = 
	`gëNumbîOut°™dög
(
œyî
->
dedu≥Index
);

127 
°©s
->
maxDedu≥Quîõs
 = 
	`gëMaximumOut°™dög
(
œyî
->
dedu≥Index
);

128 
°©s
->
ÊushOut
 = 
	`©omic64_ªad
(&
œyî
->flushOut);

129 
°©s
->
logiˇlBlockSize
 = 
œyî
->logicalBlockSize;

130 
	`c›yBioSèt
(&
°©s
->
biosIn
, &
œyî
->biosIn);

131 
	`c›yBioSèt
(&
°©s
->
biosInP¨tül
, &
œyî
->biosInPartial);

132 
	`c›yBioSèt
(&
°©s
->
biosOut
, &
œyî
->biosOut);

133 
	`c›yBioSèt
(&
°©s
->
biosMëa
, &
œyî
->biosMeta);

134 
	`c›yBioSèt
(&
°©s
->
biosJou∫Æ
, &
œyî
->biosJournal);

135 
	`c›yBioSèt
(&
°©s
->
biosPageCache
, &
œyî
->biosPageCache);

136 
	`c›yBioSèt
(&
°©s
->
biosOutCom∂ëed
, &
œyî
->biosOutCompleted);

137 
	`c›yBioSèt
(&
°©s
->
biosMëaCom∂ëed
, &
œyî
->biosMetaCompleted);

138 
	`c›yBioSèt
(&
°©s
->
biosJou∫ÆCom∂ëed
, &
œyî
->biosJournalCompleted);

139 
	`c›yBioSèt
(&
°©s
->
biosPageCacheCom∂ëed
,

140 &
œyî
->
biosPageCacheCom∂ëed
);

141 
	`c›yBioSèt
(&
°©s
->
biosAcknowÀdged
, &
œyî
->biosAcknowledged);

142 
	`c›yBioSèt
(&
°©s
->
biosAcknowÀdgedP¨tül
,

143 &
œyî
->
biosAcknowÀdgedP¨tül
);

144 
°©s
->
biosInProgªss
 = 
	`subåa˘BioSèts
(°©s->
biosIn
,

145 
°©s
->
biosAcknowÀdged
);

146 
	`gëBioW‹kQueueRódCacheSèts
(
œyî
->
ioSubmôãr
, &
°©s
->
ªadCache
);

147 
°©s
->
mem‹yUßge
 = 
	`gëMem‹yUßge
();

148 
	}
}

151 
	$°©usKî√lShow
(
£q_fûe
 *
m
, *
v
)

153 
Kî√lLayî
 *
œyî
 = (Kî√lLayî *Ë
m
->
¥iv©e
;

154 
Kî√lSèti°ics
 *
°©s
;

155 
size_t
 
Àn
 = (
Kî√lSèti°ics
);

156 
Regi°îedThªad
 
ÆloˇtögThªad
, 
ö°™˚Thªad
;

157 
	`ªgi°îAŒoˇtögThªad
(&
ÆloˇtögThªad
, 
NULL
);

158 
	`ªgi°îThªadDevi˚
(&
ö°™˚Thªad
, 
œyî
);

159 
ªsu…
 = 
	`ALLOCATE
(1, 
Kî√lSèti°ics
, 
__func__
, &
°©s
);

160 i‡(
ªsu…
 =
VDO_SUCCESS
) {

161 
	`gëKî√lSèts
(
œyî
, 
°©s
);

162 
	`£q_wrôe
(
m
, 
°©s
, 
Àn
);

163 
	`FREE
(
°©s
);

165 
	`uƒegi°îThªadDevi˚ID
();

166 
	`uƒegi°îAŒoˇtögThªad
();

167  
ªsu…
;

168 
	}
}

171 
	$°©usKî√lO≥n
(
öode
 *öode, 
fûe
 *file)

173 #i‡
LINUX_VERSION_CODE
 >
	`KERNEL_VERSION
(3,10,0)

174  
	`sögÀ_›í
(
fûe
, 
°©usKî√lShow
, 
	`PDE_DATA
(
öode
));

176  
	`sögÀ_›í
(
fûe
, 
°©usKî√lShow
, 
	`PDE
(
öode
)->
d©a
);

178 
	}
}

180 c⁄° 
fûe_›î©i⁄s
 
	gvdoProcfsKî√lOps
 = {

181 .
›í
 = 
°©usKî√lO≥n
,

182 .
	gªad
 = 
£q_ªad
,

183 .
	gŒ£ek
 = 
£q_l£ek
,

184 .
	gªÀa£
 = 
sögÀ_ªÀa£
,

188 
	$vdoInôProcfs
()

190 c⁄° *
¥ocfsName
 = 
	`gëProcRoŸ
();

191 
¥ocfsRoŸ
 = 
	`¥oc_mkdú
(
¥ocfsName
, 
NULL
);

192 i‡(
¥ocfsRoŸ
 =
NULL
) {

193 
	`logW¨nög
("CouldÇŸ cª©ê¥o¯fûesy°emÑoŸ %s\n", 
¥ocfsName
);

194  -
ENOMEM
;

196  
VDO_SUCCESS
;

197 
	}
}

200 
	$vdoDe°royProcfs
()

202 
	`ªmove_¥oc_íåy
(
	`gëProcRoŸ
(), 
NULL
);

203 
¥ocfsRoŸ
 = 
NULL
;

204 
	}
}

207 
	$vdoCª©eProcfsE¡ry
(
Kî√lLayî
 *
œyî
, c⁄° *
«me
, **
¥iv©e
)

209 
ªsu…
 = 
VDO_SUCCESS
;

211 i‡(
¥ocfsRoŸ
 !
NULL
) {

212 
¥oc_dú_íåy
 *
fsDú
;

213 
fsDú
 = 
	`¥oc_mkdú
(
«me
, 
¥ocfsRoŸ
);

214 i‡(
fsDú
 =
NULL
) {

215 
ªsu…
 = -
ENOMEM
;

217 i‡(
	`¥oc_¸óã_d©a
(
	`gëVDOSèti°icsProcFûe
(), 0644, 
fsDú
,

218 &
vdoProcfsDedu≥Ops
, 
œyî
Ë=
NULL
) {

219 
ªsu…
 = -
ENOMEM
;

220 } i‡(
	`¥oc_¸óã_d©a
(
	`gëKî√lSèti°icsProcFûe
(), 0644, 
fsDú
,

221 &
vdoProcfsKî√lOps
, 
œyî
Ë=
NULL
) {

222 
ªsu…
 = -
ENOMEM
;

225 i‡(
ªsu…
 < 0) {

226 
	`vdoDe°royProcfsE¡ry
(
«me
, 
fsDú
);

228 *
¥iv©e
 = 
fsDú
;

231 
	`logW¨nög
("Nÿ¥o¯fûesy°emÑoŸ së, skùpög %s\n", 
«me
);

233  
ªsu…
;

234 
	}
}

237 
	$vdoDe°royProcfsE¡ry
(c⁄° *
«me
, *
¥iv©e
)

239 i‡(
¥ocfsRoŸ
 !
NULL
) {

240 #i‡
LINUX_VERSION_CODE
 >
	`KERNEL_VERSION
(3,10,0)

241 
	`ªmove_¥oc_subåì
(
«me
, 
¥ocfsRoŸ
);

243 
¥oc_dú_íåy
 *
fsDú
 = (¥oc_dú_íåy *Ë
¥iv©e
;

244 
	`ªmove_¥oc_íåy
(
	`gëVDOSèti°icsProcFûe
(), 
fsDú
);

245 
	`ªmove_¥oc_íåy
(
	`gëKî√lSèti°icsProcFûe
(), 
fsDú
);

246 
	`ªmove_¥oc_íåy
(
«me
, 
¥ocfsRoŸ
);

249 
	}
}

	@vdo/kernel/statusProcfs.h

23 #i‚de‡
STATUS_PROC_H


24 
	#STATUS_PROC_H


	)

26 
	~<löux/¥oc_fs.h
>

27 
	~<löux/£q_fûe.h
>

28 
	~"kî√lLayî.h
"

36 
vdoInôProcfs
();

42 
vdoDe°royProcfs
();

54 
vdoCª©eProcfsE¡ry
(
Kî√lLayî
 *
œyî
, c⁄° *
«me
, **
¥iv©e
);

63 
vdoDe°royProcfsE¡ry
(c⁄° *
«me
, *
¥iv©e
);

71 
gëKî√lSèts
(
Kî√lLayî
 *
œyî
, 
Kî√lSèti°ics
 *
°©s
);

	@vdo/kernel/sysfs.c

22 
	~"sysfs.h
"

24 
	~<löux/moduÀ.h
>

25 
	~<löux/vîsi⁄.h
>

27 
	~"dedu≥Index.h
"

28 
	~"dmvdo.h
"

29 
	~"loggî.h
"

31 
	#HAS_MAX_DISCARD_SECTORS
 (
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(4,3,0))

	)

33 #i‡
HAS_MAX_DISCARD_SECTORS


34 
maxDisˇrdSe˘‹s
;

37 
deÁu…MaxReque°sA˘ive
;

39 
	svdoAâribuã
 {

40 
©åibuã
 
	m©å
;

41 
ssize_t
 (*
show
)(
kvdoDevi˚
 *
	md
, 
©åibuã
 *
	m©å
, *
	mbuf
);

42 
ssize_t
 (*
°‹e
)(
kvdoDevi˚
 *
	md
, c⁄° *
	mvÆue
, 
size_t
 
	mcou¡
);

44 *
	mvÆuePå
;

45 } 
	tVDOAâribuã
;

47 *
	g°©usSåögs
[] = {

54 
ssize_t
 
	$vdoSètusShow
(
kvdoDevi˚
 *
devi˚
,

55 
©åibuã
 *
©å
,

56 *
buf
)

58  
	`•rötf
(
buf
, "%s\n", 
°©usSåögs
[
devi˚
->
°©us
]);

59 
	}
}

62 
ssize_t
 
	$vdoLogLevñShow
(
kvdoDevi˚
 *
devi˚
,

63 
©åibuã
 *
©å
,

64 *
buf
)

66  
	`•rötf
(
buf
, "%s\n", 
	`¥i‹ôyToSåög
(
	`gëLogLevñ
()));

67 
	}
}

70 
ssize_t
 
	$vdoLogLevñSt‹e
(
kvdoDevi˚
 *
devi˚
,

71 c⁄° *
buf
, 
size_t
 
n
)

73 
öã∫ÆBuf
[11];

75 i‡(
n
 > 10) {

76  -
EINVAL
;

79 
	`mem£t
(
öã∫ÆBuf
, '\000', (internalBuf));

80 
	`mem˝y
(
öã∫ÆBuf
, 
buf
, 
n
);

81 i‡(
öã∫ÆBuf
[
n
 - 1] == '\n') {

82 
öã∫ÆBuf
[
n
 - 1] = '\000';

84 
	`£tLogLevñ
(
	`°rögToPri‹ôy
(
öã∫ÆBuf
));

85  
n
;

86 
	}
}

89 
ssize_t
 
	$sˇnI¡
(c⁄° *
buf
,

90 
size_t
 
n
,

91 *
vÆuePå
,

92 
möimum
,

93 
maximum
)

95 i‡(
n
 > 12) {

96  -
EINVAL
;

98 
vÆue
;

99 i‡(
	`ssˇnf
(
buf
, "%d", &
vÆue
) != 1) {

100  -
EINVAL
;

102 i‡(
vÆue
 < 
möimum
) {

103 
vÆue
 = 
möimum
;

104 } i‡(
vÆue
 > 
maximum
) {

105 
vÆue
 = 
maximum
;

107 *
vÆuePå
 = 
vÆue
;

108  
n
;

109 
	}
}

112 
ssize_t
 
	$showI¡
(
kvdoDevi˚
 *
devi˚
,

113 
©åibuã
 *
©å
,

114 *
buf
)

116 
VDOAâribuã
 *
vdoAâr
 = 
	`c⁄èöî_of
(
©å
, VDOAttribute,áttr);

118  
	`•rötf
(
buf
, "%d\n", *(*)
vdoAâr
->
vÆuePå
);

119 
	}
}

122 
ssize_t
 
	$sˇnUI¡
(c⁄° *
buf
,

123 
size_t
 
n
,

124 *
vÆuePå
,

125 
möimum
,

126 
maximum
)

128 i‡(
n
 > 12) {

129  -
EINVAL
;

131 
vÆue
;

132 i‡(
	`ssˇnf
(
buf
, "%u", &
vÆue
) != 1) {

133  -
EINVAL
;

135 i‡(
vÆue
 < 
möimum
) {

136 
vÆue
 = 
möimum
;

137 } i‡(
vÆue
 > 
maximum
) {

138 
vÆue
 = 
maximum
;

140 *
vÆuePå
 = 
vÆue
;

141  
n
;

142 
	}
}

145 
ssize_t
 
	$showUI¡
(
kvdoDevi˚
 *
devi˚
,

146 
©åibuã
 *
©å
,

147 *
buf
)

149 
VDOAâribuã
 *
vdoAâr
 = 
	`c⁄èöî_of
(
©å
, VDOAttribute,áttr);

151  
	`•rötf
(
buf
, "%u\n", *(*)
vdoAâr
->
vÆuePå
);

152 
	}
}

155 
ssize_t
 
	$sˇnBoﬁ
(c⁄° *
buf
, 
size_t
 
n
, 
boﬁ
 *
vÆuePå
)

157 
ötVÆue
 = 0;

158 
n
 = 
	`sˇnUI¡
(
buf
,Ç, &
ötVÆue
, 0, 1);

159 i‡(
n
 > 0) {

160 *
vÆuePå
 = (
ötVÆue
 != 0);

162  
n
;

163 
	}
}

166 
ssize_t
 
	$showBoﬁ
(
kvdoDevi˚
 *
devi˚
,

167 
©åibuã
 *
©å
,

168 *
buf
)

170 
VDOAâribuã
 *
vdoAâr
 = 
	`c⁄èöî_of
(
©å
, VDOAttribute,áttr);

172  
	`•rötf
(
buf
, "%u\n", *(
boﬁ
 *)
vdoAâr
->
vÆuePå
 ? 1 : 0);

173 
	}
}

176 
ssize_t
 
	$vdoTø˚Rec‹dögSt‹e
(
kvdoDevi˚
 *
devi˚
,

177 c⁄° *
buf
,

178 
size_t
 
n
)

180  
	`sˇnBoﬁ
(
buf
, 
n
, &
åa˚Rec‹dög
);

181 
	}
}

184 
ssize_t
 
	$vdoMaxReqA˘iveSt‹e
(
kvdoDevi˚
 *
devi˚
,

185 c⁄° *
buf
,

186 
size_t
 
n
)

194  
	`sˇnI¡
(
buf
, 
n
, &
deÁu…MaxReque°sA˘ive
, 1, 
MAXIMUM_USER_VIOS
);

195 
	}
}

197 #i‡
HAS_MAX_DISCARD_SECTORS


199 
ssize_t
 
	$vdoMaxDisˇrdSe˘‹s
(
kvdoDevi˚
 *
devi˚
,

200 c⁄° *
buf
,

201 
size_t
 
n
)

203  
	`sˇnUI¡
(
buf
, 
n
, &
maxDisˇrdSe˘‹s
, 8, 
UINT_MAX
);

204 
	}
}

208 
ssize_t
 
	$vdoAlbúeoTimeoutI¡îvÆSt‹e
(
kvdoDevi˚
 *
devi˚
,

209 c⁄° *
buf
,

210 
size_t
 
n
)

212 
vÆue
;

213 
ssize_t
 
ªsu…
 = 
	`sˇnUI¡
(
buf
, 
n
, &
vÆue
, 0, 
UINT_MAX
);

214 i‡(
ªsu…
 > 0) {

215 
	`£tAlbúeoTimeoutI¡îvÆ
(
vÆue
);

217  
ªsu…
;

218 
	}
}

221 
ssize_t
 
	$vdoMöAlbúeoTimîI¡îvÆSt‹e
(
kvdoDevi˚
 *
devi˚
,

222 c⁄° *
buf
,

223 
size_t
 
n
)

225 
vÆue
;

226 
ssize_t
 
ªsu…
 = 
	`sˇnUI¡
(
buf
, 
n
, &
vÆue
, 0, 
UINT_MAX
);

227 i‡(
ªsu…
 > 0) {

228 
	`£tMöAlbúeoTimîI¡îvÆ
(
vÆue
);

230  
ªsu…
;

231 
	}
}

234 
ssize_t
 
	$vdoAârShow
(
kobje˘
 *
kobj
,

235 
©åibuã
 *
©å
,

236 *
buf
)

238 
VDOAâribuã
 *
vdoAâr
 = 
	`c⁄èöî_of
(
©å
, VDOAttribute,áttr);

239 i‡(
vdoAâr
->
show
 =
NULL
) {

240  -
EINVAL
;

243 
kvdoDevi˚
 *
devi˚
 = 
	`c⁄èöî_of
(
kobj
, kvdoDevice, kobj);

244  (*
vdoAâr
->
show
)(
devi˚
, 
©å
, 
buf
);

245 
	}
}

248 
ssize_t
 
	$vdoAârSt‹e
(
kobje˘
 *
kobj
,

249 
©åibuã
 *
©å
,

250 c⁄° *
buf
,

251 
size_t
 
Àngth
)

253 
VDOAâribuã
 *
vdoAâr
 = 
	`c⁄èöî_of
(
©å
, VDOAttribute,áttr);

254 i‡(
vdoAâr
->
°‹e
 =
NULL
) {

255  -
EINVAL
;

258 
kvdoDevi˚
 *
devi˚
 = 
	`c⁄èöî_of
(
kobj
, kvdoDevice, kobj);

259  (*
vdoAâr
->
°‹e
)(
devi˚
, 
buf
, 
Àngth
);

260 
	}
}

262 
VDOAâribuã
 
	gvdoSètusAâr
 = {

263 .
©å
 = { .
«me
 = "°©us", .
	gmode
 = 0444, },

264 .
	gshow
 = 
vdoSètusShow
,

267 
VDOAâribuã
 
	gvdoLogLevñAâr
 = {

268 .
©å
 = {.
«me
 = "log_Àvñ", .
	gmode
 = 0644, },

269 .
	gshow
 = 
vdoLogLevñShow
,

270 .
	g°‹e
 = 
vdoLogLevñSt‹e
,

273 
VDOAâribuã
 
	gvdoMaxReqA˘iveAâr
 = {

274 .
©å
 = {.
«me
 = "max_ªque°s_a˘ive", .
	gmode
 = 0644, },

275 .
	gshow
 = 
showI¡
,

276 .
	g°‹e
 = 
vdoMaxReqA˘iveSt‹e
,

277 .
	gvÆuePå
 = &
deÁu…MaxReque°sA˘ive
,

280 #i‡
HAS_MAX_DISCARD_SECTORS


281 
VDOAâribuã
 
	gvdoMaxDisˇrdSe˘‹sAâr
 = {

282 .
©å
 = {.
«me
 = "max_disˇrd_£˘‹s", .
	gmode
 = 0644, },

283 .
	gshow
 = 
showUI¡
,

284 .
	g°‹e
 = 
vdoMaxDisˇrdSe˘‹s
,

285 .
	gvÆuePå
 = &
maxDisˇrdSe˘‹s
,

289 
VDOAâribuã
 
	gvdoAlbúeoTimeoutI¡îvÆ
 = {

290 .
©å
 = {.
«me
 = "dedu∂iˇti⁄_timeout_öãrvÆ", .
	gmode
 = 0644, },

291 .
	gshow
 = 
showUI¡
,

292 .
	g°‹e
 = 
vdoAlbúeoTimeoutI¡îvÆSt‹e
,

293 .
	gvÆuePå
 = &
ÆbúeoTimeoutI¡îvÆ
,

296 
VDOAâribuã
 
	gvdoMöAlbúeoTimîI¡îvÆ
 = {

297 .
©å
 = {.
«me
 = "mö_dedu∂iˇti⁄_timî_öãrvÆ", .
	gmode
 = 0644, },

298 .
	gshow
 = 
showUI¡
,

299 .
	g°‹e
 = 
vdoMöAlbúeoTimîI¡îvÆSt‹e
,

300 .
	gvÆuePå
 = &
möAlbúeoTimîI¡îvÆ
,

303 
VDOAâribuã
 
	gvdoTø˚Rec‹dög
 = {

304 .
©å
 = {.
«me
 = "åa˚_ªc‹dög", .
	gmode
 = 0644, },

305 .
	gshow
 = 
showBoﬁ
,

306 .
	g°‹e
 = 
vdoTø˚Rec‹dögSt‹e
,

307 .
	gvÆuePå
 = &
åa˚Rec‹dög
,

310 
©åibuã
 *
	gdeÁu…Aârs
[] = {

311 &
vdoSètusAâr
.
©å
,

312 &
vdoLogLevñAâr
.
©å
,

313 &
vdoMaxReqA˘iveAâr
.
©å
,

314 #i‡
HAS_MAX_DISCARD_SECTORS


315 &
vdoMaxDisˇrdSe˘‹sAâr
.
©å
,

317 &
vdoAlbúeoTimeoutI¡îvÆ
.
©å
,

318 &
vdoMöAlbúeoTimîI¡îvÆ
.
©å
,

319 &
vdoTø˚Rec‹dög
.
©å
,

320 
NULL


323 
sysfs_›s
 
	gvdoSysfsOps
 = {

324 .
show
 = 
vdoAârShow
,

325 .
	g°‹e
 = 
vdoAârSt‹e
,

329 
	$vdoRñó£
(
kobje˘
 *
kobj
)

332 
	}
}

334 
kobj_ty≥
 
	gvdo_kty≥
 = {

335 .
ªÀa£
 = 
vdoRñó£
,

336 .
	gsysfs_›s
 = &
vdoSysfsOps
,

337 .
	gdeÁu…_©ås
 = 
deÁu…Aârs
,

341 
	$vdoInôSysfs
(
kobje˘
 *
devi˚Obje˘
)

343 
	`kobje˘_öô
(
devi˚Obje˘
, &
vdo_kty≥
);

344 
ªsu…
 = 
	`kobje˘_add
(
devi˚Obje˘
, 
NULL
, 
THIS_MODULE
->
«me
);

345 i‡(
ªsu…
 < 0) {

346 
	`logEº‹
("kobje˘_add faûed wôh sètu†%d", -
ªsu…
);

347 
	`kobje˘_put
(
devi˚Obje˘
);

349 
	`logDebug
("added sysfs objects");

350  
ªsu…
;

351 
	}
};

354 
	$vdoPutSysfs
(
kobje˘
 *
devi˚Obje˘
)

356 
	`kobje˘_put
(
devi˚Obje˘
);

357 
	}
}

	@vdo/kernel/sysfs.h

22 #i‚de‡
ALBIREO_SYSFS_H


23 
	#ALBIREO_SYSFS_H


	)

25 
	~"kî√lLayî.h
"

27 
	gkvdoDevi˚
;

34 
vdoInôSysfs
(
kobje˘
 *
devi˚Obje˘
);

41 
vdoPutSysfs
(
kobje˘
 *
devi˚Obje˘
);

	@vdo/kernel/threadDevice.c

22 
	~"thªadDevi˚.h
"

24 
	~"thªadRegi°ry.h
"

30 
ThªadRegi°ry
 
	gdevi˚IDThªadRegi°ry
;

33 
	$ªgi°îThªadDevi˚ID
(
Regi°îedThªad
 *
√wThªad
, *
idPå
)

35 
	`ªgi°îThªad
(&
devi˚IDThªadRegi°ry
, 
√wThªad
, 
idPå
);

36 
	}
}

39 
	$uƒegi°îThªadDevi˚ID
()

41 
	`uƒegi°îThªad
(&
devi˚IDThªadRegi°ry
);

42 
	}
}

45 
	$gëThªadDevi˚ID
()

47 c⁄° *
poöãr
 = 
	`lookupThªad
(&
devi˚IDThªadRegi°ry
);

48  
poöãr
 ? *pointer : -1;

49 
	}
}

52 
	$öôülizeThªadDevi˚Regi°ry
()

54 
	`öôülizeThªadRegi°ry
(&
devi˚IDThªadRegi°ry
);

55 
	}
}

	@vdo/kernel/threadDevice.h

22 
	~"kî√lLayî.h
"

36 
ªgi°îThªadDevi˚ID
(
Regi°îedThªad
 *
√wThªad
, *
idPå
);

48 
ölöe
 
	$ªgi°îThªadDevi˚
(
Regi°îedThªad
 *
√wThªad
,

49 
Kî√lLayî
 *
œyî
)

51 
	`ªgi°îThªadDevi˚ID
(
√wThªad
, &
œyî
->
ö°™˚
);

52 
	}
}

58 
uƒegi°îThªadDevi˚ID
();

66 
gëThªadDevi˚ID
();

71 
öôülizeThªadDevi˚Regi°ry
();

	@vdo/kernel/threadRegistry.c

22 
	~"thªadRegi°ry.h
"

24 
	~<löux/gÂ.h
>

25 
	~<löux/¶ab.h
>

27 
	~"≥rmas£π.h
"

36 
	$ªgi°îThªad
(
ThªadRegi°ry
 *
ªgi°ry
,

37 
Regi°îedThªad
 *
√wThªad
,

38 c⁄° *
poöãr
)

40 
	`INIT_LIST_HEAD
(&
√wThªad
->
löks
);

41 
√wThªad
->
poöãr
 =Öointer;

42 
√wThªad
->
èsk
 = 
cuºít
;

44 
boﬁ
 
foundIt
 = 
Ál£
;

45 
Regi°îedThªad
 *
thªad
;

46 
	`wrôe_lock
(&
ªgi°ry
->
lock
);

47 
	`li°_f‹_óch_íåy
(
thªad
, &
ªgi°ry
->
löks
,Üinks) {

48 i‡(
thªad
->
èsk
 =
cuºít
) {

51 
	`li°_dñ_öô
(&
thªad
->
löks
);

52 
foundIt
 = 
åue
;

56 
	`li°_add_èû
(&
√wThªad
->
löks
, &
ªgi°ry
->links);

57 
	`wrôe_u∆ock
(&
ªgi°ry
->
lock
);

58 
	`ASSERT_LOG_ONLY
(!
foundIt
, "newÅhreadÇotálready inÑegistry");

59 
	}
}

62 
	$uƒegi°îThªad
(
ThªadRegi°ry
 *
ªgi°ry
)

64 
boﬁ
 
foundIt
 = 
Ál£
;

65 
Regi°îedThªad
 *
thªad
;

66 
	`wrôe_lock
(&
ªgi°ry
->
lock
);

67 
	`li°_f‹_óch_íåy
(
thªad
, &
ªgi°ry
->
löks
,Üinks) {

68 i‡(
thªad
->
èsk
 =
cuºít
) {

69 
	`li°_dñ_öô
(&
thªad
->
löks
);

70 
foundIt
 = 
åue
;

74 
	`wrôe_u∆ock
(&
ªgi°ry
->
lock
);

75 
	`ASSERT_LOG_ONLY
(
foundIt
, "thread found inÑegistry");

76 
	}
}

79 
	$öôülizeThªadRegi°ry
(
ThªadRegi°ry
 *
ªgi°ry
)

81 
	`INIT_LIST_HEAD
(&
ªgi°ry
->
löks
);

82 
	`rwlock_öô
(&
ªgi°ry
->
lock
);

83 
	}
}

86 c⁄° *
	$lookupThªad
(
ThªadRegi°ry
 *
ªgi°ry
)

88 c⁄° *
ªsu…
 = 
NULL
;

89 
	`ªad_lock
(&
ªgi°ry
->
lock
);

90 
Regi°îedThªad
 *
thªad
;

91 
	`li°_f‹_óch_íåy
(
thªad
, &
ªgi°ry
->
löks
,Üinks) {

92 i‡(
thªad
->
èsk
 =
cuºít
) {

93 
ªsu…
 = 
thªad
->
poöãr
;

97 
	`ªad_u∆ock
(&
ªgi°ry
->
lock
);

98  
ªsu…
;

99 
	}
}

	@vdo/kernel/threadRegistry.h

22 #i‚de‡
THREAD_REGISTRY_H


23 
	#THREAD_REGISTRY_H
 1

	)

25 
	~<löux/li°.h
>

26 
	~<löux/•ölock.h
>

33 
	sthªadRegi°ry
 {

34 
li°_hód
 
	mlöks
;

35 
rwlock_t
 
	mlock
;

36 } 
	tThªadRegi°ry
;

38 
	sªgi°îedThªad
 {

39 
li°_hód
 
	mlöks
;

40 c⁄° *
	mpoöãr
;

41 
èsk_°ru˘
 *
	mèsk
;

42 } 
	tRegi°îedThªad
;

51 
öôülizeThªadRegi°ry
(
ThªadRegi°ry
 *
ªgi°ry
);

62 
ªgi°îThªad
(
ThªadRegi°ry
 *
ªgi°ry
,

63 
Regi°îedThªad
 *
√wThªad
,

64 c⁄° *
poöãr
);

73 
uƒegi°îThªad
(
ThªadRegi°ry
 *
ªgi°ry
);

84 c⁄° *
lookupThªad
(
ThªadRegi°ry
 *
ªgi°ry
);

	@vdo/kernel/threads.c

22 
	~"thªads.h
"

24 
	~<löux/h¨dúq.h
>

25 
	~<löux/sched.h
>

28 
pid_t
 
	$gëThªadId
()

30  
	`ö_öãºu±
(Ë? -1 : 
cuºít
->
pid
;

31 
	}
}

	@vdo/kernel/threads.h

22 #i‚de‡
THREADS_H


23 
	#THREADS_H


	)

25 
	~<löux/ty≥s.h
>

33 
pid_t
 
	$gëThªadId
()

34 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

	@vdo/kernel/timer.c

22 
	~"timî.h
"

30 
	$timîW‹kFun˘i⁄
(
d©a
)

32 
Timî
 *
timî
 = (*)
d©a
;

33 
Êags
;

34 
	`•ö_lock_úqßve
(&
timî
->
lock
, 
Êags
);

36 
timî
->
ÆªadyScheduÀd
 = 
Ál£
;

37 
	`•ö_u∆ock_úqª°‹e
(&
timî
->
lock
, 
Êags
);

38 
timî
->
	`fun˘i⁄
(timer);

39 
	}
}

42 
öôTimî
(
Timî
 *
timî
, (*
fun˘i⁄
)(Timer *))

44 
timî
->
fun˘i⁄
 = function;

45 
timî
->
ÆªadyScheduÀd
 = 
Ál£
;

46 
	`£tup_timî
(&
timî
->timî, 
timîW‹kFun˘i⁄
, ()Åimer);

47 
	`•ö_lock_öô
(&
timî
->
lock
);

48 
timî
->
öôülized
 = 
åue
;

49 
	}
}

52 
	$ˇn˚lTimî
(
Timî
 *
timî
)

54 i‡(!
timî
->
öôülized
) {

58 
Êags
;

59 
	`•ö_lock_úqßve
(&
timî
->
lock
, 
Êags
);

60 
timî
->
shuâögDown
 = 
åue
;

61 
timî
->
ÆªadyScheduÀd
 = 
Ál£
;

62 
	`•ö_u∆ock_úqª°‹e
(&
timî
->
lock
, 
Êags
);

65 
	`dñ_timî_sync
(&
timî
->timer);

66 
	}
}

69 
boﬁ
 
	$£tTimîIfNŸRu¬ög
(
Timî
 *
timî
, 
Jiffõs
 
ídTimeJiffõs
)

71 
boﬁ
 
ªsu…
 = 
Ál£
;

72 
Êags
;

73 
	`•ö_lock_úqßve
(&
timî
->
lock
, 
Êags
);

74 i‡(!
timî
->
ÆªadyScheduÀd
 && !timî->
shuâögDown
) {

75 
	`mod_timî
(&
timî
->timî, 
ídTimeJiffõs
);

76 
timî
->
ÆªadyScheduÀd
 = 
åue
;

77 
ªsu…
 = 
åue
;

79 
	`•ö_u∆ock_úqª°‹e
(&
timî
->
lock
, 
Êags
);

80  
ªsu…
;

81 
	}
}

	@vdo/kernel/timer.h

22 #i‚de‡
TIMER_H


23 
	#TIMER_H


	)

25 
	~<löux/•ölock.h
>

26 
	~<löux/timî.h
>

28 
	~"kî√lTy≥s.h
"

30 
	stimî
 {

31 
timî_li°
 
	mtimî
;

32 
•ölock_t
 
	mlock
;

33 
boﬁ
 
	mÆªadyScheduÀd
;

34 
boﬁ
 
	mshuâögDown
;

35 
boﬁ
 
	möôülized
;

36 (*
	mfun˘i⁄
)(
timî
 *
	mtimî
);

38 } 
	tTimî
;

46 
öôTimî
(
Timî
 *
timî
, (*
fun˘i⁄
)(Timer *));

58 
boﬁ
 
	`£tTimîIfNŸRu¬ög
(
Timî
 *
timî
, 
Jiffõs
 
ídTime
);

66 
	`ˇn˚lTimî
(
Timî
 *
timî
);

	@vdo/kernel/udsIndex.c

37 
	~"udsIndex.h
"

39 
	~"loggî.h
"

40 
	~"mem‹yAŒoc.h
"

41 
	~"°rögUtûs.h
"

42 
	~"uds-block.h
"

46 
	sudsAâribuã
 {

47 
©åibuã
 
	m©å
;

48 c⁄° *(*
	mshowSåög
)(
	mDedu≥Index
 *);

49 } 
	tUDSAâribuã
;

53 íum { 
	mUDS_Q_ACTION
 };

55 c⁄° 
KvdoW‹kQueueTy≥
 
	gudsQueueTy≥
 = {

56 .
√edTimeouts
 = 
åue
,

57 .
	ga˘i⁄TabÀ
 = {

58 { .
«me
 = "uds_a˘i⁄", .
	gcode
 = 
UDS_Q_ACTION
, .
	g¥i‹ôy
 = 0 },

67 
	mUR_IDLE
 = 0,

69 
	mUR_BUSY
 = 1,

71 
	mUR_TIMED_OUT
 = 2,

76 
	sudsIndex
 {

77 
Dedu≥Index
 
	mcomm⁄
;

78 
kobje˘
 
	mdedu≥Obje˘
;

79 
KvdoW‹kIãm
 
	mw‹kIãm
;

80 *
	mödexName
;

81 
UdsBlockC⁄ãxt
 
	mblockC⁄ãxt
;

82 
UdsIndexSessi⁄
 
	mödexSessi⁄
;

83 
©omic_t
 
	ma˘ive
;

84 
boﬁ
 
	mhaveBlockC⁄ãxt
;

85 
boﬁ
 
	mhaveIndexSessi⁄
;

88 
•ölock_t
 
	m°©eLock
;

89 
KvdoW‹kQueue
 *
	mudsQueue
;

90 c⁄° *
	mdedu≥Sèã
;

91 c⁄° *
	mèrgëSèã
;

92 
	mmaximum
;

95 
•ölock_t
 
	m≥ndögLock
;

96 
li°_hód
 
	m≥ndögHód
;

97 
timî_li°
 
	m≥ndögTimî
;

98 
boﬁ
 
	m°¨ãdTimî
;

99 } 
	tUDSIndex
;

102 c⁄° *c⁄° 
	gERROR
 = "error";

105 c⁄° *c⁄° 
	gCLOSED
 = "CLOSED";

108 c⁄° *c⁄° 
	gOPENING
 = "opening";

111 c⁄° *c⁄° 
	gCLOSING
 = "closing";

115 c⁄° *c⁄° 
	gOFFLINE
 = "offline";

119 c⁄° *c⁄° 
	gONLINE
 = "online";

125 íum { 
	mUDS_ADVICE_VERSION
 = 2 };

127 
	sudsAdvi˚
 {

128 
byã
 
	mvîsi⁄
;

129 
byã
 
	m°©e
;

130 
PhysiˇlBlockNumbî
 
	mpbn
;

131 } 
	t__©åibuã__
((
	t__∑cked__
)Ë
	tUDSAdvi˚
;

134 
ölöe
 
boﬁ
 
	$°©eIn2
(c⁄° *
°©e
, c⁄° *
s1
, c⁄° *
s2
)

136  (
°©e
 =
s1
Ë|| (°©ê=
s2
);

137 
	}
}

140 
ölöe
 
boﬁ
 
	$°©eIn3
(c⁄° *
°©e
,

141 c⁄° *
s1
,

142 c⁄° *
s2
,

143 c⁄° *
s3
)

145  (
°©e
 =
s1
Ë|| (°©ê=
s2
Ë|| (°©ê=
s3
);

146 
	}
}

149 
	$föishIndexO≥øti⁄
(
UdsReque°
 *
udsReque°
)

151 
D©aKVIO
 *
d©aKVIO
 = 
	`c⁄èöî_of
(
udsReque°
, DataKVIO,

152 
dedu≥C⁄ãxt
.
udsReque°
);

153 
Dedu≥C⁄ãxt
 *
dedu≥C⁄ãxt
 = &
d©aKVIO
->dedupeContext;

154 i‡(
	`com∑ªAndSw≠32
(&
dedu≥C⁄ãxt
->
ªque°Sèã
, 
UR_BUSY
, 
UR_IDLE
)) {

155 
KVIO
 *
kvio
 = 
	`d©aKVIOAsKVIO
(
d©aKVIO
);

156 
D©aVIO
 *
d©aVIO
 = 
	`vioAsD©aVIO
(
kvio
->
vio
);

157 
UDSIndex
 *
ödex
 = 
	`c⁄èöî_of
(
kvio
->
œyî
->
dedu≥Index
, UDSIndex, 
comm⁄
);

159 
	`•ö_lock_bh
(&
ödex
->
≥ndögLock
);

160 i‡(
dedu≥C⁄ãxt
->
isPídög
) {

161 
	`li°_dñ
(&
dedu≥C⁄ãxt
->
≥ndögLi°
);

162 
dedu≥C⁄ãxt
->
isPídög
 = 
Ál£
;

164 
	`•ö_u∆ock_bh
(&
ödex
->
≥ndögLock
);

166 
dedu≥C⁄ãxt
->
°©us
 = 
udsReque°
->status;

167 i‡((
udsReque°
->
ty≥
 =
UDS_POST
Ë|| (udsReque°->ty≥ =
UDS_QUERY
)) {

168 
d©aVIO
->
isDu∂iˇã


169 (
udsReque°
->
°©us
 =
UDS_SUCCESS
Ë&& udsReque°->
found
;

170 i‡(
d©aVIO
->
isDu∂iˇã
) {

171 
UDSAdvi˚
 *
advi˚
 = (UDSAdvi˚ *Ë&
udsReque°
->
ﬁdMëad©a
;

172 
D©aLoˇti⁄
 
loˇti⁄
 = (DataLocation) {

173 .
pbn
 = 
advi˚
->pbn,

174 .
°©e
 = 
advi˚
->state,

176 
	`£tDedu≥Advi˚
(&
d©aKVIO
->
dedu≥C⁄ãxt
, &
loˇti⁄
);

179 
	`övokeDedu≥CÆlback
(
d©aKVIO
);

180 
	`©omic_dec
(&
ödex
->
a˘ive
);

182 
	`com∑ªAndSw≠32
(&
dedu≥C⁄ãxt
->
ªque°Sèã
, 
UR_TIMED_OUT
, 
UR_IDLE
);

184 
	}
}

187 
	$°¨tExpú©i⁄Timî
(
UDSIndex
 *
ödex
, 
D©aKVIO
 *
d©aKVIO
)

189 i‡(!
ödex
->
°¨ãdTimî
) {

190 
ödex
->
°¨ãdTimî
 = 
åue
;

191 
	`mod_timî
(&
ödex
->
≥ndögTimî
,

192 
	`gëAlbúeoTimeout
(
d©aKVIO
->
dedu≥C⁄ãxt
.
submissi⁄Time
));

194 
	}
}

197 
	$°¨tIndexO≥øti⁄
(
KvdoW‹kIãm
 *
ôem
)

199 
KVIO
 *
kvio
 = 
	`w‹kIãmAsKVIO
(
ôem
);

200 
D©aKVIO
 *
d©aKVIO
 = 
	`kvioAsD©aKVIO
(
kvio
);

201 
UDSIndex
 *
ödex
 = 
	`c⁄èöî_of
(
kvio
->
œyî
->
dedu≥Index
, UDSIndex, 
comm⁄
);

202 
Dedu≥C⁄ãxt
 *
dedu≥C⁄ãxt
 = &
d©aKVIO
->dedupeContext;

204 
	`•ö_lock_bh
(&
ödex
->
≥ndögLock
);

205 
	`li°_add_èû
(&
dedu≥C⁄ãxt
->
≥ndögLi°
, &
ödex
->
≥ndögHód
);

206 
dedu≥C⁄ãxt
->
isPídög
 = 
åue
;

207 
	`°¨tExpú©i⁄Timî
(
ödex
, 
d©aKVIO
);

208 
	`•ö_u∆ock_bh
(&
ödex
->
≥ndögLock
);

210 
UdsReque°
 *
udsReque°
 = &
dedu≥C⁄ãxt
->udsRequest;

211 
°©us
 = 
	`udsSèπChunkO≥øti⁄
(
udsReque°
);

212 i‡(
°©us
 !
UDS_SUCCESS
) {

213 
udsReque°
->
°©us
 = status;

214 
	`föishIndexO≥øti⁄
(
udsReque°
);

216 
	}
}

219 
	$timeoutIndexO≥øti⁄s
(
¨g
)

221 
UDSIndex
 *
ödex
 = (UDSIndex *Ë
¨g
;

222 
	`LIST_HEAD
(
expúedHód
);

223 
uöt64_t
 
timeoutJiffõs
 = 
	`m£cs_to_jiffõs
(
ÆbúeoTimeoutI¡îvÆ
);

224 
óæõ°Submissi⁄AŒowed
 = 
jiffõs
 - 
timeoutJiffõs
;

225 
	`•ö_lock_bh
(&
ödex
->
≥ndögLock
);

226 
ödex
->
°¨ãdTimî
 = 
Ál£
;

227 !
	`li°_em±y
(&
ödex
->
≥ndögHód
)) {

228 
D©aKVIO
 *
d©aKVIO
 = 
	`li°_fú°_íåy
(&
ödex
->
≥ndögHód
, DataKVIO,

229 
dedu≥C⁄ãxt
.
≥ndögLi°
);

230 
Dedu≥C⁄ãxt
 *
dedu≥C⁄ãxt
 = &
d©aKVIO
->dedupeContext;

231 i‡(
óæõ°Submissi⁄AŒowed
 <
dedu≥C⁄ãxt
->
submissi⁄Time
) {

232 
	`°¨tExpú©i⁄Timî
(
ödex
, 
d©aKVIO
);

235 
	`li°_dñ
(&
dedu≥C⁄ãxt
->
≥ndögLi°
);

236 
dedu≥C⁄ãxt
->
isPídög
 = 
Ál£
;

237 
	`li°_add_èû
(&
dedu≥C⁄ãxt
->
≥ndögLi°
, &
expúedHód
);

239 
	`•ö_u∆ock_bh
(&
ödex
->
≥ndögLock
);

240 !
	`li°_em±y
(&
expúedHód
)) {

241 
D©aKVIO
 *
d©aKVIO
 = 
	`li°_fú°_íåy
(&
expúedHód
, DataKVIO,

242 
dedu≥C⁄ãxt
.
≥ndögLi°
);

243 
Dedu≥C⁄ãxt
 *
dedu≥C⁄ãxt
 = &
d©aKVIO
->dedupeContext;

244 
	`li°_dñ
(&
dedu≥C⁄ãxt
->
≥ndögLi°
);

245 i‡(
	`com∑ªAndSw≠32
(&
dedu≥C⁄ãxt
->
ªque°Sèã
,

246 
UR_BUSY
, 
UR_TIMED_OUT
)) {

247 
dedu≥C⁄ãxt
->
°©us
 = 
ETIMEDOUT
;

248 
	`övokeDedu≥CÆlback
(
d©aKVIO
);

249 
	`©omic_dec
(&
ödex
->
a˘ive
);

250 
	`kvdoRï‹tDedu≥Timeout
(
	`d©aKVIOAsKVIO
(
d©aKVIO
)->
œyî
, 1);

253 
	}
}

256 
	$íqueueIndexO≥øti⁄
(
D©aKVIO
 *
d©aKVIO
,

257 
UdsCÆlbackTy≥
 
›î©i⁄
)

259 
KVIO
 *
kvio
 = 
	`d©aKVIOAsKVIO
(
d©aKVIO
);

260 
Dedu≥C⁄ãxt
 *
dedu≥C⁄ãxt
 = &
d©aKVIO
->dedupeContext;

261 
UDSIndex
 *
ödex
 = 
	`c⁄èöî_of
(
kvio
->
œyî
->
dedu≥Index
, UDSIndex, 
comm⁄
);

262 
dedu≥C⁄ãxt
->
°©us
 = 
UDS_SUCCESS
;

263 
dedu≥C⁄ãxt
->
submissi⁄Time
 = 
jiffõs
;

264 
d©aKVIO
->
d©aVIO
.
isDu∂iˇã
 = 
Ál£
;

265 i‡(
	`com∑ªAndSw≠32
(&
dedu≥C⁄ãxt
->
ªque°Sèã
, 
UR_IDLE
, 
UR_BUSY
)) {

266 
UdsReque°
 *
udsReque°
 = &
d©aKVIO
->
dedu≥C⁄ãxt
.udsRequest;

267 
UDSAdvi˚
 
advi˚
 = {

268 .
vîsi⁄
 = 
UDS_ADVICE_VERSION
,

269 .
°©e
 = 
d©aKVIO
->
d©aVIO
.
√wM≠≥d
.state,

270 .
pbn
 = 
kvio
->
vio
->
physiˇl
,

272 
udsReque°
->
chunkName
 = *
dedu≥C⁄ãxt
->chunkName;

273 
udsReque°
->
ˇŒback
 = 
föishIndexO≥øti⁄
;

274 
udsReque°
->
c⁄ãxt
 = 
ödex
->
blockC⁄ãxt
;

275 
udsReque°
->
ty≥
 = 
›î©i⁄
;

276 
udsReque°
->
upd©e
 = 
åue
;

277 
	`mem˝y
(&
udsReque°
->
√wMëad©a
, &
advi˚
, (advice));

278 
	`£tupW‹kIãm
(&
kvio
->
íqueuóbÀ
.
w‹kIãm
, 
°¨tIndexO≥øti⁄
, 
NULL
,

279 
UDS_Q_ACTION
);

280 
	`•ö_lock
(&
ödex
->
°©eLock
);

281 i‡((
ödex
->
dedu≥Sèã
 =
ONLINE
Ë&& (ödex->
èrgëSèã
 =
NULL
)) {

282 
	`íqueueW‹kQueue
(
ödex
->
udsQueue
, &
kvio
->
íqueuóbÀ
.
w‹kIãm
);

283 
a˘ive
 = 
	`©omic_öc_ªtu∫
(&
ödex
->active);

284 i‡(
a˘ive
 > 
ödex
->
maximum
) {

285 
ödex
->
maximum
 = 
a˘ive
;

287 
kvio
 = 
NULL
;

289 
	`©omicSt‹e32
(&
dedu≥C⁄ãxt
->
ªque°Sèã
, 
UR_IDLE
);

291 
	`•ö_u∆ock
(&
ödex
->
°©eLock
);

293 i‡(
kvio
 !
NULL
) {

294 
	`övokeDedu≥CÆlback
(
d©aKVIO
);

296 
	}
}

299 
	$ch™geDedu≥Sèã
(
KvdoW‹kIãm
 *
ôem
)

301 
UDSIndex
 *
ödex
 = 
	`c⁄èöî_of
(
ôem
, UDSIndex, 
w‹kIãm
);

302 
ªsu…
 = 
UDS_SUCCESS
;

303 
boﬁ
 
w‹kToDo
 = 
åue
; workToDo;) {

305 
	`•ö_lock
(&
ödex
->
°©eLock
);

306 i‡(
ªsu…
 !
UDS_SUCCESS
) {

307 
ªsu…
 = 
UDS_SUCCESS
;

308 
ödex
->
èrgëSèã
 = 
ERROR
;

310 i‡(
	`°©eIn2
(
ödex
->
èrgëSèã
, 
ONLINE
, 
OFFLINE
)) {

312 i‡(
	`°©eIn3
(
ödex
->
dedu≥Sèã
, 
CLOSING
, 
CLOSED
, 
ERROR
)) {

313 
ödex
->
dedu≥Sèã
 = 
OPENING
;

314 } i‡(
	`°©eIn3
(
ödex
->
dedu≥Sèã
, 
OPENING
, 
OFFLINE
, 
ONLINE
)) {

315 
ödex
->
dedu≥Sèã
 = index->
èrgëSèã
;

317 
ödex
->
dedu≥Sèã
 = 
ERROR
;

319 } i‡(
	`°©eIn2
(
ödex
->
èrgëSèã
, 
CLOSED
, 
ERROR
)) {

321 i‡(
	`°©eIn3
(
ödex
->
dedu≥Sèã
, 
OPENING
, 
OFFLINE
, 
ONLINE
)) {

322 
ödex
->
dedu≥Sèã
 = 
CLOSING
;

323 } i‡(
	`°©eIn3
(
ödex
->
dedu≥Sèã
, 
CLOSING
, 
CLOSED
, 
ERROR
)) {

324 
ödex
->
dedu≥Sèã
 = index->
èrgëSèã
;

326 
ödex
->
dedu≥Sèã
 = 
ERROR
;

329 
ödex
->
dedu≥Sèã
 = 
ERROR
;

331 i‡(
	`°©eIn2
(
ödex
->
dedu≥Sèã
, index->
èrgëSèã
, 
ERROR
)) {

333 
ödex
->
èrgëSèã
 = 
NULL
;

334 
w‹kToDo
 = 
Ál£
;

336 c⁄° *
dedu≥Sèã
 = 
ödex
->dedupeState;

337 
	`•ö_u∆ock
(&
ödex
->
°©eLock
);

339 i‡(
dedu≥Sèã
 =
ERROR
) {

341 i‡(
ªsu…
 =
UDS_SUCCESS
) {

342 
	`logW¨nög
("setting UDS indexÅarget stateÅo ERROR");

344 
	`logW¨nögWôhSåögEº‹
(
ªsu…
,

347 } i‡(
dedu≥Sèã
 =
OPENING
) {

349 i‡(!
ödex
->
haveIndexSessi⁄
) {

350 
ªsu…
 = 
	`udsRebuûdLoˇlIndex
(
ödex
->
ödexName
, &ödex->
ödexSessi⁄
);

352 i‡(
ªsu…
 =
UDS_SUCCESS
) {

353 
ödex
->
haveIndexSessi⁄
 = 
åue
;

354 
ªsu…
 = 
	`udsO≥nBlockC⁄ãxt
(
ödex
->
ödexSessi⁄
, (
UDSAdvi˚
),

355 &
ödex
->
blockC⁄ãxt
);

357 i‡(
ªsu…
 =
UDS_SUCCESS
) {

358 
ödex
->
haveBlockC⁄ãxt
 = 
åue
;

360 } i‡(
dedu≥Sèã
 =
CLOSING
) {

362 i‡(
ödex
->
haveBlockC⁄ãxt
) {

363 
ªsu…
 = 
	`udsClo£BlockC⁄ãxt
(
ödex
->
blockC⁄ãxt
);

364 
ödex
->
haveBlockC⁄ãxt
 = 
Ál£
;

366 i‡(
ödex
->
haveIndexSessi⁄
) {

367 
ªsu…2
 = 
	`udsClo£IndexSessi⁄
(
ödex
->
ödexSessi⁄
);

368 
ödex
->
haveIndexSessi⁄
 = 
Ál£
;

369 i‡(
ªsu…
 =
UDS_SUCCESS
) {

370 
ªsu…
 = 
ªsu…2
;

375 
	}
}

378 
	$£tT¨gëSèã
(
UDSIndex
 *
ödex
, c⁄° *
èrgë
)

380 
	`logInfo
("Sëtög UDS indexÅ¨gë sèãÅÿ%s", 
èrgë
);

381 
	`•ö_lock
(&
ödex
->
°©eLock
);

382 i‡(
ödex
->
èrgëSèã
 !
NULL
) {

384 
ödex
->
èrgëSèã
 = 
èrgë
;

385 } i‡(((
ödex
->
dedu≥Sèã
 =
OFFLINE
Ë&& (
èrgë
 =
ONLINE
))

386 || ((
ödex
->
dedu≥Sèã
 =
ONLINE
Ë&& (
èrgë
 =
OFFLINE
))) {

388 
ödex
->
dedu≥Sèã
 = 
èrgë
;

389 } i‡(
èrgë
 !
ödex
->
dedu≥Sèã
) {

392 
ödex
->
èrgëSèã
 = 
èrgë
;

393 
	`£tupW‹kIãm
(&
ödex
->
w‹kIãm
, 
ch™geDedu≥Sèã
, 
NULL
, 
UDS_Q_ACTION
);

394 
	`íqueueW‹kQueue
(
ödex
->
udsQueue
, &ödex->
w‹kIãm
);

396 
	`•ö_u∆ock
(&
ödex
->
°©eLock
);

397 
	}
}

402 
	$dumpUDSIndex
(
Dedu≥Index
 *
dedu≥Index
, 
boﬁ
 
showQueue
)

404 
UDSIndex
 *
ödex
 = 
	`c⁄èöî_of
(
dedu≥Index
, UDSIndex, 
comm⁄
);

405 
	`•ö_lock
(&
ödex
->
°©eLock
);

406 c⁄° *
°©e
 = 
ödex
->
dedu≥Sèã
;

407 c⁄° *
èrgë
 = 
ödex
->
èrgëSèã
;

408 
	`•ö_u∆ock
(&
ödex
->
°©eLock
);

409 
	`logInfo
("UDS index: sèã: %s", 
°©e
);

410 i‡(
èrgë
 !
NULL
) {

411 
	`logInfo
("UDS index: ch™gögÅÿ°©e: %s", 
èrgë
);

413 i‡(
showQueue
) {

414 
	`dumpW‹kQueue
(
ödex
->
udsQueue
);

416 
	}
}

419 
	$föishUDSIndex
(
Dedu≥Index
 *
dedu≥Index
)

421 
UDSIndex
 *
ödex
 = 
	`c⁄èöî_of
(
dedu≥Index
, UDSIndex, 
comm⁄
);

422 
	`£tT¨gëSèã
(
ödex
, 
CLOSED
);

423 
	`föishW‹kQueue
(
ödex
->
udsQueue
);

424 
	}
}

427 
	$‰ìUDSIndex
(
Dedu≥Index
 *
dedu≥Index
)

429 
UDSIndex
 *
ödex
 = 
	`c⁄èöî_of
(
dedu≥Index
, UDSIndex, 
comm⁄
);

430 
	`‰ìW‹kQueue
(&
ödex
->
udsQueue
);

431 
	`•ö_lock_bh
(&
ödex
->
≥ndögLock
);

432 i‡(
ödex
->
°¨ãdTimî
) {

433 
	`dñ_timî_sync
(&
ödex
->
≥ndögTimî
);

435 
	`•ö_u∆ock_bh
(&
ödex
->
≥ndögLock
);

436 
	`kobje˘_put
(&
ödex
->
dedu≥Obje˘
);

437 
	}
}

440 c⁄° *
	$gëUDSSèãName
(
Dedu≥Index
 *
dedu≥Index
)

442 
UDSIndex
 *
ödex
 = 
	`c⁄èöî_of
(
dedu≥Index
, UDSIndex, 
comm⁄
);

443  
ödex
->
dedu≥Sèã
;

444 
	}
}

447 
	$gëMaximumOut°™dögUDS
(
Dedu≥Index
 *
dedu≥Index
)

449 
UDSIndex
 *
ödex
 = 
	`c⁄èöî_of
(
dedu≥Index
, UDSIndex, 
comm⁄
);

450  
ödex
->
maximum
;

451 
	}
};

454 
	$gëNumbîOut°™dögUDS
(
Dedu≥Index
 *
dedu≥Index
)

456 
UDSIndex
 *
ödex
 = 
	`c⁄èöî_of
(
dedu≥Index
, UDSIndex, 
comm⁄
);

457  
	`©omic_ªad
(&
ödex
->
a˘ive
);

458 
	}
};

461 
	$¥o˚ssMesßge
(
Dedu≥Index
 *
dedu≥Index
, c⁄° *
«me
)

463 
UDSIndex
 *
ödex
 = 
	`c⁄èöî_of
(
dedu≥Index
, UDSIndex, 
comm⁄
);

464 i‡(
	`°rˇ£cmp
(
«me
, "index-disable") == 0) {

465 
	`£tT¨gëSèã
(
ödex
, 
OFFLINE
);

467 } i‡(
	`°rˇ£cmp
(
«me
, "index-enable") == 0) {

468 
	`£tT¨gëSèã
(
ödex
, 
ONLINE
);

471  -
EINVAL
;

472 
	}
}

475 
	$udsPo°
(
D©aKVIO
 *
d©aKVIO
)

477 
	`íqueueIndexO≥øti⁄
(
d©aKVIO
, 
UDS_POST
);

478 
	}
}

481 
	$udsQuîy
(
D©aKVIO
 *
d©aKVIO
)

483 
	`íqueueIndexO≥øti⁄
(
d©aKVIO
, 
UDS_QUERY
);

484 
	}
}

487 
	$°¨tUDSIndex
(
Dedu≥Index
 *
dedu≥Index
)

489 
UDSIndex
 *
ödex
 = 
	`c⁄èöî_of
(
dedu≥Index
, UDSIndex, 
comm⁄
);

490 
	`£tT¨gëSèã
(
ödex
, 
ONLINE
);

491 
	}
}

494 
	$°›UDSIndex
(
Dedu≥Index
 *
dedu≥Index
)

496 
UDSIndex
 *
ödex
 = 
	`c⁄èöî_of
(
dedu≥Index
, UDSIndex, 
comm⁄
);

497 
	`£tT¨gëSèã
(
ödex
, 
CLOSED
);

498 
	}
}

501 
	$udsUpd©e
(
D©aKVIO
 *
d©aKVIO
)

503 
	`íqueueIndexO≥øti⁄
(
d©aKVIO
, 
UDS_UPDATE
);

504 
	}
}

507 
	$dedu≥KobjRñó£
(
kobje˘
 *
kobj
)

509 
UDSIndex
 *
ödex
 = 
	`c⁄èöî_of
(
kobj
, UDSIndex, 
dedu≥Obje˘
);

510 
	`FREE
(
ödex
->
ödexName
);

511 
	`FREE
(
ödex
);

512 
	}
}

515 
ssize_t
 
	$dedu≥SètusShow
(
kobje˘
 *
kobj
,

516 
©åibuã
 *
©å
,

517 *
buf
)

519 
UDSAâribuã
 *
ua
 = 
	`c⁄èöî_of
(
©å
, UDSAttribute,áttr);

520 
UDSIndex
 *
ödex
 = 
	`c⁄èöî_of
(
kobj
, UDSIndex, 
dedu≥Obje˘
);

521 i‡(
ua
->
showSåög
 !
NULL
) {

522  
	`•rötf
(
buf
, "%s\n", 
ua
->
	`showSåög
(&
ödex
->
comm⁄
));

524  -
EINVAL
;

526 
	}
}

529 
ssize_t
 
	$dedu≥SètusSt‹e
(
kobje˘
 *
kobj
,

530 
©åibuã
 *
©å
,

531 c⁄° *
buf
,

532 
size_t
 
Àngth
)

534  -
EINVAL
;

535 
	}
}

539 
sysfs_›s
 
	gdedu≥SysfsOps
 = {

540 .
show
 = 
dedu≥SètusShow
,

541 .
	g°‹e
 = 
dedu≥SètusSt‹e
,

544 
UDSAâribuã
 
	gdedu≥SètusAâribuã
 = {

545 .
©å
 = {.
«me
 = "°©us", .
	gmode
 = 0444, },

546 .
	gshowSåög
 = 
gëUDSSèãName
,

549 
©åibuã
 *
	gdedu≥Aâribuãs
[] = {

550 &
dedu≥SètusAâribuã
.
©å
,

551 
NULL
,

554 
kobj_ty≥
 
	gdedu≥KobjTy≥
 = {

555 .
ªÀa£
 = 
dedu≥KobjRñó£
,

556 .
	gsysfs_›s
 = &
dedu≥SysfsOps
,

557 .
	gdeÁu…_©ås
 = 
dedu≥Aâribuãs
,

561 
	$makeUDSIndex
(
Kî√lLayî
 *
œyî
, 
Dedu≥Index
 **
ödexPå
)

563 
UDSIndex
 *
ödex
;

564 
ªsu…
 = 
	`ALLOCATE
(1, 
UDSIndex
, "UDS index d©a", &
ödex
);

565 i‡(
ªsu…
 !
VDO_SUCCESS
) {

566  
ªsu…
;

569 
ªsu…
 = 
	`ALLOCATE
(
	`°æí
(
œyî
->
devi˚C⁄fig
->
∑ª¡Devi˚Name
) + 50, ,

570 "UDS indexÇame", &
ödex
->
ödexName
);

571 i‡(
ªsu…
 < 0) {

572 
	`FREE
(
ödex
);

573  
ªsu…
;

576 
VﬁumeGeomëry
 *
geomëry
 = 
œyî
->geometry;

577 
BlockCou¡
 
ödexBlocks
 = (
geomëry
->
∑πôi⁄s
[
DATA_REGION
].
°¨tBlock


578 - 
geomëry
->
∑πôi⁄s
[
INDEX_REGION
].
°¨tBlock
);

579 
ªsu…
 = 
	`fixedS¥ötf
("ödexÇame", 
ödex
->
ödexName
, 
VDO_BLOCK_SIZE
,

580 
UDS_INDEX_PATH_TOO_LONG
, "dev=%s offset=4096 size=%"

581 
PRIu64
, 
œyî
->
devi˚C⁄fig
->
∑ª¡Devi˚Name
,

582 
ödexBlocks
 * 
VDO_BLOCK_SIZE
);

583 i‡(
ªsu…
 < 0) {

584 
	`logEº‹
("Cª©ög indexÇamêÁûed (%d)", 
ªsu…
);

585 
	`FREE
(
ödex
->
ödexName
);

586 
	`FREE
(
ödex
);

587  
ªsu…
;

590 
ªsu…
 = 
	`makeW‹kQueue
(
œyî
->
thªadNamePªfix
, "DedupeQ",

591 &
œyî
->
wqDúe˘‹y
, 
ödex
, &
udsQueueTy≥
, 1,

592 &
ödex
->
udsQueue
);

593 i‡(
ªsu…
 < 0) {

594 
	`logEº‹
("UDS index queuêöôüliz©i⁄ faûed (%d)", 
ªsu…
);

595 
	`FREE
(
ödex
->
ödexName
);

596 
	`FREE
(
ödex
);

597  
ªsu…
;

600 
	`kobje˘_öô
(&
ödex
->
dedu≥Obje˘
, &
dedu≥KobjTy≥
);

601 
ªsu…
 = 
	`kobje˘_add
(&
ödex
->
dedu≥Obje˘
, &
œyî
->
kobj
, "dedupe");

602 i‡(
ªsu…
 !
VDO_SUCCESS
) {

603 
	`‰ìW‹kQueue
(&
ödex
->
udsQueue
);

604 
	`FREE
(
ödex
->
ödexName
);

605 
	`FREE
(
ödex
);

606  
ªsu…
;

609 
ödex
->
comm⁄
.
dump
 = 
dumpUDSIndex
;

610 
ödex
->
comm⁄
.
‰ì
 = 
‰ìUDSIndex
;

611 
ödex
->
comm⁄
.
gëDedu≥SèãName
 = 
gëUDSSèãName
;

612 
ödex
->
comm⁄
.
gëMaximumOut°™dög
 = 
gëMaximumOut°™dögUDS
;

613 
ödex
->
comm⁄
.
gëNumbîOut°™dög
 = 
gëNumbîOut°™dögUDS
;

614 
ödex
->
comm⁄
.
mesßge
 = 
¥o˚ssMesßge
;

615 
ödex
->
comm⁄
.
po°
 = 
udsPo°
;

616 
ödex
->
comm⁄
.
quîy
 = 
udsQuîy
;

617 
ödex
->
comm⁄
.
°¨t
 = 
°¨tUDSIndex
;

618 
ödex
->
comm⁄
.
°›
 = 
°›UDSIndex
;

619 
ödex
->
comm⁄
.
föish
 = 
föishUDSIndex
;

620 
ödex
->
comm⁄
.
upd©e
 = 
udsUpd©e
;

622 
	`INIT_LIST_HEAD
(&
ödex
->
≥ndögHód
);

623 
	`•ö_lock_öô
(&
ödex
->
≥ndögLock
);

624 
	`•ö_lock_öô
(&
ödex
->
°©eLock
);

625 
	`£tup_timî
(&
ödex
->
≥ndögTimî
, 
timeoutIndexO≥øti⁄s
,

626 (Ë
ödex
);

627 
ödex
->
dedu≥Sèã
 = 
CLOSED
;

628 
ödex
->
èrgëSèã
 = 
NULL
;

630 *
ödexPå
 = &
ödex
->
comm⁄
;

631  
VDO_SUCCESS
;

632 
	}
}

	@vdo/kernel/udsIndex.h

37 #i‚de‡
UDS_INDEX_H


38 
	#UDS_INDEX_H


	)

40 
	~"dedu≥Index.h
"

50 
	$makeUDSIndex
(
Kî√lLayî
 *
œyî
, 
Dedu≥Index
 **
ödexPå
)

51 
	`__©åibuã__
 ((
__w¨n_unu£d_ªsu…__
));

	@vdo/kernel/vdoCommon.h

22 #i‚de‡
VDO_COMMON_H


23 
	#VDO_COMMON_H


	)

27 
	mUSE_BIO_ACK_QUEUE_FOR_READ
 = 0,

	@vdo/kernel/vdoStringUtils.c

22 
	~"vdoSåögUtûs.h
"

24 
	~"îr‹s.h
"

25 
	~"loggî.h
"

26 
	~"mem‹yAŒoc.h
"

28 
	~"°©usCodes.h
"

30 #ifde‡
NEVER


33 
	$wøpV¢¥ötf
(c⁄° *
wh©
,

34 *
buf
,

35 
size_t
 
bufSize
,

36 
îr‹
,

37 c⁄° *
fmt
,

38 
va_li°
 
≠
,

39 
size_t
 *
√eded
)

41 i‡(
buf
 =
NULL
) {

42 
nobuf
[1];

43 
buf
 = 
nobuf
;

44 
bufSize
 = 0;

46 
n
 = 
	`v¢¥ötf
(
buf
, 
bufSize
, 
fmt
, 
≠
);

47 i‡(
n
 < 0) {

48  
	`logEº‹WôhSåögEº‹
(
UDS_UNEXPECTED_RESULT
,

49 "%s: v¢¥öt‡Áûed", 
wh©
);

51 i‡(
√eded
) {

52 *
√eded
 = 
n
;

54 i‡(((
size_t
Ë
n
 >
bufSize
Ë&& (
buf
 !
NULL
Ë&& (
îr‹
 !
UDS_SUCCESS
)) {

55  
	`logEº‹WôhSåögEº‹
(
îr‹
, "%s: såögÅoÿl⁄g", 
wh©
);

57  
UDS_SUCCESS
;

58 
	}
}

61 
	$fixedS¥ötf
(c⁄° *
wh©
,

62 *
buf
,

63 
size_t
 
bufSize
,

64 
îr‹
,

65 c⁄° *
fmt
,

68 i‡(
buf
 =
NULL
) {

69  
UDS_INVALID_ARGUMENT
;

71 
va_li°
 
¨gs
;

72 
	`va_°¨t
(
¨gs
, 
fmt
);

73 
ªsu…
 = 
	`wøpV¢¥ötf
(
wh©
, 
buf
, 
bufSize
, 
îr‹
, 
fmt
, 
¨gs
, 
NULL
);

74 
	`va_íd
(
¨gs
);

75  
ªsu…
;

76 
	}
}

81 *
	$vAµídToBuf„r
(*
buf„r
,

82 *
bufEnd
,

83 c⁄° *
fmt
,

84 
va_li°
 
¨gs
)

86 
size_t
 
n
 = 
	`v¢¥ötf
(
buf„r
, 
bufEnd
 - buf„r, 
fmt
, 
¨gs
);

87 i‡(
n
 >(
size_t
Ë(
bufEnd
 - 
buf„r
)) {

88 
buf„r
 = 
bufEnd
;

90 
buf„r
 +
n
;

92  
buf„r
;

93 
	}
}

96 *
	$≠≥ndToBuf„r
(*
buf„r
, *
bufEnd
, c⁄° *
fmt
, ...)

98 
va_li°
 
≠
;

100 
	`va_°¨t
(
≠
, 
fmt
);

101 *
pos
 = 
	`vAµídToBuf„r
(
buf„r
, 
bufEnd
, 
fmt
, 
≠
);

102 
	`va_íd
(
≠
);

103  
pos
;

104 
	}
}

107 
	$‰ìSåögAºay
(**
°rögAºay
)

109 
off£t
 = 0; 
°rögAºay
[off£t] !
NULL
; offset++) {

110 
	`FREE
(
°rögAºay
[
off£t
]);

112 
	`FREE
(
°rögAºay
);

113 
	}
}

116 
	$•lôSåög
(c⁄° *
°rög
, 
£∑øt‹
, ***
sub°rögAºayPå
)

118 
sub°rögCou¡
 = 1;

119 c⁄° *
s
 = 
°rög
; *s != 0; s++) {

120 i‡(*
s
 =
£∑øt‹
) {

121 
sub°rögCou¡
++;

125 **
sub°rögs
;

126 
ªsu…
 = 
	`ALLOCATE
(
sub°rögCou¡
 + 1, *, "string-splittingárray",

127 &
sub°rögs
);

128 i‡(
ªsu…
 !
UDS_SUCCESS
) {

129  
ªsu…
;

131 
cuºítSub°rög
 = 0;

132 c⁄° *
s
 = 
°rög
; *s != 0; s++) {

133 i‡(*
s
 =
£∑øt‹
) {

134 
±rdiff_t
 
Àngth
 = 
s
 - 
°rög
;

135 
ªsu…
 = 
	`ALLOCATE
(
Àngth
 + 1, , "split string",

136 &
sub°rögs
[
cuºítSub°rög
]);

137 i‡(
ªsu…
 !
UDS_SUCCESS
) {

138 
	`‰ìSåögAºay
(
sub°rögs
);

139  
ªsu…
;

143 i‡(
Àngth
 > 0) {

144 
	`mem˝y
(
sub°rögs
[
cuºítSub°rög
], 
°rög
, 
Àngth
);

146 
°rög
 = 
s
 + 1;

147 
cuºítSub°rög
++;

148 
	`BUG_ON
(
cuºítSub°rög
 >
sub°rögCou¡
);

152 
	`BUG_ON
(
cuºítSub°rög
 !(
sub°rögCou¡
 - 1));

153 
±rdiff_t
 
Àngth
 = 
	`°æí
(
°rög
);

154 
ªsu…
 = 
	`ALLOCATE
(
Àngth
 + 1, , "split string",

155 &
sub°rögs
[
cuºítSub°rög
]);

156 i‡(
ªsu…
 !
UDS_SUCCESS
) {

157 
	`‰ìSåögAºay
(
sub°rögs
);

158  
ªsu…
;

160 
	`mem˝y
(
sub°rögs
[
cuºítSub°rög
], 
°rög
, 
Àngth
);

161 
cuºítSub°rög
++;

163 *
sub°rögAºayPå
 = 
sub°rögs
;

164  
UDS_SUCCESS
;

165 
	}
}

168 
	$joöSåögs
(**
sub°rögAºay
,

169 
size_t
 
¨øyLígth
,

170 
£∑øt‹
,

171 **
°rögPå
)

173 
size_t
 
°rögLígth
 = 0;

174 
size_t
 
i
 = 0; (ò< 
¨øyLígth
Ë&& (
sub°rögAºay
[i] !
NULL
); i++) {

175 
°rögLígth
 +
	`°æí
(
sub°rögAºay
[
i
]) + 1;

178 *
ouçut
;

179 
ªsu…
 = 
	`ALLOCATE
(
°rögLígth
, , 
__func__
, &
ouçut
);

180 i‡(
ªsu…
 !
VDO_SUCCESS
) {

181  
ªsu…
;

184 *
cuºítPosôi⁄
 = &
ouçut
[0];

185 
size_t
 
i
 = 0; (ò< 
¨øyLígth
Ë&& (
sub°rögAºay
[i] !
NULL
); i++) {

186 
cuºítPosôi⁄
 = 
	`≠≥ndToBuf„r
(cuºítPosôi⁄, 
ouçut
 + 
°rögLígth
,

187 "%s", 
sub°rögAºay
[
i
]);

188 *
cuºítPosôi⁄
 = 
£∑øt‹
;

189 
cuºítPosôi⁄
++;

193 i‡(
cuºítPosôi⁄
 !
ouçut
) {

194 *(
cuºítPosôi⁄
 - 1) = '\0';

197 *
°rögPå
 = 
ouçut
;

198  
UDS_SUCCESS
;

199 
	}
}

202 
	$°rögToUI¡
(c⁄° *
öput
, **
íd
, *
vÆuePå
)

206 
	`STATIC_ASSERT
(((
UINT64_MAX
 - 9Ë/ 10Ë> 
UINT_MAX
);

207 c⁄° *
öôülI≈ut
 = 
öput
;

208 
uöt64_t
 
vÆue
 = 0;

209 (*
öput
 >= '0') && (*input <= '9')) {

210 
thisDigô
 = *
öput
 - '0';

211 
vÆue
 = vÆuê* 10 + 
thisDigô
;

212 i‡(
vÆue
 > 
UINT_MAX
) {

213  -
EINVAL
;

215 
öput
++;

217 i‡(
öput
 =
öôülI≈ut
) {

219  -
EINVAL
;

221 *
íd
 = (*Ë
öput
;

222 *
vÆuePå
 = 
vÆue
;

223  
UDS_SUCCESS
;

224 
	}
}

226 #ifde‡
NEVER


229 
	$du∂iˇãSåög
(c⁄° *
°rög
, c⁄° *
wh©
, **
√wSåög
)

231 
size_t
 
size
 = 
	`°æí
(
°rög
) + 1;

232 *
dup
;

233 
ªsu…
 = 
	`ALLOCATE
(
size
, , 
wh©
, &
dup
);

234 i‡(
ªsu…
 !
UDS_SUCCESS
) {

235  
ªsu…
;

237 
	`mem˝y
(
dup
, 
°rög
, 
size
);

238 *
√wSåög
 = 
dup
;

239  
UDS_SUCCESS
;

240 
	}
}

	@vdo/kernel/vdoStringUtils.h

22 #i‚de‡
VDO_STRING_UTILS_H


23 
	#VDO_STRING_UTILS_H


	)

25 
	~<°d¨g.h
>

26 
	~<löux/ty≥s.h
>

28 #ifde‡
NEVER


37 
ölöe
 c⁄° *
	$boﬁToSåög
(
boﬁ
 
vÆue
)

39  (
vÆue
 ? "true" : "false");

40 
	}
}

55 
	$fixedS¥ötf
(c⁄° *
wh©
,

56 *
buf
,

57 
size_t
 
bufSize
,

58 
îr‹
,

59 c⁄° *
fmt
,

61 
	`__©åibuã__
((
	`f‹m©
(
¥ötf
, 5, 6), 
w¨n_unu£d_ªsu…
));

84 
	$wøpV¢¥ötf
(c⁄° *
wh©
,

85 *
buf
,

86 
size_t
 
bufSize
,

87 
îr‹
,

88 c⁄° *
fmt
,

89 
va_li°
 
≠
,

90 
size_t
 *
√eded
)

91 
	`__©åibuã__
((
	`f‹m©
(
¥ötf
, 5, 0), 
w¨n_unu£d_ªsu…
));

106 *
	`≠≥ndToBuf„r
(*
buf„r
, *
bufEnd
, c⁄° *
fmt
, ...);

119 *
	`vAµídToBuf„r
(*
buf„r
,

120 *
bufEnd
,

121 c⁄° *
fmt
,

122 
va_li°
 
¨gs
);

145 
	$•lôSåög
(c⁄° *
°rög
, 
£∑øt‹
, ***
sub°rögAºayPå
)

146 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

161 
	$joöSåögs
(**
sub°rögAºay
,

162 
size_t
 
¨øyLígth
,

163 
£∑øt‹
,

164 **
°rögPå
)

165 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

172 
	`‰ìSåögAºay
(**
°rögAºay
);

186 
	$°rögToUI¡
(c⁄° *
öput
, **
íd
, *
vÆuePå
)

187 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

189 #ifde‡
NEVER


202 
	$du∂iˇãSåög
(c⁄° *
°rög
, c⁄° *
wh©
, **
√wSåög
)

203 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

	@vdo/kernel/verify.c

22 
	~"vîify.h
"

24 
	~"loggî.h
"

26 
	~"d©aKVIO.h
"

27 
	~"dedu≥Index.h
"

28 
	~"numîic.h
"

29 
	~"ªadCache.h
"

46 
__©åibuã__
((
w¨n_unu£d_ªsu…
))

47 
boﬁ
 
	$mem‹yEquÆ
(*
poöãrArgumít1
,

48 *
poöãrArgumít2
,

49 
size_t
 
Àngth
)

51 
byã
 *
poöãr1
 = 
poöãrArgumít1
;

52 
byã
 *
poöãr2
 = 
poöãrArgumít2
;

53 
Àngth
 >(
uöt64_t
)) {

59 i‡(
	`GET_UNALIGNED
(
uöt64_t
, 
poöãr1
)

60 !
	`GET_UNALIGNED
(
uöt64_t
, 
poöãr2
)) {

61  
Ál£
;

63 
poöãr1
 +(
uöt64_t
);

64 
poöãr2
 +(
uöt64_t
);

65 
Àngth
 -(
uöt64_t
);

67 
Àngth
 > 0) {

68 i‡(*
poöãr1
 !*
poöãr2
) {

69  
Ál£
;

71 
poöãr1
++;

72 
poöãr2
++;

73 
Àngth
--;

75  
åue
;

76 
	}
}

93 
	$vîifyDu∂iˇti⁄W‹k
(
KvdoW‹kIãm
 *
ôem
)

95 
D©aKVIO
 *
d©aKVIO
 = 
	`w‹kIãmAsD©aKVIO
(
ôem
);

96 
	`d©aKVIOAddTø˚Rec‹d
(
d©aKVIO
, 
	`THIS_LOCATION
("$F;j=dedupe;cb=verify"));

98 
Kî√lLayî
 *
œyî
 = 
	`gëLayîFromD©aKVIO
(
d©aKVIO
);

99 i‡(
	`likñy
(
	`mem‹yEquÆ
(
d©aKVIO
->
d©aBlock
, d©aKVIO->
ªadBlock
.
d©a
,

100 
VDO_BLOCK_SIZE
))) {

101 
	`©omic64_öc
(&
œyî
->
dedu≥Advi˚VÆid
);

103 
	`logDebug
("%s: m©ch - wêwö!", 
__func__
);

105 
	`©omic64_öc
(&
œyî
->
dedu≥Advi˚SèÀ
);

106 
	`logDebug
("%s: dif„ª¡", 
__func__
);

107 
d©aKVIO
->
d©aVIO
.
isDu∂iˇã
 = 
Ál£
;

116 i‡(
	`hasAŒoˇti⁄
(&
d©aKVIO
->
d©aVIO
)) {

117 
	`upd©eDedu≥Advi˚
(
d©aKVIO
);

122 
	`kvdoEnqueueD©aVIOCÆlback
(
d©aKVIO
);

123 
	}
}

131 
	$vîifyRódBlockCÆlback
(
D©aKVIO
 *
d©aKVIO
)

133 
	`d©aKVIOAddTø˚Rec‹d
(
d©aKVIO
, 
	`THIS_LOCATION
(
NULL
));

134 
îr
 = 
d©aKVIO
->
ªadBlock
.
°©us
;

135 i‡(
	`u∆ikñy
(
îr
 != 0)) {

136 
	`logDebug
("%s:Éº %d", 
__func__
, 
îr
);

137 
d©aKVIO
->
d©aVIO
.
isDu∂iˇã
 = 
Ál£
;

138 
	`kvdoEnqueueD©aVIOCÆlback
(
d©aKVIO
);

142 
	`œunchD©aKVIOOnCPUQueue
(
d©aKVIO
, 
vîifyDu∂iˇti⁄W‹k
, 
NULL
,

143 
CPU_Q_ACTION_COMPRESS_BLOCK
);

144 
	}
}

147 
	$kvdoVîifyDu∂iˇti⁄
(
D©aVIO
 *
d©aVIO
)

149 
	`ASSERT_LOG_ONLY
(
d©aVIO
->
isDu∂iˇã
, "adviceÅo verify must be valid");

150 
	`ASSERT_LOG_ONLY
(
d©aVIO
->
du∂iˇã
.
°©e
 !
MAPPING_STATE_UNMAPPED
,

152 
	`ASSERT_LOG_ONLY
(
d©aVIO
->
du∂iˇã
.
pbn
 !
ZERO_BLOCK
,

154 
	`ASSERT_LOG_ONLY
(!
d©aVIO
->
isZîoBlock
,

157 
Tø˚Loˇti⁄
 
loˇti⁄


158 
	`THIS_LOCATION
("verifyDuplication;dup=update(verify);io=verify");

159 
	`d©aVIOAddTø˚Rec‹d
(
d©aVIO
, 
loˇti⁄
);

160 
	`kvdoRódBlock
(
d©aVIO
, d©aVIO->
du∂iˇã
.
pbn
, d©aVIO->du∂iˇã.
°©e
,

161 
READ_VERIFY_DEDUPE
, 
vîifyRódBlockCÆlback
);

162 
	}
}

	@vdo/kernel/verify.h

21 
	~"kî√lLayî.h
"

31 
kvdoVîifyDu∂iˇti⁄
(
D©aVIO
 *
d©aVIO
);

	@vdo/kernel/workItemStats.c

22 
	~"w‹kIãmSèts.h
"

24 
	~"loggî.h
"

39 
ölöe
 
	$sˇnSètTabÀ
(c⁄° 
KvdoW‹kFun˘i⁄TabÀ
 *
èbÀ
,

40 
KvdoW‹kFun˘i⁄
 
w‹k
,

41 
¥i‹ôy
)

43 
i
;

48 
i
 = 0; i < 
NUM_WORK_QUEUE_ITEM_STATS
; i++) {

49 i‡(
èbÀ
->
fun˘i⁄s
[
i
] =
NULL
) {

50  
i
;

51 } i‡(
èbÀ
->
fun˘i⁄s
[
i
] =
w‹k
) {

52 
	`smp_rmb
();

53 i‡(
èbÀ
->
¥i‹ôõs
[
i
] =
¥i‹ôy
) {

54  
i
;

58  
NUM_WORK_QUEUE_ITEM_STATS
;

59 
	}
}

72 
	$gëSètTabÀIndex
(
KvdoW‹kIãmSèts
 *
°©s
,

73 
KvdoW‹kFun˘i⁄
 
w‹k
,

74 
¥i‹ôy
)

76 
KvdoW‹kFun˘i⁄TabÀ
 *
fun˘i⁄TabÀ
 = &
°©s
->functionTable;

78 
ödex
 = 
	`sˇnSètTabÀ
(
fun˘i⁄TabÀ
, 
w‹k
, 
¥i‹ôy
);

79 i‡(
	`u∆ikñy
(
ödex
 =
NUM_WORK_QUEUE_ITEM_STATS
)

80 || 
	`likñy
(
fun˘i⁄TabÀ
->
fun˘i⁄s
[
ödex
] !
NULL
)) {

81  
ödex
;

84 
Êags
 = 0;

88 
	`•ö_lock_úqßve
(&
fun˘i⁄TabÀ
->
lock
, 
Êags
);

90 
ödex
 = 
	`sˇnSètTabÀ
(
fun˘i⁄TabÀ
, 
w‹k
, 
¥i‹ôy
);

91 i‡((
ödex
 =
NUM_WORK_QUEUE_ITEM_STATS
)

92 || (
fun˘i⁄TabÀ
->
fun˘i⁄s
[
ödex
] !
NULL
)) {

93 
	`•ö_u∆ock_úqª°‹e
(&
fun˘i⁄TabÀ
->
lock
, 
Êags
);

94  
ödex
;

104 
fun˘i⁄TabÀ
->
¥i‹ôõs
[
ödex
] = 
¥i‹ôy
;

105 
	`smp_wmb
();

106 
fun˘i⁄TabÀ
->
fun˘i⁄s
[
ödex
] = 
w‹k
;

107 
	`•ö_u∆ock_úqª°‹e
(&
fun˘i⁄TabÀ
->
lock
, 
Êags
);

108  
ödex
;

109 
	}
}

123 
	$gëW‹kIãmCou¡sByIãm
(c⁄° 
KvdoW‹kIãmSèts
 *
°©s
,

124 
ödex
,

125 
uöt64_t
 *
íqueuedPå
,

126 
uöt64_t
 *
¥o˚s£dPå
,

127 
uöt64_t
 *
timedOutPå
,

128 *
≥ndögPå
)

130 
uöt64_t
 
íqueued
 = 
	`©omic64_ªad
(&
°©s
->íqueued[
ödex
]);

131 
uöt64_t
 
¥o˚s£d
 = 
°©s
->
times
[
ödex
].
cou¡
;

132 
uöt64_t
 
timedOut
 = 
	`©omic64_ªad
(&
°©s
->timedOut[
ödex
]);

133 
uöt64_t
 
¥o˚s£dOrTimedOut
 = 
¥o˚s£d
 + 
timedOut
;

134 
≥ndög
;

135 i‡(
íqueued
 < 
¥o˚s£dOrTimedOut
) {

137 
≥ndög
 = 1;

139 
≥ndög
 = 
íqueued
 - 
¥o˚s£dOrTimedOut
;

141 i‡((
≥ndög
 + 
¥o˚s£dOrTimedOut
Ë< 
íqueued
) {

142 
≥ndög
 = 
UINT_MAX
;

145 *
íqueuedPå
 = 
íqueued
;

146 *
¥o˚s£dPå
 = 
¥o˚s£d
;

147 *
timedOutPå
 = 
timedOut
;

148 *
≥ndögPå
 = 
≥ndög
;

149 
	}
}

160 
	$gëOthîW‹kIãmCou¡s
(c⁄° 
KvdoW‹kIãmSèts
 *
°©s
,

161 
uöt64_t
 *
íqueuedPå
,

162 
uöt64_t
 *
¥o˚s£dPå
,

163 
uöt64_t
 *
timedOutPå
)

165 
≥ndög
;

166 
	`gëW‹kIãmCou¡sByIãm
(
°©s
, 
NUM_WORK_QUEUE_ITEM_STATS
,

167 
íqueuedPå
, 
¥o˚s£dPå
, 
timedOutPå
, &
≥ndög
);

168 
	}
}

180 
	$gëW‹kIãmTimesByIãm
(c⁄° 
KvdoW‹kIãmSèts
 *
°©s
,

181 
ödex
,

182 
uöt64_t
 *
mö
,

183 
uöt64_t
 *
món
,

184 
uöt64_t
 *
max
)

186 *
mö
 = 
°©s
->
times
[
ödex
].min;

187 *
món
 = 
	`gëSam∂eAvîage
(&
°©s
->
times
[
ödex
]);

188 *
max
 = 
°©s
->
times
[
ödex
].max;

189 
	}
}

192 
	$upd©eW‹kIãmSètsF‹Enqueue
(
KvdoW‹kIãmSèts
 *
°©s
,

193 
KvdoW‹kIãm
 *
ôem
,

194 
¥i‹ôy
)

196 
	`gccFí˚
();

198 
ôem
->
°©TabÀIndex
 = 
	`gëSètTabÀIndex
(
°©s
, iãm->
°©sFun˘i⁄
,

199 
¥i‹ôy
);

200 
	`©omic64_add
(1, &
°©s
->
íqueued
[
ôem
->
°©TabÀIndex
]);

201 
	`gccFí˚
();

202 
	}
}

205 
	$upd©eW‹kIãmSètsF‹Timeout
(
KvdoW‹kIãmSèts
 *
°©s
,

206 
KvdoW‹kIãm
 *
ôem
)

208 
	`©omic64_add
(1, &
°©s
->
timedOut
[
ôem
->
°©TabÀIndex
]);

209 
	}
}

212 *
	$gëFun˘i⁄Name
(*
poöãr
, *
buf„r
, 
size_t
 
buf„rLígth
)

214 i‡(
poöãr
 =
NULL
) {

220 
	`°∫˝y
(
buf„r
, "-", 
buf„rLígth
);

228 
åunˇãdFun˘i⁄NameF‹m©Såög
[] = "%.*ps";

229 
	`¢¥ötf
(
buf„r
, 
buf„rLígth
,

230 
åunˇãdFun˘i⁄NameF‹m©Såög
,

231 
buf„rLígth
 - 1,

232 
poöãr
);

234 *
•a˚
 = 
	`°rchr
(
buf„r
, ' ');

235 i‡(
•a˚
 !
NULL
) {

236 *
•a˚
 = '\0';

240  
buf„r
;

241 
	}
}

244 
size_t
 
	$f‹m©W‹kIãmSèts
(c⁄° 
KvdoW‹kIãmSèts
 *
°©s
,

245 *
buf„r
,

246 
size_t
 
Àngth
)

248 c⁄° 
KvdoW‹kFun˘i⁄TabÀ
 *
fun˘i⁄IDs
 = &
°©s
->
fun˘i⁄TabÀ
;

249 
size_t
 
cuºítOff£t
 = 0;

251 
uöt64_t
 
íqueued
, 
¥o˚s£d
, 
timedOut
;

252 
i
;

253 
i
 = 0; i < 
NUM_WORK_QUEUE_ITEM_STATS
; i++) {

254 i‡(
fun˘i⁄IDs
->
fun˘i⁄s
[
i
] =
NULL
) {

257 i‡(
	`©omic64_ªad
(&
°©s
->
íqueued
[
i
]) == 0) {

268 
≥ndög
;

269 
	`gëW‹kIãmCou¡sByIãm
(
°©s
, 
i
,

270 &
íqueued
, &
¥o˚s£d
, &
timedOut
, &
≥ndög
);

273 i‡(
ENABLE_PER_FUNCTION_TIMING_STATS
) {

274 
uöt64_t
 
mö
, 
món
, 
max
;

275 
	`gëW‹kIãmTimesByIãm
(
°©s
, 
i
, &
mö
, &
món
, &
max
);

276 
cuºítOff£t
 +
	`¢¥ötf
(
buf„r
 + currentOffset,

277 
Àngth
 - 
cuºítOff£t
,

278 "%-36p†%d %10" 
PRIu64
 " %10" PRIu64 " %10" PRIu64

279 " %10" 
PRIu64
 " %10" PRIu64 " %10" PRIu64

281 
fun˘i⁄IDs
->
fun˘i⁄s
[
i
],

282 
fun˘i⁄IDs
->
¥i‹ôõs
[
i
],

283 
íqueued
, 
¥o˚s£d
, 
timedOut
,

284 
mö
, 
max
, 
món
);

286 
cuºítOff£t
 +
	`¢¥ötf
(
buf„r
 + currentOffset,

287 
Àngth
 - 
cuºítOff£t
,

288 "%-36p†%d %10" 
PRIu64
 " %10" PRIu64 " %10" PRIu64

290 
fun˘i⁄IDs
->
fun˘i⁄s
[
i
],

291 
fun˘i⁄IDs
->
¥i‹ôõs
[
i
],

292 
íqueued
, 
¥o˚s£d
, 
timedOut
);

294 i‡(
cuºítOff£t
 >
Àngth
) {

298 i‡((
i
 =
NUM_WORK_QUEUE_ITEM_STATS
Ë&& (
cuºítOff£t
 < 
Àngth
)) {

299 
uöt64_t
 
íqueued
, 
¥o˚s£d
, 
timedOut
;

300 
	`gëOthîW‹kIãmCou¡s
(
°©s
, &
íqueued
, &
¥o˚s£d
, &
timedOut
);

301 i‡(
íqueued
 > 0) {

302 
cuºítOff£t
 +
	`¢¥ötf
(
buf„r
 + currentOffset,

303 
Àngth
 - 
cuºítOff£t
,

304 "%-36†%d %10" 
PRIu64
 " %10" PRIu64 " %10" PRIu64

307 
íqueued
, 
¥o˚s£d
, 
timedOut
);

310  
cuºítOff£t
;

311 
	}
}

314 
	$logW‹kIãmSèts
(c⁄° 
KvdoW‹kIãmSèts
 *
°©s
)

316 
uöt64_t
 
tŸÆEnqueued
 = 0;

317 
uöt64_t
 
tŸÆPro˚s£d
 = 0;

318 
uöt64_t
 
tŸÆTimedOut
 = 0;

320 c⁄° 
KvdoW‹kFun˘i⁄TabÀ
 *
fun˘i⁄IDs
 = &
°©s
->
fun˘i⁄TabÀ
;

322 
i
;

323 
i
 = 0; i < 
NUM_WORK_QUEUE_ITEM_STATS
; i++) {

324 i‡(
fun˘i⁄IDs
->
fun˘i⁄s
[
i
] =
NULL
) {

327 i‡(
	`©omic64_ªad
(&
°©s
->
íqueued
[
i
]) == 0) {

338 
uöt64_t
 
íqueued
, 
¥o˚s£d
, 
timedOut
;

339 
≥ndög
;

340 
	`gëW‹kIãmCou¡sByIãm
(
°©s
, 
i
,

341 &
íqueued
, &
¥o˚s£d
, &
timedOut
, &
≥ndög
);

342 
tŸÆEnqueued
 +
íqueued
;

343 
tŸÆPro˚s£d
 +
¥o˚s£d
;

344 
tŸÆTimedOut
 +
timedOut
;

346 
w‹k
[256];

347 
	`gëFun˘i⁄Name
(
fun˘i⁄IDs
->
fun˘i⁄s
[
i
], 
w‹k
, (work));

349 i‡(
ENABLE_PER_FUNCTION_TIMING_STATS
) {

350 
uöt64_t
 
mö
, 
món
, 
max
;

351 
	`gëW‹kIãmTimesByIãm
(
°©s
, 
i
, &
mö
, &
món
, &
max
);

352 
	`logInfo
("Öriority %d: %uÖending"

353 " %" 
PRIu64
 "Énqueued %" PRIu64 "Örocessed"

354 " %" 
PRIu64
 "Åimed out %s"

355 "Åime†%" 
PRIu64
 "/%" PRIu64 "/%" PRIu64 "ns",

356 
fun˘i⁄IDs
->
¥i‹ôõs
[
i
],

357 
≥ndög
, 
íqueued
, 
¥o˚s£d
, 
timedOut
, 
w‹k
,

358 
mö
, 
món
, 
max
);

360 
	`logInfo
("Öriority %d: %uÖending"

361 " %" 
PRIu64
 "Énqueued %" PRIu64 "Örocessed"

362 " %" 
PRIu64
 "Åimed out %s",

363 
fun˘i⁄IDs
->
¥i‹ôõs
[
i
],

364 
≥ndög
, 
íqueued
, 
¥o˚s£d
, 
timedOut
, 
w‹k
);

367 i‡(
i
 =
NUM_WORK_QUEUE_ITEM_STATS
) {

368 
uöt64_t
 
íqueued
, 
¥o˚s£d
, 
timedOut
;

369 
	`gëOthîW‹kIãmCou¡s
(
°©s
, &
íqueued
, &
¥o˚s£d
, &
timedOut
);

370 i‡(
íqueued
 > 0) {

371 
tŸÆEnqueued
 +
íqueued
;

372 
tŸÆPro˚s£d
 +
¥o˚s£d
;

373 
tŸÆTimedOut
 +
timedOut
;

374 
	`logInfo
(" ... othîs: %" 
PRIu64
 "Énqueued %" PRIu64 "Örocessed"

375 " %" 
PRIu64
 "Åimed out",

376 
íqueued
, 
¥o˚s£d
, 
timedOut
);

379 
	`logInfo
("Åotal: %lluÉnqueued %lluÖrocessed %lluÅimed out",

380 
tŸÆEnqueued
, 
tŸÆPro˚s£d
, 
tŸÆTimedOut
);

381 
	}
}

	@vdo/kernel/workItemStats.h

22 #i‚de‡
WORK_ITEM_STATS_H


23 
	#WORK_ITEM_STATS_H


	)

25 
	~"timeUtûs.h
"

27 
	~"w‹kQueue.h
"

31 
	mENABLE_PER_FUNCTION_TIMING_STATS
 = 0,

33 
	mNUM_WORK_QUEUE_ITEM_STATS
 = 18,

36 
	ssim∂eSèts
 {

37 
uöt64_t
 
	mcou¡
;

38 
uöt64_t
 
	msum
;

39 
uöt64_t
 
	mmö
;

40 
uöt64_t
 
	mmax
;

41 } 
	tSim∂eSèts
;

71 
	skvdoW‹kIãmSètsFun˘i⁄TabÀ
 {

78 
•ölock_t
 
	mlock
;

79 
KvdoW‹kFun˘i⁄
 
	mfun˘i⁄s
[
NUM_WORK_QUEUE_ITEM_STATS
];

80 
uöt8_t
 
	m¥i‹ôõs
[
NUM_WORK_QUEUE_ITEM_STATS
];

81 } 
	tKvdoW‹kFun˘i⁄TabÀ
;

83 
	skvdoW‹kIãmSèts
 {

93 
KvdoW‹kFun˘i⁄TabÀ
 
	mfun˘i⁄TabÀ
;

95 
	m∑d
[
CACHE_LINE_BYTES
 - (
©omic64_t
)];

101 
©omic64_t
 
	míqueued
[
NUM_WORK_QUEUE_ITEM_STATS
 + 1];

107 
©omic64_t
 
	mtimedOut
[
NUM_WORK_QUEUE_ITEM_STATS
 + 1];

118 
Sim∂eSèts
 
	mtimes
[
NUM_WORK_QUEUE_ITEM_STATS
 + 1];

119 } 
	tKvdoW‹kIãmSèts
;

128 
ölöe
 
	$öôSim∂eSèts
(
Sim∂eSèts
 *
°©s
)

131 
°©s
->
mö
 = 
UINT64_MAX
;

132 
	}
}

140 
ölöe
 
	$addSam∂e
(
Sim∂eSèts
 *
°©s
, 
uöt64_t
 
vÆue
)

142 
°©s
->
cou¡
++;

143 
°©s
->
sum
 +
vÆue
;

144 i‡(
°©s
->
mö
 > 
vÆue
) {

145 
°©s
->
mö
 = 
vÆue
;

147 i‡(
°©s
->
max
 < 
vÆue
) {

148 
°©s
->
max
 = 
vÆue
;

150 
	}
}

159 
ölöe
 
uöt64_t
 
	$gëSam∂eAvîage
(c⁄° 
Sim∂eSèts
 *
°©s
)

161 
uöt64_t
 
¶›
 = 
°©s
->
cou¡
 / 2;

162  (
°©s
->
sum
 + 
¶›
Ë/ sèts->
cou¡
;

163 
	}
}

173 
upd©eW‹kIãmSètsF‹Enqueue
(
KvdoW‹kIãmSèts
 *
°©s
,

174 
KvdoW‹kIãm
 *
ôem
,

175 
¥i‹ôy
);

192 
ölöe
 
	$upd©eW‹kIãmSètsF‹Dequeue
(
KvdoW‹kIãmSèts
 *
°©s
,

193 
KvdoW‹kIãm
 *
ôem
)

197 i‡(!
ENABLE_PER_FUNCTION_TIMING_STATS
) {

198 
°©s
->
times
[
ôem
->
°©TabÀIndex
].
cou¡
++;

202 
	}
}

211 
upd©eW‹kIãmSètsF‹Timeout
(
KvdoW‹kIãmSèts
 *
°©s
,

212 
KvdoW‹kIãm
 *
ôem
);

223 
ölöe
 
uöt64_t
 
	$ªc‹dSèπTime
(
ödex
)

225  (
ENABLE_PER_FUNCTION_TIMING_STATS
 ? 
	`cuºítTime
(
CT_MONOTONIC
) : 0);

226 
	}
}

237 
ölöe
 
	$upd©eW‹kIãmSètsF‹W‹kTime
(
KvdoW‹kIãmSèts
 *
°©s
,

238 
ödex
,

239 
uöt64_t
 
°¨tTime
)

241 i‡(
ENABLE_PER_FUNCTION_TIMING_STATS
) {

242 
uöt64_t
 
ídTime
 = 
	`cuºítTime
(
CT_MONOTONIC
);

243 
	`addSam∂e
(&
°©s
->
times
[
ödex
], 
ídTime
 - 
°¨tTime
);

245 
	}
}

255 *
gëFun˘i⁄Name
(*
poöãr
, *
buf„r
, 
size_t
 
buf„rLígth
);

263 
logW‹kIãmSèts
(c⁄° 
KvdoW‹kIãmSèts
 *
°©s
);

274 
size_t
 
f‹m©W‹kIãmSèts
(c⁄° 
KvdoW‹kIãmSèts
 *
°©s
,

275 *
buf„r
,

276 
size_t
 
Àngth
);

	@vdo/kernel/workQueue.c

22 
	~"w‹kQueue.h
"

24 
	~<löux/dñay.h
>

25 
	~<löux/kthªad.h
>

27 
	~"loggî.h
"

28 
	~"mem‹yAŒoc.h
"

29 
	~"≥rmas£π.h
"

30 
	~"°rögUtûs.h
"

32 
	~"numîic.h
"

33 
	~"w‹kIãmSèts.h
"

34 
	~"w‹kQueueH™dÀ.h
"

35 
	~"w‹kQueueI¡î«ls.h
"

36 
	~"w‹kQueueSèts.h
"

37 
	~"w‹kQueueSysfs.h
"

39 
	eíqueueResu…
 {

41 
	mENQUEUE_NORMAL
,

43 
	mENQUEUE_TIMED_OUT
,

45 
	mENQUEUE_NEEDS_WAKEUP


46 } 
	tEnqueueResu…
;

52 
	mFUNNEL_HEARTBEAT_INTERVAL
 = 4000,

56 
	mFUNNEL_FINISH_SLEEP
 = 5000,

59 
muãx
 
	gqueueD©aLock
;

60 
Sim∂eW‹kQueue
 
	gqueueD©a
;

62 
‰ìSim∂eW‹kQueue
(
Sim∂eW‹kQueue
 *
queue
);

63 
föishSim∂eW‹kQueue
(
Sim∂eW‹kQueue
 *
queue
);

68 
	$öôülizeW‹kIãmLi°
(
KvdoW‹kIãmLi°
 *
li°
)

70 
li°
->
èû
 = 
NULL
;

71 
	}
}

74 
	$addToW‹kIãmLi°
(
KvdoW‹kIãmLi°
 *
li°
, 
KvdoW‹kIãm
 *
ôem
)

76 i‡(
li°
->
èû
 =
NULL
) {

77 
ôem
->
√xt
 = item;

79 
KvdoW‹kIãm
 *
hód
 = 
li°
->
èû
->
√xt
;

80 
li°
->
èû
->
√xt
 = 
ôem
;

81 
ôem
->
√xt
 = 
hód
;

83 
li°
->
èû
 = 
ôem
;

84 
	}
}

87 
boﬁ
 
	$isW‹kIãmLi°Em±y
(
KvdoW‹kIãmLi°
 *
li°
)

89  
li°
->
èû
 =
NULL
;

90 
	}
}

93 
KvdoW‹kIãm
 *
	$w‹kIãmLi°Pﬁl
(
KvdoW‹kIãmLi°
 *
li°
)

95 
KvdoW‹kIãm
 *
èû
 = 
li°
->tail;

96 i‡(
èû
 =
NULL
) {

97  
NULL
;

100 
KvdoW‹kIãm
 *
hód
 = 
èû
->
√xt
;

102 i‡(
hód
 =
èû
) {

103 
li°
->
èû
 = 
NULL
;

105 
èû
->
√xt
 = 
hód
->next;

107 
hód
->
√xt
 = 
NULL
;

108  
hód
;

109 
	}
}

112 
KvdoW‹kIãm
 *
	$w‹kIãmLi°Pìk
(
KvdoW‹kIãmLi°
 *
li°
)

114 
KvdoW‹kIãm
 *
èû
 = 
li°
->tail;

115  
èû
 ?Åaû->
√xt
 : 
NULL
;

116 
	}
}

132 
ölöe
 
Sim∂eW‹kQueue
 *
	$√xtSîvi˚Queue
(
RoundRoböW‹kQueue
 *
queue
)

134 
ödex
 = (
queue
->
£rvi˚QueueRŸ‹
++ % queue->
numSîvi˚Queues
);

135  
queue
->
£rvi˚Queues
[
ödex
];

136 
	}
}

148 
ölöe
 
Sim∂eW‹kQueue
 *
	$pickSim∂eQueue
(
KvdoW‹kQueue
 *
queue
)

150  (
queue
->
roundRoböMode


151 ? 
	`√xtSîvi˚Queue
(
	`asRoundRoböW‹kQueue
(
queue
))

152 : 
	`asSim∂eW‹kQueue
(
queue
));

153 
	}
}

171 
KvdoW‹kIãm
 *
	$pﬁlF‹W‹kIãm
(
Sim∂eW‹kQueue
 *
queue
)

173 
KvdoW‹kIãm
 *
ôem
 = 
NULL
;

174 
i
 = 
queue
->
numPri‹ôyLi°s
 - 1; i >= 0; i--) {

175 
Fu¬ñQueueE¡ry
 *
lök
 = 
	`fu¬ñQueuePﬁl
(
queue
->
¥i‹ôyLi°s
[
i
]);

176 i‡(
lök
 !
NULL
) {

177 
ôem
 = 
	`c⁄èöî_of
(
lök
, 
KvdoW‹kIãm
, 
w‹kQueueE¡ryLök
);

182  
ôem
;

183 
	}
}

200 
__©åibuã__
((
w¨n_unu£d_ªsu…
))

201 
EnqueueResu…
 
	$íqueueW‹kQueueIãm
(
Sim∂eW‹kQueue
 *
queue
,

202 
KvdoW‹kIãm
 *
ôem
)

204 
KvdoW‹kFun˘i⁄
 
timeoutW‹kAtSèπ
 = 
ôem
->
timeoutW‹k
;

206 
	`ASSERT_LOG_ONLY
(
ôem
->
myQueue
 =
NULL
,

208 "(%p)", 
ôem
, iãm->
w‹k
, iãm->
°©sFun˘i⁄
, 
queue
,

209 
ôem
->
myQueue
);

210 i‡(
	`ASSERT
(
ôem
->
a˘i⁄
 < 
WORK_QUEUE_ACTION_COUNT
,

211 "a˘i⁄ i†öÑ™gêf‹ queue"Ë!
VDO_SUCCESS
) {

212 
ôem
->
a˘i⁄
 = 0;

214 
¥i‹ôy
 = 
queue
->
¥i‹ôyM≠
[
ôem
->
a˘i⁄
];

216 i‡(
	`ASSERT
((
queue
->
timeoutSuµ‹t
 =
åue
 || 
ôem
->
timeoutW‹k
 =
NULL
),

218 "ö st‹ög w‹k iãm", 
queue
->
comm⁄
.
«me
Ë!
UDS_SUCCESS
) {

221  
ENQUEUE_NORMAL
;

225 
	`upd©eSètsF‹Enqueue
(&
queue
->
°©s
, 
ôem
, 
¥i‹ôy
);

228 i‡((
ôem
->
timeoutW‹k
 !
NULL
Ë&& (ôem->
timeout
 <
jiffõs
)) {

229 
	`upd©eW‹kIãmSètsF‹Timeout
(&
queue
->
°©s
.
w‹kIãmSèts
, 
ôem
);

230  
ENQUEUE_TIMED_OUT
;

233 
ôem
->
myQueue
 = &
queue
->
comm⁄
;

236 
EnqueueResu…
 
íqueueResu…
 = 
ENQUEUE_NORMAL
;

237 
Jiffõs
 
timeout
 = 
ôem
->timeout;

238 
boﬁ
 
mu°SëTimî
 = (
timeoutW‹kAtSèπ
 !
NULL
);

240 
	`fu¬ñQueuePut
(
queue
->
¥i‹ôyLi°s
[
¥i‹ôy
], &
ôem
->
w‹kQueueE¡ryLök
);

269 
íqueueResu…
 = (((
	`©omic_ªad
(&
queue
->
idÀ
) == 1)

270 && (
	`©omic_cmpxchg
(&
queue
->
idÀ
, 1, 0) == 1))

271 ? 
ENQUEUE_NEEDS_WAKEUP


272 : 
ENQUEUE_NORMAL
);

281 
ôem
 = 
NULL
;

287 i‡(
mu°SëTimî
) {

288 
	`£tTimîIfNŸRu¬ög
(&
queue
->
timeoutTimî
, 
timeout
);

291  
íqueueResu…
;

292 
	}
}

304 
	$gëPídögCou¡
(
Sim∂eW‹kQueue
 *
queue
)

306 
KvdoW‹kIãmSèts
 *
°©s
 = &
queue
->°©s.
w‹kIãmSèts
;

307 
≥ndög
 = 0;

308 
i
 = 0; i < 
NUM_WORK_QUEUE_ITEM_STATS
 + 1; i++) {

309 
≥ndög
 +
	`©omic64_ªad
(&
°©s
->
íqueued
[
i
]);

310 
≥ndög
 -
	`©omic64_ªad
(&
°©s
->
timedOut
[
i
]);

311 
≥ndög
 -
°©s
->
times
[
i
].
cou¡
;

313 i‡(
≥ndög
 < 0) {

318 
≥ndög
 = 1;

320  
≥ndög
;

321 
	}
}

334 
ölöe
 
	$lockC⁄sumîLock
(
Sim∂eW‹kQueue
 *
queue
,

335 *
Êags
)

337 i‡(
queue
->
timeoutSuµ‹t
) {

338 
	`•ö_lock_úqßve
(&
queue
->
c⁄sumîLock
, *
Êags
);

340 
	}
}

353 
ölöe
 
	$u∆ockC⁄sumîLock
(
Sim∂eW‹kQueue
 *
queue
,

354 *
Êags
)

356 i‡(
queue
->
timeoutSuµ‹t
) {

357 
	`•ö_u∆ock_úqª°‹e
(&
queue
->
c⁄sumîLock
, *
Êags
);

359 
	}
}

366 
	$runSèπHook
(
Sim∂eW‹kQueue
 *
queue
)

368 i‡(
queue
->
ty≥
->
°¨t
 !
NULL
) {

369 
queue
->
ty≥
->
	`°¨t
(queue->
¥iv©e
);

371 
	}
}

378 
	$runFöishHook
(
Sim∂eW‹kQueue
 *
queue
)

380 i‡(
queue
->
ty≥
->
föish
 !
NULL
) {

381 
queue
->
ty≥
->
	`föish
(queue->
¥iv©e
);

383 
	}
}

403 
KvdoW‹kIãm
 *
	$runSu•ídHook
(
Sim∂eW‹kQueue
 *
queue
,

404 *
Êags
)

406 i‡(
queue
->
ty≥
->
su•íd
 =
NULL
) {

407  
NULL
;

410 
	`u∆ockC⁄sumîLock
(
queue
, 
Êags
);

411 
queue
->
ty≥
->
	`su•íd
(queue->
¥iv©e
);

412 
	`lockC⁄sumîLock
(
queue
, 
Êags
);

413  
	`pﬁlF‹W‹kIãm
(
queue
);

414 
	}
}

423 
boﬁ
 
	$hasDñayedW‹kIãms
(
Sim∂eW‹kQueue
 *
queue
)

425 
boﬁ
 
ªsu…
;

426 
Êags
;

427 
	`•ö_lock_úqßve
(&
queue
->
lock
, 
Êags
);

428 
ªsu…
 = !
	`isW‹kIãmLi°Em±y
(&
queue
->
dñayedIãms
);

429 
	`•ö_u∆ock_úqª°‹e
(&
queue
->
lock
, 
Êags
);

430  
ªsu…
;

431 
	}
}

452 
KvdoW‹kIãm
 *
	$waôF‹NextW‹kIãm
(
Sim∂eW‹kQueue
 *
queue
,

453 *
Êags
,

454 
TimeoutJiffõs
 
timeoutI¡îvÆ
)

456 
KvdoW‹kIãm
 *
ôem
 = 
	`runSu•ídHook
(
queue
, 
Êags
);

457 i‡(
ôem
 !
NULL
) {

458  
ôem
;

461 
	`DEFINE_WAIT
(
waô
);

462 
åue
) {

463 
	`©omic64_£t
(&
queue
->
fú°Wakeup
, 0);

464 
	`¥ï¨e_to_waô
(&
queue
->
waôögW‹kîThªads
, &
waô
, 
TASK_INTERRUPTIBLE
);

474 
	`©omic_£t
(&
queue
->
idÀ
, 1);

475 
	`mem‹yFí˚
();

477 
ôem
 = 
	`pﬁlF‹W‹kIãm
(
queue
);

478 i‡(
ôem
 !
NULL
) {

491 i‡(
	`kthªad_should_°›
(Ë&& !
	`hasDñayedW‹kIãms
(
queue
)) {

510 
ôem
 = 
	`pﬁlF‹W‹kIãm
(
queue
);

514 
	`u∆ockC⁄sumîLock
(
queue
, 
Êags
);

519 
queue
->
°©s
.
waôs
++;

520 
uöt64_t
 
timeBef‹eScheduÀ
 = 
	`cuºítTime
(
CT_MONOTONIC
);

521 
	`©omic64_add
(
timeBef‹eScheduÀ
 - 
queue
->
mo°Re˚¡Wakeup
,

522 &
queue
->
°©s
.
runTime
);

524 
	`scheduÀ_timeout
(
timeoutI¡îvÆ
);

525 
queue
->
mo°Re˚¡Wakeup
 = 
	`cuºítTime
(
CT_MONOTONIC
);

526 
uöt64_t
 
ˇŒDuøti⁄NS
 = 
queue
->
mo°Re˚¡Wakeup
 - 
timeBef‹eScheduÀ
;

527 
	`íãrHi°ogømSam∂e
(
queue
->
°©s
.
scheduÀTimeHi°ogøm
,

528 
ˇŒDuøti⁄NS
 / 1000);

529 
	`lockC⁄sumîLock
(
queue
, 
Êags
);

536 
ôem
 = 
	`pﬁlF‹W‹kIãm
(
queue
);

537 i‡(
ôem
 !
NULL
) {

542 i‡(
ôem
 !
NULL
) {

543 
uöt64_t
 
fú°Wakeup
 = 
	`©omic64_ªad
(&
queue
->firstWakeup);

551 
	`lﬂdFí˚
();

552 i‡(
fú°Wakeup
 != 0) {

553 
	`íãrHi°ogømSam∂e
(
queue
->
°©s
.
wakeupL©ícyHi°ogøm
,

554 (
	`cuºítTime
(
CT_MONOTONIC
Ë- 
fú°Wakeup
) / 1000);

555 
	`íãrHi°ogømSam∂e
(
queue
->
°©s
.
wakeupQueueLígthHi°ogøm
,

556 
	`gëPídögCou¡
(
queue
));

559 
	`föish_waô
(&
queue
->
waôögW‹kîThªads
, &
waô
);

560 
	`©omic_£t
(&
queue
->
idÀ
, 0);

562  
ôem
;

563 
	}
}

582 
KvdoW‹kIãm
 *
	$gëNextW‹kIãm
(
Sim∂eW‹kQueue
 *
queue
,

583 *
Êags
,

584 
TimeoutJiffõs
 
timeoutI¡îvÆ
)

586 
KvdoW‹kIãm
 *
ôem
 = 
	`pﬁlF‹W‹kIãm
(
queue
);

587 i‡(
ôem
 !
NULL
) {

588  
ôem
;

590  
	`waôF‹NextW‹kIãm
(
queue
, 
Êags
, 
timeoutI¡îvÆ
);

591 
	}
}

601 
	$¥o˚ssW‹kIãm
(
Sim∂eW‹kQueue
 *
queue
,

602 
KvdoW‹kIãm
 *
ôem
,

603 *
Êags
)

605 
	`u∆ockC⁄sumîLock
(
queue
, 
Êags
);

606 i‡(
	`ASSERT
(
ôem
->
myQueue
 =&
queue
->
comm⁄
,

608 "(%p)", 
ôem
, 
queue
, iãm->
myQueue
Ë=
UDS_SUCCESS
) {

609 
	`upd©eSètsF‹Dequeue
(&
queue
->
°©s
, 
ôem
);

610 
ôem
->
myQueue
 = 
NULL
;

614 
ödex
 = 
ôem
->
°©TabÀIndex
;

615 
uöt64_t
 
w‹kSèπTime
 = 
	`ªc‹dSèπTime
(
ödex
);

616 
ôem
->
	`w‹k
(item);

618 
ôem
 = 
NULL
;

619 
	`upd©eW‹kIãmSètsF‹W‹kTime
(&
queue
->
°©s
.
w‹kIãmSèts
, 
ödex
,

620 
w‹kSèπTime
);

631 i‡(
	`√ed_ªsched
()) {

632 
uöt64_t
 
timeBef‹eRescheduÀ
 = 
	`cuºítTime
(
CT_MONOTONIC
);

634 
queueLí
 = 
	`gëPídögCou¡
(
queue
);

635 
	`c⁄d_ªsched
();

636 
uöt64_t
 
timeA·îRescheduÀ
 = 
	`cuºítTime
(
CT_MONOTONIC
);

638 
	`íãrHi°ogømSam∂e
(
queue
->
°©s
.
ªscheduÀQueueLígthHi°ogøm
,

639 
queueLí
);

640 
uöt64_t
 
runTimeNS
 = 
timeBef‹eRescheduÀ
 - 
queue
->
mo°Re˚¡Wakeup
;

641 
	`íãrHi°ogømSam∂e
(
queue
->
°©s
.
runTimeBef‹eRescheduÀHi°ogøm
,

642 
runTimeNS
 / 1000);

643 
	`©omic64_add
(
runTimeNS
, &
queue
->
°©s
.
runTime
);

644 
uöt64_t
 
ˇŒTimeNS
 = 
timeA·îRescheduÀ
 - 
timeBef‹eRescheduÀ
;

645 
	`íãrHi°ogømSam∂e
(
queue
->
°©s
.
ªscheduÀTimeHi°ogøm
,

646 
ˇŒTimeNS
 / 1000);

647 
	`©omic64_add
(
ˇŒTimeNS
, &
queue
->
°©s
.
ªscheduÀTime
);

648 
queue
->
mo°Re˚¡Wakeup
 = 
timeA·îRescheduÀ
;

650 
	`lockC⁄sumîLock
(
queue
, 
Êags
);

651 
	}
}

660 
	$£rvi˚W‹kQueue
(
Sim∂eW‹kQueue
 *
queue
)

663 
TimeoutJiffõs
 
timeoutI¡îvÆ
 =

664 
	`maxL⁄g
(2, 
	`u£cs_to_jiffõs
(
FUNNEL_HEARTBEAT_INTERVAL
 + 1) - 1);

665 
Êags
 = 0;

667 
	`runSèπHook
(
queue
);

668 
	`lockC⁄sumîLock
(
queue
, &
Êags
);

670 
åue
) {

671 
KvdoW‹kIãm
 *
ôem
 = 
	`gëNextW‹kIãm
(
queue
, &
Êags
, 
timeoutI¡îvÆ
);

672 i‡(
ôem
 =
NULL
) {

677 
	`¥o˚ssW‹kIãm
(
queue
, 
ôem
, &
Êags
);

680 
	`u∆ockC⁄sumîLock
(
queue
, &
Êags
);

681 
	`runFöishHook
(
queue
);

682 
	}
}

692 
	$w‹kQueueRu¬î
(*
±r
)

694 
Sim∂eW‹kQueue
 *
queue
 = 
±r
;

695 
	`kobje˘_gë
(&
queue
->
comm⁄
.
kobj
);

697 
W‹kQueueSèckH™dÀ
 
queueH™dÀ
;

698 
	`öôülizeW‹kQueueSèckH™dÀ
(&
queueH™dÀ
, 
queue
);

699 
queue
->
°©s
.
°¨tTime
 = queue->
mo°Re˚¡Wakeup
 = 
	`cuºítTime
(
CT_MONOTONIC
);

700 
	`©omic_£t
(&
queue
->
°¨ãd
, 
åue
);

701 
	`wake_up
(&
queue
->
°¨tWaôîs
);

702 
	`£rvi˚W‹kQueue
(
queue
);

705 
	`mem£t
(&
queueH™dÀ
, 0, (queueHandle));

707 
	`kobje˘_put
(&
queue
->
comm⁄
.
kobj
);

709 
	}
}

714 
	$£tupW‹kIãm
(
KvdoW‹kIãm
 *
ôem
,

715 
KvdoW‹kFun˘i⁄
 
w‹k
,

716 *
°©sFun˘i⁄
,

717 
a˘i⁄
)

719 
	`£tupW‹kIãmWôhTimeout
(
ôem
, 
w‹k
, 
°©sFun˘i⁄
, 
a˘i⁄
, 
NULL
, 0);

720 
	}
}

723 
	$£tupW‹kIãmWôhTimeout
(
KvdoW‹kIãm
 *
ôem
,

724 
KvdoW‹kFun˘i⁄
 
w‹k
,

725 *
°©sFun˘i⁄
,

726 
a˘i⁄
,

727 
KvdoW‹kFun˘i⁄
 
timeoutW‹k
,

728 
Jiffõs
 
timeout
)

730 
	`ASSERT_LOG_ONLY
(
ôem
->
myQueue
 =
NULL
,

732 
ôem
->
w‹k
 = work;

733 
ôem
->
°©sFun˘i⁄
 = ((°©sFun˘i⁄ =
NULL
Ë? 
w‹k
 : statsFunction);

734 
ôem
->
°©TabÀIndex
 = 0;

735 
ôem
->
a˘i⁄
 =áction;

736 
ôem
->
myQueue
 = 
NULL
;

737 
ôem
->
executi⁄Time
 = 0;

738 
ôem
->
timeoutW‹k
 =ÅimeoutWork;

739 
ôem
->
timeout
 =Åimeout;

740 
ôem
->
√xt
 = 
NULL
;

741 
	}
}

746 
ölöe
 
	$wakeW‹kîThªad
(
Sim∂eW‹kQueue
 *
queue
)

748 
	`©omic64_cmpxchg
(&
queue
->
fú°Wakeup
, 0, 
	`cuºítTime
(
CT_MONOTONIC
));

750 
	`wake_up
(&
queue
->
waôögW‹kîThªads
);

751 
	}
}

760 
	$¥o˚ssDñayedW‹kIãms
(
d©a
)

762 
Sim∂eW‹kQueue
 *
queue
 = (Sim∂eW‹kQueuê*Ë
d©a
;

763 
Jiffõs
 
√xtExecuti⁄Time
 = 0;

764 
boﬁ
 
ªscheduÀ
 = 
Ál£
;

765 
boﬁ
 
√edsWakeup
 = 
Ál£
;

767 
Êags
;

768 
	`•ö_lock_úqßve
(&
queue
->
lock
, 
Êags
);

769 !
	`isW‹kIãmLi°Em±y
(&
queue
->
dñayedIãms
)) {

770 
KvdoW‹kIãm
 *
ôem
 = 
	`w‹kIãmLi°Pìk
(&
queue
->
dñayedIãms
);

771 i‡(
ôem
->
executi⁄Time
 > 
jiffõs
) {

772 
√xtExecuti⁄Time
 = 
ôem
->
executi⁄Time
;

773 
ªscheduÀ
 = 
åue
;

776 
	`w‹kIãmLi°Pﬁl
(&
queue
->
dñayedIãms
);

777 
ôem
->
executi⁄Time
 = 0;

778 
ôem
->
myQueue
 = 
NULL
;

779 
EnqueueResu…
 
íqueueResu…
 = 
	`íqueueW‹kQueueIãm
(
queue
, 
ôem
);

781 
√edsWakeup
 |(
íqueueResu…
 =
ENQUEUE_NEEDS_WAKEUP
);

783 
	`•ö_u∆ock_úqª°‹e
(&
queue
->
lock
, 
Êags
);

784 i‡(
ªscheduÀ
) {

785 
	`mod_timî
(&
queue
->
dñayedIãmsTimî
, 
√xtExecuti⁄Time
);

787 i‡(
√edsWakeup
) {

788 
	`wakeW‹kîThªad
(
queue
);

790 
	}
}

803 
KvdoW‹kIãm
 *
	$gëTimedOutW‹kIãm
(
Sim∂eW‹kQueue
 *
queue
, 
¥i‹ôy
)

805 
Fu¬ñQueueE¡ry
 *
íåy
 = 
	`fu¬ñQueuePﬁl
(
queue
->
¥i‹ôyLi°s
[
¥i‹ôy
]);

806 
	`BUG_ON
(
íåy
 =
NULL
);

807 
KvdoW‹kIãm
 *
ôem
 = 
	`c⁄èöî_of
(
íåy
, KvdoW‹kIãm, 
w‹kQueueE¡ryLök
);

809 i‡(
ôem
->
myQueue
 =&
queue
->
comm⁄
) {

810 
	`upd©eW‹kIãmSètsF‹Timeout
(&
queue
->
°©s
.
w‹kIãmSèts
, 
ôem
);

811 
ôem
->
myQueue
 = 
NULL
;

813  
ôem
;

814 
	}
}

817 
	$„tchExpúedIãms
(
Sim∂eW‹kQueue
 *
queue
,

818 
KvdoW‹kIãmLi°
 *
expúedIãms
)

820 
Jiffõs
 
√xtExpú©i⁄
 = -1UL;

821 
Êags
;

822 
	`•ö_lock_úqßve
(&
queue
->
c⁄sumîLock
, 
Êags
);

824 
¥i‹ôy
;

825 
¥i‹ôy
 = 
queue
->
numPri‹ôyLi°s
 - 1;Öriority >= 0;Öriority--) {

826 
Fu¬ñQueue
 *
fu¬ñQueue
 = 
queue
->
¥i‹ôyLi°s
[
¥i‹ôy
];

828 
åue
) {

829 
Fu¬ñQueueE¡ry
 *
íåy
 = 
	`fu¬ñQueuePìk
(
fu¬ñQueue
);

830 i‡(
íåy
 =
NULL
) {

834 
KvdoW‹kIãm
 *
ôem
 = 
	`c⁄èöî_of
(
íåy
, KvdoWorkItem,

835 
w‹kQueueE¡ryLök
);

836 i‡(
ôem
->
timeoutW‹k
 =
NULL
) {

840 i‡(
ôem
->
timeout
 <
jiffõs
) {

841 
KvdoW‹kIãm
 *
ªmovedIãm
 = 
	`gëTimedOutW‹kIãm
(
queue
, 
¥i‹ôy
);

842 
	`BUG_ON
(
ªmovedIãm
 !
ôem
);

843 
	`addToW‹kIãmLi°
(
expúedIãms
, 
ôem
);

845 i‡(
ôem
->
timeout
 < 
√xtExpú©i⁄
) {

846 
√xtExpú©i⁄
 = 
ôem
->
timeout
;

852 
	`•ö_u∆ock_úqª°‹e
(&
queue
->
c⁄sumîLock
, 
Êags
);

853  
√xtExpú©i⁄
;

854 
	}
}

857 
	$w‹kQueueTimeout
(
Timî
 *
timî
)

859 
Sim∂eW‹kQueue
 *
queue
 = 
	`c⁄èöî_of
(
timî
, Sim∂eW‹kQueue, 
timeoutTimî
);

861 i‡(
	`ASSERT
(
queue
->
timeoutSuµ‹t
 =
åue
,

863 
queue
->
comm⁄
.
«me
Ë!
UDS_SUCCESS
) {

867 
Jiffõs
 
√xtExpú©i⁄
;

868 
KvdoW‹kIãmLi°
 
expúedIãms
;

869 
	`öôülizeW‹kIãmLi°
(&
expúedIãms
);

870 
cou¡
 = 0;

873 
√xtExpú©i⁄
 = 
	`„tchExpúedIãms
(
queue
, &
expúedIãms
);

876 !
	`isW‹kIãmLi°Em±y
(&
expúedIãms
)) {

877 
KvdoW‹kIãm
 *
ôem
 = 
	`w‹kIãmLi°Pﬁl
(&
expúedIãms
);

878 
ôem
->
	`timeoutW‹k
(item);

881 } (
√xtExpú©i⁄
 != -1UL)

882 && (
√xtExpú©i⁄
 <
jiffõs
)

883 && (++
cou¡
 <= 10));

886 i‡(
√xtExpú©i⁄
 != -1UL) {

887 
	`£tTimîIfNŸRu¬ög
(&
queue
->
timeoutTimî
,

888 
	`maxUL⁄g
(
√xtExpú©i⁄
, 
jiffõs
 + 2));

890 
	}
}

909 
	$makeSim∂eW‹kQueue
(c⁄° *
thªadNamePªfix
,

910 c⁄° *
«me
,

911 
kobje˘
 *
∑ª¡Kobje˘
,

912 *
¥iv©e
,

913 c⁄° 
KvdoW‹kQueueTy≥
 *
ty≥
,

914 
Sim∂eW‹kQueue
 **
queuePå
)

916 
Sim∂eW‹kQueue
 *
queue
;

917 
ªsu…
 = 
	`ALLOCATE
(1, 
Sim∂eW‹kQueue
, "sim∂êw‹k queue", &
queue
);

918 i‡(
ªsu…
 !
UDS_SUCCESS
) {

919  
ªsu…
;

922 
queue
->
ty≥
 =Åype;

923 
queue
->
¥iv©e
 =Örivate;

924 
queue
->
timeoutSuµ‹t
 = 
ty≥
->
√edTimeouts
;

926 
numPri‹ôyLi°s
 = 1;

927 
i
 = 0; i < 
WORK_QUEUE_ACTION_COUNT
; i++) {

928 c⁄° 
KvdoW‹kQueueA˘i⁄
 *
a˘i⁄
 = &
queue
->
ty≥
->
a˘i⁄TabÀ
[
i
];

929 i‡(
a˘i⁄
->
«me
 =
NULL
) {

932 
code
 = 
a˘i⁄
->code;

933 
¥i‹ôy
 = 
a˘i⁄
->priority;

935 
ªsu…
 = 
	`ASSERT
(
code
 < 
WORK_QUEUE_ACTION_COUNT
,

937 
code
);

938 i‡(
ªsu…
 !
VDO_SUCCESS
) {

939 
	`FREE
(
queue
);

940  
ªsu…
;

942 
ªsu…
 = 
	`ASSERT
(
¥i‹ôy
 < 
WORK_QUEUE_PRIORITY_COUNT
,

944 
¥i‹ôy
);

945 i‡(
ªsu…
 !
VDO_SUCCESS
) {

946 
	`FREE
(
queue
);

947  
ªsu…
;

949 
queue
->
¥i‹ôyM≠
[
code
] = 
¥i‹ôy
;

950 i‡(
numPri‹ôyLi°s
 <
¥i‹ôy
) {

951 
numPri‹ôyLi°s
 = 
¥i‹ôy
 + 1;

955 
ªsu…
 = 
	`du∂iˇãSåög
(
«me
, "queuê«me", &
queue
->
comm⁄
.name);

956 i‡(
ªsu…
 !
VDO_SUCCESS
) {

957 
	`FREE
(
queue
);

958  -
ENOMEM
;

961 
	`öô_waôqueue_hód
(&
queue
->
waôögW‹kîThªads
);

962 
	`öô_waôqueue_hód
(&
queue
->
°¨tWaôîs
);

963 
	`•ö_lock_öô
(&
queue
->
lock
);

965 
	`öôülizeW‹kIãmLi°
(&
queue
->
dñayedIãms
);

966 
	`£tup_timî
(&
queue
->
dñayedIãmsTimî
, 
¥o˚ssDñayedW‹kIãms
,

967 (Ë
queue
);

969 
queue
->
numPri‹ôyLi°s
 =ÇumPriorityLists;

970 
i
 = 0; i < 
WORK_QUEUE_PRIORITY_COUNT
; i++) {

971 
ªsu…
 = 
	`makeFu¬ñQueue
(&
queue
->
¥i‹ôyLi°s
[
i
]);

972 i‡(
ªsu…
 !
UDS_SUCCESS
) {

973 
	`‰ìSim∂eW‹kQueue
(
queue
);

974  
ªsu…
;

980 i‡(
queue
->
timeoutSuµ‹t
) {

981 
	`öôTimî
(&
queue
->
timeoutTimî
, 
w‹kQueueTimeout
);

984 
	`kobje˘_öô
(&
queue
->
comm⁄
.
kobj
, &
sim∂eW‹kQueueKobjTy≥
);

985 
ªsu…
 = 
	`kobje˘_add
(&
queue
->
comm⁄
.
kobj
, 
∑ª¡Kobje˘
, queue->comm⁄.
«me
);

986 i‡(
ªsu…
 != 0) {

987 
	`logEº‹
("C™nŸádd sysf†node: %d", 
ªsu…
);

988 
	`föishSim∂eW‹kQueue
(
queue
);

989 
	`‰ìSim∂eW‹kQueue
(
queue
);

990  
ªsu…
;

992 
ªsu…
 = 
	`öôülizeW‹kQueueSèts
(&
queue
->
°©s
, &queue->
comm⁄
.
kobj
);

993 i‡(
ªsu…
 != 0) {

994 
	`logEº‹
("C™nŸ inôülizê°©i°ic†åackög: %d", 
ªsu…
);

995 
	`föishSim∂eW‹kQueue
(
queue
);

996 
	`‰ìSim∂eW‹kQueue
(
queue
);

997  
ªsu…
;

1000 
	`©omic_£t
(&
queue
->
°¨ãd
, 
Ál£
);

1001 
èsk_°ru˘
 *
thªad
 = 
NULL
;

1002 
thªad
 = 
	`kthªad_run
(
w‹kQueueRu¬î
, 
queue
, "%s:%s", 
thªadNamePªfix
,

1003 
queue
->
comm⁄
.
«me
);

1005 i‡(
	`IS_ERR
(
thªad
)) {

1006 
	`föishSim∂eW‹kQueue
(
queue
);

1007 
	`‰ìSim∂eW‹kQueue
(
queue
);

1008  (Ë
	`PTR_ERR
(
thªad
);

1010 
queue
->
thªad
 =Åhread;

1011 
	`©omic_£t
(&
queue
->
thªadID
, 
thªad
->
pid
);

1020 
	`waô_evít
(
queue
->
°¨tWaôîs
, 
	`©omic_ªad
(&queue->
°¨ãd
Ë=
åue
);

1021 *
queuePå
 = 
queue
;

1022  
UDS_SUCCESS
;

1023 
	}
}

1026 
	$makeW‹kQueue
(c⁄° *
thªadNamePªfix
,

1027 c⁄° *
«me
,

1028 
kobje˘
 *
∑ª¡Kobje˘
,

1029 *
¥iv©e
,

1030 c⁄° 
KvdoW‹kQueueTy≥
 *
ty≥
,

1031 
thªadCou¡
,

1032 
KvdoW‹kQueue
 **
queuePå
)

1034 i‡(
thªadCou¡
 == 1) {

1035 
Sim∂eW‹kQueue
 *
sim∂eQueue
;

1036 
ªsu…
 = 
	`makeSim∂eW‹kQueue
(
thªadNamePªfix
, 
«me
, 
∑ª¡Kobje˘
,

1037 
¥iv©e
, 
ty≥
, &
sim∂eQueue
);

1038 i‡(
ªsu…
 =
VDO_SUCCESS
) {

1039 *
queuePå
 = &
sim∂eQueue
->
comm⁄
;

1041  
ªsu…
;

1044 
RoundRoböW‹kQueue
 *
queue
;

1045 
ªsu…
 = 
	`ALLOCATE
(1, 
RoundRoböW‹kQueue
, "round-robin work queue",

1046 &
queue
);

1047 i‡(
ªsu…
 !
UDS_SUCCESS
) {

1048  
ªsu…
;

1051 
ªsu…
 = 
	`ALLOCATE
(
thªadCou¡
, 
Sim∂eW‹kQueue
 *, "subordinate work queues",

1052 &
queue
->
£rvi˚Queues
);

1053 i‡(
ªsu…
 !
UDS_SUCCESS
) {

1054 
	`FREE
(
queue
);

1055  
ªsu…
;

1058 
queue
->
numSîvi˚Queues
 = 
thªadCou¡
;

1059 
queue
->
comm⁄
.
roundRoböMode
 = 
åue
;

1061 
ªsu…
 = 
	`du∂iˇãSåög
(
«me
, "queuê«me", &
queue
->
comm⁄
.name);

1062 i‡(
ªsu…
 !
VDO_SUCCESS
) {

1063 
	`FREE
(
queue
);

1064  -
ENOMEM
;

1067 
	`kobje˘_öô
(&
queue
->
comm⁄
.
kobj
, &
roundRoböW‹kQueueKobjTy≥
);

1068 
ªsu…
 = 
	`kobje˘_add
(&
queue
->
comm⁄
.
kobj
, 
∑ª¡Kobje˘
, queue->comm⁄.
«me
);

1069 i‡(
ªsu…
 != 0) {

1070 
	`logEº‹
("C™nŸádd sysf†node: %d", 
ªsu…
);

1071 
	`föishW‹kQueue
(&
queue
->
comm⁄
);

1072 
	`kobje˘_put
(&
queue
->
comm⁄
.
kobj
);

1073  
ªsu…
;

1076 *
queuePå
 = &
queue
->
comm⁄
;

1078 
thªadName
[
TASK_COMM_LEN
];

1079 
i
 = 0; i < 
thªadCou¡
; i++) {

1080 
	`¢¥ötf
(
thªadName
, —hªadName), "%s%u", 
«me
, 
i
);

1081 
ªsu…
 = 
	`makeSim∂eW‹kQueue
(
thªadNamePªfix
, 
thªadName
,

1082 &
queue
->
comm⁄
.
kobj
, 
¥iv©e
, 
ty≥
,

1083 &
queue
->
£rvi˚Queues
[
i
]);

1084 i‡(
ªsu…
 !
VDO_SUCCESS
) {

1085 
queue
->
numSîvi˚Queues
 = 
i
;

1087 
	`föishW‹kQueue
(*
queuePå
);

1088 
	`‰ìW‹kQueue
(
queuePå
);

1089  
ªsu…
;

1091 
queue
->
£rvi˚Queues
[
i
]->
∑ª¡Queue
 = *
queuePå
;

1094  
VDO_SUCCESS
;

1095 
	}
}

1102 
	$föishSim∂eW‹kQueue
(
Sim∂eW‹kQueue
 *
queue
)

1104 i‡(
queue
->
timeoutSuµ‹t
) {

1112 
	`ˇn˚lTimî
(&
queue
->
timeoutTimî
);

1117 i‡(
queue
->
thªad
 !
NULL
) {

1118 
	`©omic_£t
(&
queue
->
thªadID
, 0);

1120 
	`kthªad_°›
(
queue
->
thªad
);

1123 
queue
->
thªad
 = 
NULL
;

1124 
	}
}

1131 
	$föishRoundRoböW‹kQueue
(
RoundRoböW‹kQueue
 *
queue
)

1133 
Sim∂eW‹kQueue
 **
queueTabÀ
 = 
queue
->
£rvi˚Queues
;

1134 
cou¡
 = 
queue
->
numSîvi˚Queues
;

1136 
i
 = 0; i < 
cou¡
; i++) {

1137 
	`föishSim∂eW‹kQueue
(
queueTabÀ
[
i
]);

1139 
	}
}

1142 
	$föishW‹kQueue
(
KvdoW‹kQueue
 *
queue
)

1144 i‡(
queue
->
roundRoböMode
) {

1145 
	`föishRoundRoböW‹kQueue
(
	`asRoundRoböW‹kQueue
(
queue
));

1147 
	`föishSim∂eW‹kQueue
(
	`asSim∂eW‹kQueue
(
queue
));

1149 
	}
}

1157 
	$‰ìSim∂eW‹kQueue
(
Sim∂eW‹kQueue
 *
queue
)

1159 
i
 = 0; i < 
WORK_QUEUE_PRIORITY_COUNT
; i++) {

1160 
	`‰ìFu¬ñQueue
(
queue
->
¥i‹ôyLi°s
[
i
]);

1162 
	`˛ónupW‹kQueueSèts
(&
queue
->
°©s
);

1163 
	`kobje˘_put
(&
queue
->
comm⁄
.
kobj
);

1164 
	}
}

1172 
	$‰ìRoundRoböW‹kQueue
(
RoundRoböW‹kQueue
 *
queue
)

1174 
Sim∂eW‹kQueue
 **
queueTabÀ
 = 
queue
->
£rvi˚Queues
;

1175 
cou¡
 = 
queue
->
numSîvi˚Queues
;

1177 
queue
->
£rvi˚Queues
 = 
NULL
;

1178 
i
 = 0; i < 
cou¡
; i++) {

1179 
	`‰ìSim∂eW‹kQueue
(
queueTabÀ
[
i
]);

1181 
	`FREE
(
queueTabÀ
);

1182 
	`kobje˘_put
(&
queue
->
comm⁄
.
kobj
);

1183 
	}
}

1186 
	$‰ìW‹kQueue
(
KvdoW‹kQueue
 **
queuePå
)

1188 
KvdoW‹kQueue
 *
queue
 = *
queuePå
;

1189 i‡(
queue
 =
NULL
) {

1192 *
queuePå
 = 
NULL
;

1194 i‡(
queue
->
roundRoböMode
) {

1195 
	`‰ìRoundRoböW‹kQueue
(
	`asRoundRoböW‹kQueue
(
queue
));

1197 
	`‰ìSim∂eW‹kQueue
(
	`asSim∂eW‹kQueue
(
queue
));

1199 
	}
}

1204 
	$dumpSim∂eW‹kQueue
(
Sim∂eW‹kQueue
 *
queue
)

1206 
	`muãx_lock
(&
queueD©aLock
);

1208 
queueD©a
 = *
queue
;

1209 c⁄° *
thªadSètus
;

1211 
èskSèãRï‹t
 = '-';

1212 i‡(
queueD©a
.
thªad
 !
NULL
) {

1213 
èskSèã
 = 
queue
->
thªad
->
°©e
 & 
TASK_REPORT
;

1214 
èskSèã
 &= 0x1ff;

1215 
èskSèãIndex
;

1216 i‡(
èskSèã
 != 0) {

1217 
èskSèãIndex
 = 
	`__ffs
(
èskSèã
)+1;

1218 
	`BUG_ON
(
èskSèãIndex
 >(
TASK_STATE_TO_CHAR_STR
));

1220 
èskSèãIndex
 = 0;

1222 
èskSèãRï‹t
 = 
TASK_STATE_TO_CHAR_STR
[
èskSèãIndex
];

1225 i‡(
queueD©a
.
thªad
 =
NULL
) {

1226 
thªadSètus
 = "noÅhreads";

1227 } i‡(
	`©omic_ªad
(&
queueD©a
.
idÀ
)) {

1228 
thªadSètus
 = "idle";

1230 
thªadSètus
 = "running";

1232 
	`logInfo
("workQ %p (%s) %uÉntries %llu waits, %s (%c)",

1233 &
queue
->
comm⁄
,

1234 
queueD©a
.
comm⁄
.
«me
,

1235 
	`gëPídögCou¡
(&
queueD©a
),

1236 
queueD©a
.
°©s
.
waôs
,

1237 
thªadSètus
,

1238 
èskSèãRï‹t
);

1240 
	`logW‹kIãmSèts
(&
queueD©a
.
°©s
.
w‹kIãmSèts
);

1241 
	`logW‹kQueueSèts
(
queue
);

1243 
	`muãx_u∆ock
(&
queueD©aLock
);

1247 
	}
}

1250 
	$dumpW‹kQueue
(
KvdoW‹kQueue
 *
queue
)

1252 i‡(
queue
->
roundRoböMode
) {

1253 
RoundRoböW‹kQueue
 *
roundRoböQueue
 = 
	`asRoundRoböW‹kQueue
(
queue
);

1254 
i
 = 0; i < 
roundRoböQueue
->
numSîvi˚Queues
; i++) {

1255 
	`dumpSim∂eW‹kQueue
(
roundRoböQueue
->
£rvi˚Queues
[
i
]);

1258 
	`dumpSim∂eW‹kQueue
(
	`asSim∂eW‹kQueue
(
queue
));

1260 
	}
}

1263 
	$dumpW‹kIãmToBuf„r
(
KvdoW‹kIãm
 *
ôem
, *
buf„r
, 
size_t
 
Àngth
)

1265 
size_t
 
cuºítLígth


1266 
	`¢¥ötf
(
buf„r
, 
Àngth
, "%.*s/", 
TASK_COMM_LEN
,

1267 
ôem
->
myQueue
 =
NULL
 ? "-" : iãm->myQueue->
«me
);

1268 i‡(
cuºítLígth
 < 
Àngth
) {

1269 
	`gëFun˘i⁄Name
(
ôem
->
°©sFun˘i⁄
, 
buf„r
 + 
cuºítLígth
,

1270 
Àngth
 - 
cuºítLígth
);

1272 
	}
}

1277 
	$íqueueW‹kQueue
(
KvdoW‹kQueue
 *
kvdoW‹kQueue
, 
KvdoW‹kIãm
 *
ôem
)

1279 
Sim∂eW‹kQueue
 *
queue
 = 
	`pickSim∂eQueue
(
kvdoW‹kQueue
);

1281 
ôem
->
executi⁄Time
 = 0;

1283 
EnqueueResu…
 
íqueueResu…
 = 
ENQUEUE_NORMAL
;

1284 
íqueueResu…
 = 
	`íqueueW‹kQueueIãm
(
queue
, 
ôem
);

1286 
íqueueResu…
) {

1287 
ENQUEUE_NORMAL
:

1289 
ENQUEUE_NEEDS_WAKEUP
:

1290 
	`wakeW‹kîThªad
(
queue
);

1292 
ENQUEUE_TIMED_OUT
:

1293 
ôem
->
	`timeoutW‹k
(item);

1296 
	`ASSERT_LOG_ONLY
(
Ál£
, "enqueueResult (%d)ámongÉxpected values",

1297 
íqueueResu…
);

1300 
	}
}

1303 
	$íqueueW‹kQueueDñayed
(
KvdoW‹kQueue
 *
kvdoW‹kQueue
,

1304 
KvdoW‹kIãm
 *
ôem
,

1305 
Jiffõs
 
executi⁄Time
)

1307 i‡(
	`ASSERT
(
ôem
->
timeoutW‹k
 =
NULL
,

1308 "w‹k iãm c™nŸ havêbŸh dñayándÅimeout"Ë!
UDS_SUCCESS
) {

1309 
ôem
->
timeout
 = 0;

1310 
ôem
->
timeoutW‹k
 = 
NULL
;

1313 i‡(
executi⁄Time
 <
jiffõs
) {

1314 
	`íqueueW‹kQueue
(
kvdoW‹kQueue
, 
ôem
);

1318 
Sim∂eW‹kQueue
 *
queue
 = 
	`pickSim∂eQueue
(
kvdoW‹kQueue
);

1319 
boﬁ
 
ªscheduÀTimî
 = 
Ál£
;

1320 
Êags
;

1322 
ôem
->
executi⁄Time
 =ÉxecutionTime;

1326 
	`•ö_lock_úqßve
(&
queue
->
lock
, 
Êags
);

1328 i‡(
	`isW‹kIãmLi°Em±y
(&
queue
->
dñayedIãms
)) {

1329 
ªscheduÀTimî
 = 
åue
;

1335 
ôem
->
myQueue
 = &
queue
->
comm⁄
;

1336 
	`addToW‹kIãmLi°
(&
queue
->
dñayedIãms
, 
ôem
);

1338 
	`•ö_u∆ock_úqª°‹e
(&
queue
->
lock
, 
Êags
);

1340 i‡(
ªscheduÀTimî
) {

1341 
	`mod_timî
(&
queue
->
dñayedIãmsTimî
, 
executi⁄Time
);

1343 
	}
}

1349 
KvdoW‹kQueue
 *
	$gëCuºítW‹kQueue
()

1351 
Sim∂eW‹kQueue
 *
queue
 = 
	`gëCuºítThªadW‹kQueue
();

1352  (
queue
 =
NULL
Ë? NULL : &queue->
comm⁄
;

1353 
	}
}

1356 *
	$gëW‹kQueuePriv©eD©a
()

1358 
Sim∂eW‹kQueue
 *
queue
 = 
	`gëCuºítThªadW‹kQueue
();

1359  (
queue
 !
NULL
Ë? queue->
¥iv©e
 : NULL;

1360 
	}
}

1363 
	$£tW‹kQueuePriv©eD©a
(*
√wD©a
)

1365 
Sim∂eW‹kQueue
 *
queue
 = 
	`gëCuºítThªadW‹kQueue
();

1366 
	`BUG_ON
(
queue
 =
NULL
);

1367 
queue
->
¥iv©e
 = 
√wD©a
;

1368 
	}
}

1371 
	$öôW‹kQueueOn˚
()

1374 
	`muãx_öô
(&
queueD©aLock
);

1375 
	`öôW‹kQueueSèckH™dÀOn˚
();

1376 
	}
}

	@vdo/kernel/workQueue.h

22 #i‚de‡
ALBIREO_WORK_QUEUE_H


23 
	#ALBIREO_WORK_QUEUE_H


	)

25 
	~<löux/kobje˘.h
>

26 
	~<löux/sched.h
>

28 
	~"fu¬ñQueue.h
"

29 
	~"kî√lTy≥s.h
"

32 
	mMAX_QUEUE_NAME_LEN
 = 
TASK_COMM_LEN
,

34 
	mWORK_QUEUE_ACTION_COUNT
 = 8,

36 
	mWORK_QUEUE_PRIORITY_COUNT
 = 4,

39 
	skvdoW‹kIãm
 {

41 
Fu¬ñQueueE¡ry
 
	mw‹kQueueE¡ryLök
;

43 
KvdoW‹kFun˘i⁄
 
	mw‹k
;

45 *
	m°©sFun˘i⁄
;

47 
KvdoW‹kFun˘i⁄
 
	mtimeoutW‹k
;

49 
Jiffõs
 
	mtimeout
;

51 
	m°©TabÀIndex
;

56 
	ma˘i⁄
;

58 
KvdoW‹kQueue
 *
	mmyQueue
;

63 
Jiffõs
 
	mexecuti⁄Time
;

65 
KvdoW‹kIãm
 *
	m√xt
;

67 
uöt64_t
 
	míqueueTime
;

105 
	skvdoW‹kQueueA˘i⁄
 {

107 *
	m«me
;

110 
	mcode
;

113 
	m¥i‹ôy
;

114 } 
	tKvdoW‹kQueueA˘i⁄
;

116 (*
	tKvdoW‹kQueueFun˘i⁄
)(*);

123 
	skvdoW‹kQueueTy≥
 {

125 
KvdoW‹kQueueFun˘i⁄
 
°¨t
;

128 
KvdoW‹kQueueFun˘i⁄
 
föish
;

131 
KvdoW‹kQueueFun˘i⁄
 
su•íd
;

134 
boﬁ
 
√edTimeouts
;

137 
KvdoW‹kQueueA˘i⁄
 
a˘i⁄TabÀ
[
WORK_QUEUE_ACTION_COUNT
];

138 } 
	tKvdoW‹kQueueTy≥
;

159 
	`makeW‹kQueue
(c⁄° *
thªadNamePªfix
,

160 c⁄° *
«me
,

161 
kobje˘
 *
∑ª¡Kobje˘
,

162 *
¥iv©e
,

163 c⁄° 
KvdoW‹kQueueTy≥
 *
ty≥
,

164 
thªadCou¡
,

165 
KvdoW‹kQueue
 **
queuePå
);

182 
	`£tupW‹kIãm
(
KvdoW‹kIãm
 *
ôem
,

183 
KvdoW‹kFun˘i⁄
 
w‹k
,

184 *
°©sFun˘i⁄
,

185 
a˘i⁄
);

202 
	`£tupW‹kIãmWôhTimeout
(
KvdoW‹kIãm
 *
ôem
,

203 
KvdoW‹kFun˘i⁄
 
w‹k
,

204 *
°©sFun˘i⁄
,

205 
a˘i⁄
,

206 
KvdoW‹kFun˘i⁄
 
timeoutW‹k
,

207 
Jiffõs
 
timeout
);

218 
	`íqueueW‹kQueue
(
KvdoW‹kQueue
 *
queue
, 
KvdoW‹kIãm
 *
ôem
);

233 
	`íqueueW‹kQueueDñayed
(
KvdoW‹kQueue
 *
queue
,

234 
KvdoW‹kIãm
 *
ôem
,

235 
Jiffõs
 
executi⁄Time
);

250 
	`föishW‹kQueue
(
KvdoW‹kQueue
 *
queue
);

257 
	`‰ìW‹kQueue
(
KvdoW‹kQueue
 **
queuePå
);

264 
	`dumpW‹kQueue
(
KvdoW‹kQueue
 *
queue
);

275 
	`dumpW‹kIãmToBuf„r
(
KvdoW‹kIãm
 *
ôem
, *
buf„r
, 
size_t
 
Àngth
);

281 
	`öôW‹kQueueOn˚
();

291 
ölöe
 
boﬁ
 
	$¨eW‹kIãmA˘i⁄sEquÆ
(
KvdoW‹kIãm
 *
ôem1
,

292 
KvdoW‹kIãm
 *
ôem2
)

294  
ôem1
->
a˘i⁄
 =
ôem2
->action;

295 
	}
}

303 *
gëW‹kQueuePriv©eD©a
();

310 
£tW‹kQueuePriv©eD©a
(*
√wD©a
);

317 
KvdoW‹kQueue
 *
gëCuºítW‹kQueue
();

	@vdo/kernel/workQueueHandle.c

22 
	~"w‹kQueueH™dÀ.h
"

24 
W‹kQueueSèckH™dÀGlobÆs
 
	gw‹kQueueSèckH™dÀGlobÆs
;

27 
	$öôülizeW‹kQueueSèckH™dÀ
(
W‹kQueueSèckH™dÀ
 *
h™dÀ
,

28 
Sim∂eW‹kQueue
 *
queue
)

30 
h™dÀ
->
n⁄˚
 = 
w‹kQueueSèckH™dÀGlobÆs
.nonce;

31 
h™dÀ
->
queue
 = queue;

33 
off£t
 = (*Ë
h™dÀ
 - (*Ë
	`cuºít_thªad_öfo
();

34 
	`•ö_lock
(&
w‹kQueueSèckH™dÀGlobÆs
.
off£tLock
);

35 i‡(
w‹kQueueSèckH™dÀGlobÆs
.
off£t
 == 0) {

36 
w‹kQueueSèckH™dÀGlobÆs
.
off£t
 = offset;

37 
	`•ö_u∆ock
(&
w‹kQueueSèckH™dÀGlobÆs
.
off£tLock
);

39 
foundOff£t
 = 
w‹kQueueSèckH™dÀGlobÆs
.
off£t
;

40 
	`•ö_u∆ock
(&
w‹kQueueSèckH™dÀGlobÆs
.
off£tLock
);

41 
	`BUG_ON
(
foundOff£t
 !
off£t
);

43 
	}
}

46 
	$öôW‹kQueueSèckH™dÀOn˚
()

48 
	`•ö_lock_öô
(&
w‹kQueueSèckH™dÀGlobÆs
.
off£tLock
);

49 
w‹kQueueSèckH™dÀGlobÆs
.
n⁄˚
 = 
	`cuºítTime
(
CT_MONOTONIC
);

50 
	}
}

	@vdo/kernel/workQueueHandle.h

22 #i‚de‡
WORK_QUEUE_HANDLE_H


23 
	#WORK_QUEUE_HANDLE_H


	)

25 
	~"w‹kQueueI¡î«ls.h
"

31 
	sw‹kQueueSèckH™dÀ
 {

32 
	mn⁄˚
;

33 
Sim∂eW‹kQueue
 *
	mqueue
;

34 } 
	tW‹kQueueSèckH™dÀ
;

36 
	sw‹kQueueSèckH™dÀGlobÆs
 {

41 
	moff£t
;

46 
•ölock_t
 
	moff£tLock
;

53 
	mn⁄˚
;

54 } 
	tW‹kQueueSèckH™dÀGlobÆs
;

56 
W‹kQueueSèckH™dÀGlobÆs
 
w‹kQueueSèckH™dÀGlobÆs
;

64 
öôülizeW‹kQueueSèckH™dÀ
(
W‹kQueueSèckH™dÀ
 *
h™dÀ
,

65 
Sim∂eW‹kQueue
 *
queue
);

74 
ölöe
 
Sim∂eW‹kQueue
 *
	$gëCuºítThªadW‹kQueue
()

76 
W‹kQueueSèckH™dÀ
 *
h™dÀ


77 (
W‹kQueueSèckH™dÀ
 *)((*)
	`cuºít_thªad_öfo
()

78 + 
w‹kQueueSèckH™dÀGlobÆs
.
off£t
);

79 i‡(
	`likñy
(
h™dÀ
->
n⁄˚
 =
w‹kQueueSèckH™dÀGlobÆs
.nonce)) {

80  
h™dÀ
->
queue
;

82  
NULL
;

84 
	}
}

90 
öôW‹kQueueSèckH™dÀOn˚
();

	@vdo/kernel/workQueueInternals.h

22 #i‚de‡
WORK_QUEUE_INTERNALS_H


23 
	#WORK_QUEUE_INTERNALS_H


	)

25 
	~<löux/com∂ëi⁄.h
>

26 
	~<löux/kobje˘.h
>

27 
	~<löux/li°.h
>

28 
	~<löux/•ölock.h
>

29 
	~<löux/waô.h
>

31 
	~"timî.h
"

32 
	~"w‹kIãmSèts.h
"

33 
	~"w‹kQueueSèts.h
"

35 
	skvdoW‹kIãmLi°
 {

36 
KvdoW‹kIãm
 *
	mèû
;

37 } 
	tKvdoW‹kIãmLi°
;

48 
	skvdoW‹kQueue
 {

50 *
	m«me
;

55 
boﬁ
 
	mroundRoböMode
;

57 
kobje˘
 
	mkobj
;

60 
sim∂eW‹kQueue
 
	tSim∂eW‹kQueue
;

61 
roundRoböW‹kQueue
 
	tRoundRoböW‹kQueue
;

63 
	ssim∂eW‹kQueue
 {

65 
KvdoW‹kQueue
 
	mcomm⁄
;

67 
boﬁ
 
	mtimeoutSuµ‹t
;

69 
©omic_t
 
	mthªadID
;

74 
	mnumPri‹ôyLi°s
;

81 
uöt8_t
 
	m¥i‹ôyM≠
[
WORK_QUEUE_ACTION_COUNT
];

83 
Fu¬ñQueue
 *
	m¥i‹ôyLi°s
[
WORK_QUEUE_PRIORITY_COUNT
];

85 
èsk_°ru˘
 *
	mthªad
;

87 c⁄° 
KvdoW‹kQueueTy≥
 *
	mty≥
;

89 *
	m¥iv©e
;

91 
KvdoW‹kQueue
 *
	m∑ª¡Queue
;

93 
	m∑d
[
CACHE_LINE_BYTES
 - (
KvdoW‹kQueue
 *)];

101 
•ölock_t
 
	mc⁄sumîLock
;

103 
•ölock_t
 
	mlock
;

105 
waô_queue_hód_t
 
	mwaôögW‹kîThªads
;

113 
©omic_t
 
	midÀ
;

115 
waô_queue_hód_t
 
	m°¨tWaôîs
;

117 
©omic_t
 
	m°¨ãd
;

120 
KvdoW‹kIãmLi°
 
	mdñayedIãms
;

129 
timî_li°
 
	mdñayedIãmsTimî
;

142 
Timî
 
	mtimeoutTimî
;

170 
©omic64_t
 
	mfú°Wakeup
;

172 
	m∑d2
[
CACHE_LINE_BYTES
 - (
©omic64_t
)];

174 
KvdoW‹kQueueSèts
 
	m°©s
;

176 
uöt64_t
 
	mmo°Re˚¡Wakeup
;

179 
	sroundRoböW‹kQueue
 {

181 
KvdoW‹kQueue
 
	mcomm⁄
;

183 
Sim∂eW‹kQueue
 **
	m£rvi˚Queues
;

185 
	mnumSîvi˚Queues
;

187 
	m∑d
[
CACHE_LINE_BYTES
 - ()];

196 
	m£rvi˚QueueRŸ‹
;

199 
ölöe
 
Sim∂eW‹kQueue
 *
	$asSim∂eW‹kQueue
(
KvdoW‹kQueue
 *
queue
)

201  ((
queue
 =
NULL
)

202 ? 
NULL


203 : 
	`c⁄èöî_of
(
queue
, 
Sim∂eW‹kQueue
, 
comm⁄
));

204 
	}
}

206 
ölöe
 c⁄° 
Sim∂eW‹kQueue
 *

207 
	$asC⁄°Sim∂eW‹kQueue
(c⁄° 
KvdoW‹kQueue
 *
queue
)

209  ((
queue
 =
NULL
)

210 ? 
NULL


211 : 
	`c⁄èöî_of
(
queue
, 
Sim∂eW‹kQueue
, 
comm⁄
));

212 
	}
}

214 
ölöe
 
RoundRoböW‹kQueue
 *
	$asRoundRoböW‹kQueue
(
KvdoW‹kQueue
 *
queue
)

216  ((
queue
 =
NULL
)

217 ? 
NULL


218 : 
	`c⁄èöî_of
(
queue
, 
RoundRoböW‹kQueue
, 
comm⁄
));

219 
	}
}

	@vdo/kernel/workQueueStats.c

22 
	~"w‹kQueueSèts.h
"

24 
	~"loggî.h
"

25 
	~"w‹kIãmSèts.h
"

26 
	~"w‹kQueueI¡î«ls.h
"

29 
	$öôülizeW‹kQueueSèts
(
KvdoW‹kQueueSèts
 *
°©s
,

30 
kobje˘
 *
queueKObje˘
)

32 
	`•ö_lock_öô
(&
°©s
->
w‹kIãmSèts
.
fun˘i⁄TabÀ
.
lock
);

33 i‡(
ENABLE_PER_FUNCTION_TIMING_STATS
) {

34 
i
 = 0; i < 
NUM_WORK_QUEUE_ITEM_STATS
 + 1; i++) {

35 
	`öôSim∂eSèts
(&
°©s
->
w‹kIãmSèts
.
times
[
i
]);

39 
°©s
->
queueTimeHi°ogøm


40 
	`makeLog¨ôhmicHi°ogøm
(
queueKObje˘
, "queue_time",

43 i‡(
°©s
->
queueTimeHi°ogøm
 =
NULL
) {

44  -
ENOMEM
;

47 
°©s
->
ªscheduÀQueueLígthHi°ogøm


48 
	`makeLog¨ôhmicHi°ogøm
(
queueKObje˘
, "reschedule_queue_length",

50 "queued w‹k iãms", 
NULL
, 4);

51 i‡(
°©s
->
ªscheduÀQueueLígthHi°ogøm
 =
NULL
) {

52  -
ENOMEM
;

55 
°©s
->
ªscheduÀTimeHi°ogøm


56 
	`makeLog¨ôhmicHi°ogøm
(
queueKObje˘
, "reschedule_time",

59 i‡(
°©s
->
ªscheduÀTimeHi°ogøm
 =
NULL
) {

60  -
ENOMEM
;

63 
°©s
->
runTimeBef‹eRescheduÀHi°ogøm


64 
	`makeLog¨ôhmicHi°ogøm
(
queueKObje˘
, "run_time_before_reschedule",

67 i‡(
°©s
->
runTimeBef‹eRescheduÀHi°ogøm
 =
NULL
) {

68  -
ENOMEM
;

71 
°©s
->
scheduÀTimeHi°ogøm


72 
	`makeLog¨ôhmicHi°ogøm
(
queueKObje˘
, "schedule_time",

75 i‡(
°©s
->
scheduÀTimeHi°ogøm
 =
NULL
) {

76  -
ENOMEM
;

79 
°©s
->
wakeupL©ícyHi°ogøm


80 
	`makeLog¨ôhmicHi°ogøm
(
queueKObje˘
, "wakeup_latency",

83 i‡(
°©s
->
wakeupL©ícyHi°ogøm
 =
NULL
) {

84  -
ENOMEM
;

87 
°©s
->
wakeupQueueLígthHi°ogøm


88 
	`makeLog¨ôhmicHi°ogøm
(
queueKObje˘
, "wakeup_queue_length",

90 "queued w‹k iãms", 
NULL
, 4);

91 i‡(
°©s
->
ªscheduÀQueueLígthHi°ogøm
 =
NULL
) {

92  -
ENOMEM
;

96 
	}
}

99 
	$˛ónupW‹kQueueSèts
(
KvdoW‹kQueueSèts
 *
°©s
)

101 
	`‰ìHi°ogøm
(&
°©s
->
queueTimeHi°ogøm
);

102 
	`‰ìHi°ogøm
(&
°©s
->
ªscheduÀQueueLígthHi°ogøm
);

103 
	`‰ìHi°ogøm
(&
°©s
->
ªscheduÀTimeHi°ogøm
);

104 
	`‰ìHi°ogøm
(&
°©s
->
runTimeBef‹eRescheduÀHi°ogøm
);

105 
	`‰ìHi°ogøm
(&
°©s
->
scheduÀTimeHi°ogøm
);

106 
	`‰ìHi°ogøm
(&
°©s
->
wakeupL©ícyHi°ogøm
);

107 
	`‰ìHi°ogøm
(&
°©s
->
wakeupQueueLígthHi°ogøm
);

108 
	}
}

111 
uöt64_t
 
	$gëTŸÆPro˚s£d
(c⁄° 
Sim∂eW‹kQueue
 *
queue
)

113 
uöt64_t
 
tŸÆPro˚s£d
 = 0;

114 
i
 = 0; i < 
NUM_WORK_QUEUE_ITEM_STATS
 + 1; i++) {

115 
tŸÆPro˚s£d
 +
queue
->
°©s
.
w‹kIãmSèts
.
times
[
i
].
cou¡
;

117  
tŸÆPro˚s£d
;

118 
	}
}

121 
	$logW‹kQueueSèts
(c⁄° 
Sim∂eW‹kQueue
 *
queue
)

123 
uöt64_t
 
ru¡imeNS
 = 0;

124 i‡(
queue
->
thªad
 !
NULL
) {

125 
ru¡imeNS
 +
queue
->
thªad
->
£
.
sum_exec_ru¡ime
;

128 
nsPîW‹kIãm
 = 0;

129 
uöt64_t
 
tŸÆPro˚s£d
 = 
	`gëTŸÆPro˚s£d
(
queue
);

130 i‡(
tŸÆPro˚s£d
 > 0) {

131 
nsPîW‹kIãm
 = 
ru¡imeNS
 / 
tŸÆPro˚s£d
;

133 
ru¡imeMS
 = 
ru¡imeNS
 / 1000;

134 
	`logInfo
("w‹kQ %∞(%sËthªad cpu ußgê%lu.%06lus, %" 
PRIu64


136 
queue
,

137 
queue
->
comm⁄
.
«me
,

138 
ru¡imeMS
 / 1000000,ÑuntimeMS % 1000000,

139 
tŸÆPro˚s£d
,

140 
nsPîW‹kIãm
 / 1000,ÇsPerWorkItem % 1000);

141 
	}
}

144 
ssize_t
 
	$f‹m©RunTimeSèts
(c⁄° 
KvdoW‹kQueueSèts
 *
°©s
, *
buf„r
)

147 
uöt64_t
 
°¨tTime
 = 
°©s
->startTime;

148 
uöt64_t
 
runTime
 = 
	`©omic64_ªad
(&
°©s
->runTime);

149 
uöt64_t
 
ªscheduÀTime
 = 
	`©omic64_ªad
(&
°©s
->rescheduleTime);

150 
	`lﬂdFí˚
();

151 
uöt64_t
 
now
 = 
	`cuºítTime
(
CT_MONOTONIC
);

152 
uöt64_t
 
li„time
 = 
now
 - 
°¨tTime
;

154  
	`•rötf
(
buf„r
,

155 "%" 
PRIu64
 " %" PRIu64 " %" PRIu64 "\n",

156 
li„time
, 
runTime
, 
ªscheduÀTime
);

157 
	}
}

	@vdo/kernel/workQueueStats.h

22 #i‚de‡
WORK_QUEUE_STATS_H


23 
	#WORK_QUEUE_STATS_H


	)

25 
	~"w‹kQueue.h
"

27 
	~"timeUtûs.h
"

29 
	~"hi°ogøm.h
"

30 
	~"w‹kIãmSèts.h
"

33 
	gsim∂eW‹kQueue
;

47 
	skvdoW‹kQueueSèts
 {

49 
KvdoW‹kIãmSèts
 
	mw‹kIãmSèts
;

51 
uöt64_t
 
	mwaôs
;

56 
uöt64_t
 
	m°¨tTime
;

67 
©omic64_t
 
	mrunTime
;

70 
©omic64_t
 
	mªscheduÀTime
;

73 
Hi°ogøm
 *
	mqueueTimeHi°ogøm
;

75 
Hi°ogøm
 *
	mªscheduÀQueueLígthHi°ogøm
;

77 
Hi°ogøm
 *
	mªscheduÀTimeHi°ogøm
;

79 
Hi°ogøm
 *
	mrunTimeBef‹eRescheduÀHi°ogøm
;

81 
Hi°ogøm
 *
	mscheduÀTimeHi°ogøm
;

83 
Hi°ogøm
 *
	mwakeupL©ícyHi°ogøm
;

85 
Hi°ogøm
 *
	mwakeupQueueLígthHi°ogøm
;

86 } 
	tKvdoW‹kQueueSèts
;

96 
	$öôülizeW‹kQueueSèts
(
KvdoW‹kQueueSèts
 *
°©s
,

97 
kobje˘
 *
queueKObje˘
)

98 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
));

105 
	`˛ónupW‹kQueueSèts
(
KvdoW‹kQueueSèts
 *
°©s
);

115 
ölöe
 
	$upd©eSètsF‹Enqueue
(
KvdoW‹kQueueSèts
 *
°©s
,

116 
KvdoW‹kIãm
 *
ôem
,

117 
¥i‹ôy
)

119 
	`upd©eW‹kIãmSètsF‹Enqueue
(&
°©s
->
w‹kIãmSèts
, 
ôem
, 
¥i‹ôy
);

120 
ôem
->
íqueueTime
 = 
	`cuºítTime
(
CT_MONOTONIC
);

121 
	}
}

130 
ölöe
 
	$upd©eSètsF‹Dequeue
(
KvdoW‹kQueueSèts
 *
°©s
,

131 
KvdoW‹kIãm
 *
ôem
)

133 
	`upd©eW‹kIãmSètsF‹Dequeue
(&
°©s
->
w‹kIãmSèts
, 
ôem
);

134 
	`íãrHi°ogømSam∂e
(
°©s
->
queueTimeHi°ogøm
,

135 (
	`cuºítTime
(
CT_MONOTONIC
Ë- 
ôem
->
íqueueTime
) / 1000);

136 
ôem
->
íqueueTime
 = 0;

137 
	}
}

147 
logW‹kQueueSèts
(c⁄° 
sim∂eW‹kQueue
 *
queue
);

156 
ssize_t
 
f‹m©RunTimeSèts
(c⁄° 
KvdoW‹kQueueSèts
 *
°©s
, *
buf„r
);

	@vdo/kernel/workQueueSysfs.c

22 
	~"w‹kQueueSysfs.h
"

24 
	~<löux/kobje˘.h
>

26 
	~"loggî.h
"

27 
	~"mem‹yAŒoc.h
"

29 
	~"w‹kQueueI¡î«ls.h
"

31 
	sw‹kQueueAâribuã
 {

32 
©åibuã
 
	m©å
;

33 
ssize_t
 (*
show
)(c⁄° 
KvdoW‹kQueue
 *
	mqueue
, *
	mbuf
);

34 
ssize_t
 (*
°‹e
)(
KvdoW‹kQueue
 *
	mqueue
, c⁄° *
	mbuf
, 
size_t
 
	mÀngth
);

35 } 
	tW‹kQueueAâribuã
;

38 
ssize_t
 
	$«meShow
(c⁄° 
KvdoW‹kQueue
 *
queue
, *
buf
)

40  
	`•rötf
(
buf
, "%s\n", 
queue
->
«me
);

41 
	}
}

44 
ssize_t
 
	$pidShow
(c⁄° 
KvdoW‹kQueue
 *
queue
, *
buf
)

46  
	`•rötf
(
buf
, "%ld\n",

47 (Ë
	`©omic_ªad
(&
	`asC⁄°Sim∂eW‹kQueue
(
queue
)->
thªadID
));

48 
	}
}

51 
ssize_t
 
	$timesShow
(c⁄° 
KvdoW‹kQueue
 *
queue
, *
buf
)

53  
	`f‹m©RunTimeSèts
(&
	`asC⁄°Sim∂eW‹kQueue
(
queue
)->
°©s
, 
buf
);

54 
	}
}

57 
ssize_t
 
	$ty≥Show
(c⁄° 
KvdoW‹kQueue
 *
queue
, *
buf
)

59 
	`°r˝y
(
buf
, 
queue
->
roundRoböMode
 ? "round-robin\n" : "simple\n");

60  
	`°æí
(
buf
);

61 
	}
}

64 
ssize_t
 
	$w‹kFun˘i⁄sShow
(c⁄° 
KvdoW‹kQueue
 *
queue
, *
buf
)

66 c⁄° 
Sim∂eW‹kQueue
 *
sim∂eQueue
 = 
	`asC⁄°Sim∂eW‹kQueue
(
queue
);

67  
	`f‹m©W‹kIãmSèts
(&
sim∂eQueue
->
°©s
.
w‹kIãmSèts
, 
buf
,

68 
PAGE_SIZE
);

69 
	}
}

72 
W‹kQueueAâribuã
 
	g«meAâr
 = {

73 .
©å
 = { .
«me
 = "«me", .
	gmode
 = 0444, },

74 .
	gshow
 = 
«meShow
,

78 
W‹kQueueAâribuã
 
	gpidAâr
 = {

79 .
©å
 = { .
«me
 = "pid", .
	gmode
 = 0444, },

80 .
	gshow
 = 
pidShow
,

84 
W‹kQueueAâribuã
 
	gtimesAâr
 = {

85 .
©å
 = { .
«me
 = "times", .
	gmode
 = 0444 },

86 .
	gshow
 = 
timesShow
,

90 
W‹kQueueAâribuã
 
	gty≥Aâr
 = {

91 .
©å
 = { .
«me
 = "ty≥", .
	gmode
 = 0444, },

92 .
	gshow
 = 
ty≥Show
,

96 
W‹kQueueAâribuã
 
	gw‹kFun˘i⁄sAâr
 = {

97 .
©å
 = { .
«me
 = "w‹k_fun˘i⁄s", .
	gmode
 = 0444, },

98 .
	gshow
 = 
w‹kFun˘i⁄sShow
,

102 
©åibuã
 *
	gsim∂eW‹kQueueAârs
[] = {

103 &
«meAâr
.
©å
,

104 &
pidAâr
.
©å
,

105 &
timesAâr
.
©å
,

106 &
ty≥Aâr
.
©å
,

107 &
w‹kFun˘i⁄sAâr
.
©å
,

108 
NULL
,

112 
©åibuã
 *
	groundRoböW‹kQueueAârs
[] = {

113 &
«meAâr
.
©å
,

114 &
ty≥Aâr
.
©å
,

115 
NULL
,

119 
ssize_t
 
	$w‹kQueueAârShow
(
kobje˘
 *
kobj
,

120 
©åibuã
 *
©å
,

121 *
buf
)

123 
W‹kQueueAâribuã
 *
wqAâr
 = 
	`c⁄èöî_of
(
©å
, WorkQueueAttribute,áttr);

124 i‡(
wqAâr
->
show
 =
NULL
) {

125  -
EINVAL
;

127 
KvdoW‹kQueue
 *
queue
 = 
	`c⁄èöî_of
(
kobj
, KvdoWorkQueue, kobj);

128  
wqAâr
->
	`show
(
queue
, 
buf
);

129 
	}
}

132 
ssize_t
 
	$w‹kQueueAârSt‹e
(
kobje˘
 *
kobj
,

133 
©åibuã
 *
©å
,

134 c⁄° *
buf
,

135 
size_t
 
Àngth
)

137 
W‹kQueueAâribuã
 *
wqAâr
 = 
	`c⁄èöî_of
(
©å
, WorkQueueAttribute,áttr);

138 i‡(
wqAâr
->
°‹e
 =
NULL
) {

139  -
EINVAL
;

141 
KvdoW‹kQueue
 *
queue
 = 
	`c⁄èöî_of
(
kobj
, KvdoWorkQueue, kobj);

142  
wqAâr
->
	`°‹e
(
queue
, 
buf
, 
Àngth
);

143 
	}
}

146 
sysfs_›s
 
	gw‹kQueueSysfsOps
 = {

147 .
show
 = 
w‹kQueueAârShow
,

148 .
	g°‹e
 = 
w‹kQueueAârSt‹e
,

152 
	$w‹kQueueRñó£
(
kobje˘
 *
kobj
)

154 
KvdoW‹kQueue
 *
queue
 = 
	`c⁄èöî_of
(
kobj
, KvdoWorkQueue, kobj);

155 
	`FREE
(
queue
->
«me
);

156 i‡(
queue
->
roundRoböMode
) {

157 
	`FREE
(
	`asRoundRoböW‹kQueue
(
queue
));

159 
	`FREE
(
	`asSim∂eW‹kQueue
(
queue
));

161 
	}
}

164 
kobj_ty≥
 
	gsim∂eW‹kQueueKobjTy≥
 = {

165 .
deÁu…_©ås
 = 
sim∂eW‹kQueueAârs
,

166 .
	gªÀa£
 = 
w‹kQueueRñó£
,

167 .
	gsysfs_›s
 = &
w‹kQueueSysfsOps
,

171 
kobj_ty≥
 
	groundRoböW‹kQueueKobjTy≥
 = {

172 .
deÁu…_©ås
 = 
roundRoböW‹kQueueAârs
,

173 .
	gªÀa£
 = 
w‹kQueueRñó£
,

174 .
	gsysfs_›s
 = &
w‹kQueueSysfsOps
,

	@vdo/kernel/workQueueSysfs.h

22 #i‚de‡
WORK_QUEUE_SYSFS_H


23 
	#WORK_QUEUE_SYSFS_H


	)

25 
	~<löux/kobje˘.h
>

27 
kobj_ty≥
 
roundRoböW‹kQueueKobjTy≥
;

28 
kobj_ty≥
 
sim∂eW‹kQueueKobjTy≥
;

	@vdo/kvdo.mod.c

1 
	~<löux/moduÀ.h
>

2 
	~<löux/vîmagic.h
>

3 
	~<löux/compûî.h
>

5 
MODULE_INFO
(
vîmagic
, 
VERMAGIC_STRING
);

6 
MODULE_INFO
(
«me
, 
KBUILD_MODNAME
);

8 
__visibÀ
 
moduÀ
 
__this_moduÀ


9 
__©åibuã__
((
£˘i⁄
(".gnu.linkonce.this_module"))) = {

10 .
«me
 = 
KBUILD_MODNAME
,

11 .
	göô
 = 
öô_moduÀ
,

12 #ifde‡
CONFIG_MODULE_UNLOAD


13 .
	gexô
 = 
˛ónup_moduÀ
,

15 .
	g¨ch
 = 
MODULE_ARCH_INIT
,

18 c⁄° 
	g__moduÀ_dïíds
[]

19 
__u£d


20 
__©åibuã__
((
£˘i⁄
(".modinfo"))) =

24 
MODULE_INFO
(
§cvîsi⁄
, "9B0022AC6042C84B15465B1");

	@/usr/include/asm/byteorder.h

1 #i‚de‡
_ASM_X86_BYTEORDER_H


2 
	#_ASM_X86_BYTEORDER_H


	)

4 
	~<löux/byã‹dî/lôée_ídün.h
>

	@/usr/include/endian.h

18 #i‚def 
_ENDIAN_H


19 
	#_ENDIAN_H
 1

	)

21 
	~<„©uªs.h
>

31 
	#__LITTLE_ENDIAN
 1234

	)

32 
	#__BIG_ENDIAN
 4321

	)

33 
	#__PDP_ENDIAN
 3412

	)

36 
	~<bôs/ídün.h
>

40 #i‚de‡
__FLOAT_WORD_ORDER


41 
	#__FLOAT_WORD_ORDER
 
__BYTE_ORDER


	)

44 #ifdef 
__USE_MISC


45 
	#LITTLE_ENDIAN
 
__LITTLE_ENDIAN


	)

46 
	#BIG_ENDIAN
 
__BIG_ENDIAN


	)

47 
	#PDP_ENDIAN
 
__PDP_ENDIAN


	)

48 
	#BYTE_ORDER
 
__BYTE_ORDER


	)

51 #i‡
__BYTE_ORDER
 =
__LITTLE_ENDIAN


52 
	#__LONG_LONG_PAIR
(
HI
, 
LO
ËLO, 
	)
HI

53 #ñi‡
__BYTE_ORDER
 =
__BIG_ENDIAN


54 
	#__LONG_LONG_PAIR
(
HI
, 
LO
ËHI, 
	)
LO

58 #i‡
deföed
 
__USE_MISC
 && !deföed 
__ASSEMBLER__


60 
	~<bôs/byãsw≠.h
>

61 
	~<bôs/uöä-idítôy.h
>

63 #i‡
__BYTE_ORDER
 =
__LITTLE_ENDIAN


64 
	#htobe16
(
x
Ë
	`__bsw≠_16
 (x)

	)

65 
	#htﬁe16
(
x
Ë
	`__uöt16_idítôy
 (x)

	)

66 
	#be16toh
(
x
Ë
	`__bsw≠_16
 (x)

	)

67 
	#À16toh
(
x
Ë
	`__uöt16_idítôy
 (x)

	)

69 
	#htobe32
(
x
Ë
	`__bsw≠_32
 (x)

	)

70 
	#htﬁe32
(
x
Ë
	`__uöt32_idítôy
 (x)

	)

71 
	#be32toh
(
x
Ë
	`__bsw≠_32
 (x)

	)

72 
	#À32toh
(
x
Ë
	`__uöt32_idítôy
 (x)

	)

74 
	#htobe64
(
x
Ë
	`__bsw≠_64
 (x)

	)

75 
	#htﬁe64
(
x
Ë
	`__uöt64_idítôy
 (x)

	)

76 
	#be64toh
(
x
Ë
	`__bsw≠_64
 (x)

	)

77 
	#À64toh
(
x
Ë
	`__uöt64_idítôy
 (x)

	)

80 
	#htobe16
(
x
Ë
	`__uöt16_idítôy
 (x)

	)

81 
	#htﬁe16
(
x
Ë
	`__bsw≠_16
 (x)

	)

82 
	#be16toh
(
x
Ë
	`__uöt16_idítôy
 (x)

	)

83 
	#À16toh
(
x
Ë
	`__bsw≠_16
 (x)

	)

85 
	#htobe32
(
x
Ë
	`__uöt32_idítôy
 (x)

	)

86 
	#htﬁe32
(
x
Ë
	`__bsw≠_32
 (x)

	)

87 
	#be32toh
(
x
Ë
	`__uöt32_idítôy
 (x)

	)

88 
	#À32toh
(
x
Ë
	`__bsw≠_32
 (x)

	)

90 
	#htobe64
(
x
Ë
	`__uöt64_idítôy
 (x)

	)

91 
	#htﬁe64
(
x
Ë
	`__bsw≠_64
 (x)

	)

92 
	#be64toh
(
x
Ë
	`__uöt64_idítôy
 (x)

	)

93 
	#À64toh
(
x
Ë
	`__bsw≠_64
 (x)

	)

	@/usr/include/linux/errno.h

1 
	~<asm/î∫o.h
>

	@/usr/include/linux/fs.h

1 #i‚de‡
_LINUX_FS_H


2 
	#_LINUX_FS_H


	)

12 
	~<löux/limôs.h
>

13 
	~<löux/io˘l.h
>

14 
	~<löux/ty≥s.h
>

27 #unde‡
NR_OPEN


28 
	#INR_OPEN_CUR
 1024

	)

29 
	#INR_OPEN_MAX
 4096

	)

31 
	#BLOCK_SIZE_BITS
 10

	)

32 
	#BLOCK_SIZE
 (1<<
BLOCK_SIZE_BITS
)

	)

34 
	#SEEK_SET
 0

	)

35 
	#SEEK_CUR
 1

	)

36 
	#SEEK_END
 2

	)

37 
	#SEEK_DATA
 3

	)

38 
	#SEEK_HOLE
 4

	)

39 
	#SEEK_MAX
 
SEEK_HOLE


	)

41 
	#RENAME_NOREPLACE
 (1 << 0Ë

	)

42 
	#RENAME_EXCHANGE
 (1 << 1Ë

	)

43 
	#RENAME_WHITEOUT
 (1 << 2Ë

	)

45 
	sfûe_˛⁄e_ønge
 {

46 
__s64
 
	m§c_fd
;

47 
__u64
 
	m§c_off£t
;

48 
__u64
 
	m§c_Àngth
;

49 
__u64
 
	mde°_off£t
;

52 
	sf°rim_ønge
 {

53 
__u64
 
	m°¨t
;

54 
__u64
 
	mÀn
;

55 
__u64
 
	mmöÀn
;

59 
	#FILE_DEDUPE_RANGE_SAME
 0

	)

60 
	#FILE_DEDUPE_RANGE_DIFFERS
 1

	)

63 
	sfûe_dedu≥_ønge_öfo
 {

64 
__s64
 
	mde°_fd
;

65 
__u64
 
	mde°_off£t
;

66 
__u64
 
	mbyãs_dedu≥d
;

73 
__s32
 
	m°©us
;

74 
__u32
 
	mª£rved
;

78 
	sfûe_dedu≥_ønge
 {

79 
__u64
 
	m§c_off£t
;

80 
__u64
 
	m§c_Àngth
;

81 
__u16
 
	mde°_cou¡
;

82 
__u16
 
	mª£rved1
;

83 
__u32
 
	mª£rved2
;

84 
fûe_dedu≥_ønge_öfo
 
	möfo
[0];

88 
	sfûes_°©_°ru˘
 {

89 
	mƒ_fûes
;

90 
	mƒ_‰ì_fûes
;

91 
	mmax_fûes
;

94 
	söodes_°©_t
 {

95 
	mƒ_öodes
;

96 
	mƒ_unu£d
;

97 
	mdummy
[5];

101 
	#NR_FILE
 8192

	)

107 
	#MS_RDONLY
 1

	)

108 
	#MS_NOSUID
 2

	)

109 
	#MS_NODEV
 4

	)

110 
	#MS_NOEXEC
 8

	)

111 
	#MS_SYNCHRONOUS
 16

	)

112 
	#MS_REMOUNT
 32

	)

113 
	#MS_MANDLOCK
 64

	)

114 
	#MS_DIRSYNC
 128

	)

115 
	#MS_NOATIME
 1024

	)

116 
	#MS_NODIRATIME
 2048

	)

117 
	#MS_BIND
 4096

	)

118 
	#MS_MOVE
 8192

	)

119 
	#MS_REC
 16384

	)

120 
	#MS_VERBOSE
 32768

	)

122 
	#MS_SILENT
 32768

	)

123 
	#MS_POSIXACL
 (1<<16Ë

	)

124 
	#MS_UNBINDABLE
 (1<<17Ë

	)

125 
	#MS_PRIVATE
 (1<<18Ë

	)

126 
	#MS_SLAVE
 (1<<19Ë

	)

127 
	#MS_SHARED
 (1<<20Ë

	)

128 
	#MS_RELATIME
 (1<<21Ë

	)

129 
	#MS_KERNMOUNT
 (1<<22Ë

	)

130 
	#MS_I_VERSION
 (1<<23Ë

	)

131 
	#MS_STRICTATIME
 (1<<24Ë

	)

132 
	#MS_LAZYTIME
 (1<<25Ë

	)

135 
	#MS_SUBMOUNT
 (1<<26)

	)

136 
	#MS_NOREMOTELOCK
 (1<<27)

	)

137 
	#MS_NOSEC
 (1<<28)

	)

138 
	#MS_BORN
 (1<<29)

	)

139 
	#MS_ACTIVE
 (1<<30)

	)

140 
	#MS_NOUSER
 (1<<31)

	)

145 
	#MS_RMT_MASK
 (
MS_RDONLY
|
MS_SYNCHRONOUS
|
MS_MANDLOCK
|
MS_I_VERSION
|\

146 
MS_LAZYTIME
)

	)

151 
	#MS_MGC_VAL
 0xC0ED0000

	)

152 
	#MS_MGC_MSK
 0xffff0000

	)

157 
	sfsx©å
 {

158 
__u32
 
	mfsx_xÊags
;

159 
__u32
 
	mfsx_extsize
;

160 
__u32
 
	mfsx_√xã¡s
;

161 
__u32
 
	mfsx_¥ojid
;

162 
__u32
 
	mfsx_cowextsize
;

163 
	mfsx_∑d
[8];

169 
	#FS_XFLAG_REALTIME
 0x00000001

	)

170 
	#FS_XFLAG_PREALLOC
 0x00000002

	)

171 
	#FS_XFLAG_IMMUTABLE
 0x00000008

	)

172 
	#FS_XFLAG_APPEND
 0x00000010

	)

173 
	#FS_XFLAG_SYNC
 0x00000020

	)

174 
	#FS_XFLAG_NOATIME
 0x00000040

	)

175 
	#FS_XFLAG_NODUMP
 0x00000080

	)

176 
	#FS_XFLAG_RTINHERIT
 0x00000100

	)

177 
	#FS_XFLAG_PROJINHERIT
 0x00000200

	)

178 
	#FS_XFLAG_NOSYMLINKS
 0x00000400

	)

179 
	#FS_XFLAG_EXTSIZE
 0x00000800

	)

180 
	#FS_XFLAG_EXTSZINHERIT
 0x00001000

	)

181 
	#FS_XFLAG_NODEFRAG
 0x00002000

	)

182 
	#FS_XFLAG_FILESTREAM
 0x00004000

	)

183 
	#FS_XFLAG_DAX
 0x00008000

	)

184 
	#FS_XFLAG_COWEXTSIZE
 0x00010000

	)

185 
	#FS_XFLAG_HASATTR
 0x80000000

	)

190 
	#BLKROSET
 
	`_IO
(0x12,93Ë

	)

191 
	#BLKROGET
 
	`_IO
(0x12,94Ë

	)

192 
	#BLKRRPART
 
	`_IO
(0x12,95Ë

	)

193 
	#BLKGETSIZE
 
	`_IO
(0x12,96Ë

	)

194 
	#BLKFLSBUF
 
	`_IO
(0x12,97Ë

	)

195 
	#BLKRASET
 
	`_IO
(0x12,98Ë

	)

196 
	#BLKRAGET
 
	`_IO
(0x12,99Ë

	)

197 
	#BLKFRASET
 
	`_IO
(0x12,100)

	)

198 
	#BLKFRAGET
 
	`_IO
(0x12,101)

	)

199 
	#BLKSECTSET
 
	`_IO
(0x12,102)

	)

200 
	#BLKSECTGET
 
	`_IO
(0x12,103)

	)

201 
	#BLKSSZGET
 
	`_IO
(0x12,104)

	)

203 
	#BLKPG
 
	`_IO
(0x12,105)

	)

207 
	#BLKELVGET
 
	`_IOR
(0x12,106,
size_t
)

	)

208 
	#BLKELVSET
 
	`_IOW
(0x12,107,
size_t
)

	)

213 
	#BLKBSZGET
 
	`_IOR
(0x12,112,
size_t
)

	)

214 
	#BLKBSZSET
 
	`_IOW
(0x12,113,
size_t
)

	)

215 
	#BLKGETSIZE64
 
	`_IOR
(0x12,114,
size_t
Ë

	)

216 
	#BLKTRACESETUP
 
	`_IOWR
(0x12,115,
blk_u£r_åa˚_£tup
)

	)

217 
	#BLKTRACESTART
 
	`_IO
(0x12,116)

	)

218 
	#BLKTRACESTOP
 
	`_IO
(0x12,117)

	)

219 
	#BLKTRACETEARDOWN
 
	`_IO
(0x12,118)

	)

220 
	#BLKDISCARD
 
	`_IO
(0x12,119)

	)

221 
	#BLKIOMIN
 
	`_IO
(0x12,120)

	)

222 
	#BLKIOOPT
 
	`_IO
(0x12,121)

	)

223 
	#BLKALIGNOFF
 
	`_IO
(0x12,122)

	)

224 
	#BLKPBSZGET
 
	`_IO
(0x12,123)

	)

225 
	#BLKDISCARDZEROES
 
	`_IO
(0x12,124)

	)

226 
	#BLKSECDISCARD
 
	`_IO
(0x12,125)

	)

227 
	#BLKROTATIONAL
 
	`_IO
(0x12,126)

	)

228 
	#BLKZEROOUT
 
	`_IO
(0x12,127)

	)

234 
	#BMAP_IOCTL
 1

	)

235 
	#FIBMAP
 
	`_IO
(0x00,1Ë

	)

236 
	#FIGETBSZ
 
	`_IO
(0x00,2Ë

	)

237 
	#FIFREEZE
 
	`_IOWR
('X', 119, Ë

	)

238 
	#FITHAW
 
	`_IOWR
('X', 120, Ë

	)

239 
	#FITRIM
 
	`_IOWR
('X', 121, 
f°rim_ønge
Ë

	)

240 
	#FICLONE
 
	`_IOW
(0x94, 9, )

	)

241 
	#FICLONERANGE
 
	`_IOW
(0x94, 13, 
fûe_˛⁄e_ønge
)

	)

242 
	#FIDEDUPERANGE
 
	`_IOWR
(0x94, 54, 
fûe_dedu≥_ønge
)

	)

244 
	#FS_IOC_GETFLAGS
 
	`_IOR
('f', 1, )

	)

245 
	#FS_IOC_SETFLAGS
 
	`_IOW
('f', 2, )

	)

246 
	#FS_IOC_GETVERSION
 
	`_IOR
('v', 1, )

	)

247 
	#FS_IOC_SETVERSION
 
	`_IOW
('v', 2, )

	)

248 
	#FS_IOC_FIEMAP
 
	`_IOWR
('f', 11, 
fõm≠
)

	)

249 
	#FS_IOC32_GETFLAGS
 
	`_IOR
('f', 1, )

	)

250 
	#FS_IOC32_SETFLAGS
 
	`_IOW
('f', 2, )

	)

251 
	#FS_IOC32_GETVERSION
 
	`_IOR
('v', 1, )

	)

252 
	#FS_IOC32_SETVERSION
 
	`_IOW
('v', 2, )

	)

253 
	#FS_IOC_FSGETXATTR
 
	`_IOR
 ('X', 31, 
fsx©å
)

	)

254 
	#FS_IOC_FSSETXATTR
 
	`_IOW
 ('X', 32, 
fsx©å
)

	)

260 
	#FS_KEY_DESCRIPTOR_SIZE
 8

	)

262 
	#FS_POLICY_FLAGS_PAD_4
 0x00

	)

263 
	#FS_POLICY_FLAGS_PAD_8
 0x01

	)

264 
	#FS_POLICY_FLAGS_PAD_16
 0x02

	)

265 
	#FS_POLICY_FLAGS_PAD_32
 0x03

	)

266 
	#FS_POLICY_FLAGS_PAD_MASK
 0x03

	)

267 
	#FS_POLICY_FLAGS_VALID
 0x03

	)

270 
	#FS_ENCRYPTION_MODE_INVALID
 0

	)

271 
	#FS_ENCRYPTION_MODE_AES_256_XTS
 1

	)

272 
	#FS_ENCRYPTION_MODE_AES_256_GCM
 2

	)

273 
	#FS_ENCRYPTION_MODE_AES_256_CBC
 3

	)

274 
	#FS_ENCRYPTION_MODE_AES_256_CTS
 4

	)

275 
	#FS_ENCRYPTION_MODE_AES_128_CBC
 5

	)

276 
	#FS_ENCRYPTION_MODE_AES_128_CTS
 6

	)

278 
	sfs¸y±_pﬁicy
 {

279 
__u8
 
	mvîsi⁄
;

280 
__u8
 
	mc⁄ã¡s_í¸y±i⁄_mode
;

281 
__u8
 
	mfûíames_í¸y±i⁄_mode
;

282 
__u8
 
	mÊags
;

283 
__u8
 
	mma°î_key_des¸ùt‹
[
FS_KEY_DESCRIPTOR_SIZE
];

286 
	#FS_IOC_SET_ENCRYPTION_POLICY
 
	`_IOR
('f', 19, 
fs¸y±_pﬁicy
)

	)

287 
	#FS_IOC_GET_ENCRYPTION_PWSALT
 
	`_IOW
('f', 20, 
__u8
[16])

	)

288 
	#FS_IOC_GET_ENCRYPTION_POLICY
 
	`_IOW
('f', 21, 
fs¸y±_pﬁicy
)

	)

291 
	#FS_KEY_DESC_PREFIX
 "fs¸y±:"

	)

292 
	#FS_KEY_DESC_PREFIX_SIZE
 8

	)

295 
	#FS_MAX_KEY_SIZE
 64

	)

297 
	sfs¸y±_key
 {

298 
__u32
 
	mmode
;

299 
__u8
 
	møw
[
FS_MAX_KEY_SIZE
];

300 
__u32
 
	msize
;

323 
	#FS_SECRM_FL
 0x00000001

	)

324 
	#FS_UNRM_FL
 0x00000002

	)

325 
	#FS_COMPR_FL
 0x00000004

	)

326 
	#FS_SYNC_FL
 0x00000008

	)

327 
	#FS_IMMUTABLE_FL
 0x00000010

	)

328 
	#FS_APPEND_FL
 0x00000020

	)

329 
	#FS_NODUMP_FL
 0x00000040

	)

330 
	#FS_NOATIME_FL
 0x00000080

	)

332 
	#FS_DIRTY_FL
 0x00000100

	)

333 
	#FS_COMPRBLK_FL
 0x00000200

	)

334 
	#FS_NOCOMP_FL
 0x00000400

	)

336 
	#FS_ENCRYPT_FL
 0x00000800

	)

337 
	#FS_BTREE_FL
 0x00001000

	)

338 
	#FS_INDEX_FL
 0x00001000

	)

339 
	#FS_IMAGIC_FL
 0x00002000

	)

340 
	#FS_JOURNAL_DATA_FL
 0x00004000

	)

341 
	#FS_NOTAIL_FL
 0x00008000

	)

342 
	#FS_DIRSYNC_FL
 0x00010000

	)

343 
	#FS_TOPDIR_FL
 0x00020000

	)

344 
	#FS_HUGE_FILE_FL
 0x00040000

	)

345 
	#FS_EXTENT_FL
 0x00080000

	)

346 
	#FS_EA_INODE_FL
 0x00200000

	)

347 
	#FS_EOFBLOCKS_FL
 0x00400000

	)

348 
	#FS_NOCOW_FL
 0x00800000

	)

349 
	#FS_INLINE_DATA_FL
 0x10000000

	)

350 
	#FS_PROJINHERIT_FL
 0x20000000

	)

351 
	#FS_RESERVED_FL
 0x80000000

	)

353 
	#FS_FL_USER_VISIBLE
 0x0003DFFF

	)

354 
	#FS_FL_USER_MODIFIABLE
 0x000380FF

	)

357 
	#SYNC_FILE_RANGE_WAIT_BEFORE
 1

	)

358 
	#SYNC_FILE_RANGE_WRITE
 2

	)

359 
	#SYNC_FILE_RANGE_WAIT_AFTER
 4

	)

362 
	#RWF_HIPRI
 0x00000001

	)

363 
	#RWF_DSYNC
 0x00000002

	)

364 
	#RWF_SYNC
 0x00000004

	)

365 
	#RWF_NOWAIT
 0x00000008

	)

367 
	#RWF_SUPPORTED
 (
RWF_HIPRI
 | 
RWF_DSYNC
 | 
RWF_SYNC
 |\

368 
RWF_NOWAIT
)

	)

	@/usr/include/linux/kernel.h

1 #i‚de‡
_LINUX_KERNEL_H


2 
	#_LINUX_KERNEL_H


	)

4 
	~<löux/sysöfo.h
>

9 
	#__ALIGN_KERNEL
(
x
, 
a
Ë
	`__ALIGN_KERNEL_MASK
(x, (
	`ty≥of
(x))◊Ë- 1)

	)

10 
	#__ALIGN_KERNEL_MASK
(
x
, 
mask
Ë(((xË+ (mask)Ë& ~(mask))

	)

12 
	#__KERNEL_DIV_ROUND_UP
(
n
, 
d
Ë((“Ë+ (dË- 1Ë/ (d))

	)

	@/usr/include/linux/module.h

1 #i‚de‡
_LINUX_MODULE_H


2 
	#_LINUX_MODULE_H


	)

5 
	#MODULE_INIT_IGNORE_MODVERSIONS
 1

	)

6 
	#MODULE_INIT_IGNORE_VERMAGIC
 2

	)

	@/usr/include/linux/random.h

7 #i‚de‡
_LINUX_RANDOM_H


8 
	#_LINUX_RANDOM_H


	)

10 
	~<löux/ty≥s.h
>

11 
	~<löux/io˘l.h
>

12 
	~<löux/úqƒ.h
>

17 
	#RNDGETENTCNT
 
	`_IOR
–'R', 0x00, )

	)

20 
	#RNDADDTOENTCNT
 
	`_IOW
–'R', 0x01, )

	)

23 
	#RNDGETPOOL
 
	`_IOR
–'R', 0x02, [2] )

	)

29 
	#RNDADDENTROPY
 
	`_IOW
–'R', 0x03, [2] )

	)

32 
	#RNDZAPENTCNT
 
	`_IO
–'R', 0x04 )

	)

35 
	#RNDCLEARPOOL
 
	`_IO
–'R', 0x06 )

	)

37 
	sønd_poﬁ_öfo
 {

38 
	míå›y_cou¡
;

39 
	mbuf_size
;

40 
__u32
 
	mbuf
[0];

49 
	#GRND_NONBLOCK
 0x0001

	)

50 
	#GRND_RANDOM
 0x0002

	)

	@/usr/include/linux/sched.h

1 #i‚de‡
_LINUX_SCHED_H


2 
	#_LINUX_SCHED_H


	)

7 
	#CSIGNAL
 0x000000f‡

	)

8 
	#CLONE_VM
 0x00000100

	)

9 
	#CLONE_FS
 0x00000200

	)

10 
	#CLONE_FILES
 0x00000400

	)

11 
	#CLONE_SIGHAND
 0x00000800

	)

12 
	#CLONE_PTRACE
 0x00002000

	)

13 
	#CLONE_VFORK
 0x00004000

	)

14 
	#CLONE_PARENT
 0x00008000

	)

15 
	#CLONE_THREAD
 0x00010000

	)

16 
	#CLONE_NEWNS
 0x00020000

	)

17 
	#CLONE_SYSVSEM
 0x00040000

	)

18 
	#CLONE_SETTLS
 0x00080000

	)

19 
	#CLONE_PARENT_SETTID
 0x00100000

	)

20 
	#CLONE_CHILD_CLEARTID
 0x00200000

	)

21 
	#CLONE_DETACHED
 0x00400000

	)

22 
	#CLONE_UNTRACED
 0x00800000

	)

23 
	#CLONE_CHILD_SETTID
 0x01000000

	)

24 
	#CLONE_NEWCGROUP
 0x02000000

	)

25 
	#CLONE_NEWUTS
 0x04000000

	)

26 
	#CLONE_NEWIPC
 0x08000000

	)

27 
	#CLONE_NEWUSER
 0x10000000

	)

28 
	#CLONE_NEWPID
 0x20000000

	)

29 
	#CLONE_NEWNET
 0x40000000

	)

30 
	#CLONE_IO
 0x80000000

	)

35 
	#SCHED_NORMAL
 0

	)

36 
	#SCHED_FIFO
 1

	)

37 
	#SCHED_RR
 2

	)

38 
	#SCHED_BATCH
 3

	)

40 
	#SCHED_IDLE
 5

	)

41 
	#SCHED_DEADLINE
 6

	)

44 
	#SCHED_RESET_ON_FORK
 0x40000000

	)

49 
	#SCHED_FLAG_RESET_ON_FORK
 0x01

	)

50 
	#SCHED_FLAG_RECLAIM
 0x02

	)

	@/usr/include/linux/stddef.h

3 #i‚de‡
__Æways_ölöe


4 
	#__Æways_ölöe
 
__ölöe__


	)

	@/usr/include/linux/string.h

1 #i‚de‡
_LINUX_STRING_H_


2 
	#_LINUX_STRING_H_


	)

6 
	~<°rög.h
>

	@/usr/include/linux/time.h

1 #i‚de‡
_LINUX_TIME_H


2 
	#_LINUX_TIME_H


	)

4 
	~<löux/ty≥s.h
>

7 #i‚de‡
_STRUCT_TIMESPEC


8 
	#_STRUCT_TIMESPEC


	)

9 
	stime•ec
 {

10 
__kî√l_time_t
 
	mtv_£c
;

11 
	mtv_n£c
;

15 
	stimevÆ
 {

16 
__kî√l_time_t
 
	mtv_£c
;

17 
__kî√l_su£c⁄ds_t
 
	mtv_u£c
;

20 
	stimez⁄e
 {

21 
	mtz_möuãswe°
;

22 
	mtz_d°time
;

30 
	#ITIMER_REAL
 0

	)

31 
	#ITIMER_VIRTUAL
 1

	)

32 
	#ITIMER_PROF
 2

	)

34 
	sôimî•ec
 {

35 
time•ec
 
	mô_öãrvÆ
;

36 
time•ec
 
	mô_vÆue
;

39 
	sôimîvÆ
 {

40 
timevÆ
 
	mô_öãrvÆ
;

41 
timevÆ
 
	mô_vÆue
;

47 
	#CLOCK_REALTIME
 0

	)

48 
	#CLOCK_MONOTONIC
 1

	)

49 
	#CLOCK_PROCESS_CPUTIME_ID
 2

	)

50 
	#CLOCK_THREAD_CPUTIME_ID
 3

	)

51 
	#CLOCK_MONOTONIC_RAW
 4

	)

52 
	#CLOCK_REALTIME_COARSE
 5

	)

53 
	#CLOCK_MONOTONIC_COARSE
 6

	)

54 
	#CLOCK_BOOTTIME
 7

	)

55 
	#CLOCK_REALTIME_ALARM
 8

	)

56 
	#CLOCK_BOOTTIME_ALARM
 9

	)

61 
	#CLOCK_SGI_CYCLE
 10

	)

62 
	#CLOCK_TAI
 11

	)

64 
	#MAX_CLOCKS
 16

	)

65 
	#CLOCKS_MASK
 (
CLOCK_REALTIME
 | 
CLOCK_MONOTONIC
)

	)

66 
	#CLOCKS_MONO
 
CLOCK_MONOTONIC


	)

71 
	#TIMER_ABSTIME
 0x01

	)

	@/usr/include/linux/types.h

1 #i‚de‡
_LINUX_TYPES_H


2 
	#_LINUX_TYPES_H


	)

4 
	~<asm/ty≥s.h
>

6 #i‚de‡
__ASSEMBLY__


8 
	~<löux/posix_ty≥s.h
>

16 #ifde‡
__CHECKER__


17 
	#__bôwi£__
 
	`__©åibuã__
((
bôwi£
))

	)

19 
	#__bôwi£__


	)

21 
	#__bôwi£
 
__bôwi£__


	)

23 
__u16
 
	t__bôwi£
 
	t__À16
;

24 
__u16
 
	t__bôwi£
 
	t__be16
;

25 
__u32
 
	t__bôwi£
 
	t__À32
;

26 
__u32
 
	t__bôwi£
 
	t__be32
;

27 
__u64
 
	t__bôwi£
 
	t__À64
;

28 
__u64
 
	t__bôwi£
 
	t__be64
;

30 
__u16
 
	t__bôwi£
 
	t__sum16
;

31 
__u32
 
	t__bôwi£
 
	t__wsum
;

42 
	#__Æig√d_u64
 
__u64
 
	`__©åibuã__
((
	`Æig√d
(8)))

	)

43 
	#__Æig√d_be64
 
__be64
 
	`__©åibuã__
((
	`Æig√d
(8)))

	)

44 
	#__Æig√d_À64
 
__À64
 
	`__©åibuã__
((
	`Æig√d
(8)))

	)

	@/usr/include/linux/version.h

1 
	#LINUX_VERSION_CODE
 265481

	)

2 
	#KERNEL_VERSION
(
a
,
b
,
c
Ë((◊Ë<< 16Ë+ ((bË<< 8Ë+ (c))

	)

	@/usr/include/linux/wait.h

1 #i‚de‡
_LINUX_WAIT_H


2 
	#_LINUX_WAIT_H


	)

4 
	#WNOHANG
 0x00000001

	)

5 
	#WUNTRACED
 0x00000002

	)

6 
	#WSTOPPED
 
WUNTRACED


	)

7 
	#WEXITED
 0x00000004

	)

8 
	#WCONTINUED
 0x00000008

	)

9 
	#WNOWAIT
 0x01000000

	)

11 
	#__WNOTHREAD
 0x20000000

	)

12 
	#__WALL
 0x40000000

	)

13 
	#__WCLONE
 0x80000000

	)

16 
	#P_ALL
 0

	)

17 
	#P_PID
 1

	)

18 
	#P_PGID
 2

	)

	@/usr/include/math.h

23 #i‚def 
_MATH_H


24 
	#_MATH_H
 1

	)

26 
	#__GLIBC_INTERNAL_STARTING_HEADER_IMPLEMENTATION


	)

27 
	~<bôs/libc-hódî-°¨t.h
>

29 
	g__BEGIN_DECLS


32 
	~<bôs/ty≥s.h
>

35 
	~<bôs/m©h-ve˘‹.h
>

39 
	~<bôs/huge_vÆ.h
>

40 #ifde‡
__USE_ISOC99


41 
	~<bôs/huge_vÆf.h
>

42 
	~<bôs/huge_vÆl.h
>

45 
	~<bôs/öf.h
>

48 
	~<bôs/«n.h
>

51 #i‡
__GLIBC_USE
 (
IEC_60559_BFP_EXT
)

53 #i‡
__GNUC_PREREQ
 (3, 3)

54 
	#SNANF
 (
	`__buûtö_«nsf
 (""))

	)

55 
	#SNAN
 (
	`__buûtö_«ns
 (""))

	)

56 
	#SNANL
 (
	`__buûtö_«n¶
 (""))

	)

61 
	~<bôs/Êt-evÆ-mëhod.h
>

63 #ifde‡
__USE_ISOC99


71 #i‡
__GLIBC_FLT_EVAL_METHOD
 == 0 || __GLIBC_FLT_EVAL_METHOD == 16

72 
	tÊﬂt_t
;

73 
	tdoubÀ_t
;

74 #ñi‡
__GLIBC_FLT_EVAL_METHOD
 == 1

75 
	tÊﬂt_t
;

76 
	tdoubÀ_t
;

77 #ñi‡
__GLIBC_FLT_EVAL_METHOD
 == 2

78 
	tÊﬂt_t
;

79 
	tdoubÀ_t
;

80 #ñi‡
__GLIBC_FLT_EVAL_METHOD
 == 32

81 
_Flﬂt32
 
	tÊﬂt_t
;

82 
	tdoubÀ_t
;

83 #ñi‡
__GLIBC_FLT_EVAL_METHOD
 == 33

84 
_Flﬂt32x
 
	tÊﬂt_t
;

85 
_Flﬂt32x
 
	tdoubÀ_t
;

86 #ñi‡
__GLIBC_FLT_EVAL_METHOD
 == 64

87 
_Flﬂt64
 
	tÊﬂt_t
;

88 
_Flﬂt64
 
	tdoubÀ_t
;

89 #ñi‡
__GLIBC_FLT_EVAL_METHOD
 == 65

90 
_Flﬂt64x
 
	tÊﬂt_t
;

91 
_Flﬂt64x
 
	tdoubÀ_t
;

92 #ñi‡
__GLIBC_FLT_EVAL_METHOD
 == 128

93 
_Flﬂt128
 
	tÊﬂt_t
;

94 
_Flﬂt128
 
	tdoubÀ_t
;

95 #ñi‡
__GLIBC_FLT_EVAL_METHOD
 == 129

96 
_Flﬂt128x
 
	tÊﬂt_t
;

97 
_Flﬂt128x
 
	tdoubÀ_t
;

113 
	~<bôs/Â-logb.h
>

114 #ifde‡
__USE_ISOC99


115 #i‡
__FP_LOGB0_IS_MIN


116 
	#FP_ILOGB0
 (-2147483647 - 1)

	)

118 
	#FP_ILOGB0
 (-2147483647)

	)

120 #i‡
__FP_LOGBNAN_IS_MIN


121 
	#FP_ILOGBNAN
 (-2147483647 - 1)

	)

123 
	#FP_ILOGBNAN
 2147483647

	)

126 #i‡
__GLIBC_USE
 (
IEC_60559_BFP_EXT
)

127 #i‡
__WORDSIZE
 == 32

128 
	#__FP_LONG_MAX
 0x7fffffffL

	)

130 
	#__FP_LONG_MAX
 0x7fffffffffffffffL

	)

132 #i‡
__FP_LOGB0_IS_MIN


133 
	#FP_LLOGB0
 (-
__FP_LONG_MAX
 - 1)

	)

135 
	#FP_LLOGB0
 (-
__FP_LONG_MAX
)

	)

137 #i‡
__FP_LOGBNAN_IS_MIN


138 
	#FP_LLOGBNAN
 (-
__FP_LONG_MAX
 - 1)

	)

140 
	#FP_LLOGBNAN
 
__FP_LONG_MAX


	)

156 
	~<bôs/Â-Á°.h
>

158 #i‡
__GLIBC_USE
 (
IEC_60559_BFP_EXT
)

162 
	mFP_INT_UPWARD
 =

163 
	#FP_INT_UPWARD
 0

	)

164 
FP_INT_UPWARD
,

165 
	mFP_INT_DOWNWARD
 =

166 
	#FP_INT_DOWNWARD
 1

	)

167 
FP_INT_DOWNWARD
,

168 
	mFP_INT_TOWARDZERO
 =

169 
	#FP_INT_TOWARDZERO
 2

	)

170 
FP_INT_TOWARDZERO
,

171 
	mFP_INT_TONEARESTFROMZERO
 =

172 
	#FP_INT_TONEARESTFROMZERO
 3

	)

173 
FP_INT_TONEARESTFROMZERO
,

174 
	mFP_INT_TONEAREST
 =

175 
	#FP_INT_TONEAREST
 4

	)

176 
FP_INT_TONEAREST
,

185 
	#__SIMD_DECL
(
fun˘i⁄
Ë
	`__CONCAT
 (
__DECL_SIMD_
, fun˘i⁄)

	)

187 
	#__MATHCALL_VEC
(
fun˘i⁄
, 
suffix
, 
¨gs
) \

188 
	`__SIMD_DECL
 (
	`__MATH_PRECNAME
 (
fun˘i⁄
, 
suffix
)) \

189 
	`__MATHCALL
 (
fun˘i⁄
, 
suffix
, 
¨gs
)

	)

191 
	#__MATHDECL_VEC
(
ty≥
, 
fun˘i⁄
,
suffix
, 
¨gs
) \

192 
	`__SIMD_DECL
 (
	`__MATH_PRECNAME
 (
fun˘i⁄
, 
suffix
)) \

193 
	`__MATHDECL
(
ty≥
, 
fun˘i⁄
,
suffix
, 
¨gs
)

	)

195 
	#__MATHCALL
(
fun˘i⁄
,
suffix
, 
¨gs
) \

196 
	`__MATHDECL
 (
_MdoubÀ_
,
fun˘i⁄
,
suffix
, 
¨gs
)

	)

197 
	#__MATHDECL
(
ty≥
, 
fun˘i⁄
,
suffix
, 
¨gs
) \

198 
	`__MATHDECL_1
(
ty≥
, 
fun˘i⁄
,
suffix
, 
¨gs
); \

199 
	`__MATHDECL_1
(
ty≥
, 
	`__CONCAT
(
__
,
fun˘i⁄
),
suffix
, 
¨gs
)

	)

200 
	#__MATHCALLX
(
fun˘i⁄
,
suffix
, 
¨gs
, 
©åib
) \

201 
	`__MATHDECLX
 (
_MdoubÀ_
,
fun˘i⁄
,
suffix
, 
¨gs
, 
©åib
)

	)

202 
	#__MATHDECLX
(
ty≥
, 
fun˘i⁄
,
suffix
, 
¨gs
, 
©åib
) \

203 
	`__MATHDECL_1
(
ty≥
, 
fun˘i⁄
,
suffix
, 
¨gs
Ë
	`__©åibuã__
 (
©åib
); \

204 
	`__MATHDECL_1
(
ty≥
, 
	`__CONCAT
(
__
,
fun˘i⁄
),
suffix
, 
¨gs
Ë
	`__©åibuã__
 (
©åib
)

	)

205 
	#__MATHDECL_1
(
ty≥
, 
fun˘i⁄
,
suffix
, 
¨gs
) \

206 
ty≥
 
	`__MATH_PRECNAME
(
fun˘i⁄
,
suffix
Ë
¨gs
 
__THROW


	)

208 
	#_MdoubÀ_
 

	)

209 
	#__MATH_PRECNAME
(
«me
,
r
Ë
	`__CONCAT
“ame,r)

	)

210 
	#__MATH_DECLARING_DOUBLE
 1

	)

211 
	#_MdoubÀ_BEGIN_NAMESPACE
 
__BEGIN_NAMESPACE_STD


	)

212 
	#_MdoubÀ_END_NAMESPACE
 
__END_NAMESPACE_STD


	)

213 
	~<bôs/m©hˇŒs.h
>

214 #unde‡
_MdoubÀ_


215 #unde‡
_MdoubÀ_BEGIN_NAMESPACE


216 #unde‡
_MdoubÀ_END_NAMESPACE


217 #unde‡
__MATH_PRECNAME


218 #unde‡
__MATH_DECLARING_DOUBLE


220 #ifde‡
__USE_ISOC99


226 #i‚de‡
_MÊﬂt_


227 
	#_MÊﬂt_
 

	)

229 
	#_MdoubÀ_
 
_MÊﬂt_


	)

230 
	#__MATH_PRECNAME
(
«me
,
r
Ë«me##
f
##
	)
r

231 
	#__MATH_DECLARING_DOUBLE
 0

	)

232 
	#_MdoubÀ_BEGIN_NAMESPACE
 
__BEGIN_NAMESPACE_C99


	)

233 
	#_MdoubÀ_END_NAMESPACE
 
__END_NAMESPACE_C99


	)

234 
	~<bôs/m©hˇŒs.h
>

235 #unde‡
_MdoubÀ_


236 #unde‡
_MdoubÀ_BEGIN_NAMESPACE


237 #unde‡
_MdoubÀ_END_NAMESPACE


238 #unde‡
__MATH_PRECNAME


239 #unde‡
__MATH_DECLARING_DOUBLE


241 #i‡!(
deföed
 
__NO_LONG_DOUBLE_MATH
 && deföed 
_LIBC
) \

242 || 
deföed
 
__LDBL_COMPAT
 \

243 || 
deföed
 
_LIBC_TEST


244 #ifde‡
__LDBL_COMPAT


246 #ifde‡
__USE_ISOC99


247 
	$__∆dbl_√xâow¨df
 (
__x
, 
__y
)

248 
__THROW
 
	`__©åibuã__
 ((
__c⁄°__
));

249 #ifde‡
__REDIRECT_NTH


250 
	`__REDIRECT_NTH
 (
√xâow¨df
, (
__x
, 
__y
),

251 
__∆dbl_√xâow¨df
)

252 
	`__©åibuã__
 ((
__c⁄°__
));

253 
	`__REDIRECT_NTH
 (
√xâow¨d
, (
__x
, 
__y
),

254 
√xè·î
Ë
	`__©åibuã__
 ((
__c⁄°__
));

255 
	`__REDIRECT_NTH
 (
√xâow¨dl
,

256 (
__x
, 
__y
),

257 
√xè·î
Ë
	`__©åibuã__
 ((
__c⁄°__
));

261 #unde‡
__MATHDECL_1


262 
	#__MATHDECL_2
(
ty≥
, 
fun˘i⁄
,
suffix
, 
¨gs
, 
Æüs
) \

263 
ty≥
 
	`__REDIRECT_NTH
(
	`__MATH_PRECNAME
(
fun˘i⁄
,
suffix
), \

264 
¨gs
, 
Æüs
)

	)

265 
	#__MATHDECL_1
(
ty≥
, 
fun˘i⁄
,
suffix
, 
¨gs
) \

266 
	`__MATHDECL_2
(
ty≥
, 
fun˘i⁄
,
suffix
, 
¨gs
, 
	`__CONCAT
(fun˘i⁄,suffix))

	)

272 #i‚de‡
_Ml⁄g_doubÀ_


273 
	#_Ml⁄g_doubÀ_
 

	)

275 
	#_MdoubÀ_
 
_Ml⁄g_doubÀ_


	)

276 
	#__MATH_PRECNAME
(
«me
,
r
Ë«me##
l
##
	)
r

277 
	#__MATH_DECLARING_DOUBLE
 0

	)

278 
	#_MdoubÀ_BEGIN_NAMESPACE
 
__BEGIN_NAMESPACE_C99


	)

279 
	#_MdoubÀ_END_NAMESPACE
 
__END_NAMESPACE_C99


	)

280 
	#__MATH_DECLARE_LDOUBLE
 1

	)

281 
	~<bôs/m©hˇŒs.h
>

282 #unde‡
_MdoubÀ_


283 #unde‡
_MdoubÀ_BEGIN_NAMESPACE


284 #unde‡
_MdoubÀ_END_NAMESPACE


285 #unde‡
__MATH_PRECNAME


286 #unde‡
__MATH_DECLARING_DOUBLE


291 #unde‡
__MATHDECL_1


292 #unde‡
__MATHDECL


293 #unde‡
__MATHCALL


296 #i‡
deföed
 
__USE_MISC
 || deföed 
__USE_XOPEN


298 
signgam
;

311 #ifde‡
__NO_LONG_DOUBLE_MATH


312 
	#__MATH_TG
(
TG_ARG
, 
FUNC
, 
ARGS
) \

313 ( (
TG_ARG
Ë= (Ë? 
FUNC
 ## 
f
 
ARGS
 : FUNC ARGS)

	)

315 
	#__MATH_TG
(
TG_ARG
, 
FUNC
, 
ARGS
) \

316 ( (
TG_ARG
) ==  () \

317 ? 
FUNC
 ## 
f
 
ARGS
 \

318 :  (
TG_ARG
) ==  () \

319 ? 
FUNC
 
ARGS
 \

320 : 
FUNC
 ## 
l
 
ARGS
)

	)

324 #ifde‡
__USE_ISOC99


329 
FP_NAN
 =

330 
	#FP_NAN
 0

	)

331 
FP_NAN
,

332 
FP_INFINITE
 =

333 
	#FP_INFINITE
 1

	)

334 
FP_INFINITE
,

335 
FP_ZERO
 =

336 
	#FP_ZERO
 2

	)

337 
FP_ZERO
,

338 
FP_SUBNORMAL
 =

339 
	#FP_SUBNORMAL
 3

	)

340 
FP_SUBNORMAL
,

341 
FP_NORMAL
 =

342 
	#FP_NORMAL
 4

	)

343 
FP_NORMAL


351 #i‡
	`__GNUC_PREREQ
 (4,4Ë&& !
deföed
 
__SUPPORT_SNAN__
 \

352 && !
deföed
 
__OPTIMIZE_SIZE__


353 
	#Â˛assify
(
x
Ë
	`__buûtö_Â˛assify
 (
FP_NAN
, 
FP_INFINITE
, \

354 
FP_NORMAL
, 
FP_SUBNORMAL
, 
FP_ZERO
, 
x
)

	)

356 
	#Â˛assify
(
x
Ë
	`__MATH_TG
 ((x), 
__Â˛assify
, (x))

	)

360 #i‡
	`__GNUC_PREREQ
 (4,0)

361 
	#signbô
(
x
Ë
	`__MATH_TG
 ((x), 
__buûtö_signbô
, (x))

	)

363 
	#signbô
(
x
Ë
	`__MATH_TG
 ((x), 
__signbô
, (x))

	)

367 #i‡
	`__GNUC_PREREQ
 (4,4Ë&& !
deföed
 
__SUPPORT_SNAN__


368 
	#isföôe
(
x
Ë
	`__buûtö_isföôe
 (x)

	)

370 
	#isföôe
(
x
Ë
	`__MATH_TG
 ((x), 
__föôe
, (x))

	)

374 #i‡
	`__GNUC_PREREQ
 (4,4Ë&& !
deföed
 
__SUPPORT_SNAN__


375 
	#i¢‹mÆ
(
x
Ë
	`__buûtö_i¢‹mÆ
 (x)

	)

377 
	#i¢‹mÆ
(
x
Ë(
	`Â˛assify
 (xË=
FP_NORMAL
)

	)

382 #i‡
	`__GNUC_PREREQ
 (4,4Ë&& !
deföed
 
__SUPPORT_SNAN__


383 
	#i¢™
(
x
Ë
	`__buûtö_i¢™
 (x)

	)

385 
	#i¢™
(
x
Ë
	`__MATH_TG
 ((x), 
__i¢™
, (x))

	)

389 #i‡
	`__GNUC_PREREQ
 (4,4Ë&& !
deföed
 
__SUPPORT_SNAN__


390 
	#isöf
(
x
Ë
	`__buûtö_isöf_sign
 (x)

	)

392 
	#isöf
(
x
Ë
	`__MATH_TG
 ((x), 
__isöf
, (x))

	)

396 
	#MATH_ERRNO
 1

	)

397 
	#MATH_ERREXCEPT
 2

	)

402 #i‚de‡
__FAST_MATH__


403 
	#m©h_îrh™dlög
 (
MATH_ERRNO
 | 
MATH_ERREXCEPT
)

	)

408 #i‡
	`__GLIBC_USE
 (
IEC_60559_BFP_EXT
)

409 
	~<bôs/isˇn⁄iˇl.h
>

412 
	#issig«lög
(
x
Ë
	`__MATH_TG
 ((x), 
__issig«lög
, (x))

	)

415 
	#issubn‹mÆ
(
x
Ë(
	`Â˛assify
 (xË=
FP_SUBNORMAL
)

	)

418 #i‚de‡
__˝lu•lus


419 #ifde‡
__SUPPORT_SNAN__


420 
	#iszîo
(
x
Ë(
	`Â˛assify
 (xË=
FP_ZERO
)

	)

422 
	#iszîo
(
x
Ë(((
	`__ty≥of
 (x)Ë(x)Ë=0)

	)

426 
ãm∂©e
 <
˛ass
 
__T
> 
ölöe
 
boﬁ


427 
	`iszîo
 (
__T
 
__vÆ
)

429 #ifde‡
__SUPPORT_SNAN__


430  
	`Â˛assify
 (
__vÆ
Ë=
FP_ZERO
;

432  
__vÆ
 == 0;

435 
	}
}

439 #ifdef 
__USE_MISC


443 
_IEEE_
 = -1,

444 
_SVID_
,

445 
_XOPEN_
,

446 
_POSIX_
,

447 
_ISOC_


448 } 
	t_LIB_VERSION_TYPE
;

453 
_LIB_VERSION_TYPE
 
_LIB_VERSION
;

457 #ifde‡
__USE_MISC


463 #ifde‡
__˝lu•lus


464 
	g__ex˚±i⁄


466 
	gex˚±i⁄


469 
	gty≥
;

470 *
	g«me
;

471 
	g¨g1
;

472 
	g¨g2
;

473 
	gªtvÆ
;

476 #ifde‡
__˝lu•lus


477 
	$m©hîr
 (
__ex˚±i⁄
 *
__exc
Ë
	`throw
 ();

479 
	`m©hîr
 (
ex˚±i⁄
 *
__exc
);

482 
	#X_TLOSS
 1.41484755040568800000e+16

	)

485 
	#DOMAIN
 1

	)

486 
	#SING
 2

	)

487 
	#OVERFLOW
 3

	)

488 
	#UNDERFLOW
 4

	)

489 
	#TLOSS
 5

	)

490 
	#PLOSS
 6

	)

493 
	#HUGE
 3.40282347e+38F

	)

497 #ifde‡
__USE_XOPEN


499 
	#MAXFLOAT
 3.40282347e+38F

	)

506 #i‡
deföed
 
__USE_MISC
 || deföed 
__USE_XOPEN


507 
	#M_E
 2.7182818284590452354

	)

508 
	#M_LOG2E
 1.4426950408889634074

	)

509 
	#M_LOG10E
 0.43429448190325182765

	)

510 
	#M_LN2
 0.69314718055994530942

	)

511 
	#M_LN10
 2.30258509299404568402

	)

512 
	#M_PI
 3.14159265358979323846

	)

513 
	#M_PI_2
 1.57079632679489661923

	)

514 
	#M_PI_4
 0.78539816339744830962

	)

515 
	#M_1_PI
 0.31830988618379067154

	)

516 
	#M_2_PI
 0.63661977236758134308

	)

517 
	#M_2_SQRTPI
 1.12837916709551257390

	)

518 
	#M_SQRT2
 1.41421356237309504880

	)

519 
	#M_SQRT1_2
 0.70710678118654752440

	)

525 #ifde‡
__USE_GNU


526 
	#M_El
 2.718281828459045235360287471352662498L

	)

527 
	#M_LOG2El
 1.442695040888963407359924681001892137L

	)

528 
	#M_LOG10El
 0.434294481903251827651128918916605082L

	)

529 
	#M_LN2l
 0.693147180559945309417232121458176568L

	)

530 
	#M_LN10l
 2.302585092994045684017991454684364208L

	)

531 
	#M_PIl
 3.141592653589793238462643383279502884L

	)

532 
	#M_PI_2l
 1.570796326794896619231321691639751442L

	)

533 
	#M_PI_4l
 0.785398163397448309615660845819875721L

	)

534 
	#M_1_PIl
 0.318309886183790671537767526745028724L

	)

535 
	#M_2_PIl
 0.636619772367581343075535053490057448L

	)

536 
	#M_2_SQRTPIl
 1.128379167095512573896158903121545172L

	)

537 
	#M_SQRT2l
 1.414213562373095048801688724209698079L

	)

538 
	#M_SQRT1_2l
 0.707106781186547524400844362104849039L

	)

545 #i‡
deföed
 
__STRICT_ANSI__
 && !deföed 
__NO_MATH_INLINES


546 
	#__NO_MATH_INLINES
 1

	)

549 #i‡
deföed
 
__USE_ISOC99
 && 
	`__GNUC_PREREQ
(2,97)

556 
	#isgª©î
(
x
, 
y
Ë
	`__buûtö_isgª©î
(x, y)

	)

557 
	#isgª©îequÆ
(
x
, 
y
Ë
	`__buûtö_isgª©îequÆ
(x, y)

	)

558 
	#i¶ess
(
x
, 
y
Ë
	`__buûtö_i¶ess
(x, y)

	)

559 
	#i¶es£quÆ
(
x
, 
y
Ë
	`__buûtö_i¶es£quÆ
(x, y)

	)

560 
	#i¶essgª©î
(
x
, 
y
Ë
	`__buûtö_i¶essgª©î
(x, y)

	)

561 
	#isun‹dîed
(
u
, 
v
Ë
	`__buûtö_isun‹dîed
(u, v)

	)

565 #ifde‡
__USE_EXTERN_INLINES


566 
	~<bôs/m©hölöe.h
>

571 #i‡
deföed
 
__FINITE_MATH_ONLY__
 && __FINITE_MATH_ONLY__ > 0

572 
	~<bôs/m©h-föôe.h
>

575 #ifde‡
__USE_ISOC99


579 #i‚de‡
isgª©î


580 
	#isgª©î
(
x
, 
y
) \

581 (
__exãnsi⁄__
 \

582 ({ 
	`__ty≥of__
(
x
Ë
__x
 = (x); __ty≥of__(
y
Ë
__y
 = (y); \

583 !
	`isun‹dîed
 (
__x
, 
__y
Ë&& __x > __y; 
	}
}))

	)

587 #i‚de‡
isgª©îequÆ


588 
	#isgª©îequÆ
(
x
, 
y
) \

589 (
__exãnsi⁄__
 \

590 ({ 
	`__ty≥of__
(
x
Ë
__x
 = (x); __ty≥of__(
y
Ë
__y
 = (y); \

591 !
	`isun‹dîed
 (
__x
, 
__y
Ë&& __x >__y; }))

	)

595 #i‚de‡
i¶ess


596 
	#i¶ess
(
x
, 
y
) \

597 (
__exãnsi⁄__
 \

598 ({ 
	`__ty≥of__
(
x
Ë
__x
 = (x); __ty≥of__(
y
Ë
__y
 = (y); \

599 !
	`isun‹dîed
 (
__x
, 
__y
Ë&& __x < __y; }))

	)

603 #i‚de‡
i¶es£quÆ


604 
	#i¶es£quÆ
(
x
, 
y
) \

605 (
__exãnsi⁄__
 \

606 ({ 
	`__ty≥of__
(
x
Ë
__x
 = (x); __ty≥of__(
y
Ë
__y
 = (y); \

607 !
	`isun‹dîed
 (
__x
, 
__y
Ë&& __x <__y; }))

	)

611 #i‚de‡
i¶essgª©î


612 
	#i¶essgª©î
(
x
, 
y
) \

613 (
__exãnsi⁄__
 \

614 ({ 
	`__ty≥of__
(
x
Ë
__x
 = (x); __ty≥of__(
y
Ë
__y
 = (y); \

615 !
	`isun‹dîed
 (
__x
, 
__y
Ë&& (__x < __y || __y < __x); }))

	)

619 #i‚de‡
isun‹dîed


620 
	#isun‹dîed
(
u
, 
v
) \

621 (
__exãnsi⁄__
 \

622 ({ 
	`__ty≥of__
(
u
Ë
__u
 = (u); __ty≥of__(
v
Ë
__v
 = (v); \

623 
	`Â˛assify
 (
__u
Ë=
FP_NAN
 || fp˛assify (
__v
Ë=FP_NAN; }))

	)

628 #i‡
__GLIBC_USE
 (
IEC_60559_BFP_EXT
)

631 #i‡
__FLT_EVAL_METHOD__
 == 2 || __FLT_EVAL_METHOD__ > 64

632 
	#__MATH_EVAL_FMT2
(
x
, 
y
Ë((xË+ (yË+ 0.0L)

	)

633 #ñi‡
__FLT_EVAL_METHOD__
 == 1 || __FLT_EVAL_METHOD__ > 32

634 
	#__MATH_EVAL_FMT2
(
x
, 
y
Ë((xË+ (yË+ 0.0)

	)

636 
	#__MATH_EVAL_FMT2
(
x
, 
y
Ë((xË+ (y))

	)

641 
	#i£qsig
(
x
, 
y
) \

642 
	`__MATH_TG
 (
	`__MATH_EVAL_FMT2
 (
x
, 
y
), 
__i£qsig
, ((x), (y)))

	)

645 
	g__END_DECLS


	@/usr/include/stdint.h

22 #i‚de‡
_STDINT_H


23 
	#_STDINT_H
 1

	)

25 
	#__GLIBC_INTERNAL_STARTING_HEADER_IMPLEMENTATION


	)

26 
	~<bôs/libc-hódî-°¨t.h
>

27 
	~<bôs/ty≥s.h
>

28 
	~<bôs/wch¨.h
>

29 
	~<bôs/w‹dsize.h
>

36 #i‚de‡
__öt8_t_deföed


37 
	#__öt8_t_deföed


	)

38 sig√d 
	töt8_t
;

39 
	töt16_t
;

40 
	töt32_t
;

41 #i‡
__WORDSIZE
 == 64

42 
	töt64_t
;

44 
__exãnsi⁄__


45 
	töt64_t
;

50 
	tuöt8_t
;

51 
	tuöt16_t
;

52 #i‚de‡
__uöt32_t_deföed


53 
	tuöt32_t
;

54 
	#__uöt32_t_deföed


	)

56 #i‡
__WORDSIZE
 == 64

57 
	tuöt64_t
;

59 
__exãnsi⁄__


60 
	tuöt64_t
;

67 sig√d 
	töt_Àa°8_t
;

68 
	töt_Àa°16_t
;

69 
	töt_Àa°32_t
;

70 #i‡
__WORDSIZE
 == 64

71 
	töt_Àa°64_t
;

73 
__exãnsi⁄__


74 
	töt_Àa°64_t
;

78 
	tuöt_Àa°8_t
;

79 
	tuöt_Àa°16_t
;

80 
	tuöt_Àa°32_t
;

81 #i‡
__WORDSIZE
 == 64

82 
	tuöt_Àa°64_t
;

84 
__exãnsi⁄__


85 
	tuöt_Àa°64_t
;

92 sig√d 
	töt_Á°8_t
;

93 #i‡
__WORDSIZE
 == 64

94 
	töt_Á°16_t
;

95 
	töt_Á°32_t
;

96 
	töt_Á°64_t
;

98 
	töt_Á°16_t
;

99 
	töt_Á°32_t
;

100 
__exãnsi⁄__


101 
	töt_Á°64_t
;

105 
	tuöt_Á°8_t
;

106 #i‡
__WORDSIZE
 == 64

107 
	tuöt_Á°16_t
;

108 
	tuöt_Á°32_t
;

109 
	tuöt_Á°64_t
;

111 
	tuöt_Á°16_t
;

112 
	tuöt_Á°32_t
;

113 
__exãnsi⁄__


114 
	tuöt_Á°64_t
;

119 #i‡
__WORDSIZE
 == 64

120 #i‚de‡
__öçå_t_deföed


121 
	töçå_t
;

122 
	#__öçå_t_deföed


	)

124 
	tuöçå_t
;

126 #i‚de‡
__öçå_t_deföed


127 
	töçå_t
;

128 
	#__öçå_t_deföed


	)

130 
	tuöçå_t
;

135 
__ötmax_t
 
	tötmax_t
;

136 
__uötmax_t
 
	tuötmax_t
;

139 #i‡
__WORDSIZE
 == 64

140 
	#__INT64_C
(
c
Ë¯## 
L


	)

141 
	#__UINT64_C
(
c
Ë¯## 
UL


	)

143 
	#__INT64_C
(
c
Ë¯## 
LL


	)

144 
	#__UINT64_C
(
c
Ë¯## 
ULL


	)

150 
	#INT8_MIN
 (-128)

	)

151 
	#INT16_MIN
 (-32767-1)

	)

152 
	#INT32_MIN
 (-2147483647-1)

	)

153 
	#INT64_MIN
 (-
	`__INT64_C
(9223372036854775807)-1)

	)

155 
	#INT8_MAX
 (127)

	)

156 
	#INT16_MAX
 (32767)

	)

157 
	#INT32_MAX
 (2147483647)

	)

158 
	#INT64_MAX
 (
	`__INT64_C
(9223372036854775807))

	)

161 
	#UINT8_MAX
 (255)

	)

162 
	#UINT16_MAX
 (65535)

	)

163 
	#UINT32_MAX
 (4294967295U)

	)

164 
	#UINT64_MAX
 (
	`__UINT64_C
(18446744073709551615))

	)

168 
	#INT_LEAST8_MIN
 (-128)

	)

169 
	#INT_LEAST16_MIN
 (-32767-1)

	)

170 
	#INT_LEAST32_MIN
 (-2147483647-1)

	)

171 
	#INT_LEAST64_MIN
 (-
	`__INT64_C
(9223372036854775807)-1)

	)

173 
	#INT_LEAST8_MAX
 (127)

	)

174 
	#INT_LEAST16_MAX
 (32767)

	)

175 
	#INT_LEAST32_MAX
 (2147483647)

	)

176 
	#INT_LEAST64_MAX
 (
	`__INT64_C
(9223372036854775807))

	)

179 
	#UINT_LEAST8_MAX
 (255)

	)

180 
	#UINT_LEAST16_MAX
 (65535)

	)

181 
	#UINT_LEAST32_MAX
 (4294967295U)

	)

182 
	#UINT_LEAST64_MAX
 (
	`__UINT64_C
(18446744073709551615))

	)

186 
	#INT_FAST8_MIN
 (-128)

	)

187 #i‡
__WORDSIZE
 == 64

188 
	#INT_FAST16_MIN
 (-9223372036854775807L-1)

	)

189 
	#INT_FAST32_MIN
 (-9223372036854775807L-1)

	)

191 
	#INT_FAST16_MIN
 (-2147483647-1)

	)

192 
	#INT_FAST32_MIN
 (-2147483647-1)

	)

194 
	#INT_FAST64_MIN
 (-
	`__INT64_C
(9223372036854775807)-1)

	)

196 
	#INT_FAST8_MAX
 (127)

	)

197 #i‡
__WORDSIZE
 == 64

198 
	#INT_FAST16_MAX
 (9223372036854775807L)

	)

199 
	#INT_FAST32_MAX
 (9223372036854775807L)

	)

201 
	#INT_FAST16_MAX
 (2147483647)

	)

202 
	#INT_FAST32_MAX
 (2147483647)

	)

204 
	#INT_FAST64_MAX
 (
	`__INT64_C
(9223372036854775807))

	)

207 
	#UINT_FAST8_MAX
 (255)

	)

208 #i‡
__WORDSIZE
 == 64

209 
	#UINT_FAST16_MAX
 (18446744073709551615UL)

	)

210 
	#UINT_FAST32_MAX
 (18446744073709551615UL)

	)

212 
	#UINT_FAST16_MAX
 (4294967295U)

	)

213 
	#UINT_FAST32_MAX
 (4294967295U)

	)

215 
	#UINT_FAST64_MAX
 (
	`__UINT64_C
(18446744073709551615))

	)

219 #i‡
__WORDSIZE
 == 64

220 
	#INTPTR_MIN
 (-9223372036854775807L-1)

	)

221 
	#INTPTR_MAX
 (9223372036854775807L)

	)

222 
	#UINTPTR_MAX
 (18446744073709551615UL)

	)

224 
	#INTPTR_MIN
 (-2147483647-1)

	)

225 
	#INTPTR_MAX
 (2147483647)

	)

226 
	#UINTPTR_MAX
 (4294967295U)

	)

231 
	#INTMAX_MIN
 (-
	`__INT64_C
(9223372036854775807)-1)

	)

233 
	#INTMAX_MAX
 (
	`__INT64_C
(9223372036854775807))

	)

236 
	#UINTMAX_MAX
 (
	`__UINT64_C
(18446744073709551615))

	)

242 #i‡
__WORDSIZE
 == 64

243 
	#PTRDIFF_MIN
 (-9223372036854775807L-1)

	)

244 
	#PTRDIFF_MAX
 (9223372036854775807L)

	)

246 #i‡
__WORDSIZE32_PTRDIFF_LONG


247 
	#PTRDIFF_MIN
 (-2147483647L-1)

	)

248 
	#PTRDIFF_MAX
 (2147483647L)

	)

250 
	#PTRDIFF_MIN
 (-2147483647-1)

	)

251 
	#PTRDIFF_MAX
 (2147483647)

	)

256 
	#SIG_ATOMIC_MIN
 (-2147483647-1)

	)

257 
	#SIG_ATOMIC_MAX
 (2147483647)

	)

260 #i‡
__WORDSIZE
 == 64

261 
	#SIZE_MAX
 (18446744073709551615UL)

	)

263 #i‡
__WORDSIZE32_SIZE_ULONG


264 
	#SIZE_MAX
 (4294967295UL)

	)

266 
	#SIZE_MAX
 (4294967295U)

	)

271 #i‚de‡
WCHAR_MIN


273 
	#WCHAR_MIN
 
__WCHAR_MIN


	)

274 
	#WCHAR_MAX
 
__WCHAR_MAX


	)

278 
	#WINT_MIN
 (0u)

	)

279 
	#WINT_MAX
 (4294967295u)

	)

282 
	#INT8_C
(
c
Ë
	)
c

283 
	#INT16_C
(
c
Ë
	)
c

284 
	#INT32_C
(
c
Ë
	)
c

285 #i‡
__WORDSIZE
 == 64

286 
	#INT64_C
(
c
Ë¯## 
L


	)

288 
	#INT64_C
(
c
Ë¯## 
LL


	)

292 
	#UINT8_C
(
c
Ë
	)
c

293 
	#UINT16_C
(
c
Ë
	)
c

294 
	#UINT32_C
(
c
Ë¯## 
U


	)

295 #i‡
__WORDSIZE
 == 64

296 
	#UINT64_C
(
c
Ë¯## 
UL


	)

298 
	#UINT64_C
(
c
Ë¯## 
ULL


	)

302 #i‡
__WORDSIZE
 == 64

303 
	#INTMAX_C
(
c
Ë¯## 
L


	)

304 
	#UINTMAX_C
(
c
Ë¯## 
UL


	)

306 
	#INTMAX_C
(
c
Ë¯## 
LL


	)

307 
	#UINTMAX_C
(
c
Ë¯## 
ULL


	)

310 #i‡
__GLIBC_USE
 (
IEC_60559_BFP_EXT
)

312 
	#INT8_WIDTH
 8

	)

313 
	#UINT8_WIDTH
 8

	)

314 
	#INT16_WIDTH
 16

	)

315 
	#UINT16_WIDTH
 16

	)

316 
	#INT32_WIDTH
 32

	)

317 
	#UINT32_WIDTH
 32

	)

318 
	#INT64_WIDTH
 64

	)

319 
	#UINT64_WIDTH
 64

	)

321 
	#INT_LEAST8_WIDTH
 8

	)

322 
	#UINT_LEAST8_WIDTH
 8

	)

323 
	#INT_LEAST16_WIDTH
 16

	)

324 
	#UINT_LEAST16_WIDTH
 16

	)

325 
	#INT_LEAST32_WIDTH
 32

	)

326 
	#UINT_LEAST32_WIDTH
 32

	)

327 
	#INT_LEAST64_WIDTH
 64

	)

328 
	#UINT_LEAST64_WIDTH
 64

	)

330 
	#INT_FAST8_WIDTH
 8

	)

331 
	#UINT_FAST8_WIDTH
 8

	)

332 
	#INT_FAST16_WIDTH
 
__WORDSIZE


	)

333 
	#UINT_FAST16_WIDTH
 
__WORDSIZE


	)

334 
	#INT_FAST32_WIDTH
 
__WORDSIZE


	)

335 
	#UINT_FAST32_WIDTH
 
__WORDSIZE


	)

336 
	#INT_FAST64_WIDTH
 64

	)

337 
	#UINT_FAST64_WIDTH
 64

	)

339 
	#INTPTR_WIDTH
 
__WORDSIZE


	)

340 
	#UINTPTR_WIDTH
 
__WORDSIZE


	)

342 
	#INTMAX_WIDTH
 64

	)

343 
	#UINTMAX_WIDTH
 64

	)

345 
	#PTRDIFF_WIDTH
 
__WORDSIZE


	)

346 
	#SIG_ATOMIC_WIDTH
 32

	)

347 
	#SIZE_WIDTH
 
__WORDSIZE


	)

348 
	#WCHAR_WIDTH
 32

	)

349 
	#WINT_WIDTH
 32

	)

	@/usr/include/stdlib.h

22 #i‚def 
_STDLIB_H


24 
	#__GLIBC_INTERNAL_STARTING_HEADER_IMPLEMENTATION


	)

25 
	~<bôs/libc-hódî-°¨t.h
>

28 
	#__√ed_size_t


	)

29 #i‚de‡
__√ed_mÆloc_™d_ˇŒoc


30 
	#__√ed_wch¨_t


	)

31 
	#__√ed_NULL


	)

33 
	~<°ddef.h
>

35 
	g__BEGIN_DECLS


37 #i‚de‡
__√ed_mÆloc_™d_ˇŒoc


38 
	#_STDLIB_H
 1

	)

40 #i‡(
deföed
 
__USE_XOPEN
 || deföed 
__USE_XOPEN2K8
Ë&& !deföed 
_SYS_WAIT_H


42 
	~<bôs/waôÊags.h
>

43 
	~<bôs/waô°©us.h
>

46 
	#WEXITSTATUS
(
°©us
Ë
	`__WEXITSTATUS
 (°©us)

	)

47 
	#WTERMSIG
(
°©us
Ë
	`__WTERMSIG
 (°©us)

	)

48 
	#WSTOPSIG
(
°©us
Ë
	`__WSTOPSIG
 (°©us)

	)

49 
	#WIFEXITED
(
°©us
Ë
	`__WIFEXITED
 (°©us)

	)

50 
	#WIFSIGNALED
(
°©us
Ë
	`__WIFSIGNALED
 (°©us)

	)

51 
	#WIFSTOPPED
(
°©us
Ë
	`__WIFSTOPPED
 (°©us)

	)

52 #ifde‡
__WIFCONTINUED


53 
	#WIFCONTINUED
(
°©us
Ë
	`__WIFCONTINUED
 (°©us)

	)

57 
__BEGIN_NAMESPACE_STD


61 
	mquŸ
;

62 
	mªm
;

63 } 
	tdiv_t
;

66 #i‚de‡
__ldiv_t_deföed


69 
	mquŸ
;

70 
	mªm
;

71 } 
	tldiv_t
;

72 
	#__ldiv_t_deföed
 1

	)

74 
	g__END_NAMESPACE_STD


76 #i‡
deföed
 
__USE_ISOC99
 && !deföed 
__Œdiv_t_deföed


77 
__BEGIN_NAMESPACE_C99


79 
__exãnsi⁄__
 struct

81 
	mquŸ
;

82 
	mªm
;

83 } 
	tŒdiv_t
;

84 
	#__Œdiv_t_deföed
 1

	)

85 
	g__END_NAMESPACE_C99


90 
	#RAND_MAX
 2147483647

	)

95 
	#EXIT_FAILURE
 1

	)

96 
	#EXIT_SUCCESS
 0

	)

100 
	#MB_CUR_MAX
 (
	`__˘y≥_gë_mb_cur_max
 ())

	)

101 
size_t
 
	$__˘y≥_gë_mb_cur_max
 (Ë
__THROW
 
__wur
;

104 
__BEGIN_NAMESPACE_STD


106 
	$©of
 (c⁄° *
__≈å
)

107 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1)Ë
__wur
;

109 
	$©oi
 (c⁄° *
__≈å
)

110 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1)Ë
__wur
;

112 
	$©ﬁ
 (c⁄° *
__≈å
)

113 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1)Ë
__wur
;

114 
__END_NAMESPACE_STD


116 #ifde‡
__USE_ISOC99


117 
__BEGIN_NAMESPACE_C99


119 
__exãnsi⁄__
 
	$©ﬁl
 (c⁄° *
__≈å
)

120 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1)Ë
__wur
;

121 
__END_NAMESPACE_C99


124 
__BEGIN_NAMESPACE_STD


126 
	$°πod
 (c⁄° *
__ª°ri˘
 
__≈å
,

127 **
__ª°ri˘
 
__íd±r
)

128 
__THROW
 
	`__n⁄nuŒ
 ((1));

129 
__END_NAMESPACE_STD


131 #ifdef 
__USE_ISOC99


132 
__BEGIN_NAMESPACE_C99


134 
	$°πof
 (c⁄° *
__ª°ri˘
 
__≈å
,

135 **
__ª°ri˘
 
__íd±r
Ë
__THROW
 
	`__n⁄nuŒ
 ((1));

137 
	$°πﬁd
 (c⁄° *
__ª°ri˘
 
__≈å
,

138 **
__ª°ri˘
 
__íd±r
)

139 
__THROW
 
	`__n⁄nuŒ
 ((1));

140 
__END_NAMESPACE_C99


143 
__BEGIN_NAMESPACE_STD


145 
	$°πﬁ
 (c⁄° *
__ª°ri˘
 
__≈å
,

146 **
__ª°ri˘
 
__íd±r
, 
__ba£
)

147 
__THROW
 
	`__n⁄nuŒ
 ((1));

149 
	$°πoul
 (c⁄° *
__ª°ri˘
 
__≈å
,

150 **
__ª°ri˘
 
__íd±r
, 
__ba£
)

151 
__THROW
 
	`__n⁄nuŒ
 ((1));

152 
__END_NAMESPACE_STD


154 #ifde‡
__USE_MISC


156 
__exãnsi⁄__


157 
	$°πoq
 (c⁄° *
__ª°ri˘
 
__≈å
,

158 **
__ª°ri˘
 
__íd±r
, 
__ba£
)

159 
__THROW
 
	`__n⁄nuŒ
 ((1));

161 
__exãnsi⁄__


162 
	$°πouq
 (c⁄° *
__ª°ri˘
 
__≈å
,

163 **
__ª°ri˘
 
__íd±r
, 
__ba£
)

164 
__THROW
 
	`__n⁄nuŒ
 ((1));

167 #ifde‡
__USE_ISOC99


168 
__BEGIN_NAMESPACE_C99


170 
__exãnsi⁄__


171 
	$°πﬁl
 (c⁄° *
__ª°ri˘
 
__≈å
,

172 **
__ª°ri˘
 
__íd±r
, 
__ba£
)

173 
__THROW
 
	`__n⁄nuŒ
 ((1));

175 
__exãnsi⁄__


176 
	$°πouŒ
 (c⁄° *
__ª°ri˘
 
__≈å
,

177 **
__ª°ri˘
 
__íd±r
, 
__ba£
)

178 
__THROW
 
	`__n⁄nuŒ
 ((1));

179 
__END_NAMESPACE_C99


183 #i‡
	`__GLIBC_USE
 (
IEC_60559_BFP_EXT
)

184 
	$°r‰omd
 (*
__de°
, 
size_t
 
__size
, c⁄° *
__f‹m©
,

185 
__f
)

186 
__THROW
 
	`__n⁄nuŒ
 ((3));

188 
	$°r‰omf
 (*
__de°
, 
size_t
 
__size
, c⁄° *
__f‹m©
,

189 
__f
)

190 
__THROW
 
	`__n⁄nuŒ
 ((3));

192 
	$°r‰oml
 (*
__de°
, 
size_t
 
__size
, c⁄° *
__f‹m©
,

193 
__f
)

194 
__THROW
 
	`__n⁄nuŒ
 ((3));

198 #ifde‡
__USE_GNU


212 
	~<xloˇÀ.h
>

216 
	$°πﬁ_l
 (c⁄° *
__ª°ri˘
 
__≈å
,

217 **
__ª°ri˘
 
__íd±r
, 
__ba£
,

218 
__loˇÀ_t
 
__loc
Ë
__THROW
 
	`__n⁄nuŒ
 ((1, 4));

220 
	$°πoul_l
 (c⁄° *
__ª°ri˘
 
__≈å
,

221 **
__ª°ri˘
 
__íd±r
,

222 
__ba£
, 
__loˇÀ_t
 
__loc
)

223 
__THROW
 
	`__n⁄nuŒ
 ((1, 4));

225 
__exãnsi⁄__


226 
	$°πﬁl_l
 (c⁄° *
__ª°ri˘
 
__≈å
,

227 **
__ª°ri˘
 
__íd±r
, 
__ba£
,

228 
__loˇÀ_t
 
__loc
)

229 
__THROW
 
	`__n⁄nuŒ
 ((1, 4));

231 
__exãnsi⁄__


232 
	$°πouŒ_l
 (c⁄° *
__ª°ri˘
 
__≈å
,

233 **
__ª°ri˘
 
__íd±r
,

234 
__ba£
, 
__loˇÀ_t
 
__loc
)

235 
__THROW
 
	`__n⁄nuŒ
 ((1, 4));

237 
	$°πod_l
 (c⁄° *
__ª°ri˘
 
__≈å
,

238 **
__ª°ri˘
 
__íd±r
, 
__loˇÀ_t
 
__loc
)

239 
__THROW
 
	`__n⁄nuŒ
 ((1, 3));

241 
	$°πof_l
 (c⁄° *
__ª°ri˘
 
__≈å
,

242 **
__ª°ri˘
 
__íd±r
, 
__loˇÀ_t
 
__loc
)

243 
__THROW
 
	`__n⁄nuŒ
 ((1, 3));

245 
	$°πﬁd_l
 (c⁄° *
__ª°ri˘
 
__≈å
,

246 **
__ª°ri˘
 
__íd±r
,

247 
__loˇÀ_t
 
__loc
)

248 
__THROW
 
	`__n⁄nuŒ
 ((1, 3));

252 #ifde‡
__USE_EXTERN_INLINES


253 
__BEGIN_NAMESPACE_STD


254 
__exã∫_ölöe
 

255 
	`__NTH
 (
	$©oi
 (c⁄° *
__≈å
))

257  (Ë
	`°πﬁ
 (
__≈å
, (**Ë
NULL
, 10);

258 
	}
}

259 
__exã∫_ölöe
 

260 
__NTH
 (
	$©ﬁ
 (c⁄° *
__≈å
))

262  
	`°πﬁ
 (
__≈å
, (**Ë
NULL
, 10);

263 
	}
}

264 
	g__END_NAMESPACE_STD


266 #ifde‡
__USE_ISOC99


267 
__BEGIN_NAMESPACE_C99


268 
__exãnsi⁄__
 
__exã∫_ölöe
 

269 
__NTH
 (
	$©ﬁl
 (c⁄° *
__≈å
))

271  
	`°πﬁl
 (
__≈å
, (**Ë
NULL
, 10);

272 
	}
}

273 
	g__END_NAMESPACE_C99


278 #i‡
deföed
 
__USE_MISC
 || deföed 
__USE_XOPEN_EXTENDED


282 *
	$l64a
 (
__n
Ë
__THROW
 
__wur
;

285 
	$a64l
 (c⁄° *
__s
)

286 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1)Ë
__wur
;

290 #i‡
deföed
 
__USE_MISC
 || deföed 
__USE_XOPEN_EXTENDED


291 
	~<sys/ty≥s.h
>

298 
	$øndom
 (Ë
__THROW
;

301 
	$§™dom
 (
__£ed
Ë
__THROW
;

307 *
	$öô°©e
 (
__£ed
, *
__°©ebuf
,

308 
size_t
 
__°©ñí
Ë
__THROW
 
	`__n⁄nuŒ
 ((2));

312 *
	$£t°©e
 (*
__°©ebuf
Ë
__THROW
 
	`__n⁄nuŒ
 ((1));

315 #ifde‡
__USE_MISC


320 
	søndom_d©a


322 
öt32_t
 *
Âå
;

323 
öt32_t
 *
Ωå
;

324 
öt32_t
 *
°©e
;

325 
ønd_ty≥
;

326 
ønd_deg
;

327 
ønd_£p
;

328 
öt32_t
 *
íd_±r
;

331 
	$øndom_r
 (
øndom_d©a
 *
__ª°ri˘
 
__buf
,

332 
öt32_t
 *
__ª°ri˘
 
__ªsu…
Ë
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

334 
	$§™dom_r
 (
__£ed
, 
øndom_d©a
 *
__buf
)

335 
__THROW
 
	`__n⁄nuŒ
 ((2));

337 
	$öô°©e_r
 (
__£ed
, *
__ª°ri˘
 
__°©ebuf
,

338 
size_t
 
__°©ñí
,

339 
øndom_d©a
 *
__ª°ri˘
 
__buf
)

340 
__THROW
 
	`__n⁄nuŒ
 ((2, 4));

342 
	$£t°©e_r
 (*
__ª°ri˘
 
__°©ebuf
,

343 
øndom_d©a
 *
__ª°ri˘
 
__buf
)

344 
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

349 
__BEGIN_NAMESPACE_STD


351 
	$ønd
 (Ë
__THROW
;

353 
	$§™d
 (
__£ed
Ë
__THROW
;

354 
__END_NAMESPACE_STD


356 #ifde‡
__USE_POSIX199506


358 
	$ønd_r
 (*
__£ed
Ë
__THROW
;

362 #i‡
deföed
 
__USE_MISC
 || deföed 
__USE_XOPEN


366 
	$dønd48
 (Ë
__THROW
;

367 
	$î™d48
 (
__xsubi
[3]Ë
__THROW
 
	`__n⁄nuŒ
 ((1));

370 
	$Ã™d48
 (Ë
__THROW
;

371 
	$ƒ™d48
 (
__xsubi
[3])

372 
__THROW
 
	`__n⁄nuŒ
 ((1));

375 
	$mønd48
 (Ë
__THROW
;

376 
	$jønd48
 (
__xsubi
[3])

377 
__THROW
 
	`__n⁄nuŒ
 ((1));

380 
	$§™d48
 (
__£edvÆ
Ë
__THROW
;

381 *
	$£ed48
 (
__£ed16v
[3])

382 
__THROW
 
	`__n⁄nuŒ
 ((1));

383 
	$lc⁄g48
 (
__∑øm
[7]Ë
__THROW
 
	`__n⁄nuŒ
 ((1));

385 #ifde‡
__USE_MISC


389 
	sdønd48_d©a


391 
__x
[3];

392 
__ﬁd_x
[3];

393 
__c
;

394 
__öô
;

395 
__exãnsi⁄__
 
__a
;

400 
	$dønd48_r
 (
dønd48_d©a
 *
__ª°ri˘
 
__buf„r
,

401 *
__ª°ri˘
 
__ªsu…
Ë
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

402 
	$î™d48_r
 (
__xsubi
[3],

403 
dønd48_d©a
 *
__ª°ri˘
 
__buf„r
,

404 *
__ª°ri˘
 
__ªsu…
Ë
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

407 
	$Ã™d48_r
 (
dønd48_d©a
 *
__ª°ri˘
 
__buf„r
,

408 *
__ª°ri˘
 
__ªsu…
)

409 
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

410 
	$ƒ™d48_r
 (
__xsubi
[3],

411 
dønd48_d©a
 *
__ª°ri˘
 
__buf„r
,

412 *
__ª°ri˘
 
__ªsu…
)

413 
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

416 
	$mønd48_r
 (
dønd48_d©a
 *
__ª°ri˘
 
__buf„r
,

417 *
__ª°ri˘
 
__ªsu…
)

418 
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

419 
	$jønd48_r
 (
__xsubi
[3],

420 
dønd48_d©a
 *
__ª°ri˘
 
__buf„r
,

421 *
__ª°ri˘
 
__ªsu…
)

422 
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

425 
	$§™d48_r
 (
__£edvÆ
, 
dønd48_d©a
 *
__buf„r
)

426 
__THROW
 
	`__n⁄nuŒ
 ((2));

428 
	$£ed48_r
 (
__£ed16v
[3],

429 
dønd48_d©a
 *
__buf„r
Ë
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

431 
	$lc⁄g48_r
 (
__∑øm
[7],

432 
dønd48_d©a
 *
__buf„r
)

433 
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

439 #i‚de‡
__mÆloc_™d_ˇŒoc_deföed


440 
	#__mÆloc_™d_ˇŒoc_deföed


	)

441 
__BEGIN_NAMESPACE_STD


443 *
	$mÆloc
 (
size_t
 
__size
Ë
__THROW
 
__©åibuã_mÆloc__
 
__wur
;

445 *
	$ˇŒoc
 (
size_t
 
__nmemb
, size_à
__size
)

446 
__THROW
 
__©åibuã_mÆloc__
 
__wur
;

447 
__END_NAMESPACE_STD


450 #i‚de‡
__√ed_mÆloc_™d_ˇŒoc


451 
__BEGIN_NAMESPACE_STD


457 *
	$ªÆloc
 (*
__±r
, 
size_t
 
__size
)

458 
__THROW
 
__©åibuã_w¨n_unu£d_ªsu…__
;

460 
	$‰ì
 (*
__±r
Ë
__THROW
;

461 
__END_NAMESPACE_STD


463 #ifdef 
__USE_MISC


465 
	$c‰ì
 (*
__±r
Ë
__THROW
;

468 #ifde‡
__USE_MISC


469 
	~<Æloˇ.h
>

472 #i‡(
deföed
 
__USE_XOPEN_EXTENDED
 && !deföed 
__USE_XOPEN2K
) \

473 || 
deföed
 
__USE_MISC


475 *
	$vÆloc
 (
size_t
 
__size
Ë
__THROW
 
__©åibuã_mÆloc__
 
__wur
;

478 #ifde‡
__USE_XOPEN2K


480 
	$posix_memÆign
 (**
__mem±r
, 
size_t
 
__Æignmít
, size_à
__size
)

481 
__THROW
 
	`__n⁄nuŒ
 ((1)Ë
__wur
;

484 #ifde‡
__USE_ISOC11


486 *
	$Æig√d_Æloc
 (
size_t
 
__Æignmít
, size_à
__size
)

487 
__THROW
 
__©åibuã_mÆloc__
 
	`__©åibuã_Æloc_size__
 ((2)Ë
__wur
;

490 
__BEGIN_NAMESPACE_STD


492 
	$ab‹t
 (Ë
__THROW
 
	`__©åibuã__
 ((
__n‹ëu∫__
));

496 
	`©exô
 ((*
__func
Ë()Ë
__THROW
 
	`__n⁄nuŒ
 ((1));

498 #i‡
deföed
 
__USE_ISOC11
 || deföed 
__USE_ISOCXX11


500 #ifde‡
__˝lu•lus


501 "C++" 
	`©_quick_exô
 ((*
__func
) ())

502 
__THROW
 
	`__asm
 ("©_quick_exô"Ë
	`__n⁄nuŒ
 ((1));

504 
	`©_quick_exô
 ((*
__func
Ë()Ë
__THROW
 
	`__n⁄nuŒ
 ((1));

507 
__END_NAMESPACE_STD


509 #ifdef 
__USE_MISC


512 
	`⁄_exô
 ((*
__func
Ë(
__°©us
, *
__¨g
), *__arg)

513 
__THROW
 
	`__n⁄nuŒ
 ((1));

516 
__BEGIN_NAMESPACE_STD


520 
	$exô
 (
__°©us
Ë
__THROW
 
	`__©åibuã__
 ((
__n‹ëu∫__
));

522 #i‡
deföed
 
__USE_ISOC11
 || deföed 
__USE_ISOCXX11


526 
	$quick_exô
 (
__°©us
Ë
__THROW
 
	`__©åibuã__
 ((
__n‹ëu∫__
));

528 
__END_NAMESPACE_STD


530 #ifde‡
__USE_ISOC99


531 
__BEGIN_NAMESPACE_C99


534 
	$_Exô
 (
__°©us
Ë
__THROW
 
	`__©åibuã__
 ((
__n‹ëu∫__
));

535 
__END_NAMESPACE_C99


539 
__BEGIN_NAMESPACE_STD


541 *
	$gëív
 (c⁄° *
__«me
Ë
__THROW
 
	`__n⁄nuŒ
 ((1)Ë
__wur
;

542 
__END_NAMESPACE_STD


544 #ifde‡
__USE_GNU


547 *
	$£cuª_gëív
 (c⁄° *
__«me
)

548 
__THROW
 
	`__n⁄nuŒ
 ((1)Ë
__wur
;

551 #i‡
deföed
 
__USE_MISC
 || deföed 
__USE_XOPEN


555 
	$puãnv
 (*
__°rög
Ë
__THROW
 
	`__n⁄nuŒ
 ((1));

558 #ifde‡
__USE_XOPEN2K


561 
	$£ãnv
 (c⁄° *
__«me
, c⁄° *
__vÆue
, 
__ª∂a˚
)

562 
__THROW
 
	`__n⁄nuŒ
 ((2));

565 
	$un£ãnv
 (c⁄° *
__«me
Ë
__THROW
 
	`__n⁄nuŒ
 ((1));

568 #ifdef 
__USE_MISC


572 
	$˛óªnv
 (Ë
__THROW
;

576 #i‡
deföed
 
__USE_MISC
 \

577 || (
deföed
 
__USE_XOPEN_EXTENDED
 && !deföed 
__USE_XOPEN2K8
)

583 *
	$mkãmp
 (*
__ãm∂©e
Ë
__THROW
 
	`__n⁄nuŒ
 ((1));

586 #i‡
deföed
 
__USE_XOPEN_EXTENDED
 || deföed 
__USE_XOPEN2K8


595 #i‚de‡
__USE_FILE_OFFSET64


596 
	$mk°emp
 (*
__ãm∂©e
Ë
	`__n⁄nuŒ
 ((1)Ë
__wur
;

598 #ifde‡
__REDIRECT


599 
	`__REDIRECT
 (
mk°emp
, (*
__ãm∂©e
), 
mk°emp64
)

600 
	`__n⁄nuŒ
 ((1)Ë
__wur
;

602 
	#mk°emp
 
mk°emp64


	)

605 #ifde‡
__USE_LARGEFILE64


606 
	$mk°emp64
 (*
__ãm∂©e
Ë
	`__n⁄nuŒ
 ((1)Ë
__wur
;

610 #ifde‡
__USE_MISC


617 #i‚de‡
__USE_FILE_OFFSET64


618 
	$mk°emps
 (*
__ãm∂©e
, 
__suffixÀn
Ë
	`__n⁄nuŒ
 ((1)Ë
__wur
;

620 #ifde‡
__REDIRECT


621 
	`__REDIRECT
 (
mk°emps
, (*
__ãm∂©e
, 
__suffixÀn
),

622 
mk°emps64
Ë
	`__n⁄nuŒ
 ((1)Ë
__wur
;

624 
	#mk°emps
 
mk°emps64


	)

627 #ifde‡
__USE_LARGEFILE64


628 
	$mk°emps64
 (*
__ãm∂©e
, 
__suffixÀn
)

629 
	`__n⁄nuŒ
 ((1)Ë
__wur
;

633 #ifde‡
__USE_XOPEN2K8


639 *
	$mkdãmp
 (*
__ãm∂©e
Ë
__THROW
 
	`__n⁄nuŒ
 ((1)Ë
__wur
;

642 #ifde‡
__USE_GNU


649 #i‚de‡
__USE_FILE_OFFSET64


650 
	$mko°emp
 (*
__ãm∂©e
, 
__Êags
Ë
	`__n⁄nuŒ
 ((1)Ë
__wur
;

652 #ifde‡
__REDIRECT


653 
	`__REDIRECT
 (
mko°emp
, (*
__ãm∂©e
, 
__Êags
), 
mko°emp64
)

654 
	`__n⁄nuŒ
 ((1)Ë
__wur
;

656 
	#mko°emp
 
mko°emp64


	)

659 #ifde‡
__USE_LARGEFILE64


660 
	$mko°emp64
 (*
__ãm∂©e
, 
__Êags
Ë
	`__n⁄nuŒ
 ((1)Ë
__wur
;

669 #i‚de‡
__USE_FILE_OFFSET64


670 
	$mko°emps
 (*
__ãm∂©e
, 
__suffixÀn
, 
__Êags
)

671 
	`__n⁄nuŒ
 ((1)Ë
__wur
;

673 #ifde‡
__REDIRECT


674 
	`__REDIRECT
 (
mko°emps
, (*
__ãm∂©e
, 
__suffixÀn
,

675 
__Êags
), 
mko°emps64
)

676 
	`__n⁄nuŒ
 ((1)Ë
__wur
;

678 
	#mko°emps
 
mko°emps64


	)

681 #ifde‡
__USE_LARGEFILE64


682 
	$mko°emps64
 (*
__ãm∂©e
, 
__suffixÀn
, 
__Êags
)

683 
	`__n⁄nuŒ
 ((1)Ë
__wur
;

688 
__BEGIN_NAMESPACE_STD


693 
	$sy°em
 (c⁄° *
__comm™d
Ë
__wur
;

694 
__END_NAMESPACE_STD


697 #ifdef 
__USE_GNU


700 *
	$ˇn⁄iˇlize_fûe_«me
 (c⁄° *
__«me
)

701 
__THROW
 
	`__n⁄nuŒ
 ((1)Ë
__wur
;

704 #i‡
deföed
 
__USE_MISC
 || deföed 
__USE_XOPEN_EXTENDED


710 *
	$ªÆ∑th
 (c⁄° *
__ª°ri˘
 
__«me
,

711 *
__ª°ri˘
 
__ªsﬁved
Ë
__THROW
 
__wur
;

716 #i‚de‡
__COMPAR_FN_T


717 
	#__COMPAR_FN_T


	)

718 (*
	t__com∑r_‚_t
) (const *, const *);

720 #ifdef 
__USE_GNU


721 
__com∑r_‚_t
 
	tcom∑ris⁄_‚_t
;

724 #ifde‡
__USE_GNU


725 (*
	t__com∑r_d_‚_t
) (const *, const *, *);

728 
__BEGIN_NAMESPACE_STD


731 *
	$b£¨ch
 (c⁄° *
__key
, c⁄° *
__ba£
,

732 
size_t
 
__nmemb
, size_à
__size
, 
__com∑r_‚_t
 
__com∑r
)

733 
	`__n⁄nuŒ
 ((1, 2, 5)Ë
__wur
;

735 #ifde‡
__USE_EXTERN_INLINES


736 
	~<bôs/°dlib-b£¨ch.h
>

741 
	$qs‹t
 (*
__ba£
, 
size_t
 
__nmemb
, size_à
__size
,

742 
__com∑r_‚_t
 
__com∑r
Ë
	`__n⁄nuŒ
 ((1, 4));

743 #ifde‡
__USE_GNU


744 
	$qs‹t_r
 (*
__ba£
, 
size_t
 
__nmemb
, size_à
__size
,

745 
__com∑r_d_‚_t
 
__com∑r
, *
__¨g
)

746 
	`__n⁄nuŒ
 ((1, 4));

751 
	$abs
 (
__x
Ë
__THROW
 
	`__©åibuã__
 ((
__c⁄°__
)Ë
__wur
;

752 
	$œbs
 (
__x
Ë
__THROW
 
	`__©åibuã__
 ((
__c⁄°__
)Ë
__wur
;

753 
__END_NAMESPACE_STD


755 #ifde‡
__USE_ISOC99


756 
__exãnsi⁄__
 
	$Œabs
 (
__x
)

757 
__THROW
 
	`__©åibuã__
 ((
__c⁄°__
)Ë
__wur
;

761 
__BEGIN_NAMESPACE_STD


765 
div_t
 
	$div
 (
__numî
, 
__díom
)

766 
__THROW
 
	`__©åibuã__
 ((
__c⁄°__
)Ë
__wur
;

767 
ldiv_t
 
	$ldiv
 (
__numî
, 
__díom
)

768 
__THROW
 
	`__©åibuã__
 ((
__c⁄°__
)Ë
__wur
;

769 
__END_NAMESPACE_STD


771 #ifde‡
__USE_ISOC99


772 
__BEGIN_NAMESPACE_C99


773 
__exãnsi⁄__
 
Œdiv_t
 
	$Œdiv
 (
__numî
,

774 
__díom
)

775 
__THROW
 
	`__©åibuã__
 ((
__c⁄°__
)Ë
__wur
;

776 
__END_NAMESPACE_C99


780 #i‡(
deföed
 
__USE_XOPEN_EXTENDED
 && !deföed 
__USE_XOPEN2K8
) \

781 || 
deföed
 
__USE_MISC


788 *
	$ecvt
 (
__vÆue
, 
__ndigô
, *
__ª°ri˘
 
__de˝t
,

789 *
__ª°ri˘
 
__sign
Ë
__THROW
 
	`__n⁄nuŒ
 ((3, 4)Ë
__wur
;

794 *
	$fcvt
 (
__vÆue
, 
__ndigô
, *
__ª°ri˘
 
__de˝t
,

795 *
__ª°ri˘
 
__sign
Ë
__THROW
 
	`__n⁄nuŒ
 ((3, 4)Ë
__wur
;

800 *
	$gcvt
 (
__vÆue
, 
__ndigô
, *
__buf
)

801 
__THROW
 
	`__n⁄nuŒ
 ((3)Ë
__wur
;

804 #ifde‡
__USE_MISC


806 *
	$qecvt
 (
__vÆue
, 
__ndigô
,

807 *
__ª°ri˘
 
__de˝t
, *__ª°ri˘ 
__sign
)

808 
__THROW
 
	`__n⁄nuŒ
 ((3, 4)Ë
__wur
;

809 *
	$qfcvt
 (
__vÆue
, 
__ndigô
,

810 *
__ª°ri˘
 
__de˝t
, *__ª°ri˘ 
__sign
)

811 
__THROW
 
	`__n⁄nuŒ
 ((3, 4)Ë
__wur
;

812 *
	$qgcvt
 (
__vÆue
, 
__ndigô
, *
__buf
)

813 
__THROW
 
	`__n⁄nuŒ
 ((3)Ë
__wur
;

818 
	$ecvt_r
 (
__vÆue
, 
__ndigô
, *
__ª°ri˘
 
__de˝t
,

819 *
__ª°ri˘
 
__sign
, *__ª°ri˘ 
__buf
,

820 
size_t
 
__Àn
Ë
__THROW
 
	`__n⁄nuŒ
 ((3, 4, 5));

821 
	$fcvt_r
 (
__vÆue
, 
__ndigô
, *
__ª°ri˘
 
__de˝t
,

822 *
__ª°ri˘
 
__sign
, *__ª°ri˘ 
__buf
,

823 
size_t
 
__Àn
Ë
__THROW
 
	`__n⁄nuŒ
 ((3, 4, 5));

825 
	$qecvt_r
 (
__vÆue
, 
__ndigô
,

826 *
__ª°ri˘
 
__de˝t
, *__ª°ri˘ 
__sign
,

827 *
__ª°ri˘
 
__buf
, 
size_t
 
__Àn
)

828 
__THROW
 
	`__n⁄nuŒ
 ((3, 4, 5));

829 
	$qfcvt_r
 (
__vÆue
, 
__ndigô
,

830 *
__ª°ri˘
 
__de˝t
, *__ª°ri˘ 
__sign
,

831 *
__ª°ri˘
 
__buf
, 
size_t
 
__Àn
)

832 
__THROW
 
	`__n⁄nuŒ
 ((3, 4, 5));

836 
__BEGIN_NAMESPACE_STD


839 
	$mbÀn
 (c⁄° *
__s
, 
size_t
 
__n
Ë
__THROW
;

842 
	$mbtowc
 (
wch¨_t
 *
__ª°ri˘
 
__pwc
,

843 c⁄° *
__ª°ri˘
 
__s
, 
size_t
 
__n
Ë
__THROW
;

846 
	$w˘omb
 (*
__s
, 
wch¨_t
 
__wch¨
Ë
__THROW
;

850 
size_t
 
	$mb°owcs
 (
wch¨_t
 *
__ª°ri˘
 
__pwcs
,

851 c⁄° *
__ª°ri˘
 
__s
, 
size_t
 
__n
Ë
__THROW
;

853 
size_t
 
	$wc°ombs
 (*
__ª°ri˘
 
__s
,

854 c⁄° 
wch¨_t
 *
__ª°ri˘
 
__pwcs
, 
size_t
 
__n
)

855 
__THROW
;

856 
__END_NAMESPACE_STD


859 #ifde‡
__USE_MISC


864 
	$Ωm©ch
 (c⁄° *
__ª•⁄£
Ë
__THROW
 
	`__n⁄nuŒ
 ((1)Ë
__wur
;

868 #i‡
deföed
 
__USE_XOPEN_EXTENDED
 || deföed 
__USE_XOPEN2K8


875 
	$gësub›t
 (**
__ª°ri˘
 
__›ti⁄p
,

876 *c⁄° *
__ª°ri˘
 
__tokís
,

877 **
__ª°ri˘
 
__vÆuï
)

878 
__THROW
 
	`__n⁄nuŒ
 ((1, 2, 3)Ë
__wur
;

882 #ifde‡
__USE_XOPEN


884 
	$£tkey
 (c⁄° *
__key
Ë
__THROW
 
	`__n⁄nuŒ
 ((1));

890 #ifde‡
__USE_XOPEN2KXSI


892 
	$posix_›í±
 (
__oÊag
Ë
__wur
;

895 #ifde‡
__USE_XOPEN_EXTENDED


900 
	$gø¡±
 (
__fd
Ë
__THROW
;

904 
	$u∆ock±
 (
__fd
Ë
__THROW
;

909 *
	$±¢ame
 (
__fd
Ë
__THROW
 
__wur
;

912 #ifde‡
__USE_GNU


916 
	$±¢ame_r
 (
__fd
, *
__buf
, 
size_t
 
__buÊí
)

917 
__THROW
 
	`__n⁄nuŒ
 ((2));

920 
	`gë±
 ();

923 #ifde‡
__USE_MISC


927 
	$gëlﬂdavg
 (
__lﬂdavg
[], 
__√Àm
)

928 
__THROW
 
	`__n⁄nuŒ
 ((1));

931 #i‡
deföed
 
__USE_XOPEN_EXTENDED
 && !deföed 
__USE_XOPEN2K


934 
	$ây¶Ÿ
 (Ë
__THROW
;

937 
	~<bôs/°dlib-Êﬂt.h
>

940 #i‡
__USE_FORTIFY_LEVEL
 > 0 && 
deföed
 
__f‹tify_fun˘i⁄


941 
	~<bôs/°dlib.h
>

943 #ifde‡
__LDBL_COMPAT


944 
	~<bôs/°dlib-ldbl.h
>

948 #unde‡
__√ed_mÆloc_™d_ˇŒoc


950 
__END_DECLS


	@/usr/include/string.h

22 #i‚def 
_STRING_H


23 
	#_STRING_H
 1

	)

25 
	#__GLIBC_INTERNAL_STARTING_HEADER_IMPLEMENTATION


	)

26 
	~<bôs/libc-hódî-°¨t.h
>

28 
	g__BEGIN_DECLS


31 
	#__√ed_size_t


	)

32 
	#__√ed_NULL


	)

33 
	~<°ddef.h
>

36 #i‡
deföed
 
__˝lu•lus
 && 
__GNUC_PREREQ
 (4, 4)

37 
	#__CORRECT_ISO_CPP_STRING_H_PROTO


	)

41 
__BEGIN_NAMESPACE_STD


43 *
	$mem˝y
 (*
__ª°ri˘
 
__de°
, c⁄° *__ª°ri˘ 
__§c
,

44 
size_t
 
__n
Ë
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

47 *
	$memmove
 (*
__de°
, c⁄° *
__§c
, 
size_t
 
__n
)

48 
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

49 
__END_NAMESPACE_STD


54 #i‡
deföed
 
__USE_MISC
 || deföed 
__USE_XOPEN


55 *
	$memc˝y
 (*
__ª°ri˘
 
__de°
, c⁄° *__ª°ri˘ 
__§c
,

56 
__c
, 
size_t
 
__n
)

57 
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

61 
__BEGIN_NAMESPACE_STD


63 *
	$mem£t
 (*
__s
, 
__c
, 
size_t
 
__n
Ë
__THROW
 
	`__n⁄nuŒ
 ((1));

66 
	$memcmp
 (c⁄° *
__s1
, c⁄° *
__s2
, 
size_t
 
__n
)

67 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

70 #ifde‡
__CORRECT_ISO_CPP_STRING_H_PROTO


73 *
	`memchr
 (*
__s
, 
__c
, 
size_t
 
__n
)

74 
__THROW
 
	`__asm
 ("memchr"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

75 c⁄° *
	`memchr
 (c⁄° *
__s
, 
__c
, 
size_t
 
__n
)

76 
__THROW
 
	`__asm
 ("memchr"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

78 #ifde‡
__OPTIMIZE__


79 
__exã∫_Æways_ölöe
 *

80 
	`memchr
 (*
__s
, 
__c
, 
size_t
 
__n
Ë
__THROW


82  
	`__buûtö_memchr
 (
__s
, 
__c
, 
__n
);

85 
__exã∫_Æways_ölöe
 const *

86 
	`memchr
 (c⁄° *
__s
, 
__c
, 
size_t
 
__n
Ë
__THROW


88  
	`__buûtö_memchr
 (
__s
, 
__c
, 
__n
);

91 
	}
}

93 *
	$memchr
 (c⁄° *
__s
, 
__c
, 
size_t
 
__n
)

94 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

96 
__END_NAMESPACE_STD


98 #ifde‡
__USE_GNU


101 #ifde‡
__CORRECT_ISO_CPP_STRING_H_PROTO


102 "C++" *
	$øwmemchr
 (*
__s
, 
__c
)

103 
__THROW
 
	`__asm
 ("øwmemchr"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

104 "C++" c⁄° *
	$øwmemchr
 (c⁄° *
__s
, 
__c
)

105 
__THROW
 
	`__asm
 ("øwmemchr"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

107 *
	$øwmemchr
 (c⁄° *
__s
, 
__c
)

108 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

112 #ifde‡
__CORRECT_ISO_CPP_STRING_H_PROTO


113 "C++" *
	$memrchr
 (*
__s
, 
__c
, 
size_t
 
__n
)

114 
__THROW
 
	`__asm
 ("memrchr"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

115 "C++" c⁄° *
	$memrchr
 (c⁄° *
__s
, 
__c
, 
size_t
 
__n
)

116 
__THROW
 
	`__asm
 ("memrchr"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

118 *
	$memrchr
 (c⁄° *
__s
, 
__c
, 
size_t
 
__n
)

119 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

124 
__BEGIN_NAMESPACE_STD


126 *
	$°r˝y
 (*
__ª°ri˘
 
__de°
, c⁄° *__ª°ri˘ 
__§c
)

127 
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

129 *
	$°∫˝y
 (*
__ª°ri˘
 
__de°
,

130 c⁄° *
__ª°ri˘
 
__§c
, 
size_t
 
__n
)

131 
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

134 *
	$°rˇt
 (*
__ª°ri˘
 
__de°
, c⁄° *__ª°ri˘ 
__§c
)

135 
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

137 *
	$°∫ˇt
 (*
__ª°ri˘
 
__de°
, c⁄° *__ª°ri˘ 
__§c
,

138 
size_t
 
__n
Ë
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

141 
	$°rcmp
 (c⁄° *
__s1
, c⁄° *
__s2
)

142 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

144 
	$°∫cmp
 (c⁄° *
__s1
, c⁄° *
__s2
, 
size_t
 
__n
)

145 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

148 
	$°rcﬁl
 (c⁄° *
__s1
, c⁄° *
__s2
)

149 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

151 
size_t
 
	$°rx‰m
 (*
__ª°ri˘
 
__de°
,

152 c⁄° *
__ª°ri˘
 
__§c
, 
size_t
 
__n
)

153 
__THROW
 
	`__n⁄nuŒ
 ((2));

154 
__END_NAMESPACE_STD


156 #ifde‡
__USE_XOPEN2K8


157 
	~<xloˇÀ.h
>

160 
	$°rcﬁl_l
 (c⁄° *
__s1
, c⁄° *
__s2
, 
__loˇÀ_t
 
__l
)

161 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2, 3));

164 
size_t
 
	$°rx‰m_l
 (*
__de°
, c⁄° *
__§c
, 
size_t
 
__n
,

165 
__loˇÀ_t
 
__l
Ë
__THROW
 
	`__n⁄nuŒ
 ((2, 4));

168 #i‡(
deföed
 
__USE_XOPEN_EXTENDED
 || deföed 
__USE_XOPEN2K8
 \

169 || 
	$__GLIBC_USE
 (
LIB_EXT2
))

171 *
	$°rdup
 (c⁄° *
__s
)

172 
__THROW
 
__©åibuã_mÆloc__
 
	`__n⁄nuŒ
 ((1));

178 #i‡
deföed
 
__USE_XOPEN2K8
 || 
	`__GLIBC_USE
 (
LIB_EXT2
)

179 *
	$°∫dup
 (c⁄° *
__°rög
, 
size_t
 
__n
)

180 
__THROW
 
__©åibuã_mÆloc__
 
	`__n⁄nuŒ
 ((1));

183 #i‡
deföed
 
__USE_GNU
 && deföed 
__GNUC__


185 
	#°rdu∑
(
s
) \

186 (
__exãnsi⁄__
 \

188 c⁄° *
__ﬁd
 = (
s
); \

189 
size_t
 
__Àn
 = 
	`°æí
 (
__ﬁd
) + 1; \

190 *
__√w
 = (*Ë
	`__buûtö_Æloˇ
 (
__Àn
); \

191 (*Ë
	`mem˝y
 (
__√w
, 
__ﬁd
, 
__Àn
); \

192 
	}
}))

	)

195 
	#°∫du∑
(
s
, 
n
) \

196 (
__exãnsi⁄__
 \

198 c⁄° *
__ﬁd
 = (
s
); \

199 
size_t
 
__Àn
 = 
	`°∫Àn
 (
__ﬁd
, (
n
)); \

200 *
__√w
 = (*Ë
	`__buûtö_Æloˇ
 (
__Àn
 + 1); \

201 
__√w
[
__Àn
] = '\0'; \

202 (*Ë
	`mem˝y
 (
__√w
, 
__ﬁd
, 
__Àn
); \

203 }))

	)

206 
	g__BEGIN_NAMESPACE_STD


208 #ifde‡
__CORRECT_ISO_CPP_STRING_H_PROTO


211 *
°rchr
 (*
__s
, 
__c
)

212 
__THROW
 
__asm
 ("°rchr"Ë
__©åibuã_puª__
 
__n⁄nuŒ
 ((1));

213 c⁄° *
°rchr
 (c⁄° *
__s
, 
__c
)

214 
__THROW
 
__asm
 ("°rchr"Ë
__©åibuã_puª__
 
__n⁄nuŒ
 ((1));

216 #ifde‡
__OPTIMIZE__


217 
__exã∫_Æways_ölöe
 *

218 
°rchr
 (*
__s
, 
__c
Ë
	g__THROW


220  
__buûtö_°rchr
 (
__s
, 
__c
);

223 
__exã∫_Æways_ölöe
 const *

224 
°rchr
 (c⁄° *
__s
, 
__c
Ë
	g__THROW


226  
__buûtö_°rchr
 (
__s
, 
__c
);

231 *
	$°rchr
 (c⁄° *
__s
, 
__c
)

232 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

235 #ifde‡
__CORRECT_ISO_CPP_STRING_H_PROTO


238 *
	`°ºchr
 (*
__s
, 
__c
)

239 
__THROW
 
	`__asm
 ("°ºchr"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

240 c⁄° *
	`°ºchr
 (c⁄° *
__s
, 
__c
)

241 
__THROW
 
	`__asm
 ("°ºchr"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

243 #ifde‡
__OPTIMIZE__


244 
__exã∫_Æways_ölöe
 *

245 
	`°ºchr
 (*
__s
, 
__c
Ë
__THROW


247  
	`__buûtö_°ºchr
 (
__s
, 
__c
);

250 
__exã∫_Æways_ölöe
 const *

251 
	`°ºchr
 (c⁄° *
__s
, 
__c
Ë
__THROW


253  
	`__buûtö_°ºchr
 (
__s
, 
__c
);

256 
	}
}

258 *
	$°ºchr
 (c⁄° *
__s
, 
__c
)

259 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

261 
__END_NAMESPACE_STD


263 #ifde‡
__USE_GNU


266 #ifde‡
__CORRECT_ISO_CPP_STRING_H_PROTO


267 "C++" *
	$°rch∫ul
 (*
__s
, 
__c
)

268 
__THROW
 
	`__asm
 ("°rch∫ul"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

269 "C++" c⁄° *
	$°rch∫ul
 (c⁄° *
__s
, 
__c
)

270 
__THROW
 
	`__asm
 ("°rch∫ul"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

272 *
	$°rch∫ul
 (c⁄° *
__s
, 
__c
)

273 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

277 
__BEGIN_NAMESPACE_STD


280 
size_t
 
	$°rc•n
 (c⁄° *
__s
, c⁄° *
__ªje˘
)

281 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

284 
size_t
 
	$°r•n
 (c⁄° *
__s
, c⁄° *
__ac˚±
)

285 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

287 #ifde‡
__CORRECT_ISO_CPP_STRING_H_PROTO


290 *
	`°Ωbrk
 (*
__s
, c⁄° *
__ac˚±
)

291 
__THROW
 
	`__asm
 ("°Ωbrk"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

292 c⁄° *
	`°Ωbrk
 (c⁄° *
__s
, c⁄° *
__ac˚±
)

293 
__THROW
 
	`__asm
 ("°Ωbrk"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

295 #ifde‡
__OPTIMIZE__


296 
__exã∫_Æways_ölöe
 *

297 
	`°Ωbrk
 (*
__s
, c⁄° *
__ac˚±
Ë
__THROW


299  
	`__buûtö_°Ωbrk
 (
__s
, 
__ac˚±
);

302 
__exã∫_Æways_ölöe
 const *

303 
	`°Ωbrk
 (c⁄° *
__s
, c⁄° *
__ac˚±
Ë
__THROW


305  
	`__buûtö_°Ωbrk
 (
__s
, 
__ac˚±
);

308 
	}
}

310 *
	$°Ωbrk
 (c⁄° *
__s
, c⁄° *
__ac˚±
)

311 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

314 #ifde‡
__CORRECT_ISO_CPP_STRING_H_PROTO


317 *
	`°r°r
 (*
__hay°ack
, c⁄° *
__√edÀ
)

318 
__THROW
 
	`__asm
 ("°r°r"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

319 c⁄° *
	`°r°r
 (c⁄° *
__hay°ack
, c⁄° *
__√edÀ
)

320 
__THROW
 
	`__asm
 ("°r°r"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

322 #ifde‡
__OPTIMIZE__


323 
__exã∫_Æways_ölöe
 *

324 
	`°r°r
 (*
__hay°ack
, c⁄° *
__√edÀ
Ë
__THROW


326  
	`__buûtö_°r°r
 (
__hay°ack
, 
__√edÀ
);

329 
__exã∫_Æways_ölöe
 const *

330 
	`°r°r
 (c⁄° *
__hay°ack
, c⁄° *
__√edÀ
Ë
__THROW


332  
	`__buûtö_°r°r
 (
__hay°ack
, 
__√edÀ
);

335 
	}
}

337 *
	$°r°r
 (c⁄° *
__hay°ack
, c⁄° *
__√edÀ
)

338 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

343 *
	$°πok
 (*
__ª°ri˘
 
__s
, c⁄° *__ª°ri˘ 
__dñim
)

344 
__THROW
 
	`__n⁄nuŒ
 ((2));

345 
__END_NAMESPACE_STD


349 *
	$__°πok_r
 (*
__ª°ri˘
 
__s
,

350 c⁄° *
__ª°ri˘
 
__dñim
,

351 **
__ª°ri˘
 
__ßve_±r
)

352 
__THROW
 
	`__n⁄nuŒ
 ((2, 3));

353 #ifde‡
__USE_POSIX


354 *
	$°πok_r
 (*
__ª°ri˘
 
__s
, c⁄° *__ª°ri˘ 
__dñim
,

355 **
__ª°ri˘
 
__ßve_±r
)

356 
__THROW
 
	`__n⁄nuŒ
 ((2, 3));

359 #ifde‡
__USE_GNU


361 #ifde‡
__CORRECT_ISO_CPP_STRING_H_PROTO


362 "C++" *
	$°rˇ£°r
 (*
__hay°ack
, c⁄° *
__√edÀ
)

363 
__THROW
 
	`__asm
 ("°rˇ£°r"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

364 "C++" c⁄° *
	$°rˇ£°r
 (c⁄° *
__hay°ack
,

365 c⁄° *
__√edÀ
)

366 
__THROW
 
	`__asm
 ("°rˇ£°r"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

368 *
	$°rˇ£°r
 (c⁄° *
__hay°ack
, c⁄° *
__√edÀ
)

369 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

373 #ifde‡
__USE_GNU


377 *
	$memmem
 (c⁄° *
__hay°ack
, 
size_t
 
__hay°ackÀn
,

378 c⁄° *
__√edÀ
, 
size_t
 
__√edÀÀn
)

379 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 3));

383 *
	$__memp˝y
 (*
__ª°ri˘
 
__de°
,

384 c⁄° *
__ª°ri˘
 
__§c
, 
size_t
 
__n
)

385 
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

386 *
	$memp˝y
 (*
__ª°ri˘
 
__de°
,

387 c⁄° *
__ª°ri˘
 
__§c
, 
size_t
 
__n
)

388 
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

392 
__BEGIN_NAMESPACE_STD


394 
size_t
 
	$°æí
 (c⁄° *
__s
)

395 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

396 
__END_NAMESPACE_STD


398 #ifdef 
__USE_XOPEN2K8


401 
size_t
 
	$°∫Àn
 (c⁄° *
__°rög
, 
size_t
 
__maxÀn
)

402 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

406 
__BEGIN_NAMESPACE_STD


408 *
	$°ªº‹
 (
__î∫um
Ë
__THROW
;

409 
__END_NAMESPACE_STD


410 #ifde‡
__USE_XOPEN2K


418 #i‡
deföed
 
__USE_XOPEN2K
 && !deföed 
__USE_GNU


421 #ifde‡
__REDIRECT_NTH


422 
	`__REDIRECT_NTH
 (
°ªº‹_r
,

423 (
__î∫um
, *
__buf
, 
size_t
 
__buÊí
),

424 
__xpg_°ªº‹_r
Ë
	`__n⁄nuŒ
 ((2));

426 
	$__xpg_°ªº‹_r
 (
__î∫um
, *
__buf
, 
size_t
 
__buÊí
)

427 
__THROW
 
	`__n⁄nuŒ
 ((2));

428 
	#°ªº‹_r
 
__xpg_°ªº‹_r


	)

433 *
	$°ªº‹_r
 (
__î∫um
, *
__buf
, 
size_t
 
__buÊí
)

434 
__THROW
 
	`__n⁄nuŒ
 ((2)Ë
__wur
;

438 #ifde‡
__USE_XOPEN2K8


440 *
	$°ªº‹_l
 (
__î∫um
, 
__loˇÀ_t
 
__l
Ë
__THROW
;

446 
	$__bzîo
 (*
__s
, 
size_t
 
__n
Ë
__THROW
 
	`__n⁄nuŒ
 ((1));

448 #ifde‡
__USE_MISC


450 
	$bc›y
 (c⁄° *
__§c
, *
__de°
, 
size_t
 
__n
)

451 
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

454 
	$bzîo
 (*
__s
, 
size_t
 
__n
Ë
__THROW
 
	`__n⁄nuŒ
 ((1));

458 
	$ex∂icô_bzîo
 (*
__s
, 
size_t
 
__n
Ë
__THROW
 
	`__n⁄nuŒ
 ((1));

461 
	$bcmp
 (c⁄° *
__s1
, c⁄° *
__s2
, 
size_t
 
__n
)

462 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

465 #ifde‡
__CORRECT_ISO_CPP_STRING_H_PROTO


468 *
	`ödex
 (*
__s
, 
__c
)

469 
__THROW
 
	`__asm
 ("ödex"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

470 c⁄° *
	`ödex
 (c⁄° *
__s
, 
__c
)

471 
__THROW
 
	`__asm
 ("ödex"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

473 #i‡
deföed
 
__OPTIMIZE__
 && !deföed 
__CORRECT_ISO_CPP_STRINGS_H_PROTO


474 
__exã∫_Æways_ölöe
 *

475 
	`ödex
 (*
__s
, 
__c
Ë
__THROW


477  
	`__buûtö_ödex
 (
__s
, 
__c
);

480 
__exã∫_Æways_ölöe
 const *

481 
	`ödex
 (c⁄° *
__s
, 
__c
Ë
__THROW


483  
	`__buûtö_ödex
 (
__s
, 
__c
);

486 
	}
}

488 *
	$ödex
 (c⁄° *
__s
, 
__c
)

489 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

493 #ifde‡
__CORRECT_ISO_CPP_STRING_H_PROTO


496 *
	`rödex
 (*
__s
, 
__c
)

497 
__THROW
 
	`__asm
 ("rödex"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

498 c⁄° *
	`rödex
 (c⁄° *
__s
, 
__c
)

499 
__THROW
 
	`__asm
 ("rödex"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

501 #i‡
deföed
 
__OPTIMIZE__
 && !deföed 
__CORRECT_ISO_CPP_STRINGS_H_PROTO


502 
__exã∫_Æways_ölöe
 *

503 
	`rödex
 (*
__s
, 
__c
Ë
__THROW


505  
	`__buûtö_rödex
 (
__s
, 
__c
);

508 
__exã∫_Æways_ölöe
 const *

509 
	`rödex
 (c⁄° *
__s
, 
__c
Ë
__THROW


511  
	`__buûtö_rödex
 (
__s
, 
__c
);

514 
	}
}

516 *
	$rödex
 (c⁄° *
__s
, 
__c
)

517 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

522 
	$ffs
 (
__i
Ë
__THROW
 
	`__©åibuã__
 ((
__c⁄°__
));

526 #ifdef 
__USE_GNU


527 
	$ff¶
 (
__l
Ë
__THROW
 
	`__©åibuã__
 ((
__c⁄°__
));

528 
__exãnsi⁄__
 
	$ff¶l
 (
__Œ
)

529 
__THROW
 
	`__©åibuã__
 ((
__c⁄°__
));

533 
	$°rˇ£cmp
 (c⁄° *
__s1
, c⁄° *
__s2
)

534 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

537 
	$°∫ˇ£cmp
 (c⁄° *
__s1
, c⁄° *
__s2
, 
size_t
 
__n
)

538 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

541 #ifdef 
__USE_GNU


544 
	$°rˇ£cmp_l
 (c⁄° *
__s1
, c⁄° *
__s2
,

545 
__loˇÀ_t
 
__loc
)

546 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2, 3));

548 
	$°∫ˇ£cmp_l
 (c⁄° *
__s1
, c⁄° *
__s2
,

549 
size_t
 
__n
, 
__loˇÀ_t
 
__loc
)

550 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2, 4));

553 #ifdef 
__USE_MISC


556 *
	$°r£p
 (**
__ª°ri˘
 
__°rögp
,

557 c⁄° *
__ª°ri˘
 
__dñim
)

558 
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

561 #ifdef 
__USE_XOPEN2K8


563 *
	$°rsig«l
 (
__sig
Ë
__THROW
;

566 *
	$__°p˝y
 (*
__ª°ri˘
 
__de°
, c⁄° *__ª°ri˘ 
__§c
)

567 
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

568 *
	$°p˝y
 (*
__ª°ri˘
 
__de°
, c⁄° *__ª°ri˘ 
__§c
)

569 
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

573 *
	$__°≤˝y
 (*
__ª°ri˘
 
__de°
,

574 c⁄° *
__ª°ri˘
 
__§c
, 
size_t
 
__n
)

575 
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

576 *
	$°≤˝y
 (*
__ª°ri˘
 
__de°
,

577 c⁄° *
__ª°ri˘
 
__§c
, 
size_t
 
__n
)

578 
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

581 #ifdef 
__USE_GNU


583 
	$°rvîscmp
 (c⁄° *
__s1
, c⁄° *
__s2
)

584 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

587 *
	$°r‰y
 (*
__°rög
Ë
__THROW
 
	`__n⁄nuŒ
 ((1));

590 *
	$mem‰ob
 (*
__s
, 
size_t
 
__n
Ë
__THROW
 
	`__n⁄nuŒ
 ((1));

592 #i‚de‡
ba£«me


597 #ifde‡
__CORRECT_ISO_CPP_STRING_H_PROTO


598 "C++" *
	$ba£«me
 (*
__fûíame
)

599 
__THROW
 
	`__asm
 ("ba£«me"Ë
	`__n⁄nuŒ
 ((1));

600 "C++" c⁄° *
	$ba£«me
 (c⁄° *
__fûíame
)

601 
__THROW
 
	`__asm
 ("ba£«me"Ë
	`__n⁄nuŒ
 ((1));

603 *
	$ba£«me
 (c⁄° *
__fûíame
Ë
__THROW
 
	`__n⁄nuŒ
 ((1));

609 #i‡
	`__GNUC_PREREQ
 (3,4)

610 #i‡
deföed
 
__OPTIMIZE__
 && !deföed 
__OPTIMIZE_SIZE__
 \

611 && !
deföed
 
__NO_INLINE__
 && !deföed 
__˝lu•lus


631 
	~<bôs/°rög.h
>

634 
	~<bôs/°rög2.h
>

637 #i‡
__USE_FORTIFY_LEVEL
 > 0 && 
deföed
 
__f‹tify_fun˘i⁄


639 
	~<bôs/°rög3.h
>

643 #i‡
deföed
 
__USE_GNU
 && deföed 
__OPTIMIZE__
 \

644 && 
deföed
 
__exã∫_Æways_ölöe
 && 
	$__GNUC_PREREQ
 (3,2)

645 #i‡!
deföed
 
_FORCE_INLINES
 && !deföed 
_HAVE_STRING_ARCH_memp˝y


647 
	#memp˝y
(
de°
, 
§c
, 
n
Ë
	`__memp˝y_ölöe
 (de°, src,Ç)

	)

648 
	#__memp˝y
(
de°
, 
§c
, 
n
Ë
	`__memp˝y_ölöe
 (de°, src,Ç)

	)

650 
__exã∫_Æways_ölöe
 *

651 
	$__memp˝y_ölöe
 (*
__ª°ri˘
 
__de°
,

652 c⁄° *
__ª°ri˘
 
__§c
, 
size_t
 
__n
)

654  (*Ë
	`mem˝y
 (
__de°
, 
__§c
, 
__n
) + __n;

655 
	}
}

660 
	g__END_DECLS


	@/usr/include/alloca.h

18 #i‚def 
_ALLOCA_H


19 
	#_ALLOCA_H
 1

	)

21 
	~<„©uªs.h
>

23 
	#__√ed_size_t


	)

24 
	~<°ddef.h
>

26 
	g__BEGIN_DECLS


29 #unde‡
Æloˇ


32 *
	$Æloˇ
 (
size_t
 
__size
Ë
__THROW
;

34 #ifdef 
__GNUC__


35 
	#Æloˇ
(
size
Ë
	`__buûtö_Æloˇ
 (size)

	)

38 
__END_DECLS


	@/usr/include/asm/errno.h

1 
	~<asm-gíîic/î∫o.h
>

	@/usr/include/asm/types.h

1 #i‚de‡
_ASM_X86_TYPES_H


2 
	#_ASM_X86_TYPES_H


	)

4 
	~<asm-gíîic/ty≥s.h
>

	@/usr/include/bits/byteswap.h

19 #i‡!
deföed
 
_BYTESWAP_H
 && !deföed 
_NETINET_IN_H
 && !deföed 
_ENDIAN_H


23 #i‚de‡
_BITS_BYTESWAP_H


24 
	#_BITS_BYTESWAP_H
 1

	)

26 
	~<„©uªs.h
>

27 
	~<bôs/ty≥s.h
>

28 
	~<bôs/w‹dsize.h
>

31 
	#__bsw≠_c⁄°™t_16
(
x
) \

32 ((Ë((((
x
Ë>> 8Ë& 0xffË| (((xË& 0xffË<< 8)))

	)

35 
	~<bôs/byãsw≠-16.h
>

38 
	#__bsw≠_c⁄°™t_32
(
x
) \

39 ((((
x
) & 0xff000000) >> 24) | (((x) & 0x00ff0000) >> 8) | \

40 (((
x
Ë& 0x0000ff00Ë<< 8Ë| (((xË& 0x000000ffË<< 24))

	)

42 #ifde‡
__GNUC__


43 #i‡
__GNUC_PREREQ
 (4, 3)

44 
__ölöe
 

45 
	$__bsw≠_32
 (
__bsx
)

47  
	`__buûtö_bsw≠32
 (
__bsx
);

48 
	}
}

49 #ñi‡
__GNUC__
 >= 2

50 #i‡
__WORDSIZE
 =64 || (
deföed
 
__i486__
 || deföed 
__≥¡ium__
 \

51 || 
deföed
 
	g__≥¡ium¥o__
 || deföed 
	g__≥¡ium4__
 \

52 || 
deföed
 
	g__k8__
 || deföed 
	g__©hl⁄__
 \

53 || 
deföed
 
	g__k6__
 || deföed 
	g__noc⁄a__
 \

54 || 
deföed
 
	g__c‹e2__
 || deföed 
	g__geode__
 \

55 || 
deföed
 
	g__amdÁm10__
)

58 
	#__bsw≠_32
(
x
) \

59 (
__exãnsi⁄__
 \

60 ({ 
__v
, 
__x
 = (
x
); \

61 i‡(
	`__buûtö_c⁄°™t_p
 (
__x
)) \

62 
__v
 = 
	`__bsw≠_c⁄°™t_32
 (
__x
); \

64 
	`__asm__
 ("bsw≠ %0" : "Ù" (
__v
Ë: "0" (
__x
)); \

65 
__v
; }))

	)

67 
	#__bsw≠_32
(
x
) \

68 (
__exãnsi⁄__
 \

69 ({ 
__v
, 
__x
 = (
x
); \

70 i‡(
	`__buûtö_c⁄°™t_p
 (
__x
)) \

71 
__v
 = 
	`__bsw≠_c⁄°™t_32
 (
__x
); \

73 
	`__asm__
 ("rorw $8, %w0;" \

76 : "Ù" (
__v
) \

77 : "0" (
__x
) \

79 
__v
; }))

	)

82 
	#__bsw≠_32
(
x
) \

83 (
__exãnsi⁄__
 \

84 ({ 
__x
 = (
x
); 
	`__bsw≠_c⁄°™t_32
 (__x); }))

	)

87 
__ölöe
 

88 
	$__bsw≠_32
 (
__bsx
)

90  
	`__bsw≠_c⁄°™t_32
 (
__bsx
);

91 
	}
}

95 #i‡
__GNUC_PREREQ
 (2, 0)

97 
	#__bsw≠_c⁄°™t_64
(
x
) \

98 (
	`__exãnsi⁄__
 ((((
x
) & 0xff00000000000000ull) >> 56) \

99 | (((
x
) & 0x00ff000000000000ull) >> 40) \

100 | (((
x
) & 0x0000ff0000000000ull) >> 24) \

101 | (((
x
) & 0x000000ff00000000ull) >> 8) \

102 | (((
x
) & 0x00000000ff000000ull) << 8) \

103 | (((
x
) & 0x0000000000ff0000ull) << 24) \

104 | (((
x
) & 0x000000000000ff00ull) << 40) \

105 | (((
x
Ë& 0x00000000000000ffuŒË<< 56)))

	)

107 #i‡
__GNUC_PREREQ
 (4, 3)

108 
__ölöe
 
__uöt64_t


109 
	$__bsw≠_64
 (
__uöt64_t
 
__bsx
)

111  
	`__buûtö_bsw≠64
 (
__bsx
);

112 
	}
}

113 #ñi‡
__WORDSIZE
 == 64

114 
	#__bsw≠_64
(
x
) \

115 (
__exãnsi⁄__
 \

116 ({ 
__uöt64_t
 
__v
, 
__x
 = (
x
); \

117 i‡(
	`__buûtö_c⁄°™t_p
 (
__x
)) \

118 
__v
 = 
	`__bsw≠_c⁄°™t_64
 (
__x
); \

120 
	`__asm__
 ("bsw≠ %q0" : "Ù" (
__v
Ë: "0" (
__x
)); \

121 
__v
; }))

	)

123 
	#__bsw≠_64
(
x
) \

124 (
__exãnsi⁄__
 \

125 ({ uni⁄ { 
__exãnsi⁄__
 
__uöt64_t
 
__Œ
; \

126 
__l
[2]; } 
__w
, 
__r
; \

127 i‡(
	`__buûtö_c⁄°™t_p
 (
x
)) \

128 
__r
.
__Œ
 = 
	`__bsw≠_c⁄°™t_64
 (
x
); \

131 
__w
.
__Œ
 = (
x
); \

132 
__r
.
__l
[0] = 
	`__bsw≠_32
 (
__w
.__l[1]); \

133 
__r
.
__l
[1] = 
	`__bsw≠_32
 (
__w
.__l[0]); \

135 
__r
.
__Œ
; }))

	)

138 
	#__bsw≠_c⁄°™t_64
(
x
) \

139 ((((
x
) & 0xff00000000000000ull) >> 56) \

140 | (((
x
) & 0x00ff000000000000ull) >> 40) \

141 | (((
x
) & 0x0000ff0000000000ull) >> 24) \

142 | (((
x
) & 0x000000ff00000000ull) >> 8) \

143 | (((
x
) & 0x00000000ff000000ull) << 8) \

144 | (((
x
) & 0x0000000000ff0000ull) << 24) \

145 | (((
x
) & 0x000000000000ff00ull) << 40) \

146 | (((
x
Ë& 0x00000000000000ffuŒË<< 56))

	)

148 
__ölöe
 
__uöt64_t


149 
	$__bsw≠_64
 (
__uöt64_t
 
__bsx
)

151  
	`__bsw≠_c⁄°™t_64
 (
__bsx
);

152 
	}
}

	@/usr/include/bits/endian.h

3 #i‚de‡
_ENDIAN_H


7 
	#__BYTE_ORDER
 
__LITTLE_ENDIAN


	)

	@/usr/include/bits/flt-eval-method.h

19 #i‚de‡
_MATH_H


23 #ifde‡
__FLT_EVAL_METHOD__


24 #i‡
__FLT_EVAL_METHOD__
 == -1

25 
	#__GLIBC_FLT_EVAL_METHOD
 2

	)

27 
	#__GLIBC_FLT_EVAL_METHOD
 
__FLT_EVAL_METHOD__


	)

29 #ñi‡
deföed
 
__x86_64__


30 
	#__GLIBC_FLT_EVAL_METHOD
 0

	)

32 
	#__GLIBC_FLT_EVAL_METHOD
 2

	)

	@/usr/include/bits/fp-fast.h

19 #i‚de‡
_MATH_H


23 #ifde‡
__USE_ISOC99


27 #ifde‡
__FP_FAST_FMA


28 
	#FP_FAST_FMA
 1

	)

31 #ifde‡
__FP_FAST_FMAF


32 
	#FP_FAST_FMAF
 1

	)

35 #ifde‡
__FP_FAST_FMAL


36 
	#FP_FAST_FMAL
 1

	)

	@/usr/include/bits/fp-logb.h

19 #i‚de‡
_MATH_H


23 
	#__FP_LOGB0_IS_MIN
 1

	)

24 
	#__FP_LOGBNAN_IS_MIN
 1

	)

	@/usr/include/bits/huge_val.h

20 #i‚de‡
_MATH_H


26 #i‡
__GNUC_PREREQ
(3,3)

27 
	#HUGE_VAL
 (
	`__buûtö_huge_vÆ
())

	)

28 #ñi‡
__GNUC_PREREQ
(2,96)

29 
	#HUGE_VAL
 (
__exãnsi⁄__
 0x1.0
p2047
)

	)

30 #ñi‡
deföed
 
__GNUC__


32 
	#HUGE_VAL
 \

33 (
__exãnsi⁄__
 \

34 ((uni⁄ { 
__l
 
	`__©åibuã__
((
	`__mode__
(
__DI__
))); 
__d
; }) \

35 { 
__l
: 0x7ff0000000000000ULL }).
__d
)

	)

39 
	~<ídün.h
>

41 uni⁄ { 
	m__c
[8]; 
	m__d
; } 
	t__huge_vÆ_t
;

43 #i‡
__BYTE_ORDER
 =
__BIG_ENDIAN


44 
	#__HUGE_VAL_byãs
 { 0x7f, 0xf0, 0, 0, 0, 0, 0, 0 }

	)

46 #i‡
__BYTE_ORDER
 =
__LITTLE_ENDIAN


47 
	#__HUGE_VAL_byãs
 { 0, 0, 0, 0, 0, 0, 0xf0, 0x7‡}

	)

50 
__huge_vÆ_t
 
	g__huge_vÆ
 = { 
__HUGE_VAL_byãs
 };

51 
	#HUGE_VAL
 (
__huge_vÆ
.
__d
)

	)

	@/usr/include/bits/huge_valf.h

20 #i‚de‡
_MATH_H


26 #i‡
__GNUC_PREREQ
(3,3)

27 
	#HUGE_VALF
 (
	`__buûtö_huge_vÆf
())

	)

28 #ñi‡
__GNUC_PREREQ
(2,96)

29 
	#HUGE_VALF
 (
__exãnsi⁄__
 0x1.0
p255f
)

	)

30 #ñi‡
deföed
 
__GNUC__


32 
	#HUGE_VALF
 \

33 (
__exãnsi⁄__
 \

34 ((uni⁄ { 
__l
 
	`__©åibuã__
((
	`__mode__
(
__SI__
))); 
__d
; }) \

35 { 
__l
: 0x7f800000UL }).
__d
)

	)

39 uni⁄ { 
	m__c
[4]; 
	m__f
; } 
	t__huge_vÆf_t
;

41 #i‡
__BYTE_ORDER
 =
__BIG_ENDIAN


42 
	#__HUGE_VALF_byãs
 { 0x7f, 0x80, 0, 0 }

	)

44 #i‡
__BYTE_ORDER
 =
__LITTLE_ENDIAN


45 
	#__HUGE_VALF_byãs
 { 0, 0, 0x80, 0x7‡}

	)

48 
__huge_vÆf_t
 
	g__huge_vÆf
 = { 
__HUGE_VALF_byãs
 };

49 
	#HUGE_VALF
 (
__huge_vÆf
.
__f
)

	)

	@/usr/include/bits/huge_vall.h

20 #i‚de‡
_MATH_H


24 #i‡
__GNUC_PREREQ
(3,3)

25 
	#HUGE_VALL
 (
	`__buûtö_huge_vÆl
())

	)

26 #ñi‡
__GNUC_PREREQ
(2,96)

27 
	#HUGE_VALL
 (
__exãnsi⁄__
 0x1.0
p32767L
)

	)

30 
	#__HUGE_VALL_byãs
 { 0, 0, 0, 0, 0, 0, 0, 0x80, 0xff, 0x7f, 0, 0 }

	)

32 
	#__huge_vÆl_t
 uni⁄ { 
__c
[12]; 
__ld
; }

	)

33 #ifde‡
__GNUC__


34 
	#HUGE_VALL
 (
__exãnsi⁄__
 \

35 ((
__huge_vÆl_t
Ë{ 
__c
: 
__HUGE_VALL_byãs
 }).
__ld
)

	)

37 
__huge_vÆl_t
 
	g__huge_vÆl
 = { 
__HUGE_VALL_byãs
 };

38 
	#HUGE_VALL
 (
__huge_vÆl
.
__ld
)

	)

	@/usr/include/bits/inf.h

19 #i‚de‡
_MATH_H


25 #i‡
__GNUC_PREREQ
(3,3)

26 
	#INFINITY
 (
	`__buûtö_öff
())

	)

28 
	#INFINITY
 
HUGE_VALF


	)

	@/usr/include/bits/iscanonical.h

19 #i‚de‡
_MATH_H


23 
	$__isˇn⁄iˇŒ
 (
__x
)

24 
__THROW
 
	`__©åibuã__
 ((
__c⁄°__
));

25 
	#__isˇn⁄iˇlf
(
x
Ë((Ë(
	`__ty≥of
 (x)Ë(x), 1)

	)

26 
	#__isˇn⁄iˇl
(
x
Ë((Ë(
	`__ty≥of
 (x)Ë(x), 1)

	)

34 
	#isˇn⁄iˇl
(
x
Ë
	`__MATH_TG
 ((x), 
__isˇn⁄iˇl
, (x))

	)

	@/usr/include/bits/libc-header-start.h

27 #i‚de‡
__GLIBC_INTERNAL_STARTING_HEADER_IMPLEMENTATION


31 #unde‡
__GLIBC_INTERNAL_STARTING_HEADER_IMPLEMENTATION


33 
	~<„©uªs.h
>

37 #unde‡
__GLIBC_USE_LIB_EXT2


38 #i‡(
deföed
 
__USE_GNU
 \

39 || (
deföed
 
	g__STDC_WANT_LIB_EXT2__
 && __STDC_WANT_LIB_EXT2__ > 0))

40 
	#__GLIBC_USE_LIB_EXT2
 1

	)

42 
	#__GLIBC_USE_LIB_EXT2
 0

	)

47 #unde‡
__GLIBC_USE_IEC_60559_BFP_EXT


48 #i‡
deföed
 
__USE_GNU
 || deföed 
__STDC_WANT_IEC_60559_BFP_EXT__


49 
	#__GLIBC_USE_IEC_60559_BFP_EXT
 1

	)

51 
	#__GLIBC_USE_IEC_60559_BFP_EXT
 0

	)

56 #unde‡
__GLIBC_USE_IEC_60559_FUNCS_EXT


57 #i‡
deföed
 
__USE_GNU
 || deföed 
__STDC_WANT_IEC_60559_FUNCS_EXT__


58 
	#__GLIBC_USE_IEC_60559_FUNCS_EXT
 1

	)

60 
	#__GLIBC_USE_IEC_60559_FUNCS_EXT
 0

	)

	@/usr/include/bits/math-finite.h

19 #i‚de‡
_MATH_H


24 
__REDIRECT_NTH
 (
acos
, (), 
__acos_föôe
);

25 #ifde‡
__USE_ISOC99


26 
__REDIRECT_NTH
 (
acosf
, (), 
__acosf_föôe
);

27 #ifde‡
__MATH_DECLARE_LDOUBLE


28 #ifde‡
__NO_LONG_DOUBLE_MATH


29 
__REDIRECT_NTH
 (
aco¶
, (), 
__acos_föôe
);

31 
__REDIRECT_NTH
 (
aco¶
, (), 
__aco¶_föôe
);

36 #i‡
deföed
 
__USE_XOPEN_EXTENDED
 || deföed 
__USE_ISOC99


38 
__REDIRECT_NTH
 (
acosh
, (), 
__acosh_föôe
);

40 #ifde‡
__USE_ISOC99


41 
__REDIRECT_NTH
 (
acoshf
, (), 
__acoshf_föôe
);

42 #ifde‡
__MATH_DECLARE_LDOUBLE


43 #ifde‡
__NO_LONG_DOUBLE_MATH


44 
__REDIRECT_NTH
 (
acoshl
, (), 
__acosh_föôe
);

46 
__REDIRECT_NTH
 (
acoshl
, (), 
__acoshl_föôe
);

52 
__REDIRECT_NTH
 (
asö
, (), 
__asö_föôe
);

53 #ifde‡
__USE_ISOC99


54 
__REDIRECT_NTH
 (
asöf
, (), 
__asöf_föôe
);

55 #ifde‡
__MATH_DECLARE_LDOUBLE


56 #ifde‡
__NO_LONG_DOUBLE_MATH


57 
__REDIRECT_NTH
 (
asöl
, (), 
__asö_föôe
);

59 
__REDIRECT_NTH
 (
asöl
, (), 
__asöl_föôe
);

65 
__REDIRECT_NTH
 (
©™2
, (, ), 
__©™2_föôe
);

66 #ifde‡
__USE_ISOC99


67 
__REDIRECT_NTH
 (
©™2f
, (, ), 
__©™2f_föôe
);

68 #ifde‡
__MATH_DECLARE_LDOUBLE


69 #ifde‡
__NO_LONG_DOUBLE_MATH


70 
__REDIRECT_NTH
 (
©™2l
, (, ),

71 
__©™2_föôe
);

73 
__REDIRECT_NTH
 (
©™2l
, (, ),

74 
__©™2l_föôe
);

79 #i‡
deföed
 
__USE_XOPEN_EXTENDED
 || deföed 
__USE_ISOC99


81 
__REDIRECT_NTH
 (
©™h
, (), 
__©™h_föôe
);

83 #ifde‡
__USE_ISOC99


84 
__REDIRECT_NTH
 (
©™hf
, (), 
__©™hf_föôe
);

85 #ifde‡
__MATH_DECLARE_LDOUBLE


86 #ifde‡
__NO_LONG_DOUBLE_MATH


87 
__REDIRECT_NTH
 (
©™hl
, (), 
__©™h_föôe
);

89 
__REDIRECT_NTH
 (
©™hl
, (), 
__©™hl_föôe
);

95 
__REDIRECT_NTH
 (
cosh
, (), 
__cosh_föôe
);

96 #ifde‡
__USE_ISOC99


97 
__REDIRECT_NTH
 (
coshf
, (), 
__coshf_föôe
);

98 #ifde‡
__MATH_DECLARE_LDOUBLE


99 #ifde‡
__NO_LONG_DOUBLE_MATH


100 
__REDIRECT_NTH
 (
coshl
, (), 
__cosh_föôe
);

102 
__REDIRECT_NTH
 (
coshl
, (), 
__coshl_föôe
);

108 
__REDIRECT_NTH
 (
exp
, (), 
__exp_föôe
);

109 #ifde‡
__USE_ISOC99


110 
__REDIRECT_NTH
 (
expf
, (), 
__expf_föôe
);

111 #ifde‡
__MATH_DECLARE_LDOUBLE


112 #ifde‡
__NO_LONG_DOUBLE_MATH


113 
__REDIRECT_NTH
 (
ex∂
, (), 
__exp_föôe
);

115 
__REDIRECT_NTH
 (
ex∂
, (), 
__ex∂_föôe
);

120 #ifde‡
__USE_GNU


122 
__REDIRECT_NTH
 (
exp10
, (), 
__exp10_föôe
);

123 
__REDIRECT_NTH
 (
exp10f
, (), 
__exp10f_föôe
);

124 #ifde‡
__MATH_DECLARE_LDOUBLE


125 #ifde‡
__NO_LONG_DOUBLE_MATH


126 
__REDIRECT_NTH
 (
exp10l
, (), 
__exp10_föôe
);

128 
__REDIRECT_NTH
 (
exp10l
, (), 
__exp10l_föôe
);

133 
__REDIRECT_NTH
 (
pow10
, (), 
__exp10_föôe
);

134 
__REDIRECT_NTH
 (
pow10f
, (), 
__exp10f_föôe
);

135 #ifde‡
__MATH_DECLARE_LDOUBLE


136 #ifde‡
__NO_LONG_DOUBLE_MATH


137 
__REDIRECT_NTH
 (
pow10l
, (), 
__exp10_föôe
);

139 
__REDIRECT_NTH
 (
pow10l
, (), 
__exp10l_föôe
);

144 #ifde‡
__USE_ISOC99


146 
__REDIRECT_NTH
 (
exp2
, (), 
__exp2_föôe
);

147 
__REDIRECT_NTH
 (
exp2f
, (), 
__exp2f_föôe
);

148 #ifde‡
__MATH_DECLARE_LDOUBLE


149 #ifde‡
__NO_LONG_DOUBLE_MATH


150 
__REDIRECT_NTH
 (
exp2l
, (), 
__exp2_föôe
);

152 
__REDIRECT_NTH
 (
exp2l
, (), 
__exp2l_föôe
);

158 
__REDIRECT_NTH
 (
fmod
, (, ), 
__fmod_föôe
);

159 #ifde‡
__USE_ISOC99


160 
__REDIRECT_NTH
 (
fmodf
, (, ), 
__fmodf_föôe
);

161 #ifde‡
__MATH_DECLARE_LDOUBLE


162 #ifde‡
__NO_LONG_DOUBLE_MATH


163 
__REDIRECT_NTH
 (
fmodl
, (, ),

164 
__fmod_föôe
);

166 
__REDIRECT_NTH
 (
fmodl
, (, ),

167 
__fmodl_föôe
);

172 #i‡
deföed
 
__USE_XOPEN
 || deföed 
__USE_ISOC99


174 
__REDIRECT_NTH
 (
hypŸ
, (, ), 
__hypŸ_föôe
);

176 #ifde‡
__USE_ISOC99


177 
__REDIRECT_NTH
 (
hypŸf
, (, ), 
__hypŸf_föôe
);

178 #ifde‡
__MATH_DECLARE_LDOUBLE


179 #ifde‡
__NO_LONG_DOUBLE_MATH


180 
__REDIRECT_NTH
 (
hypŸl
, (, ),

181 
__hypŸ_föôe
);

183 
__REDIRECT_NTH
 (
hypŸl
, (, ),

184 
__hypŸl_föôe
);

189 #i‡
deföed
 
__USE_MISC
 || deföed 
__USE_XOPEN


191 
__REDIRECT_NTH
 (
j0
, (), 
__j0_föôe
);

193 #i‡
deföed
 
__USE_MISC
 && deföed 
__USE_ISOC99


194 
__REDIRECT_NTH
 (
j0f
, (), 
__j0f_föôe
);

195 #ifde‡
__MATH_DECLARE_LDOUBLE


196 #ifde‡
__NO_LONG_DOUBLE_MATH


197 
__REDIRECT_NTH
 (
j0l
, (), 
__j0_föôe
);

199 
__REDIRECT_NTH
 (
j0l
, (), 
__j0l_föôe
);

204 #i‡
deföed
 
__USE_MISC
 || deföed 
__USE_XOPEN


206 
__REDIRECT_NTH
 (
y0
, (), 
__y0_föôe
);

208 #i‡
deföed
 
__USE_MISC
 && deföed 
__USE_ISOC99


209 
__REDIRECT_NTH
 (
y0f
, (), 
__y0f_föôe
);

210 #ifde‡
__MATH_DECLARE_LDOUBLE


211 #ifde‡
__NO_LONG_DOUBLE_MATH


212 
__REDIRECT_NTH
 (
y0l
, (), 
__y0_föôe
);

214 
__REDIRECT_NTH
 (
y0l
, (), 
__y0l_föôe
);

219 #i‡
deföed
 
__USE_MISC
 || deföed 
__USE_XOPEN


221 
__REDIRECT_NTH
 (
j1
, (), 
__j1_föôe
);

223 #i‡
deföed
 
__USE_MISC
 && deföed 
__USE_ISOC99


224 
__REDIRECT_NTH
 (
j1f
, (), 
__j1f_föôe
);

225 #ifde‡
__MATH_DECLARE_LDOUBLE


226 #ifde‡
__NO_LONG_DOUBLE_MATH


227 
__REDIRECT_NTH
 (
j1l
, (), 
__j1_föôe
);

229 
__REDIRECT_NTH
 (
j1l
, (), 
__j1l_föôe
);

234 #i‡
deföed
 
__USE_MISC
 || deföed 
__USE_XOPEN


236 
__REDIRECT_NTH
 (
y1
, (), 
__y1_föôe
);

238 #i‡
deföed
 
__USE_MISC
 && deföed 
__USE_ISOC99


239 
__REDIRECT_NTH
 (
y1f
, (), 
__y1f_föôe
);

240 #ifde‡
__MATH_DECLARE_LDOUBLE


241 #ifde‡
__NO_LONG_DOUBLE_MATH


242 
__REDIRECT_NTH
 (
y1l
, (), 
__y1_föôe
);

244 
__REDIRECT_NTH
 (
y1l
, (), 
__y1l_föôe
);

249 #i‡
deföed
 
__USE_MISC
 || deföed 
__USE_XOPEN


251 
__REDIRECT_NTH
 (
jn
, (, ), 
__jn_föôe
);

253 #i‡
deföed
 
__USE_MISC
 && deföed 
__USE_ISOC99


254 
__REDIRECT_NTH
 (
jnf
, (, ), 
__jnf_föôe
);

255 #ifde‡
__MATH_DECLARE_LDOUBLE


256 #ifde‡
__NO_LONG_DOUBLE_MATH


257 
__REDIRECT_NTH
 (
j∆
, (, ), 
__jn_föôe
);

259 
__REDIRECT_NTH
 (
j∆
, (, ), 
__j∆_föôe
);

264 #i‡
deföed
 
__USE_MISC
 || deföed 
__USE_XOPEN


266 
__REDIRECT_NTH
 (
yn
, (, ), 
__yn_föôe
);

268 #i‡
deföed
 
__USE_MISC
 && deföed 
__USE_ISOC99


269 
__REDIRECT_NTH
 (
ynf
, (, ), 
__ynf_föôe
);

270 #ifde‡
__MATH_DECLARE_LDOUBLE


271 #ifde‡
__NO_LONG_DOUBLE_MATH


272 
__REDIRECT_NTH
 (
y∆
, (, ), 
__yn_föôe
);

274 
__REDIRECT_NTH
 (
y∆
, (, ), 
__y∆_föôe
);

279 #ifde‡
__USE_MISC


281 
__REDIRECT_NTH
 (
lgamma_r
, (, *), 
__lgamma_r_föôe
);

282 #ifde‡
__USE_ISOC99


283 
__REDIRECT_NTH
 (
lgammaf_r
, (, *), 
__lgammaf_r_föôe
);

284 #ifde‡
__MATH_DECLARE_LDOUBLE


285 #ifde‡
__NO_LONG_DOUBLE_MATH


286 
__REDIRECT_NTH
 (
lgammÆ_r
, (, *),

287 
__lgamma_r_föôe
);

289 
__REDIRECT_NTH
 (
lgammÆ_r
, (, *),

290 
__lgammÆ_r_föôe
);

296 
__lgamma_r_föôe
 (, *);

297 
__lgammaf_r_föôe
 (, *);

298 #ifde‡
__NO_LONG_DOUBLE_MATH


299 
__REDIRECT_NTH
 (
__lgammÆ_r_föôe
, (, *),

300 
__lgamma_r_föôe
);

302 
__lgammÆ_r_föôe
 (, *);

305 #i‡((
deföed
 
__USE_XOPEN
 || deföed 
__USE_ISOC99
) \

306 && 
deföed
 
	g__exã∫_Æways_ölöe
)

308 
__exã∫_Æways_ölöe
 
__NTH
 (
	$lgamma
 (
__d
))

310 #i‡
deföed
 
__USE_MISC
 || deföed 
__USE_XOPEN


311  
	`__lgamma_r_föôe
 (
__d
, &
signgam
);

313 
__loˇl_signgam
 = 0;

314  
	`__lgamma_r_föôe
 (
__d
, &
__loˇl_signgam
);

316 
	}
}

318 #i‡
deföed
 
__USE_ISOC99
 && deföed 
__exã∫_Æways_ölöe


319 
__exã∫_Æways_ölöe
 
__NTH
 (
	$lgammaf
 (
__d
))

321 #i‡
deföed
 
__USE_MISC
 || deföed 
__USE_XOPEN


322  
	`__lgammaf_r_föôe
 (
__d
, &
signgam
);

324 
__loˇl_signgam
 = 0;

325  
	`__lgammaf_r_föôe
 (
__d
, &
__loˇl_signgam
);

327 
	}
}

328 #ifde‡
__MATH_DECLARE_LDOUBLE


329 
__exã∫_Æways_ölöe
 
__NTH
 (
	$lgammÆ
 (
__d
))

331 #i‡
deföed
 
__USE_MISC
 || deföed 
__USE_XOPEN


332  
	`__lgammÆ_r_föôe
 (
__d
, &
signgam
);

334 
__loˇl_signgam
 = 0;

335  
	`__lgammÆ_r_föôe
 (
__d
, &
__loˇl_signgam
);

337 
	}
}

341 #i‡((
deföed
 
__USE_MISC
 || (deföed 
__USE_XOPEN
 && !deföed 
__USE_XOPEN2K
)) \

342 && 
deföed
 
	g__exã∫_Æways_ölöe
)

344 
__exã∫_Æways_ölöe
 
__NTH
 (
	$gamma
 (
__d
))

346  
	`__lgamma_r_föôe
 (
__d
, &
signgam
);

347 
	}
}

348 #ifde‡
__USE_ISOC99


349 
__exã∫_Æways_ölöe
 
__NTH
 (
	$gammaf
 (
__d
))

351  
	`__lgammaf_r_föôe
 (
__d
, &
signgam
);

352 
	}
}

353 #ifde‡
__MATH_DECLARE_LDOUBLE


354 
__exã∫_Æways_ölöe
 
__NTH
 (
	$gammÆ
 (
__d
))

356  
	`__lgammÆ_r_föôe
 (
__d
, &
signgam
);

357 
	}
}

363 
__REDIRECT_NTH
 (
log
, (), 
__log_föôe
);

364 #ifde‡
__USE_ISOC99


365 
__REDIRECT_NTH
 (
logf
, (), 
__logf_föôe
);

366 #ifde‡
__MATH_DECLARE_LDOUBLE


367 #ifde‡
__NO_LONG_DOUBLE_MATH


368 
__REDIRECT_NTH
 (
logl
, (), 
__log_föôe
);

370 
__REDIRECT_NTH
 (
logl
, (), 
__logl_föôe
);

376 
__REDIRECT_NTH
 (
log10
, (), 
__log10_föôe
);

377 #ifde‡
__USE_ISOC99


378 
__REDIRECT_NTH
 (
log10f
, (), 
__log10f_föôe
);

379 #ifde‡
__MATH_DECLARE_LDOUBLE


380 #ifde‡
__NO_LONG_DOUBLE_MATH


381 
__REDIRECT_NTH
 (
log10l
, (), 
__log10_föôe
);

383 
__REDIRECT_NTH
 (
log10l
, (), 
__log10l_föôe
);

388 #ifde‡
__USE_ISOC99


390 
__REDIRECT_NTH
 (
log2
, (), 
__log2_föôe
);

391 
__REDIRECT_NTH
 (
log2f
, (), 
__log2f_föôe
);

392 #ifde‡
__MATH_DECLARE_LDOUBLE


393 #ifde‡
__NO_LONG_DOUBLE_MATH


394 
__REDIRECT_NTH
 (
log2l
, (), 
__log2_föôe
);

396 
__REDIRECT_NTH
 (
log2l
, (), 
__log2l_föôe
);

402 
__REDIRECT_NTH
 (
pow
, (, ), 
__pow_föôe
);

403 #ifde‡
__USE_ISOC99


404 
__REDIRECT_NTH
 (
powf
, (, ), 
__powf_föôe
);

405 #ifde‡
__MATH_DECLARE_LDOUBLE


406 #ifde‡
__NO_LONG_DOUBLE_MATH


407 
__REDIRECT_NTH
 (
powl
, (, ),

408 
__pow_föôe
);

410 
__REDIRECT_NTH
 (
powl
, (, ),

411 
__powl_föôe
);

416 #i‡
deföed
 
__USE_XOPEN_EXTENDED
 || deföed 
__USE_ISOC99


418 
__REDIRECT_NTH
 (
ªmaödî
, (, ), 
__ªmaödî_föôe
);

420 #ifde‡
__USE_ISOC99


421 
__REDIRECT_NTH
 (
ªmaödîf
, (, ), 
__ªmaödîf_föôe
);

422 #ifde‡
__MATH_DECLARE_LDOUBLE


423 #ifde‡
__NO_LONG_DOUBLE_MATH


424 
__REDIRECT_NTH
 (
ªmaödîl
, (, ),

425 
__ªmaödî_föôe
);

427 
__REDIRECT_NTH
 (
ªmaödîl
, (, ),

428 
__ªmaödîl_föôe
);

433 #i‡(
deföed
 
__USE_MISC
 \

434 || (
deföed
 
	g__USE_XOPEN_EXTENDED
 && !deföed 
	g__USE_XOPEN2K8
))

436 
__REDIRECT_NTH
 (
sˇlb
, (, ), 
__sˇlb_föôe
);

438 #i‡
deföed
 
__USE_MISC
 && deföed 
__USE_ISOC99


439 
__REDIRECT_NTH
 (
sˇlbf
, (, ), 
__sˇlbf_föôe
);

440 #ifde‡
__MATH_DECLARE_LDOUBLE


441 #ifde‡
__NO_LONG_DOUBLE_MATH


442 
__REDIRECT_NTH
 (
sˇlbl
, (, ),

443 
__sˇlb_föôe
);

445 
__REDIRECT_NTH
 (
sˇlbl
, (, ),

446 
__sˇlbl_föôe
);

452 
__REDIRECT_NTH
 (
söh
, (), 
__söh_föôe
);

453 #ifde‡
__USE_ISOC99


454 
__REDIRECT_NTH
 (
söhf
, (), 
__söhf_föôe
);

455 #ifde‡
__MATH_DECLARE_LDOUBLE


456 #ifde‡
__NO_LONG_DOUBLE_MATH


457 
__REDIRECT_NTH
 (
söhl
, (), 
__söh_föôe
);

459 
__REDIRECT_NTH
 (
söhl
, (), 
__söhl_föôe
);

465 
__REDIRECT_NTH
 (
sqπ
, (), 
__sqπ_föôe
);

466 #ifde‡
__USE_ISOC99


467 
__REDIRECT_NTH
 (
sqπf
, (), 
__sqπf_föôe
);

468 #ifde‡
__MATH_DECLARE_LDOUBLE


469 #ifde‡
__NO_LONG_DOUBLE_MATH


470 
__REDIRECT_NTH
 (
sqπl
, (), 
__sqπ_föôe
);

472 
__REDIRECT_NTH
 (
sqπl
, (), 
__sqπl_föôe
);

477 #i‡
deföed
 
__USE_ISOC99
 && deföed 
__exã∫_Æways_ölöe


479 
__gamma_r_föôe
 (, *);

480 
__exã∫_Æways_ölöe
 
__NTH
 (
	$tgamma
 (
__d
))

482 
__loˇl_signgam
 = 0;

483 
__ªs
 = 
	`__gamma_r_föôe
 (
__d
, &
__loˇl_signgam
);

484  
__loˇl_signgam
 < 0 ? -
__ªs
 : __res;

485 
	}
}

486 
__gammaf_r_föôe
 (, *);

487 
__exã∫_Æways_ölöe
 
__NTH
 (
	$tgammaf
 (
__d
))

489 
__loˇl_signgam
 = 0;

490 
__ªs
 = 
	`__gammaf_r_föôe
 (
__d
, &
__loˇl_signgam
);

491  
__loˇl_signgam
 < 0 ? -
__ªs
 : __res;

492 
	}
}

493 #ifde‡
__MATH_DECLARE_LDOUBLE


494 
__gammÆ_r_föôe
 (, *);

495 
__exã∫_Æways_ölöe
 
__NTH
 (
	$tgammÆ
 (
__d
))

497 
__loˇl_signgam
 = 0;

498 #ifde‡
__NO_LONG_DOUBLE_MATH


499 
__ªs
 = 
	`__gamma_r_föôe
 (
__d
, &
__loˇl_signgam
);

501 
__ªs
 = 
	`__gammÆ_r_föôe
 (
__d
, &
__loˇl_signgam
);

503  
__loˇl_signgam
 < 0 ? -
__ªs
 : __res;

504 
	}
}

	@/usr/include/bits/math-vector.h

19 #i‚de‡
_MATH_H


25 
	~<bôs/libm-simd-de˛-°ubs.h
>

27 #i‡
deföed
 
__x86_64__
 && deföed 
__FAST_MATH__


28 #i‡
deföed
 
_OPENMP
 && _OPENMP >= 201307

30 
	#__DECL_SIMD_x86_64
 
	`_Pøgma
 ("om∞de˛¨êsimdÇŸöbønch")

	)

31 #ñi‡
__GNUC_PREREQ
 (6,0)

33 
	#__DECL_SIMD_x86_64
 
	`__©åibuã__
 ((
	`__simd__
 ("nŸöbønch")))

	)

36 #ifde‡
__DECL_SIMD_x86_64


37 #unde‡
__DECL_SIMD_cos


38 
	#__DECL_SIMD_cos
 
__DECL_SIMD_x86_64


	)

39 #unde‡
__DECL_SIMD_cosf


40 
	#__DECL_SIMD_cosf
 
__DECL_SIMD_x86_64


	)

41 #unde‡
__DECL_SIMD_sö


42 
	#__DECL_SIMD_sö
 
__DECL_SIMD_x86_64


	)

43 #unde‡
__DECL_SIMD_söf


44 
	#__DECL_SIMD_söf
 
__DECL_SIMD_x86_64


	)

45 #unde‡
__DECL_SIMD_söcos


46 
	#__DECL_SIMD_söcos
 
__DECL_SIMD_x86_64


	)

47 #unde‡
__DECL_SIMD_söcosf


48 
	#__DECL_SIMD_söcosf
 
__DECL_SIMD_x86_64


	)

49 #unde‡
__DECL_SIMD_log


50 
	#__DECL_SIMD_log
 
__DECL_SIMD_x86_64


	)

51 #unde‡
__DECL_SIMD_logf


52 
	#__DECL_SIMD_logf
 
__DECL_SIMD_x86_64


	)

53 #unde‡
__DECL_SIMD_exp


54 
	#__DECL_SIMD_exp
 
__DECL_SIMD_x86_64


	)

55 #unde‡
__DECL_SIMD_expf


56 
	#__DECL_SIMD_expf
 
__DECL_SIMD_x86_64


	)

57 #unde‡
__DECL_SIMD_pow


58 
	#__DECL_SIMD_pow
 
__DECL_SIMD_x86_64


	)

59 #unde‡
__DECL_SIMD_powf


60 
	#__DECL_SIMD_powf
 
__DECL_SIMD_x86_64


	)

	@/usr/include/bits/mathcalls.h

45 #i‚de‡
_MATH_H


52 
_MdoubÀ_BEGIN_NAMESPACE


54 
__MATHCALL
 (
acos
,, (
_MdoubÀ_
 
__x
));

56 
__MATHCALL
 (
asö
,, (
_MdoubÀ_
 
__x
));

58 
__MATHCALL
 (
©™
,, (
_MdoubÀ_
 
__x
));

60 
__MATHCALL
 (
©™2
,, (
_MdoubÀ_
 
__y
, _MdoubÀ_ 
__x
));

63 
__MATHCALL_VEC
 (
cos
,, (
_MdoubÀ_
 
__x
));

65 
__MATHCALL_VEC
 (
sö
,, (
_MdoubÀ_
 
__x
));

67 
__MATHCALL
 (
èn
,, (
_MdoubÀ_
 
__x
));

72 
__MATHCALL
 (
cosh
,, (
_MdoubÀ_
 
__x
));

74 
__MATHCALL
 (
söh
,, (
_MdoubÀ_
 
__x
));

76 
__MATHCALL
 (
ènh
,, (
_MdoubÀ_
 
__x
));

77 
	g_MdoubÀ_END_NAMESPACE


79 #ifde‡
__USE_GNU


81 
__MATHDECL_VEC
 (,
söcos
,,

82 (
_MdoubÀ_
 
__x
, _MdoubÀ_ *
__söx
, _MdoubÀ_ *
__cosx
));

85 #i‡
deföed
 
__USE_XOPEN_EXTENDED
 || deföed 
__USE_ISOC99


86 
__BEGIN_NAMESPACE_C99


88 
__MATHCALL
 (
acosh
,, (
_MdoubÀ_
 
__x
));

90 
__MATHCALL
 (
asöh
,, (
_MdoubÀ_
 
__x
));

92 
__MATHCALL
 (
©™h
,, (
_MdoubÀ_
 
__x
));

93 
	g__END_NAMESPACE_C99


98 
_MdoubÀ_BEGIN_NAMESPACE


100 
__MATHCALL_VEC
 (
exp
,, (
_MdoubÀ_
 
__x
));

103 
__MATHCALL
 (
‰exp
,, (
_MdoubÀ_
 
__x
, *
__exp⁄ít
));

106 
__MATHCALL
 (
ldexp
,, (
_MdoubÀ_
 
__x
, 
__exp⁄ít
));

109 
__MATHCALL_VEC
 (
log
,, (
_MdoubÀ_
 
__x
));

112 
__MATHCALL
 (
log10
,, (
_MdoubÀ_
 
__x
));

115 
__MATHCALL
 (
modf
,, (
_MdoubÀ_
 
__x
, _MdoubÀ_ *
__ùå
)Ë
__n⁄nuŒ
 ((2));

116 
	g_MdoubÀ_END_NAMESPACE


118 #i‡
__GLIBC_USE
 (
IEC_60559_FUNCS_EXT
)

120 
__MATHCALL
 (
exp10
,, (
_MdoubÀ_
 
__x
));

122 #ifde‡
__USE_GNU


124 
__MATHCALL
 (
pow10
,, (
_MdoubÀ_
 
__x
));

127 #i‡
deföed
 
__USE_XOPEN_EXTENDED
 || deföed 
__USE_ISOC99


128 
__BEGIN_NAMESPACE_C99


130 
__MATHCALL
 (
expm1
,, (
_MdoubÀ_
 
__x
));

133 
__MATHCALL
 (
log1p
,, (
_MdoubÀ_
 
__x
));

136 
__MATHCALL
 (
logb
,, (
_MdoubÀ_
 
__x
));

137 
	g__END_NAMESPACE_C99


140 #ifde‡
__USE_ISOC99


141 
__BEGIN_NAMESPACE_C99


143 
__MATHCALL
 (
exp2
,, (
_MdoubÀ_
 
__x
));

146 
__MATHCALL
 (
log2
,, (
_MdoubÀ_
 
__x
));

147 
	g__END_NAMESPACE_C99


153 
_MdoubÀ_BEGIN_NAMESPACE


155 
__MATHCALL_VEC
 (
pow
,, (
_MdoubÀ_
 
__x
, _MdoubÀ_ 
__y
));

158 
__MATHCALL
 (
sqπ
,, (
_MdoubÀ_
 
__x
));

159 
	g_MdoubÀ_END_NAMESPACE


161 #i‡
deföed
 
__USE_XOPEN
 || deföed 
__USE_ISOC99


162 
__BEGIN_NAMESPACE_C99


164 
__MATHCALL
 (
hypŸ
,, (
_MdoubÀ_
 
__x
, _MdoubÀ_ 
__y
));

165 
	g__END_NAMESPACE_C99


168 #i‡
deföed
 
__USE_XOPEN_EXTENDED
 || deföed 
__USE_ISOC99


169 
__BEGIN_NAMESPACE_C99


171 
__MATHCALL
 (
cbπ
,, (
_MdoubÀ_
 
__x
));

172 
	g__END_NAMESPACE_C99


178 
_MdoubÀ_BEGIN_NAMESPACE


180 
__MATHCALLX
 (
˚û
,, (
_MdoubÀ_
 
__x
), (
__c⁄°__
));

183 
__MATHCALLX
 (
Ábs
,, (
_MdoubÀ_
 
__x
), (
__c⁄°__
));

186 
__MATHCALLX
 (
Êo‹
,, (
_MdoubÀ_
 
__x
), (
__c⁄°__
));

189 
__MATHCALL
 (
fmod
,, (
_MdoubÀ_
 
__x
, _MdoubÀ_ 
__y
));

194 
__MATHDECL_1
 (,
__isöf
,, (
_MdoubÀ_
 
__vÆue
)Ë
__©åibuã__
 ((
__c⁄°__
));

197 
__MATHDECL_1
 (,
__föôe
,, (
_MdoubÀ_
 
__vÆue
)Ë
__©åibuã__
 ((
__c⁄°__
));

198 
	g_MdoubÀ_END_NAMESPACE


200 #ifde‡
__USE_MISC


201 #i‡(!
deföed
 
__˝lu•lus
 \

202 || 
	g__˝lu•lus
 < 201103L \

203 || 
	g__MATH_DECLARING_DOUBLE
 == 0)

206 
__MATHDECL_1
 (,
isöf
,, (
_MdoubÀ_
 
__vÆue
)Ë
__©åibuã__
 ((
__c⁄°__
));

210 
__MATHDECL_1
 (,
föôe
,, (
_MdoubÀ_
 
__vÆue
)Ë
__©åibuã__
 ((
__c⁄°__
));

213 
__MATHCALL
 (
dªm
,, (
_MdoubÀ_
 
__x
, _MdoubÀ_ 
__y
));

217 
__MATHCALL
 (
signifiˇnd
,, (
_MdoubÀ_
 
__x
));

220 #ifde‡
__USE_ISOC99


221 
__BEGIN_NAMESPACE_C99


223 
__MATHCALLX
 (
c›ysign
,, (
_MdoubÀ_
 
__x
, _MdoubÀ_ 
__y
), (
__c⁄°__
));

224 
	g__END_NAMESPACE_C99


227 #ifde‡
__USE_ISOC99


228 
__BEGIN_NAMESPACE_C99


230 
__MATHCALLX
 (
«n
,, (c⁄° *
__ègb
), (
__c⁄°__
));

231 
	g__END_NAMESPACE_C99


236 
__MATHDECL_1
 (,
__i¢™
,, (
_MdoubÀ_
 
__vÆue
)Ë
__©åibuã__
 ((
__c⁄°__
));

238 #i‡
deföed
 
__USE_MISC
 || (deföed 
__USE_XOPEN
 && !deföed 
__USE_XOPEN2K
)

239 #i‡(!
deföed
 
__˝lu•lus
 \

240 || 
	g__˝lu•lus
 < 201103L \

241 || 
	g__MATH_DECLARING_DOUBLE
 == 0)

243 
__MATHDECL_1
 (,
i¢™
,, (
_MdoubÀ_
 
__vÆue
)Ë
__©åibuã__
 ((
__c⁄°__
));

247 #i‡
deföed
 
__USE_MISC
 || (deföed 
__USE_XOPEN
 && 
__MATH_DECLARING_DOUBLE
)

249 
__MATHCALL
 (
j0
,, (
_MdoubÀ_
));

250 
__MATHCALL
 (
j1
,, (
_MdoubÀ_
));

251 
__MATHCALL
 (
jn
,, (, 
_MdoubÀ_
));

252 
__MATHCALL
 (
y0
,, (
_MdoubÀ_
));

253 
__MATHCALL
 (
y1
,, (
_MdoubÀ_
));

254 
__MATHCALL
 (
yn
,, (, 
_MdoubÀ_
));

258 #i‡
deföed
 
__USE_XOPEN
 || deföed 
__USE_ISOC99


259 
__BEGIN_NAMESPACE_C99


261 
__MATHCALL
 (
îf
,, (
_MdoubÀ_
));

262 
__MATHCALL
 (
îfc
,, (
_MdoubÀ_
));

263 
__MATHCALL
 (
lgamma
,, (
_MdoubÀ_
));

264 
	g__END_NAMESPACE_C99


267 #ifde‡
__USE_ISOC99


268 
__BEGIN_NAMESPACE_C99


270 
__MATHCALL
 (
tgamma
,, (
_MdoubÀ_
));

271 
	g__END_NAMESPACE_C99


274 #i‡
deföed
 
__USE_MISC
 || (deföed 
__USE_XOPEN
 && !deföed 
__USE_XOPEN2K
)

276 
__MATHCALL
 (
gamma
,, (
_MdoubÀ_
));

279 #ifde‡
__USE_MISC


283 
__MATHCALL
 (
lgamma
,
_r
, (
_MdoubÀ_
, *
__signgamp
));

287 #i‡
deföed
 
__USE_XOPEN_EXTENDED
 || deföed 
__USE_ISOC99


288 
__BEGIN_NAMESPACE_C99


291 
__MATHCALL
 (
röt
,, (
_MdoubÀ_
 
__x
));

294 
__MATHCALLX
 (
√xè·î
,, (
_MdoubÀ_
 
__x
, _MdoubÀ_ 
__y
), (
__c⁄°__
));

295 #i‡
deföed
 
__USE_ISOC99
 && !deföed 
__LDBL_COMPAT


296 
__MATHCALLX
 (
√xâow¨d
,, (
_MdoubÀ_
 
__x
, 
__y
), (
__c⁄°__
));

299 #i‡
__GLIBC_USE
 (
IEC_60559_BFP_EXT
)

301 
__MATHCALL
 (
√xtdown
,, (
_MdoubÀ_
 
__x
));

303 
__MATHCALL
 (
√xtup
,, (
_MdoubÀ_
 
__x
));

307 
__MATHCALL
 (
ªmaödî
,, (
_MdoubÀ_
 
__x
, _MdoubÀ_ 
__y
));

309 #ifde‡
__USE_ISOC99


311 
__MATHCALL
 (
sˇlbn
,, (
_MdoubÀ_
 
__x
, 
__n
));

315 
__MATHDECL
 (,
ûogb
,, (
_MdoubÀ_
 
__x
));

318 #i‡
__GLIBC_USE
 (
IEC_60559_BFP_EXT
)

320 
__MATHDECL
 (, 
Œogb
,, (
_MdoubÀ_
 
__x
));

323 #ifde‡
__USE_ISOC99


325 
__MATHCALL
 (
sˇlb 
,, (
_MdoubÀ_
 
__x
, 
__n
));

329 
__MATHCALL
 (
√¨byöt
,, (
_MdoubÀ_
 
__x
));

333 
__MATHCALLX
 (
round
,, (
_MdoubÀ_
 
__x
), (
__c⁄°__
));

337 
__MATHCALLX
 (
åunc
,, (
_MdoubÀ_
 
__x
), (
__c⁄°__
));

342 
__MATHCALL
 (
ªmquo
,, (
_MdoubÀ_
 
__x
, _MdoubÀ_ 
__y
, *
__quo
));

349 
__MATHDECL
 (,
Ãöt
,, (
_MdoubÀ_
 
__x
));

350 
__exãnsi⁄__


351 
__MATHDECL
 (,
Œröt
,, (
_MdoubÀ_
 
__x
));

355 
__MATHDECL
 (,
Ãound
,, (
_MdoubÀ_
 
__x
));

356 
__exãnsi⁄__


357 
__MATHDECL
 (,
Œround
,, (
_MdoubÀ_
 
__x
));

361 
__MATHCALL
 (
fdim
,, (
_MdoubÀ_
 
__x
, _MdoubÀ_ 
__y
));

364 
__MATHCALLX
 (
fmax
,, (
_MdoubÀ_
 
__x
, _MdoubÀ_ 
__y
), (
__c⁄°__
));

367 
__MATHCALLX
 (
fmö
,, (
_MdoubÀ_
 
__x
, _MdoubÀ_ 
__y
), (
__c⁄°__
));

371 
__MATHDECL_1
 (, 
__Â˛assify
,, (
_MdoubÀ_
 
__vÆue
))

372 
__©åibuã__
 ((
__c⁄°__
));

375 
__MATHDECL_1
 (, 
__signbô
,, (
_MdoubÀ_
 
__vÆue
))

376 
__©åibuã__
 ((
__c⁄°__
));

380 
__MATHCALL
 (
fma
,, (
_MdoubÀ_
 
__x
, _MdoubÀ_ 
__y
, _MdoubÀ_ 
__z
));

383 #i‡
deföed
 
__USE_XOPEN_EXTENDED
 || deföed 
__USE_ISOC99


384 
	g__END_NAMESPACE_C99


387 #i‡
__GLIBC_USE
 (
IEC_60559_BFP_EXT
)

389 
__MATHCALLX
 (
roundeví
,, (
_MdoubÀ_
 
__x
), (
__c⁄°__
));

393 
__MATHDECL
 (
__ötmax_t
, 
‰omÂ
,, (
_MdoubÀ_
 
__x
, 
__round
,

394 
__width
));

398 
__MATHDECL
 (
__uötmax_t
, 
u‰omÂ
,, (
_MdoubÀ_
 
__x
, 
__round
,

399 
__width
));

404 
__MATHDECL
 (
__ötmax_t
, 
‰omÂx
,, (
_MdoubÀ_
 
__x
, 
__round
,

405 
__width
));

410 
__MATHDECL
 (
__uötmax_t
, 
u‰omÂx
,, (
_MdoubÀ_
 
__x
, 
__round
,

411 
__width
));

414 
__MATHCALLX
 (
fmaxmag
,, (
_MdoubÀ_
 
__x
, _MdoubÀ_ 
__y
), (
__c⁄°__
));

417 
__MATHCALLX
 (
fmömag
,, (
_MdoubÀ_
 
__x
, _MdoubÀ_ 
__y
), (
__c⁄°__
));

420 
__MATHDECL_1
 (, 
__i£qsig
,, (
_MdoubÀ_
 
__x
, _MdoubÀ_ 
__y
));

423 
__MATHDECL_1
 (, 
__issig«lög
,, (
_MdoubÀ_
 
__vÆue
))

424 
__©åibuã__
 ((
__c⁄°__
));

427 
__MATHDECL_1
 (, 
tŸÆ‹dî
,, (
_MdoubÀ_
 
__x
, _MdoubÀ_ 
__y
))

428 
__©åibuã__
 ((
__c⁄°__
));

431 
__MATHDECL_1
 (, 
tŸÆ‹dîmag
,, (
_MdoubÀ_
 
__x
, _MdoubÀ_ 
__y
))

432 
__©åibuã__
 ((
__c⁄°__
));

435 
__MATHDECL_1
 (, 
ˇn⁄iˇlize
,, (
_MdoubÀ_
 *
__cx
, c⁄° _MdoubÀ_ *
__x
));

438 
__MATHCALL
 (
gë∑ylﬂd
,, (c⁄° 
_MdoubÀ_
 *
__x
));

441 
__MATHDECL_1
 (, 
£çaylﬂd
,, (
_MdoubÀ_
 *
__x
, _MdoubÀ_ 
__∑ylﬂd
));

444 
__MATHDECL_1
 (, 
£çaylﬂdsig
,, (
_MdoubÀ_
 *
__x
, _MdoubÀ_ 
__∑ylﬂd
));

447 #i‡
deföed
 
__USE_MISC
 || (deföed 
__USE_XOPEN_EXTENDED
 \

448 && 
	g__MATH_DECLARING_DOUBLE
 \

449 && !
deföed
 
	g__USE_XOPEN2K8
)

451 
__MATHCALL
 (
sˇlb
,, (
_MdoubÀ_
 
__x
, _MdoubÀ_ 
__n
));

	@/usr/include/bits/mathinline.h

19 #i‚de‡
_MATH_H


23 #i‚de‡
__exã∫_Æways_ölöe


24 
	#__MATH_INLINE
 
__ölöe


	)

26 
	#__MATH_INLINE
 
__exã∫_Æways_ölöe


	)

30 #i‡
deföed
 
__USE_ISOC99
 && deföed 
__GNUC__
 && __GNUC__ >= 2

32 #i‡!
__GNUC_PREREQ
 (2,97)

37 #unde‡
isgª©î


38 #unde‡
isgª©îequÆ


39 #unde‡
i¶ess


40 #unde‡
i¶es£quÆ


41 #unde‡
i¶essgª©î


42 #unde‡
isun‹dîed


43 #ifde‡
__i686__


46 
	#isgª©î
(
x
, 
y
) \

47 ({ 
__ªsu…
; \

48 
	`__asm__
 ("fucomip %%st(1), %%st; seta %%al" \

49 : "˜" (
__ªsu…
Ë: "u" (
y
), "t" (
x
) : "cc", "st"); \

50 
__ªsu…
; })

	)

51 
	#isgª©îequÆ
(
x
, 
y
) \

52 ({ 
__ªsu…
; \

53 
	`__asm__
 ("fucomip %%st(1), %%st; setae %%al" \

54 : "˜" (
__ªsu…
Ë: "u" (
y
), "t" (
x
) : "cc", "st"); \

55 
__ªsu…
; })

	)

57 
	#i¶ess
(
x
, 
y
) \

58 ({ 
__ªsu…
; \

59 
	`__asm__
 ("fucomip %%st(1), %%st; seta %%al" \

60 : "˜" (
__ªsu…
Ë: "u" (
x
), "t" (
y
) : "cc", "st"); \

61 
__ªsu…
; })

	)

63 
	#i¶es£quÆ
(
x
, 
y
) \

64 ({ 
__ªsu…
; \

65 
	`__asm__
 ("fucomip %%st(1), %%st; setae %%al" \

66 : "˜" (
__ªsu…
Ë: "u" (
x
), "t" (
y
) : "cc", "st"); \

67 
__ªsu…
; })

	)

69 
	#i¶essgª©î
(
x
, 
y
) \

70 ({ 
__ªsu…
; \

71 
	`__asm__
 ("fucomip %%st(1), %%st; setne %%al" \

72 : "˜" (
__ªsu…
Ë: "u" (
y
), "t" (
x
) : "cc", "st"); \

73 
__ªsu…
; })

	)

75 
	#isun‹dîed
(
x
, 
y
) \

76 ({ 
__ªsu…
; \

77 
	`__asm__
 ("fucomip %%st(1), %%st; setp %%al" \

78 : "˜" (
__ªsu…
Ë: "u" (
y
), "t" (
x
) : "cc", "st"); \

79 
__ªsu…
; })

	)

82 
	#isgª©î
(
x
, 
y
) \

83 ({ 
__ªsu…
; \

84 
	`__asm__
 ("fucompp; fnstsw;Åestb $0x45, %%ah; setz %%al" \

85 : "˜" (
__ªsu…
Ë: "u" (
y
), "t" (
x
) : "cc", "st", "st(1)"); \

86 
__ªsu…
; })

	)

88 
	#isgª©îequÆ
(
x
, 
y
) \

89 ({ 
__ªsu…
; \

90 
	`__asm__
 ("fucompp; fnstsw;Åestb $0x05, %%ah; setz %%al" \

91 : "˜" (
__ªsu…
Ë: "u" (
y
), "t" (
x
) : "cc", "st", "st(1)"); \

92 
__ªsu…
; })

	)

94 
	#i¶ess
(
x
, 
y
) \

95 ({ 
__ªsu…
; \

96 
	`__asm__
 ("fucompp; fnstsw;Åestb $0x45, %%ah; setz %%al" \

97 : "˜" (
__ªsu…
Ë: "u" (
x
), "t" (
y
) : "cc", "st", "st(1)"); \

98 
__ªsu…
; })

	)

100 
	#i¶es£quÆ
(
x
, 
y
) \

101 ({ 
__ªsu…
; \

102 
	`__asm__
 ("fucompp; fnstsw;Åestb $0x05, %%ah; setz %%al" \

103 : "˜" (
__ªsu…
Ë: "u" (
x
), "t" (
y
) : "cc", "st", "st(1)"); \

104 
__ªsu…
; })

	)

106 
	#i¶essgª©î
(
x
, 
y
) \

107 ({ 
__ªsu…
; \

108 
	`__asm__
 ("fucompp; fnstsw;Åestb $0x44, %%ah; setz %%al" \

109 : "˜" (
__ªsu…
Ë: "u" (
y
), "t" (
x
) : "cc", "st", "st(1)"); \

110 
__ªsu…
; })

	)

112 
	#isun‹dîed
(
x
, 
y
) \

113 ({ 
__ªsu…
; \

114 
	`__asm__
 ("fucompp; fnstsw; sahf; setp %%al" \

115 : "˜" (
__ªsu…
Ë: "u" (
y
), "t" (
x
) : "cc", "st", "st(1)"); \

116 
__ªsu…
; })

	)

122 #i‡
__GNUC_PREREQ
 (2, 8)

123 
__BEGIN_NAMESPACE_C99


126 
__MATH_INLINE
 

127 
__NTH
 (
	$__signbôf
 (
__x
))

129 #ifde‡
__SSE2_MATH__


130 
__m
;

131 
	`__asm
 ("pmovmskb %1, %0" : "Ù" (
__m
Ë: "x" (
__x
));

132  (
__m
 & 0x8) != 0;

134 
__exãnsi⁄__
 uni⁄ { 
__f
; 
__i
; } 
__u
 = { __f: 
__x
 };

135  
__u
.
__i
 < 0;

137 
	}
}

138 
__MATH_INLINE
 

139 
__NTH
 (
	$__signbô
 (
__x
))

141 #ifde‡
__SSE2_MATH__


142 
__m
;

143 
	`__asm
 ("pmovmskb %1, %0" : "Ù" (
__m
Ë: "x" (
__x
));

144  (
__m
 & 0x80) != 0;

146 
__exãnsi⁄__
 uni⁄ { 
__d
; 
__i
[2]; } 
__u
 = { __d: 
__x
 };

147  
__u
.
__i
[1] < 0;

149 
	}
}

150 
__MATH_INLINE
 

151 
__NTH
 (
	$__signbôl
 (
__x
))

153 
__exãnsi⁄__
 uni⁄ { 
__l
; 
__i
[3]; } 
__u
 = { __l: 
__x
 };

154  (
__u
.
__i
[2] & 0x8000) != 0;

155 
	}
}

157 
	g__END_NAMESPACE_C99


164 #i‡
__GNUC_PREREQ
 (2, 8)

165 #i‡!
__GNUC_PREREQ
 (3, 4Ë&& !
deföed
 
__NO_MATH_INLINES
 \

166 && 
deföed
 
	g__OPTIMIZE__


170 #ifde‡
__USE_ISOC99


171 
	g__BEGIN_NAMESPACE_C99


174 #ifde‡
__SSE_MATH__


175 
__MATH_INLINE
 

176 
__NTH
 (
	$Ãötf
 (
__x
))

178 
__ªs
;

183 
__asm
 
	`__vﬁ©ûe__
 ("cvtss2sò%1, %0" : "Ù" (
__ªs
Ë: "xm" (
__x
));

184  
__ªs
;

185 
	}
}

187 #ifde‡
__SSE2_MATH__


188 
__MATH_INLINE
 

189 
__NTH
 (
	$Ãöt
 (
__x
))

191 
__ªs
;

196 
__asm
 
	`__vﬁ©ûe__
 ("cvtsd2sò%1, %0" : "Ù" (
__ªs
Ë: "xm" (
__x
));

197  
__ªs
;

198 
	}
}

200 #ifde‡
__x86_64__


201 
__exãnsi⁄__


202 
__MATH_INLINE
 

203 
__NTH
 (
	$Œrötf
 (
__x
))

205 
__ªs
;

210 
__asm
 
	`__vﬁ©ûe__
 ("cvtss2sò%1, %0" : "Ù" (
__ªs
Ë: "xm" (
__x
));

211  
__ªs
;

212 
	}
}

213 
__exãnsi⁄__


214 
__MATH_INLINE
 

215 
__NTH
 (
	$Œröt
 (
__x
))

217 
__ªs
;

222 
__asm
 
	`__vﬁ©ûe__
 ("cvtsd2sò%1, %0" : "Ù" (
__ªs
Ë: "xm" (
__x
));

223  
__ªs
;

224 
	}
}

227 #i‡
deföed
 
__FINITE_MATH_ONLY__
 && __FINITE_MATH_ONLY__ > 0 \

228 && 
deföed
 
__SSE2_MATH__


230 
__MATH_INLINE
 

231 
__NTH
 (
	$fmaxf
 (
__x
, 
__y
))

233 #ifde‡
__AVX__


234 
__ªs
;

235 
	`__asm
 ("vmaxs†%2, %1, %0" : "=x" (
__ªs
Ë: "x" (
x
), "xm" (
__y
));

236  
__ªs
;

238 
	`__asm
 ("maxs†%1, %0" : "+x" (
__x
Ë: "xm" (
__y
));

239  
__x
;

241 
	}
}

242 
__MATH_INLINE
 

243 
__NTH
 (
	$fmax
 (
__x
, 
__y
))

245 #ifde‡
__AVX__


246 
__ªs
;

247 
	`__asm
 ("vmaxsd %2, %1, %0" : "=x" (
__ªs
Ë: "x" (
x
), "xm" (
__y
));

248  
__ªs
;

250 
	`__asm
 ("maxsd %1, %0" : "+x" (
__x
Ë: "xm" (
__y
));

251  
__x
;

253 
	}
}

256 
__MATH_INLINE
 

257 
__NTH
 (
	$fmöf
 (
__x
, 
__y
))

259 #ifde‡
__AVX__


260 
__ªs
;

261 
	`__asm
 ("vmös†%2, %1, %0" : "=x" (
__ªs
Ë: "x" (
x
), "xm" (
__y
));

262  
__ªs
;

264 
	`__asm
 ("mös†%1, %0" : "+x" (
__x
Ë: "xm" (
__y
));

265  
__x
;

267 
	}
}

268 
__MATH_INLINE
 

269 
__NTH
 (
	$fmö
 (
__x
, 
__y
))

271 #ifde‡
__AVX__


272 
__ªs
;

273 
	`__asm
 ("vmösd %2, %1, %0" : "=x" (
__ªs
Ë: "x" (
x
), "xm" (
__y
));

274  
__ªs
;

276 
	`__asm
 ("mösd %1, %0" : "+x" (
__x
Ë: "xm" (
__y
));

277  
__x
;

279 
	}
}

282 
	g__END_NAMESPACE_C99


285 #i‡
deföed
 
__SSE4_1__
 && deföed 
__SSE2_MATH__


286 #i‡
deföed
 
__USE_XOPEN_EXTENDED
 || deföed 
__USE_ISOC99


287 
__BEGIN_NAMESPACE_C99


290 
__MATH_INLINE
 

291 
__NTH
 (
	$röt
 (
__x
))

293 
__ªs
;

298 
__asm
 
	`__vﬁ©ûe__
 ("roundsd $4, %1, %0" : "=x" (
__ªs
Ë: "xm" (
__x
));

299  
__ªs
;

300 
	}
}

301 
__MATH_INLINE
 

302 
__NTH
 (
	$rötf
 (
__x
))

304 
__ªs
;

309 
__asm
 
	`__vﬁ©ûe__
 ("rounds†$4, %1, %0" : "=x" (
__ªs
Ë: "xm" (
__x
));

310  
__ªs
;

311 
	}
}

313 #ifde‡
__USE_ISOC99


315 
__MATH_INLINE
 

316 
__NTH
 (
	$√¨byöt
 (
__x
))

318 
__ªs
;

323 
__asm
 
	`__vﬁ©ûe__
 ("roundsd $0xc, %1, %0" : "=x" (
__ªs
Ë: "xm" (
__x
));

324  
__ªs
;

325 
	}
}

326 
__MATH_INLINE
 

327 
__NTH
 (
	$√¨byötf
 (
__x
))

329 
__ªs
;

334 
__asm
 
	`__vﬁ©ûe__
 ("rounds†$0xc, %1, %0" : "=x" (
__ªs
Ë: "xm" (
__x
));

335  
__ªs
;

336 
	}
}

339 
	g__END_NAMESPACE_C99


342 
__BEGIN_NAMESPACE_STD


344 
__MATH_INLINE
 

345 
__NTH
 (
	$˚û
 (
__x
))

347 
__ªs
;

348 
	`__asm
 ("roundsd $2, %1, %0" : "=x" (
__ªs
Ë: "xm" (
__x
));

349  
__ªs
;

350 
	}
}

351 
__END_NAMESPACE_STD


353 
__BEGIN_NAMESPACE_C99


354 
__MATH_INLINE
 

355 
__NTH
 (
	$˚ûf
 (
__x
))

357 
__ªs
;

358 
	`__asm
 ("rounds†$2, %1, %0" : "=x" (
__ªs
Ë: "xm" (
__x
));

359  
__ªs
;

360 
	}
}

361 
__END_NAMESPACE_C99


363 
__BEGIN_NAMESPACE_STD


365 
__MATH_INLINE
 

366 
__NTH
 (
	$Êo‹
 (
__x
))

368 
__ªs
;

369 
	`__asm
 ("roundsd $1, %1, %0" : "=x" (
__ªs
Ë: "xm" (
__x
));

370  
__ªs
;

371 
	}
}

372 
__END_NAMESPACE_STD


374 
__BEGIN_NAMESPACE_C99


375 
__MATH_INLINE
 

376 
__NTH
 (
	$Êo‹f
 (
__x
))

378 
__ªs
;

379 
	`__asm
 ("rounds†$1, %1, %0" : "=x" (
__ªs
Ë: "xm" (
__x
));

380  
__ªs
;

381 
	}
}

382 
	g__END_NAMESPACE_C99


390 #i‡!
deföed
 
__SSE2_MATH__
 && !deföed 
__x86_64__


391 #i‡((!
deföed
 
__NO_MATH_INLINES
 || deföed 
__LIBC_INTERNAL_MATH_INLINES
) \

392 && 
deföed
 
	g__OPTIMIZE__
)

396 #unde‡
m©h_îrh™dlög


405 #ifde‡
__USE_ISOC99


406 
	#__ölöe_m©h›
(
func
, 
›
) \

407 
	`__ölöe_m©h›_
 (, 
func
, 
›
) \

408 
	`__ölöe_m©h›_
 (, 
	`__CONCAT
(
func
,
f
), 
›
) \

409 
	`__ölöe_m©h›_
 (, 
	`__CONCAT
(
func
,
l
), 
›
)

	)

410 
	#__ölöe_m©h›NP
(
func
, 
›
) \

411 
	`__ölöe_m©h›NP_
 (, 
func
, 
›
) \

412 
	`__ölöe_m©h›NP_
 (, 
	`__CONCAT
(
func
,
f
), 
›
) \

413 
	`__ölöe_m©h›NP_
 (, 
	`__CONCAT
(
func
,
l
), 
›
)

	)

415 
	#__ölöe_m©h›
(
func
, 
›
) \

416 
	`__ölöe_m©h›_
 (, 
func
, 
›
)

	)

417 
	#__ölöe_m©h›NP
(
func
, 
›
) \

418 
	`__ölöe_m©h›NP_
 (, 
func
, 
›
)

	)

421 
	#__ölöe_m©h›_
(
Êﬂt_ty≥
, 
func
, 
›
) \

422 
	`__ölöe_m©h›_de˛_
 (
Êﬂt_ty≥
, 
func
, 
›
, "0" (
__x
))

	)

423 
	#__ölöe_m©h›NP_
(
Êﬂt_ty≥
, 
func
, 
›
) \

424 
	`__ölöe_m©h›_de˛NP_
 (
Êﬂt_ty≥
, 
func
, 
›
, "0" (
__x
))

	)

427 #ifde‡
__USE_ISOC99


428 
	#__ölöe_m©h›_de˛
(
func
, 
›
, 
∑øms
...) \

429 
	`__ölöe_m©h›_de˛_
 (, 
func
, 
›
, 
∑øms
) \

430 
	`__ölöe_m©h›_de˛_
 (, 
	`__CONCAT
(
func
,
f
), 
›
, 
∑øms
) \

431 
	`__ölöe_m©h›_de˛_
 (, 
	`__CONCAT
(
func
,
l
), 
›
, 
∑øms
)

	)

432 
	#__ölöe_m©h›_de˛NP
(
func
, 
›
, 
∑øms
...) \

433 
	`__ölöe_m©h›_de˛NP_
 (, 
func
, 
›
, 
∑øms
) \

434 
	`__ölöe_m©h›_de˛NP_
 (, 
	`__CONCAT
(
func
,
f
), 
›
, 
∑øms
) \

435 
	`__ölöe_m©h›_de˛NP_
 (, 
	`__CONCAT
(
func
,
l
), 
›
, 
∑øms
)

	)

437 
	#__ölöe_m©h›_de˛
(
func
, 
›
, 
∑øms
...) \

438 
	`__ölöe_m©h›_de˛_
 (, 
func
, 
›
, 
∑øms
)

	)

439 
	#__ölöe_m©h›_de˛NP
(
func
, 
›
, 
∑øms
...) \

440 
	`__ölöe_m©h›_de˛NP_
 (, 
func
, 
›
, 
∑øms
)

	)

443 
	#__ölöe_m©h›_de˛_
(
Êﬂt_ty≥
, 
func
, 
›
, 
∑øms
...) \

444 
__MATH_INLINE
 
Êﬂt_ty≥
 
	`func
 (Êﬂt_ty≥Ë
__THROW
; \

445 
	`__ölöe_m©h›_de˛NP_
 (
Êﬂt_ty≥
, 
func
, 
›
, 
∑øms
)

	)

447 
	#__ölöe_m©h›_de˛NP_
(
Êﬂt_ty≥
, 
func
, 
›
, 
∑øms
...) \

448 
__MATH_INLINE
 
Êﬂt_ty≥
 
	`__NTH
 (
	`func
 (Êﬂt_ty≥ 
__x
)) \

450 
Êﬂt_ty≥
 
__ªsu…
; \

451 
__asm
 
	`__vﬁ©ûe__
 (
›
 : "Ò" (
__ªsu…
Ë: 
∑øms
); \

452  
__ªsu…
; \

453 }

	)

456 #ifde‡
__USE_ISOC99


457 
	#__ölöe_m©hcode
(
func
, 
¨g
, 
code
) \

458 
	`__ölöe_m©hcode_
 (, 
func
, 
¨g
, 
code
) \

459 
	`__ölöe_m©hcode_
 (, 
	`__CONCAT
(
func
,
f
), 
¨g
, 
code
) \

460 
	`__ölöe_m©hcode_
 (, 
	`__CONCAT
(
func
,
l
), 
¨g
, 
code
)

	)

461 
	#__ölöe_m©hcodeNP
(
func
, 
¨g
, 
code
) \

462 
	`__ölöe_m©hcodeNP_
 (, 
func
, 
¨g
, 
code
) \

463 
	`__ölöe_m©hcodeNP_
 (, 
	`__CONCAT
(
func
,
f
), 
¨g
, 
code
) \

464 
	`__ölöe_m©hcodeNP_
 (, 
	`__CONCAT
(
func
,
l
), 
¨g
, 
code
)

	)

465 
	#__ölöe_m©hcode2
(
func
, 
¨g1
, 
¨g2
, 
code
) \

466 
	`__ölöe_m©hcode2_
 (, 
func
, 
¨g1
, 
¨g2
, 
code
) \

467 
	`__ölöe_m©hcode2_
 (, 
	`__CONCAT
(
func
,
f
), 
¨g1
, 
¨g2
, 
code
) \

468 
	`__ölöe_m©hcode2_
 (, 
	`__CONCAT
(
func
,
l
), 
¨g1
, 
¨g2
, 
code
)

	)

469 
	#__ölöe_m©hcodeNP2
(
func
, 
¨g1
, 
¨g2
, 
code
) \

470 
	`__ölöe_m©hcodeNP2_
 (, 
func
, 
¨g1
, 
¨g2
, 
code
) \

471 
	`__ölöe_m©hcodeNP2_
 (, 
	`__CONCAT
(
func
,
f
), 
¨g1
, 
¨g2
, 
code
) \

472 
	`__ölöe_m©hcodeNP2_
 (, 
	`__CONCAT
(
func
,
l
), 
¨g1
, 
¨g2
, 
code
)

	)

473 
	#__ölöe_m©hcode3
(
func
, 
¨g1
, 
¨g2
, 
¨g3
, 
code
) \

474 
	`__ölöe_m©hcode3_
 (, 
func
, 
¨g1
, 
¨g2
, 
¨g3
, 
code
) \

475 
	`__ölöe_m©hcode3_
 (, 
	`__CONCAT
(
func
,
f
), 
¨g1
, 
¨g2
, 
¨g3
, 
code
) \

476 
	`__ölöe_m©hcode3_
 (, 
	`__CONCAT
(
func
,
l
), 
¨g1
, 
¨g2
, 
¨g3
, 
code
)

	)

477 
	#__ölöe_m©hcodeNP3
(
func
, 
¨g1
, 
¨g2
, 
¨g3
, 
code
) \

478 
	`__ölöe_m©hcodeNP3_
 (, 
func
, 
¨g1
, 
¨g2
, 
¨g3
, 
code
) \

479 
	`__ölöe_m©hcodeNP3_
 (, 
	`__CONCAT
(
func
,
f
), 
¨g1
, 
¨g2
, 
¨g3
, 
code
) \

480 
	`__ölöe_m©hcodeNP3_
 (, 
	`__CONCAT
(
func
,
l
), 
¨g1
, 
¨g2
, 
¨g3
, 
code
)

	)

482 
	#__ölöe_m©hcode
(
func
, 
¨g
, 
code
) \

483 
	`__ölöe_m©hcode_
 (, 
func
, (
¨g
), 
code
)

	)

484 
	#__ölöe_m©hcodeNP
(
func
, 
¨g
, 
code
) \

485 
	`__ölöe_m©hcodeNP_
 (, 
func
, (
¨g
), 
code
)

	)

486 
	#__ölöe_m©hcode2
(
func
, 
¨g1
, 
¨g2
, 
code
) \

487 
	`__ölöe_m©hcode2_
 (, 
func
, 
¨g1
, 
¨g2
, 
code
)

	)

488 
	#__ölöe_m©hcodeNP2
(
func
, 
¨g1
, 
¨g2
, 
code
) \

489 
	`__ölöe_m©hcodeNP2_
 (, 
func
, 
¨g1
, 
¨g2
, 
code
)

	)

490 
	#__ölöe_m©hcode3
(
func
, 
¨g1
, 
¨g2
, 
¨g3
, 
code
) \

491 
	`__ölöe_m©hcode3_
 (, 
func
, 
¨g1
, 
¨g2
, 
¨g3
, 
code
)

	)

492 
	#__ölöe_m©hcodeNP3
(
func
, 
¨g1
, 
¨g2
, 
¨g3
, 
code
) \

493 
	`__ölöe_m©hcodeNP3_
 (, 
func
, 
¨g1
, 
¨g2
, 
¨g3
, 
code
)

	)

496 
	#__ölöe_m©hcode_
(
Êﬂt_ty≥
, 
func
, 
¨g
, 
code
) \

497 
__MATH_INLINE
 
Êﬂt_ty≥
 
	`func
 (Êﬂt_ty≥Ë
__THROW
; \

498 
	`__ölöe_m©hcodeNP_
(
Êﬂt_ty≥
, 
func
, 
¨g
, 
code
)

	)

500 
	#__ölöe_m©hcodeNP_
(
Êﬂt_ty≥
, 
func
, 
¨g
, 
code
) \

501 
__MATH_INLINE
 
Êﬂt_ty≥
 
	`__NTH
 (
	`func
 (Êﬂt_ty≥ 
¨g
)) \

503 
code
; \

504 }

	)

507 
	#__ölöe_m©hcode2_
(
Êﬂt_ty≥
, 
func
, 
¨g1
, 
¨g2
, 
code
) \

508 
__MATH_INLINE
 
Êﬂt_ty≥
 
	`func
 (Êﬂt_ty≥, flﬂt_ty≥Ë
__THROW
; \

509 
	`__ölöe_m©hcodeNP2_
 (
Êﬂt_ty≥
, 
func
, 
¨g1
, 
¨g2
, 
code
)

	)

511 
	#__ölöe_m©hcodeNP2_
(
Êﬂt_ty≥
, 
func
, 
¨g1
, 
¨g2
, 
code
) \

512 
__MATH_INLINE
 
Êﬂt_ty≥
 
	`__NTH
 (
	`func
 (Êﬂt_ty≥ 
¨g1
, flﬂt_ty≥ 
¨g2
)) \

514 
code
; \

515 }

	)

517 
	#__ölöe_m©hcode3_
(
Êﬂt_ty≥
, 
func
, 
¨g1
, 
¨g2
, 
¨g3
, 
code
) \

518 
__MATH_INLINE
 
Êﬂt_ty≥
 
	`func
 (Êﬂt_ty≥, flﬂt_ty≥, flﬂt_ty≥Ë
__THROW
; \

519 
	`__ölöe_m©hcodeNP3_
(
Êﬂt_ty≥
, 
func
, 
¨g1
, 
¨g2
, 
¨g3
, 
code
)

	)

521 
	#__ölöe_m©hcodeNP3_
(
Êﬂt_ty≥
, 
func
, 
¨g1
, 
¨g2
, 
¨g3
, 
code
) \

522 
__MATH_INLINE
 
Êﬂt_ty≥
 
	`__NTH
 (
	`func
 (Êﬂt_ty≥ 
¨g1
, flﬂt_ty≥ 
¨g2
, \

523 
Êﬂt_ty≥
 
¨g3
)) \

525 
code
; \

526 }

	)

530 #i‡!
deföed
 
__NO_MATH_INLINES
 && deföed 
__OPTIMIZE__


534 #ifde‡
__FAST_MATH__


535 #ifde‡
__USE_GNU


536 
	#__söcos_code
 \

537 
__co§
; \

538 
__sör
; \

539 
__swtmp
; \

540 
__asm
 
__vﬁ©ûe__
 \

555 : "Ò" (
__co§
), "=u" (
__sör
), "˜" (
__swtmp
Ë: "0" (
__x
)); \

556 *
__söx
 = 
__sör
; \

557 *
__cosx
 = 
__co§


	)

559 
__MATH_INLINE
 

560 
__NTH
 (
	$__söcos
 (
__x
, *
__söx
, *
__cosx
))

562 
__söcos_code
;

563 
	}
}

565 
__MATH_INLINE
 

566 
__NTH
 (
	$__söcosf
 (
__x
, *
__söx
, *
__cosx
))

568 
__söcos_code
;

569 
	}
}

571 
__MATH_INLINE
 

572 
__NTH
 (
	$__söco¶
 (
__x
, *
__söx
, *
__cosx
))

574 
__söcos_code
;

575 
	}
}

582 #i‡
__GNUC_PREREQ
 (3, 5)

583 
	#__expm1_code
 \

584 
__ãmp
; \

585 
__ãmp
 = 
	`__buûtö_expm1l
 (
__x
); \

586  
__ãmp
 ? __ãm∞: 
__x


	)

588 
	#__expm1_code
 \

589 
__vÆue
; \

590 
__exp⁄ít
; \

591 
__ãmp
; \

592 
__asm
 
__vﬁ©ûe__
 \

601 : "Ò" (
__vÆue
), "=u" (
__exp⁄ít
Ë: "0" (
__x
)); \

602 
__asm
 
__vﬁ©ûe__
 \

604 : "Ò" (
__ãmp
Ë: "0" (1.0), "u" (
__exp⁄ít
)); \

605 
__ãmp
 -= 1.0; \

606 
__ãmp
 +
__vÆue
; \

607  
__ãmp
 ? __ãm∞: 
__x


	)

609 
	$__ölöe_m©hcodeNP_
 (, 
__expm1l
, 
__x
, 
__expm1_code
)

611 #i‡
	`__GNUC_PREREQ
 (3, 4)

612 
	`__ölöe_m©hcodeNP_
 (, 
__ex∂
, 
__x
,  
	$__buûtö_ex∂
 (
__x
))

614 
	#__exp_code
 \

615 
__vÆue
; \

616 
__exp⁄ít
; \

617 
__asm
 
__vﬁ©ûe__
 \

625 : "Ò" (
__vÆue
), "=u" (
__exp⁄ít
Ë: "0" (
__x
)); \

626 
__vÆue
 += 1.0; \

627 
__asm
 
__vﬁ©ûe__
 \

629 : "Ò" (
__vÆue
Ë: "0" (__vÆue), "u" (
__exp⁄ít
)); \

630  
__vÆue


	)

631 
	$__ölöe_m©hcodeNP
 (
exp
, 
__x
, 
__exp_code
)

632 
	$__ölöe_m©hcodeNP_
 (, 
__ex∂
, 
__x
, 
__exp_code
)

636 #i‡!
	`__GNUC_PREREQ
 (3, 5)

637 
	`__ölöe_m©hcodeNP
 (
èn
, 
__x
, \

638 
__vÆue
; \

639 
__vÆue2
 
	`__©åibuã__
 ((
__unu£d__
)); \

640 
__asm
 
__vﬁ©ûe__
 \

642 : "Ò" (
__vÆue2
), "=u" (
__vÆue
Ë: "0" (
__x
)); \

643  
__vÆue
)

648 #i‡
	`__GNUC_PREREQ
 (3, 4)

649 
	`__ölöe_m©hcodeNP2_
 (, 
__©™2l
, 
__y
, 
__x
,

650  
	$__buûtö_©™2l
 (
__y
, 
__x
))

652 
	#__©™2_code
 \

653 
__vÆue
; \

654 
__asm
 
__vﬁ©ûe__
 \

656 : "Ò" (
__vÆue
Ë: "0" (
__x
), "u" (
__y
) : "st(1)"); \

657  
__vÆue


	)

658 #ifde‡
__FAST_MATH__


659 
	$__ölöe_m©hcodeNP2
 (
©™2
, 
__y
, 
__x
, 
__©™2_code
)

661 
	$__ölöe_m©hcodeNP2_
 (, 
__©™2l
, 
__y
, 
__x
, 
__©™2_code
)

665 #i‡
deföed
 
__FAST_MATH__
 && !
	`__GNUC_PREREQ
 (3, 5)

666 
	`__ölöe_m©hcodeNP2
 (
fmod
, 
__x
, 
__y
, \

667 
__vÆue
; \

668 
__asm
 
__vﬁ©ûe__
 \

673 : "Ò" (
__vÆue
Ë: "0" (
__x
), "u" (
__y
) : "ax", "cc"); \

674  
__vÆue
)

678 #ifde‡
__FAST_MATH__


679 #i‡!
	`__GNUC_PREREQ
 (3,3)

680 
	`__ölöe_m©h›NP
 (
sqπ
, "fsqrt")

681 
	`__ölöe_m©h›NP_
 (, 
__sqπl
, "fsqrt")

682 
	#__libc_sqπl
(
n
Ë
	`__sqπl
 (n)

	)

684 
	#__libc_sqπl
(
n
Ë
	`__buûtö_sqπl
 (n)

	)

688 #i‡
	`__GNUC_PREREQ
 (2, 8)

689 
	`__ölöe_m©hcodeNP_
 (, 
Ábs
, 
__x
,  
	$__buûtö_Ábs
 (
__x
))

690 #ifde‡
__USE_ISOC99


691 
	`__ölöe_m©hcodeNP_
 (, 
Ábsf
, 
__x
,  
	$__buûtö_Ábsf
 (
__x
))

692 
	`__ölöe_m©hcodeNP_
 (, 
Áb¶
, 
__x
,  
	$__buûtö_Áb¶
 (
__x
))

694 
	`__ölöe_m©hcodeNP_
 (, 
__Áb¶
, 
__x
,  
	$__buûtö_Áb¶
 (
__x
))

696 
	`__ölöe_m©h›
 (
Ábs
, "fabs")

697 
	`__ölöe_m©h›_
 (, 
__Áb¶
, "fabs")

700 #ifde‡
__FAST_MATH__


701 #i‡!
	`__GNUC_PREREQ
 (3, 4)

703 
	`__ölöe_m©h›NP
 (
sö
, "fsin")

705 
	`__ölöe_m©h›NP
 (
cos
, "fcos")

707 
	`__ölöe_m©h›_de˛NP
 (
log
, "Êd 2; fxch; fyl2x", "0" (
__x
) : "st(1)")

710 #i‡!
	`__GNUC_PREREQ
 (3, 5)

711 
	`__ölöe_m©h›_de˛NP
 (
log10
, "Êdlg2; fxch; fyl2x", "0" (
__x
) : "st(1)")

713 
	`__ölöe_m©hcodeNP
 (
asö
, 
__x
,  
	`__©™2l
 (__x, 
	`__libc_sqπl
 (1.0 - __x * __x)))

714 
	`__ölöe_m©hcodeNP
 (
acos
, 
__x
,  
	`__©™2l
 (
	`__libc_sqπl
 (1.0 - __x * __x), __x))

717 #i‡!
	`__GNUC_PREREQ
 (3, 4)

718 
	`__ölöe_m©h›_de˛NP
 (
©™
, "Êd1; f∑èn", "0" (
__x
) : "st(1)")

722 
	`__ölöe_m©hcode_
 (, 
__sgn1l
, 
__x
, \

723 
__exãnsi⁄__
 uni⁄ { 
__xld
; 
__xi
[3]; } 
__n
 = \

724 { 
__xld
: 
__x
 
	}
}; \

725 
	g__n
.
	g__xi
[2] = (
__n
.
__xi
[2] & 0x8000) | 0x3fff; \

726 
	g__n
.
	g__xi
[1] = 0x80000000; \

727 
	g__n
.
	g__xi
[0] = 0; \

728  
	g__n
.
	g__xld
)

731 #ifde‡
__FAST_MATH__


733 
__ölöe_m©hcodeNP
 (
söh
, 
__x
, \

734 
__exm1
 = 
__expm1l
 (
__Áb¶
 (
__x
)); \

735  0.5 * (
__exm1
 / (__exm1 + 1.0Ë+ __exm1Ë* 
	$__sgn1l
 (
__x
))

737 
	`__ölöe_m©hcodeNP
 (
cosh
, 
__x
, \

738 
__ex
 = 
	`__ex∂
 (
__x
); \

739  0.5 * (
__ex
 + 1.0 / __ex))

741 
	`__ölöe_m©hcodeNP
 (
ènh
, 
__x
, \

742 
__exm1
 = 
	`__expm1l
 (-
	`__Áb¶
 (
__x
 + __x)); \

743  
__exm1
 / (__exm1 + 2.0Ë* 
	`__sgn1l
 (-
__x
))

746 
	`__ölöe_m©hcodeNP
 (
Êo‹
, 
__x
, \

747 
__vÆue
; \

748 
__ign‹e
; \

749 
__cw
; \

750 
__cwtmp
; \

751 
__asm
 
	`__vﬁ©ûe
 ("fnstcw %3\n\t" \

759 : "Ò" (
__vÆue
), "=&q" (
__ign‹e
), "=m" (
__cwtmp
), \

760 "=m" (
__cw
) \

761 : "0" (
__x
)); \

762  
__vÆue
)

764 
	`__ölöe_m©hcodeNP
 (
˚û
, 
__x
, \

765 
__vÆue
; \

766 
__ign‹e
; \

767 
__cw
; \

768 
__cwtmp
; \

769 
__asm
 
	`__vﬁ©ûe
 ("fnstcw %3\n\t" \

777 : "Ò" (
__vÆue
), "=&q" (
__ign‹e
), "=m" (
__cwtmp
), \

778 "=m" (
__cw
) \

779 : "0" (
__x
)); \

780  
__vÆue
)

782 #ifde‡
__FAST_MATH__


783 
	#__ldexp_code
 \

784 
__vÆue
; \

785 
__asm
 
__vﬁ©ûe__
 \

787 : "Ò" (
__vÆue
Ë: "0" (
__x
), "u" ((Ë
__y
)); \

788  
__vÆue


	)

790 
__MATH_INLINE
 

791 
	`__NTH
 (
	$ldexp
 (
__x
, 
__y
))

793 
__ldexp_code
;

794 
	}
}

799 #ifde‡
__USE_ISOC99


801 #ifde‡
__FAST_MATH__


802 
	$__ölöe_m©hcodeNP
 (
expm1
, 
__x
, 
__expm1_code
)

806 
	#__M_SQRT2
 1.41421356237309504880L

	)

808 #i‡!
	`__GNUC_PREREQ
 (3, 5)

809 
	`__ölöe_m©hcodeNP
 (
log1p
, 
__x
, \

810 
__vÆue
; \

811 i‡(
	`__Áb¶
 (
__x
Ë>1.0 - 0.5 * 
__M_SQRT2
) \

812 
__vÆue
 = 
	`logl
 (1.0 + 
__x
); \

814 
__asm
 
__vﬁ©ûe__
 \

818 : "Ò" (
__vÆue
Ë: "0" (
__x
) : "st(1)"); \

819  
__vÆue
)

824 
	`__ölöe_m©hcodeNP
 (
asöh
, 
__x
, \

825 
__y
 = 
	`__Áb¶
 (
__x
); \

826  (
	`log1∂
 (
__y
 * __y / (
	`__libc_sqπl
 (__y * __y + 1.0) + 1.0) + __y) \

827 * 
	$__sgn1l
 (
__x
)))

829 
	`__ölöe_m©hcodeNP
 (
acosh
, 
__x
, \

830  
	`logl
 (
__x
 + 
	`__libc_sqπl
 (__x - 1.0) * __libc_sqrtl (__x + 1.0)))

832 
	`__ölöe_m©hcodeNP
 (
©™h
, 
__x
, \

833 
__y
 = 
	`__Áb¶
 (
__x
); \

834  -0.5 * 
	`log1∂
 (-(
__y
 + __yË/ (1.0 + __y)Ë* 
	$__sgn1l
 (
__x
))

837 
	`__ölöe_m©hcodeNP2
 (
hypŸ
, 
__x
, 
__y
,

838  
	`__libc_sqπl
 (
__x
 * __x + 
__y
 * __y))

840 #i‡!
	`__GNUC_PREREQ
 (3, 5)

841 
	`__ölöe_m©hcodeNP
(
logb
, 
__x
, \

842 
__vÆue
; \

843 
__junk
; \

844 
__asm
 
__vﬁ©ûe__
 \

846 : "Ò" (
__junk
), "=u" (
__vÆue
Ë: "0" (
__x
)); \

847  
__vÆue
)

853 #ifde‡
__USE_ISOC99


854 #ifde‡
__FAST_MATH__


856 #i‡!
	`__GNUC_PREREQ
 (3, 5)

857 
	`__ölöe_m©h›_de˛NP
 (
log2
, "Êd1; fxch; fyl2x", "0" (
__x
) : "st(1)")

860 
__MATH_INLINE
 

861 
	`__NTH
 (
	$ldexpf
 (
__x
, 
__y
))

863 
__ldexp_code
;

864 
	}
}

866 
__MATH_INLINE
 

867 
__NTH
 (
	$ldex∂
 (
__x
, 
__y
))

869 
__ldexp_code
;

870 
	}
}

872 
__ölöe_m©h›NP
 (
röt
, "frndint")

875 
	#__Ãöt_code
 \

876 
__Ãöåes
; \

877 
__asm__
 
__vﬁ©ûe__
 \

879 : "=m" (
__Ãöåes
Ë: "t" (
__x
) : "st"); \

880  
__Ãöåes


	)

881 
__MATH_INLINE
 

882 
__NTH
 (
	$Ãötf
 (
__x
))

884 
__Ãöt_code
;

885 
	}
}

886 
__MATH_INLINE
 

887 
__NTH
 (
	$Ãöt
 (
__x
))

889 
__Ãöt_code
;

890 
	}
}

891 
__MATH_INLINE
 

892 
__NTH
 (
	$Ãöé
 (
__x
))

894 
__Ãöt_code
;

895 
	}
}

896 #unde‡
__Ãöt_code


898 
	#__Œröt_code
 \

899 
__Œröåes
; \

900 
__asm__
 
__vﬁ©ûe__
 \

902 : "=m" (
__Œröåes
Ë: "t" (
__x
) : "st"); \

903  
__Œröåes


	)

904 
__exãnsi⁄__


905 
__MATH_INLINE
 

906 
__NTH
 (
	$Œrötf
 (
__x
))

908 
__Œröt_code
;

909 
	}
}

910 
__exãnsi⁄__


911 
__MATH_INLINE
 

912 
__NTH
 (
	$Œröt
 (
__x
))

914 
__Œröt_code
;

915 
	}
}

916 
__exãnsi⁄__


917 
__MATH_INLINE
 

918 
__NTH
 (
	$Œröé
 (
__x
))

920 
__Œröt_code
;

921 
	}
}

922 #unde‡
__Œröt_code


927 #ifde‡
__USE_MISC


929 #i‡
deföed
 
__FAST_MATH__
 && !
__GNUC_PREREQ
 (3, 5)

930 
__ölöe_m©hcodeNP2
 (
dªm
, 
__x
, 
__y
, \

931 
__vÆue
; \

932 
__˛obbîed
; \

933 
__asm
 
__vﬁ©ûe__
 \

938 : "Ò" (
__vÆue
), "=&a" (
__˛obbîed
Ë: "0" (
__x
), "u" (
__y
) : "cc"); \

939  
__vÆue
)

944 
__MATH_INLINE
 

945 
__NTH
 (
	$__föôe
 (
__x
))

947  (
__exãnsi⁄__


948 (((((uni⁄ { 
__d
; 
__i
[2]; }Ë{__d: 
__x
}).__i[1]

950 
	}
}

955 #unde‡
__©™2_code


956 #ifde‡
__FAST_MATH__


957 #unde‡
__expm1_code


958 #unde‡
__exp_code


959 #unde‡
__söcos_code


966 #ifde‡
__LIBC_INTERNAL_MATH_INLINES


967 
__ölöe_m©h›
 (
__õì754_sqπ
, "fsqrt")

968 
__ölöe_m©hcode2_
 (, 
__õì754_©™2l
, 
__y
, 
__x
,

969 
__vÆue
;

970 
__asm
 
__vﬁ©ûe__
 ("fpatan\n\t"

971 : "Ò" (
__vÆue
)

972 : "0" (
__x
), "u" (
__y
) : "st(1)");

973  
__vÆue
;)

	@/usr/include/bits/nan.h

19 #i‚de‡
_MATH_H


26 #i‡
__GNUC_PREREQ
(3,3)

28 
	#NAN
 (
	`__buûtö_«nf
 (""))

	)

30 #ñi‡
deföed
 
__GNUC__


32 
	#NAN
 \

33 (
__exãnsi⁄__
 \

34 ((uni⁄ { 
__l
 
	`__©åibuã__
 ((
	`__mode__
 (
__SI__
))); 
__d
; }) \

35 { 
__l
: 0x7fc00000UL }).
__d
)

	)

39 
	~<ídün.h
>

41 #i‡
__BYTE_ORDER
 =
__BIG_ENDIAN


42 
	#__q«n_byãs
 { 0x7f, 0xc0, 0, 0 }

	)

44 #i‡
__BYTE_ORDER
 =
__LITTLE_ENDIAN


45 
	#__q«n_byãs
 { 0, 0, 0xc0, 0x7‡}

	)

48 uni⁄ { 
	m__c
[4]; 
	m__d
; } 
__q«n_uni⁄


49 
__©åibuã__
 ((
__unu£d__
)Ë{ 
__q«n_byãs
 };

50 
	#NAN
 (
__q«n_uni⁄
.
__d
)

	)

	@/usr/include/bits/stdlib-bsearch.h

19 
__exã∫_ölöe
 *

20 
	$b£¨ch
 (c⁄° *
__key
, c⁄° *
__ba£
, 
size_t
 
__nmemb
, size_à
__size
,

21 
__com∑r_‚_t
 
__com∑r
)

23 
size_t
 
__l
, 
__u
, 
__idx
;

24 c⁄° *
__p
;

25 
__com∑ris⁄
;

27 
__l
 = 0;

28 
__u
 = 
__nmemb
;

29 
__l
 < 
__u
)

31 
__idx
 = (
__l
 + 
__u
) / 2;

32 
__p
 = (*Ë(((c⁄° *Ë
__ba£
Ë+ (
__idx
 * 
__size
));

33 
__com∑ris⁄
 = (*
__com∑r
Ë(
__key
, 
__p
);

34 i‡(
__com∑ris⁄
 < 0)

35 
__u
 = 
__idx
;

36 i‡(
__com∑ris⁄
 > 0)

37 
__l
 = 
__idx
 + 1;

39  (*Ë
__p
;

42  
NULL
;

43 
	}
}

	@/usr/include/bits/stdlib-float.h

19 #i‚de‡
_STDLIB_H


23 #ifde‡
__USE_EXTERN_INLINES


24 
__BEGIN_NAMESPACE_STD


25 
__exã∫_ölöe
 

26 
__NTH
 (
	$©of
 (c⁄° *
__≈å
))

28  
	`°πod
 (
__≈å
, (**Ë
NULL
);

29 
	}
}

30 
	g__END_NAMESPACE_STD


	@/usr/include/bits/stdlib-ldbl.h

19 #i‚de‡
_STDLIB_H


23 #ifdef 
__USE_ISOC99


24 
__BEGIN_NAMESPACE_C99


25 
	$__LDBL_REDIR1_DECL
 (
°πﬁd
, 
°πod
)

26 
__END_NAMESPACE_C99


29 #ifde‡
__USE_GNU


30 
	$__LDBL_REDIR1_DECL
 (
°πﬁd_l
, 
°πod_l
)

33 #i‡
	`__GLIBC_USE
 (
IEC_60559_BFP_EXT
)

34 
	$__LDBL_REDIR1_DECL
 (
°r‰oml
, 
°r‰omd
)

37 #ifde‡
__USE_MISC


38 
	$__LDBL_REDIR1_DECL
 (
qecvt
, 
ecvt
)

39 
	$__LDBL_REDIR1_DECL
 (
qfcvt
, 
fcvt
)

40 
	$__LDBL_REDIR1_DECL
 (
qgcvt
, 
gcvt
)

41 
	$__LDBL_REDIR1_DECL
 (
qecvt_r
, 
ecvt_r
)

42 
	$__LDBL_REDIR1_DECL
 (
qfcvt_r
, 
fcvt_r
)

	@/usr/include/bits/stdlib.h

19 #i‚de‡
_STDLIB_H


23 *
	$__ªÆ∑th_chk
 (c⁄° *
__ª°ri˘
 
__«me
,

24 *
__ª°ri˘
 
__ªsﬁved
,

25 
size_t
 
__ªsﬁvedÀn
Ë
__THROW
 
__wur
;

26 *
	`__REDIRECT_NTH
 (
__ªÆ∑th_Æüs
,

27 (c⁄° *
__ª°ri˘
 
__«me
,

28 *
__ª°ri˘
 
__ªsﬁved
), 
ªÆ∑th
Ë
__wur
;

29 *
	`__REDIRECT_NTH
 (
__ªÆ∑th_chk_w¨n
,

30 (c⁄° *
__ª°ri˘
 
__«me
,

31 *
__ª°ri˘
 
__ªsﬁved
,

32 
size_t
 
__ªsﬁvedÀn
), 
__ªÆ∑th_chk
Ë
__wur


33 
	`__w¨«âr
 ("secondárgument ofÑealpath must beÉither NULL orát "

36 
__f‹tify_fun˘i⁄
 
__wur
 *

37 
	`__NTH
 (
	$ªÆ∑th
 (c⁄° *
__ª°ri˘
 
__«me
, *__ª°ri˘ 
__ªsﬁved
))

39 i‡(
	`__bos
 (
__ªsﬁved
Ë!(
size_t
) -1)

41 #i‡
deföed
 
_LIBC_LIMITS_H_
 && deföed 
PATH_MAX


42 i‡(
	`__bos
 (
__ªsﬁved
Ë< 
PATH_MAX
)

43  
	`__ªÆ∑th_chk_w¨n
 (
__«me
, 
__ªsﬁved
, 
	`__bos
 (__resolved));

45  
	`__ªÆ∑th_chk
 (
__«me
, 
__ªsﬁved
, 
	`__bos
 (__resolved));

48  
	`__ªÆ∑th_Æüs
 (
__«me
, 
__ªsﬁved
);

49 
	}
}

52 
	$__±¢ame_r_chk
 (
__fd
, *
__buf
, 
size_t
 
__buÊí
,

53 
size_t
 
__ƒól
Ë
__THROW
 
	`__n⁄nuŒ
 ((2));

54 
	`__REDIRECT_NTH
 (
__±¢ame_r_Æüs
, (
__fd
, *
__buf
,

55 
size_t
 
__buÊí
), 
±¢ame_r
)

56 
	`__n⁄nuŒ
 ((2));

57 
	`__REDIRECT_NTH
 (
__±¢ame_r_chk_w¨n
,

58 (
__fd
, *
__buf
, 
size_t
 
__buÊí
,

59 
size_t
 
__ƒól
), 
__±¢ame_r_chk
)

60 
	`__n⁄nuŒ
 ((2)Ë
	`__w¨«âr
 ("ptsname_r called with buflen biggerÅhan "

63 
__f‹tify_fun˘i⁄
 

64 
	`__NTH
 (
	$±¢ame_r
 (
__fd
, *
__buf
, 
size_t
 
__buÊí
))

66 i‡(
	`__bos
 (
__buf
Ë!(
size_t
) -1)

68 i‡(!
	`__buûtö_c⁄°™t_p
 (
__buÊí
))

69  
	`__±¢ame_r_chk
 (
__fd
, 
__buf
, 
__buÊí
, 
	`__bos
 (__buf));

70 i‡(
__buÊí
 > 
	`__bos
 (
__buf
))

71  
	`__±¢ame_r_chk_w¨n
 (
__fd
, 
__buf
, 
__buÊí
, 
	`__bos
 (__buf));

73  
	`__±¢ame_r_Æüs
 (
__fd
, 
__buf
, 
__buÊí
);

74 
	}
}

77 
	$__w˘omb_chk
 (*
__s
, 
wch¨_t
 
__wch¨
, 
size_t
 
__buÊí
)

78 
__THROW
 
__wur
;

79 
	`__REDIRECT_NTH
 (
__w˘omb_Æüs
, (*
__s
, 
wch¨_t
 
__wch¨
),

80 
w˘omb
Ë
__wur
;

82 
__f‹tify_fun˘i⁄
 
__wur
 

83 
	`__NTH
 (
	$w˘omb
 (*
__s
, 
wch¨_t
 
__wch¨
))

88 
	#__STDLIB_MB_LEN_MAX
 16

	)

89 #i‡
deföed
 
MB_LEN_MAX
 && MB_LEN_MAX !
__STDLIB_MB_LEN_MAX


92 i‡(
	`__bos
 (
__s
Ë!(
size_t
Ë-1 && 
__STDLIB_MB_LEN_MAX
 > __bos (__s))

93  
	`__w˘omb_chk
 (
__s
, 
__wch¨
, 
	`__bos
 (__s));

94  
	`__w˘omb_Æüs
 (
__s
, 
__wch¨
);

95 
	}
}

98 
size_t
 
	$__mb°owcs_chk
 (
wch¨_t
 *
__ª°ri˘
 
__d°
,

99 c⁄° *
__ª°ri˘
 
__§c
,

100 
size_t
 
__Àn
, size_à
__d°Àn
Ë
__THROW
;

101 
size_t
 
	`__REDIRECT_NTH
 (
__mb°owcs_Æüs
,

102 (
wch¨_t
 *
__ª°ri˘
 
__d°
,

103 c⁄° *
__ª°ri˘
 
__§c
,

104 
size_t
 
__Àn
), 
mb°owcs
);

105 
size_t
 
	`__REDIRECT_NTH
 (
__mb°owcs_chk_w¨n
,

106 (
wch¨_t
 *
__ª°ri˘
 
__d°
,

107 c⁄° *
__ª°ri˘
 
__§c
,

108 
size_t
 
__Àn
, size_à
__d°Àn
), 
__mb°owcs_chk
)

109 
	`__w¨«âr
 ("mbstowcs called with dst buffer smallerÅhanÜen "

112 
__f‹tify_fun˘i⁄
 
size_t


113 
	`__NTH
 (
	$mb°owcs
 (
wch¨_t
 *
__ª°ri˘
 
__d°
, c⁄° *__ª°ri˘ 
__§c
,

114 
size_t
 
__Àn
))

116 i‡(
	`__bos
 (
__d°
Ë!(
size_t
) -1)

118 i‡(!
	`__buûtö_c⁄°™t_p
 (
__Àn
))

119  
	`__mb°owcs_chk
 (
__d°
, 
__§c
, 
__Àn
,

120 
	`__bos
 (
__d°
Ë/  (
wch¨_t
));

122 i‡(
__Àn
 > 
	`__bos
 (
__d°
Ë/  (
wch¨_t
))

123  
	`__mb°owcs_chk_w¨n
 (
__d°
, 
__§c
, 
__Àn
,

124 
	`__bos
 (
__d°
Ë/  (
wch¨_t
));

126  
	`__mb°owcs_Æüs
 (
__d°
, 
__§c
, 
__Àn
);

127 
	}
}

130 
size_t
 
	$__wc°ombs_chk
 (*
__ª°ri˘
 
__d°
,

131 c⁄° 
wch¨_t
 *
__ª°ri˘
 
__§c
,

132 
size_t
 
__Àn
, size_à
__d°Àn
Ë
__THROW
;

133 
size_t
 
	`__REDIRECT_NTH
 (
__wc°ombs_Æüs
,

134 (*
__ª°ri˘
 
__d°
,

135 c⁄° 
wch¨_t
 *
__ª°ri˘
 
__§c
,

136 
size_t
 
__Àn
), 
wc°ombs
);

137 
size_t
 
	`__REDIRECT_NTH
 (
__wc°ombs_chk_w¨n
,

138 (*
__ª°ri˘
 
__d°
,

139 c⁄° 
wch¨_t
 *
__ª°ri˘
 
__§c
,

140 
size_t
 
__Àn
, size_à
__d°Àn
), 
__wc°ombs_chk
)

141 
	`__w¨«âr
 ("wcstombs called with dst buffer smallerÅhanÜen");

143 
__f‹tify_fun˘i⁄
 
size_t


144 
	`__NTH
 (
	$wc°ombs
 (*
__ª°ri˘
 
__d°
, c⁄° 
wch¨_t
 *__ª°ri˘ 
__§c
,

145 
size_t
 
__Àn
))

147 i‡(
	`__bos
 (
__d°
Ë!(
size_t
) -1)

149 i‡(!
	`__buûtö_c⁄°™t_p
 (
__Àn
))

150  
	`__wc°ombs_chk
 (
__d°
, 
__§c
, 
__Àn
, 
	`__bos
 (__dst));

151 i‡(
__Àn
 > 
	`__bos
 (
__d°
))

152  
	`__wc°ombs_chk_w¨n
 (
__d°
, 
__§c
, 
__Àn
, 
	`__bos
 (__dst));

154  
	`__wc°ombs_Æüs
 (
__d°
, 
__§c
, 
__Àn
);

155 
	}
}

	@/usr/include/bits/string.h

19 #i‚de‡
_STRING_H


24 
	#_STRING_INLINE_u«lig√d
 1

	)

27 
	#_HAVE_STRING_ARCH_memp˝y
 1

	)

31 #i‡!
deföed
 
__x86_64__
 && (deföed 
__i486__
 || deföed 
__≥¡ium__
 \

32 || 
deföed
 
	g__≥¡ium¥o__
 || deföed 
	g__≥¡ium4__
 \

33 || 
deföed
 
	g__noc⁄a__
 || deföed 
	g__©om__
 \

34 || 
deföed
 
	g__c‹e2__
 || deföed 
	g__c‹ei7__
 \

35 || 
deföed
 
	g__ßndybridge__
 || deföed 
	g__haswñl__
 \

36 || 
deföed
 
	g__b⁄√Œ__
 || deföed 
	g__sûvîm⁄t__
 \

37 || 
deföed
 
	g__k6__
 || deföed 
	g__geode__
 \

38 || 
deföed
 
	g__k8__
 || deföed 
	g__©hl⁄__
 \

39 || 
deföed
 
	g__amdÁm10__
 || deföed 
	g__bdvî1__
 \

40 || 
deföed
 
	g__bdvî2__
 || deföed 
	g__bdvî3__
 \

41 || 
deföed
 
	g__bdvî4__
 || deföed 
	g__btvî1__
 \

42 || 
deföed
 
	g__btvî2__
)

46 #i‡!
deföed
 
__NO_STRING_INLINES
 && deföed 
__USE_STRING_INLINES
 \

47 && 
deföed
 
	g__GNUC__
 && __GNUC__ >= 2

49 #i‚de‡
__STRING_INLINE


50 #i‚de‡
__exã∫_ölöe


51 
	#__STRING_INLINE
 
ölöe


	)

53 
	#__STRING_INLINE
 
__exã∫_ölöe


	)

58 
	#__STRING_SMALL_GET16
(
§c
, 
idx
) \

59 ((((c⁄° *Ë(
§c
))[
idx
 + 1] << 8) \

60 | ((c⁄° *Ë(
§c
))[
idx
])

	)

61 
	#__STRING_SMALL_GET32
(
§c
, 
idx
) \

62 (((((c⁄° *Ë(
§c
))[
idx
 + 3] << 8 \

63 | ((c⁄° *Ë(
§c
))[
idx
 + 2]) << 8 \

64 | ((c⁄° *Ë(
§c
))[
idx
 + 1]) << 8 \

65 | ((c⁄° *Ë(
§c
))[
idx
])

	)

69 
	#_HAVE_STRING_ARCH_mem˝y
 1

	)

70 
	#mem˝y
(
de°
, 
§c
, 
n
) \

71 (
	`__exãnsi⁄__
 (
	`__buûtö_c⁄°™t_p
 (
n
) \

72 ? 
	`__mem˝y_c
 ((
de°
), (
§c
), (
n
)) \

73 : 
	`__mem˝y_g
 ((
de°
), (
§c
), (
n
))))

	)

74 
	#__mem˝y_c
(
de°
, 
§c
, 
n
) \

75 ((
n
) == 0 \

76 ? (
de°
) \

77 : (((
n
) % 4 == 0) \

78 ? 
	`__mem˝y_by4
 (
de°
, 
§c
, 
n
) \

79 : (((
n
) % 2 == 0) \

80 ? 
	`__mem˝y_by2
 (
de°
, 
§c
, 
n
) \

81 : 
	`__mem˝y_g
 (
de°
, 
§c
, 
n
))))

	)

83 
__STRING_INLINE
 *
__mem˝y_by4
 (*
__de°
, c⁄° *
__§c
,

84 
size_t
 
__n
);

86 
__STRING_INLINE
 *

87 
	$__mem˝y_by4
 (*
__de°
, c⁄° *
__§c
, 
size_t
 
__n
)

89 
__d0
, 
__d1
;

90 *
__tmp
 = 
__de°
;

91 
__asm__
 
__vﬁ©ûe__


99 : "=&r" (
__d0
), "=&r" (
__tmp
), "=&r" (
__§c
), "=&r" (
__d1
)

100 : "1" (
__tmp
), "2" (
__§c
), "3" (
__n
 / 4)

102  
__de°
;

103 
	}
}

105 
__STRING_INLINE
 *
__mem˝y_by2
 (*
__de°
, c⁄° *
__§c
,

106 
size_t
 
__n
);

108 
__STRING_INLINE
 *

109 
	$__mem˝y_by2
 (*
__de°
, c⁄° *
__§c
, 
size_t
 
__n
)

111 
__d0
, 
__d1
;

112 *
__tmp
 = 
__de°
;

113 
__asm__
 
__vﬁ©ûe__


126 : "=&q" (
__d0
), "=&r" (
__tmp
), "=&r" (
__§c
), "=&r" (
__d1
)

127 : "1" (
__tmp
), "2" (
__§c
), "3" (
__n
 / 2)

129  
__de°
;

130 
	}
}

132 
__STRING_INLINE
 *
__mem˝y_g
 (*
__de°
, c⁄° *
__§c
, 
size_t
 
__n
);

134 
__STRING_INLINE
 *

135 
	$__mem˝y_g
 (*
__de°
, c⁄° *
__§c
, 
size_t
 
__n
)

137 
__d0
, 
__d1
, 
__d2
;

138 *
__tmp
 = 
__de°
;

139 
__asm__
 
__vﬁ©ûe__


150 : "=&c" (
__d0
), "=&D" (
__d1
), "=&S" (
__d2
),

151 "=m" ( *(°ru˘ { 
__exãnsi⁄__
 
__x
[
__n
]; } *)
__de°
)

152 : "0" (
__n
), "1" (
__tmp
), "2" (
__§c
),

153 "m" ( *(°ru˘ { 
__exãnsi⁄__
 
__x
[
__n
]; } *)
__§c
)

155  
__de°
;

156 
	}
}

158 
	#_HAVE_STRING_ARCH_memmove
 1

	)

159 #i‚de‡
_FORCE_INLINES


162 
	#memmove
(
de°
, 
§c
, 
n
Ë
	`__memmove_g
 (de°, src,Ç)

	)

164 
__STRING_INLINE
 *
	$__memmove_g
 (*, c⁄° *, 
size_t
)

165 
	`__asm__
 ("memmove");

167 
__STRING_INLINE
 *

168 
	$__memmove_g
 (*
__de°
, c⁄° *
__§c
, 
size_t
 
__n
)

170 
__d0
, 
__d1
, 
__d2
;

171 *
__tmp
 = 
__de°
;

172 i‡(
__de°
 < 
__§c
)

173 
__asm__
 
__vﬁ©ûe__


176 : "=&c" (
__d0
), "=&S" (
__d1
), "=&D" (
__d2
),

177 "=m" ( *(°ru˘ { 
__exãnsi⁄__
 
__x
[
__n
]; } *)
__de°
)

178 : "0" (
__n
), "1" (
__§c
), "2" (
__tmp
),

179 "m" ( *(°ru˘ { 
__exãnsi⁄__
 
__x
[
__n
]; } *)
__§c
));

181 
__asm__
 
__vﬁ©ûe__


187 : "=&c" (
__d0
), "=&S" (
__d1
), "=&D" (
__d2
),

188 "=m" ( *(°ru˘ { 
__exãnsi⁄__
 
__x
[
__n
]; } *)
__de°
)

189 : "0" (
__n
), "1" (__¿+ (c⁄° *Ë
__§c
),

190 "2" (
__n
 + (*Ë
__tmp
),

191 "m" ( *(°ru˘ { 
__exãnsi⁄__
 
__x
[
__n
]; } *)
__§c
));

192  
__de°
;

193 
	}
}

197 
	#_HAVE_STRING_ARCH_memcmp
 1

	)

198 #i‚de‡
_FORCE_INLINES


199 #i‚de‡
__PIC__


201 
__STRING_INLINE
 

202 
	$memcmp
 (c⁄° *
__s1
, c⁄° *
__s2
, 
size_t
 
__n
)

204 
__d0
, 
__d1
, 
__d2
;

205 
__ªs
;

206 
__asm__
 
__vﬁ©ûe__


214 : "=&a" (
__ªs
), "=&S" (
__d0
), "=&D" (
__d1
), "=&c" (
__d2
)

215 : "0" (0), "1" (
__s1
), "2" (
__s2
), "3" (
__n
),

216 "m" ( *(°ru˘ { 
__exãnsi⁄__
 
__x
[
__n
]; } *)
__s1
),

217 "m" ( *(°ru˘ { 
__exãnsi⁄__
 
__x
[
__n
]; } *)
__s2
)

219  
__ªs
;

220 
	}
}

225 
	#_HAVE_STRING_ARCH_mem£t
 1

	)

226 
	#_USE_STRING_ARCH_mem£t
 1

	)

227 
	#mem£t
(
s
, 
c
, 
n
) \

228 (
	`__exãnsi⁄__
 (
	`__buûtö_c⁄°™t_p
 (
n
) && (n) <= 16 \

229 ? ((
n
) == 1 \

230 ? 
	`__mem£t_c1
 ((
s
), (
c
)) \

231 : 
	`__mem£t_gc
 ((
s
), (
c
), (
n
))) \

232 : (
	`__buûtö_c⁄°™t_p
 (
c
) \

233 ? (
	`__buûtö_c⁄°™t_p
 (
n
) \

234 ? 
	`__mem£t_c˙
 ((
s
), (
c
), (
n
)) \

235 : 
	`mem£t
 ((
s
), (
c
), (
n
))) \

236 : (
	`__buûtö_c⁄°™t_p
 (
n
) \

237 ? 
	`__mem£t_g˙
 ((
s
), (
c
), (
n
)) \

238 : 
	`mem£t
 ((
s
), (
c
), (
n
))))))

	)

240 
	#__mem£t_c1
(
s
, 
c
Ë({ *
__s
 = (s); \

241 *((*Ë
__s
Ë(Ë(
c
); \

242 
__s
; })

	)

244 
	#__mem£t_gc
(
s
, 
c
, 
n
) \

245 ({ *
__s
 = (
s
); \

247 
__ui
; \

248 
__usi
; \

249 
__uc
; \

250 } *
__u
 = 
__s
; \

251 
__c
 = ((Ë((Ë(
c
))) * 0x01010101; \

257 i‡((
n
) == 3 || (n) >= 5) \

258 
__asm__
 
	`__vﬁ©ûe__
 ("" : "Ù" (
__c
) : "0" (__c)); \

261 
n
) \

264 
__u
->
__ui
 = 
__c
; \

265 
__u
 = 
	`__exãnsi⁄__
 ((*) __u + 4); \

267 
__u
->
__ui
 = 
__c
; \

268 
__u
 = 
	`__exãnsi⁄__
 ((*) __u + 4); \

270 
__u
->
__ui
 = 
__c
; \

271 
__u
 = 
	`__exãnsi⁄__
 ((*) __u + 4); \

273 
__u
->
__usi
 = (Ë
__c
; \

274 
__u
 = 
	`__exãnsi⁄__
 ((*) __u + 2); \

275 
__u
->
__uc
 = (Ë
__c
; \

279 
__u
->
__ui
 = 
__c
; \

280 
__u
 = 
	`__exãnsi⁄__
 ((*) __u + 4); \

282 
__u
->
__ui
 = 
__c
; \

283 
__u
 = 
	`__exãnsi⁄__
 ((*) __u + 4); \

285 
__u
->
__ui
 = 
__c
; \

286 
__u
 = 
	`__exãnsi⁄__
 ((*) __u + 4); \

288 
__u
->
__usi
 = (Ë
__c
; \

292 
__u
->
__ui
 = 
__c
; \

293 
__u
 = 
	`__exãnsi⁄__
 ((*) __u + 4); \

295 
__u
->
__ui
 = 
__c
; \

296 
__u
 = 
	`__exãnsi⁄__
 ((*) __u + 4); \

298 
__u
->
__ui
 = 
__c
; \

299 
__u
 = 
	`__exãnsi⁄__
 ((*) __u + 4); \

301 
__u
->
__uc
 = (Ë
__c
; \

305 
__u
->
__ui
 = 
__c
; \

306 
__u
 = 
	`__exãnsi⁄__
 ((*) __u + 4); \

308 
__u
->
__ui
 = 
__c
; \

309 
__u
 = 
	`__exãnsi⁄__
 ((*) __u + 4); \

311 
__u
->
__ui
 = 
__c
; \

312 
__u
 = 
	`__exãnsi⁄__
 ((*) __u + 4); \

314 
__u
->
__ui
 = 
__c
; \

319 
__s
; })

	)

321 
	#__mem£t_c˙
(
s
, 
c
, 
n
) \

322 (((
n
) % 4 == 0) \

323 ? 
	`__mem£t_c˙_by4
 (
s
, ((Ë((Ë(
c
))) * 0x01010101,\

324 
n
) \

325 : (((
n
) % 2 == 0) \

326 ? 
	`__mem£t_c˙_by2
 (
s
, \

327 ((Ë((Ë(
c
))) * 0x01010101,\

328 
n
) \

329 : 
	`mem£t
 (
s
, 
c
, 
n
)))

	)

331 
__STRING_INLINE
 *
__mem£t_c˙_by4
 (*
__s
, 
__c
,

332 
size_t
 
__n
);

334 
__STRING_INLINE
 *

335 
	$__mem£t_c˙_by4
 (*
__s
, 
__c
, 
size_t
 
__n
)

337 *
__tmp
 = 
__s
;

338 
__d0
;

339 #ifde‡
__i686__


340 
__asm__
 
__vﬁ©ûe__


343 : "=&a" (
__c
), "=&D" (
__tmp
), "=&c" (
__d0
),

344 "=m" ( *(°ru˘ { 
__exãnsi⁄__
 
__x
[
__n
]; } *)
__s
)

345 : "0" ((Ë
__c
), "1" (
__tmp
), "2" (
__n
 / 4)

348 
__asm__
 
__vﬁ©ûe__


354 : "=&r" (
__c
), "=&r" (
__tmp
), "=&r" (
__d0
),

355 "=m" ( *(°ru˘ { 
__exãnsi⁄__
 
__x
[
__n
]; } *)
__s
)

356 : "0" ((Ë
__c
), "1" (
__tmp
), "2" (
__n
 / 4)

359  
__s
;

360 
	}
}

362 
__STRING_INLINE
 *
__mem£t_c˙_by2
 (*
__s
, 
__c
,

363 
size_t
 
__n
);

365 
__STRING_INLINE
 *

366 
	$__mem£t_c˙_by2
 (*
__s
, 
__c
, 
size_t
 
__n
)

368 
__d0
, 
__d1
;

369 *
__tmp
 = 
__s
;

370 #ifde‡
__i686__


371 
__asm__
 
__vﬁ©ûe__


375 : "=&a" (
__d0
), "=&D" (
__tmp
), "=&c" (
__d1
),

376 "=m" ( *(°ru˘ { 
__exãnsi⁄__
 
__x
[
__n
]; } *)
__s
)

377 : "0" ((Ë
__c
), "1" (
__tmp
), "2" (
__n
 / 4)

380 
__asm__
 
__vﬁ©ûe__


386 : "=&q" (
__d0
), "=&r" (
__tmp
), "=&r" (
__d1
),

387 "=m" ( *(°ru˘ { 
__exãnsi⁄__
 
__x
[
__n
]; } *)
__s
)

388 : "0" ((Ë
__c
), "1" (
__tmp
), "2" (
__n
 / 4)

391  
__s
;

392 
	}
}

394 
	#__mem£t_g˙
(
s
, 
c
, 
n
) \

395 (((
n
) % 4 == 0) \

396 ? 
	`__mem£t_g˙_by4
 (
s
, 
c
, 
n
) \

397 : (((
n
) % 2 == 0) \

398 ? 
	`__mem£t_g˙_by2
 (
s
, 
c
, 
n
) \

399 : 
	`mem£t
 (
s
, 
c
, 
n
)))

	)

401 
__STRING_INLINE
 *
__mem£t_g˙_by4
 (*
__s
, 
__c
, 
size_t
 
__n
);

403 
__STRING_INLINE
 *

404 
	$__mem£t_g˙_by4
 (*
__s
, 
__c
, 
size_t
 
__n
)

406 *
__tmp
 = 
__s
;

407 
__d0
;

408 
__asm__
 
__vﬁ©ûe__


418 : "=&q" (
__c
), "=&r" (
__tmp
), "=&r" (
__d0
),

419 "=m" ( *(°ru˘ { 
__exãnsi⁄__
 
__x
[
__n
]; } *)
__s
)

420 : "0" ((Ë
__c
), "1" (
__tmp
), "2" (
__n
 / 4)

422  
__s
;

423 
	}
}

425 
__STRING_INLINE
 *
__mem£t_g˙_by2
 (*
__s
, 
__c
, 
size_t
 
__n
);

427 
__STRING_INLINE
 *

428 
	$__mem£t_g˙_by2
 (*
__s
, 
__c
, 
size_t
 
__n
)

430 
__d0
, 
__d1
;

431 *
__tmp
 = 
__s
;

432 
__asm__
 
__vﬁ©ûe__


443 : "=&q" (
__d0
), "=&r" (
__tmp
), "=&r" (
__d1
),

444 "=m" ( *(°ru˘ { 
__exãnsi⁄__
 
__x
[
__n
]; } *)
__s
)

445 : "0" ((Ë
__c
), "1" (
__tmp
), "2" (
__n
 / 4)

447  
__s
;

448 
	}
}

452 
	#_HAVE_STRING_ARCH_memchr
 1

	)

453 #i‚de‡
_FORCE_INLINES


454 
__STRING_INLINE
 *

455 
	$memchr
 (c⁄° *
__s
, 
__c
, 
size_t
 
__n
)

457 
__d0
;

458 #ifde‡
__i686__


459 
__d1
;

461 *
__ªs
;

462 i‡(
__n
 == 0)

463  
NULL
;

464 #ifde‡
__i686__


465 
__asm__
 
__vﬁ©ûe__


469 : "=D" (
__ªs
), "=&c" (
__d0
), "=&r" (
__d1
)

470 : "a" (
__c
), "0" (
__s
), "1" (
__n
), "2" (1),

471 "m" ( *(°ru˘ { 
__exãnsi⁄__
 
__x
[
__n
]; } *)
__s
)

474 
__asm__
 
__vﬁ©ûe__


480 : "=D" (
__ªs
), "=&c" (
__d0
)

481 : "a" (
__c
), "0" (
__s
), "1" (
__n
),

482 "m" ( *(°ru˘ { 
__exãnsi⁄__
 
__x
[
__n
]; } *)
__s
)

485  
__ªs
 - 1;

486 
	}
}

489 
	#_HAVE_STRING_ARCH_memrchr
 1

	)

490 #i‚de‡
_FORCE_INLINES


491 
__STRING_INLINE
 *
__memrchr
 (c⁄° *
__s
, 
__c
, 
size_t
 
__n
);

493 
__STRING_INLINE
 *

494 
	$__memrchr
 (c⁄° *
__s
, 
__c
, 
size_t
 
__n
)

496 
__d0
;

497 #ifde‡
__i686__


498 
__d1
;

500 *
__ªs
;

501 i‡(
__n
 == 0)

502  
NULL
;

503 #ifde‡
__i686__


504 
__asm__
 
__vﬁ©ûe__


510 : "=D" (
__ªs
), "=&c" (
__d0
), "=&r" (
__d1
)

511 : "a" (
__c
), "0" (
__s
 + 
__n
 - 1), "1" (__n), "2" (-1),

512 "m" ( *(°ru˘ { 
__exãnsi⁄__
 
__x
[
__n
]; } *)
__s
)

515 
__asm__
 
__vﬁ©ûe__


522 : "=D" (
__ªs
), "=&c" (
__d0
)

523 : "a" (
__c
), "0" (
__s
 + 
__n
 - 1), "1" (__n),

524 "m" ( *(°ru˘ { 
__exãnsi⁄__
 
__x
[
__n
]; } *)
__s
)

527  
__ªs
;

528 
	}
}

529 #ifde‡
__USE_GNU


530 
	#memrchr
(
s
, 
c
, 
n
Ë
	`__memrchr
 ((s), (c), (n))

	)

535 
	#_HAVE_STRING_ARCH_øwmemchr
 1

	)

536 
__STRING_INLINE
 *
__øwmemchr
 (c⁄° *
__s
, 
__c
);

538 #i‚de‡
_FORCE_INLINES


539 
__STRING_INLINE
 *

540 
	$__øwmemchr
 (c⁄° *
__s
, 
__c
)

542 
__d0
;

543 *
__ªs
;

544 
__asm__
 
__vﬁ©ûe__


547 : "=D" (
__ªs
), "=&c" (
__d0
)

548 : "a" (
__c
), "0" (
__s
), "1" (0xffffffff),

549 "m" ( *(°ru˘ { 
__x
[0xfffffff]; } *)
__s
)

551  
__ªs
 - 1;

552 
	}
}

553 #ifde‡
__USE_GNU


554 
__STRING_INLINE
 *

555 
	$øwmemchr
 (c⁄° *
__s
, 
__c
)

557  
	`__øwmemchr
 (
__s
, 
__c
);

558 
	}
}

564 
	#_HAVE_STRING_ARCH_°æí
 1

	)

565 
	#°æí
(
°r
) \

566 (
	`__exãnsi⁄__
 (
	`__buûtö_c⁄°™t_p
 (
°r
) \

567 ? 
	`__buûtö_°æí
 (
°r
) \

568 : 
	`__°æí_g
 (
°r
)))

	)

569 
__STRING_INLINE
 
size_t
 
__°æí_g
 (c⁄° *
__°r
);

571 
__STRING_INLINE
 
size_t


572 
	$__°æí_g
 (c⁄° *
__°r
)

574 
__dummy
;

575 c⁄° *
__tmp
 = 
__°r
;

576 
__asm__
 
__vﬁ©ûe__


582 : "Ù" (
__tmp
), "=&q" (
__dummy
)

583 : "0" (
__°r
),

584 "m" ( *(°ru˘ { 
__x
[0xfffffff]; } *)
__°r
)

586  
__tmp
 - 
__°r
 - 1;

587 
	}
}

591 
	#_HAVE_STRING_ARCH_°r˝y
 1

	)

592 
	#°r˝y
(
de°
, 
§c
) \

593 (
	`__exãnsi⁄__
 (
	`__buûtö_c⁄°™t_p
 (
§c
) \

594 ? ( ((
§c
)[0]Ë=1 && 
	`°æí
 (src) + 1 <= 8 \

595 ? 
	`__°r˝y_a_smÆl
 ((
de°
), (
§c
), 
	`°æí
 (src) + 1) \

596 : (*Ë
	`mem˝y
 ((*Ë(
de°
), \

597 (c⁄° *Ë(
§c
), \

598 
	`°æí
 (
§c
) + 1)) \

599 : 
	`__°r˝y_g
 ((
de°
), (
§c
))))

	)

601 
	#__°r˝y_a_smÆl
(
de°
, 
§c
, 
§˛í
) \

602 (
	`__exãnsi⁄__
 ({ *
__de°
 = (
de°
); \

604 
__ui
; \

605 
__usi
; \

606 
__uc
; \

607 
__c
; \

608 } *
__u
 = (*Ë
__de°
; \

609 
§˛í
) \

612 
__u
->
__uc
 = '\0'; \

615 
__u
->
__usi
 = 
	`__STRING_SMALL_GET16
 (
§c
, 0); \

618 
__u
->
__usi
 = 
	`__STRING_SMALL_GET16
 (
§c
, 0); \

619 
__u
 = 
	`__exãnsi⁄__
 ((*) __u + 2); \

620 
__u
->
__uc
 = '\0'; \

623 
__u
->
__ui
 = 
	`__STRING_SMALL_GET32
 (
§c
, 0); \

626 
__u
->
__ui
 = 
	`__STRING_SMALL_GET32
 (
§c
, 0); \

627 
__u
 = 
	`__exãnsi⁄__
 ((*) __u + 4); \

628 
__u
->
__uc
 = '\0'; \

631 
__u
->
__ui
 = 
	`__STRING_SMALL_GET32
 (
§c
, 0); \

632 
__u
 = 
	`__exãnsi⁄__
 ((*) __u + 4); \

633 
__u
->
__usi
 = 
	`__STRING_SMALL_GET16
 (
§c
, 4); \

636 
__u
->
__ui
 = 
	`__STRING_SMALL_GET32
 (
§c
, 0); \

637 
__u
 = 
	`__exãnsi⁄__
 ((*) __u + 4); \

638 
__u
->
__usi
 = 
	`__STRING_SMALL_GET16
 (
§c
, 4); \

639 
__u
 = 
	`__exãnsi⁄__
 ((*) __u + 2); \

640 
__u
->
__uc
 = '\0'; \

643 
__u
->
__ui
 = 
	`__STRING_SMALL_GET32
 (
§c
, 0); \

644 
__u
 = 
	`__exãnsi⁄__
 ((*) __u + 4); \

645 
__u
->
__ui
 = 
	`__STRING_SMALL_GET32
 (
§c
, 4); \

648 (*Ë
__de°
; }))

	)

650 
__STRING_INLINE
 *
__°r˝y_g
 (*
__de°
, c⁄° *
__§c
);

652 
__STRING_INLINE
 *

653 
	$__°r˝y_g
 (*
__de°
, c⁄° *
__§c
)

655 *
__tmp
 = 
__de°
;

656 
__dummy
;

657 
__asm__
 
__vﬁ©ûe__


666 : "=&r" (
__§c
), "=&r" (
__tmp
), "=&q" (
__dummy
),

667 "=m" ( *(°ru˘ { 
__x
[0xfffffff]; } *)
__de°
)

668 : "0" (
__§c
), "1" (
__tmp
),

669 "m" ( *(°ru˘ { 
__x
[0xfffffff]; } *)
__§c
)

671  
__de°
;

672 
	}
}

675 #ifde‡
__USE_GNU


676 
	#_HAVE_STRING_ARCH_°p˝y
 1

	)

678 
	#__°p˝y
(
de°
, 
§c
) \

679 (
	`__exãnsi⁄__
 (
	`__buûtö_c⁄°™t_p
 (
§c
) \

680 ? (
	`°æí
 (
§c
) + 1 <= 8 \

681 ? 
	`__°p˝y_a_smÆl
 ((
de°
), (
§c
), 
	`°æí
 (src) + 1) \

682 : 
	`__°p˝y_c
 ((
de°
), (
§c
), 
	`°æí
 (src) + 1)) \

683 : 
	`__°p˝y_g
 ((
de°
), (
§c
))))

	)

684 
	#__°p˝y_c
(
de°
, 
§c
, 
§˛í
) \

685 ((
§˛í
) % 4 == 0 \

686 ? 
	`__memp˝y_by4
 (
de°
, 
§c
, 
§˛í
) - 1 \

687 : ((
§˛í
) % 2 == 0 \

688 ? 
	`__memp˝y_by2
 (
de°
, 
§c
, 
§˛í
) - 1 \

689 : 
	`__memp˝y_byn
 (
de°
, 
§c
, 
§˛í
Ë- 1))

	)

692 
	#°p˝y
(
de°
, 
§c
Ë
	`__°p˝y
 ((de°), (§c))

	)

694 
	#__°p˝y_a_smÆl
(
de°
, 
§c
, 
§˛í
) \

695 (
	`__exãnsi⁄__
 ({ union { \

696 
__ui
; \

697 
__usi
; \

698 
__uc
; \

699 
__c
; \

700 } *
__u
 = (*Ë(
de°
); \

701 
§˛í
) \

704 
__u
->
__uc
 = '\0'; \

707 
__u
->
__usi
 = 
	`__STRING_SMALL_GET16
 (
§c
, 0); \

708 
__u
 = 
	`__exãnsi⁄__
 ((*) __u + 1); \

711 
__u
->
__usi
 = 
	`__STRING_SMALL_GET16
 (
§c
, 0); \

712 
__u
 = 
	`__exãnsi⁄__
 ((*) __u + 2); \

713 
__u
->
__uc
 = '\0'; \

716 
__u
->
__ui
 = 
	`__STRING_SMALL_GET32
 (
§c
, 0); \

717 
__u
 = 
	`__exãnsi⁄__
 ((*) __u + 3); \

720 
__u
->
__ui
 = 
	`__STRING_SMALL_GET32
 (
§c
, 0); \

721 
__u
 = 
	`__exãnsi⁄__
 ((*) __u + 4); \

722 
__u
->
__uc
 = '\0'; \

725 
__u
->
__ui
 = 
	`__STRING_SMALL_GET32
 (
§c
, 0); \

726 
__u
 = 
	`__exãnsi⁄__
 ((*) __u + 4); \

727 
__u
->
__usi
 = 
	`__STRING_SMALL_GET16
 (
§c
, 4); \

728 
__u
 = 
	`__exãnsi⁄__
 ((*) __u + 1); \

731 
__u
->
__ui
 = 
	`__STRING_SMALL_GET32
 (
§c
, 0); \

732 
__u
 = 
	`__exãnsi⁄__
 ((*) __u + 4); \

733 
__u
->
__usi
 = 
	`__STRING_SMALL_GET16
 (
§c
, 4); \

734 
__u
 = 
	`__exãnsi⁄__
 ((*) __u + 2); \

735 
__u
->
__uc
 = '\0'; \

738 
__u
->
__ui
 = 
	`__STRING_SMALL_GET32
 (
§c
, 0); \

739 
__u
 = 
	`__exãnsi⁄__
 ((*) __u + 4); \

740 
__u
->
__ui
 = 
	`__STRING_SMALL_GET32
 (
§c
, 4); \

741 
__u
 = 
	`__exãnsi⁄__
 ((*) __u + 3); \

744 (*Ë
__u
; }))

	)

746 
__STRING_INLINE
 *
__memp˝y_by4
 (*
__de°
, c⁄° *
__§c
,

747 
size_t
 
__§˛í
);

749 
__STRING_INLINE
 *

750 
	$__memp˝y_by4
 (*
__de°
, c⁄° *
__§c
, 
size_t
 
__§˛í
)

752 *
__tmp
 = 
__de°
;

753 
__d0
, 
__d1
;

754 
__asm__
 
__vﬁ©ûe__


762 : "=&r" (
__d0
), "Ù" (
__tmp
), "=&r" (
__§c
), "=&r" (
__d1
)

763 : "1" (
__tmp
), "2" (
__§c
), "3" (
__§˛í
 / 4)

765  
__tmp
;

766 
	}
}

768 
__STRING_INLINE
 *
__memp˝y_by2
 (*
__de°
, c⁄° *
__§c
,

769 
size_t
 
__§˛í
);

771 
__STRING_INLINE
 *

772 
	$__memp˝y_by2
 (*
__de°
, c⁄° *
__§c
, 
size_t
 
__§˛í
)

774 *
__tmp
 = 
__de°
;

775 
__d0
, 
__d1
;

776 
__asm__
 
__vﬁ©ûe__


789 : "=&q" (
__d0
), "Ù" (
__tmp
), "=&r" (
__§c
), "=&r" (
__d1
),

790 "=m" ( *(°ru˘ { 
__exãnsi⁄__
 
__x
[
__§˛í
]; } *)
__de°
)

791 : "1" (
__tmp
), "2" (
__§c
), "3" (
__§˛í
 / 2),

792 "m" ( *(°ru˘ { 
__exãnsi⁄__
 
__x
[
__§˛í
]; } *)
__§c
)

794  
__tmp
 + 2;

795 
	}
}

797 
__STRING_INLINE
 *
__memp˝y_byn
 (*
__de°
, c⁄° *
__§c
,

798 
size_t
 
__§˛í
);

800 
__STRING_INLINE
 *

801 
	$__memp˝y_byn
 (*
__de°
, c⁄° *
__§c
, 
size_t
 
__§˛í
)

803 
__d0
, 
__d1
;

804 *
__tmp
 = 
__de°
;

805 
__asm__
 
__vﬁ©ûe__


816 : "=D" (
__tmp
), "=&c" (
__d0
), "=&S" (
__d1
),

817 "=m" ( *(°ru˘ { 
__exãnsi⁄__
 
__x
[
__§˛í
]; } *)
__de°
)

818 : "0" (
__tmp
), "1" (
__§˛í
), "2" (
__§c
),

819 "m" ( *(°ru˘ { 
__exãnsi⁄__
 
__x
[
__§˛í
]; } *)
__§c
)

821  
__tmp
;

822 
	}
}

824 
__STRING_INLINE
 *
__°p˝y_g
 (*
__de°
, c⁄° *
__§c
);

826 
__STRING_INLINE
 *

827 
	$__°p˝y_g
 (*
__de°
, c⁄° *
__§c
)

829 *
__tmp
 = 
__de°
;

830 
__dummy
;

831 
__asm__
 
__vﬁ©ûe__


840 : "=&r" (
__§c
), "Ù" (
__tmp
), "=&q" (
__dummy
),

841 "=m" ( *(°ru˘ { 
__x
[0xfffffff]; } *)
__de°
)

842 : "0" (
__§c
), "1" (
__tmp
),

843 "m" ( *(°ru˘ { 
__x
[0xfffffff]; } *)
__§c
)

845  
__tmp
 - 1;

846 
	}
}

851 
	#_HAVE_STRING_ARCH_°∫˝y
 1

	)

852 
	#°∫˝y
(
de°
, 
§c
, 
n
) \

853 (
	`__exãnsi⁄__
 (
	`__buûtö_c⁄°™t_p
 (
§c
) \

854 ? ((
	`°æí
 (
§c
Ë+ 1 >((
size_t
Ë(
n
)) \

855 ? (*Ë
	`mem˝y
 ((*Ë(
de°
), \

856 (c⁄° *Ë(
§c
), 
n
) \

857 : 
	`__°∫˝y_cg
 ((
de°
), (
§c
), 
	`°æí
 (§cË+ 1, 
n
))) \

858 : 
	`__°∫˝y_gg
 ((
de°
), (
§c
), 
n
)))

	)

859 
	#__°∫˝y_cg
(
de°
, 
§c
, 
§˛í
, 
n
) \

860 (((
§˛í
) % 4 == 0) \

861 ? 
	`__°∫˝y_by4
 (
de°
, 
§c
, 
§˛í
, 
n
) \

862 : (((
§˛í
) % 2 == 0) \

863 ? 
	`__°∫˝y_by2
 (
de°
, 
§c
, 
§˛í
, 
n
) \

864 : 
	`__°∫˝y_byn
 (
de°
, 
§c
, 
§˛í
, 
n
)))

	)

866 
__STRING_INLINE
 *
__°∫˝y_by4
 (*
__de°
, c⁄° 
__§c
[],

867 
size_t
 
__§˛í
, size_à
__n
);

869 
__STRING_INLINE
 *

870 
	$__°∫˝y_by4
 (*
__de°
, c⁄° 
__§c
[], 
size_t
 
__§˛í
, size_à
__n
)

872 *
__tmp
 = 
__de°
;

873 
__dummy1
, 
__dummy2
;

874 
__asm__
 
__vﬁ©ûe__


882 : "=&r" (
__dummy1
), "Ù" (
__tmp
), "=&r" (
__§c
), "=&r" (
__dummy2
),

883 "=m" ( *(°ru˘ { 
__exãnsi⁄__
 
__x
[
__§˛í
]; } *)
__de°
)

884 : "1" (
__tmp
), "2" (
__§c
), "3" (
__§˛í
 / 4),

885 "m" ( *(°ru˘ { 
__exãnsi⁄__
 
__x
[
__§˛í
]; } *)
__§c
)

887 (Ë
	`mem£t
 (
__tmp
, '\0', 
__n
 - 
__§˛í
);

888  
__de°
;

889 
	}
}

891 
__STRING_INLINE
 *
__°∫˝y_by2
 (*
__de°
, c⁄° 
__§c
[],

892 
size_t
 
__§˛í
, size_à
__n
);

894 
__STRING_INLINE
 *

895 
	$__°∫˝y_by2
 (*
__de°
, c⁄° 
__§c
[], 
size_t
 
__§˛í
, size_à
__n
)

897 *
__tmp
 = 
__de°
;

898 
__dummy1
, 
__dummy2
;

899 
__asm__
 
__vﬁ©ûe__


912 : "=&q" (
__dummy1
), "Ù" (
__tmp
), "=&r" (
__§c
), "=&r" (
__dummy2
),

913 "=m" ( *(°ru˘ { 
__exãnsi⁄__
 
__x
[
__§˛í
]; } *)
__de°
)

914 : "1" (
__tmp
), "2" (
__§c
), "3" (
__§˛í
 / 2),

915 "m" ( *(°ru˘ { 
__exãnsi⁄__
 
__x
[
__§˛í
]; } *)
__§c
)

917 (Ë
	`mem£t
 (
__tmp
 + 2, '\0', 
__n
 - 
__§˛í
);

918  
__de°
;

919 
	}
}

921 
__STRING_INLINE
 *
__°∫˝y_byn
 (*
__de°
, c⁄° 
__§c
[],

922 
size_t
 
__§˛í
, size_à
__n
);

924 
__STRING_INLINE
 *

925 
	$__°∫˝y_byn
 (*
__de°
, c⁄° 
__§c
[], 
size_t
 
__§˛í
, size_à
__n
)

927 
__d0
, 
__d1
;

928 *
__tmp
 = 
__de°
;

929 
__asm__
 
__vﬁ©ûe__


940 : "=D" (
__tmp
), "=&c" (
__d0
), "=&S" (
__d1
),

941 "=m" ( *(°ru˘ { 
__exãnsi⁄__
 
__x
[
__§˛í
]; } *)
__de°
)

942 : "1" (
__§˛í
), "0" (
__tmp
),"2" (
__§c
),

943 "m" ( *(°ru˘ { 
__exãnsi⁄__
 
__x
[
__§˛í
]; } *)
__§c
)

945 (Ë
	`mem£t
 (
__tmp
, '\0', 
__n
 - 
__§˛í
);

946  
__de°
;

947 
	}
}

949 
__STRING_INLINE
 *
__°∫˝y_gg
 (*
__de°
, c⁄° *
__§c
,

950 
size_t
 
__n
);

952 
__STRING_INLINE
 *

953 
	$__°∫˝y_gg
 (*
__de°
, c⁄° *
__§c
, 
size_t
 
__n
)

955 *
__tmp
 = 
__de°
;

956 
__dummy
;

957 i‡(
__n
 > 0)

958 
__asm__
 
__vﬁ©ûe__


974 : "=&r" (
__§c
), "=&r" (
__tmp
), "=&q" (
__dummy
), "=&r" (
__n
)

975 : "0" (
__§c
), "1" (
__tmp
), "3" (
__n
)

978  
__de°
;

979 
	}
}

983 
	#_HAVE_STRING_ARCH_°rˇt
 1

	)

984 
	#°rˇt
(
de°
, 
§c
) \

985 (
	`__exãnsi⁄__
 (
	`__buûtö_c⁄°™t_p
 (
§c
) \

986 ? 
	`__°rˇt_c
 ((
de°
), (
§c
), 
	`°æí
 (src) + 1) \

987 : 
	`__°rˇt_g
 ((
de°
), (
§c
))))

	)

989 
__STRING_INLINE
 *
__°rˇt_c
 (*
__de°
, c⁄° 
__§c
[],

990 
size_t
 
__§˛í
);

992 
__STRING_INLINE
 *

993 
	$__°rˇt_c
 (*
__de°
, c⁄° 
__§c
[], 
size_t
 
__§˛í
)

995 #ifde‡
__i686__


996 
__d0
;

997 *
__tmp
;

998 
__asm__
 
__vﬁ©ûe__


1000 : "=D" (
__tmp
), "=&c" (
__d0
),

1001 "=m" ( *(°ru˘ { 
__x
[0xfffffff]; } *)
__de°
)

1002 : "0" (
__de°
), "1" (0xffffffff), "a" (0),

1003 "m" ( *(°ru˘ { 
__exãnsi⁄__
 
__x
[
__§˛í
]; } *)
__§c
)

1005 --
__tmp
;

1007 *
__tmp
 = 
__de°
;

1008 
__asm__
 
__vﬁ©ûe__


1014 : "Ù" (
__tmp
),

1015 "=m" ( *(°ru˘ { 
__x
[0xfffffff]; } *)
__de°
)

1016 : "0" (
__tmp
),

1017 "m" ( *(°ru˘ { 
__exãnsi⁄__
 
__x
[
__§˛í
]; } *)
__§c
)

1020 (Ë
	`mem˝y
 (
__tmp
, 
__§c
, 
__§˛í
);

1021  
__de°
;

1022 
	}
}

1024 
__STRING_INLINE
 *
__°rˇt_g
 (*
__de°
, c⁄° *
__§c
);

1026 
__STRING_INLINE
 *

1027 
	$__°rˇt_g
 (*
__de°
, c⁄° *
__§c
)

1029 *
__tmp
 = 
__de°
;

1030 
__dummy
;

1031 
__asm__
 
__vﬁ©ûe__


1044 : "=&q" (
__dummy
), "=&r" (
__tmp
), "=&r" (
__§c
),

1045 "=m" ( *(°ru˘ { 
__x
[0xfffffff]; } *)
__de°
)

1046 : "1" (
__tmp
), "2" (
__§c
),

1047 "m" ( *(°ru˘ { 
__x
[0xfffffff]; } *)
__§c
)

1049  
__de°
;

1050 
	}
}

1054 
	#_HAVE_STRING_ARCH_°∫ˇt
 1

	)

1055 
	#°∫ˇt
(
de°
, 
§c
, 
n
) \

1056 (
	`__exãnsi⁄__
 ({ *
__de°
 = (
de°
); \

1057 
	`__buûtö_c⁄°™t_p
 (
§c
Ë&& __buûtö_c⁄°™t_∞(
n
) \

1058 ? (
	`°æí
 (
§c
Ë< ((
size_t
Ë(
n
)) \

1059 ? 
	`°rˇt
 (
__de°
, (
§c
)) \

1060 : (*(*)
	`__memp˝y
 (
	`°rchr
 (
__de°
, '\0'), \

1061 (c⁄° *Ë(
§c
), \

1062 (
n
)Ë0, 
__de°
)) \

1063 : 
	`__°∫ˇt_g
 (
__de°
, (
§c
), (
n
)); }))

	)

1065 
__STRING_INLINE
 *
__°∫ˇt_g
 (*
__de°
, c⁄° 
__§c
[],

1066 
size_t
 
__n
);

1068 
__STRING_INLINE
 *

1069 
	$__°∫ˇt_g
 (*
__de°
, c⁄° 
__§c
[], 
size_t
 
__n
)

1071 *
__tmp
 = 
__de°
;

1072 
__dummy
;

1073 #ifde‡
__i686__


1074 
__asm__
 
__vﬁ©ûe__


1088 : "=&a" (
__dummy
), "=&D" (
__tmp
), "=&S" (
__§c
), "=&c" (
__n
)

1089 : "g" (
__n
), "0" (0), "1" (
__tmp
), "2" (
__§c
), "3" (0xffffffff)

1092 
__asm__
 
__vﬁ©ûe__


1109 : "=&q" (
__dummy
), "=&r" (
__tmp
), "=&r" (
__§c
), "=&r" (
__n
)

1110 : "1" ((Ë
__tmp
 - 1), "2" (
__§c
), "3" (
__n
)

1113  
__de°
;

1114 
	}
}

1118 
	#_HAVE_STRING_ARCH_°rcmp
 1

	)

1119 
	#°rcmp
(
s1
, 
s2
) \

1120 (
	`__exãnsi⁄__
 (
	`__buûtö_c⁄°™t_p
 (
s1
Ë&& __buûtö_c⁄°™t_∞(
s2
) \

1121 && ( ((
s1
)[0]Ë!1 || 
	`°æí
 (s1) >= 4) \

1122 && ( ((
s2
)[0]Ë!1 || 
	`°æí
 (s2) >= 4) \

1123 ? 
	`memcmp
 ((c⁄° *Ë(
s1
), (c⁄° *Ë(
s2
), \

1124 (
	`°æí
 (
s1
Ë< såÀ¿(
s2
) \

1125 ? 
	`°æí
 (
s1
Ë: såÀ¿(
s2
)) + 1) \

1126 : (
	`__buûtö_c⁄°™t_p
 (
s1
) &&  ((s1)[0]) == 1 \

1127 &&  ((
s2
)[0]Ë=1 && 
	`°æí
 (
s1
) < 4 \

1128 ? (
	`__buûtö_c⁄°™t_p
 (
s2
) &&  ((s2)[0]) == 1 \

1129 ? 
	`__°rcmp_cc
 ((c⁄° *Ë(
s1
), \

1130 (c⁄° *Ë(
s2
), \

1131 
	`°æí
 (
s1
)) \

1132 : 
	`__°rcmp_cg
 ((c⁄° *Ë(
s1
), \

1133 (c⁄° *Ë(
s2
), \

1134 
	`°æí
 (
s1
))) \

1135 : (
	`__buûtö_c⁄°™t_p
 (
s2
Ë&&  ((
s1
)[0]) == 1 \

1136 &&  ((
s2
)[0]Ë=1 && 
	`°æí
 (s2) < 4 \

1137 ? (
	`__buûtö_c⁄°™t_p
 (
s1
) \

1138 ? 
	`__°rcmp_cc
 ((c⁄° *Ë(
s1
), \

1139 (c⁄° *Ë(
s2
), \

1140 
	`°æí
 (
s2
)) \

1141 : 
	`__°rcmp_gc
 ((c⁄° *Ë(
s1
), \

1142 (c⁄° *Ë(
s2
), \

1143 
	`°æí
 (
s2
))) \

1144 : 
	`__°rcmp_gg
 ((
s1
), (
s2
))))))

	)

1146 
	#__°rcmp_cc
(
s1
, 
s2
, 
l
) \

1147 (
	`__exãnsi⁄__
 ({ 
__ªsu…
 = (
s1
)[0] - (
s2
)[0]; \

1148 i‡(
l
 > 0 && 
__ªsu…
 == 0) \

1150 
__ªsu…
 = (
s1
)[1] - (
s2
)[1]; \

1151 i‡(
l
 > 1 && 
__ªsu…
 == 0) \

1153 
__ªsu…
 = (
s1
)[2] - (
s2
)[2]; \

1154 i‡(
l
 > 2 && 
__ªsu…
 == 0) \

1155 
__ªsu…
 = (
s1
)[3] - (
s2
)[3]; \

1158 
__ªsu…
; }))

	)

1160 
	#__°rcmp_cg
(
s1
, 
s2
, 
l1
) \

1161 (
	`__exãnsi⁄__
 ({ c⁄° *
__s2
 = (
s2
); \

1162 
__ªsu…
 = (
s1
)[0] - 
__s2
[0]; \

1163 i‡(
l1
 > 0 && 
__ªsu…
 == 0) \

1165 
__ªsu…
 = (
s1
)[1] - 
__s2
[1]; \

1166 i‡(
l1
 > 1 && 
__ªsu…
 == 0) \

1168 
__ªsu…
 = (
s1
)[2] - 
__s2
[2]; \

1169 i‡(
l1
 > 2 && 
__ªsu…
 == 0) \

1170 
__ªsu…
 = (
s1
)[3] - 
__s2
[3]; \

1173 
__ªsu…
; }))

	)

1175 
	#__°rcmp_gc
(
s1
, 
s2
, 
l2
) \

1176 (
	`__exãnsi⁄__
 ({ c⁄° *
__s1
 = (
s1
); \

1177 
__ªsu…
 = 
__s1
[0] - (
s2
)[0]; \

1178 i‡(
l2
 > 0 && 
__ªsu…
 == 0) \

1180 
__ªsu…
 = 
__s1
[1] - (
s2
)[1]; \

1181 i‡(
l2
 > 1 && 
__ªsu…
 == 0) \

1183 
__ªsu…
 = 
__s1
[2] - (
s2
)[2]; \

1184 i‡(
l2
 > 2 && 
__ªsu…
 == 0) \

1185 
__ªsu…
 = 
__s1
[3] - (
s2
)[3]; \

1188 
__ªsu…
; }))

	)

1190 
__STRING_INLINE
 
__°rcmp_gg
 (c⁄° *
__s1
, c⁄° *
__s2
);

1192 
__STRING_INLINE
 

1193 
	$__°rcmp_gg
 (c⁄° *
__s1
, c⁄° *
__s2
)

1195 
__ªs
;

1196 
__asm__
 
__vﬁ©ûe__


1212 : "=q" (
__ªs
), "=&r" (
__s1
), "=&r" (
__s2
)

1213 : "1" (
__s1
), "2" (
__s2
),

1214 "m" ( *(°ru˘ { 
__x
[0xfffffff]; } *)
__s1
),

1215 "m" ( *(°ru˘ { 
__x
[0xfffffff]; } *)
__s2
)

1217  
__ªs
;

1218 
	}
}

1222 
	#_HAVE_STRING_ARCH_°∫cmp
 1

	)

1223 
	#°∫cmp
(
s1
, 
s2
, 
n
) \

1224 (
	`__exãnsi⁄__
 (
	`__buûtö_c⁄°™t_p
 (
s1
Ë&& 
	`°æí
 (s1Ë< ((
size_t
Ë(
n
)) \

1225 ? 
	`°rcmp
 ((
s1
), (
s2
)) \

1226 : (
	`__buûtö_c⁄°™t_p
 (
s2
Ë&& 
	`°æí
 (s2Ë< ((
size_t
Ë(
n
))\

1227 ? 
	`°rcmp
 ((
s1
), (
s2
)) \

1228 : 
	`__°∫cmp_g
 ((
s1
), (
s2
), (
n
)))))

	)

1230 
__STRING_INLINE
 
__°∫cmp_g
 (c⁄° *
__s1
, c⁄° *
__s2
,

1231 
size_t
 
__n
);

1233 
__STRING_INLINE
 

1234 
	$__°∫cmp_g
 (c⁄° *
__s1
, c⁄° *
__s2
, 
size_t
 
__n
)

1236 
__ªs
;

1237 
__asm__
 
__vﬁ©ûe__


1256 : "=q" (
__ªs
), "=&r" (
__s1
), "=&r" (
__s2
), "=&r" (
__n
)

1257 : "1" (
__s1
), "2" (
__s2
), "3" (
__n
),

1258 "m" ( *(°ru˘ { 
__exãnsi⁄__
 
__x
[
__n
]; } *)
__s1
),

1259 "m" ( *(°ru˘ { 
__exãnsi⁄__
 
__x
[
__n
]; } *)
__s2
)

1261  
__ªs
;

1262 
	}
}

1266 
	#_HAVE_STRING_ARCH_°rchr
 1

	)

1267 
	#_USE_STRING_ARCH_°rchr
 1

	)

1268 
	#°rchr
(
s
, 
c
) \

1269 (
	`__exãnsi⁄__
 (
	`__buûtö_c⁄°™t_p
 (
c
) \

1270 ? ((
c
) == '\0' \

1271 ? (*Ë
	`__øwmemchr
 ((
s
), (
c
)) \

1272 : 
	`__°rchr_c
 ((
s
), ((
c
) & 0xff) << 8)) \

1273 : 
	`__°rchr_g
 ((
s
), (
c
))))

	)

1275 
__STRING_INLINE
 *
__°rchr_c
 (c⁄° *
__s
, 
__c
);

1277 
__STRING_INLINE
 *

1278 
	$__°rchr_c
 (c⁄° *
__s
, 
__c
)

1280 
__d0
;

1281 *
__ªs
;

1282 
__asm__
 
__vﬁ©ûe__


1292 : "Ù" (
__ªs
), "=&a" (
__d0
)

1293 : "0" (
__s
), "1" (
__c
),

1294 "m" ( *(°ru˘ { 
__x
[0xfffffff]; } *)
__s
)

1296  
__ªs
;

1297 
	}
}

1299 
__STRING_INLINE
 *
__°rchr_g
 (c⁄° *
__s
, 
__c
);

1301 
__STRING_INLINE
 *

1302 
	$__°rchr_g
 (c⁄° *
__s
, 
__c
)

1304 
__d0
;

1305 *
__ªs
;

1306 
__asm__
 
__vﬁ©ûe__


1317 : "Ù" (
__ªs
), "=&a" (
__d0
)

1318 : "0" (
__s
), "1" (
__c
),

1319 "m" ( *(°ru˘ { 
__x
[0xfffffff]; } *)
__s
)

1321  
__ªs
;

1322 
	}
}

1326 
	#_HAVE_STRING_ARCH_°rch∫ul
 1

	)

1327 
	#__°rch∫ul
(
s
, 
c
) \

1328 (
	`__exãnsi⁄__
 (
	`__buûtö_c⁄°™t_p
 (
c
) \

1329 ? ((
c
) == '\0' \

1330 ? (*Ë
	`__øwmemchr
 ((
s
), 
c
) \

1331 : 
	`__°rch∫ul_c
 ((
s
), ((
c
) & 0xff) << 8)) \

1332 : 
	`__°rch∫ul_g
 ((
s
), 
c
)))

	)

1334 
__STRING_INLINE
 *
__°rch∫ul_c
 (c⁄° *
__s
, 
__c
);

1336 
__STRING_INLINE
 *

1337 
	$__°rch∫ul_c
 (c⁄° *
__s
, 
__c
)

1339 
__d0
;

1340 *
__ªs
;

1341 
__asm__
 
__vﬁ©ûe__


1351 : "Ù" (
__ªs
), "=&a" (
__d0
)

1352 : "0" (
__s
), "1" (
__c
),

1353 "m" ( *(°ru˘ { 
__x
[0xfffffff]; } *)
__s
)

1355  
__ªs
;

1356 
	}
}

1358 
__STRING_INLINE
 *
__°rch∫ul_g
 (c⁄° *
__s
, 
__c
);

1360 
__STRING_INLINE
 *

1361 
	$__°rch∫ul_g
 (c⁄° *
__s
, 
__c
)

1363 
__d0
;

1364 *
__ªs
;

1365 
__asm__
 
__vﬁ©ûe__


1376 : "Ù" (
__ªs
), "=&a" (
__d0
)

1377 : "0" (
__s
), "1" (
__c
),

1378 "m" ( *(°ru˘ { 
__x
[0xfffffff]; } *)
__s
)

1380  
__ªs
;

1381 
	}
}

1382 #ifde‡
__USE_GNU


1383 
	#°rch∫ul
(
s
, 
c
Ë
	`__°rch∫ul
 ((s), (c))

	)

1387 #i‡
deföed
 
__USE_MISC
 || deföed 
__USE_XOPEN_EXTENDED


1389 
	#_HAVE_STRING_ARCH_ödex
 1

	)

1390 
	#ödex
(
s
, 
c
) \

1391 (
	`__exãnsi⁄__
 (
	`__buûtö_c⁄°™t_p
 (
c
) \

1392 ? 
	`__°rchr_c
 ((
s
), ((
c
) & 0xff) << 8) \

1393 : 
	`__°rchr_g
 ((
s
), (
c
))))

	)

1398 
	#_HAVE_STRING_ARCH_°ºchr
 1

	)

1399 
	#°ºchr
(
s
, 
c
) \

1400 (
	`__exãnsi⁄__
 (
	`__buûtö_c⁄°™t_p
 (
c
) \

1401 ? 
	`__°ºchr_c
 ((
s
), ((
c
) & 0xff) << 8) \

1402 : 
	`__°ºchr_g
 ((
s
), (
c
))))

	)

1404 #ifde‡
__i686__


1405 
__STRING_INLINE
 *
__°ºchr_c
 (c⁄° *
__s
, 
__c
);

1407 
__STRING_INLINE
 *

1408 
	$__°ºchr_c
 (c⁄° *
__s
, 
__c
)

1410 
__d0
, 
__d1
;

1411 *
__ªs
;

1412 
__asm__
 
__vﬁ©ûe__


1420 : "=d" (
__ªs
), "=&S" (
__d0
), "=&a" (
__d1
)

1421 : "0" (1), "1" (
__s
), "2" (
__c
),

1422 "m" ( *(°ru˘ { 
__x
[0xfffffff]; } *)
__s
)

1424  
__ªs
 - 1;

1425 
	}
}

1427 
__STRING_INLINE
 *
__°ºchr_g
 (c⁄° *
__s
, 
__c
);

1429 
__STRING_INLINE
 *

1430 
	$__°ºchr_g
 (c⁄° *
__s
, 
__c
)

1432 
__d0
, 
__d1
;

1433 *
__ªs
;

1434 
__asm__
 
__vﬁ©ûe__


1443 : "=d" (
__ªs
), "=&S" (
__d0
), "=&a" (
__d1
)

1444 : "0" (1), "1" (
__s
), "2" (
__c
),

1445 "m" ( *(°ru˘ { 
__x
[0xfffffff]; } *)
__s
)

1447  
__ªs
 - 1;

1448 
	}
}

1450 
__STRING_INLINE
 *
__°ºchr_c
 (c⁄° *
__s
, 
__c
);

1452 
__STRING_INLINE
 *

1453 
	$__°ºchr_c
 (c⁄° *
__s
, 
__c
)

1455 
__d0
, 
__d1
;

1456 *
__ªs
;

1457 
__asm__
 
__vﬁ©ûe__


1467 : "=d" (
__ªs
), "=&S" (
__d0
), "=&a" (
__d1
)

1468 : "0" (0), "1" (
__s
), "2" (
__c
),

1469 "m" ( *(°ru˘ { 
__x
[0xfffffff]; } *)
__s
)

1471  
__ªs
;

1472 
	}
}

1474 
__STRING_INLINE
 *
__°ºchr_g
 (c⁄° *
__s
, 
__c
);

1476 
__STRING_INLINE
 *

1477 
	$__°ºchr_g
 (c⁄° *
__s
, 
__c
)

1479 
__d0
, 
__d1
;

1480 *
__ªs
;

1481 
__asm__
 
__vﬁ©ûe__


1492 : "Ù" (
__ªs
), "=&S" (
__d0
), "=&a" (
__d1
)

1493 : "0" (0), "1" (
__s
), "2" (
__c
),

1494 "m" ( *(°ru˘ { 
__x
[0xfffffff]; } *)
__s
)

1496  
__ªs
;

1497 
	}
}

1501 #i‡
deföed
 
__USE_MISC
 || deföed 
__USE_XOPEN_EXTENDED


1503 
	#_HAVE_STRING_ARCH_rödex
 1

	)

1504 
	#rödex
(
s
, 
c
) \

1505 (
	`__exãnsi⁄__
 (
	`__buûtö_c⁄°™t_p
 (
c
) \

1506 ? 
	`__°ºchr_c
 ((
s
), ((
c
) & 0xff) << 8) \

1507 : 
	`__°ºchr_g
 ((
s
), (
c
))))

	)

1513 
	#_HAVE_STRING_ARCH_°rc•n
 1

	)

1514 
	#°rc•n
(
s
, 
ªje˘
) \

1515 (
	`__exãnsi⁄__
 (
	`__buûtö_c⁄°™t_p
 (
ªje˘
) &&  ((reject)[0]) == 1 \

1516 ? ((
ªje˘
)[0] == '\0' \

1517 ? 
	`°æí
 (
s
) \

1518 : ((
ªje˘
)[1] == '\0' \

1519 ? 
	`__°rc•n_c1
 ((
s
), (((
ªje˘
)[0] << 8) & 0xff00)) \

1520 : 
	`__°rc•n_cg
 ((
s
), (
ªje˘
), 
	`°æí
 (reject)))) \

1521 : 
	`__°rc•n_g
 ((
s
), (
ªje˘
))))

	)

1523 
__STRING_INLINE
 
size_t
 
__°rc•n_c1
 (c⁄° *
__s
, 
__ªje˘
);

1525 #i‚de‡
_FORCE_INLINES


1526 
__STRING_INLINE
 
size_t


1527 
	$__°rc•n_c1
 (c⁄° *
__s
, 
__ªje˘
)

1529 
__d0
;

1530 *
__ªs
;

1531 
__asm__
 
__vﬁ©ûe__


1540 : "Ù" (
__ªs
), "=&a" (
__d0
)

1541 : "0" (
__s
), "1" (
__ªje˘
),

1542 "m" ( *(°ru˘ { 
__x
[0xfffffff]; } *)
__s
)

1544  (
__ªs
 - 1Ë- 
__s
;

1545 
	}
}

1548 
__STRING_INLINE
 
size_t
 
__°rc•n_cg
 (c⁄° *
__s
, c⁄° 
__ªje˘
[],

1549 
size_t
 
__ªje˘_Àn
);

1551 
__STRING_INLINE
 
size_t


1552 
	$__°rc•n_cg
 (c⁄° *
__s
, c⁄° 
__ªje˘
[], 
size_t
 
__ªje˘_Àn
)

1554 
__d0
, 
__d1
, 
__d2
;

1555 c⁄° *
__ªs
;

1556 
__asm__
 
__vﬁ©ûe__


1567 : "=S" (
__ªs
), "=&a" (
__d0
), "=&c" (
__d1
), "=&D" (
__d2
)

1568 : "0" (
__s
), "d" (
__ªje˘
), "g" (
__ªje˘_Àn
)

1570  (
__ªs
 - 1Ë- 
__s
;

1571 
	}
}

1573 
__STRING_INLINE
 
size_t
 
__°rc•n_g
 (c⁄° *
__s
, c⁄° *
__ªje˘
);

1574 #ifde‡
__PIC__


1576 
__STRING_INLINE
 
size_t


1577 
	$__°rc•n_g
 (c⁄° *
__s
, c⁄° *
__ªje˘
)

1579 
__d0
, 
__d1
, 
__d2
;

1580 c⁄° *
__ªs
;

1581 
__asm__
 
__vﬁ©ûe__


1598 : "=S" (
__ªs
), "=&a" (
__d0
), "=&c" (
__d1
), "=&D" (
__d2
)

1599 : "r" (
__ªje˘
), "0" (
__s
), "1" (0), "2" (0xffffffff)

1601  (
__ªs
 - 1Ë- 
__s
;

1602 
	}
}

1604 
__STRING_INLINE
 
size_t


1605 
	$__°rc•n_g
 (c⁄° *
__s
, c⁄° *
__ªje˘
)

1607 
__d0
, 
__d1
, 
__d2
, 
__d3
;

1608 c⁄° *
__ªs
;

1609 
__asm__
 
__vﬁ©ûe__


1623 : "=S" (
__ªs
), "=&a" (
__d0
), "=&c" (
__d1
), "=&D" (
__d2
), "=&d" (
__d3
)

1624 : "0" (
__s
), "1" (0), "2" (0xffffffff), "3" (
__ªje˘
), "b" (__reject)

1627  (
__ªs
 - 1Ë- 
__s
;

1628 
	}
}

1634 
	#_HAVE_STRING_ARCH_°r•n
 1

	)

1635 
	#°r•n
(
s
, 
ac˚±
) \

1636 (
	`__exãnsi⁄__
 (
	`__buûtö_c⁄°™t_p
 (
ac˚±
) &&  ((accept)[0]) == 1 \

1637 ? ((
ac˚±
)[0] == '\0' \

1638 ? ((Ë(
s
), 0) \

1639 : ((
ac˚±
)[1] == '\0' \

1640 ? 
	`__°r•n_c1
 ((
s
), (((
ac˚±
)[0] << 8 ) & 0xff00)) \

1641 : 
	`__°r•n_cg
 ((
s
), (
ac˚±
), 
	`°æí
 (accept)))) \

1642 : 
	`__°r•n_g
 ((
s
), (
ac˚±
))))

	)

1644 #i‚de‡
_FORCE_INLINES


1645 
__STRING_INLINE
 
size_t
 
__°r•n_c1
 (c⁄° *
__s
, 
__ac˚±
);

1647 
__STRING_INLINE
 
size_t


1648 
	$__°r•n_c1
 (c⁄° *
__s
, 
__ac˚±
)

1650 
__d0
;

1651 *
__ªs
;

1653 
__asm__
 
__vﬁ©ûe__


1659 : "Ù" (
__ªs
), "=&q" (
__d0
)

1660 : "0" (
__s
), "1" (
__ac˚±
),

1661 "m" ( *(°ru˘ { 
__x
[0xfffffff]; } *)
__s
)

1663  (
__ªs
 - 1Ë- 
__s
;

1664 
	}
}

1667 
__STRING_INLINE
 
size_t
 
__°r•n_cg
 (c⁄° *
__s
, c⁄° 
__ac˚±
[],

1668 
size_t
 
__ac˚±_Àn
);

1670 
__STRING_INLINE
 
size_t


1671 
	$__°r•n_cg
 (c⁄° *
__s
, c⁄° 
__ac˚±
[], 
size_t
 
__ac˚±_Àn
)

1673 
__d0
, 
__d1
, 
__d2
;

1674 c⁄° *
__ªs
;

1675 
__asm__
 
__vﬁ©ûe__


1686 : "=S" (
__ªs
), "=&a" (
__d0
), "=&c" (
__d1
), "=&D" (
__d2
)

1687 : "0" (
__s
), "g" (
__ac˚±
), "g" (
__ac˚±_Àn
),

1690 "m" ( *(°ru˘ { 
__x
[0xfffffff]; } *)
__s
),

1691 "m" ( *(°ru˘ { 
__exãnsi⁄__
 
__x
[
__ac˚±_Àn
]; } *)
__ac˚±
)

1693  (
__ªs
 - 1Ë- 
__s
;

1694 
	}
}

1696 
__STRING_INLINE
 
size_t
 
__°r•n_g
 (c⁄° *
__s
, c⁄° *
__ac˚±
);

1697 #ifde‡
__PIC__


1699 
__STRING_INLINE
 
size_t


1700 
	$__°r•n_g
 (c⁄° *
__s
, c⁄° *
__ac˚±
)

1702 
__d0
, 
__d1
, 
__d2
;

1703 c⁄° *
__ªs
;

1704 
__asm__
 
__vﬁ©ûe__


1720 : "=S" (
__ªs
), "=&a" (
__d0
), "=&c" (
__d1
), "=&D" (
__d2
)

1721 : "d" (
__ac˚±
), "0" (
__s
), "1" (0), "2" (0xffffffff), "3" (__accept)

1723  (
__ªs
 - 1Ë- 
__s
;

1724 
	}
}

1726 
__STRING_INLINE
 
size_t


1727 
	$__°r•n_g
 (c⁄° *
__s
, c⁄° *
__ac˚±
)

1729 
__d0
, 
__d1
, 
__d2
, 
__d3
;

1730 c⁄° *
__ªs
;

1731 
__asm__
 
__vﬁ©ûe__


1745 : "=S" (
__ªs
), "=&a" (
__d0
), "=&c" (
__d1
), "=&D" (
__d2
), "=&d" (
__d3
)

1746 : "0" (
__s
), "1" (0), "2" (0xffffffff), "3" (
__ac˚±
), "b" (__accept)

1748  (
__ªs
 - 1Ë- 
__s
;

1749 
	}
}

1754 
	#_HAVE_STRING_ARCH_°Ωbrk
 1

	)

1755 
	#°Ωbrk
(
s
, 
ac˚±
) \

1756 (
	`__exãnsi⁄__
 (
	`__buûtö_c⁄°™t_p
 (
ac˚±
) &&  ((accept)[0]) == 1 \

1757 ? ((
ac˚±
)[0] == '\0' \

1758 ? ((Ë(
s
), (*) 0) \

1759 : ((
ac˚±
)[1] == '\0' \

1760 ? 
	`°rchr
 ((
s
), (
ac˚±
)[0]) \

1761 : 
	`__°Ωbrk_cg
 ((
s
), (
ac˚±
), 
	`°æí
 (accept)))) \

1762 : 
	`__°Ωbrk_g
 ((
s
), (
ac˚±
))))

	)

1764 
__STRING_INLINE
 *
__°Ωbrk_cg
 (c⁄° *
__s
, c⁄° 
__ac˚±
[],

1765 
size_t
 
__ac˚±_Àn
);

1767 
__STRING_INLINE
 *

1768 
	$__°Ωbrk_cg
 (c⁄° *
__s
, c⁄° 
__ac˚±
[], 
size_t
 
__ac˚±_Àn
)

1770 
__d0
, 
__d1
, 
__d2
;

1771 *
__ªs
;

1772 
__asm__
 
__vﬁ©ûe__


1787 : "=S" (
__ªs
), "=&a" (
__d0
), "=&c" (
__d1
), "=&D" (
__d2
)

1788 : "0" (
__s
), "d" (
__ac˚±
), "g" (
__ac˚±_Àn
)

1790  
__ªs
;

1791 
	}
}

1793 
__STRING_INLINE
 *
__°Ωbrk_g
 (c⁄° *
__s
, c⁄° *
__ac˚±
);

1794 #ifde‡
__PIC__


1796 
__STRING_INLINE
 *

1797 
	$__°Ωbrk_g
 (c⁄° *
__s
, c⁄° *
__ac˚±
)

1799 
__d0
, 
__d1
, 
__d2
;

1800 *
__ªs
;

1801 
__asm__
 
__vﬁ©ûe__


1822 : "=S" (
__ªs
), "=&a" (
__d0
), "=&c" (
__d1
), "=&D" (
__d2
)

1823 : "d" (
__ac˚±
), "0" (
__s
), "1" (0), "2" (0xffffffff)

1825  
__ªs
;

1826 
	}
}

1828 
__STRING_INLINE
 *

1829 
	$__°Ωbrk_g
 (c⁄° *
__s
, c⁄° *
__ac˚±
)

1831 
__d0
, 
__d1
, 
__d2
, 
__d3
;

1832 *
__ªs
;

1833 
__asm__
 
__vﬁ©ûe__


1852 : "=S" (
__ªs
), "=&a" (
__d0
), "=&c" (
__d1
), "=&d" (
__d2
), "=&D" (
__d3
)

1853 : "0" (
__s
), "1" (0), "2" (0xffffffff), "b" (
__ac˚±
)

1855  
__ªs
;

1856 
	}
}

1861 
	#_HAVE_STRING_ARCH_°r°r
 1

	)

1862 
	#°r°r
(
hay°ack
, 
√edÀ
) \

1863 (
	`__exãnsi⁄__
 (
	`__buûtö_c⁄°™t_p
 (
√edÀ
) &&  ((needle)[0]) == 1 \

1864 ? ((
√edÀ
)[0] == '\0' \

1865 ? (
hay°ack
) \

1866 : ((
√edÀ
)[1] == '\0' \

1867 ? 
	`°rchr
 ((
hay°ack
), (
√edÀ
)[0]) \

1868 : 
	`__°r°r_cg
 ((
hay°ack
), (
√edÀ
), \

1869 
	`°æí
 (
√edÀ
)))) \

1870 : 
	`__°r°r_g
 ((
hay°ack
), (
√edÀ
))))

	)

1874 
__STRING_INLINE
 *
__°r°r_cg
 (c⁄° *
__hay°ack
,

1875 c⁄° 
__√edÀ
[],

1876 
size_t
 
__√edÀ_Àn
);

1878 
__STRING_INLINE
 *

1879 
	$__°r°r_cg
 (c⁄° *
__hay°ack
, c⁄° 
__√edÀ
[],

1880 
size_t
 
__√edÀ_Àn
)

1882 
__d0
, 
__d1
, 
__d2
;

1883 *
__ªs
;

1884 
__asm__
 
__vﬁ©ûe__


1897 : "=&a" (
__ªs
), "=&S" (
__d0
), "=&D" (
__d1
), "=&c" (
__d2
)

1898 : "g" (
__√edÀ_Àn
), "1" (
__hay°ack
), "d" (
__√edÀ
)

1900  
__ªs
;

1901 
	}
}

1903 
__STRING_INLINE
 *
__°r°r_g
 (c⁄° *
__hay°ack
,

1904 c⁄° *
__√edÀ
);

1905 #ifde‡
__PIC__


1907 
__STRING_INLINE
 *

1908 
	$__°r°r_g
 (c⁄° *
__hay°ack
, c⁄° *
__√edÀ
)

1910 
__d0
, 
__d1
, 
__d2
;

1911 *
__ªs
;

1912 
__asm__
 
__vﬁ©ûe__


1931 : "=&a" (
__ªs
), "=&c" (
__d0
), "=&S" (
__d1
), "=&D" (
__d2
)

1932 : "0" (0), "1" (0xffffffff), "2" (
__hay°ack
), "3" (
__√edÀ
),

1933 "d" (
__√edÀ
)

1935  
__ªs
;

1936 
	}
}

1938 
__STRING_INLINE
 *

1939 
	$__°r°r_g
 (c⁄° *
__hay°ack
, c⁄° *
__√edÀ
)

1941 
__d0
, 
__d1
, 
__d2
, 
__d3
;

1942 *
__ªs
;

1943 
__asm__
 
__vﬁ©ûe__


1960 : "=&a" (
__ªs
), "=&c" (
__d0
), "=&S" (
__d1
), "=&D" (
__d2
), "=&d" (
__d3
)

1961 : "0" (0), "1" (0xffffffff), "2" (
__hay°ack
), "3" (
__√edÀ
),

1962 "b" (
__√edÀ
)

1964  
__ªs
;

1965 
	}
}

1971 #i‡
deföed
 
__USE_MISC
 || deföed 
__USE_XOPEN_EXTENDED


1972 #ifde‡
__i686__


1973 
	#_HAVE_STRING_ARCH_ffs
 1

	)

1974 
	#ffs
(
w‹d
Ë(
	`__buûtö_c⁄°™t_p
 (word) \

1975 ? 
	`__buûtö_ffs
 (
w‹d
) \

1976 : ({ 
__˙t
, 
__tmp
; \

1977 
__asm__
 
__vﬁ©ûe__
 \

1980 : "=&r" (
__˙t
), "Ù" (
__tmp
) \

1981 : "rm" (
w‹d
), "1" (-1)); \

1982 
__˙t
 + 1; }))

	)

1984 #i‚de‡
ff¶


1985 
	#ff¶
(
w‹d
Ë
	`ffs
(w‹d)

	)

1990 #i‚de‡
_FORCE_INLINES


1991 #unde‡
__STRING_INLINE


	@/usr/include/bits/string2.h

20 #i‚de‡
_STRING_H


24 #i‚de‡
__NO_STRING_INLINES


41 #i‚de‡
__STRING_INLINE


42 #ifde‡
__˝lu•lus


43 
	#__STRING_INLINE
 
ölöe


	)

45 
	#__STRING_INLINE
 
__exã∫_ölöe


	)

52 
	#__°rög2_1b±r_p
(
__x
) \

53 ((
size_t
)(c⁄° *)((
__x
Ë+ 1Ë- (size_t)(c⁄° *)(__xË=1)

	)

56 #i‡!
deföed
 
_HAVE_STRING_ARCH_mem£t


57 
	#__bzîo
(
s
, 
n
Ë
	`__buûtö_mem£t
 (s, '\0',Ç)

	)

61 #i‚de‡
_HAVE_STRING_ARCH_°rchr


62 *
__øwmemchr
 (c⁄° *
__s
, 
__c
);

63 
	#°rchr
(
s
, 
c
) \

64 (
	`__exãnsi⁄__
 (
	`__buûtö_c⁄°™t_p
 (
c
Ë&& !__buûtö_c⁄°™t_∞(
s
) \

65 && (
c
) == '\0' \

66 ? (*Ë
	`__øwmemchr
 (
s
, 
c
) \

67 : 
	`__buûtö_°rchr
 (
s
, 
c
)))

	)

72 #ifde‡
__USE_GNU


73 #i‚de‡
_HAVE_STRING_ARCH_°p˝y


74 
	#__°p˝y
(
de°
, 
§c
Ë
	`__buûtö_°p˝y
 (de°, src)

	)

77 
	#°p˝y
(
de°
, 
§c
Ë
	`__°p˝y
 (de°, src)

	)

83 #i‚de‡
_HAVE_STRING_ARCH_°∫˝y


84 
	#°∫˝y
(
de°
, 
§c
, 
n
Ë
	`__buûtö_°∫˝y
 (de°, src,Ç)

	)

89 #i‚de‡
_HAVE_STRING_ARCH_°∫ˇt


90 #ifde‡
_USE_STRING_ARCH_°rchr


91 
	#°∫ˇt
(
de°
, 
§c
, 
n
) \

92 (
	`__exãnsi⁄__
 ({ *
__de°
 = (
de°
); \

93 
	`__buûtö_c⁄°™t_p
 (
§c
Ë&& __buûtö_c⁄°™t_∞(
n
) \

94 ? (
	`°æí
 (
§c
Ë< ((
size_t
Ë(
n
)) \

95 ? 
	`°rˇt
 (
__de°
, 
§c
) \

96 : (*((*Ë
	`__memp˝y
 (
	`°rchr
 (
__de°
, '\0'), \

97 
§c
, 
n
)Ë'\0', 
__de°
)) \

98 : 
	`°∫ˇt
 (
de°
, 
§c
, 
n
); }))

	)

100 
	#°∫ˇt
(
de°
, 
§c
, 
n
Ë
	`__buûtö_°∫ˇt
 (de°, src,Ç)

	)

106 #i‚de‡
_HAVE_STRING_ARCH_°rcmp


107 
	#°rcmp
(
s1
, 
s2
) \

108 
__exãnsi⁄__
 \

109 ({ 
size_t
 
__s1_Àn
, 
__s2_Àn
; \

110 (
	`__buûtö_c⁄°™t_p
 (
s1
Ë&& __buûtö_c⁄°™t_∞(
s2
) \

111 && (
__s1_Àn
 = 
	`°æí
 (
s1
), 
__s2_Àn
 = såÀ¿(
s2
), \

112 (!
	`__°rög2_1b±r_p
 (
s1
Ë|| 
__s1_Àn
 >= 4) \

113 && (!
	`__°rög2_1b±r_p
 (
s2
Ë|| 
__s2_Àn
 >= 4)) \

114 ? 
	`__buûtö_°rcmp
 (
s1
, 
s2
) \

115 : (
	`__buûtö_c⁄°™t_p
 (
s1
Ë&& 
	`__°rög2_1b±r_p
 (s1) \

116 && (
__s1_Àn
 = 
	`°æí
 (
s1
), __s1_len < 4) \

117 ? (
	`__buûtö_c⁄°™t_p
 (
s2
Ë&& 
	`__°rög2_1b±r_p
 (s2) \

118 ? 
	`__buûtö_°rcmp
 (
s1
, 
s2
) \

119 : 
	`__°rcmp_cg
 (
s1
, 
s2
, 
__s1_Àn
)) \

120 : (
	`__buûtö_c⁄°™t_p
 (
s2
Ë&& 
	`__°rög2_1b±r_p
 (s2) \

121 && (
__s2_Àn
 = 
	`°æí
 (
s2
), __s2_len < 4) \

122 ? (
	`__buûtö_c⁄°™t_p
 (
s1
Ë&& 
	`__°rög2_1b±r_p
 (s1) \

123 ? 
	`__buûtö_°rcmp
 (
s1
, 
s2
) \

124 : -
	`__°rcmp_cg
 (
s2
, 
s1
, 
__s2_Àn
)) \

125 : 
	`__buûtö_°rcmp
 (
s1
, 
s2
)))); })

	)

127 
	#__°rcmp_cg
(
s1
, 
s2
, 
l1
) \

128 (
	`__exãnsi⁄__
 ({ c⁄° *
__s2
 = \

129 (c⁄° *Ë(c⁄° *Ë(
s2
); \

130 
__ªsu…
 = \

131 (((c⁄° *Ë(c⁄° *Ë(
s1
))[0] \

132 - 
__s2
[0]); \

133 i‡(
l1
 > 0 && 
__ªsu…
 == 0) \

135 
__ªsu…
 = (((const *) \

136 (c⁄° *Ë(
s1
))[1] - 
__s2
[1]); \

137 i‡(
l1
 > 1 && 
__ªsu…
 == 0) \

139 
__ªsu…
 = (((const *) \

140 (c⁄° *Ë(
s1
))[2] - 
__s2
[2]); \

141 i‡(
l1
 > 2 && 
__ªsu…
 == 0) \

142 
__ªsu…
 = (((const *) \

143 (c⁄° *Ë(
s1
))[3] \

144 - 
__s2
[3]); \

147 
__ªsu…
; }))

	)

152 #i‚de‡
_HAVE_STRING_ARCH_°∫cmp


153 
	#°∫cmp
(
s1
, 
s2
, 
n
) \

154 (
	`__exãnsi⁄__
 (
	`__buûtö_c⁄°™t_p
 (
n
) \

155 && ((
	`__buûtö_c⁄°™t_p
 (
s1
) \

156 && 
	`°æí
 (
s1
Ë< ((
size_t
Ë(
n
))) \

157 || (
	`__buûtö_c⁄°™t_p
 (
s2
) \

158 && 
	`°æí
 (
s2
Ë< ((
size_t
Ë(
n
)))) \

159 ? 
	`°rcmp
 (
s1
, 
s2
Ë: 
	`°∫cmp
 (s1, s2, 
n
)))

	)

165 #i‚de‡
_HAVE_STRING_ARCH_°rc•n


166 
	#°rc•n
(
s
, 
ªje˘
Ë
	`__buûtö_°rc•n
 (s,Ñeje˘)

	)

172 #i‚de‡
_HAVE_STRING_ARCH_°r•n


173 
	#°r•n
(
s
, 
ac˚±
Ë
	`__buûtö_°r•n
 (s,ác˚±)

	)

178 #i‚de‡
_HAVE_STRING_ARCH_°Ωbrk


179 
	#°Ωbrk
(
s
, 
ac˚±
Ë
	`__buûtö_°Ωbrk
 (s,ác˚±)

	)

186 #ifde‡
__USE_MISC


188 #i‡!
deföed
 
_HAVE_STRING_ARCH_°rdup
 || !deföed 
_HAVE_STRING_ARCH_°∫dup


189 
	#__√ed_mÆloc_™d_ˇŒoc


	)

190 
	~<°dlib.h
>

193 #i‚de‡
_HAVE_STRING_ARCH_°rdup


195 *
	$__°rdup
 (c⁄° *
__°rög
Ë
__THROW
 
__©åibuã_mÆloc__
;

196 
	#__°rdup
(
s
) \

197 (
	`__exãnsi⁄__
 (
	`__buûtö_c⁄°™t_p
 (
s
Ë&& 
	`__°rög2_1b±r_p
 (s) \

198 ? (((c⁄° *Ë(
s
))[0] == '\0' \

199 ? (*Ë
	`ˇŒoc
 ((
size_t
) 1, (size_t) 1) \

200 : ({ 
size_t
 
__Àn
 = 
	`°æí
 (
s
) + 1; \

201 *
__ªtvÆ
 = (*Ë
	`mÆloc
 (
__Àn
); \

202 i‡(
__ªtvÆ
 !
NULL
) \

203 
__ªtvÆ
 = (*Ë
	`mem˝y
 (__ªtvÆ, 
s
, 
__Àn
); \

204 
__ªtvÆ
; 
	}
})) \

205 : 
	`__°rdup
 (
s
)))

	)

207 #i‡
deföed
 
__USE_XOPEN_EXTENDED
 || deföed 
__USE_XOPEN2K8


208 
	#°rdup
(
s
Ë
	`__°rdup
 (s)

	)

212 #i‚de‡
_HAVE_STRING_ARCH_°∫dup


214 *
	$__°∫dup
 (c⁄° *
__°rög
, 
size_t
 
__n
)

215 
__THROW
 
__©åibuã_mÆloc__
;

216 
	#__°∫dup
(
s
, 
n
) \

217 (
	`__exãnsi⁄__
 (
	`__buûtö_c⁄°™t_p
 (
s
Ë&& 
	`__°rög2_1b±r_p
 (s) \

218 ? (((c⁄° *Ë(
s
))[0] == '\0' \

219 ? (*Ë
	`ˇŒoc
 ((
size_t
) 1, (size_t) 1) \

220 : ({ 
size_t
 
__Àn
 = 
	`°æí
 (
s
) + 1; \

221 
size_t
 
__n
 = (
n
); \

222 *
__ªtvÆ
; \

223 i‡(
__n
 < 
__Àn
) \

224 
__Àn
 = 
__n
 + 1; \

225 
__ªtvÆ
 = (*Ë
	`mÆloc
 (
__Àn
); \

226 i‡(
__ªtvÆ
 !
NULL
) \

228 
__ªtvÆ
[
__Àn
 - 1] = '\0'; \

229 
__ªtvÆ
 = (*Ë
	`mem˝y
 (__ªtvÆ, 
s
, \

230 
__Àn
 - 1); \

232 
__ªtvÆ
; 
	}
})) \

233 : 
	`__°∫dup
 (
s
, 
n
)))

	)

235 #ifde‡
__USE_XOPEN2K8


236 
	#°∫dup
(
s
, 
n
Ë
	`__°∫dup
 (s,Ç)

	)

242 #i‚de‡
_FORCE_INLINES


243 #unde‡
__STRING_INLINE


	@/usr/include/bits/string3.h

18 #i‚de‡
_STRING_H


22 #i‡!
__GNUC_PREREQ
 (5,0)

23 
__w¨nde˛
 (
__w¨n_mem£t_zîo_Àn
,

27 #i‚de‡
__˝lu•lus


31 #unde‡
mem˝y


32 #unde‡
memmove


33 #unde‡
mem£t


34 #unde‡
°rˇt


35 #unde‡
°r˝y


36 #unde‡
°∫ˇt


37 #unde‡
°∫˝y


38 #ifde‡
__USE_GNU


39 #unde‡
memp˝y


40 #unde‡
°p˝y


42 #ifde‡
__USE_MISC


43 #unde‡
bc›y


44 #unde‡
bzîo


49 
__f‹tify_fun˘i⁄
 *

50 
__NTH
 (
	$mem˝y
 (*
__ª°ri˘
 
__de°
, c⁄° *__ª°ri˘ 
__§c
,

51 
size_t
 
__Àn
))

53  
	`__buûtö___mem˝y_chk
 (
__de°
, 
__§c
, 
__Àn
, 
	`__bos0
 (__dest));

54 
	}
}

56 
__f‹tify_fun˘i⁄
 *

57 
__NTH
 (
	$memmove
 (*
__de°
, c⁄° *
__§c
, 
size_t
 
__Àn
))

59  
	`__buûtö___memmove_chk
 (
__de°
, 
__§c
, 
__Àn
, 
	`__bos0
 (__dest));

60 
	}
}

62 #ifde‡
__USE_GNU


63 
__f‹tify_fun˘i⁄
 *

64 
__NTH
 (
	$memp˝y
 (*
__ª°ri˘
 
__de°
, c⁄° *__ª°ri˘ 
__§c
,

65 
size_t
 
__Àn
))

67  
	`__buûtö___memp˝y_chk
 (
__de°
, 
__§c
, 
__Àn
, 
	`__bos0
 (__dest));

68 
	}
}

77 
__f‹tify_fun˘i⁄
 *

78 
__NTH
 (
	$mem£t
 (*
__de°
, 
__ch
, 
size_t
 
__Àn
))

82 #i‡!
	`__GNUC_PREREQ
 (5,0)

83 i‡(
	`__buûtö_c⁄°™t_p
 (
__Àn
) && __len == 0

84 && (!
	`__buûtö_c⁄°™t_p
 (
__ch
) || __ch != 0))

86 
	`__w¨n_mem£t_zîo_Àn
 ();

87  
__de°
;

90  
	`__buûtö___mem£t_chk
 (
__de°
, 
__ch
, 
__Àn
, 
	`__bos0
 (__dest));

91 
	}
}

93 #ifde‡
__USE_MISC


94 
	~<bôs/°rögs_f‹tifõd.h
>

96 
	$__ex∂icô_bzîo_chk
 (*
__de°
, 
size_t
 
__Àn
, size_à
__de°Àn
)

97 
__THROW
 
	`__n⁄nuŒ
 ((1));

99 
__f‹tify_fun˘i⁄
 

100 
	`__NTH
 (
	$ex∂icô_bzîo
 (*
__de°
, 
size_t
 
__Àn
))

102 
	`__ex∂icô_bzîo_chk
 (
__de°
, 
__Àn
, 
	`__bos0
 (__dest));

103 
	}
}

106 
__f‹tify_fun˘i⁄
 *

107 
__NTH
 (
	$°r˝y
 (*
__ª°ri˘
 
__de°
, c⁄° *__ª°ri˘ 
__§c
))

109  
	`__buûtö___°r˝y_chk
 (
__de°
, 
__§c
, 
	`__bos
 (__dest));

110 
	}
}

112 #ifde‡
__USE_GNU


113 
__f‹tify_fun˘i⁄
 *

114 
__NTH
 (
	$°p˝y
 (*
__ª°ri˘
 
__de°
, c⁄° *__ª°ri˘ 
__§c
))

116  
	`__buûtö___°p˝y_chk
 (
__de°
, 
__§c
, 
	`__bos
 (__dest));

117 
	}
}

121 
__f‹tify_fun˘i⁄
 *

122 
__NTH
 (
	$°∫˝y
 (*
__ª°ri˘
 
__de°
, c⁄° *__ª°ri˘ 
__§c
,

123 
size_t
 
__Àn
))

125  
	`__buûtö___°∫˝y_chk
 (
__de°
, 
__§c
, 
__Àn
, 
	`__bos
 (__dest));

126 
	}
}

129 *
	$__°≤˝y_chk
 (*
__de°
, c⁄° *
__§c
, 
size_t
 
__n
,

130 
size_t
 
__de°Àn
Ë
__THROW
;

131 *
	`__REDIRECT_NTH
 (
__°≤˝y_Æüs
, (*
__de°
, c⁄° *
__§c
,

132 
size_t
 
__n
), 
°≤˝y
);

134 
__f‹tify_fun˘i⁄
 *

135 
	`__NTH
 (
	$°≤˝y
 (*
__de°
, c⁄° *
__§c
, 
size_t
 
__n
))

137 i‡(
	`__bos
 (
__de°
Ë!(
size_t
) -1

138 && (!
	`__buûtö_c⁄°™t_p
 (
__n
Ë|| __¿> 
	`__bos
 (
__de°
)))

139  
	`__°≤˝y_chk
 (
__de°
, 
__§c
, 
__n
, 
	`__bos
 (__dest));

140  
	`__°≤˝y_Æüs
 (
__de°
, 
__§c
, 
__n
);

141 
	}
}

144 
__f‹tify_fun˘i⁄
 *

145 
__NTH
 (
	$°rˇt
 (*
__ª°ri˘
 
__de°
, c⁄° *__ª°ri˘ 
__§c
))

147  
	`__buûtö___°rˇt_chk
 (
__de°
, 
__§c
, 
	`__bos
 (__dest));

148 
	}
}

151 
__f‹tify_fun˘i⁄
 *

152 
__NTH
 (
	$°∫ˇt
 (*
__ª°ri˘
 
__de°
, c⁄° *__ª°ri˘ 
__§c
,

153 
size_t
 
__Àn
))

155  
	`__buûtö___°∫ˇt_chk
 (
__de°
, 
__§c
, 
__Àn
, 
	`__bos
 (__dest));

156 
	}
}

	@/usr/include/bits/types.h

23 #i‚def 
_BITS_TYPES_H


24 
	#_BITS_TYPES_H
 1

	)

26 
	~<„©uªs.h
>

27 
	~<bôs/w‹dsize.h
>

30 
	t__u_ch¨
;

31 
	t__u_sh‹t
;

32 
	t__u_öt
;

33 
	t__u_l⁄g
;

36 sig√d 
	t__öt8_t
;

37 
	t__uöt8_t
;

38 sig√d 
	t__öt16_t
;

39 
	t__uöt16_t
;

40 sig√d 
	t__öt32_t
;

41 
	t__uöt32_t
;

42 #i‡
__WORDSIZE
 == 64

43 sig√d 
	t__öt64_t
;

44 
	t__uöt64_t
;

46 
__exãnsi⁄__
 sig√d 
	t__öt64_t
;

47 
__exãnsi⁄__
 
	t__uöt64_t
;

51 #i‡
__WORDSIZE
 == 64

52 
	t__quad_t
;

53 
	t__u_quad_t
;

55 
__exãnsi⁄__
 
	t__quad_t
;

56 
__exãnsi⁄__
 
	t__u_quad_t
;

60 #i‡
__WORDSIZE
 == 64

61 
	t__ötmax_t
;

62 
	t__uötmax_t
;

64 
__exãnsi⁄__
 
	t__ötmax_t
;

65 
__exãnsi⁄__
 
	t__uötmax_t
;

98 
	#__S16_TYPE
 

	)

99 
	#__U16_TYPE
 

	)

100 
	#__S32_TYPE
 

	)

101 
	#__U32_TYPE
 

	)

102 
	#__SLONGWORD_TYPE
 

	)

103 
	#__ULONGWORD_TYPE
 

	)

104 #i‡
__WORDSIZE
 == 32

105 
	#__SQUAD_TYPE
 
__quad_t


	)

106 
	#__UQUAD_TYPE
 
__u_quad_t


	)

107 
	#__SWORD_TYPE
 

	)

108 
	#__UWORD_TYPE
 

	)

109 
	#__SLONG32_TYPE
 

	)

110 
	#__ULONG32_TYPE
 

	)

111 
	#__S64_TYPE
 
__quad_t


	)

112 
	#__U64_TYPE
 
__u_quad_t


	)

115 
	#__STD_TYPE
 
__exãnsi⁄__
 

	)

116 #ñi‡
__WORDSIZE
 == 64

117 
	t__SQUAD_TYPE
 

	)

118 
	t__UQUAD_TYPE
 

	)

119 
	t__SWORD_TYPE
 

	)

120 
	t__UWORD_TYPE
 

	)

121 
	t__SLONG32_TYPE
 

	)

122 
	t__ULONG32_TYPE
 

	)

123 
	t__S64_TYPE
 

	)

124 
	t__U64_TYPE
 

	)

126 
	t__STD_TYPE
 

	)

130 
	~<bôs/ty≥sizes.h
>

133 
__STD_TYPE
 
	t__DEV_T_TYPE
 
	t__dev_t
;

134 
__STD_TYPE
 
__UID_T_TYPE
 
	g__uid_t
;

135 
__STD_TYPE
 
__GID_T_TYPE
 
	g__gid_t
;

136 
__STD_TYPE
 
__INO_T_TYPE
 
	g__öo_t
;

137 
__STD_TYPE
 
__INO64_T_TYPE
 
	g__öo64_t
;

138 
__STD_TYPE
 
__MODE_T_TYPE
 
	g__mode_t
;

139 
__STD_TYPE
 
__NLINK_T_TYPE
 
	g__∆ök_t
;

140 
__STD_TYPE
 
__OFF_T_TYPE
 
	g__off_t
;

141 
__STD_TYPE
 
__OFF64_T_TYPE
 
	g__off64_t
;

142 
__STD_TYPE
 
__PID_T_TYPE
 
	g__pid_t
;

143 
__STD_TYPE
 
__FSID_T_TYPE
 
	g__fsid_t
;

144 
__STD_TYPE
 
__CLOCK_T_TYPE
 
	g__˛ock_t
;

145 
__STD_TYPE
 
__RLIM_T_TYPE
 
	g__æim_t
;

146 
__STD_TYPE
 
__RLIM64_T_TYPE
 
	g__æim64_t
;

147 
__STD_TYPE
 
__ID_T_TYPE
 
	g__id_t
;

148 
__STD_TYPE
 
__TIME_T_TYPE
 
	g__time_t
;

149 
__STD_TYPE
 
__USECONDS_T_TYPE
 
	g__u£c⁄ds_t
;

150 
__STD_TYPE
 
__SUSECONDS_T_TYPE
 
	g__su£c⁄ds_t
;

152 
__STD_TYPE
 
__DADDR_T_TYPE
 
	g__daddr_t
;

153 
__STD_TYPE
 
__KEY_T_TYPE
 
	g__key_t
;

156 
__STD_TYPE
 
__CLOCKID_T_TYPE
 
	g__˛ockid_t
;

159 
__STD_TYPE
 
__TIMER_T_TYPE
 
	g__timî_t
;

162 
__STD_TYPE
 
__BLKSIZE_T_TYPE
 
	g__blksize_t
;

167 
__STD_TYPE
 
__BLKCNT_T_TYPE
 
	g__blk˙t_t
;

168 
__STD_TYPE
 
__BLKCNT64_T_TYPE
 
	g__blk˙t64_t
;

171 
__STD_TYPE
 
__FSBLKCNT_T_TYPE
 
	g__fsblk˙t_t
;

172 
__STD_TYPE
 
__FSBLKCNT64_T_TYPE
 
	g__fsblk˙t64_t
;

175 
__STD_TYPE
 
__FSFILCNT_T_TYPE
 
	g__fsfû˙t_t
;

176 
__STD_TYPE
 
__FSFILCNT64_T_TYPE
 
	g__fsfû˙t64_t
;

179 
__STD_TYPE
 
__FSWORD_T_TYPE
 
	g__fsw‹d_t
;

181 
__STD_TYPE
 
__SSIZE_T_TYPE
 
	g__ssize_t
;

184 
__STD_TYPE
 
__SYSCALL_SLONG_TYPE
 
	g__sysˇŒ_¶⁄g_t
;

186 
__STD_TYPE
 
__SYSCALL_ULONG_TYPE
 
	g__sysˇŒ_ul⁄g_t
;

190 
__off64_t
 
	t__loff_t
;

191 
__quad_t
 *
	t__qaddr_t
;

192 *
	t__ˇddr_t
;

195 
__STD_TYPE
 
__SWORD_TYPE
 
	g__öçå_t
;

198 
__STD_TYPE
 
__U32_TYPE
 
	g__sockÀn_t
;

201 #unde‡
__STD_TYPE


	@/usr/include/bits/uintn-identity.h

19 #i‡!
deföed
 
_NETINET_IN_H
 && !deföed 
_ENDIAN_H


23 #i‚de‡
_BITS_UINTN_IDENTITY_H


24 
	#_BITS_UINTN_IDENTITY_H
 1

	)

26 
	~<bôs/ty≥s.h
>

32 
__ölöe
 
__uöt16_t


33 
	$__uöt16_idítôy
 (
__uöt16_t
 
__x
)

35  
__x
;

36 
	}
}

38 
__ölöe
 
__uöt32_t


39 
	$__uöt32_idítôy
 (
__uöt32_t
 
__x
)

41  
__x
;

42 
	}
}

44 
__ölöe
 
__uöt64_t


45 
	$__uöt64_idítôy
 (
__uöt64_t
 
__x
)

47  
__x
;

48 
	}
}

	@/usr/include/bits/waitflags.h

19 #i‡!
deföed
 
_SYS_WAIT_H
 && !deföed 
_STDLIB_H


25 
	#WNOHANG
 1

	)

26 
	#WUNTRACED
 2

	)

29 
	#WSTOPPED
 2

	)

30 
	#WEXITED
 4

	)

31 
	#WCONTINUED
 8

	)

32 
	#WNOWAIT
 0x01000000

	)

34 
	#__WNOTHREAD
 0x20000000

	)

36 
	#__WALL
 0x40000000

	)

37 
	#__WCLONE
 0x80000000

	)

	@/usr/include/bits/waitstatus.h

19 #i‡!
deföed
 
_SYS_WAIT_H
 && !deföed 
_STDLIB_H


28 
	#__WEXITSTATUS
(
°©us
Ë(((°©usË& 0xff00Ë>> 8)

	)

31 
	#__WTERMSIG
(
°©us
Ë((°©usË& 0x7f)

	)

34 
	#__WSTOPSIG
(
°©us
Ë
	`__WEXITSTATUS
(°©us)

	)

37 
	#__WIFEXITED
(
°©us
Ë(
	`__WTERMSIG
(°©usË=0)

	)

40 
	#__WIFSIGNALED
(
°©us
) \

41 (((sig√d Ë(((
°©us
Ë& 0x7fË+ 1Ë>> 1Ë> 0)

	)

44 
	#__WIFSTOPPED
(
°©us
Ë(((°©usË& 0xffË=0x7f)

	)

48 #ifde‡
WCONTINUED


49 
	#__WIFCONTINUED
(
°©us
Ë((°©usË=
__W_CONTINUED
)

	)

53 
	#__WCOREDUMP
(
°©us
Ë((°©usË& 
__WCOREFLAG
)

	)

56 
	#__W_EXITCODE
(
ªt
, 
sig
Ë(‘ëË<< 8 | (sig))

	)

57 
	#__W_STOPCODE
(
sig
Ë((sigË<< 8 | 0x7f)

	)

58 
	#__W_CONTINUED
 0xffff

	)

59 
	#__WCOREFLAG
 0x80

	)

	@/usr/include/bits/wchar.h

19 #i‚de‡
_BITS_WCHAR_H


20 
	#_BITS_WCHAR_H
 1

	)

33 #ifde‡
__WCHAR_MAX__


34 
	#__WCHAR_MAX
 
__WCHAR_MAX__


	)

35 #ñi‡
L
'\0' - 1 > 0

36 
	#__WCHAR_MAX
 (0xffffffffu + 
L
'\0')

	)

38 
	#__WCHAR_MAX
 (0x7ffffff‡+ 
L
'\0')

	)

41 #ifde‡
__WCHAR_MIN__


42 
	#__WCHAR_MIN
 
__WCHAR_MIN__


	)

43 #ñi‡
L
'\0' - 1 > 0

44 
	#__WCHAR_MIN
 (
L
'\0' + 0)

	)

46 
	#__WCHAR_MIN
 (-
__WCHAR_MAX
 - 1)

	)

	@/usr/include/bits/wordsize.h

3 #i‡
deföed
 
__x86_64__
 && !deföed 
__ILP32__


4 
	#__WORDSIZE
 64

	)

6 
	#__WORDSIZE
 32

	)

7 
	#__WORDSIZE32_SIZE_ULONG
 0

	)

8 
	#__WORDSIZE32_PTRDIFF_LONG
 0

	)

11 #ifde‡
__x86_64__


12 
	#__WORDSIZE_TIME64_COMPAT32
 1

	)

14 
	#__SYSCALL_WORDSIZE
 64

	)

16 
	#__WORDSIZE_TIME64_COMPAT32
 0

	)

	@/usr/include/features.h

18 #i‚def 
_FEATURES_H


19 
	#_FEATURES_H
 1

	)

116 #unde‡
__USE_ISOC11


117 #unde‡
__USE_ISOC99


118 #unde‡
__USE_ISOC95


119 #unde‡
__USE_ISOCXX11


120 #unde‡
__USE_POSIX


121 #unde‡
__USE_POSIX2


122 #unde‡
__USE_POSIX199309


123 #unde‡
__USE_POSIX199506


124 #unde‡
__USE_XOPEN


125 #unde‡
__USE_XOPEN_EXTENDED


126 #unde‡
__USE_UNIX98


127 #unde‡
__USE_XOPEN2K


128 #unde‡
__USE_XOPEN2KXSI


129 #unde‡
__USE_XOPEN2K8


130 #unde‡
__USE_XOPEN2K8XSI


131 #unde‡
__USE_LARGEFILE


132 #unde‡
__USE_LARGEFILE64


133 #unde‡
__USE_FILE_OFFSET64


134 #unde‡
__USE_MISC


135 #unde‡
__USE_ATFILE


136 #unde‡
__USE_GNU


137 #unde‡
__USE_FORTIFY_LEVEL


138 #unde‡
__KERNEL_STRICT_NAMES


142 #i‚de‡
_LOOSE_KERNEL_NAMES


143 
	#__KERNEL_STRICT_NAMES


	)

153 #i‡
deföed
 
__GNUC__
 && deföed 
__GNUC_MINOR__


154 
	#__GNUC_PREREQ
(
maj
, 
mö
) \

155 ((
__GNUC__
 << 16Ë+ 
__GNUC_MINOR__
 >((
maj
Ë<< 16Ë+ (
mö
))

	)

157 
	#__GNUC_PREREQ
(
maj
, 
mö
Ë0

	)

164 #i‡
deföed
 
__˛™g_maj‹__
 && deföed 
__˛™g_mö‹__


165 
	#__glibc_˛™g_¥îeq
(
maj
, 
mö
) \

166 ((
__˛™g_maj‹__
 << 16Ë+ 
__˛™g_mö‹__
 >((
maj
Ë<< 16Ë+ (
mö
))

	)

168 
	#__glibc_˛™g_¥îeq
(
maj
, 
mö
Ë0

	)

172 
	#__GLIBC_USE
(
F
Ë
__GLIBC_USE_
 ## 
	)
F

178 #i‡(
deföed
 
_BSD_SOURCE
 || deföed 
_SVID_SOURCE
) \

179 && !
deföed
 
	g_DEFAULT_SOURCE


181 #unde‡
_DEFAULT_SOURCE


182 
	#_DEFAULT_SOURCE
 1

	)

186 #ifde‡
_GNU_SOURCE


187 #unde‡
_ISOC95_SOURCE


188 
	#_ISOC95_SOURCE
 1

	)

189 #unde‡
_ISOC99_SOURCE


190 
	#_ISOC99_SOURCE
 1

	)

191 #unde‡
_ISOC11_SOURCE


192 
	#_ISOC11_SOURCE
 1

	)

193 #unde‡
_POSIX_SOURCE


194 
	#_POSIX_SOURCE
 1

	)

195 #unde‡
_POSIX_C_SOURCE


196 
	#_POSIX_C_SOURCE
 200809L

	)

197 #unde‡
_XOPEN_SOURCE


198 
	#_XOPEN_SOURCE
 700

	)

199 #unde‡
_XOPEN_SOURCE_EXTENDED


200 
	#_XOPEN_SOURCE_EXTENDED
 1

	)

201 #unde‡
_LARGEFILE64_SOURCE


202 
	#_LARGEFILE64_SOURCE
 1

	)

203 #unde‡
_DEFAULT_SOURCE


204 
	#_DEFAULT_SOURCE
 1

	)

205 #unde‡
_ATFILE_SOURCE


206 
	#_ATFILE_SOURCE
 1

	)

211 #i‡(
deföed
 
_DEFAULT_SOURCE
 \

212 || (!
deföed
 
	g__STRICT_ANSI__
 \

213 && !
deföed
 
	g_ISOC99_SOURCE
 \

214 && !
deföed
 
	g_POSIX_SOURCE
 && !deföed 
	g_POSIX_C_SOURCE
 \

215 && !
deföed
 
	g_XOPEN_SOURCE
))

216 #unde‡
_DEFAULT_SOURCE


217 
	#_DEFAULT_SOURCE
 1

	)

221 #i‡(
deföed
 
_ISOC11_SOURCE
 \

222 || (
deföed
 
	g__STDC_VERSION__
 && __STDC_VERSION__ >= 201112L))

223 
	#__USE_ISOC11
 1

	)

227 #i‡(
deföed
 
_ISOC99_SOURCE
 || deföed 
_ISOC11_SOURCE
 \

228 || (
deföed
 
__STDC_VERSION__
 && __STDC_VERSION__ >= 199901L))

229 
	#__USE_ISOC99
 1

	)

233 #i‡(
deföed
 
_ISOC99_SOURCE
 || deföed 
_ISOC11_SOURCE
 \

234 || (
deföed
 
__STDC_VERSION__
 && __STDC_VERSION__ >= 199409L))

235 
	#__USE_ISOC95
 1

	)

242 #i‡((
deföed
 
__˝lu•lus
 && __cplusplus >= 201103L) \

243 || 
deföed
 
__GXX_EXPERIMENTAL_CXX0X__
)

244 
	#__USE_ISOCXX11
 1

	)

250 #ifde‡
_DEFAULT_SOURCE


251 #i‡!
deföed
 
_POSIX_SOURCE
 && !deföed 
_POSIX_C_SOURCE


252 
	#__USE_POSIX_IMPLICITLY
 1

	)

254 #unde‡
_POSIX_SOURCE


255 
	#_POSIX_SOURCE
 1

	)

256 #unde‡
_POSIX_C_SOURCE


257 
	#_POSIX_C_SOURCE
 200809L

	)

260 #i‡((!
deföed
 
__STRICT_ANSI__
 \

261 || (
deföed
 
_XOPEN_SOURCE
 && (_XOPEN_SOURCE - 0) >= 500)) \

262 && !
deföed
 
_POSIX_SOURCE
 && !deföed 
_POSIX_C_SOURCE
)

263 
	#_POSIX_SOURCE
 1

	)

264 #i‡
deföed
 
_XOPEN_SOURCE
 && (_XOPEN_SOURCE - 0) < 500

265 
	#_POSIX_C_SOURCE
 2

	)

266 #ñi‡
deföed
 
_XOPEN_SOURCE
 && (_XOPEN_SOURCE - 0) < 600

267 
	#_POSIX_C_SOURCE
 199506L

	)

268 #ñi‡
deföed
 
_XOPEN_SOURCE
 && (_XOPEN_SOURCE - 0) < 700

269 
	#_POSIX_C_SOURCE
 200112L

	)

271 
	#_POSIX_C_SOURCE
 200809L

	)

273 
	#__USE_POSIX_IMPLICITLY
 1

	)

282 #i‡((!
deföed
 
_POSIX_C_SOURCE
 || (_POSIX_C_SOURCE - 0) < 199506L) \

283 && (
deföed
 
_REENTRANT
 || deföed 
_THREAD_SAFE
))

284 
	#_POSIX_SOURCE
 1

	)

285 #unde‡
_POSIX_C_SOURCE


286 
	#_POSIX_C_SOURCE
 199506L

	)

289 #i‡(
deföed
 
_POSIX_SOURCE
 \

290 || (
deföed
 
_POSIX_C_SOURCE
 && _POSIX_C_SOURCE >= 1) \

291 || 
deföed
 
_XOPEN_SOURCE
)

292 
	#__USE_POSIX
 1

	)

295 #i‡
deföed
 
_POSIX_C_SOURCE
 && _POSIX_C_SOURCE >2 || deföed 
_XOPEN_SOURCE


296 
	#__USE_POSIX2
 1

	)

299 #i‡
deföed
 
_POSIX_C_SOURCE
 && (_POSIX_C_SOURCE - 0) >= 199309L

300 
	#__USE_POSIX199309
 1

	)

303 #i‡
deföed
 
_POSIX_C_SOURCE
 && (_POSIX_C_SOURCE - 0) >= 199506L

304 
	#__USE_POSIX199506
 1

	)

307 #i‡
deföed
 
_POSIX_C_SOURCE
 && (_POSIX_C_SOURCE - 0) >= 200112L

308 
	#__USE_XOPEN2K
 1

	)

309 #unde‡
__USE_ISOC95


310 
	#__USE_ISOC95
 1

	)

311 #unde‡
__USE_ISOC99


312 
	#__USE_ISOC99
 1

	)

315 #i‡
deföed
 
_POSIX_C_SOURCE
 && (_POSIX_C_SOURCE - 0) >= 200809L

316 
	#__USE_XOPEN2K8
 1

	)

317 #unde‡
_ATFILE_SOURCE


318 
	#_ATFILE_SOURCE
 1

	)

321 #ifdef 
_XOPEN_SOURCE


322 
	#__USE_XOPEN
 1

	)

323 #i‡(
_XOPEN_SOURCE
 - 0) >= 500

324 
	#__USE_XOPEN_EXTENDED
 1

	)

325 
	#__USE_UNIX98
 1

	)

326 #unde‡
_LARGEFILE_SOURCE


327 
	#_LARGEFILE_SOURCE
 1

	)

328 #i‡(
_XOPEN_SOURCE
 - 0) >= 600

329 #i‡(
_XOPEN_SOURCE
 - 0) >= 700

330 
	#__USE_XOPEN2K8
 1

	)

331 
	#__USE_XOPEN2K8XSI
 1

	)

333 
	#__USE_XOPEN2K
 1

	)

334 
	#__USE_XOPEN2KXSI
 1

	)

335 #unde‡
__USE_ISOC95


336 
	#__USE_ISOC95
 1

	)

337 #unde‡
__USE_ISOC99


338 
	#__USE_ISOC99
 1

	)

341 #ifde‡
_XOPEN_SOURCE_EXTENDED


342 
	#__USE_XOPEN_EXTENDED
 1

	)

347 #ifde‡
_LARGEFILE_SOURCE


348 
	#__USE_LARGEFILE
 1

	)

351 #ifde‡
_LARGEFILE64_SOURCE


352 
	#__USE_LARGEFILE64
 1

	)

355 #i‡
deföed
 
_FILE_OFFSET_BITS
 && _FILE_OFFSET_BITS == 64

356 
	#__USE_FILE_OFFSET64
 1

	)

359 #i‡
deföed
 
_DEFAULT_SOURCE


360 
	#__USE_MISC
 1

	)

363 #ifdef 
_ATFILE_SOURCE


364 
	#__USE_ATFILE
 1

	)

367 #ifdef 
_GNU_SOURCE


368 
	#__USE_GNU
 1

	)

371 #i‡
deföed
 
_FORTIFY_SOURCE
 && _FORTIFY_SOURCE > 0

372 #i‡!
deföed
 
__OPTIMIZE__
 || __OPTIMIZE__ <= 0

373 #w¨nög 
_FORTIFY_SOURCE
 
ªquúes
 
compûög
 
wôh
 
›timiz©i⁄
 (-
O
)

374 #ñi‡!
__GNUC_PREREQ
 (4, 1)

375 #w¨nög 
_FORTIFY_SOURCE
 
ªquúes
 
GCC
 4.1 
‹
 
œãr


376 #ñi‡
_FORTIFY_SOURCE
 > 1

377 
	#__USE_FORTIFY_LEVEL
 2

	)

379 
	#__USE_FORTIFY_LEVEL
 1

	)

382 #i‚de‡
__USE_FORTIFY_LEVEL


383 
	#__USE_FORTIFY_LEVEL
 0

	)

388 
	~<°dc-¥edef.h
>

396 #unde‡
__GNU_LIBRARY__


397 
	#__GNU_LIBRARY__
 6

	)

401 
	#__GLIBC__
 2

	)

402 
	#__GLIBC_MINOR__
 25

	)

404 
	#__GLIBC_PREREQ
(
maj
, 
mö
) \

405 ((
__GLIBC__
 << 16Ë+ 
__GLIBC_MINOR__
 >((
maj
Ë<< 16Ë+ (
mö
))

	)

408 #i‚de‡
__ASSEMBLER__


409 #i‚de‡
_SYS_CDEFS_H


410 
	~<sys/cdefs.h
>

415 #i‡
deföed
 
__USE_FILE_OFFSET64
 && !deföed 
__REDIRECT


416 
	#__USE_LARGEFILE
 1

	)

417 
	#__USE_LARGEFILE64
 1

	)

423 #i‡
__GNUC_PREREQ
 (2, 7Ë&& 
deföed
 
__OPTIMIZE__
 \

424 && !
deföed
 
	g__OPTIMIZE_SIZE__
 && !deföed 
	g__NO_INLINE__
 \

425 && 
deföed
 
	g__exã∫_ölöe


426 
	#__USE_EXTERN_INLINES
 1

	)

434 
	~<gnu/°ubs.h
>

	@/usr/include/linux/byteorder/little_endian.h

1 #i‚de‡
_LINUX_BYTEORDER_LITTLE_ENDIAN_H


2 
	#_LINUX_BYTEORDER_LITTLE_ENDIAN_H


	)

4 #i‚de‡
__LITTLE_ENDIAN


5 
	#__LITTLE_ENDIAN
 1234

	)

7 #i‚de‡
__LITTLE_ENDIAN_BITFIELD


8 
	#__LITTLE_ENDIAN_BITFIELD


	)

11 
	~<löux/ty≥s.h
>

12 
	~<löux/swab.h
>

14 
	#__c⁄°™t_ht⁄l
(
x
Ë((
__be32
)
	`___c⁄°™t_swab32
((x)))

	)

15 
	#__c⁄°™t_¡ohl
(
x
Ë
	`___c⁄°™t_swab32
((
__be32
)(x))

	)

16 
	#__c⁄°™t_ht⁄s
(
x
Ë((
__be16
)
	`___c⁄°™t_swab16
((x)))

	)

17 
	#__c⁄°™t_¡ohs
(
x
Ë
	`___c⁄°™t_swab16
((
__be16
)(x))

	)

18 
	#__c⁄°™t_˝u_to_À64
(
x
Ë((
__À64
)(
__u64
)(x))

	)

19 
	#__c⁄°™t_À64_to_˝u
(
x
Ë((
__u64
)(
__À64
)(x))

	)

20 
	#__c⁄°™t_˝u_to_À32
(
x
Ë((
__À32
)(
__u32
)(x))

	)

21 
	#__c⁄°™t_À32_to_˝u
(
x
Ë((
__u32
)(
__À32
)(x))

	)

22 
	#__c⁄°™t_˝u_to_À16
(
x
Ë((
__À16
)(
__u16
)(x))

	)

23 
	#__c⁄°™t_À16_to_˝u
(
x
Ë((
__u16
)(
__À16
)(x))

	)

24 
	#__c⁄°™t_˝u_to_be64
(
x
Ë((
__be64
)
	`___c⁄°™t_swab64
((x)))

	)

25 
	#__c⁄°™t_be64_to_˝u
(
x
Ë
	`___c⁄°™t_swab64
((
__u64
)(
__be64
)(x))

	)

26 
	#__c⁄°™t_˝u_to_be32
(
x
Ë((
__be32
)
	`___c⁄°™t_swab32
((x)))

	)

27 
	#__c⁄°™t_be32_to_˝u
(
x
Ë
	`___c⁄°™t_swab32
((
__u32
)(
__be32
)(x))

	)

28 
	#__c⁄°™t_˝u_to_be16
(
x
Ë((
__be16
)
	`___c⁄°™t_swab16
((x)))

	)

29 
	#__c⁄°™t_be16_to_˝u
(
x
Ë
	`___c⁄°™t_swab16
((
__u16
)(
__be16
)(x))

	)

30 
	#__˝u_to_À64
(
x
Ë((
__À64
)(
__u64
)(x))

	)

31 
	#__À64_to_˝u
(
x
Ë((
__u64
)(
__À64
)(x))

	)

32 
	#__˝u_to_À32
(
x
Ë((
__À32
)(
__u32
)(x))

	)

33 
	#__À32_to_˝u
(
x
Ë((
__u32
)(
__À32
)(x))

	)

34 
	#__˝u_to_À16
(
x
Ë((
__À16
)(
__u16
)(x))

	)

35 
	#__À16_to_˝u
(
x
Ë((
__u16
)(
__À16
)(x))

	)

36 
	#__˝u_to_be64
(
x
Ë((
__be64
)
	`__swab64
((x)))

	)

37 
	#__be64_to_˝u
(
x
Ë
	`__swab64
((
__u64
)(
__be64
)(x))

	)

38 
	#__˝u_to_be32
(
x
Ë((
__be32
)
	`__swab32
((x)))

	)

39 
	#__be32_to_˝u
(
x
Ë
	`__swab32
((
__u32
)(
__be32
)(x))

	)

40 
	#__˝u_to_be16
(
x
Ë((
__be16
)
	`__swab16
((x)))

	)

41 
	#__be16_to_˝u
(
x
Ë
	`__swab16
((
__u16
)(
__be16
)(x))

	)

43 
__Æways_ölöe
 
__À64
 
	$__˝u_to_À64p
(c⁄° 
__u64
 *
p
)

45  (
__À64
)*
p
;

46 
	}
}

47 
__Æways_ölöe
 
__u64
 
	$__À64_to_˝up
(c⁄° 
__À64
 *
p
)

49  (
__u64
)*
p
;

50 
	}
}

51 
__Æways_ölöe
 
__À32
 
	$__˝u_to_À32p
(c⁄° 
__u32
 *
p
)

53  (
__À32
)*
p
;

54 
	}
}

55 
__Æways_ölöe
 
__u32
 
	$__À32_to_˝up
(c⁄° 
__À32
 *
p
)

57  (
__u32
)*
p
;

58 
	}
}

59 
__Æways_ölöe
 
__À16
 
	$__˝u_to_À16p
(c⁄° 
__u16
 *
p
)

61  (
__À16
)*
p
;

62 
	}
}

63 
__Æways_ölöe
 
__u16
 
	$__À16_to_˝up
(c⁄° 
__À16
 *
p
)

65  (
__u16
)*
p
;

66 
	}
}

67 
__Æways_ölöe
 
__be64
 
	$__˝u_to_be64p
(c⁄° 
__u64
 *
p
)

69  (
__be64
)
	`__swab64p
(
p
);

70 
	}
}

71 
__Æways_ölöe
 
__u64
 
	$__be64_to_˝up
(c⁄° 
__be64
 *
p
)

73  
	`__swab64p
((
__u64
 *)
p
);

74 
	}
}

75 
__Æways_ölöe
 
__be32
 
	$__˝u_to_be32p
(c⁄° 
__u32
 *
p
)

77  (
__be32
)
	`__swab32p
(
p
);

78 
	}
}

79 
__Æways_ölöe
 
__u32
 
	$__be32_to_˝up
(c⁄° 
__be32
 *
p
)

81  
	`__swab32p
((
__u32
 *)
p
);

82 
	}
}

83 
__Æways_ölöe
 
__be16
 
	$__˝u_to_be16p
(c⁄° 
__u16
 *
p
)

85  (
__be16
)
	`__swab16p
(
p
);

86 
	}
}

87 
__Æways_ölöe
 
__u16
 
	$__be16_to_˝up
(c⁄° 
__be16
 *
p
)

89  
	`__swab16p
((
__u16
 *)
p
);

90 
	}
}

91 
	#__˝u_to_À64s
(
x
Ëdÿ{ ()(x); } 0)

	)

92 
	#__À64_to_˝us
(
x
Ëdÿ{ ()(x); } 0)

	)

93 
	#__˝u_to_À32s
(
x
Ëdÿ{ ()(x); } 0)

	)

94 
	#__À32_to_˝us
(
x
Ëdÿ{ ()(x); } 0)

	)

95 
	#__˝u_to_À16s
(
x
Ëdÿ{ ()(x); } 0)

	)

96 
	#__À16_to_˝us
(
x
Ëdÿ{ ()(x); } 0)

	)

97 
	#__˝u_to_be64s
(
x
Ë
	`__swab64s
((x))

	)

98 
	#__be64_to_˝us
(
x
Ë
	`__swab64s
((x))

	)

99 
	#__˝u_to_be32s
(
x
Ë
	`__swab32s
((x))

	)

100 
	#__be32_to_˝us
(
x
Ë
	`__swab32s
((x))

	)

101 
	#__˝u_to_be16s
(
x
Ë
	`__swab16s
((x))

	)

102 
	#__be16_to_˝us
(
x
Ë
	`__swab16s
((x))

	)

	@/usr/include/linux/ioctl.h

1 #i‚de‡
_LINUX_IOCTL_H


2 
	#_LINUX_IOCTL_H


	)

4 
	~<asm/io˘l.h
>

	@/usr/include/linux/irqnr.h

	@/usr/include/linux/limits.h

1 #i‚de‡
_LINUX_LIMITS_H


2 
	#_LINUX_LIMITS_H


	)

4 
	#NR_OPEN
 1024

	)

6 
	#NGROUPS_MAX
 65536

	)

7 
	#ARG_MAX
 131072

	)

8 
	#LINK_MAX
 127

	)

9 
	#MAX_CANON
 255

	)

10 
	#MAX_INPUT
 255

	)

11 
	#NAME_MAX
 255

	)

12 
	#PATH_MAX
 4096

	)

13 
	#PIPE_BUF
 4096

	)

14 
	#XATTR_NAME_MAX
 255

	)

15 
	#XATTR_SIZE_MAX
 65536

	)

16 
	#XATTR_LIST_MAX
 65536

	)

18 
	#RTSIG_MAX
 32

	)

	@/usr/include/linux/posix_types.h

1 #i‚de‡
_LINUX_POSIX_TYPES_H


2 
	#_LINUX_POSIX_TYPES_H


	)

4 
	~<löux/°ddef.h
>

21 #unde‡
__FD_SETSIZE


22 
	#__FD_SETSIZE
 1024

	)

25 
	mfds_bôs
[
__FD_SETSIZE
 / (8 * ())];

26 } 
	t__kî√l_fd_£t
;

29 (*
	t__kî√l_sigh™dÀr_t
)();

32 
	t__kî√l_key_t
;

33 
	t__kî√l_mqd_t
;

35 
	~<asm/posix_ty≥s.h
>

	@/usr/include/linux/sysinfo.h

1 #i‚de‡
_LINUX_SYSINFO_H


2 
	#_LINUX_SYSINFO_H


	)

4 
	~<löux/ty≥s.h
>

6 
	#SI_LOAD_SHIFT
 16

	)

7 
	ssysöfo
 {

8 
__kî√l_l⁄g_t
 
	mu±ime
;

9 
__kî√l_ul⁄g_t
 
	mlﬂds
[3];

10 
__kî√l_ul⁄g_t
 
	mtŸÆøm
;

11 
__kî√l_ul⁄g_t
 
	m‰ìøm
;

12 
__kî√l_ul⁄g_t
 
	msh¨edøm
;

13 
__kî√l_ul⁄g_t
 
	mbuf„ºam
;

14 
__kî√l_ul⁄g_t
 
	mtŸÆsw≠
;

15 
__kî√l_ul⁄g_t
 
	m‰ìsw≠
;

16 
__u16
 
	m¥ocs
;

17 
__u16
 
	m∑d
;

18 
__kî√l_ul⁄g_t
 
	mtŸÆhigh
;

19 
__kî√l_ul⁄g_t
 
	m‰ìhigh
;

20 
__u32
 
	mmem_unô
;

21 
	m_f
[20-2*(
__kî√l_ul⁄g_t
)-(
__u32
)];

	@/usr/include/sys/types.h

22 #i‚def 
_SYS_TYPES_H


23 
	#_SYS_TYPES_H
 1

	)

25 
	~<„©uªs.h
>

27 
	g__BEGIN_DECLS


29 
	~<bôs/ty≥s.h
>

31 #ifdef 
__USE_MISC


32 #i‚de‡
__u_ch¨_deföed


33 
__u_ch¨
 
	tu_ch¨
;

34 
__u_sh‹t
 
	tu_sh‹t
;

35 
__u_öt
 
	tu_öt
;

36 
__u_l⁄g
 
	tu_l⁄g
;

37 
__quad_t
 
	tquad_t
;

38 
__u_quad_t
 
	tu_quad_t
;

39 
__fsid_t
 
	tfsid_t
;

40 
	#__u_ch¨_deföed


	)

44 
__loff_t
 
	tloff_t
;

46 #i‚de‡
__öo_t_deföed


47 #i‚de‡
__USE_FILE_OFFSET64


48 
__öo_t
 
	töo_t
;

50 
__öo64_t
 
	töo_t
;

52 
	#__öo_t_deföed


	)

54 #i‡
deföed
 
__USE_LARGEFILE64
 && !deföed 
__öo64_t_deföed


55 
__öo64_t
 
	töo64_t
;

56 
	#__öo64_t_deföed


	)

59 #i‚de‡
__dev_t_deföed


60 
__dev_t
 
	tdev_t
;

61 
	#__dev_t_deföed


	)

64 #i‚de‡
__gid_t_deföed


65 
__gid_t
 
	tgid_t
;

66 
	#__gid_t_deföed


	)

69 #i‚de‡
__mode_t_deföed


70 
__mode_t
 
	tmode_t
;

71 
	#__mode_t_deföed


	)

74 #i‚de‡
__∆ök_t_deföed


75 
__∆ök_t
 
	t∆ök_t
;

76 
	#__∆ök_t_deföed


	)

79 #i‚de‡
__uid_t_deföed


80 
__uid_t
 
	tuid_t
;

81 
	#__uid_t_deföed


	)

84 #i‚de‡
__off_t_deföed


85 #i‚de‡
__USE_FILE_OFFSET64


86 
__off_t
 
	toff_t
;

88 
__off64_t
 
	toff_t
;

90 
	#__off_t_deföed


	)

92 #i‡
deföed
 
__USE_LARGEFILE64
 && !deföed 
__off64_t_deföed


93 
__off64_t
 
	toff64_t
;

94 
	#__off64_t_deföed


	)

97 #i‚de‡
__pid_t_deföed


98 
__pid_t
 
	tpid_t
;

99 
	#__pid_t_deföed


	)

102 #i‡(
deföed
 
__USE_XOPEN
 || deföed 
__USE_XOPEN2K8
) \

103 && !
deföed
 
__id_t_deföed


104 
__id_t
 
	tid_t
;

105 
	#__id_t_deföed


	)

108 #i‚de‡
__ssize_t_deföed


109 
__ssize_t
 
	tssize_t
;

110 
	#__ssize_t_deföed


	)

113 #ifdef 
__USE_MISC


114 #i‚de‡
__daddr_t_deföed


115 
__daddr_t
 
	tdaddr_t
;

116 
__ˇddr_t
 
	tˇddr_t
;

117 
	#__daddr_t_deföed


	)

121 #i‡(
deföed
 
__USE_MISC
 || deföed 
__USE_XOPEN
Ë&& !deföed 
__key_t_deföed


122 
__key_t
 
	tkey_t
;

123 
	#__key_t_deföed


	)

126 #i‡
deföed
 
__USE_XOPEN
 || deföed 
__USE_XOPEN2K8


127 
	~<bôs/ty≥s/˛ock_t.h
>

129 
	~<bôs/ty≥s/˛ockid_t.h
>

130 
	~<bôs/ty≥s/time_t.h
>

131 
	~<bôs/ty≥s/timî_t.h
>

133 #ifde‡
__USE_XOPEN


134 #i‚de‡
__u£c⁄ds_t_deföed


135 
__u£c⁄ds_t
 
	tu£c⁄ds_t
;

136 
	#__u£c⁄ds_t_deföed


	)

138 #i‚de‡
__su£c⁄ds_t_deföed


139 
__su£c⁄ds_t
 
	tsu£c⁄ds_t
;

140 
	#__su£c⁄ds_t_deföed


	)

144 
	#__√ed_size_t


	)

145 
	~<°ddef.h
>

147 #ifde‡
__USE_MISC


149 
	tul⁄g
;

150 
	tush‹t
;

151 
	tuöt
;

156 #i‡!
__GNUC_PREREQ
 (2, 7)

159 #i‚de‡
__öt8_t_deföed


160 
	#__öt8_t_deföed


	)

161 
	töt8_t
;

162 
	töt16_t
;

163 
	töt32_t
;

164 #i‡
__WORDSIZE
 == 64

165 
	töt64_t
;

167 
__exãnsi⁄__
 
	töt64_t
;

172 
	tu_öt8_t
;

173 
	tu_öt16_t
;

174 
	tu_öt32_t
;

175 #i‡
__WORDSIZE
 == 64

176 
	tu_öt64_t
;

178 
__exãnsi⁄__
 
	tu_öt64_t
;

181 
	tªgi°î_t
;

186 
	#__ötN_t
(
N
, 
MODE
) \

187 ##
	tN
##
	t_t
 
	t__©åibuã__
 ((
	t__mode__
 (
	tMODE
)))

	)

188 
	t__u_ötN_t
(
	tN
, 
	tMODE
) \

189 
	tu_öt
##
	tN
##
	t_t
 
	t__©åibuã__
 ((
	t__mode__
 (
	tMODE
)))

	)

191 #i‚de‡
	t__öt8_t_deföed


192 
	t__öt8_t_deföed


	)

193 
	t__ötN_t
 (8, 
	t__QI__
);

194 
__ötN_t
 (16, 
__HI__
);

195 
__ötN_t
 (32, 
__SI__
);

196 
__ötN_t
 (64, 
__DI__
);

199 
__u_ötN_t
 (8, 
__QI__
);

200 
__u_ötN_t
 (16, 
__HI__
);

201 
__u_ötN_t
 (32, 
__SI__
);

202 
__u_ötN_t
 (64, 
__DI__
);

204 
	tªgi°î_t
 
	t__©åibuã__
 ((
	t__mode__
 (
	t__w‹d__
)));

210 
	#__BIT_TYPES_DEFINED__
 1

	)

213 #ifdef 
__USE_MISC


215 
	~<ídün.h
>

218 
	~<sys/£À˘.h
>

225 
	#__SYSMACROS_DEPRECATED_INCLUSION


	)

226 
	~<sys/sysma¸os.h
>

227 #unde‡
__SYSMACROS_DEPRECATED_INCLUSION


231 #i‡(
deföed
 
__USE_UNIX98
 || deföed 
__USE_XOPEN2K8
) \

232 && !
deföed
 
__blksize_t_deföed


233 
__blksize_t
 
	tblksize_t
;

234 
	#__blksize_t_deföed


	)

238 #i‚de‡
__USE_FILE_OFFSET64


239 #i‚de‡
__blk˙t_t_deföed


240 
__blk˙t_t
 
	tblk˙t_t
;

241 
	#__blk˙t_t_deföed


	)

243 #i‚de‡
__fsblk˙t_t_deföed


244 
__fsblk˙t_t
 
	tfsblk˙t_t
;

245 
	#__fsblk˙t_t_deföed


	)

247 #i‚de‡
__fsfû˙t_t_deföed


248 
__fsfû˙t_t
 
	tfsfû˙t_t
;

249 
	#__fsfû˙t_t_deföed


	)

252 #i‚de‡
__blk˙t_t_deföed


253 
__blk˙t64_t
 
	tblk˙t_t
;

254 
	#__blk˙t_t_deföed


	)

256 #i‚de‡
__fsblk˙t_t_deföed


257 
__fsblk˙t64_t
 
	tfsblk˙t_t
;

258 
	#__fsblk˙t_t_deföed


	)

260 #i‚de‡
__fsfû˙t_t_deföed


261 
__fsfû˙t64_t
 
	tfsfû˙t_t
;

262 
	#__fsfû˙t_t_deföed


	)

266 #ifde‡
__USE_LARGEFILE64


267 
__blk˙t64_t
 
	tblk˙t64_t
;

268 
__fsblk˙t64_t
 
	tfsblk˙t64_t
;

269 
__fsfû˙t64_t
 
	tfsfû˙t64_t
;

274 #i‡
deföed
 
__USE_POSIX199506
 || deföed 
__USE_UNIX98


275 
	~<bôs/±hªadty≥s.h
>

278 
	g__END_DECLS


	@/usr/include/xlocale.h

20 #i‚de‡
_XLOCALE_H


21 
	#_XLOCALE_H
 1

	)

27 
	s__loˇÀ_°ru˘


30 
__loˇÀ_d©a
 *
	m__loˇÀs
[13];

33 c⁄° *
	m__˘y≥_b
;

34 c⁄° *
	m__˘y≥_tﬁowî
;

35 c⁄° *
	m__˘y≥_touµî
;

38 c⁄° *
	m__«mes
[13];

39 } *
	t__loˇÀ_t
;

42 
__loˇÀ_t
 
	tloˇÀ_t
;

	@/usr/include/asm-generic/errno.h

1 #i‚de‡
_ASM_GENERIC_ERRNO_H


2 
	#_ASM_GENERIC_ERRNO_H


	)

4 
	~<asm-gíîic/î∫o-ba£.h
>

6 
	#EDEADLK
 35

	)

7 
	#ENAMETOOLONG
 36

	)

8 
	#ENOLCK
 37

	)

17 
	#ENOSYS
 38

	)

19 
	#ENOTEMPTY
 39

	)

20 
	#ELOOP
 40

	)

21 
	#EWOULDBLOCK
 
EAGAIN


	)

22 
	#ENOMSG
 42

	)

23 
	#EIDRM
 43

	)

24 
	#ECHRNG
 44

	)

25 
	#EL2NSYNC
 45

	)

26 
	#EL3HLT
 46

	)

27 
	#EL3RST
 47

	)

28 
	#ELNRNG
 48

	)

29 
	#EUNATCH
 49

	)

30 
	#ENOCSI
 50

	)

31 
	#EL2HLT
 51

	)

32 
	#EBADE
 52

	)

33 
	#EBADR
 53

	)

34 
	#EXFULL
 54

	)

35 
	#ENOANO
 55

	)

36 
	#EBADRQC
 56

	)

37 
	#EBADSLT
 57

	)

39 
	#EDEADLOCK
 
EDEADLK


	)

41 
	#EBFONT
 59

	)

42 
	#ENOSTR
 60

	)

43 
	#ENODATA
 61

	)

44 
	#ETIME
 62

	)

45 
	#ENOSR
 63

	)

46 
	#ENONET
 64

	)

47 
	#ENOPKG
 65

	)

48 
	#EREMOTE
 66

	)

49 
	#ENOLINK
 67

	)

50 
	#EADV
 68

	)

51 
	#ESRMNT
 69

	)

52 
	#ECOMM
 70

	)

53 
	#EPROTO
 71

	)

54 
	#EMULTIHOP
 72

	)

55 
	#EDOTDOT
 73

	)

56 
	#EBADMSG
 74

	)

57 
	#EOVERFLOW
 75

	)

58 
	#ENOTUNIQ
 76

	)

59 
	#EBADFD
 77

	)

60 
	#EREMCHG
 78

	)

61 
	#ELIBACC
 79

	)

62 
	#ELIBBAD
 80

	)

63 
	#ELIBSCN
 81

	)

64 
	#ELIBMAX
 82

	)

65 
	#ELIBEXEC
 83

	)

66 
	#EILSEQ
 84

	)

67 
	#ERESTART
 85

	)

68 
	#ESTRPIPE
 86

	)

69 
	#EUSERS
 87

	)

70 
	#ENOTSOCK
 88

	)

71 
	#EDESTADDRREQ
 89

	)

72 
	#EMSGSIZE
 90

	)

73 
	#EPROTOTYPE
 91

	)

74 
	#ENOPROTOOPT
 92

	)

75 
	#EPROTONOSUPPORT
 93

	)

76 
	#ESOCKTNOSUPPORT
 94

	)

77 
	#EOPNOTSUPP
 95

	)

78 
	#EPFNOSUPPORT
 96

	)

79 
	#EAFNOSUPPORT
 97

	)

80 
	#EADDRINUSE
 98

	)

81 
	#EADDRNOTAVAIL
 99

	)

82 
	#ENETDOWN
 100

	)

83 
	#ENETUNREACH
 101

	)

84 
	#ENETRESET
 102

	)

85 
	#ECONNABORTED
 103

	)

86 
	#ECONNRESET
 104

	)

87 
	#ENOBUFS
 105

	)

88 
	#EISCONN
 106

	)

89 
	#ENOTCONN
 107

	)

90 
	#ESHUTDOWN
 108

	)

91 
	#ETOOMANYREFS
 109

	)

92 
	#ETIMEDOUT
 110

	)

93 
	#ECONNREFUSED
 111

	)

94 
	#EHOSTDOWN
 112

	)

95 
	#EHOSTUNREACH
 113

	)

96 
	#EALREADY
 114

	)

97 
	#EINPROGRESS
 115

	)

98 
	#ESTALE
 116

	)

99 
	#EUCLEAN
 117

	)

100 
	#ENOTNAM
 118

	)

101 
	#ENAVAIL
 119

	)

102 
	#EISNAM
 120

	)

103 
	#EREMOTEIO
 121

	)

104 
	#EDQUOT
 122

	)

106 
	#ENOMEDIUM
 123

	)

107 
	#EMEDIUMTYPE
 124

	)

108 
	#ECANCELED
 125

	)

109 
	#ENOKEY
 126

	)

110 
	#EKEYEXPIRED
 127

	)

111 
	#EKEYREVOKED
 128

	)

112 
	#EKEYREJECTED
 129

	)

115 
	#EOWNERDEAD
 130

	)

116 
	#ENOTRECOVERABLE
 131

	)

118 
	#ERFKILL
 132

	)

120 
	#EHWPOISON
 133

	)

	@/usr/include/asm-generic/types.h

1 #i‚de‡
_ASM_GENERIC_TYPES_H


2 
	#_ASM_GENERIC_TYPES_H


	)

6 
	~<asm-gíîic/öt-Œ64.h
>

	@/usr/include/asm/ioctl.h

1 
	~<asm-gíîic/io˘l.h
>

	@/usr/include/asm/posix_types.h

1 #ifde‡
__i386__


2 
	~<asm/posix_ty≥s_32.h
>

3 #ñi‡
deföed
(
__ILP32__
)

4 
	~<asm/posix_ty≥s_x32.h
>

6 
	~<asm/posix_ty≥s_64.h
>

	@/usr/include/bits/byteswap-16.h

19 #i‚de‡
_BITS_BYTESWAP_H


23 #ifde‡
__GNUC__


24 #i‡
__GNUC__
 >= 2

25 
	#__bsw≠_16
(
x
) \

26 (
__exãnsi⁄__
 \

27 ({ 
__v
, 
__x
 = (Ë(
x
); \

28 i‡(
	`__buûtö_c⁄°™t_p
 (
__x
)) \

29 
__v
 = 
	`__bsw≠_c⁄°™t_16
 (
__x
); \

31 
	`__asm__
 ("rorw $8, %w0" \

32 : "Ù" (
__v
) \

33 : "0" (
__x
) \

35 
__v
; }))

	)

38 
	#__bsw≠_16
(
x
) \

39 (
__exãnsi⁄__
 \

40 ({ 
__x
 = (Ë(
x
); \

41 
	`__bsw≠_c⁄°™t_16
 (
__x
); }))

	)

44 
__ölöe
 

45 
	$__bsw≠_16
 (
__bsx
)

47  
	`__bsw≠_c⁄°™t_16
 (
__bsx
);

48 
	}
}

	@/usr/include/bits/libm-simd-decl-stubs.h

19 #i‚de‡
_MATH_H


33 #i‚de‡
_BITS_LIBM_SIMD_DECL_STUBS_H


34 
	#_BITS_LIBM_SIMD_DECL_STUBS_H
 1

	)

36 
	#__DECL_SIMD_cos


	)

37 
	#__DECL_SIMD_cosf


	)

38 
	#__DECL_SIMD_co¶


	)

40 
	#__DECL_SIMD_sö


	)

41 
	#__DECL_SIMD_söf


	)

42 
	#__DECL_SIMD_söl


	)

44 
	#__DECL_SIMD_söcos


	)

45 
	#__DECL_SIMD_söcosf


	)

46 
	#__DECL_SIMD_söco¶


	)

48 
	#__DECL_SIMD_log


	)

49 
	#__DECL_SIMD_logf


	)

50 
	#__DECL_SIMD_logl


	)

52 
	#__DECL_SIMD_exp


	)

53 
	#__DECL_SIMD_expf


	)

54 
	#__DECL_SIMD_ex∂


	)

56 
	#__DECL_SIMD_pow


	)

57 
	#__DECL_SIMD_powf


	)

58 
	#__DECL_SIMD_powl


	)

	@/usr/include/bits/pthreadtypes.h

18 #i‚de‡
_BITS_PTHREADTYPES_H


19 
	#_BITS_PTHREADTYPES_H
 1

	)

21 
	~<bôs/w‹dsize.h
>

23 #ifde‡
__x86_64__


24 #i‡
__WORDSIZE
 == 64

25 
	#__SIZEOF_PTHREAD_ATTR_T
 56

	)

26 
	#__SIZEOF_PTHREAD_MUTEX_T
 40

	)

27 
	#__SIZEOF_PTHREAD_MUTEXATTR_T
 4

	)

28 
	#__SIZEOF_PTHREAD_COND_T
 48

	)

29 
	#__SIZEOF_PTHREAD_CONDATTR_T
 4

	)

30 
	#__SIZEOF_PTHREAD_RWLOCK_T
 56

	)

31 
	#__SIZEOF_PTHREAD_RWLOCKATTR_T
 8

	)

32 
	#__SIZEOF_PTHREAD_BARRIER_T
 32

	)

33 
	#__SIZEOF_PTHREAD_BARRIERATTR_T
 4

	)

35 
	#__SIZEOF_PTHREAD_ATTR_T
 32

	)

36 
	#__SIZEOF_PTHREAD_MUTEX_T
 32

	)

37 
	#__SIZEOF_PTHREAD_MUTEXATTR_T
 4

	)

38 
	#__SIZEOF_PTHREAD_COND_T
 48

	)

39 
	#__SIZEOF_PTHREAD_CONDATTR_T
 4

	)

40 
	#__SIZEOF_PTHREAD_RWLOCK_T
 44

	)

41 
	#__SIZEOF_PTHREAD_RWLOCKATTR_T
 8

	)

42 
	#__SIZEOF_PTHREAD_BARRIER_T
 20

	)

43 
	#__SIZEOF_PTHREAD_BARRIERATTR_T
 4

	)

46 
	#__SIZEOF_PTHREAD_ATTR_T
 36

	)

47 
	#__SIZEOF_PTHREAD_MUTEX_T
 24

	)

48 
	#__SIZEOF_PTHREAD_MUTEXATTR_T
 4

	)

49 
	#__SIZEOF_PTHREAD_COND_T
 48

	)

50 
	#__SIZEOF_PTHREAD_CONDATTR_T
 4

	)

51 
	#__SIZEOF_PTHREAD_RWLOCK_T
 32

	)

52 
	#__SIZEOF_PTHREAD_RWLOCKATTR_T
 8

	)

53 
	#__SIZEOF_PTHREAD_BARRIER_T
 20

	)

54 
	#__SIZEOF_PTHREAD_BARRIERATTR_T
 4

	)

60 
	t±hªad_t
;

63 
	u±hªad_©å_t


65 
	m__size
[
__SIZEOF_PTHREAD_ATTR_T
];

66 
	m__Æign
;

68 #i‚de‡
__have_±hªad_©å_t


69 
±hªad_©å_t
 
	t±hªad_©å_t
;

70 
	#__have_±hªad_©å_t
 1

	)

74 #ifde‡
__x86_64__


75 
	s__±hªad_öã∫Æ_li°


77 
__±hªad_öã∫Æ_li°
 *
	m__¥ev
;

78 
__±hªad_öã∫Æ_li°
 *
	m__√xt
;

79 } 
	t__±hªad_li°_t
;

81 
	s__±hªad_öã∫Æ_¶i°


83 
__±hªad_öã∫Æ_¶i°
 *
	m__√xt
;

84 } 
	t__±hªad_¶i°_t
;

92 
	s__±hªad_muãx_s


94 
	m__lock
;

95 
	m__cou¡
;

96 
	m__ow√r
;

97 #ifde‡
__x86_64__


98 
	m__nu£rs
;

102 
	m__köd
;

103 #ifde‡
__x86_64__


104 
	m__•ös
;

105 
	m__ñisi⁄
;

106 
__±hªad_li°_t
 
	m__li°
;

107 
	#__PTHREAD_MUTEX_HAVE_PREV
 1

	)

109 
	#__PTHREAD_SPINS
 0, 0

	)

111 
	m__nu£rs
;

112 
__exãnsi⁄__
 union

116 
	m__e•ös
;

117 
	m__ñisi⁄
;

118 
	#__•ös
 
__ñisi⁄_d©a
.
__e•ös


	)

119 
	#__ñisi⁄
 
__ñisi⁄_d©a
.
__ñisi⁄


	)

120 
	#__PTHREAD_SPINS
 { 0, 0 }

	)

121 } 
	m__ñisi⁄_d©a
;

122 
__±hªad_¶i°_t
 
	m__li°
;

125 } 
	m__d©a
;

126 
	m__size
[
__SIZEOF_PTHREAD_MUTEX_T
];

127 
	m__Æign
;

128 } 
	t±hªad_muãx_t
;

132 
	m__size
[
__SIZEOF_PTHREAD_MUTEXATTR_T
];

133 
	m__Æign
;

134 } 
	t±hªad_muãx©å_t
;

143 
__exãnsi⁄__
 union

145 
__exãnsi⁄__
 
	m__w£q
;

147 
	m__low
;

148 
	m__high
;

149 } 
	m__w£q32
;

151 
__exãnsi⁄__
 union

153 
__exãnsi⁄__
 
	m__g1_°¨t
;

155 
	m__low
;

156 
	m__high
;

157 } 
	m__g1_°¨t32
;

159 
	m__g_ªfs
[2];

160 
	m__g_size
[2];

161 
	m__g1_‹ig_size
;

162 
	m__wªfs
;

163 
	m__g_sig«ls
[2];

164 } 
	m__d©a
;

165 
	m__size
[
__SIZEOF_PTHREAD_COND_T
];

166 
__exãnsi⁄__
 
	m__Æign
;

167 } 
	t±hªad_c⁄d_t
;

171 
	m__size
[
__SIZEOF_PTHREAD_CONDATTR_T
];

172 
	m__Æign
;

173 } 
	t±hªad_c⁄d©å_t
;

177 
	t±hªad_key_t
;

181 
	t±hªad_⁄˚_t
;

184 #i‡
deföed
 
__USE_UNIX98
 || deföed 
__USE_XOPEN2K


189 #ifde‡
__x86_64__


192 
	m__ªadîs
;

193 
	m__wrôîs
;

194 
	m__wΩha£_fuãx
;

195 
	m__wrôîs_fuãx
;

196 
	m__∑d3
;

197 
	m__∑d4
;

198 
	m__cur_wrôî
;

199 
	m__sh¨ed
;

200 sig√d 
	m__rwñisi⁄
;

201 #ifde‡ 
__ILP32__


202 
	m__∑d1
[3];

203 
	#__PTHREAD_RWLOCK_ELISION_EXTRA
 0, { 0, 0, 0 }

	)

205 
	m__∑d1
[7];

206 
	#__PTHREAD_RWLOCK_ELISION_EXTRA
 0, { 0, 0, 0, 0, 0, 0, 0 }

	)

208 
	m__∑d2
;

211 
	m__Êags
;

212 
	#__PTHREAD_RWLOCK_INT_FLAGS_SHARED
 1

	)

213 } 
	m__d©a
;

217 
	m__ªadîs
;

218 
	m__wrôîs
;

219 
	m__wΩha£_fuãx
;

220 
	m__wrôîs_fuãx
;

221 
	m__∑d3
;

222 
	m__∑d4
;

225 
	m__Êags
;

226 
	m__sh¨ed
;

227 sig√d 
	m__rwñisi⁄
;

228 
	#__PTHREAD_RWLOCK_ELISION_EXTRA
 0

	)

229 
	m__∑d2
;

230 
	m__cur_wrôî
;

231 } 
	m__d©a
;

233 
	m__size
[
__SIZEOF_PTHREAD_RWLOCK_T
];

234 
	m__Æign
;

235 } 
	t±hªad_rwlock_t
;

239 
	m__size
[
__SIZEOF_PTHREAD_RWLOCKATTR_T
];

240 
	m__Æign
;

241 } 
	t±hªad_rwlock©å_t
;

245 #ifde‡
__USE_XOPEN2K


247 vﬁ©ûê
	t±hªad_•ölock_t
;

254 
	m__size
[
__SIZEOF_PTHREAD_BARRIER_T
];

255 
	m__Æign
;

256 } 
	t±hªad_b¨rõr_t
;

260 
	m__size
[
__SIZEOF_PTHREAD_BARRIERATTR_T
];

261 
	m__Æign
;

262 } 
	t±hªad_b¨rõøâr_t
;

266 #i‚de‡
__x86_64__


268 
	#__˛ónup_f˘_©åibuã
 
	`__©åibuã__
 ((
	`__ªg∑rm__
 (1)))

	)

	@/usr/include/bits/strings_fortified.h

19 #i‚de‡
__STRINGS_FORTIFIED


20 
	#__STRINGS_FORTIFIED
 1

	)

22 
__f‹tify_fun˘i⁄
 

23 
__NTH
 (
	$bc›y
 (c⁄° *
__§c
, *
__de°
, 
size_t
 
__Àn
))

25 (Ë
	`__buûtö___memmove_chk
 (
__de°
, 
__§c
, 
__Àn
, 
	`__bos0
 (__dest));

26 
	}
}

28 
__f‹tify_fun˘i⁄
 

29 
__NTH
 (
	$bzîo
 (*
__de°
, 
size_t
 
__Àn
))

31 (Ë
	`__buûtö___mem£t_chk
 (
__de°
, '\0', 
__Àn
, 
	`__bos0
 (__dest));

32 
	}
}

	@/usr/include/bits/types/clock_t.h

1 #i‚de‡
__˛ock_t_deföed


2 
	#__˛ock_t_deföed
 1

	)

4 
	~<bôs/ty≥s.h
>

6 
__BEGIN_NAMESPACE_STD


8 
__˛ock_t
 
	t˛ock_t
;

9 
	g__END_NAMESPACE_STD


11 #i‡
deföed
 
__USE_XOPEN
 || deföed 
__USE_POSIX


12 
	$__USING_NAMESPACE_STD
(
˛ock_t
)

	@/usr/include/bits/types/clockid_t.h

1 #i‚de‡
__˛ockid_t_deföed


2 
	#__˛ockid_t_deföed
 1

	)

4 
	~<bôs/ty≥s.h
>

7 
__˛ockid_t
 
	t˛ockid_t
;

	@/usr/include/bits/types/time_t.h

1 #i‚de‡
__time_t_deföed


2 
	#__time_t_deföed
 1

	)

4 
	~<bôs/ty≥s.h
>

6 
__BEGIN_NAMESPACE_STD


8 
__time_t
 
	ttime_t
;

9 
	g__END_NAMESPACE_STD


10 #ifde‡
__USE_POSIX


11 
	$__USING_NAMESPACE_STD
(
time_t
)

	@/usr/include/bits/types/timer_t.h

1 #i‚de‡
__timî_t_deföed


2 
	#__timî_t_deföed
 1

	)

4 
	~<bôs/ty≥s.h
>

7 
__timî_t
 
	ttimî_t
;

	@/usr/include/bits/typesizes.h

19 #i‚de‡
_BITS_TYPES_H


23 #i‚def 
_BITS_TYPESIZES_H


24 
	#_BITS_TYPESIZES_H
 1

	)

30 #i‡
deföed
 
__x86_64__
 && deföed 
__ILP32__


31 
	#__SYSCALL_SLONG_TYPE
 
__SQUAD_TYPE


	)

32 
	#__SYSCALL_ULONG_TYPE
 
__UQUAD_TYPE


	)

34 
	#__SYSCALL_SLONG_TYPE
 
__SLONGWORD_TYPE


	)

35 
	#__SYSCALL_ULONG_TYPE
 
__ULONGWORD_TYPE


	)

38 
	#__DEV_T_TYPE
 
__UQUAD_TYPE


	)

39 
	#__UID_T_TYPE
 
__U32_TYPE


	)

40 
	#__GID_T_TYPE
 
__U32_TYPE


	)

41 
	#__INO_T_TYPE
 
__SYSCALL_ULONG_TYPE


	)

42 
	#__INO64_T_TYPE
 
__UQUAD_TYPE


	)

43 
	#__MODE_T_TYPE
 
__U32_TYPE


	)

44 #ifde‡
__x86_64__


45 
	#__NLINK_T_TYPE
 
__SYSCALL_ULONG_TYPE


	)

46 
	#__FSWORD_T_TYPE
 
__SYSCALL_SLONG_TYPE


	)

48 
	#__NLINK_T_TYPE
 
__UWORD_TYPE


	)

49 
	#__FSWORD_T_TYPE
 
__SWORD_TYPE


	)

51 
	#__OFF_T_TYPE
 
__SYSCALL_SLONG_TYPE


	)

52 
	#__OFF64_T_TYPE
 
__SQUAD_TYPE


	)

53 
	#__PID_T_TYPE
 
__S32_TYPE


	)

54 
	#__RLIM_T_TYPE
 
__SYSCALL_ULONG_TYPE


	)

55 
	#__RLIM64_T_TYPE
 
__UQUAD_TYPE


	)

56 
	#__BLKCNT_T_TYPE
 
__SYSCALL_SLONG_TYPE


	)

57 
	#__BLKCNT64_T_TYPE
 
__SQUAD_TYPE


	)

58 
	#__FSBLKCNT_T_TYPE
 
__SYSCALL_ULONG_TYPE


	)

59 
	#__FSBLKCNT64_T_TYPE
 
__UQUAD_TYPE


	)

60 
	#__FSFILCNT_T_TYPE
 
__SYSCALL_ULONG_TYPE


	)

61 
	#__FSFILCNT64_T_TYPE
 
__UQUAD_TYPE


	)

62 
	#__ID_T_TYPE
 
__U32_TYPE


	)

63 
	#__CLOCK_T_TYPE
 
__SYSCALL_SLONG_TYPE


	)

64 
	#__TIME_T_TYPE
 
__SYSCALL_SLONG_TYPE


	)

65 
	#__USECONDS_T_TYPE
 
__U32_TYPE


	)

66 
	#__SUSECONDS_T_TYPE
 
__SYSCALL_SLONG_TYPE


	)

67 
	#__DADDR_T_TYPE
 
__S32_TYPE


	)

68 
	#__KEY_T_TYPE
 
__S32_TYPE


	)

69 
	#__CLOCKID_T_TYPE
 
__S32_TYPE


	)

70 
	#__TIMER_T_TYPE
 *

	)

71 
	#__BLKSIZE_T_TYPE
 
__SYSCALL_SLONG_TYPE


	)

72 
	#__FSID_T_TYPE
 såu˘ { 
__vÆ
[2]; }

	)

73 
	#__SSIZE_T_TYPE
 
__SWORD_TYPE


	)

74 
	#__CPU_MASK_TYPE
 
__SYSCALL_ULONG_TYPE


	)

76 #ifde‡
__x86_64__


80 
	#__OFF_T_MATCHES_OFF64_T
 1

	)

83 
	#__INO_T_MATCHES_INO64_T
 1

	)

86 
	#__RLIM_T_MATCHES_RLIM64_T
 1

	)

88 
	#__RLIM_T_MATCHES_RLIM64_T
 0

	)

92 
	#__FD_SETSIZE
 1024

	)

	@/usr/include/gnu/stubs.h

6 #i‡!
deföed
 
__x86_64__


7 
	~<gnu/°ubs-32.h
>

9 #i‡
deföed
 
__x86_64__
 && deföed 
__LP64__


10 
	~<gnu/°ubs-64.h
>

12 #i‡
deföed
 
__x86_64__
 && deföed 
__ILP32__


13 
	~<gnu/°ubs-x32.h
>

	@/usr/include/linux/swab.h

1 #i‚de‡
_LINUX_SWAB_H


2 
	#_LINUX_SWAB_H


	)

4 
	~<löux/ty≥s.h
>

6 
	~<asm/swab.h
>

12 
	#___c⁄°™t_swab16
(
x
Ë((
__u16
)( \

13 (((
__u16
)(
x
) & (__u16)0x00ffU) << 8) | \

14 (((
__u16
)(
x
Ë& (__u16)0xff00UË>> 8)))

	)

16 
	#___c⁄°™t_swab32
(
x
Ë((
__u32
)( \

17 (((
__u32
)(
x
) & (__u32)0x000000ffUL) << 24) | \

18 (((
__u32
)(
x
) & (__u32)0x0000ff00UL) << 8) | \

19 (((
__u32
)(
x
) & (__u32)0x00ff0000UL) >> 8) | \

20 (((
__u32
)(
x
Ë& (__u32)0xff000000ULË>> 24)))

	)

22 
	#___c⁄°™t_swab64
(
x
Ë((
__u64
)( \

23 (((
__u64
)(
x
) & (__u64)0x00000000000000ffULL) << 56) | \

24 (((
__u64
)(
x
) & (__u64)0x000000000000ff00ULL) << 40) | \

25 (((
__u64
)(
x
) & (__u64)0x0000000000ff0000ULL) << 24) | \

26 (((
__u64
)(
x
) & (__u64)0x00000000ff000000ULL) << 8) | \

27 (((
__u64
)(
x
) & (__u64)0x000000ff00000000ULL) >> 8) | \

28 (((
__u64
)(
x
) & (__u64)0x0000ff0000000000ULL) >> 24) | \

29 (((
__u64
)(
x
) & (__u64)0x00ff000000000000ULL) >> 40) | \

30 (((
__u64
)(
x
Ë& (__u64)0xff00000000000000ULLË>> 56)))

	)

32 
	#___c⁄°™t_swahw32
(
x
Ë((
__u32
)( \

33 (((
__u32
)(
x
) & (__u32)0x0000ffffUL) << 16) | \

34 (((
__u32
)(
x
Ë& (__u32)0xffff0000ULË>> 16)))

	)

36 
	#___c⁄°™t_swahb32
(
x
Ë((
__u32
)( \

37 (((
__u32
)(
x
) & (__u32)0x00ff00ffUL) << 8) | \

38 (((
__u32
)(
x
Ë& (__u32)0xff00ff00ULË>> 8)))

	)

46 
__ölöe__
 
__u16
 
	$__fswab16
(
__u16
 
vÆ
)

48 #i‡
	`deföed
 (
__¨ch_swab16
)

49  
	`__¨ch_swab16
(
vÆ
);

51  
	`___c⁄°™t_swab16
(
vÆ
);

53 
	}
}

55 
__ölöe__
 
__u32
 
	$__fswab32
(
__u32
 
vÆ
)

57 #i‡
	`deföed
(
__¨ch_swab32
)

58  
	`__¨ch_swab32
(
vÆ
);

60  
	`___c⁄°™t_swab32
(
vÆ
);

62 
	}
}

64 
__ölöe__
 
__u64
 
	$__fswab64
(
__u64
 
vÆ
)

66 #i‡
	`deföed
 (
__¨ch_swab64
)

67  
	`__¨ch_swab64
(
vÆ
);

68 #ñi‡
	`deföed
(
__SWAB_64_THRU_32__
)

69 
__u32
 
h
 = 
vÆ
 >> 32;

70 
__u32
 
l
 = 
vÆ
 & ((1ULL << 32) - 1);

71  (((
__u64
)
	`__fswab32
(
l
)Ë<< 32Ë| ((__u64)(__fswab32(
h
)));

73  
	`___c⁄°™t_swab64
(
vÆ
);

75 
	}
}

77 
__ölöe__
 
__u32
 
	$__fswahw32
(
__u32
 
vÆ
)

79 #ifde‡
__¨ch_swahw32


80  
	`__¨ch_swahw32
(
vÆ
);

82  
	`___c⁄°™t_swahw32
(
vÆ
);

84 
	}
}

86 
__ölöe__
 
__u32
 
	$__fswahb32
(
__u32
 
vÆ
)

88 #ifde‡
__¨ch_swahb32


89  
	`__¨ch_swahb32
(
vÆ
);

91  
	`___c⁄°™t_swahb32
(
vÆ
);

93 
	}
}

99 #ifde‡
__HAVE_BUILTIN_BSWAP16__


100 
	#__swab16
(
x
Ë(
__u16
)
	`__buûtö_bsw≠16
((__u16)(x))

	)

102 
	#__swab16
(
x
) \

103 (
	`__buûtö_c⁄°™t_p
((
__u16
)(
x
)) ? \

104 
	`___c⁄°™t_swab16
(
x
) : \

105 
	`__fswab16
(
x
))

	)

112 #ifde‡
__HAVE_BUILTIN_BSWAP32__


113 
	#__swab32
(
x
Ë(
__u32
)
	`__buûtö_bsw≠32
((__u32)(x))

	)

115 
	#__swab32
(
x
) \

116 (
	`__buûtö_c⁄°™t_p
((
__u32
)(
x
)) ? \

117 
	`___c⁄°™t_swab32
(
x
) : \

118 
	`__fswab32
(
x
))

	)

125 #ifde‡
__HAVE_BUILTIN_BSWAP64__


126 
	#__swab64
(
x
Ë(
__u64
)
	`__buûtö_bsw≠64
((__u64)(x))

	)

128 
	#__swab64
(
x
) \

129 (
	`__buûtö_c⁄°™t_p
((
__u64
)(
x
)) ? \

130 
	`___c⁄°™t_swab64
(
x
) : \

131 
	`__fswab64
(
x
))

	)

140 
	#__swahw32
(
x
) \

141 (
	`__buûtö_c⁄°™t_p
((
__u32
)(
x
)) ? \

142 
	`___c⁄°™t_swahw32
(
x
) : \

143 
	`__fswahw32
(
x
))

	)

151 
	#__swahb32
(
x
) \

152 (
	`__buûtö_c⁄°™t_p
((
__u32
)(
x
)) ? \

153 
	`___c⁄°™t_swahb32
(
x
) : \

154 
	`__fswahb32
(
x
))

	)

160 
__Æways_ölöe
 
__u16
 
	$__swab16p
(c⁄° 
__u16
 *
p
)

162 #ifde‡
__¨ch_swab16p


163  
	`__¨ch_swab16p
(
p
);

165  
	`__swab16
(*
p
);

167 
	}
}

173 
__Æways_ölöe
 
__u32
 
	$__swab32p
(c⁄° 
__u32
 *
p
)

175 #ifde‡
__¨ch_swab32p


176  
	`__¨ch_swab32p
(
p
);

178  
	`__swab32
(*
p
);

180 
	}
}

186 
__Æways_ölöe
 
__u64
 
	$__swab64p
(c⁄° 
__u64
 *
p
)

188 #ifde‡
__¨ch_swab64p


189  
	`__¨ch_swab64p
(
p
);

191  
	`__swab64
(*
p
);

193 
	}
}

201 
__ölöe__
 
__u32
 
	$__swahw32p
(c⁄° 
__u32
 *
p
)

203 #ifde‡
__¨ch_swahw32p


204  
	`__¨ch_swahw32p
(
p
);

206  
	`__swahw32
(*
p
);

208 
	}
}

216 
__ölöe__
 
__u32
 
	$__swahb32p
(c⁄° 
__u32
 *
p
)

218 #ifde‡
__¨ch_swahb32p


219  
	`__¨ch_swahb32p
(
p
);

221  
	`__swahb32
(*
p
);

223 
	}
}

229 
__ölöe__
 
	$__swab16s
(
__u16
 *
p
)

231 #ifde‡
__¨ch_swab16s


232 
	`__¨ch_swab16s
(
p
);

234 *
p
 = 
	`__swab16p
(p);

236 
	}
}

241 
__Æways_ölöe
 
	$__swab32s
(
__u32
 *
p
)

243 #ifde‡
__¨ch_swab32s


244 
	`__¨ch_swab32s
(
p
);

246 *
p
 = 
	`__swab32p
(p);

248 
	}
}

254 
__Æways_ölöe
 
	$__swab64s
(
__u64
 *
p
)

256 #ifde‡
__¨ch_swab64s


257 
	`__¨ch_swab64s
(
p
);

259 *
p
 = 
	`__swab64p
(p);

261 
	}
}

269 
__ölöe__
 
	$__swahw32s
(
__u32
 *
p
)

271 #ifde‡
__¨ch_swahw32s


272 
	`__¨ch_swahw32s
(
p
);

274 *
p
 = 
	`__swahw32p
(p);

276 
	}
}

284 
__ölöe__
 
	$__swahb32s
(
__u32
 *
p
)

286 #ifde‡
__¨ch_swahb32s


287 
	`__¨ch_swahb32s
(
p
);

289 *
p
 = 
	`__swahb32p
(p);

291 
	}
}

	@/usr/include/stdc-predef.h

18 #i‚def 
_STDC_PREDEF_H


19 
	#_STDC_PREDEF_H
 1

	)

36 #ifde‡
__GCC_IEC_559


37 #i‡
__GCC_IEC_559
 > 0

38 
	#__STDC_IEC_559__
 1

	)

41 
	#__STDC_IEC_559__
 1

	)

44 #ifde‡
__GCC_IEC_559_COMPLEX


45 #i‡
__GCC_IEC_559_COMPLEX
 > 0

46 
	#__STDC_IEC_559_COMPLEX__
 1

	)

49 
	#__STDC_IEC_559_COMPLEX__
 1

	)

57 
	#__STDC_ISO_10646__
 201605L

	)

60 
	#__STDC_NO_THREADS__
 1

	)

	@/usr/include/sys/cdefs.h

18 #i‚def 
_SYS_CDEFS_H


19 
	#_SYS_CDEFS_H
 1

	)

22 #i‚de‡
_FEATURES_H


23 
	~<„©uªs.h
>

29 #i‡
deföed
 
__GNUC__
 && !deföed 
__STDC__


34 #unde‡
__P


35 #unde‡
__PMT


37 #ifde‡
__GNUC__


41 #i‡
__GNUC_PREREQ
 (4, 6Ë&& !
deföed
 
_LIBC


42 
	#__LEAF
 , 
__Àaf__


	)

43 
	#__LEAF_ATTR
 
	`__©åibuã__
 ((
__Àaf__
))

	)

45 
	#__LEAF


	)

46 
	#__LEAF_ATTR


	)

54 #i‡!
deföed
 
__˝lu•lus
 && 
__GNUC_PREREQ
 (3, 3)

55 
	#__THROW
 
	`__©åibuã__
 ((
__nŸhrow__
 
__LEAF
))

	)

56 
	#__THROWNL
 
	`__©åibuã__
 ((
__nŸhrow__
))

	)

57 
	#__NTH
(
f˘
Ë
	`__©åibuã__
 ((
__nŸhrow__
 
__LEAF
)Ë
	)
fct

59 #i‡
deföed
 
__˝lu•lus
 && 
__GNUC_PREREQ
 (2,8)

60 
	#__THROW
 
	`throw
 ()

	)

61 
	#__THROWNL
 
	`throw
 ()

	)

62 
	#__NTH
(
f˘
Ë
__LEAF_ATTR
 f˘ 
	`throw
 ()

	)

64 
	#__THROW


	)

65 
	#__THROWNL


	)

66 
	#__NTH
(
f˘
Ë
	)
fct

72 
	#__ölöe


	)

74 
	#__THROW


	)

75 
	#__THROWNL


	)

76 
	#__NTH
(
f˘
Ë
	)
fct

83 #i‡
deföed
 
__˛™g__
 && deföed 
__has_exãnsi⁄


84 
	#__glibc_˛™g_has_exãnsi⁄
(
ext
Ë
	`__has_exãnsi⁄
 (ext)

	)

86 
	#__glibc_˛™g_has_exãnsi⁄
(
ext
Ë0

	)

91 
	#__P
(
¨gs
Ë
	)
args

92 
	#__PMT
(
¨gs
Ë
	)
args

97 
	#__CONCAT
(
x
,
y
Ëx ## 
	)
y

98 
	#__STRING
(
x
Ë#x

	)

101 
	#__±r_t
 *

	)

102 
	#__l⁄g_doubÀ_t
 

	)

106 #ifdef 
__˝lu•lus


107 
	#__BEGIN_DECLS
 "C" {

	)

108 
	#__END_DECLS
 }

	)

110 
	#__BEGIN_DECLS


	)

111 
	#__END_DECLS


	)

120 #i‡
deföed
 
__˝lu•lus
 && deföed 
_GLIBCPP_USE_NAMESPACES


121 
	#__BEGIN_NAMESPACE_STD
 
«me•a˚
 
°d
 {

	)

122 
	#__END_NAMESPACE_STD
 }

	)

123 
	#__USING_NAMESPACE_STD
(
«me
Ë
usög
 
°d
::«me;

	)

124 
	#__BEGIN_NAMESPACE_C99
 
«me•a˚
 
__c99
 {

	)

125 
	#__END_NAMESPACE_C99
 }

	)

126 
	#__USING_NAMESPACE_C99
(
«me
Ë
usög
 
__c99
::«me;

	)

131 
	#__BEGIN_NAMESPACE_STD


	)

132 
	#__END_NAMESPACE_STD


	)

133 
	#__USING_NAMESPACE_STD
(
«me
)

	)

134 
	#__BEGIN_NAMESPACE_C99


	)

135 
	#__END_NAMESPACE_C99


	)

136 
	#__USING_NAMESPACE_C99
(
«me
)

	)

141 
	#__bos
(
±r
Ë
	`__buûtö_obje˘_size
 (±r, 
__USE_FORTIFY_LEVEL
 > 1)

	)

142 
	#__bos0
(
±r
Ë
	`__buûtö_obje˘_size
 (±r, 0)

	)

144 #i‡
__GNUC_PREREQ
 (4,3)

145 
	#__w¨nde˛
(
«me
, 
msg
) \

146 
	`«me
 (Ë
	`__©åibuã__
((
	`__w¨nög__
 (
msg
)))

	)

147 
	#__w¨«âr
(
msg
Ë
	`__©åibuã__
((
	`__w¨nög__
 (msg)))

	)

148 
	#__îr‹de˛
(
«me
, 
msg
) \

149 
	`«me
 (Ë
	`__©åibuã__
((
	`__îr‹__
 (
msg
)))

	)

151 
	#__w¨nde˛
(
«me
, 
msg
Ë
	`«me
 ()

	)

152 
	#__w¨«âr
(
msg
)

	)

153 
	#__îr‹de˛
(
«me
, 
msg
Ë
	`«me
 ()

	)

160 #i‡
deföed
 
__STDC_VERSION__
 && __STDC_VERSION__ >= 199901L

161 
	#__Êex¨r
 []

	)

162 
	#__glibc_c99_Êex¨r_avaûabÀ
 1

	)

163 #ñi‡
__GNUC_PREREQ
 (2,97)

166 
	#__Êex¨r
 []

	)

167 
	#__glibc_c99_Êex¨r_avaûabÀ
 1

	)

168 #ñi‡
deföed
 
__GNUC__


171 
	#__Êex¨r
 [0]

	)

172 
	#__glibc_c99_Êex¨r_avaûabÀ
 1

	)

175 
	#__Êex¨r
 [1]

	)

176 
	#__glibc_c99_Êex¨r_avaûabÀ
 0

	)

190 #i‡
deföed
 
__GNUC__
 && __GNUC__ >= 2

192 
	#__REDIRECT
(
«me
, 
¥Ÿo
, 
Æüs
Ë«mê¥Ÿÿ
	`__asm__
 (
	`__ASMNAME
 (#Æüs))

	)

193 #ifde‡
__˝lu•lus


194 
	#__REDIRECT_NTH
(
«me
, 
¥Ÿo
, 
Æüs
) \

195 
«me
 
¥Ÿo
 
__THROW
 
	`__asm__
 (
	`__ASMNAME
 (#Æüs))

	)

196 
	#__REDIRECT_NTHNL
(
«me
, 
¥Ÿo
, 
Æüs
) \

197 
«me
 
¥Ÿo
 
__THROWNL
 
	`__asm__
 (
	`__ASMNAME
 (#Æüs))

	)

199 
	#__REDIRECT_NTH
(
«me
, 
¥Ÿo
, 
Æüs
) \

200 
«me
 
¥Ÿo
 
	`__asm__
 (
	`__ASMNAME
 (#Æüs)Ë
__THROW


	)

201 
	#__REDIRECT_NTHNL
(
«me
, 
¥Ÿo
, 
Æüs
) \

202 
«me
 
¥Ÿo
 
	`__asm__
 (
	`__ASMNAME
 (#Æüs)Ë
__THROWNL


	)

204 
	#__ASMNAME
(
˙ame
Ë
	`__ASMNAME2
 (
__USER_LABEL_PREFIX__
, c«me)

	)

205 
	#__ASMNAME2
(
¥efix
, 
˙ame
Ë
	`__STRING
 (¥efixË
	)
cname

218 #i‡!
deföed
 
__GNUC__
 || __GNUC__ < 2

219 
	#__©åibuã__
(
xyz
Ë

	)

225 #i‡
__GNUC_PREREQ
 (2,96)

226 
	#__©åibuã_mÆloc__
 
	`__©åibuã__
 ((
__mÆloc__
))

	)

228 
	#__©åibuã_mÆloc__


	)

233 #i‡
__GNUC_PREREQ
 (4, 3)

234 
	#__©åibuã_Æloc_size__
(
∑øms
) \

235 
	`__©åibuã__
 ((
__Æloc_size__
 
∑øms
))

	)

237 
	#__©åibuã_Æloc_size__
(
∑øms
Ë

	)

243 #i‡
__GNUC_PREREQ
 (2,96)

244 
	#__©åibuã_puª__
 
	`__©åibuã__
 ((
__puª__
))

	)

246 
	#__©åibuã_puª__


	)

250 #i‡
__GNUC_PREREQ
 (2,5)

251 
	#__©åibuã_c⁄°__
 
	`__©åibuã__
 ((
__c⁄°__
))

	)

253 
	#__©åibuã_c⁄°__


	)

259 #i‡
__GNUC_PREREQ
 (3,1)

260 
	#__©åibuã_u£d__
 
	`__©åibuã__
 ((
__u£d__
))

	)

261 
	#__©åibuã_noölöe__
 
	`__©åibuã__
 ((
__noölöe__
))

	)

263 
	#__©åibuã_u£d__
 
	`__©åibuã__
 ((
__unu£d__
))

	)

264 
	#__©åibuã_noölöe__


	)

268 #i‡
__GNUC_PREREQ
 (3,2)

269 
	#__©åibuã_dïªˇãd__
 
	`__©åibuã__
 ((
__dïªˇãd__
))

	)

271 
	#__©åibuã_dïªˇãd__


	)

277 #i‡
__GNUC_PREREQ
 (4,5) || \

278 
	$__glibc_˛™g_has_exãnsi⁄
 (
__©åibuã_dïªˇãd_wôh_mesßge__
)

279 
	#__©åibuã_dïªˇãd_msg__
(
msg
) \

280 
	`__©åibuã__
 ((
	`__dïªˇãd__
 (
msg
)))

	)

282 
	#__©åibuã_dïªˇãd_msg__
(
msg
Ë
__©åibuã_dïªˇãd__


	)

291 #i‡
	`__GNUC_PREREQ
 (2,8)

292 
	#__©åibuã_f‹m©_¨g__
(
x
Ë
	`__©åibuã__
 ((
	`__f‹m©_¨g__
 (x)))

	)

294 
	#__©åibuã_f‹m©_¨g__
(
x
Ë

	)

301 #i‡
	`__GNUC_PREREQ
 (2,97)

302 
	#__©åibuã_f‹m©_°rfm⁄__
(
a
,
b
) \

303 
	`__©åibuã__
 ((
	`__f‹m©__
 (
__°rfm⁄__
, 
a
, 
b
)))

	)

305 
	#__©åibuã_f‹m©_°rfm⁄__
(
a
,
b
Ë

	)

310 #i‡
	`__GNUC_PREREQ
 (3,3)

311 
	#__n⁄nuŒ
(
∑øms
Ë
	`__©åibuã__
 ((
__n⁄nuŒ__
Ö¨ams))

	)

313 
	#__n⁄nuŒ
(
∑øms
)

	)

318 #i‡
	`__GNUC_PREREQ
 (3,4)

319 
	#__©åibuã_w¨n_unu£d_ªsu…__
 \

320 
	`__©åibuã__
 ((
__w¨n_unu£d_ªsu…__
))

	)

321 #i‡
__USE_FORTIFY_LEVEL
 > 0

322 
	#__wur
 
__©åibuã_w¨n_unu£d_ªsu…__


	)

325 
	#__©åibuã_w¨n_unu£d_ªsu…__


	)

327 #i‚de‡
__wur


328 
	#__wur


	)

332 #i‡
	`__GNUC_PREREQ
 (3,2)

336 #unde‡
__Æways_ölöe


337 
	#__Æways_ölöe
 
__ölöe
 
	`__©åibuã__
 ((
__Æways_ölöe__
))

	)

339 #unde‡
__Æways_ölöe


340 
	#__Æways_ölöe
 
__ölöe


	)

345 #i‡
	`__GNUC_PREREQ
 (4,3)

346 
	#__©åibuã_¨tificül__
 
	`__©åibuã__
 ((
__¨tificül__
))

	)

348 
	#__©åibuã_¨tificül__


	)

360 #i‡(!
deföed
 
__˝lu•lus
 || 
	`__GNUC_PREREQ
 (4,3) \

361 || (
deföed
 
__˛™g__
 && (deföed 
__GNUC_STDC_INLINE__
 \

362 || 
deföed
 
__GNUC_GNU_INLINE__
)))

363 #i‡
deföed
 
__GNUC_STDC_INLINE__
 || deföed 
__˝lu•lus


364 
	#__exã∫_ölöe
 
__ölöe
 
	`__©åibuã__
 ((
__gnu_ölöe__
))

	)

365 
	#__exã∫_Æways_ölöe
 \

366 
__Æways_ölöe
 
	`__©åibuã__
 ((
__gnu_ölöe__
))

	)

368 
	#__exã∫_ölöe
 
__ölöe


	)

369 
	#__exã∫_Æways_ölöe
 
__Æways_ölöe


	)

373 #ifde‡
__exã∫_Æways_ölöe


374 
	#__f‹tify_fun˘i⁄
 
__exã∫_Æways_ölöe
 
__©åibuã_¨tificül__


	)

379 #i‡
	`__GNUC_PREREQ
 (4,3)

380 
	#__va_¨g_∑ck
(Ë
	`__buûtö_va_¨g_∑ck
 ()

	)

381 
	#__va_¨g_∑ck_Àn
(Ë
	`__buûtö_va_¨g_∑ck_Àn
 ()

	)

388 #i‡!
	`__GNUC_PREREQ
 (2,8)

389 
	#__exãnsi⁄__


	)

393 #i‡!
	`__GNUC_PREREQ
 (2,92)

394 
	#__ª°ri˘


	)

400 #i‡
	`__GNUC_PREREQ
 (3,1Ë&& !
deföed
 
__GNUG__


401 
	#__ª°ri˘_¨r
 
__ª°ri˘


	)

403 #ifde‡
__GNUC__


404 
	#__ª°ri˘_¨r


	)

406 #i‡
deföed
 
__STDC_VERSION__
 && __STDC_VERSION__ >= 199901L

407 
	#__ª°ri˘_¨r
 
ª°ri˘


	)

410 
	#__ª°ri˘_¨r


	)

415 #i‡
__GNUC__
 >= 3

416 
	#__glibc_u∆ikñy
(
c⁄d
Ë
	`__buûtö_ex≥˘
 ((c⁄d), 0)

	)

417 
	#__glibc_likñy
(
c⁄d
Ë
	`__buûtö_ex≥˘
 ((c⁄d), 1)

	)

419 
	#__glibc_u∆ikñy
(
c⁄d
Ë(c⁄d)

	)

420 
	#__glibc_likñy
(
c⁄d
Ë(c⁄d)

	)

423 #i‡(!
deföed
 
_N‹ëu∫
 \

424 && (
deföed
 
__STDC_VERSION__
 ? __STDC_VERSION__ : 0) < 201112 \

425 && !
	$__GNUC_PREREQ
 (4,7))

426 #i‡
	`__GNUC_PREREQ
 (2,8)

427 
	#_N‹ëu∫
 
	`__©åibuã__
 ((
__n‹ëu∫__
))

	)

429 
	#_N‹ëu∫


	)

433 #i‡(!
deföed
 
_Sètic_as£π
 && !deföed 
__˝lu•lus
 \

434 && (
deföed
 
__STDC_VERSION__
 ? __STDC_VERSION__ : 0) < 201112 \

435 && (!
	`__GNUC_PREREQ
 (4, 6Ë|| 
deföed
 
__STRICT_ANSI__
))

436 
	#_Sètic_as£π
(
ex¥
, 
dügno°ic
) \

437 (*
	`__Sètic_as£π_fun˘i⁄
 ()) \

438 [!! (°ru˘ { 
__îr‹_if_√g©ive
: (
ex¥
Ë? 2 : -1; })]

	)

441 
	~<bôs/w‹dsize.h
>

442 
	~<bôs/l⁄g-doubÀ.h
>

444 #i‡
deföed
 
__LONG_DOUBLE_MATH_OPTIONAL
 && deföed 
__NO_LONG_DOUBLE_MATH


445 
	#__LDBL_COMPAT
 1

	)

446 #ifde‡
__REDIRECT


447 
	#__LDBL_REDIR1
(
«me
, 
¥Ÿo
, 
Æüs
Ë
	`__REDIRECT
 («me,ÖrŸo,álüs)

	)

448 
	#__LDBL_REDIR
(
«me
, 
¥Ÿo
) \

449 
	`__LDBL_REDIR1
 (
«me
, 
¥Ÿo
, 
__∆dbl_
##«me)

	)

450 
	#__LDBL_REDIR1_NTH
(
«me
, 
¥Ÿo
, 
Æüs
Ë
	`__REDIRECT_NTH
 («me,ÖrŸo,álüs)

	)

451 
	#__LDBL_REDIR_NTH
(
«me
, 
¥Ÿo
) \

452 
	`__LDBL_REDIR1_NTH
 (
«me
, 
¥Ÿo
, 
__∆dbl_
##«me)

	)

453 
	#__LDBL_REDIR1_DECL
(
«me
, 
Æüs
) \

454 
	`__ty≥of
 (
«me
Ë«mê
	`__asm
 (
	`__ASMNAME
 (#Æüs));

	)

455 
	#__LDBL_REDIR_DECL
(
«me
) \

456 
	`__ty≥of
 (
«me
Ë«mê
	`__asm
 (
	`__ASMNAME
 ("__∆dbl_" #«me));

	)

457 
	#__REDIRECT_LDBL
(
«me
, 
¥Ÿo
, 
Æüs
) \

458 
	`__LDBL_REDIR1
 (
«me
, 
¥Ÿo
, 
__∆dbl_
##
Æüs
)

	)

459 
	#__REDIRECT_NTH_LDBL
(
«me
, 
¥Ÿo
, 
Æüs
) \

460 
	`__LDBL_REDIR1_NTH
 (
«me
, 
¥Ÿo
, 
__∆dbl_
##
Æüs
)

	)

463 #i‡!
deföed
 
__LDBL_COMPAT
 || !deföed 
__REDIRECT


464 
	#__LDBL_REDIR1
(
«me
, 
¥Ÿo
, 
Æüs
Ë«mê
	)
proto

465 
	#__LDBL_REDIR
(
«me
, 
¥Ÿo
Ë«mê
	)
proto

466 
	#__LDBL_REDIR1_NTH
(
«me
, 
¥Ÿo
, 
Æüs
Ë«mê¥Ÿÿ
__THROW


	)

467 
	#__LDBL_REDIR_NTH
(
«me
, 
¥Ÿo
Ë«mê¥Ÿÿ
__THROW


	)

468 
	#__LDBL_REDIR_DECL
(
«me
)

	)

469 #ifde‡
__REDIRECT


470 
	#__REDIRECT_LDBL
(
«me
, 
¥Ÿo
, 
Æüs
Ë
	`__REDIRECT
 («me,ÖrŸo,álüs)

	)

471 
	#__REDIRECT_NTH_LDBL
(
«me
, 
¥Ÿo
, 
Æüs
) \

472 
	`__REDIRECT_NTH
 (
«me
, 
¥Ÿo
, 
Æüs
)

	)

481 #i‡
	`__GNUC_PREREQ
 (4,8Ë|| 
	`__glibc_˛™g_¥îeq
 (3,5)

482 
	#__glibc_ma¸o_w¨nög1
(
mesßge
Ë
	`_Pøgma
 (#mesßge)

	)

483 
	#__glibc_ma¸o_w¨nög
(
mesßge
) \

484 
	`__glibc_ma¸o_w¨nög1
 (
GCC
 
w¨nög
 
mesßge
)

	)

486 
	#__glibc_ma¸o_w¨nög
(
msg
)

	)

	@/usr/include/sys/select.h

21 #i‚de‡
_SYS_SELECT_H


22 
	#_SYS_SELECT_H
 1

	)

24 
	~<„©uªs.h
>

27 
	~<bôs/ty≥s.h
>

30 
	~<bôs/£À˘.h
>

33 
	~<bôs/sig£t.h
>

35 #i‚de‡
__sig£t_t_deföed


36 
	#__sig£t_t_deföed


	)

37 
__sig£t_t
 
	tsig£t_t
;

41 
	~<bôs/ty≥s/time_t.h
>

42 
	~<bôs/ty≥s/°ru˘_timevÆ.h
>

43 #ifde‡
__USE_XOPEN2K


44 
	~<bôs/ty≥s/°ru˘_time•ec.h
>

47 #i‚de‡
__su£c⁄ds_t_deföed


48 
__su£c⁄ds_t
 
	tsu£c⁄ds_t
;

49 
	#__su£c⁄ds_t_deföed


	)

54 
	t__fd_mask
;

57 #unde‡
__NFDBITS


59 
	#__NFDBITS
 (8 * (Ë (
__fd_mask
))

	)

60 
	#__FD_ELT
(
d
Ë((dË/ 
__NFDBITS
)

	)

61 
	#__FD_MASK
(
d
Ë((
__fd_mask
Ë(1UL << ((dË% 
__NFDBITS
)))

	)

68 #ifde‡
__USE_XOPEN


69 
__fd_mask
 
	mfds_bôs
[
__FD_SETSIZE
 / 
__NFDBITS
];

70 
	#__FDS_BITS
(
£t
Ë((£t)->
fds_bôs
)

	)

72 
__fd_mask
 
	m__fds_bôs
[
__FD_SETSIZE
 / 
__NFDBITS
];

73 
	#__FDS_BITS
(
£t
Ë((£t)->
__fds_bôs
)

	)

75 } 
	tfd_£t
;

78 
	#FD_SETSIZE
 
__FD_SETSIZE


	)

80 #ifde‡
__USE_MISC


82 
__fd_mask
 
	tfd_mask
;

85 
	#NFDBITS
 
__NFDBITS


	)

90 
	#FD_SET
(
fd
, 
fd£ç
Ë
	`__FD_SET
 (fd, fd£ç)

	)

91 
	#FD_CLR
(
fd
, 
fd£ç
Ë
	`__FD_CLR
 (fd, fd£ç)

	)

92 
	#FD_ISSET
(
fd
, 
fd£ç
Ë
	`__FD_ISSET
 (fd, fd£ç)

	)

93 
	#FD_ZERO
(
fd£ç
Ë
	`__FD_ZERO
 (fd£ç)

	)

96 
__BEGIN_DECLS


106 
£À˘
 (
__nfds
, 
fd_£t
 *
__ª°ri˘
 
__ªadfds
,

107 
fd_£t
 *
__ª°ri˘
 
__wrôefds
,

108 
fd_£t
 *
__ª°ri˘
 
__ex˚±fds
,

109 
timevÆ
 *
__ª°ri˘
 
__timeout
);

111 #ifde‡
__USE_XOPEN2K


118 
p£À˘
 (
__nfds
, 
fd_£t
 *
__ª°ri˘
 
__ªadfds
,

119 
fd_£t
 *
__ª°ri˘
 
__wrôefds
,

120 
fd_£t
 *
__ª°ri˘
 
__ex˚±fds
,

121 c⁄° 
time•ec
 *
__ª°ri˘
 
__timeout
,

122 c⁄° 
__sig£t_t
 *
__ª°ri˘
 
__sigmask
);

127 #i‡
__USE_FORTIFY_LEVEL
 > 0 && 
deföed
 
__GNUC__


128 
	~<bôs/£À˘2.h
>

131 
	g__END_DECLS


	@/usr/include/sys/sysmacros.h

19 #i‚de‡
_SYS_SYSMACROS_H_OUTER


21 #i‚de‡
__SYSMACROS_DEPRECATED_INCLUSION


22 
	#_SYS_SYSMACROS_H_OUTER
 1

	)

30 #unde‡
maj‹


31 #unde‡
mö‹


32 #unde‡
makedev


36 #i‚de‡
_SYS_SYSMACROS_H


37 
	#_SYS_SYSMACROS_H
 1

	)

39 
	~<„©uªs.h
>

40 
	~<bôs/ty≥s.h
>

41 
	~<bôs/sysma¸os.h
>

52 
	#__SYSMACROS_DM
(
symbﬁ
Ë
__SYSMACROS_DM1
 \

53 (
In
 
the
 
GNU
 
C
 
Libøry
, #symbﬁ 
is
 
deföed
\
n
\

54 
by
 <
sys
/
sysma¸os
.
h
>. 
F‹
 
hi°‹iˇl
 
com∑tibûôy
, 
ô
 
is
\
n
\

55 
cuºíéy
 
deföed
 
by
 <
sys
/
ty≥s
.
h
> 
as
 
wñl
, 
but
 
we
 
∂™
 
to
\
n
\

56 
ªmove
 
this
 
so⁄
. 
To
 
u£
 #symbﬁ, 
ö˛ude
 <
sys
/
sysma¸os
.
h
>\
n
\

57 
dúe˘ly
. 
If
 
you
 
did
 
nŸ
 
öãnd
 
to
 
u£
 
a
 
sy°em
-
deföed
 
ma¸o
\
n
\

58 #symbﬁ, 
you
 
should
 
undeföe
 
ô
 
a·î
 
ö˛udög
 <
sys
/
ty≥s
.
h
>.)

	)

62 
	#__SYSMACROS_DM1
(...Ë
	`__glibc_ma¸o_w¨nög
 (#__VA_ARGS__)

	)

64 
	#__SYSMACROS_DECL_TEMPL
(
πy≥
, 
«me
, 
¥Ÿo
) \

65 
πy≥
 
gnu_dev_
##
«me
 
¥Ÿo
 
__THROW
 
__©åibuã_c⁄°__
;

	)

67 
	#__SYSMACROS_IMPL_TEMPL
(
πy≥
, 
«me
, 
¥Ÿo
) \

68 
__exãnsi⁄__
 
__exã∫_ölöe
 
__©åibuã_c⁄°__
 
πy≥
 \

69 
	`__NTH
 (
gnu_dev_
##
«me
 
¥Ÿo
)

	)

71 
__BEGIN_DECLS


73 
	$__SYSMACROS_DECLARE_MAJOR
 (
__SYSMACROS_DECL_TEMPL
)

74 
	$__SYSMACROS_DECLARE_MINOR
 (
__SYSMACROS_DECL_TEMPL
)

75 
	$__SYSMACROS_DECLARE_MAKEDEV
 (
__SYSMACROS_DECL_TEMPL
)

77 #ifde‡
__USE_EXTERN_INLINES


79 
	$__SYSMACROS_DEFINE_MAJOR
 (
__SYSMACROS_IMPL_TEMPL
)

80 
	$__SYSMACROS_DEFINE_MINOR
 (
__SYSMACROS_IMPL_TEMPL
)

81 
	$__SYSMACROS_DEFINE_MAKEDEV
 (
__SYSMACROS_IMPL_TEMPL
)

85 
__END_DECLS


89 #i‚de‡
__SYSMACROS_NEED_IMPLEMENTATION


90 #unde‡
__SYSMACROS_DECL_TEMPL


91 #unde‡
__SYSMACROS_IMPL_TEMPL


92 #unde‡
__SYSMACROS_DECLARE_MAJOR


93 #unde‡
__SYSMACROS_DECLARE_MINOR


94 #unde‡
__SYSMACROS_DECLARE_MAKEDEV


95 #unde‡
__SYSMACROS_DEFINE_MAJOR


96 #unde‡
__SYSMACROS_DEFINE_MINOR


97 #unde‡
__SYSMACROS_DEFINE_MAKEDEV


100 #ifde‡
__SYSMACROS_DEPRECATED_INCLUSION


101 
	#maj‹
(
dev
Ë
	`__SYSMACROS_DM
 (
maj‹
Ë
	`gnu_dev_maj‹
 (dev)

	)

102 
	#mö‹
(
dev
Ë
	`__SYSMACROS_DM
 (
mö‹
Ë
	`gnu_dev_mö‹
 (dev)

	)

103 
	#makedev
(
maj
, 
mö
Ë
	`__SYSMACROS_DM
 (
makedev
Ë
	`gnu_dev_makedev
 (maj, mö)

	)

105 
	#maj‹
(
dev
Ë
	`gnu_dev_maj‹
 (dev)

	)

106 
	#mö‹
(
dev
Ë
	`gnu_dev_mö‹
 (dev)

	)

107 
	#makedev
(
maj
, 
mö
Ë
	`gnu_dev_makedev
 (maj, mö)

	)

	@/usr/include/asm-generic/errno-base.h

1 #i‚de‡
_ASM_GENERIC_ERRNO_BASE_H


2 
	#_ASM_GENERIC_ERRNO_BASE_H


	)

4 
	#EPERM
 1

	)

5 
	#ENOENT
 2

	)

6 
	#ESRCH
 3

	)

7 
	#EINTR
 4

	)

8 
	#EIO
 5

	)

9 
	#ENXIO
 6

	)

10 
	#E2BIG
 7

	)

11 
	#ENOEXEC
 8

	)

12 
	#EBADF
 9

	)

13 
	#ECHILD
 10

	)

14 
	#EAGAIN
 11

	)

15 
	#ENOMEM
 12

	)

16 
	#EACCES
 13

	)

17 
	#EFAULT
 14

	)

18 
	#ENOTBLK
 15

	)

19 
	#EBUSY
 16

	)

20 
	#EEXIST
 17

	)

21 
	#EXDEV
 18

	)

22 
	#ENODEV
 19

	)

23 
	#ENOTDIR
 20

	)

24 
	#EISDIR
 21

	)

25 
	#EINVAL
 22

	)

26 
	#ENFILE
 23

	)

27 
	#EMFILE
 24

	)

28 
	#ENOTTY
 25

	)

29 
	#ETXTBSY
 26

	)

30 
	#EFBIG
 27

	)

31 
	#ENOSPC
 28

	)

32 
	#ESPIPE
 29

	)

33 
	#EROFS
 30

	)

34 
	#EMLINK
 31

	)

35 
	#EPIPE
 32

	)

36 
	#EDOM
 33

	)

37 
	#ERANGE
 34

	)

	@/usr/include/asm-generic/int-ll64.h

8 #i‚de‡
_ASM_GENERIC_INT_LL64_H


9 
	#_ASM_GENERIC_INT_LL64_H


	)

11 
	~<asm/bô•îl⁄g.h
>

13 #i‚de‡
__ASSEMBLY__


19 
__sig√d__
 
	t__s8
;

20 
	t__u8
;

22 
__sig√d__
 
	t__s16
;

23 
	t__u16
;

25 
__sig√d__
 
	t__s32
;

26 
	t__u32
;

28 #ifde‡
__GNUC__


29 
__exãnsi⁄__
 
__sig√d__
 
	t__s64
;

30 
__exãnsi⁄__
 
	t__u64
;

32 
__sig√d__
 
	t__s64
;

33 
	t__u64
;

	@/usr/include/asm-generic/ioctl.h

1 #i‚de‡
_ASM_GENERIC_IOCTL_H


2 
	#_ASM_GENERIC_IOCTL_H


	)

22 
	#_IOC_NRBITS
 8

	)

23 
	#_IOC_TYPEBITS
 8

	)

30 #i‚de‡
_IOC_SIZEBITS


31 
	#_IOC_SIZEBITS
 14

	)

34 #i‚de‡
_IOC_DIRBITS


35 
	#_IOC_DIRBITS
 2

	)

38 
	#_IOC_NRMASK
 ((1 << 
_IOC_NRBITS
)-1)

	)

39 
	#_IOC_TYPEMASK
 ((1 << 
_IOC_TYPEBITS
)-1)

	)

40 
	#_IOC_SIZEMASK
 ((1 << 
_IOC_SIZEBITS
)-1)

	)

41 
	#_IOC_DIRMASK
 ((1 << 
_IOC_DIRBITS
)-1)

	)

43 
	#_IOC_NRSHIFT
 0

	)

44 
	#_IOC_TYPESHIFT
 (
_IOC_NRSHIFT
+
_IOC_NRBITS
)

	)

45 
	#_IOC_SIZESHIFT
 (
_IOC_TYPESHIFT
+
_IOC_TYPEBITS
)

	)

46 
	#_IOC_DIRSHIFT
 (
_IOC_SIZESHIFT
+
_IOC_SIZEBITS
)

	)

56 #i‚de‡
_IOC_NONE


57 
	#_IOC_NONE
 0U

	)

60 #i‚de‡
_IOC_WRITE


61 
	#_IOC_WRITE
 1U

	)

64 #i‚de‡
_IOC_READ


65 
	#_IOC_READ
 2U

	)

68 
	#_IOC
(
dú
,
ty≥
,
ƒ
,
size
) \

69 (((
dú
Ë<< 
_IOC_DIRSHIFT
) | \

70 ((
ty≥
Ë<< 
_IOC_TYPESHIFT
) | \

71 ((
ƒ
Ë<< 
_IOC_NRSHIFT
) | \

72 ((
size
Ë<< 
_IOC_SIZESHIFT
))

	)

74 
	#_IOC_TYPECHECK
(
t
Ë(—))

	)

82 
	#_IO
(
ty≥
,
ƒ
Ë
	`_IOC
(
_IOC_NONE
,—y≥),“r),0)

	)

83 
	#_IOR
(
ty≥
,
ƒ
,
size
Ë
	`_IOC
(
_IOC_READ
,—y≥),“r),(
	`_IOC_TYPECHECK
(size)))

	)

84 
	#_IOW
(
ty≥
,
ƒ
,
size
Ë
	`_IOC
(
_IOC_WRITE
,—y≥),“r),(
	`_IOC_TYPECHECK
(size)))

	)

85 
	#_IOWR
(
ty≥
,
ƒ
,
size
Ë
	`_IOC
(
_IOC_READ
|
_IOC_WRITE
,—y≥),“r),(
	`_IOC_TYPECHECK
(size)))

	)

86 
	#_IOR_BAD
(
ty≥
,
ƒ
,
size
Ë
	`_IOC
(
_IOC_READ
,—y≥),“r),(size))

	)

87 
	#_IOW_BAD
(
ty≥
,
ƒ
,
size
Ë
	`_IOC
(
_IOC_WRITE
,—y≥),“r),(size))

	)

88 
	#_IOWR_BAD
(
ty≥
,
ƒ
,
size
Ë
	`_IOC
(
_IOC_READ
|
_IOC_WRITE
,—y≥),“r),(size))

	)

91 
	#_IOC_DIR
(
ƒ
Ë((“rË>> 
_IOC_DIRSHIFT
Ë& 
_IOC_DIRMASK
)

	)

92 
	#_IOC_TYPE
(
ƒ
Ë((“rË>> 
_IOC_TYPESHIFT
Ë& 
_IOC_TYPEMASK
)

	)

93 
	#_IOC_NR
(
ƒ
Ë((“rË>> 
_IOC_NRSHIFT
Ë& 
_IOC_NRMASK
)

	)

94 
	#_IOC_SIZE
(
ƒ
Ë((“rË>> 
_IOC_SIZESHIFT
Ë& 
_IOC_SIZEMASK
)

	)

98 
	#IOC_IN
 (
_IOC_WRITE
 << 
_IOC_DIRSHIFT
)

	)

99 
	#IOC_OUT
 (
_IOC_READ
 << 
_IOC_DIRSHIFT
)

	)

100 
	#IOC_INOUT
 ((
_IOC_WRITE
|
_IOC_READ
Ë<< 
_IOC_DIRSHIFT
)

	)

101 
	#IOCSIZE_MASK
 (
_IOC_SIZEMASK
 << 
_IOC_SIZESHIFT
)

	)

102 
	#IOCSIZE_SHIFT
 (
_IOC_SIZESHIFT
)

	)

	@/usr/include/asm/posix_types_32.h

1 #i‚de‡
_ASM_X86_POSIX_TYPES_32_H


2 
	#_ASM_X86_POSIX_TYPES_32_H


	)

10 
	t__kî√l_mode_t
;

11 
	#__kî√l_mode_t
 
__kî√l_mode_t


	)

13 
	t__kî√l_ùc_pid_t
;

14 
	#__kî√l_ùc_pid_t
 
__kî√l_ùc_pid_t


	)

16 
	t__kî√l_uid_t
;

17 
	t__kî√l_gid_t
;

18 
	#__kî√l_uid_t
 
__kî√l_uid_t


	)

20 
	t__kî√l_ﬁd_dev_t
;

21 
	#__kî√l_ﬁd_dev_t
 
__kî√l_ﬁd_dev_t


	)

23 
	~<asm-gíîic/posix_ty≥s.h
>

	@/usr/include/asm/posix_types_64.h

1 #i‚de‡
_ASM_X86_POSIX_TYPES_64_H


2 
	#_ASM_X86_POSIX_TYPES_64_H


	)

10 
	t__kî√l_ﬁd_uid_t
;

11 
	t__kî√l_ﬁd_gid_t
;

12 
	#__kî√l_ﬁd_uid_t
 
__kî√l_ﬁd_uid_t


	)

14 
	t__kî√l_ﬁd_dev_t
;

15 
	#__kî√l_ﬁd_dev_t
 
__kî√l_ﬁd_dev_t


	)

17 
	~<asm-gíîic/posix_ty≥s.h
>

	@/usr/include/asm/posix_types_x32.h

1 #i‚de‡
_ASM_X86_POSIX_TYPES_X32_H


2 
	#_ASM_X86_POSIX_TYPES_X32_H


	)

13 
	t__kî√l_l⁄g_t
;

14 
	t__kî√l_ul⁄g_t
;

15 
	#__kî√l_l⁄g_t
 
__kî√l_l⁄g_t


	)

17 
	~<asm/posix_ty≥s_64.h
>

	@/usr/include/asm/swab.h

1 #i‚de‡
_ASM_X86_SWAB_H


2 
	#_ASM_X86_SWAB_H


	)

4 
	~<löux/ty≥s.h
>

7 
__ölöe__
 
__u32
 
	$__¨ch_swab32
(
__u32
 
vÆ
)

9 
	`__asm__
("bsw≠»%0" : "Ù" (
vÆ
) : "0" (val));

10  
vÆ
;

11 
	}
}

12 
	#__¨ch_swab32
 
__¨ch_swab32


	)

14 
__ölöe__
 
__u64
 
	$__¨ch_swab64
(
__u64
 
vÆ
)

16 #ifde‡
__i386__


19 
__u32
 
a
;

20 
__u32
 
b
;

21 } 
s
;

22 
__u64
 
u
;

23 } 
v
;

24 
v
.
u
 = 
vÆ
;

25 
	`__asm__
("bswapl %0 ; bswapl %1 ; xchgl %0,%1"

26 : "Ù" (
v
.
s
.
a
), "Ù" (v.s.
b
)

27 : "0" (
v
.
s
.
a
), "1" (v.s.
b
));

28  
v
.
u
;

30 
	`__asm__
("bsw≠q %0" : "Ù" (
vÆ
) : "0" (val));

31  
vÆ
;

33 
	}
}

34 
	#__¨ch_swab64
 
__¨ch_swab64


	)

	@/usr/include/bits/long-double.h

	@/usr/include/bits/select.h

18 #i‚de‡
_SYS_SELECT_H


22 
	~<bôs/w‹dsize.h
>

25 #i‡
deföed
 
__GNUC__
 && __GNUC__ >= 2

27 #i‡
__WORDSIZE
 == 64

28 
	#__FD_ZERO_STOS
 "°osq"

	)

30 
	#__FD_ZERO_STOS
 "°o¶"

	)

33 
	#__FD_ZERO
(
fd•
) \

35 
__d0
, 
__d1
; \

36 
__asm__
 
	`__vﬁ©ûe__
 ("˛d;Ñï; " 
__FD_ZERO_STOS
 \

37 : "=c" (
__d0
), "=D" (
__d1
) \

38 : "a" (0), "0" ( (
fd_£t
) \

39 /  (
__fd_mask
)), \

40 "1" (&
	`__FDS_BITS
 (
fd•
)[0]) \

42 } 0)

	)

48 
	#__FD_ZERO
(
£t
) \

50 
__i
; \

51 
fd_£t
 *
__¨r
 = (
£t
); \

52 
__i
 = 0; __ò<  (
fd_£t
Ë/  (
__fd_mask
); ++__i) \

53 
	`__FDS_BITS
 (
__¨r
)[
__i
] = 0; \

54 } 0)

	)

58 
	#__FD_SET
(
d
, 
£t
) \

59 ((Ë(
	`__FDS_BITS
 (
£t
)[
	`__FD_ELT
 (
d
)] |
	`__FD_MASK
 (d)))

	)

60 
	#__FD_CLR
(
d
, 
£t
) \

61 ((Ë(
	`__FDS_BITS
 (
£t
)[
	`__FD_ELT
 (
d
)] &~
	`__FD_MASK
 (d)))

	)

62 
	#__FD_ISSET
(
d
, 
£t
) \

63 ((
	`__FDS_BITS
 (
£t
)[
	`__FD_ELT
 (
d
)] & 
	`__FD_MASK
 (d)Ë!0)

	)

	@/usr/include/bits/select2.h

19 #i‚de‡
_SYS_SELECT_H


24 
__fdñt_chk
 (
__d
);

25 
	$__fdñt_w¨n
 (
__d
)

26 
	`__w¨«âr
 ("bit outside of fd_set selected");

27 #unde‡
__FD_ELT


28 
	#__FD_ELT
(
d
) \

29 
__exãnsi⁄__
 \

30 ({ 
__d
 = (
d
); \

31 (
	`__buûtö_c⁄°™t_p
 (
__d
) \

32 ? (0 <
__d
 && __d < 
__FD_SETSIZE
 \

33 ? (
__d
 / 
__NFDBITS
) \

34 : 
	`__fdñt_w¨n
 (
__d
)) \

35 : 
	`__fdñt_chk
 (
__d
)); 
	}
})

	)

	@/usr/include/bits/sigset.h

19 #i‚def 
_SIGSET_H_ty≥s


20 
	#_SIGSET_H_ty≥s
 1

	)

22 
	t__sig_©omic_t
;

26 
	#_SIGSET_NWORDS
 (1024 / (8 *  ()))

	)

29 
	m__vÆ
[
_SIGSET_NWORDS
];

30 } 
	t__sig£t_t
;

41 #i‡!
deföed
 
_SIGSET_H_‚s
 && deföed 
_SIGNAL_H


42 
	#_SIGSET_H_‚s
 1

	)

44 #i‚de‡
_EXTERN_INLINE


45 
	#_EXTERN_INLINE
 
__exã∫_ölöe


	)

49 
	#__sigmask
(
sig
) \

50 (((Ë1Ë<< (((
sig
Ë- 1Ë% (8 *  ())))

	)

53 
	#__sigw‹d
(
sig
Ë(((sigË- 1Ë/ (8 *  ()))

	)

55 #i‡
deföed
 
__GNUC__
 && __GNUC__ >= 2

56 
	#__sigem±y£t
(
£t
) \

57 (
	`__exãnsi⁄__
 ({ 
__˙t
 = 
_SIGSET_NWORDS
; \

58 
sig£t_t
 *
__£t
 = (
£t
); \

59 --
__˙t
 >0Ë
__£t
->
__vÆ
[__cnt] = 0; \

60 0; }))

	)

61 
	#__sigfûl£t
(
£t
) \

62 (
	`__exãnsi⁄__
 ({ 
__˙t
 = 
_SIGSET_NWORDS
; \

63 
sig£t_t
 *
__£t
 = (
£t
); \

64 --
__˙t
 >0Ë
__£t
->
__vÆ
[__cnt] = ~0UL; \

65 0; }))

	)

67 #ifde‡
__USE_GNU


71 
	#__sigi£m±y£t
(
£t
) \

72 (
	`__exãnsi⁄__
 ({ 
__˙t
 = 
_SIGSET_NWORDS
; \

73 c⁄° 
sig£t_t
 *
__£t
 = (
£t
); \

74 
__ªt
 = 
__£t
->
__vÆ
[--
__˙t
]; \

75 !
__ªt
 && --
__˙t
 >= 0) \

76 
__ªt
 = 
__£t
->
__vÆ
[
__˙t
]; \

77 
__ªt
 =0; }))

	)

78 
	#__sig™d£t
(
de°
, 
À·
, 
right
) \

79 (
	`__exãnsi⁄__
 ({ 
__˙t
 = 
_SIGSET_NWORDS
; \

80 
sig£t_t
 *
__de°
 = (
de°
); \

81 c⁄° 
sig£t_t
 *
__À·
 = (
À·
); \

82 c⁄° 
sig£t_t
 *
__right
 = (
right
); \

83 --
__˙t
 >= 0) \

84 
__de°
->
__vÆ
[
__˙t
] = (
__À·
->__val[__cnt] \

85 & 
__right
->
__vÆ
[
__˙t
]); \

86 0; }))

	)

87 
	#__sig‹£t
(
de°
, 
À·
, 
right
) \

88 (
	`__exãnsi⁄__
 ({ 
__˙t
 = 
_SIGSET_NWORDS
; \

89 
sig£t_t
 *
__de°
 = (
de°
); \

90 c⁄° 
sig£t_t
 *
__À·
 = (
À·
); \

91 c⁄° 
sig£t_t
 *
__right
 = (
right
); \

92 --
__˙t
 >= 0) \

93 
__de°
->
__vÆ
[
__˙t
] = (
__À·
->__val[__cnt] \

94 | 
__right
->
__vÆ
[
__˙t
]); \

95 0; }))

	)

102 
__sigismembî
 (c⁄° 
__sig£t_t
 *, );

103 
__sigadd£t
 (
__sig£t_t
 *, );

104 
__sigdñ£t
 (
__sig£t_t
 *, );

106 #ifde‡
__USE_EXTERN_INLINES


107 
	#__SIGSETFN
(
NAME
, 
BODY
, 
CONST
) \

108 
_EXTERN_INLINE
 \

109 
	`NAME
 (
CONST
 
__sig£t_t
 *
__£t
, 
__sig
) \

111 
__mask
 = 
	`__sigmask
 (
__sig
); \

112 
__w‹d
 = 
	`__sigw‹d
 (
__sig
); \

113  
BODY
; \

114 }

	)

116 
__SIGSETFN
 (
__sigismembî
, (
__£t
->
__vÆ
[
__w‹d
] & 
__mask
) ? 1 : 0, const)

117 
__SIGSETFN
 (
__sigadd£t
, ((
__£t
->
__vÆ
[
__w‹d
] |
__mask
), 0), )

118 
__SIGSETFN
 (
__sigdñ£t
, ((
__£t
->
__vÆ
[
__w‹d
] &~
__mask
), 0), )

120 #unde‡
__SIGSETFN


	@/usr/include/bits/sysmacros.h

19 #i‚de‡
_BITS_SYSMACROS_H


20 
	#_BITS_SYSMACROS_H
 1

	)

22 #i‚de‡
_SYS_SYSMACROS_H


36 
	#__SYSMACROS_DECLARE_MAJOR
(
DECL_TEMPL
) \

37 
	`DECL_TEMPL
(, 
maj‹
, (
__dev_t
 
__dev
))

	)

39 
	#__SYSMACROS_DEFINE_MAJOR
(
DECL_TEMPL
) \

40 
	`__SYSMACROS_DECLARE_MAJOR
 (
DECL_TEMPL
) \

42 
__maj‹
; \

43 
__maj‹
 = ((
__dev
 & (
__dev_t
) 0x00000000000fff00u) >> 8); \

44 
__maj‹
 |((
__dev
 & (
__dev_t
) 0xfffff00000000000u) >> 32); \

45  
__maj‹
; \

46 }

	)

48 
	#__SYSMACROS_DECLARE_MINOR
(
DECL_TEMPL
) \

49 
	`DECL_TEMPL
(, 
mö‹
, (
__dev_t
 
__dev
))

	)

51 
	#__SYSMACROS_DEFINE_MINOR
(
DECL_TEMPL
) \

52 
	`__SYSMACROS_DECLARE_MINOR
 (
DECL_TEMPL
) \

54 
__mö‹
; \

55 
__mö‹
 = ((
__dev
 & (
__dev_t
) 0x00000000000000ffu) >> 0); \

56 
__mö‹
 |((
__dev
 & (
__dev_t
) 0x00000ffffff00000u) >> 12); \

57  
__mö‹
; \

58 }

	)

60 
	#__SYSMACROS_DECLARE_MAKEDEV
(
DECL_TEMPL
) \

61 
	`DECL_TEMPL
(
__dev_t
, 
makedev
, (
__maj‹
, 
__mö‹
))

	)

63 
	#__SYSMACROS_DEFINE_MAKEDEV
(
DECL_TEMPL
) \

64 
	`__SYSMACROS_DECLARE_MAKEDEV
 (
DECL_TEMPL
) \

66 
__dev_t
 
__dev
; \

67 
__dev
 = (((
__dev_t
Ë(
__maj‹
 & 0x00000fffu)) << 8); \

68 
__dev
 |(((
__dev_t
Ë(
__maj‹
 & 0xfffff000u)) << 32); \

69 
__dev
 |(((
__dev_t
Ë(
__mö‹
 & 0x000000ffu)) << 0); \

70 
__dev
 |(((
__dev_t
Ë(
__mö‹
 & 0xffffff00u)) << 12); \

71  
__dev
; \

72 }

	)

	@/usr/include/bits/types/struct_timespec.h

1 #i‚de‡
__time•ec_deföed


2 
	#__time•ec_deföed
 1

	)

4 
	~<bôs/ty≥s.h
>

8 
	stime•ec


10 
__time_t
 
	mtv_£c
;

11 
__sysˇŒ_¶⁄g_t
 
	mtv_n£c
;

	@/usr/include/bits/types/struct_timeval.h

1 #i‚de‡
__timevÆ_deföed


2 
	#__timevÆ_deföed
 1

	)

4 
	~<bôs/ty≥s.h
>

8 
	stimevÆ


10 
__time_t
 
	mtv_£c
;

11 
__su£c⁄ds_t
 
	mtv_u£c
;

	@/usr/include/gnu/stubs-64.h

6 #ifde‡
_LIBC


7 #îr‹ 
Aµliˇti⁄s
 
may
 
nŸ
 
deföe
 
the
 
ma¸o
 
_LIBC


10 
	#__°ub___com∑t_bdÊush


	)

11 
	#__°ub_chÊags


	)

12 
	#__°ub_Áâach


	)

13 
	#__°ub_fchÊags


	)

14 
	#__°ub_fdëach


	)

15 
	#__°ub_gëmsg


	)

16 
	#__°ub_gây


	)

17 
	#__°ub_lchmod


	)

18 
	#__°ub_putmsg


	)

19 
	#__°ub_ªvoke


	)

20 
	#__°ub_£éogö


	)

21 
	#__°ub_sigªtu∫


	)

22 
	#__°ub_s°k


	)

23 
	#__°ub_°ty


	)

	@/usr/include/asm-generic/posix_types.h

1 #i‚de‡
__ASM_GENERIC_POSIX_TYPES_H


2 
	#__ASM_GENERIC_POSIX_TYPES_H


	)

4 
	~<asm/bô•îl⁄g.h
>

13 #i‚de‡
__kî√l_l⁄g_t


14 
	t__kî√l_l⁄g_t
;

15 
	t__kî√l_ul⁄g_t
;

18 #i‚de‡
__kî√l_öo_t


19 
__kî√l_ul⁄g_t
 
	t__kî√l_öo_t
;

22 #i‚de‡
__kî√l_mode_t


23 
	t__kî√l_mode_t
;

26 #i‚de‡
__kî√l_pid_t


27 
	t__kî√l_pid_t
;

30 #i‚de‡
__kî√l_ùc_pid_t


31 
	t__kî√l_ùc_pid_t
;

34 #i‚de‡
__kî√l_uid_t


35 
	t__kî√l_uid_t
;

36 
	t__kî√l_gid_t
;

39 #i‚de‡
__kî√l_su£c⁄ds_t


40 
__kî√l_l⁄g_t
 
	t__kî√l_su£c⁄ds_t
;

43 #i‚de‡
__kî√l_daddr_t


44 
	t__kî√l_daddr_t
;

47 #i‚de‡
__kî√l_uid32_t


48 
	t__kî√l_uid32_t
;

49 
	t__kî√l_gid32_t
;

52 #i‚de‡
__kî√l_ﬁd_uid_t


53 
__kî√l_uid_t
 
	t__kî√l_ﬁd_uid_t
;

54 
__kî√l_gid_t
 
	t__kî√l_ﬁd_gid_t
;

57 #i‚de‡
__kî√l_ﬁd_dev_t


58 
	t__kî√l_ﬁd_dev_t
;

65 #i‚de‡
__kî√l_size_t


66 #i‡
__BITS_PER_LONG
 != 64

67 
	t__kî√l_size_t
;

68 
	t__kî√l_ssize_t
;

69 
	t__kî√l_±rdiff_t
;

71 
__kî√l_ul⁄g_t
 
	t__kî√l_size_t
;

72 
__kî√l_l⁄g_t
 
	t__kî√l_ssize_t
;

73 
__kî√l_l⁄g_t
 
	t__kî√l_±rdiff_t
;

77 #i‚de‡
__kî√l_fsid_t


79 
	mvÆ
[2];

80 } 
	t__kî√l_fsid_t
;

86 
__kî√l_l⁄g_t
 
	t__kî√l_off_t
;

87 
	t__kî√l_loff_t
;

88 
__kî√l_l⁄g_t
 
	t__kî√l_time_t
;

89 
__kî√l_l⁄g_t
 
	t__kî√l_˛ock_t
;

90 
	t__kî√l_timî_t
;

91 
	t__kî√l_˛ockid_t
;

92 * 
	t__kî√l_ˇddr_t
;

93 
	t__kî√l_uid16_t
;

94 
	t__kî√l_gid16_t
;

	@/usr/include/asm/bitsperlong.h

1 #i‚de‡
__ASM_X86_BITSPERLONG_H


2 
	#__ASM_X86_BITSPERLONG_H


	)

4 #i‡
deföed
(
__x86_64__
Ë&& !deföed(
__ILP32__
)

5 
	#__BITS_PER_LONG
 64

	)

7 
	#__BITS_PER_LONG
 32

	)

10 
	~<asm-gíîic/bô•îl⁄g.h
>

	@/usr/include/asm-generic/bitsperlong.h

1 #i‚de‡
__ASM_GENERIC_BITS_PER_LONG


2 
	#__ASM_GENERIC_BITS_PER_LONG


	)

11 #i‚de‡
__BITS_PER_LONG


12 
	#__BITS_PER_LONG
 32

	)

	@
1
.
1
/usr/include
579
13259
uds/accessMode.h
uds/assertDefs.h
uds/bits.c
uds/bits.h
uds/block.c
uds/blockIORegion.c
uds/blockIORegion.h
uds/buffer.c
uds/buffer.h
uds/bufferOps.h
uds/bufferPrivate.h
uds/bufferedIORegion.c
uds/bufferedIORegion.h
uds/bufferedReader.c
uds/bufferedReader.h
uds/bufferedReaderInternals.h
uds/bufferedWriter.c
uds/bufferedWriter.h
uds/bufferedWriterInternals.h
uds/cacheCounters.c
uds/cacheCounters.h
uds/cachedChapterIndex.c
uds/cachedChapterIndex.h
uds/chapterIndex.c
uds/chapterIndex.h
uds/chapterWriter.c
uds/chapterWriter.h
uds/chunkName.c
uds/common.h
uds/compiler.h
uds/compilerDefs.h
uds/componentPortal.h
uds/componentPortalInline.h
uds/config.c
uds/config.h
uds/context.c
uds/context.h
uds/cpu.h
uds/deltaIndex.c
uds/deltaIndex.h
uds/deltaMemory.c
uds/deltaMemory.h
uds/errorDefs.h
uds/errors.c
uds/errors.h
uds/errorsLinuxKernel.c
uds/featureDefs.h
uds/geometry.c
uds/geometry.h
uds/grid.c
uds/grid.h
uds/hashUtils.c
uds/hashUtils.h
uds/index.c
uds/index.h
uds/indexCheckpoint.c
uds/indexCheckpoint.h
uds/indexComponent.c
uds/indexComponent.h
uds/indexComponentInline.h
uds/indexComponentInternal.h
uds/indexConfig.c
uds/indexConfig.h
uds/indexInternals.c
uds/indexInternals.h
uds/indexLayout.c
uds/indexLayout.h
uds/indexLayoutInline.h
uds/indexLayoutInternal.h
uds/indexLayoutLinuxKernel.c
uds/indexLayoutParser.c
uds/indexLayoutParser.h
uds/indexPageMap.c
uds/indexPageMap.h
uds/indexRouter.c
uds/indexRouter.h
uds/indexRouterStats.h
uds/indexSession.c
uds/indexSession.h
uds/indexState.c
uds/indexState.h
uds/indexStateData.c
uds/indexStateData.h
uds/indexStateInternals.h
uds/indexZone.c
uds/indexZone.h
uds/ioRegion.c
uds/ioRegion.h
uds/ioRegionInline.h
uds/isCallbackThreadDefs.h
uds/layoutRegion.h
uds/linuxIORegion.c
uds/linuxIORegion.h
uds/loadType.c
uds/loadType.h
uds/localIndexRouter.c
uds/localIndexRouter.h
uds/localIndexRouterPrivate.h
uds/logger.c
uds/logger.h
uds/loggerDefs.h
uds/loggerLinuxKernel.c
uds/masterIndex005.c
uds/masterIndex005.h
uds/masterIndex006.c
uds/masterIndex006.h
uds/masterIndexOps.c
uds/masterIndexOps.h
uds/memoryAlloc.c
uds/memoryAlloc.h
uds/memoryDefs.h
uds/memoryLinuxKernel.c
uds/murmur/MurmurHash3.c
uds/murmur/MurmurHash3.h
uds/namespaceHash.h
uds/nonce.c
uds/nonce.h
uds/notificationDefs.h
uds/numeric.c
uds/numeric.h
uds/numericDefs.h
uds/opaqueTypes.h
uds/openChapter.c
uds/openChapter.h
uds/openChapterZone.c
uds/openChapterZone.h
uds/pageCache.c
uds/pageCache.h
uds/parameter.c
uds/parameter.h
uds/permassert.c
uds/permassert.h
uds/permassertInternals.h
uds/permassertLinuxKernel.c
uds/queue.h
uds/random.c
uds/random.h
uds/randomDefs.h
uds/randomLinuxKernel.c
uds/readOnlyVolume.c
uds/readOnlyVolume.h
uds/recordPage.c
uds/recordPage.h
uds/regionIdentifiers.h
uds/regionIndexComponent.c
uds/regionIndexComponent.h
uds/regionIndexComponentInternal.h
uds/regionIndexState.c
uds/regionIndexState.h
uds/regionIndexStateInternal.h
uds/request.c
uds/request.h
uds/requestLimit.c
uds/requestLimit.h
uds/requestQueue.c
uds/requestQueue.h
uds/resourceDefs.h
uds/resourceUsageLinuxKernel.c
uds/searchList.c
uds/searchList.h
uds/session.c
uds/session.h
uds/sha224-256-private.h
uds/sha224-256.c
uds/sha224-256.h
uds/sha256.h
uds/singleFileLayout.c
uds/singleFileLayout.h
uds/singleFileLayoutInternals.h
uds/sparseCache.c
uds/sparseCache.h
uds/stringDefs.h
uds/stringLinuxKernel.c
uds/stringUtils.c
uds/stringUtils.h
uds/sysfs.c
uds/sysfs.h
uds/threadCondVar.h
uds/threadCondVarLinuxKernel.c
uds/threadDefs.h
uds/threadMutex.h
uds/threadMutexLinuxKernel.c
uds/threadOnce.c
uds/threadOnce.h
uds/threadRegistry.c
uds/threadRegistry.h
uds/threadSemaphore.h
uds/threadSemaphoreLinuxKernel.c
uds/threads.h
uds/threadsLinuxKernel.c
uds/timeDefs.h
uds/timeUtils.c
uds/timeUtils.h
uds/timeUtilsLinuxKernel.c
uds/typeDefs.h
uds/uds-block.h
uds/uds-error.h
uds/uds-param.h
uds/uds-platform.h
uds/uds.h
uds/uds.mod.c
uds/udsMain.c
uds/udsModule.c
uds/udsState.c
uds/udsState.h
uds/util/atomic.h
uds/util/eventCount.c
uds/util/eventCount.h
uds/util/funnelQueue.c
uds/util/funnelQueue.h
uds/util/pathBuffer.c
uds/util/pathBuffer.h
uds/util/radixSort.c
uds/util/radixSort.h
uds/util/statistic.c
uds/util/statistic.h
uds/volume.c
uds/volume.h
uds/volumeInternals.c
uds/volumeInternals.h
uds/zone.c
uds/zone.h
vdo/base/adminCompletion.c
vdo/base/adminCompletion.h
vdo/base/allocatingVIO.c
vdo/base/allocatingVIO.h
vdo/base/blockAllocator.c
vdo/base/blockAllocator.h
vdo/base/blockAllocatorInternals.h
vdo/base/blockDescriptor.h
vdo/base/blockMap.c
vdo/base/blockMap.h
vdo/base/blockMapEntry.h
vdo/base/blockMapInternals.h
vdo/base/blockMapPage.c
vdo/base/blockMapPage.h
vdo/base/blockMapRecovery.c
vdo/base/blockMapRecovery.h
vdo/base/blockMapTree.c
vdo/base/blockMapTree.h
vdo/base/blockMapTreeInternals.h
vdo/base/blockMappingState.h
vdo/base/completion.c
vdo/base/completion.h
vdo/base/compressedBlock.c
vdo/base/compressedBlock.h
vdo/base/compressionState.c
vdo/base/compressionState.h
vdo/base/compressionStateInternals.h
vdo/base/constants.c
vdo/base/constants.h
vdo/base/countedList.h
vdo/base/dataVIO.c
vdo/base/dataVIO.h
vdo/base/dirtyLists.c
vdo/base/dirtyLists.h
vdo/base/dirtyListsInternals.h
vdo/base/extent.c
vdo/base/extent.h
vdo/base/fixedLayout.c
vdo/base/fixedLayout.h
vdo/base/flush.c
vdo/base/flush.h
vdo/base/forest.c
vdo/base/forest.h
vdo/base/hashLock.c
vdo/base/hashLock.h
vdo/base/hashLockInternals.h
vdo/base/hashZone.c
vdo/base/hashZone.h
vdo/base/header.c
vdo/base/header.h
vdo/base/heap.c
vdo/base/heap.h
vdo/base/intMap.c
vdo/base/intMap.h
vdo/base/journalPoint.h
vdo/base/lockCounter.c
vdo/base/lockCounter.h
vdo/base/logicalZone.c
vdo/base/logicalZone.h
vdo/base/lz4.c
vdo/base/lz4.h
vdo/base/numUtils.h
vdo/base/objectPool.c
vdo/base/objectPool.h
vdo/base/packer.c
vdo/base/packer.h
vdo/base/packerInternals.h
vdo/base/partitionCopy.c
vdo/base/partitionCopy.h
vdo/base/pbnLock.c
vdo/base/pbnLock.h
vdo/base/pbnLockPool.c
vdo/base/pbnLockPool.h
vdo/base/physicalLayer.c
vdo/base/physicalLayer.h
vdo/base/physicalZone.c
vdo/base/physicalZone.h
vdo/base/pointerMap.c
vdo/base/pointerMap.h
vdo/base/priorityTable.c
vdo/base/priorityTable.h
vdo/base/readOnlyModeContext.c
vdo/base/readOnlyModeContext.h
vdo/base/readOnlyModeContextInternals.h
vdo/base/readOnlyRebuild.c
vdo/base/readOnlyRebuild.h
vdo/base/recoveryJournal.c
vdo/base/recoveryJournal.h
vdo/base/recoveryJournalInternals.h
vdo/base/recoveryUtils.c
vdo/base/recoveryUtils.h
vdo/base/refCounts.c
vdo/base/refCounts.h
vdo/base/refCountsInternals.h
vdo/base/referenceBlock.h
vdo/base/referenceCountRebuild.c
vdo/base/referenceCountRebuild.h
vdo/base/referenceOperation.c
vdo/base/referenceOperation.h
vdo/base/releaseVersions.h
vdo/base/ringNode.h
vdo/base/slab.c
vdo/base/slab.h
vdo/base/slabCompletion.c
vdo/base/slabCompletion.h
vdo/base/slabDepot.c
vdo/base/slabDepot.h
vdo/base/slabDepotInternals.h
vdo/base/slabIterator.h
vdo/base/slabJournal.c
vdo/base/slabJournal.h
vdo/base/slabJournalEraser.c
vdo/base/slabJournalEraser.h
vdo/base/slabJournalInternals.h
vdo/base/slabRebuild.c
vdo/base/slabRebuild.h
vdo/base/slabScrubber.c
vdo/base/slabScrubber.h
vdo/base/slabScrubberInternals.h
vdo/base/slabSummary.c
vdo/base/slabSummary.h
vdo/base/slabSummaryInternals.h
vdo/base/statistics.h
vdo/base/statusCodes.c
vdo/base/statusCodes.h
vdo/base/superBlock.c
vdo/base/superBlock.h
vdo/base/threadConfig.c
vdo/base/threadConfig.h
vdo/base/threadData.c
vdo/base/threadData.h
vdo/base/trace.c
vdo/base/trace.h
vdo/base/types.h
vdo/base/upgrade.c
vdo/base/upgrade.h
vdo/base/vdo.c
vdo/base/vdo.h
vdo/base/vdoClose.c
vdo/base/vdoClose.h
vdo/base/vdoDebug.c
vdo/base/vdoDebug.h
vdo/base/vdoInternal.h
vdo/base/vdoLayout.c
vdo/base/vdoLayout.h
vdo/base/vdoLayoutInternals.h
vdo/base/vdoLoad.c
vdo/base/vdoLoad.h
vdo/base/vdoPageCache.c
vdo/base/vdoPageCache.h
vdo/base/vdoPageCacheInternals.h
vdo/base/vdoRecovery.c
vdo/base/vdoRecovery.h
vdo/base/vdoRecoveryInternals.h
vdo/base/vdoResize.c
vdo/base/vdoResize.h
vdo/base/vdoResizeLogical.c
vdo/base/vdoResizeLogical.h
vdo/base/vio.c
vdo/base/vio.h
vdo/base/vioPool.c
vdo/base/vioPool.h
vdo/base/vioRead.c
vdo/base/vioRead.h
vdo/base/vioWrite.c
vdo/base/vioWrite.h
vdo/base/volumeGeometry.c
vdo/base/volumeGeometry.h
vdo/base/waitQueue.c
vdo/base/waitQueue.h
vdo/kernel/batchProcessor.c
vdo/kernel/batchProcessor.h
vdo/kernel/bio.c
vdo/kernel/bio.h
vdo/kernel/bioIterator.h
vdo/kernel/bufferPool.c
vdo/kernel/bufferPool.h
vdo/kernel/dataKVIO.c
vdo/kernel/dataKVIO.h
vdo/kernel/deadlockQueue.c
vdo/kernel/deadlockQueue.h
vdo/kernel/dedupeIndex.c
vdo/kernel/dedupeIndex.h
vdo/kernel/deviceConfig.c
vdo/kernel/deviceConfig.h
vdo/kernel/deviceRegistry.c
vdo/kernel/deviceRegistry.h
vdo/kernel/dmvdo.c
vdo/kernel/dmvdo.h
vdo/kernel/dump.c
vdo/kernel/dump.h
vdo/kernel/errors.c
vdo/kernel/errors.h
vdo/kernel/funnelQueue.c
vdo/kernel/funnelQueue.h
vdo/kernel/heartbeat.c
vdo/kernel/heartbeat.h
vdo/kernel/histogram.c
vdo/kernel/histogram.h
vdo/kernel/instanceNumber.c
vdo/kernel/instanceNumber.h
vdo/kernel/ioSubmitter.c
vdo/kernel/ioSubmitter.h
vdo/kernel/ioSubmitterInternals.h
vdo/kernel/kernelLayer.c
vdo/kernel/kernelLayer.h
vdo/kernel/kernelStatistics.h
vdo/kernel/kernelTypes.h
vdo/kernel/kernelVDO.c
vdo/kernel/kernelVDO.h
vdo/kernel/kernelVDOInternals.h
vdo/kernel/ktrace.c
vdo/kernel/ktrace.h
vdo/kernel/kvdoFlush.c
vdo/kernel/kvdoFlush.h
vdo/kernel/kvio.c
vdo/kernel/kvio.h
vdo/kernel/limiter.c
vdo/kernel/limiter.h
vdo/kernel/logger.c
vdo/kernel/logger.h
vdo/kernel/memoryUsage.c
vdo/kernel/memoryUsage.h
vdo/kernel/numeric.h
vdo/kernel/poolSysfs.c
vdo/kernel/poolSysfs.h
vdo/kernel/poolSysfsStats.c
vdo/kernel/readCache.c
vdo/kernel/readCache.h
vdo/kernel/statusCodeBlocks.h
vdo/kernel/statusProcfs.c
vdo/kernel/statusProcfs.h
vdo/kernel/sysfs.c
vdo/kernel/sysfs.h
vdo/kernel/threadDevice.c
vdo/kernel/threadDevice.h
vdo/kernel/threadRegistry.c
vdo/kernel/threadRegistry.h
vdo/kernel/threads.c
vdo/kernel/threads.h
vdo/kernel/timer.c
vdo/kernel/timer.h
vdo/kernel/udsIndex.c
vdo/kernel/udsIndex.h
vdo/kernel/vdoCommon.h
vdo/kernel/vdoStringUtils.c
vdo/kernel/vdoStringUtils.h
vdo/kernel/verify.c
vdo/kernel/verify.h
vdo/kernel/workItemStats.c
vdo/kernel/workItemStats.h
vdo/kernel/workQueue.c
vdo/kernel/workQueue.h
vdo/kernel/workQueueHandle.c
vdo/kernel/workQueueHandle.h
vdo/kernel/workQueueInternals.h
vdo/kernel/workQueueStats.c
vdo/kernel/workQueueStats.h
vdo/kernel/workQueueSysfs.c
vdo/kernel/workQueueSysfs.h
vdo/kvdo.mod.c
/usr/include/asm/byteorder.h
/usr/include/endian.h
/usr/include/linux/errno.h
/usr/include/linux/fs.h
/usr/include/linux/kernel.h
/usr/include/linux/module.h
/usr/include/linux/random.h
/usr/include/linux/sched.h
/usr/include/linux/stddef.h
/usr/include/linux/string.h
/usr/include/linux/time.h
/usr/include/linux/types.h
/usr/include/linux/version.h
/usr/include/linux/wait.h
/usr/include/math.h
/usr/include/stdint.h
/usr/include/stdlib.h
/usr/include/string.h
/usr/include/alloca.h
/usr/include/asm/errno.h
/usr/include/asm/types.h
/usr/include/bits/byteswap.h
/usr/include/bits/endian.h
/usr/include/bits/flt-eval-method.h
/usr/include/bits/fp-fast.h
/usr/include/bits/fp-logb.h
/usr/include/bits/huge_val.h
/usr/include/bits/huge_valf.h
/usr/include/bits/huge_vall.h
/usr/include/bits/inf.h
/usr/include/bits/iscanonical.h
/usr/include/bits/libc-header-start.h
/usr/include/bits/math-finite.h
/usr/include/bits/math-vector.h
/usr/include/bits/mathcalls.h
/usr/include/bits/mathinline.h
/usr/include/bits/nan.h
/usr/include/bits/stdlib-bsearch.h
/usr/include/bits/stdlib-float.h
/usr/include/bits/stdlib-ldbl.h
/usr/include/bits/stdlib.h
/usr/include/bits/string.h
/usr/include/bits/string2.h
/usr/include/bits/string3.h
/usr/include/bits/types.h
/usr/include/bits/uintn-identity.h
/usr/include/bits/waitflags.h
/usr/include/bits/waitstatus.h
/usr/include/bits/wchar.h
/usr/include/bits/wordsize.h
/usr/include/features.h
/usr/include/linux/byteorder/little_endian.h
/usr/include/linux/ioctl.h
/usr/include/linux/irqnr.h
/usr/include/linux/limits.h
/usr/include/linux/posix_types.h
/usr/include/linux/sysinfo.h
/usr/include/sys/types.h
/usr/include/xlocale.h
/usr/include/asm-generic/errno.h
/usr/include/asm-generic/types.h
/usr/include/asm/ioctl.h
/usr/include/asm/posix_types.h
/usr/include/bits/byteswap-16.h
/usr/include/bits/libm-simd-decl-stubs.h
/usr/include/bits/pthreadtypes.h
/usr/include/bits/strings_fortified.h
/usr/include/bits/types/clock_t.h
/usr/include/bits/types/clockid_t.h
/usr/include/bits/types/time_t.h
/usr/include/bits/types/timer_t.h
/usr/include/bits/typesizes.h
/usr/include/gnu/stubs.h
/usr/include/linux/swab.h
/usr/include/stdc-predef.h
/usr/include/sys/cdefs.h
/usr/include/sys/select.h
/usr/include/sys/sysmacros.h
/usr/include/asm-generic/errno-base.h
/usr/include/asm-generic/int-ll64.h
/usr/include/asm-generic/ioctl.h
/usr/include/asm/posix_types_32.h
/usr/include/asm/posix_types_64.h
/usr/include/asm/posix_types_x32.h
/usr/include/asm/swab.h
/usr/include/bits/long-double.h
/usr/include/bits/select.h
/usr/include/bits/select2.h
/usr/include/bits/sigset.h
/usr/include/bits/sysmacros.h
/usr/include/bits/types/struct_timespec.h
/usr/include/bits/types/struct_timeval.h
/usr/include/gnu/stubs-64.h
/usr/include/asm-generic/posix_types.h
/usr/include/asm/bitsperlong.h
/usr/include/asm-generic/bitsperlong.h
